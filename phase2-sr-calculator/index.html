<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRäº‹æ¥­éƒ¨ æç›Šè¨ˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - PLçµ±åˆã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* SRäº‹æ¥­éƒ¨å°‚ç”¨ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒï¼ˆèµ¤ç³»ï¼‰ */
        .sr-theme {
            --primary: #e74c3c;
            --secondary: #c0392b;
            --accent: #ff6b6b;
            --success: #27ae60;
            --error: #e74c3c;
            --warning: #f39c12;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        /* 6åº—èˆ—å…¥åŠ›ã‚°ãƒªãƒƒãƒ‰ */
        .store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .store-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .store-card:hover {
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.2);
        }

        .store-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
        }

        .store-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .month-input {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .month-input label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .month-input input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
        }

        .month-input input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.3);
        }

        /* è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .config-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .config-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .config-item input, .config-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        /* çµæœè¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ« */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .results-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .results-table tr:hover {
            background: #e8f4f8;
        }

        .total-row {
            background: #ffe6e6 !important;
            font-weight: bold;
        }

        .profit-positive {
            color: var(--success);
        }

        .profit-negative {
            color: var(--error);
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .status-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .status-label {
            color: #666;
            margin-top: 5px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .content {
                padding: 20px;
            }

            .store-grid {
                grid-template-columns: 1fr;
            }

            .store-inputs {
                grid-template-columns: repeat(3, 1fr);
            }

            .month-input input {
                width: 70px;
            }

            .header h1 {
                font-size: 2em;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            animation: fadeIn 0.5s ease-out;
        }

        /* äººä»¶è²»ä¿‚æ•°è¡¨ç¤º */
        .personnel-rate-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .personnel-rate-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .rate-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }

        .rate-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }
    </style>
</head>
<body class="sr-theme">
    <div class="container">
        <div class="header">
            <h1>SRäº‹æ¥­éƒ¨ æç›Šè¨ˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <div class="subtitle">6åº—èˆ—çµ±åˆç®¡ç† | å£²ä¸Šãƒ¬ãƒ³ã‚¸åˆ¥äººä»¶è²»ä¿‚æ•°å¯¾å¿œ</div>
        </div>

        <div class="content">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="status-indicators">
                <div class="status-card">
                    <div class="status-value" id="totalSalesDisplay">0</div>
                    <div class="status-label">å¹´é–“å£²ä¸Šï¼ˆä¸‡å††ï¼‰</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="operatingProfitDisplay">0</div>
                    <div class="status-label">å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="profitRateDisplay">0%</div>
                    <div class="status-label">åˆ©ç›Šç‡</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="personnelRateDisplay">0%</div>
                    <div class="status-label">äººä»¶è²»ç‡</div>
                </div>
            </div>

            <!-- 6åº—èˆ—å£²ä¸Šå…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“Š 6åº—èˆ—åˆ¥å£²ä¸Šå…¥åŠ›</h2>
                <div class="store-grid">
                    <!-- åº—èˆ—A -->
                    <div class="store-card" data-store="A">
                        <h3>ğŸª åº—èˆ—Aï¼ˆä¸»åŠ›åº—ï¼‰</h3>
                        <div class="store-inputs" id="storeA-inputs">
                            <!-- 12ãƒ¶æœˆåˆ†ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’JSã§ç”Ÿæˆ -->
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>å¹´é–“å£²ä¸Š: <span id="storeA-total">0</span>ä¸‡å††</strong>
                        </div>
                    </div>

                    <!-- åº—èˆ—B -->
                    <div class="store-card" data-store="B">
                        <h3>ğŸ¬ åº—èˆ—Bï¼ˆä¸­å …åº—ï¼‰</h3>
                        <div class="store-inputs" id="storeB-inputs">
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>å¹´é–“å£²ä¸Š: <span id="storeB-total">0</span>ä¸‡å††</strong>
                        </div>
                    </div>

                    <!-- åº—èˆ—C -->
                    <div class="store-card" data-store="C">
                        <h3>ğŸ¢ åº—èˆ—Cï¼ˆä¸­å …åº—ï¼‰</h3>
                        <div class="store-inputs" id="storeC-inputs">
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>å¹´é–“å£²ä¸Š: <span id="storeC-total">0</span>ä¸‡å††</strong>
                        </div>
                    </div>

                    <!-- åº—èˆ—D -->
                    <div class="store-card" data-store="D">
                        <h3>ğŸª åº—èˆ—Dï¼ˆå°è¦æ¨¡åº—ï¼‰</h3>
                        <div class="store-inputs" id="storeD-inputs">
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>å¹´é–“å£²ä¸Š: <span id="storeD-total">0</span>ä¸‡å††</strong>
                        </div>
                    </div>

                    <!-- åº—èˆ—E -->
                    <div class="store-card" data-store="E">
                        <h3>ğŸ¬ åº—èˆ—Eï¼ˆå°è¦æ¨¡åº—ï¼‰</h3>
                        <div class="store-inputs" id="storeE-inputs">
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>å¹´é–“å£²ä¸Š: <span id="storeE-total">0</span>ä¸‡å††</strong>
                        </div>
                    </div>

                    <!-- åº—èˆ—F -->
                    <div class="store-card" data-store="F">
                        <h3>ğŸ†• åº—èˆ—Fï¼ˆæ–°è¦åº—ï¼‰</h3>
                        <div class="store-inputs" id="storeF-inputs">
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>å¹´é–“å£²ä¸Š: <span id="storeF-total">0</span>ä¸‡å††</strong>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="loadSampleData()">ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
                    <button class="btn btn-secondary" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <!-- è¨ˆç®—è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>âš™ï¸ è¨ˆç®—è¨­å®š</h2>
                <div class="config-grid">
                    <div class="config-item">
                        <label>å•†å“ä»•å…¥ç‡</label>
                        <input type="number" id="cogsRate" value="27.2" step="0.1" min="0" max="100">
                        <small>%ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 27.2%ï¼‰</small>
                    </div>
                    <div class="config-item">
                        <label>è²¨ç‰©é‹è³ƒç‡</label>
                        <input type="number" id="freightRate" value="1.5" step="0.1" min="0" max="10">
                        <small>%ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1.5%ï¼‰</small>
                    </div>
                    <div class="config-item">
                        <label>æ°´é“å…‰ç†±è²»ç‡</label>
                        <input type="number" id="utilitiesRate" value="0.8" step="0.1" min="0" max="10">
                        <small>%ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0.8%ï¼‰</small>
                    </div>
                    <div class="config-item">
                        <label>æ”¯æ‰•æ‰‹æ•°æ–™ç‡</label>
                        <input type="number" id="paymentFeeRate" value="2.5" step="0.1" min="0" max="10">
                        <small>%ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 2.5%ï¼‰</small>
                    </div>
                    <div class="config-item">
                        <label>æœˆæ¬¡å£²ä¸Šç›®æ¨™</label>
                        <input type="number" id="monthlyTarget" value="10000" step="100" min="0">
                        <small>ä¸‡å††ï¼ˆã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—ç”¨ï¼‰</small>
                    </div>
                    <div class="config-item">
                        <label>åŸºæœ¬çµ¦æœˆé¡</label>
                        <input type="number" id="baseSalary" value="400" step="10" min="0">
                        <small>ä¸‡å††</small>
                    </div>
                </div>

                <!-- äººä»¶è²»ä¿‚æ•°èª¬æ˜ -->
                <div class="personnel-rate-info">
                    <h4>ğŸ“ˆ å£²ä¸Šãƒ¬ãƒ³ã‚¸åˆ¥äººä»¶è²»ä¿‚æ•°</h4>
                    <div class="rate-table">
                        <div class="rate-item">
                            <span>0 - 8,000ä¸‡å††</span>
                            <strong>33.8%</strong>
                        </div>
                        <div class="rate-item">
                            <span>8,001 - 12,000ä¸‡å††</span>
                            <strong>29.5%</strong>
                        </div>
                        <div class="rate-item">
                            <span>12,001 - 16,000ä¸‡å††</span>
                            <strong>27.5%</strong>
                        </div>
                        <div class="rate-item">
                            <span>16,001 - 20,000ä¸‡å††</span>
                            <strong>25.5%</strong>
                        </div>
                        <div class="rate-item">
                            <span>20,001ä¸‡å††ä»¥ä¸Š</span>
                            <strong>24.5%</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨ˆç®—çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“Š æœˆæ¬¡æç›Šè¨ˆç®—æ›¸</h2>
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>é …ç›®</th>
                            <th>1æœˆ</th>
                            <th>2æœˆ</th>
                            <th>3æœˆ</th>
                            <th>4æœˆ</th>
                            <th>5æœˆ</th>
                            <th>6æœˆ</th>
                            <th>7æœˆ</th>
                            <th>8æœˆ</th>
                            <th>9æœˆ</th>
                            <th>10æœˆ</th>
                            <th>11æœˆ</th>
                            <th>12æœˆ</th>
                            <th>å¹´é–“åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- è¨ˆç®—çµæœã‚’JSã§æŒ¿å…¥ -->
                    </tbody>
                </table>
            </div>

            <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“ˆ è¦–è¦šåˆ†æ</h2>
                <div class="chart-container">
                    <h3>æœˆæ¬¡å£²ä¸Šæ¨ç§»</h3>
                    <div class="chart-wrapper">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>åº—èˆ—åˆ¥å£²ä¸Šæ§‹æˆ</h3>
                    <div class="chart-wrapper">
                        <canvas id="storeChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>æç›Šæ¨ç§»</h3>
                    <div class="chart-wrapper">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <div style="text-align: center;">
                    <button class="btn" onclick="saveData()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="loadData()">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>
                    <button class="btn btn-secondary" onclick="sendToIntegratedSystem()">ğŸ”„ çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã¸é€ä¿¡</button>
                </div>
                <div id="dataStatus" style="margin-top: 15px; text-align: center; color: #666;"></div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const STORAGE_KEY = 'pl_system_sr_data';
        const stores = ['A', 'B', 'C', 'D', 'E', 'F'];
        const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        let salesChart, storeChart, profitChart;

        // å£²ä¸Šãƒ¬ãƒ³ã‚¸åˆ¥äººä»¶è²»ä¿‚æ•°
        const personnelRates = {
            "0-8000": 0.338,      // 33.8%
            "8001-12000": 0.295,  // 29.5%
            "12001-16000": 0.275, // 27.5%
            "16001-20000": 0.255, // 25.5%
            "20001ä»¥ä¸Š": 0.245    // 24.5%
        };

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeInputs();
            loadData();
            calculate();
            updateCharts();
        });

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆæœŸåŒ–
        function initializeInputs() {
            stores.forEach(store => {
                const container = document.getElementById(`store${store}-inputs`);
                months.forEach((month, index) => {
                    const monthInput = document.createElement('div');
                    monthInput.className = 'month-input';
                    monthInput.innerHTML = `
                        <label>${month}</label>
                        <input type="number" 
                               id="store${store}-month${index + 1}" 
                               min="0" 
                               step="1" 
                               value="0"
                               oninput="updateStoreTotal('${store}'); calculate(); updateCharts();">
                    `;
                    container.appendChild(monthInput);
                });
            });
        }

        // åº—èˆ—åˆ¥å£²ä¸Šåˆè¨ˆæ›´æ–°
        function updateStoreTotal(store) {
            let total = 0;
            for (let i = 1; i <= 12; i++) {
                const value = parseFloat(document.getElementById(`store${store}-month${i}`).value) || 0;
                total += value;
            }
            document.getElementById(`store${store}-total`).textContent = total.toLocaleString();
        }

        // äººä»¶è²»ä¿‚æ•°è¨ˆç®—
        function calculatePersonnelRate(monthlySales) {
            if (monthlySales <= 8000) return 0.338;
            if (monthlySales <= 12000) return 0.295;
            if (monthlySales <= 16000) return 0.275;
            if (monthlySales <= 20000) return 0.255;
            return 0.245;
        }

        // å–¶æ¥­ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨ˆç®—
        function calculateCommission(sales, target) {
            const achievementRate = sales / target;
            if (achievementRate >= 1.1) return sales * 0.02;  // 110%ä»¥ä¸Š: 2%
            if (achievementRate >= 1.0) return sales * 0.01;  // 100%ä»¥ä¸Š: 1%
            return 0;  // 100%æœªæº€: ãªã—
        }

        // æœˆæ¬¡è¨ˆç®—
        function calculateMonthlyPL(monthIndex) {
            let monthlySales = 0;
            
            // 6åº—èˆ—ã®å£²ä¸Šåˆè¨ˆ
            stores.forEach(store => {
                const value = parseFloat(document.getElementById(`store${store}-month${monthIndex + 1}`).value) || 0;
                monthlySales += value;
            });

            // åŸºæœ¬è¨ˆç®—
            const cogsRate = parseFloat(document.getElementById('cogsRate').value) / 100;
            const freightRate = parseFloat(document.getElementById('freightRate').value) / 100;
            const utilitiesRate = parseFloat(document.getElementById('utilitiesRate').value) / 100;
            const paymentFeeRate = parseFloat(document.getElementById('paymentFeeRate').value) / 100;
            const monthlyTarget = parseFloat(document.getElementById('monthlyTarget').value);

            const cogs = monthlySales * cogsRate;
            const grossProfit = monthlySales - cogs;

            // äººä»¶è²»è¨ˆç®—ï¼ˆå£²ä¸Šãƒ¬ãƒ³ã‚¸åˆ¥ä¿‚æ•°ï¼‰
            const personnelRate = calculatePersonnelRate(monthlySales);
            const personnelCost = monthlySales * personnelRate;

            // å¤‰å‹•è²»è¨ˆç®—
            const freight = monthlySales * freightRate;
            const utilities = monthlySales * utilitiesRate;
            const paymentFee = monthlySales * paymentFeeRate;

            // å–¶æ¥­ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³
            const commission = calculateCommission(monthlySales, monthlyTarget);

            // å–¶æ¥­åˆ©ç›Š
            const operatingProfit = grossProfit - personnelCost - freight - utilities - paymentFee - commission;

            return {
                sales: monthlySales,
                cogs: cogs,
                grossProfit: grossProfit,
                personnelCost: personnelCost,
                personnelRate: personnelRate,
                freight: freight,
                utilities: utilities,
                paymentFee: paymentFee,
                commission: commission,
                operatingProfit: operatingProfit
            };
        }

        // å…¨ä½“è¨ˆç®—å®Ÿè¡Œ
        function calculate() {
            const results = [];
            let totalSales = 0, totalOperatingProfit = 0;

            // æœˆæ¬¡è¨ˆç®—
            for (let i = 0; i < 12; i++) {
                const monthResult = calculateMonthlyPL(i);
                results.push(monthResult);
                totalSales += monthResult.sales;
                totalOperatingProfit += monthResult.operatingProfit;
            }

            // çµæœè¡¨ç¤ºæ›´æ–°
            updateResultsTable(results);
            updateStatusDisplay(totalSales, totalOperatingProfit, results);
            updateStoresTotals();
        }

        // çµæœãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateResultsTable(results) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            const items = [
                { label: 'å£²ä¸Šé«˜', key: 'sales', format: 'number' },
                { label: 'å£²ä¸ŠåŸä¾¡', key: 'cogs', format: 'number' },
                { label: 'ç²—åˆ©ç›Š', key: 'grossProfit', format: 'number' },
                { label: 'äººä»¶è²»', key: 'personnelCost', format: 'number' },
                { label: 'äººä»¶è²»ç‡', key: 'personnelRate', format: 'percent' },
                { label: 'è²¨ç‰©é‹è³ƒ', key: 'freight', format: 'number' },
                { label: 'æ°´é“å…‰ç†±è²»', key: 'utilities', format: 'number' },
                { label: 'æ”¯æ‰•æ‰‹æ•°æ–™', key: 'paymentFee', format: 'number' },
                { label: 'å–¶æ¥­ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³', key: 'commission', format: 'number' },
                { label: 'å–¶æ¥­åˆ©ç›Š', key: 'operatingProfit', format: 'profit' }
            ];

            items.forEach(item => {
                const row = document.createElement('tr');
                let html = `<td style="text-align: left; font-weight: bold;">${item.label}</td>`;

                let total = 0;
                results.forEach(result => {
                    const value = result[item.key] || 0;
                    total += value;

                    if (item.format === 'percent') {
                        html += `<td>${(value * 100).toFixed(1)}%</td>`;
                    } else if (item.format === 'profit') {
                        const className = value >= 0 ? 'profit-positive' : 'profit-negative';
                        html += `<td class="${className}">${Math.round(value).toLocaleString()}</td>`;
                    } else {
                        html += `<td>${Math.round(value).toLocaleString()}</td>`;
                    }
                });

                // å¹´é–“åˆè¨ˆ
                if (item.format === 'percent') {
                    const avgRate = total / results.length;
                    html += `<td style="font-weight: bold;">${(avgRate * 100).toFixed(1)}%</td>`;
                } else if (item.format === 'profit') {
                    const className = total >= 0 ? 'profit-positive' : 'profit-negative';
                    html += `<td class="${className}" style="font-weight: bold;">${Math.round(total).toLocaleString()}</td>`;
                } else {
                    html += `<td style="font-weight: bold;">${Math.round(total).toLocaleString()}</td>`;
                }

                if (item.key === 'operatingProfit') {
                    row.className = 'total-row';
                }

                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
        function updateStatusDisplay(totalSales, totalOperatingProfit, results) {
            document.getElementById('totalSalesDisplay').textContent = Math.round(totalSales).toLocaleString();
            document.getElementById('operatingProfitDisplay').textContent = Math.round(totalOperatingProfit).toLocaleString();
            
            const profitRate = totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0;
            document.getElementById('profitRateDisplay').textContent = profitRate.toFixed(1) + '%';

            const avgPersonnelRate = results.reduce((sum, r) => sum + (r.personnelRate || 0), 0) / results.length;
            document.getElementById('personnelRateDisplay').textContent = (avgPersonnelRate * 100).toFixed(1) + '%';
        }

        // åº—èˆ—åˆè¨ˆæ›´æ–°
        function updateStoresTotals() {
            stores.forEach(store => {
                updateStoreTotal(store);
            });
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateCharts() {
            updateSalesChart();
            updateStoreChart();
            updateProfitChart();
        }

        // å£²ä¸Šæ¨ç§»ã‚°ãƒ©ãƒ•
        function updateSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            if (salesChart) {
                salesChart.destroy();
            }

            const salesData = [];
            for (let i = 0; i < 12; i++) {
                const result = calculateMonthlyPL(i);
                salesData.push(Math.round(result.sales));
            }

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'æœˆæ¬¡å£²ä¸Š',
                        data: salesData,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡å††';
                                }
                            }
                        }
                    }
                }
            });
        }

        // åº—èˆ—åˆ¥å£²ä¸Šæ§‹æˆã‚°ãƒ©ãƒ•
        function updateStoreChart() {
            const ctx = document.getElementById('storeChart').getContext('2d');
            
            if (storeChart) {
                storeChart.destroy();
            }

            const storeData = [];
            const storeLabels = [];
            stores.forEach(store => {
                let total = 0;
                for (let i = 1; i <= 12; i++) {
                    total += parseFloat(document.getElementById(`store${store}-month${i}`).value) || 0;
                }
                storeData.push(Math.round(total));
                storeLabels.push(`åº—èˆ—${store}`);
            });

            storeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: storeLabels,
                    datasets: [{
                        data: storeData,
                        backgroundColor: [
                            '#e74c3c',
                            '#f39c12',
                            '#f1c40f',
                            '#27ae60',
                            '#3498db',
                            '#9b59b6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed.toLocaleString()}ä¸‡å†† (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // æç›Šæ¨ç§»ã‚°ãƒ©ãƒ•
        function updateProfitChart() {
            const ctx = document.getElementById('profitChart').getContext('2d');
            
            if (profitChart) {
                profitChart.destroy();
            }

            const salesData = [];
            const profitData = [];
            
            for (let i = 0; i < 12; i++) {
                const result = calculateMonthlyPL(i);
                salesData.push(Math.round(result.sales));
                profitData.push(Math.round(result.operatingProfit));
            }

            profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'å£²ä¸Šé«˜',
                            data: salesData,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'å–¶æ¥­åˆ©ç›Š',
                            data: profitData,
                            type: 'line',
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡å††';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡å††';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­è¾¼
        function loadSampleData() {
            // å¼•ç¶™ãæ›¸ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ç¾æ³ã‚’å‚è€ƒã«ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            const sampleData = {
                A: [1200, 1150, 1300, 1250, 1100, 1350, 1400, 1300, 1200, 1250, 1180, 1220], // ä¸»åŠ›åº—40%
                B: [600, 580, 650, 620, 550, 680, 700, 650, 600, 620, 590, 610],   // ä¸­å …åº—20%
                C: [450, 430, 490, 470, 410, 510, 520, 490, 450, 470, 440, 460],   // ä¸­å …åº—15%
                D: [300, 290, 320, 310, 270, 340, 350, 320, 300, 310, 290, 300],   // å°è¦æ¨¡åº—10%
                E: [240, 230, 260, 250, 220, 270, 280, 260, 240, 250, 230, 240],   // å°è¦æ¨¡åº—8%
                F: [210, 200, 230, 220, 190, 240, 250, 230, 210, 220, 200, 210]    // æ–°è¦åº—7%
            };

            stores.forEach(store => {
                for (let i = 1; i <= 12; i++) {
                    document.getElementById(`store${store}-month${i}`).value = sampleData[store][i-1];
                }
                updateStoreTotal(store);
            });

            calculate();
            updateCharts();
            showStatus('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (!confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;

            stores.forEach(store => {
                for (let i = 1; i <= 12; i++) {
                    document.getElementById(`store${store}-month${i}`).value = 0;
                }
                updateStoreTotal(store);
            });

            calculate();
            updateCharts();
            showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            const data = {
                department: "SRäº‹æ¥­éƒ¨",
                timestamp: new Date().toISOString(),
                metadata: {
                    source: "sr_simulator_phase2",
                    version: "2.0",
                    checksum: Date.now().toString()
                },
                storesData: {},
                config: {
                    cogsRate: parseFloat(document.getElementById('cogsRate').value),
                    freightRate: parseFloat(document.getElementById('freightRate').value),
                    utilitiesRate: parseFloat(document.getElementById('utilitiesRate').value),
                    paymentFeeRate: parseFloat(document.getElementById('paymentFeeRate').value),
                    monthlyTarget: parseFloat(document.getElementById('monthlyTarget').value),
                    baseSalary: parseFloat(document.getElementById('baseSalary').value)
                }
            };

            // åº—èˆ—ãƒ‡ãƒ¼ã‚¿åé›†
            stores.forEach(store => {
                const monthlyData = [];
                for (let i = 1; i <= 12; i++) {
                    monthlyData.push(parseFloat(document.getElementById(`store${store}-month${i}`).value) || 0);
                }
                data.storesData[store] = {
                    monthly: monthlyData,
                    annual: monthlyData.reduce((sum, val) => sum + val, 0)
                };
            });

            // è¨ˆç®—çµæœã‚‚ä¿å­˜
            data.calculatedResults = [];
            for (let i = 0; i < 12; i++) {
                data.calculatedResults.push(calculateMonthlyPL(i));
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿èª­è¾¼
        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) {
                showStatus('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }

            try {
                const data = JSON.parse(savedData);
                
                // åº—èˆ—ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                if (data.storesData) {
                    stores.forEach(store => {
                        if (data.storesData[store] && data.storesData[store].monthly) {
                            for (let i = 1; i <= 12; i++) {
                                const value = data.storesData[store].monthly[i-1] || 0;
                                document.getElementById(`store${store}-month${i}`).value = value;
                            }
                            updateStoreTotal(store);
                        }
                    });
                }

                // è¨­å®šãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                if (data.config) {
                    document.getElementById('cogsRate').value = data.config.cogsRate || 27.2;
                    document.getElementById('freightRate').value = data.config.freightRate || 1.5;
                    document.getElementById('utilitiesRate').value = data.config.utilitiesRate || 0.8;
                    document.getElementById('paymentFeeRate').value = data.config.paymentFeeRate || 2.5;
                    document.getElementById('monthlyTarget').value = data.config.monthlyTarget || 10000;
                    document.getElementById('baseSalary').value = data.config.baseSalary || 400;
                }

                calculate();
                updateCharts();
                showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
            } catch (error) {
                showStatus('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                console.error('Load error:', error);
            }
        }

        // CSVå‡ºåŠ›
        function exportCSV() {
            const results = [];
            for (let i = 0; i < 12; i++) {
                results.push(calculateMonthlyPL(i));
            }

            let csv = 'SRäº‹æ¥­éƒ¨ æç›Šè¨ˆç®—æ›¸\n\n';
            csv += 'é …ç›®,' + months.join(',') + ',å¹´é–“åˆè¨ˆ\n';

            const items = [
                { label: 'å£²ä¸Šé«˜', key: 'sales' },
                { label: 'å£²ä¸ŠåŸä¾¡', key: 'cogs' },
                { label: 'ç²—åˆ©ç›Š', key: 'grossProfit' },
                { label: 'äººä»¶è²»', key: 'personnelCost' },
                { label: 'è²¨ç‰©é‹è³ƒ', key: 'freight' },
                { label: 'æ°´é“å…‰ç†±è²»', key: 'utilities' },
                { label: 'æ”¯æ‰•æ‰‹æ•°æ–™', key: 'paymentFee' },
                { label: 'å–¶æ¥­ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³', key: 'commission' },
                { label: 'å–¶æ¥­åˆ©ç›Š', key: 'operatingProfit' }
            ];

            items.forEach(item => {
                let row = item.label;
                let total = 0;
                results.forEach(result => {
                    const value = Math.round(result[item.key] || 0);
                    row += ',' + value;
                    total += value;
                });
                row += ',' + Math.round(total);
                csv += row + '\n';
            });

            // åº—èˆ—åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚‚è¿½åŠ 
            csv += '\nåº—èˆ—åˆ¥å£²ä¸Š\n';
            csv += 'åº—èˆ—,' + months.join(',') + ',å¹´é–“åˆè¨ˆ\n';
            stores.forEach(store => {
                let row = `åº—èˆ—${store}`;
                let total = 0;
                for (let i = 1; i <= 12; i++) {
                    const value = parseFloat(document.getElementById(`store${store}-month${i}`).value) || 0;
                    row += ',' + Math.round(value);
                    total += value;
                }
                row += ',' + Math.round(total);
                csv += row + '\n';
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `SRäº‹æ¥­éƒ¨_æç›Šè¨ˆç®—æ›¸_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();

            showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }

        // çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã¸é€ä¿¡
        function sendToIntegratedSystem() {
            const data = {
                department: "SRäº‹æ¥­éƒ¨",
                timestamp: new Date().toISOString(),
                metadata: {
                    source: "sr_simulator_phase2",
                    version: "2.0",
                    checksum: Date.now().toString()
                }
            };

            // è¨ˆç®—çµæœåé›†
            const results = [];
            let totalSales = 0, totalOperatingProfit = 0;
            
            for (let i = 0; i < 12; i++) {
                const monthResult = calculateMonthlyPL(i);
                results.push(monthResult);
                totalSales += monthResult.sales;
                totalOperatingProfit += monthResult.operatingProfit;
            }

            data.sales = {
                monthly: results.map(r => Math.round(r.sales)),
                annual: Math.round(totalSales)
            };

            data.operatingProfit = {
                monthly: results.map(r => Math.round(r.operatingProfit)),
                annual: Math.round(totalOperatingProfit)
            };

            data.expenses = {
                personnel: {
                    monthly: results.map(r => Math.round(r.personnelCost)),
                    annual: Math.round(results.reduce((sum, r) => sum + r.personnelCost, 0))
                },
                cogs: {
                    monthly: results.map(r => Math.round(r.cogs)),
                    annual: Math.round(results.reduce((sum, r) => sum + r.cogs, 0))
                }
            };

            // çµ±åˆã‚·ã‚¹ãƒ†ãƒ ç”¨ã®ã‚­ãƒ¼ã§ä¿å­˜
            localStorage.setItem('pl_system_combined_data_sr', JSON.stringify(data));
            
            showStatus('çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã¸ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.textContent = message;
            statusDiv.className = type === 'success' ? 'profit-positive' : 
                                 type === 'error' ? 'profit-negative' : '';
            
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        // è¨­å®šå¤‰æ›´æ™‚ã®å†è¨ˆç®—
        document.getElementById('cogsRate').addEventListener('input', () => { calculate(); updateCharts(); });
        document.getElementById('freightRate').addEventListener('input', () => { calculate(); updateCharts(); });
        document.getElementById('utilitiesRate').addEventListener('input', () => { calculate(); updateCharts(); });
        document.getElementById('paymentFeeRate').addEventListener('input', () => { calculate(); updateCharts(); });
        document.getElementById('monthlyTarget').addEventListener('input', () => { calculate(); updateCharts(); });
        document.getElementById('baseSalary').addEventListener('input', () => { calculate(); updateCharts(); });
    </script>
</body>
</html>
