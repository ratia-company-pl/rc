<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4完成版 統合PLシステム - 販管費19項目完全対応</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 8px;
        }

        .version-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
            font-size: 0.9em;
        }

        .container {
            max-width: 1400px;
            margin: 15px auto;
            padding: 0 15px;
        }

        /* ナビゲーションボタン */
        .nav-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nav-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* データ受信状況テーブル */
        .status-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .status-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .status-table th,
        .status-table td {
            padding: 10px 15px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .status-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-completed { background-color: #27ae60; }
        .status-pending { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }

        /* チャート表示 */
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: 450px;
        }

        .section-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        /* 統一テーブルスタイル（情報密度最大化） */
        .pl-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .unified-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            margin-bottom: 15px;
        }

        .unified-table th,
        .unified-table td {
            padding: 4px;
            text-align: right;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #f0f0f0;
        }

        /* ID列：極小幅 */
        .unified-table .id-column {
            width: 25px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            padding: 4px 2px;
        }

        /* 項目名列：左寄せ、最大文字数+1スペース */
        .unified-table th:nth-child(2),
        .unified-table td:nth-child(2) {
            text-align: left;
            font-weight: bold;
            width: 120px;
            padding: 4px 8px;
        }

        /* 月別データ列：均等幅拡張 */
        .unified-table th:nth-child(n+3):nth-child(-n+14),
        .unified-table td:nth-child(n+3):nth-child(-n+14) {
            width: calc((100% - 25px - 120px - 80px) / 12);
            min-width: 50px;
            padding: 4px 6px;
        }

        /* 年間合計列 */
        .unified-table th:last-child,
        .unified-table td:last-child {
            width: 80px;
            font-weight: bold;
            background-color: #e8f4f8;
            padding: 4px 6px;
        }

        .unified-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 6px 4px;
        }

        .total-row {
            background-color: #e8f4f8;
            font-weight: bold;
            border-top: 2px solid #667eea;
        }

        .profit-row {
            background-color: #d4edda;
            font-weight: bold;
            color: #155724;
        }

        .admin-expense-row:nth-child(even) {
            background-color: #f8f9fa;
        }

        .admin-expense-row:hover {
            background-color: #e3f2fd;
        }

        .executive-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .executive-section .section-title {
            border-bottom-color: #27ae60;
        }

        .executive-section .unified-table th {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .executive-row {
            background-color: #e8f5e8;
        }

        .common-expense-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .common-expense-section .section-title {
            border-bottom-color: #f39c12;
        }

        .common-expense-section .unified-table th {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .summary-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid #e74c3c;
        }

        .summary-section .section-title {
            border-bottom-color: #e74c3c;
        }

        .summary-section .unified-table th {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .final-profit-positive {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }

        .final-profit-negative {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        .data-source {
            font-size: 0.8em;
            color: #888;
            margin-top: 10px;
            text-align: center;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .nav-buttons {
                justify-content: center;
            }
            
            .nav-btn {
                padding: 10px 18px;
                font-size: 0.9em;
            }
            
            .unified-table {
                font-size: 0.7em;
            }
            
            .unified-table th,
            .unified-table td {
                padding: 3px 2px;
            }
        }

        /* スクロール用コンテナ */
        .table-scroll {
            overflow-x: auto;
            margin: -5px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Phase 4完成版 統合PLシステム</h1>
        <div class="version-badge">統一構造Version 3.0 + 19項目販管費 + 7月開始年度対応</div>
        <div id="lastUpdate" class="data-source">最終更新: 自動取得中...</div>
    </div>

    <div class="container">
        <!-- ナビゲーションボタン -->
        <div class="nav-section">
            <div class="nav-buttons">
                <a href="dashboard.html" class="nav-btn">📊 メインダッシュボード</a>
                <a href="sr-pl.html" class="nav-btn">🏢 SR事業部PL</a>
                <a href="w-pl.html" class="nav-btn">🏪 W事業部PL</a>
                <a href="rc-pl.html" class="nav-btn">🏬 RC事業部PL</a>
                <a href="rcd-pl.html" class="nav-btn">🏭 RCD事業部PL</a>
                <a href="budget-input.html" class="nav-btn">⚙️ 予算入力システム</a>
            </div>
        </div>

        <!-- 事業部データ受信状況（1行テーブル） -->
        <div class="status-section">
            <h2 class="section-title">🔄 事業部別データ受信状況</h2>
            <table class="status-table">
                <thead>
                    <tr>
                        <th>SR事業部</th>
                        <th>W事業部</th>
                        <th>RC事業部</th>
                        <th>RCD事業部</th>
                        <th>全体進捗</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <span class="status-indicator" id="srStatus"></span>
                            <div id="srLastUpdate">未受信</div>
                        </td>
                        <td>
                            <span class="status-indicator" id="wStatus"></span>
                            <div id="wLastUpdate">未受信</div>
                        </td>
                        <td>
                            <span class="status-indicator" id="rcStatus"></span>
                            <div id="rcLastUpdate">未受信</div>
                        </td>
                        <td>
                            <span class="status-indicator" id="rcdStatus"></span>
                            <div id="rcdLastUpdate">未受信</div>
                        </td>
                        <td>
                            <strong id="overallProgress">0/4完了</strong>
                            <br>
                            <span id="progressPercentage">0%</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 月次推移グラフ（2軸：売上・販管費棒グラフ + 営業利益累計折れ線） -->
        <div class="chart-container">
            <h2 class="section-title">📊 月次推移グラフ（売上・販管費・営業利益累計）</h2>
            <canvas id="salesChart"></canvas>
        </div>

        <!-- 統合損益計算書・販管費19項目詳細（1ブロック統合版・レイアウト最適化） -->
        <div class="pl-section">
            <h2 class="section-title">📈 統合損益計算書・販管費19項目詳細（7月開始年度）</h2>
            <div class="table-scroll">
                <table class="unified-table" id="combinedPLTable">
                    <thead>
                        <tr>
                            <th class="id-column">ID</th>
                            <th>項目名</th>
                            <th>7月</th>
                            <th>8月</th>
                            <th>9月</th>
                            <th>10月</th>
                            <th>11月</th>
                            <th>12月</th>
                            <th>1月</th>
                            <th>2月</th>
                            <th>3月</th>
                            <th>4月</th>
                            <th>5月</th>
                            <th>6月</th>
                            <th>年間合計</th>
                        </tr>
                    </thead>
                    <tbody id="combinedPLBody">
                        <!-- 動的に生成される統合PLデータ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 役員報酬（ダッシュボード連携・統一レイアウト） -->
        <div class="executive-section">
            <h2 class="section-title">👔 役員報酬（ダッシュボード連携）</h2>
            <div class="table-scroll">
                <table class="unified-table" id="executiveTable">
                    <thead>
                        <tr>
                            <th class="id-column"></th>
                            <th>項目名</th>
                            <th>7月</th>
                            <th>8月</th>
                            <th>9月</th>
                            <th>10月</th>
                            <th>11月</th>
                            <th>12月</th>
                            <th>1月</th>
                            <th>2月</th>
                            <th>3月</th>
                            <th>4月</th>
                            <th>5月</th>
                            <th>6月</th>
                            <th>年間合計</th>
                        </tr>
                    </thead>
                    <tbody id="executiveBody">
                        <!-- 動的に生成される役員報酬データ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 全社共通費販管費（万円単位CSVデータ・統一レイアウト） -->
        <div class="common-expense-section">
            <h2 class="section-title">🏢 全社共通費販管費（万円単位）</h2>
            <div class="table-scroll">
                <table class="unified-table" id="commonExpenseTable">
                    <thead>
                        <tr>
                            <th class="id-column">ID</th>
                            <th>項目名</th>
                            <th>7月</th>
                            <th>8月</th>
                            <th>9月</th>
                            <th>10月</th>
                            <th>11月</th>
                            <th>12月</th>
                            <th>1月</th>
                            <th>2月</th>
                            <th>3月</th>
                            <th>4月</th>
                            <th>5月</th>
                            <th>6月</th>
                            <th>年間合計</th>
                        </tr>
                    </thead>
                    <tbody id="commonExpenseBody">
                        <!-- 動的に生成される全社共通費データ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RC全体集計（統一レイアウト） -->
        <div class="summary-section">
            <h2 class="section-title">🎯 RC全体集計</h2>
            <div class="table-scroll">
                <table class="unified-table" id="summaryTable">
                    <thead>
                        <tr>
                            <th class="id-column"></th>
                            <th>項目名</th>
                            <th>7月</th>
                            <th>8月</th>
                            <th>9月</th>
                            <th>10月</th>
                            <th>11月</th>
                            <th>12月</th>
                            <th>1月</th>
                            <th>2月</th>
                            <th>3月</th>
                            <th>4月</th>
                            <th>5月</th>
                            <th>6月</th>
                            <th>年間合計</th>
                        </tr>
                    </thead>
                    <tbody id="summaryBody">
                        <!-- 動的に生成される集計データ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 統一構造Version 3.0 対応データ管理システム（7月開始年度対応・レイアウト最適化版）
        class Phase4DataManager {
            constructor() {
                this.STORAGE_KEYS = {
                    sr: 'pl_system_sr_data',
                    w: 'pl_system_w_data',
                    rc: 'pl_system_rc_data',
                    rcd: 'pl_system_rcd_data',
                    dashboard: 'dashboard_integration_data'
                };

                // 販管費19項目統一構造マッピング（Version 3.0）
                this.EXPENSE_ITEMS = {
                    1: '人件費統合',
                    2: '法定福利費',
                    3: '衛生費',
                    4: '物流管理費',
                    5: '地代家賃',
                    6: '外注費',
                    7: '貨物運賃',
                    8: '広告宣伝費',
                    9: '旅費交通費',
                    10: '通信費',
                    11: '販売促進費',
                    12: '消耗品費',
                    13: '事務用品費',
                    14: '水道光熱費',
                    15: '支払手数料',
                    16: 'リース料',
                    17: '保険料',
                    18: '支払報酬料',
                    19: '減価償却費'
                };

                // 全社共通費データ（万円単位・CSVから更新）
                this.commonExpenseData = {
                    '管理諸費': [34, 37, 41, 34, 37, 44, 36, 39, 44, 36, 39, 44],
                    '修繕費': [22, 0, 1, 0, 0, 12, 13, 0, 7, 0, 3, 0],
                    '車両費': [2, 2, 1, 2, 3, 2, 2, 0, 19, 2, 4, 1],
                    '租税公課': [3, 3, 2, 1, 1, 1, 7, 2, 1, 12, 2, 5],
                    '交際費': [0, 1, 0, 2, 1, 0, 2, 4, 14, 1, 1, 9],
                    '諸会費': [1, 1, 1, 1, 1, 1, 0, 1, 18, 5, 2, 1],
                    '会議費': [0, 2, 2, 0, 2, 3, 1, 3, 1, 2, 1, 3],
                    '福利厚生費': [1, 1, 1, 1, 1, 2, 1, 1, 1, 2, 2, 2],
                    '研修費': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0],
                    '雑費': [1, 1, 1, 0, 0, 0, 0, 0, 0, 5, 0, 0],
                    '寄付金': [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0]
                };

                this.initializeSystem();
            }

            initializeSystem() {
                this.loadAllDepartmentData();
                this.calculateUnifiedPL();
                this.updateDisplay();
                this.startAutoRefresh();
            }

            loadAllDepartmentData() {
                this.departmentData = {};
                
                Object.keys(this.STORAGE_KEYS).forEach(dept => {
                    if (dept === 'dashboard') return;
                    const data = localStorage.getItem(this.STORAGE_KEYS[dept]);
                    if (data) {
                        try {
                            this.departmentData[dept] = JSON.parse(data);
                        } catch (e) {
                            console.error(`Error parsing ${dept} data:`, e);
                            this.departmentData[dept] = null;
                        }
                    } else {
                        this.departmentData[dept] = null;
                    }
                });

                // ダッシュボードから役員報酬データを取得
                this.loadExecutiveDataFromDashboard();
            }

            loadExecutiveDataFromDashboard() {
                try {
                    const dashboardData = localStorage.getItem('dashboard_integration_data');
                    if (dashboardData) {
                        const data = JSON.parse(dashboardData);
                        if (data.executiveData) {
                            // ダッシュボードから送られる完全な役員報酬データ（賞与・法定福利費含む）
                            this.executiveData = data.executiveData;
                        } else {
                            // デフォルトデータ（ダッシュボード未連携時）
                            this.executiveData = {
                                compensation: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676],
                                welfare: [107, 107, 107, 88, 88, 88, 88, 88, 88, 88, 88, 88]
                            };
                        }
                    }
                } catch (error) {
                    console.error('役員報酬データ取得エラー:', error);
                    // エラー時デフォルトデータ
                    this.executiveData = {
                        compensation: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676],
                        welfare: [107, 107, 107, 88, 88, 88, 88, 88, 88, 88, 88, 88]
                    };
                }
            }

            calculateUnifiedPL() {
                // 統合データの初期化（7月開始の12ヶ月）
                this.unifiedData = {
                    sales: Array(12).fill(0),
                    cogs: Array(12).fill(0),
                    expenses: {}
                };

                // 販管費19項目の初期化
                for (let i = 1; i <= 19; i++) {
                    this.unifiedData.expenses[i] = Array(12).fill(0);
                }

                // 各事業部データの統合
                Object.keys(this.departmentData).forEach(dept => {
                    const data = this.departmentData[dept];
                    if (data && data.metadata && data.metadata.version === '3.0') {
                        // 売上・原価の統合
                        for (let month = 0; month < 12; month++) {
                            this.unifiedData.sales[month] += data.sales[month] || 0;
                            this.unifiedData.cogs[month] += data.cogs[month] || 0;
                        }

                        // 販管費19項目の統合
                        for (let expenseId = 1; expenseId <= 19; expenseId++) {
                            if (data.expenses && data.expenses[expenseId]) {
                                for (let month = 0; month < 12; month++) {
                                    this.unifiedData.expenses[expenseId][month] += 
                                        data.expenses[expenseId][month] || 0;
                                }
                            }
                        }
                    }
                });

                // 営業利益と累計営業利益の計算（役員報酬・共通費含む）
                this.calculateFinalProfit();
            }

            calculateFinalProfit() {
                // 各月の営業利益計算（全社共通費含む）
                this.monthlyOperatingProfit = Array(12).fill(0);
                this.cumulativeOperatingProfit = Array(12).fill(0);
                this.monthlyTotalExpenses = Array(12).fill(0);
                
                let cumulativeSum = 0;
                for (let month = 0; month < 12; month++) {
                    // 月次販管費合計（事業部分）
                    let monthlyDeptExpenses = 0;
                    for (let expenseId = 1; expenseId <= 19; expenseId++) {
                        monthlyDeptExpenses += this.unifiedData.expenses[expenseId][month];
                    }

                    // 役員報酬追加（ダッシュボードから受信・万円単位で加算）
                    const executiveTotal = ((this.executiveData.compensation[month] || 0) + 
                                          (this.executiveData.welfare[month] || 0)) * 10000;
                    
                    // 全社共通費追加（万円単位で加算）
                    let commonExpenseTotal = 0;
                    Object.values(this.commonExpenseData).forEach(monthlyData => {
                        commonExpenseTotal += monthlyData[month] * 10000;
                    });

                    // 月次全体販管費
                    this.monthlyTotalExpenses[month] = monthlyDeptExpenses + executiveTotal + commonExpenseTotal;

                    // 月次営業利益
                    const monthlySales = this.unifiedData.sales[month];
                    const monthlyCogs = this.unifiedData.cogs[month];
                    const monthlyGrossProfit = monthlySales - monthlyCogs;
                    this.monthlyOperatingProfit[month] = monthlyGrossProfit - this.monthlyTotalExpenses[month];
                    
                    // 累計営業利益
                    cumulativeSum += this.monthlyOperatingProfit[month];
                    this.cumulativeOperatingProfit[month] = cumulativeSum;
                }
            }

            updateDisplay() {
                this.updateCombinedPLTable();
                this.updateExecutiveTable();
                this.updateCommonExpenseTable();
                this.updateSummaryTable();
                this.updateDepartmentStatus();
                this.updateChart();
                this.updateLastUpdate();
            }

            updateCombinedPLTable() {
                const tbody = document.getElementById('combinedPLBody');
                tbody.innerHTML = '';

                // 売上行
                const salesRow = this.createUnifiedRow('', '売上高', this.unifiedData.sales, 'total-row');
                tbody.appendChild(salesRow);

                // 売上原価行
                const cogsRow = this.createUnifiedRow('', '売上原価', this.unifiedData.cogs, '');
                tbody.appendChild(cogsRow);

                // 売上総利益行
                const grossProfitData = this.unifiedData.sales.map((sales, i) => sales - this.unifiedData.cogs[i]);
                const grossProfitRow = this.createUnifiedRow('', '売上総利益', grossProfitData, 'profit-row');
                tbody.appendChild(grossProfitRow);

                // 販管費19項目詳細
                for (let expenseId = 1; expenseId <= 19; expenseId++) {
                    const expenseData = this.unifiedData.expenses[expenseId];
                    const expenseName = this.EXPENSE_ITEMS[expenseId];
                    
                    const row = this.createUnifiedRow(expenseId, expenseName, expenseData, 'admin-expense-row');
                    tbody.appendChild(row);
                }

                // 販管費合計行（事業部分のみ）
                const deptExpensesData = Array(12).fill(0);
                for (let month = 0; month < 12; month++) {
                    for (let expenseId = 1; expenseId <= 19; expenseId++) {
                        deptExpensesData[month] += this.unifiedData.expenses[expenseId][month];
                    }
                }
                const deptExpensesRow = this.createUnifiedRow('', '事業部販管費計', deptExpensesData, 'total-row');
                tbody.appendChild(deptExpensesRow);
            }

            updateExecutiveTable() {
                const tbody = document.getElementById('executiveBody');
                tbody.innerHTML = '';

                // 役員報酬行（ダッシュボードから受信・賞与含む）
                const compensationRow = this.createUnifiedRow('', '役員報酬', this.executiveData.compensation || [], 'executive-row');
                tbody.appendChild(compensationRow);

                // 法定福利費行（ダッシュボードから受信）
                const welfareRow = this.createUnifiedRow('', '法定福利費', this.executiveData.welfare || [], '');
                tbody.appendChild(welfareRow);
            }

            updateCommonExpenseTable() {
                const tbody = document.getElementById('commonExpenseBody');
                tbody.innerHTML = '';

                let idCounter = 24; // CSVのID開始番号
                Object.entries(this.commonExpenseData).forEach(([itemName, monthlyData]) => {
                    const row = this.createUnifiedRow(idCounter, itemName, monthlyData, '');
                    tbody.appendChild(row);
                    idCounter++;
                });
            }

            updateSummaryTable() {
                const tbody = document.getElementById('summaryBody');
                tbody.innerHTML = '';

                // RC全体販管費
                const totalExpensesRow = this.createUnifiedRow('', 'RC全体販管費', 
                    this.monthlyTotalExpenses.map(val => Math.round(val / 10000)), 'total-row');
                tbody.appendChild(totalExpensesRow);

                // 全体営業利益
                const operatingProfitClass = this.monthlyOperatingProfit.some(val => val < 0) ? 'final-profit-negative' : 'final-profit-positive';
                const operatingProfitRow = this.createUnifiedRow('', '全体営業利益', 
                    this.monthlyOperatingProfit.map(val => Math.round(val / 10000)), operatingProfitClass);
                tbody.appendChild(operatingProfitRow);
            }

            createUnifiedRow(id, label, data, className) {
                const row = document.createElement('tr');
                if (className) row.className = className;

                // ID列（統一レイアウト）
                const idCell = document.createElement('td');
                idCell.textContent = id;
                idCell.className = 'id-column';
                row.appendChild(idCell);

                // 項目名列（統一レイアウト）
                const labelCell = document.createElement('td');
                labelCell.textContent = label;
                row.appendChild(labelCell);

                // 月別データ列（12ヶ月・統一レイアウト）
                let yearTotal = 0;
                for (let month = 0; month < 12; month++) {
                    const cell = document.createElement('td');
                    const value = data[month] || 0;
                    yearTotal += value;
                    // 万円単位での表示判定
                    const displayValue = (typeof value === 'number' && Math.abs(value) >= 10000) 
                        ? Math.round(value / 10000) 
                        : Math.round(value);
                    cell.textContent = displayValue.toLocaleString();
                    row.appendChild(cell);
                }

                // 年間合計列（統一レイアウト）
                const totalCell = document.createElement('td');
                const totalDisplayValue = (typeof yearTotal === 'number' && Math.abs(yearTotal) >= 10000) 
                    ? Math.round(yearTotal / 10000) 
                    : Math.round(yearTotal);
                totalCell.textContent = totalDisplayValue.toLocaleString();
                row.appendChild(totalCell);

                return row;
            }

            updateDepartmentStatus() {
                const departments = ['sr', 'w', 'rc', 'rcd'];
                let completedCount = 0;
                
                departments.forEach(dept => {
                    const statusElement = document.getElementById(`${dept}Status`);
                    const updateElement = document.getElementById(`${dept}LastUpdate`);
                    
                    const data = this.departmentData[dept];
                    
                    if (data && data.metadata) {
                        statusElement.className = 'status-indicator status-completed';
                        updateElement.textContent = new Date(data.metadata.lastUpdate).toLocaleString();
                        completedCount++;
                    } else {
                        statusElement.className = 'status-indicator status-pending';
                        updateElement.textContent = '未受信';
                    }
                });

                // 全体進捗の更新
                document.getElementById('overallProgress').textContent = `${completedCount}/4完了`;
                document.getElementById('progressPercentage').textContent = `${Math.round((completedCount / 4) * 100)}%`;
            }

            updateChart() {
                const ctx = document.getElementById('salesChart').getContext('2d');
                
                if (this.chart) {
                    this.chart.destroy();
                }

                const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
                
                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                type: 'bar',
                                label: '月次売上高（万円）',
                                data: this.unifiedData.sales.map(val => Math.round(val / 10000)),
                                backgroundColor: 'rgba(102, 126, 234, 0.7)',
                                borderColor: '#667eea',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                type: 'bar',
                                label: 'RC全体販管費（万円）',
                                data: this.monthlyTotalExpenses.map(val => Math.round(val / 10000)),
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: '#ff6384',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                type: 'line',
                                label: '全体営業利益累計（万円）',
                                data: this.cumulativeOperatingProfit.map(val => Math.round(val / 10000)),
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                borderWidth: 4,
                                fill: false,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '月次推移（売上・RC全体販管費・全体営業利益累計）',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '売上高・販管費（万円）'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '営業利益累計（万円）'
                                },
                                grid: {
                                    drawOnChartArea: true,
                                }
                            }
                        }
                    }
                });
            }

            updateLastUpdate() {
                document.getElementById('lastUpdate').textContent = 
                    `最終更新: ${new Date().toLocaleString()}`;
            }

            startAutoRefresh() {
                // 5秒間隔でデータを自動更新
                setInterval(() => {
                    this.loadAllDepartmentData();
                    this.calculateUnifiedPL();
                    this.updateDisplay();
                }, 5000);
            }
        }

        // システム初期化
        document.addEventListener('DOMContentLoaded', () => {
            window.phase4Manager = new Phase4DataManager();
        });
    </script>
</body>
</html>
