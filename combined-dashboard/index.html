<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ ï¼ˆçµ±ä¸€æ§‹é€ 19é …ç›®å®Œå…¨å¯¾å¿œç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header-row1 {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .main-title {
            font-size: 2.2em;
            font-weight: 800;
            margin: 0;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.1em;
            margin-top: 8px;
            opacity: 0.9;
        }

        .header-row2 {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            padding: 12px 20px;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 140px;
            text-align: center;
            cursor: pointer;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* KPIã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .header-row3 {
            background: #f8f9fa;
            padding: 20px;
        }

        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #e74c3c;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .kpi-card.positive {
            border-color: #27ae60;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
        }

        .kpi-card.negative {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #fdf2f2 0%, #fef5f5 100%);
        }

        .kpi-label {
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.6em;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .kpi-value.positive { color: #27ae60; }
        .kpi-value.negative { color: #e74c3c; }

        .kpi-detail {
            font-size: 0.75em;
            color: #95a5a6;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .header-row4 {
            background: #ecf0f1;
            padding: 15px 20px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .dept-status {
            padding: 8px 12px;
            border-radius: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 0.8em;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        /* é€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .header-row5 {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            padding: 12px 20px;
            color: white;
            text-align: center;
        }

        .dashboard-linkage-status {
            font-size: 0.9em;
            font-weight: 600;
        }

        .linkage-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.2);
            margin-left: 10px;
        }

        .linkage-indicator.active {
            background: rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.6em;
            font-weight: 800;
            margin-bottom: 20px;
            border-bottom: 4px solid #e74c3c;
            padding-bottom: 10px;
        }

        /* ãƒãƒ£ãƒ¼ãƒˆ */
        .chart-container {
            position: relative;
            height: 250px;
            margin: 25px 0;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
            font-size: 0.85em;
            background: white;
        }

        .data-table th, 
        .data-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .data-table th {
            background: #34495e;
            color: white;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .category-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .item-name {
            text-align: left !important;
            font-weight: 600;
            background: #ecf0f1;
            padding-left: 15px !important;
            min-width: 200px;
        }

        .data-row:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .annual-total {
            font-weight: bold;
            background: #f8f9fa;
        }

        .total-row {
            background: rgba(231, 76, 60, 0.15);
            font-weight: 800;
        }

        .grand-total {
            font-weight: bold;
            color: #e74c3c;
            background: #fff3cd;
        }

        /* å£²ä¸Šãƒ»ä»•å…¥ãƒ»ç²—åˆ©ãƒ†ãƒ¼ãƒ–ãƒ«å°‚ç”¨ */
        .sales-header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .cogs-header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .profit-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-section {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-info { background: #3498db; color: white; }
        .btn-warning { background: #f39c12; color: white; }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* åŒæœŸã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .sync-indicator.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .init-message {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #856404;
            font-weight: 600;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .main-title { font-size: 1.8em; }
            .nav-buttons { flex-direction: column; }
            .kpi-section { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: 1fr; }
            .action-section { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <!-- 1è¡Œç›®: ã‚¿ã‚¤ãƒˆãƒ« -->
            <div class="header-row1">
                <h1 class="main-title">4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ </h1>
                <p class="subtitle">çµ±ä¸€æ§‹é€ 19é …ç›®å®Œå…¨å¯¾å¿œç‰ˆãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿é€£æºå¯¾å¿œ</p>
            </div>

            <!-- 2è¡Œç›®: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="header-row2">
                <div class="nav-buttons">
                    <a href="../index.html" class="btn">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                    <a href="../budget-input.html" class="btn">äºˆç®—å…¥åŠ›</a>
                    <a href="../department-pl/sr-pl.html" class="btn">SRäº‹æ¥­éƒ¨</a>
                    <a href="../department-pl/w-pl.html" class="btn">Wäº‹æ¥­éƒ¨</a>
                    <a href="../department-pl/rc-pl.html" class="btn">RCæ”¯åº—äº‹æ¥­éƒ¨</a>
                    <a href="../department-pl/rcd-pl.html" class="btn">RCDç¤¾äº‹æ¥­éƒ¨</a>
                </div>
            </div>

            <!-- 3è¡Œç›®: KPIè¡¨ç¤º -->
            <div class="header-row3">
                <div class="kpi-section">
                    <div class="kpi-card" id="total-sales-card">
                        <div class="kpi-label">çµ±åˆå¹´é–“å£²ä¸Š</div>
                        <div class="kpi-value" id="total-sales">---ä¸‡å††</div>
                        <div class="kpi-detail">4äº‹æ¥­éƒ¨åˆè¨ˆ</div>
                    </div>
                    <div class="kpi-card" id="total-profit-card">
                        <div class="kpi-label">çµ±åˆå–¶æ¥­åˆ©ç›Š</div>
                        <div class="kpi-value" id="total-profit">---ä¸‡å††</div>
                        <div class="kpi-detail">è²©ç®¡è²»19é …ç›®æ§é™¤å¾Œ</div>
                    </div>
                    <div class="kpi-card" id="profit-rate-card">
                        <div class="kpi-label">çµ±åˆåˆ©ç›Šç‡</div>
                        <div class="kpi-value" id="profit-rate">---%</div>
                        <div class="kpi-detail">å¯¾å£²ä¸Šé«˜æ¯”ç‡</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">ãƒ‡ãƒ¼ã‚¿çµ±åˆçŠ¶æ³</div>
                        <div class="kpi-value" id="integration-count">-/4</div>
                        <div class="kpi-detail">äº‹æ¥­éƒ¨é€£æºå®Œäº†</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">è²©ç®¡è²»é …ç›®æ•°</div>
                        <div class="kpi-value" id="expense-items">19/19</div>
                        <div class="kpi-detail">çµ±ä¸€æ§‹é€ å¯¾å¿œ</div>
                    </div>
                </div>
            </div>

            <!-- 4è¡Œç›®: å„äº‹æ¥­éƒ¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="header-row4">
                <div class="status-grid">
                    <div id="sr-status" class="dept-status status-warning">SRäº‹æ¥­éƒ¨: å¾…æ©Ÿä¸­</div>
                    <div id="w-status" class="dept-status status-warning">Wäº‹æ¥­éƒ¨: å¾…æ©Ÿä¸­</div>
                    <div id="rc-status" class="dept-status status-warning">RCæ”¯åº—: å¾…æ©Ÿä¸­</div>
                    <div id="rcd-status" class="dept-status status-warning">RCDç¤¾: å¾…æ©Ÿä¸­</div>
                </div>
            </div>

            <!-- 5è¡Œç›®: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="header-row5">
                <div class="dashboard-linkage-status">
                    <span>ğŸ“„ è‡ªå‹•åŒæœŸã‚·ã‚¹ãƒ†ãƒ :</span>
                    <span class="linkage-indicator" id="sync-status">åœæ­¢ä¸­</span>
                    <span id="last-sync">æœ€çµ‚åŒæœŸ: --:--</span>
                </div>
            </div>
        </header>

        <!-- ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="init-message" id="init-message">
            âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ã€Œãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content">
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="action-section">
                <button class="action-btn btn-success" onclick="generateTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
                <button class="action-btn btn-primary" onclick="startAutoSync()">è‡ªå‹•åŒæœŸé–‹å§‹</button>
                <button class="action-btn btn-warning" onclick="stopAutoSync()">è‡ªå‹•åŒæœŸåœæ­¢</button>
                <button class="action-btn btn-info" onclick="manualRefresh()">æ‰‹å‹•æ›´æ–°</button>
                <button class="action-btn btn-info" onclick="exportToCSV()">CSVå‡ºåŠ›</button>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º -->
            <div class="chart-container">
                <canvas id="expenseChart"></canvas>
            </div>

            <!-- å£²ä¸Šãƒ»ä»•å…¥ãƒ»ç²—åˆ©ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <h2 class="section-title">å£²ä¸Šãƒ»ä»•å…¥ãƒ»ç²—åˆ©æ¨ç§»</h2>
            <div class="table-container" id="sales-table-container">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>

            <!-- è²©ç®¡è²»19é …ç›®ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <h2 class="section-title" style="margin-top: 40px;">è²©ç®¡è²»19é …ç›® è©³ç´°è¡¨ç¤ºï¼ˆçµ±ä¸€æ§‹é€ å¯¾å¿œï¼‰</h2>
            <div class="table-container" id="expense-table-container">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </main>
    </div>

    <!-- åŒæœŸã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ -->
    <div class="sync-indicator" id="sync-indicator">
        ğŸ“„ ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...
    </div>

    <script>
        // ===== ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰ =====
        const DataStorage = {
            keys: {
                sr: 'pl_system_sr_data',      // çµ±ä¸€ã‚­ãƒ¼
                w: 'pl_system_w_data',
                rc: 'pl_system_rc_data',
                rcd: 'pl_system_rcd_data',
                dashboard: 'dashboard_data',
                executive: 'executive_compensation_data'
            },
            
            get: function(key) {
                try {
                    // LocalStorageã¨sessionStorageã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
                    let data = localStorage.getItem(this.keys[key]);
                    if (!data) {
                        data = sessionStorage.getItem(this.keys[key]);
                    }
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error(`ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼(${key}):`, error);
                    return null;
                }
            },
            
            set: function(key, data) {
                try {
                    localStorage.setItem(this.keys[key], JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error(`ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼(${key}):`, error);
                    return false;
                }
            },
            
            hasData: function() {
                return ['sr', 'w', 'rc', 'rcd'].some(key => this.get(key) !== null);
            }
        };

        // ===== çµ±ä¸€æ§‹é€ 19é …ç›®å®šç¾©ï¼ˆä¿®æ­£ç‰ˆï¼‰ =====
        const UNIFIED_EXPENSE_ITEMS = {
            // çµ±ä¸€æ§‹é€  Version 3.0ã«åŸºã¥ã19é …ç›®
            1: { id: 1, name: 'äººä»¶è²»çµ±åˆ', category: 'personnel' },
            2: { id: 2, name: 'æ³•å®šç¦åˆ©è²»', category: 'personnel' },
            3: { id: 3, name: 'è¡›ç”Ÿè²»', category: 'personnel' },
            4: { id: 4, name: 'ç‰©æµç®¡ç†è²»', category: 'facility' },
            5: { id: 5, name: 'åœ°ä»£å®¶è³ƒ', category: 'facility' },
            6: { id: 6, name: 'å¤–æ³¨è²»', category: 'facility' },
            7: { id: 7, name: 'è·é€ é‹è³ƒ', category: 'facility' },
            8: { id: 8, name: 'åºƒå‘Šå®£ä¼è²»', category: 'marketing' },
            9: { id: 9, name: 'æ—…è²»äº¤é€šè²»', category: 'marketing' },
            10: { id: 10, name: 'é€šä¿¡è²»', category: 'marketing' },
            11: { id: 11, name: 'è²©å£²ä¿ƒé€²è²»', category: 'marketing' },
            12: { id: 12, name: 'æ¶ˆè€—å“è²»', category: 'operation' },
            13: { id: 13, name: 'äº‹å‹™ç”¨å“è²»', category: 'operation' },
            14: { id: 14, name: 'æ°´é“å…‰ç†±è²»', category: 'operation' },
            15: { id: 15, name: 'æ”¯æ‰•æ‰‹æ•°æ–™', category: 'operation' },
            16: { id: 16, name: 'ãƒªãƒ¼ã‚¹æ–™', category: 'equipment' },
            17: { id: 17, name: 'ä¿é™ºæ–™', category: 'equipment' },
            18: { id: 18, name: 'æ”¯æ‰•å ±é…¬æ–™', category: 'equipment' },
            19: { id: 19, name: 'æ¸›ä¾¡å„Ÿå´è²»', category: 'equipment' }
        };

        // ===== ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆçµ±ä¸€æ§‹é€ å¯¾å¿œç‰ˆï¼‰ =====
        function generateTestData() {
            // SRäº‹æ¥­éƒ¨ã®çµ±ä¸€æ§‹é€ ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®çµ±åˆã‚·ã‚¹ãƒ†ãƒ å‡ºåŠ›å½¢å¼ï¼‰
            const srUnifiedData = {
                metadata: {
                    department: 'SR',
                    lastUpdate: new Date().toISOString(),
                    version: '3.0',
                    unifiedStructure: true
                },
                sales: [3405, 3333, 3333, 3333, 3333, 3333, 3333, 3333, 3333, 3333, 3333, 3333],
                cogs: [1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861],
                expenses: {
                    1: [280, 280, 280, 280, 280, 280, 280, 280, 280, 280, 280, 280],   // äººä»¶è²»çµ±åˆ
                    2: [140, 140, 140, 127, 127, 127, 127, 127, 127, 127, 127, 127],   // æ³•å®šç¦åˆ©è²»
                    3: [14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14],               // è¡›ç”Ÿè²»
                    4: [208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208, 208],   // ç‰©æµç®¡ç†è²»
                    5: [214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214],   // åœ°ä»£å®¶è³ƒ
                    6: [122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122, 122],   // å¤–æ³¨è²»
                    7: [71, 9, 130, 66, 6, 69, 127, 66, 69, 66, 5, 117],               // è·é€ é‹è³ƒï¼ˆå¤‰å‹•ï¼‰
                    8: [30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30],               // åºƒå‘Šå®£ä¼è²»
                    9: [31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31, 31],               // æ—…è²»äº¤é€šè²»
                    10: [19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19],              // é€šä¿¡è²»
                    11: [39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39, 39],              // è²©å£²ä¿ƒé€²è²»
                    12: [4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4],                         // æ¶ˆè€—å“è²»
                    13: [11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11],              // äº‹å‹™ç”¨å“è²»
                    14: [40, 47, 68, 55, 42, 40, 43, 56, 56, 52, 40, 40],              // æ°´é“å…‰ç†±è²»ï¼ˆå¤‰å‹•ï¼‰
                    15: [62, 127, 81, 79, 133, 79, 105, 69, 61, 98, 70, 88],           // æ”¯æ‰•æ‰‹æ•°æ–™ï¼ˆå¤‰å‹•ï¼‰
                    16: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],                         // ãƒªãƒ¼ã‚¹æ–™
                    17: [6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6],                         // ä¿é™ºæ–™
                    18: [34, 34, 34, 34, 34, 34, 34, 34, 34, 34, 34, 34],              // æ”¯æ‰•å ±é…¬æ–™
                    19: [19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19]               // æ¸›ä¾¡å„Ÿå´è²»
                }
            };

            // ä»–äº‹æ¥­éƒ¨ã®ç°¡æ˜“ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆçµ±ä¸€æ§‹é€ å¤‰æ›å‰ï¼‰
            const testData = {
                w: {
                    sales: [1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674],
                    cogs: [880, 880, 880, 880, 880, 880, 880, 880, 880, 880, 880, 880],
                    personnel: [117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117],
                    welfare: [55, 55, 55, 55, 55, 55, 55, 55, 55, 55, 55, 55],
                    rent: [60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60],
                    advertising: [30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30],
                    fees: [11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11],
                    travel: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10],
                    communication: [3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3]
                },
                rc: {
                    sales: [1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244],
                    cogs: [932, 932, 932, 932, 932, 932, 932, 932, 932, 932, 932, 932],
                    personnel: [61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61],
                    welfare: [6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6],
                    logistics: [67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67],
                    advertising: [40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40],
                    fees: [70, 70, 70, 70, 70, 70, 70, 70, 70, 70, 70, 70],
                    travel: [15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15],
                    communication: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                    promotion: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]
                },
                rcd: {
                    sales: [532, 532, 532, 532, 532, 532, 532, 532, 532, 532, 532, 532],
                    cogs: [372, 372, 372, 372, 372, 372, 372, 372, 372, 372, 372, 372],
                    personnel: [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                    welfare: [13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13],
                    fees: [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2]
                }
            };

            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            DataStorage.set('sr', srUnifiedData);  // SRäº‹æ¥­éƒ¨ã¯çµ±ä¸€æ§‹é€  
            DataStorage.set('w', testData.w);
            DataStorage.set('rc', testData.rc);
            DataStorage.set('rcd', testData.rcd);

            // åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            document.getElementById('init-message').style.display = 'none';
            
            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            generateSalesTable();
            generateExpenseTable();
            
            alert('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆSRäº‹æ¥­éƒ¨ã¯çµ±ä¸€æ§‹é€ å¯¾å¿œï¼‰ã€‚');
        }

        // ===== å£²ä¸Šãƒ»ä»•å…¥ãƒ»ç²—åˆ©ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ =====
        function generateSalesTable() {
            if (!DataStorage.hasData()) {
                document.getElementById('sales-table-container').innerHTML = 
                    '<p style="text-align: center; color: #856404;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            let totalSales = new Array(12).fill(0);
            let totalCOGS = new Array(12).fill(0);
            let totalGrossProfit = new Array(12).fill(0);

            // å„äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const departments = ['sr', 'w', 'rc', 'rcd'];
            const deptNames = {
                sr: 'SRäº‹æ¥­éƒ¨',
                w: 'Wäº‹æ¥­éƒ¨',
                rc: 'RCæ”¯åº—äº‹æ¥­éƒ¨',
                rcd: 'RCDç¤¾äº‹æ¥­éƒ¨'
            };

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 200px;">é …ç›®</th>
                            ${months.map(m => `<th>${m}</th>`).join('')}
                            <th style="width: 100px;">å¹´é–“è¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // å£²ä¸Šé«˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            html += `<tr class="category-header sales-header"><td colspan="14">å£²ä¸Šé«˜</td></tr>`;
            
            departments.forEach(dept => {
                const data = DataStorage.get(dept);
                if (data && data.sales) {
                    const annual = data.sales.reduce((sum, val) => sum + val, 0);
                    html += `
                        <tr class="data-row">
                            <td class="item-name">${deptNames[dept]}</td>
                            ${data.sales.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                            <td class="annual-total">${formatNumber(annual)}</td>
                        </tr>
                    `;
                    data.sales.forEach((val, i) => totalSales[i] += val);
                }
            });

            const annualTotalSales = totalSales.reduce((sum, val) => sum + val, 0);
            html += `
                <tr class="total-row">
                    <td class="item-name">å£²ä¸Šé«˜åˆè¨ˆ</td>
                    ${totalSales.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                    <td class="grand-total">${formatNumber(annualTotalSales)}</td>
                </tr>
            `;

            // å£²ä¸ŠåŸä¾¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            html += `<tr class="category-header cogs-header"><td colspan="14">å£²ä¸ŠåŸä¾¡</td></tr>`;
            
            departments.forEach(dept => {
                const data = DataStorage.get(dept);
                if (data && data.cogs) {
                    const annual = data.cogs.reduce((sum, val) => sum + val, 0);
                    html += `
                        <tr class="data-row">
                            <td class="item-name">${deptNames[dept]}</td>
                            ${data.cogs.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                            <td class="annual-total">${formatNumber(annual)}</td>
                        </tr>
                    `;
                    data.cogs.forEach((val, i) => totalCOGS[i] += val);
                }
            });

            const annualTotalCOGS = totalCOGS.reduce((sum, val) => sum + val, 0);
            html += `
                <tr class="total-row">
                    <td class="item-name">å£²ä¸ŠåŸä¾¡åˆè¨ˆ</td>
                    ${totalCOGS.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                    <td class="grand-total">${formatNumber(annualTotalCOGS)}</td>
                </tr>
            `;

            // ç²—åˆ©ç›Šã‚»ã‚¯ã‚·ãƒ§ãƒ³
            html += `<tr class="category-header profit-header"><td colspan="14">ç²—åˆ©ç›Š</td></tr>`;
            
            departments.forEach(dept => {
                const data = DataStorage.get(dept);
                if (data && data.sales && data.cogs) {
                    const grossProfitData = data.sales.map((sales, i) => sales - data.cogs[i]);
                    const annual = grossProfitData.reduce((sum, val) => sum + val, 0);
                    html += `
                        <tr class="data-row">
                            <td class="item-name">${deptNames[dept]}</td>
                            ${grossProfitData.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                            <td class="annual-total">${formatNumber(annual)}</td>
                        </tr>
                    `;
                    grossProfitData.forEach((val, i) => totalGrossProfit[i] += val);
                }
            });

            const annualTotalGrossProfit = totalGrossProfit.reduce((sum, val) => sum + val, 0);
            html += `
                <tr class="total-row">
                    <td class="item-name">ç²—åˆ©ç›Šåˆè¨ˆ</td>
                    ${totalGrossProfit.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                    <td class="grand-total">${formatNumber(annualTotalGrossProfit)}</td>
                </tr>
            `;

            html += `</tbody></table>`;
            document.getElementById('sales-table-container').innerHTML = html;
        }

        // ===== ãƒ‡ãƒ¼ã‚¿åé›†ãƒ»çµ±åˆå‡¦ç†ï¼ˆçµ±ä¸€æ§‹é€ å¯¾å¿œç‰ˆï¼‰ =====
        function collectDepartmentData() {
            const integratedExpenses = {};
            
            // 19é …ç›®ã‚’åˆæœŸåŒ–
            for (let i = 1; i <= 19; i++) {
                integratedExpenses[i] = new Array(12).fill(0);
            }
            
            let activeCount = 0;
            
            // SRäº‹æ¥­éƒ¨ã®çµ±ä¸€æ§‹é€ ãƒ‡ãƒ¼ã‚¿
            const srData = DataStorage.get('sr');
            if (srData && srData.metadata && srData.metadata.unifiedStructure) {
                activeCount++;
                updateDeptStatus('sr', 'success', 'çµ±ä¸€æ§‹é€ ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆ');
                
                // çµ±ä¸€æ§‹é€ ã®expensesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                if (srData.expenses) {
                    Object.keys(srData.expenses).forEach(expenseId => {
                        const id = parseInt(expenseId);
                        if (id >= 1 && id <= 19 && Array.isArray(srData.expenses[expenseId])) {
                            srData.expenses[expenseId].forEach((val, monthIndex) => {
                                integratedExpenses[id][monthIndex] += (val || 0);
                            });
                        }
                    });
                }
            } else {
                updateDeptStatus('sr', 'warning', 'ãƒ‡ãƒ¼ã‚¿ãªã—');
            }
            
            // Wäº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿ï¼ˆå¾“æ¥å½¢å¼ã‹ã‚‰çµ±ä¸€æ§‹é€ ã«ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰
            const wData = DataStorage.get('w');
            if (wData) {
                activeCount++;
                updateDeptStatus('w', 'success', 'ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆ');
                
                // ç°¡æ˜“ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆå®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯å„äº‹æ¥­éƒ¨ãŒçµ±ä¸€æ§‹é€ ã§é€ä¿¡ã™ã‚‹ï¼‰
                if (wData.personnel) addToExpenses(integratedExpenses, 1, wData.personnel);
                if (wData.welfare) addToExpenses(integratedExpenses, 2, wData.welfare);
                if (wData.rent) addToExpenses(integratedExpenses, 5, wData.rent);
                if (wData.advertising) addToExpenses(integratedExpenses, 8, wData.advertising);
                if (wData.travel) addToExpenses(integratedExpenses, 9, wData.travel);
                if (wData.communication) addToExpenses(integratedExpenses, 10, wData.communication);
                if (wData.fees) addToExpenses(integratedExpenses, 15, wData.fees);
            } else {
                updateDeptStatus('w', 'warning', 'ãƒ‡ãƒ¼ã‚¿ãªã—');
            }
            
            // RCæ”¯åº—äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿
            const rcData = DataStorage.get('rc');
            if (rcData) {
                activeCount++;
                updateDeptStatus('rc', 'success', 'ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆ');
                
                if (rcData.personnel) addToExpenses(integratedExpenses, 1, rcData.personnel);
                if (rcData.welfare) addToExpenses(integratedExpenses, 2, rcData.welfare);
                if (rcData.logistics) addToExpenses(integratedExpenses, 4, rcData.logistics);
                if (rcData.advertising) addToExpenses(integratedExpenses, 8, rcData.advertising);
                if (rcData.travel) addToExpenses(integratedExpenses, 9, rcData.travel);
                if (rcData.communication) addToExpenses(integratedExpenses, 10, rcData.communication);
                if (rcData.promotion) addToExpenses(integratedExpenses, 11, rcData.promotion);
                if (rcData.fees) addToExpenses(integratedExpenses, 15, rcData.fees);
            } else {
                updateDeptStatus('rc', 'warning', 'ãƒ‡ãƒ¼ã‚¿ãªã—');
            }
            
            // RCDç¤¾äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿
            const rcdData = DataStorage.get('rcd');
            if (rcdData) {
                activeCount++;
                updateDeptStatus('rcd', 'success', 'ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆ');
                
                if (rcdData.personnel) addToExpenses(integratedExpenses, 1, rcdData.personnel);
                if (rcdData.welfare) addToExpenses(integratedExpenses, 2, rcdData.welfare);
                if (rcdData.fees) addToExpenses(integratedExpenses, 15, rcdData.fees);
            } else {
                updateDeptStatus('rcd', 'warning', 'ãƒ‡ãƒ¼ã‚¿ãªã—');
            }
            
            // çµ±åˆçŠ¶æ³æ›´æ–°
            document.getElementById('integration-count').textContent = `${activeCount}/4`;
            
            return integratedExpenses;
        }

        function addToExpenses(expenses, itemId, dataArray) {
            if (expenses[itemId] && Array.isArray(dataArray)) {
                dataArray.forEach((val, i) => {
                    expenses[itemId][i] += (val || 0);
                });
            }
        }

        // ===== è²©ç®¡è²»ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆï¼ˆçµ±ä¸€æ§‹é€ 19é …ç›®ç‰ˆï¼‰ =====
        function generateExpenseTable() {
            if (!DataStorage.hasData()) {
                document.getElementById('expense-table-container').innerHTML = 
                    '<p style="text-align: center; color: #856404;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }
            
            const expenses = collectDepartmentData();
            const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th style="width: 200px;">è²©ç®¡è²»é …ç›®</th>
                            ${months.map(m => `<th>${m}</th>`).join('')}
                            <th style="width: 100px;">å¹´é–“è¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const categories = {
                personnel: 'äººä»¶è²»é–¢é€£',
                facility: 'ç‰©æµãƒ»æ–½è¨­è²»',
                marketing: 'å–¶æ¥­ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°è²»',
                operation: 'é‹å–¶è²»',
                equipment: 'è¨­å‚™ãƒ»ä¿é™º'
            };
            
            let grandTotal = 0;
            const monthlyTotals = new Array(12).fill(0);
            
            Object.entries(categories).forEach(([catKey, catName]) => {
                // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼
                html += `
                    <tr class="category-header">
                        <td colspan="15">${catName}</td>
                    </tr>
                `;
                
                // é …ç›®è¡¨ç¤º
                Object.entries(UNIFIED_EXPENSE_ITEMS)
                    .filter(([_, item]) => item.category === catKey)
                    .sort((a, b) => a[1].id - b[1].id)
                    .forEach(([_, item]) => {
                        const monthlyData = expenses[item.id] || new Array(12).fill(0);
                        const annual = monthlyData.reduce((sum, val) => sum + val, 0);
                        grandTotal += annual;
                        
                        monthlyData.forEach((val, i) => {
                            monthlyTotals[i] += val;
                        });
                        
                        html += `
                            <tr class="data-row">
                                <td>${item.id}</td>
                                <td class="item-name">${item.name}</td>
                                ${monthlyData.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                                <td class="annual-total">${formatNumber(annual)}</td>
                            </tr>
                        `;
                    });
            });
            
            // åˆè¨ˆè¡Œ
            html += `
                    <tr class="total-row">
                        <td>-</td>
                        <td class="item-name">è²©ç®¡è²»åˆè¨ˆ</td>
                        ${monthlyTotals.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                        <td class="grand-total">${formatNumber(grandTotal)}</td>
                    </tr>
                </tbody>
            </table>
            `;
            
            document.getElementById('expense-table-container').innerHTML = html;
            
            // KPIæ›´æ–°
            updateKPIs(grandTotal);
            
            // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            updateExpenseChart(monthlyTotals);
        }

        // ===== KPIæ›´æ–° =====
        function updateKPIs(totalExpenses) {
            // å£²ä¸Šãƒ‡ãƒ¼ã‚¿åé›†
            let totalSales = 0;
            let totalCOGS = 0;
            
            ['sr', 'w', 'rc', 'rcd'].forEach(dept => {
                const data = DataStorage.get(dept);
                if (data) {
                    if (data.sales && Array.isArray(data.sales)) {
                        totalSales += data.sales.reduce((sum, val) => sum + val, 0);
                    }
                    if (data.cogs && Array.isArray(data.cogs)) {
                        totalCOGS += data.cogs.reduce((sum, val) => sum + val, 0);
                    }
                }
            });
            
            const grossProfit = totalSales - totalCOGS;
            const operatingProfit = grossProfit - totalExpenses;
            const profitRate = totalSales > 0 ? (operatingProfit / totalSales * 100).toFixed(1) : '0.0';
            
            // KPIè¡¨ç¤ºæ›´æ–°
            document.getElementById('total-sales').textContent = formatNumber(totalSales) + 'ä¸‡å††';
            document.getElementById('total-profit').textContent = formatNumber(operatingProfit) + 'ä¸‡å††';
            document.getElementById('profit-rate').textContent = profitRate + '%';
            
            // è‰²åˆ†ã‘
            const profitCard = document.getElementById('total-profit-card');
            const rateCard = document.getElementById('profit-rate-card');
            
            if (operatingProfit >= 0) {
                profitCard.className = 'kpi-card positive';
                rateCard.className = 'kpi-card positive';
                document.getElementById('total-profit').className = 'kpi-value positive';
                document.getElementById('profit-rate').className = 'kpi-value positive';
            } else {
                profitCard.className = 'kpi-card negative';
                rateCard.className = 'kpi-card negative';
                document.getElementById('total-profit').className = 'kpi-value negative';
                document.getElementById('profit-rate').className = 'kpi-value negative';
            }
        }

        // ===== ãƒãƒ£ãƒ¼ãƒˆæ›´æ–° =====
        let expenseChart = null;
        
        function updateExpenseChart(monthlyTotals) {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            
            expenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'è²©ç®¡è²»åˆè¨ˆ',
                        data: monthlyTotals,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: '#e74c3c',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'è²©ç®¡è²»: ' + formatNumber(context.parsed.y) + 'ä¸‡å††';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'é‡‘é¡ï¼ˆä¸‡å††ï¼‰'
                            }
                        }
                    }
                }
            });
        }

        // ===== è‡ªå‹•åŒæœŸã‚·ã‚¹ãƒ†ãƒ  =====
        const AUTO_SYNC = {
            timer: null,
            interval: 5000,
            isActive: false,
            
            start: function() {
                if (this.isActive) return;
                
                this.isActive = true;
                this.timer = setInterval(() => {
                    this.sync();
                }, this.interval);
                
                document.getElementById('sync-status').textContent = 'ç¨¼åƒä¸­';
                document.getElementById('sync-status').className = 'linkage-indicator active';
                
                this.sync(); // å³åº§ã«å®Ÿè¡Œ
            },
            
            stop: function() {
                if (!this.isActive) return;
                
                this.isActive = false;
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                
                document.getElementById('sync-status').textContent = 'åœæ­¢ä¸­';
                document.getElementById('sync-status').className = 'linkage-indicator';
            },
            
            sync: function() {
                const indicator = document.getElementById('sync-indicator');
                indicator.className = 'sync-indicator active';
                
                // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                generateSalesTable();
                generateExpenseTable();
                
                // æœ€çµ‚åŒæœŸæ™‚åˆ»æ›´æ–°
                const now = new Date();
                document.getElementById('last-sync').textContent = 
                    `æœ€çµ‚åŒæœŸ: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                setTimeout(() => {
                    indicator.className = 'sync-indicator';
                }, 1000);
            }
        };

        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        function formatNumber(num) {
            if (isNaN(num) || num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString();
        }

        function updateDeptStatus(dept, status, message) {
            const statusElement = document.getElementById(`${dept}-status`);
            if (statusElement) {
                statusElement.className = `dept-status status-${status}`;
                const deptNames = {
                    sr: 'SRäº‹æ¥­éƒ¨',
                    w: 'Wäº‹æ¥­éƒ¨',
                    rc: 'RCæ”¯åº—',
                    rcd: 'RCDç¤¾'
                };
                statusElement.textContent = `${deptNames[dept]}: ${message}`;
            }
        }

        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•° =====
        function startAutoSync() {
            if (!DataStorage.hasData()) {
                alert('å…ˆã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            AUTO_SYNC.start();
            alert('è‡ªå‹•åŒæœŸã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆ5ç§’é–“éš”ï¼‰');
        }

        function stopAutoSync() {
            AUTO_SYNC.stop();
            alert('è‡ªå‹•åŒæœŸã‚’åœæ­¢ã—ã¾ã—ãŸ');
        }

        function manualRefresh() {
            if (!DataStorage.hasData()) {
                alert('å…ˆã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            generateSalesTable();
            generateExpenseTable();
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•æ›´æ–°ã—ã¾ã—ãŸ');
        }

        function exportToCSV() {
            if (!DataStorage.hasData()) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const expenses = collectDepartmentData();
            const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            
            // çµ±ä¸€æ§‹é€ 19é …ç›®å¯¾å¿œã®CSVä½œæˆ
            let csv = '\uFEFFçµ±åˆPLãƒ‡ãƒ¼ã‚¿ï¼ˆçµ±ä¸€æ§‹é€ 19é …ç›®å¯¾å¿œç‰ˆï¼‰\n\n';
            
            // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            csv += 'ã€å£²ä¸Šé«˜ã€‘\n';
            csv += 'äº‹æ¥­éƒ¨,7æœˆ,8æœˆ,9æœˆ,10æœˆ,11æœˆ,12æœˆ,1æœˆ,2æœˆ,3æœˆ,4æœˆ,5æœˆ,6æœˆ,å¹´é–“è¨ˆ\n';
            
            const departments = ['sr', 'w', 'rc', 'rcd'];
            const deptNames = {
                sr: 'SRäº‹æ¥­éƒ¨',
                w: 'Wäº‹æ¥­éƒ¨', 
                rc: 'RCæ”¯åº—äº‹æ¥­éƒ¨',
                rcd: 'RCDç¤¾äº‹æ¥­éƒ¨'
            };
            
            let totalSalesRow = new Array(12).fill(0);
            departments.forEach(dept => {
                const data = DataStorage.get(dept);
                if (data && data.sales) {
                    csv += `${deptNames[dept]},`;
                    csv += data.sales.join(',') + ',';
                    csv += data.sales.reduce((sum, val) => sum + val, 0) + '\n';
                    data.sales.forEach((val, i) => totalSalesRow[i] += val);
                }
            });
            csv += 'å£²ä¸Šé«˜åˆè¨ˆ,';
            csv += totalSalesRow.join(',') + ',';
            csv += totalSalesRow.reduce((sum, val) => sum + val, 0) + '\n\n';
            
            // è²©ç®¡è²»ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            csv += 'ã€è²©ç®¡è²»19é …ç›®è©³ç´°ã€‘\n';
            csv += 'ID,é …ç›®å,';
            csv += months.join(',') + ',å¹´é–“è¨ˆ\n';
            
            Object.entries(UNIFIED_EXPENSE_ITEMS)
                .sort((a, b) => a[1].id - b[1].id)
                .forEach(([_, item]) => {
                    const monthlyData = expenses[item.id] || new Array(12).fill(0);
                    const annual = monthlyData.reduce((sum, val) => sum + val, 0);
                    csv += `${item.id},"${item.name}",`;
                    csv += monthlyData.join(',') + ',' + annual + '\n';
                });
            
            // è²©ç®¡è²»åˆè¨ˆè¡Œ
            const monthlyTotals = new Array(12).fill(0);
            for (let i = 1; i <= 19; i++) {
                if (expenses[i]) {
                    expenses[i].forEach((val, monthIdx) => {
                        monthlyTotals[monthIdx] += val;
                    });
                }
            }
            csv += '-,è²©ç®¡è²»åˆè¨ˆ,';
            csv += monthlyTotals.join(',') + ',';
            csv += monthlyTotals.reduce((sum, val) => sum + val, 0) + '\n';
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `çµ±åˆPLãƒ‡ãƒ¼ã‚¿_çµ±ä¸€æ§‹é€ 19é …ç›®_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        // ===== åˆæœŸåŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ  çµ±ä¸€æ§‹é€ 19é …ç›®å®Œå…¨å¯¾å¿œç‰ˆ èµ·å‹•');
            
            // ãƒ‡ãƒ¼ã‚¿æœ‰ç„¡ãƒã‚§ãƒƒã‚¯
            if (!DataStorage.hasData()) {
                document.getElementById('init-message').style.display = 'block';
            } else {
                document.getElementById('init-message').style.display = 'none';
                // åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                generateSalesTable();
                generateExpenseTable();
            }
        });
    </script>
</body>
</html>
