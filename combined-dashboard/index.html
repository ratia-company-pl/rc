<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: #333;
            background: linear-gradient(135deg, #fdf2e9 0%, #fcf3cf 100%);
            min-height: 100vh;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼æ§‹é€  */
        .header-row1 {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 2.2em;
            font-weight: bold;
        }

        .status-legend {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-connected { background-color: #27ae60; }
        .legend-pending { background-color: #f39c12; }
        .legend-error { background-color: #e74c3c; }

        /* 2è¡Œç›®: ãƒ‡ãƒ¼ã‚¿é€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .header-row2 {
            background: #ecf0f1;
            padding: 12px 20px;
            text-align: center;
        }

        .integration-status {
            display: flex;
            gap: 25px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        /* 3è¡Œç›®: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .header-row3 {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            padding: 12px 20px;
        }

        .nav-container {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 180px;
            max-width: 220px;
            padding: 12px 20px;
            font-size: 0.9em;
            border-radius: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
            text-align: center;
            cursor: pointer;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }

        .btn-active-unified { 
            background: #f39c12 !important; 
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.6) !important;
            transform: translateY(-1px);
        }

        .status-connected { background-color: #27ae60; }
        .status-pending { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }

        /* ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¡¨ç¤º */
        .data-source-indicator {
            text-align: center;
            font-size: 0.85em;
            color: #666;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            font-weight: 500;
        }

        .indicator-simulation {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .indicator-realdata {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        /* çµ±åˆãƒ˜ãƒƒãƒ€ãƒ¼ */
        .unified-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid #3498db;
            border-radius: 25px;
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.95em;
        }

        .nav-tab:hover, .nav-tab.active {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        /* KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 3px solid;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .kpi-card-sales { border-color: #3498db; }
        .kpi-card-profit { border-color: #27ae60; }
        .kpi-card-expenses { border-color: #e67e22; }
        .kpi-card-margin { border-color: #9b59b6; }

        .kpi-label {
            font-size: 0.85em;
            color: #666;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .kpi-value {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .kpi-card-sales .kpi-value { color: #3498db; }
        .kpi-card-profit .kpi-value { color: #27ae60; }
        .kpi-card-expenses .kpi-value { color: #e67e22; }
        .kpi-card-margin .kpi-value { color: #9b59b6; }

        .kpi-change {
            font-size: 0.75em;
            font-weight: 600;
        }

        .kpi-change.positive { color: #27ae60; }
        .kpi-change.negative { color: #e74c3c; }

        /* ç›®æ¨™åˆ©ç›Šé…åˆ†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .target-profit-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px;
            padding: 30px;
            margin-bottom: 35px;
            border: 3px solid #e74c3c;
            border-left: 6px solid #e74c3c;
        }

        .target-input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.95em;
        }

        .input-field {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            border-color: #e74c3c;
            outline: none;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .allocation-result {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            display: none;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }

        .allocation-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        /* å½¹å“¡å ±é…¬è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .executive-compensation {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px;
            padding: 30px;
            margin-bottom: 35px;
            border: 3px solid #27ae60;
            border-left: 6px solid #27ae60;
        }

        .section-title {
            font-size: 1.4em;
            color: #27ae60;
            margin-bottom: 25px;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
            font-weight: bold;
        }

        .section-title.red { color: #e74c3c; border-color: #e74c3c; }

        .compensation-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.95em;
        }

        .control-input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .control-input:focus {
            border-color: #27ae60;
            outline: none;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .compensation-actions {
            display: flex;
            gap: 18px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 0.95em;
        }

        .btn-apply { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .btn-save { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-load { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .btn-test { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .btn-refresh { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
        }

        /* åˆ©ç›Šå½±éŸ¿è¡¨ç¤º */
        .profit-impact-display {
            background: #e8f5e8;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #27ae60;
        }

        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
        }

        .impact-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .impact-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .impact-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #27ae60;
        }

        /* çµ±ä¸€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .unified-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid rgba(243, 156, 18, 0.3);
            border-left: 6px solid #f39c12;
        }

        .table-container {
            overflow-x: auto;
            margin: -8px;
            padding: 8px;
        }

        .unified-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            margin-bottom: 18px;
        }

        .unified-table th,
        .unified-table td {
            padding: 6px;
            text-align: right;
            border-bottom: 1px solid #fce4d6;
            border-right: 1px solid #fdf2e9;
        }

        .unified-table .id-column {
            width: 30px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            padding: 6px 4px;
        }

        .unified-table th:nth-child(2),
        .unified-table td:nth-child(2) {
            text-align: left;
            font-weight: bold;
            width: 140px;
            padding: 6px 10px;
        }

        .unified-table th:nth-child(n+3):nth-child(-n+14),
        .unified-table td:nth-child(n+3):nth-child(-n+14) {
            width: calc((100% - 30px - 140px - 90px) / 12);
            min-width: 55px;
            padding: 6px 8px;
        }

        .unified-table th:last-child,
        .unified-table td:last-child {
            width: 90px;
            font-weight: bold;
            background-color: #fef9f3;
            padding: 6px 8px;
        }

        .unified-table th {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 8px 6px;
        }

        .total-row {
            background-color: #fef9f3;
            font-weight: bold;
            border-top: 2px solid #f39c12;
        }

        .profit-row {
            background-color: #e8f5e8;
            font-weight: bold;
            color: #155724;
        }

        .admin-expense-row:nth-child(even) {
            background-color: #fefbf7;
        }

        .admin-expense-row:hover {
            background-color: #fcf3cf;
        }

        /* äº‹æ¥­éƒ¨æ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .department-comparison {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px;
            padding: 30px;
            margin-bottom: 35px;
            border: 3px solid #3498db;
            border-left: 6px solid #3498db;
        }

        .dept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .dept-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 3px solid;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .dept-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }

        .dept-sr { border-color: #C477CC; }
        .dept-w { border-color: #3498db; }
        .dept-rc { border-color: #27ae60; }
        .dept-rcd { border-color: #9b59b6; }

        .dept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid;
        }

        .dept-name {
            font-size: 1.2em;
            font-weight: bold;
        }

        .dept-status {
            font-size: 0.85em;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: 600;
        }

        .dept-sr .dept-header { border-color: #C477CC; color: #C477CC; }
        .dept-w .dept-header { border-color: #3498db; color: #3498db; }
        .dept-rc .dept-header { border-color: #27ae60; color: #27ae60; }
        .dept-rcd .dept-header { border-color: #9b59b6; color: #9b59b6; }

        .dept-chart {
            height: 220px;
            margin-bottom: 18px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
        }

        .dept-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }

        .metric-item {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .metric-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .metric-change {
            font-size: 0.75em;
            margin-top: 5px;
        }

        /* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px;
            padding: 30px;
            margin-bottom: 35px;
            border: 3px solid #e74c3c;
            border-left: 6px solid #e74c3c;
        }

        .chart-container {
            position: relative;
            height: 480px;
            margin-bottom: 25px;
        }

        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .chart-toggle {
            padding: 10px 20px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .chart-toggle:hover, .chart-toggle.active {
            background: #3498db;
            color: white;
        }

        /* ã‚°ãƒ©ãƒ•è¡¨ç¤ºåˆ¶å¾¡ */
        .chart-visibility-controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .visibility-toggle {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85em;
        }

        .visibility-toggle.active {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        /* é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            max-width: 380px;
            padding: 18px 25px;
            border-radius: 12px;
            font-size: 0.95em;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            font-weight: 600;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-left: 6px solid #27ae60;
            color: #155724;
        }

        .notification-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left: 6px solid #f39c12;
            color: #856404;
        }

        .notification-error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-left: 6px solid #e74c3c;
            color: #721c24;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .header-row1, .header-row2, .header-row3 {
                padding: 15px;
            }
            
            .header-title {
                font-size: 1.6em;
            }
            
            .nav-container {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                min-width: 250px;
                max-width: 320px;
            }
            
            .integration-status {
                flex-direction: column;
                gap: 15px;
            }
            
            .unified-table {
                font-size: 0.75em;
            }
            
            .unified-table th,
            .unified-table td {
                padding: 4px 3px;
            }

            .kpi-dashboard {
                grid-template-columns: 1fr;
            }
            
            .dept-grid {
                grid-template-columns: 1fr;
            }
            
            .compensation-controls {
                grid-template-columns: 1fr;
            }
            
            .compensation-actions {
                flex-direction: column;
                align-items: center;
            }
        }

        /* è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
        .executive-row {
            background-color: #e8f5e8;
            font-weight: bold;
        }

        .final-profit-positive {
            background-color: #e8f5e8;
            color: #155724;
            font-weight: bold;
        }

        .final-profit-negative {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .metric-change.positive {
            color: #27ae60;
        }

        .metric-change.negative {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <!-- 3è¡Œãƒ˜ãƒƒãƒ€ãƒ¼æ§‹é€  -->
    <!-- 1è¡Œç›®: ã‚¿ã‚¤ãƒˆãƒ« + è‰²è¡¨ç¤ºã®æ„å‘³ -->
    <div class="header-row1">
        <h1 class="header-title">RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        <div class="status-legend">
            <div class="legend-item">
                <div class="legend-dot legend-connected"></div>
                <span>æ¥ç¶šæ¸ˆã¿</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot legend-pending"></div>
                <span>å¾…æ©Ÿä¸­</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot legend-error"></div>
                <span>ã‚¨ãƒ©ãƒ¼</span>
            </div>
        </div>
    </div>

    <!-- 2è¡Œç›®: ãƒ‡ãƒ¼ã‚¿é€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="header-row2">
        <div class="integration-status">
            <div class="status-item">
                <span class="status-indicator" id="sr-indicator"></span>
                <span>SRäº‹æ¥­éƒ¨</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="w-indicator"></span>
                <span>Wäº‹æ¥­éƒ¨</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="rc-indicator"></span>
                <span>RCäº‹æ¥­éƒ¨</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="rcd-indicator"></span>
                <span>RCDäº‹æ¥­éƒ¨</span>
            </div>
            <div class="status-item">
                <span class="status-indicator status-connected"></span>
                <span>çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ  ç¨¼åƒä¸­</span>
            </div>
        </div>
    </div>

    <!-- 3è¡Œç›®: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ5ãƒœã‚¿ãƒ³ï¼‰ -->
    <div class="header-row3">
        <div class="nav-container">
            <a href="../department-pl/sr-pl.html" class="btn">SRäº‹æ¥­éƒ¨PL</a>
            <a href="../department-pl/w-pl.html" class="btn">Wäº‹æ¥­éƒ¨PL</a>
            <a href="../department-pl/rc-pl.html" class="btn">RCäº‹æ¥­éƒ¨PL</a>
            <a href="../department-pl/rcd-pl.html" class="btn">RCDäº‹æ¥­éƒ¨PL</a>
            <a href="#" class="btn btn-active-unified">çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ </a>
        </div>
    </div>

    <!-- çµ±åˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="unified-header">
        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showSection('overview')">æ¦‚è¦</div>
            <div class="nav-tab" onclick="showSection('target')">ç›®æ¨™åˆ©ç›Šé…åˆ†</div>
            <div class="nav-tab" onclick="showSection('executive')">å½¹å“¡å ±é…¬</div>
            <div class="nav-tab" onclick="showSection('departments')">äº‹æ¥­éƒ¨æ¯”è¼ƒ</div>
            <div class="nav-tab" onclick="showSection('analysis')">åˆ†æ</div>
            <div class="nav-tab" onclick="showSection('pl-details')">PLè©³ç´°</div>
        </div>
    </div>

    <!-- é€šçŸ¥è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="notification" class="notification"></div>

    <div style="max-width: 1400px; margin: 0 auto; padding: 0 20px;">
        
        <!-- æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="overview-section" class="tab-content">
            <!-- KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            <div class="kpi-dashboard">
                <div class="kpi-card kpi-card-sales">
                    <div class="kpi-label">çµ±åˆå£²ä¸Šé«˜</div>
                    <div class="kpi-value" id="kpi-sales">---</div>
                    <div class="kpi-change" id="kpi-sales-change">å‰å¹´æ¯” ---%</div>
                </div>
                <div class="kpi-card kpi-card-expenses">
                    <div class="kpi-label">å…¨ä½“è²©ç®¡è²»</div>
                    <div class="kpi-value" id="kpi-expenses">---</div>
                    <div class="kpi-change" id="kpi-expenses-change">å‰å¹´æ¯” ---%</div>
                </div>
                <div class="kpi-card kpi-card-profit">
                    <div class="kpi-label">å–¶æ¥­åˆ©ç›Š</div>
                    <div class="kpi-value" id="kpi-profit">---</div>
                    <div class="kpi-change" id="kpi-profit-change">å‰å¹´æ¯” ---%</div>
                </div>
                <div class="kpi-card kpi-card-margin">
                    <div class="kpi-label">åˆ©ç›Šç‡</div>
                    <div class="kpi-value" id="kpi-margin">---%</div>
                    <div class="kpi-change" id="kpi-margin-change">å‰å¹´æ¯” ---pt</div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="chart-section">
                <h2 class="section-title" style="color: #e74c3c;">æœˆæ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆå£²ä¸Šãƒ»åˆ©ç›Šé‡è¦–è¡¨ç¤ºï¼‰</h2>
                <div id="data-source-indicator" class="data-source-indicator indicator-simulation">
                    âš ï¸ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤è¡¨ç¤ºä¸­
                </div>
                <div class="chart-controls">
                    <button class="chart-toggle active" onclick="toggleChartMode('current')">å½“æœŸå®Ÿç¸¾</button>
                    <button class="chart-toggle" onclick="toggleChartMode('comparison')">å‰å¹´æ¯”è¼ƒ</button>
                </div>
                <div class="chart-visibility-controls" id="visibility-controls">
                    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹è¡¨ç¤ºåˆ¶å¾¡ãƒœã‚¿ãƒ³ -->
                </div>
                <div class="chart-container">
                    <canvas id="main-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- ç›®æ¨™åˆ©ç›Šé…åˆ†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="target-section" class="tab-content" style="display: none;">
            <div class="target-profit-section">
                <h2 class="section-title red">ç›®æ¨™åˆ©ç›Šé…åˆ†ææ¡ˆã‚·ã‚¹ãƒ†ãƒ </h2>
                
                <div class="target-input-group">
                    <div class="input-group">
                        <label class="input-label">ç›®æ¨™å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰</label>
                        <input type="number" class="input-field" id="target-profit" value="15000" step="100">
                    </div>
                    <div class="input-group">
                        <label class="input-label">é…åˆ†æ–¹å¼</label>
                        <select class="input-field" id="allocation-method">
                            <option value="sales">å£²ä¸Šæ¯”ä¾‹é…åˆ†</option>
                            <option value="profit">åˆ©ç›Šç‡æ¯”ä¾‹é…åˆ†</option>
                            <option value="equal">å‡ç­‰é…åˆ†</option>
                            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ é…åˆ†</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">è¨ˆç®—åŸºæº–</label>
                        <select class="input-field" id="calculation-base">
                            <option value="current">å½“æœŸå®Ÿç¸¾åŸºæº–</option>
                            <option value="previous">å‰å¹´å®Ÿç¸¾åŸºæº–</option>
                            <option value="average">å¹³å‡å€¤åŸºæº–</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">&nbsp;</label>
                        <button class="action-button btn-apply" onclick="calculateTargetAllocation()">é…åˆ†è¨ˆç®—å®Ÿè¡Œ</button>
                    </div>
                </div>

                <div class="allocation-result" id="allocation-result">
                    <h3 style="margin-bottom: 18px; color: #e74c3c;">ğŸ“Š ç›®æ¨™åˆ©ç›Šé…åˆ†çµæœ</h3>
                    <div class="allocation-grid" id="allocation-grid">
                        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹é…åˆ†çµæœ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å½¹å“¡å ±é…¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="executive-section" class="tab-content" style="display: none;">
            <div class="executive-compensation">
                <h2 class="section-title">å½¹å“¡å ±é…¬ãƒ»è³ä¸è¨­å®š</h2>
                
                <div class="compensation-controls">
                    <div class="control-group">
                        <label class="control-label">7-9æœˆåŸºæº–é¡ï¼ˆä¸‡å††ï¼‰</label>
                        <input type="number" class="control-input" id="salary-high" value="826" step="10">
                    </div>
                    <div class="control-group">
                        <label class="control-label">10-6æœˆåŸºæº–é¡ï¼ˆä¸‡å††ï¼‰</label>
                        <input type="number" class="control-input" id="salary-low" value="676" step="10">
                    </div>
                    <div class="control-group">
                        <label class="control-label">6æœˆè³ä¸é¡ï¼ˆä¸‡å††ï¼‰</label>
                        <input type="number" class="control-input" id="bonus-amount" value="0" step="50">
                    </div>
                    <div class="control-group">
                        <label class="control-label">ç¦åˆ©è²»ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" class="control-input" id="welfare-rate" value="13" step="0.1" min="0" max="30">
                    </div>
                </div>

                <div class="compensation-actions">
                    <button class="action-button btn-apply" onclick="applyCompensation()">è¨­å®šé©ç”¨</button>
                    <button class="action-button btn-save" onclick="saveCompensation()">ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
                    <button class="action-button btn-load" onclick="loadCompensation()">ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
                    <button class="action-button btn-test" onclick="testCompensation()">å‹•ä½œãƒ†ã‚¹ãƒˆ</button>
                    <button class="action-button btn-refresh" onclick="refreshUnifiedData()">çµ±åˆPLæ›´æ–°</button>
                </div>

                <div id="compensation-status" class="data-source-indicator">
                    ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­...
                </div>

                <!-- åˆ©ç›Šå½±éŸ¿è¡¨ç¤º -->
                <div class="profit-impact-display">
                    <h3 style="margin-bottom: 18px; color: #27ae60;">ğŸ’° è¨­å®šå¤‰æ›´ã®åˆ©ç›Šå½±éŸ¿</h3>
                    <div class="impact-grid">
                        <div class="impact-item">
                            <div class="impact-label">å¹´é–“å ±é…¬ç·é¡</div>
                            <div class="impact-value" id="impact-total-compensation">---ä¸‡å††</div>
                        </div>
                        <div class="impact-item">
                            <div class="impact-label">å¹´é–“ç¦åˆ©è²»</div>
                            <div class="impact-value" id="impact-total-welfare">---ä¸‡å††</div>
                        </div>
                        <div class="impact-item">
                            <div class="impact-label">å–¶æ¥­åˆ©ç›Šã¸ã®å½±éŸ¿</div>
                            <div class="impact-value" id="impact-profit-effect">---ä¸‡å††</div>
                        </div>
                        <div class="impact-item">
                            <div class="impact-label">å¤‰æ›´å¾Œåˆ©ç›Šç‡</div>
                            <div class="impact-value" id="impact-profit-margin">---%</div>
                        </div>
                    </div>
                </div>

                <!-- å½¹å“¡å ±é…¬ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-container">
                    <table class="unified-table" id="compensation-table">
                        <thead>
                            <tr>
                                <th class="id-column"></th>
                                <th>é …ç›®å</th>
                                <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                                <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                                <th>å¹´é–“åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="compensation-body">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- äº‹æ¥­éƒ¨æ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="departments-section" class="tab-content" style="display: none;">
            <div class="department-comparison">
                <h2 class="section-title" style="color: #3498db;">äº‹æ¥­éƒ¨åˆ¥æ¯”è¼ƒãƒ»å‰å¹´å¯¾æ¯”åˆ†æ</h2>
                
                <div class="dept-grid">
                    <div class="dept-card dept-sr">
                        <div class="dept-header">
                            <span class="dept-name">SRäº‹æ¥­éƒ¨</span>
                            <span class="dept-status" id="sr-status">
                                <span class="status-indicator status-pending"></span>å¾…æ©Ÿä¸­
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="sr-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">å¹´é–“å£²ä¸Š</div>
                                <div class="metric-value" id="sr-sales">---ä¸‡å††</div>
                                <div class="metric-change positive" id="sr-sales-change">å‰å¹´æ¯” ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å–¶æ¥­åˆ©ç›Š</div>
                                <div class="metric-value" id="sr-profit">---ä¸‡å††</div>
                                <div class="metric-change positive" id="sr-profit-change">å‰å¹´æ¯” ---%</div>
                            </div>
                        </div>
                    </div>

                    <div class="dept-card dept-w">
                        <div class="dept-header">
                            <span class="dept-name">Wäº‹æ¥­éƒ¨</span>
                            <span class="dept-status" id="w-status">
                                <span class="status-indicator status-pending"></span>å¾…æ©Ÿä¸­
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="w-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">å¹´é–“å£²ä¸Š</div>
                                <div class="metric-value" id="w-sales">---ä¸‡å††</div>
                                <div class="metric-change positive" id="w-sales-change">å‰å¹´æ¯” ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å–¶æ¥­åˆ©ç›Š</div>
                                <div class="metric-value" id="w-profit">---ä¸‡å††</div>
                                <div class="metric-change positive" id="w-profit-change">å‰å¹´æ¯” ---%</div>
                            </div>
                        </div>
                    </div>

                    <div class="dept-card dept-rc">
                        <div class="dept-header">
                            <span class="dept-name">RCäº‹æ¥­éƒ¨</span>
                            <span class="dept-status" id="rc-status">
                                <span class="status-indicator status-pending"></span>å¾…æ©Ÿä¸­
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="rc-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">å¹´é–“å£²ä¸Š</div>
                                <div class="metric-value" id="rc-sales">---ä¸‡å††</div>
                                <div class="metric-change positive" id="rc-sales-change">å‰å¹´æ¯” ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å–¶æ¥­åˆ©ç›Š</div>
                                <div class="metric-value" id="rc-profit">---ä¸‡å††</div>
                                <div class="metric-change positive" id="rc-profit-change">å‰å¹´æ¯” ---%</div>
                            </div>
                        </div>
                    </div>

                    <div class="dept-card dept-rcd">
                        <div class="dept-header">
                            <span class="dept-name">RCDäº‹æ¥­éƒ¨</span>
                            <span class="dept-status" id="rcd-status">
                                <span class="status-indicator status-pending"></span>å¾…æ©Ÿä¸­
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="rcd-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">å¹´é–“å£²ä¸Š</div>
                                <div class="metric-value" id="rcd-sales">---ä¸‡å††</div>
                                <div class="metric-change positive" id="rcd-sales-change">å‰å¹´æ¯” ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å–¶æ¥­åˆ©ç›Š</div>
                                <div class="metric-value" id="rcd-profit">---ä¸‡å††</div>
                                <div class="metric-change positive" id="rcd-profit-change">å‰å¹´æ¯” ---%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="analysis-section" class="tab-content" style="display: none;">
            <div class="chart-section">
                <h2 class="section-title" style="color: #e74c3c;">è©³ç´°åˆ†æãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</h2>
                <div class="chart-container">
                    <canvas id="analysis-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- PLè©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="pl-details-section" class="tab-content" style="display: none;">
            <!-- å½¹å“¡å ±é…¬è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="unified-section">
                <h2 class="section-title">å½¹å“¡å ±é…¬ãƒ»å½¹å“¡æ³•å®šç¦åˆ©è²»è©³ç´°</h2>
                <div class="table-container">
                    <table class="unified-table" id="executive-detail-table">
                        <thead>
                            <tr>
                                <th class="id-column">ID</th>
                                <th>é …ç›®å</th>
                                <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                                <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                                <th>å¹´é–“åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="executive-detail-body">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹å½¹å“¡å ±é…¬è©³ç´°ãƒ‡ãƒ¼ã‚¿ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- çµ±åˆæç›Šè¨ˆç®—æ›¸ -->
            <div class="unified-section">
                <h2 class="section-title">çµ±åˆæç›Šè¨ˆç®—æ›¸ãƒ»è²©ç®¡è²»19é …ç›®è©³ç´°ï¼ˆ7æœˆé–‹å§‹å¹´åº¦ï¼‰</h2>
                <div class="table-container">
                    <table class="unified-table" id="combined-pl-table">
                        <thead>
                            <tr>
                                <th class="id-column">ID</th>
                                <th>é …ç›®å</th>
                                <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                                <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                                <th>å¹´é–“åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="combined-pl-body">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹çµ±åˆPLãƒ‡ãƒ¼ã‚¿ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- RCå…¨ä½“é›†è¨ˆ -->
            <div class="unified-section">
                <h2 class="section-title" style="color: #e74c3c;">RCå…¨ä½“é›†è¨ˆ</h2>
                <div class="table-container">
                    <table class="unified-table" id="summary-table">
                        <thead>
                            <tr>
                                <th class="id-column"></th>
                                <th>é …ç›®å</th>
                                <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                                <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                                <th>å¹´é–“åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="summary-body">
                            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹é›†è¨ˆãƒ‡ãƒ¼ã‚¿ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.0 - å®Œå…¨ä¿®æ­£ç‰ˆï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«é–“ãƒ‡ãƒ¼ã‚¿é€£æºå¼·åŒ–ï¼‰
        class UnifiedPLSystemV6 {
            constructor() {
                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼å®šç¾©
                this.STORAGE_KEYS = {
                    'SR': 'pl_system_sr_corrected_data',
                    'W': 'pl_system_w_corrected_data', 
                    'RC': 'pl_system_rc_corrected_data',
                    'RCD': 'pl_system_rcd_corrected_data',
                    'executive': 'executive_compensation_csv_settings'
                };

                // è²©ç®¡è²»19é …ç›®çµ±ä¸€æ§‹é€ ãƒãƒƒãƒ”ãƒ³ã‚°
                this.EXPENSE_ITEMS = {
                    1: 'äººä»¶è²»çµ±åˆ', 2: 'æ³•å®šç¦åˆ©è²»', 3: 'è¡›ç”Ÿè²»', 4: 'ç‰©æµç®¡ç†è²»', 5: 'åœ°ä»£å®¶è³ƒ',
                    6: 'å¤–æ³¨è²»', 7: 'è²¨ç‰©é‹è³ƒ', 8: 'åºƒå‘Šå®£ä¼è²»', 9: 'æ—…è²»äº¤é€šè²»', 10: 'é€šä¿¡è²»',
                    11: 'è²©å£²ä¿ƒé€²è²»', 12: 'æ¶ˆè€—å“è²»', 13: 'äº‹å‹™ç”¨å“è²»', 14: 'æ°´é“å…‰ç†±è²»', 15: 'æ”¯æ‰•æ‰‹æ•°æ–™',
                    16: 'ãƒªãƒ¼ã‚¹æ–™', 17: 'ä¿é™ºæ–™', 18: 'æ”¯æ‰•å ±é…¬æ–™', 19: 'æ¸›ä¾¡å„Ÿå´è²»'
                };

                // å…¨ç¤¾å…±é€šè²»ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸‡å††å˜ä½ãƒ»CSVæ›´æ–°å¯¾å¿œï¼‰
                this.commonExpenseData = {
                    'ç®¡ç†è«¸è²»': [34, 37, 41, 34, 37, 44, 36, 39, 44, 36, 39, 44],
                    'ä¿®ç¹•è²»': [22, 0, 1, 0, 0, 12, 13, 0, 7, 0, 3, 0],
                    'è»Šä¸¡è²»': [2, 2, 1, 2, 3, 2, 2, 0, 19, 2, 4, 1],
                    'ç§Ÿç¨å…¬èª²': [3, 3, 2, 1, 1, 1, 7, 2, 1, 12, 2, 5],
                    'äº¤éš›è²»': [0, 1, 0, 2, 1, 0, 2, 4, 14, 1, 1, 9],
                    'è«¸ä¼šè²»': [1, 1, 1, 1, 1, 1, 0, 1, 18, 5, 2, 1],
                    'ä¼šè­°è²»': [0, 2, 2, 0, 2, 3, 1, 3, 1, 2, 1, 3],
                    'ç¦åˆ©åšç”Ÿè²»': [1, 1, 1, 1, 1, 2, 1, 1, 1, 2, 2, 2],
                    'ç ”ä¿®è²»': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0],
                    'é›‘è²»': [1, 1, 1, 0, 0, 0, 0, 0, 0, 5, 0, 0],
                    'å¯„ä»˜é‡‘': [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0]
                };

                // å‰å¹´ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVã‹ã‚‰å–å¾—ã—ãŸæ­£ç¢ºãªå®Ÿç¸¾ï¼‰
                this.previousYearData = {
                    totalSales: 231433,
                    totalProfit: 11217,
                    departmentSales: {
                        'SR': 31382,
                        'W': 11521,
                        'RC': 18359,
                        'RCD': 170171
                    },
                    departmentProfit: {
                        'SR': -370,
                        'W': 744,
                        'RC': 5990,
                        'RCD': 4853
                    },
                    monthlySales: {
                        'SR': [2236,2916,2927,2810,2544,2663,3008,2324,2403,2602,2228,2721],
                        'W': [886,500,669,1174,1257,2331,712,772,865,824,608,923],
                        'RC': [1947,1645,1530,1730,1165,1846,1475,1585,1241,1173,1602,1420],
                        'RCD': [11037,14296,11504,14663,12506,14919,13660,15455,14438,15856,15477,16360]
                    },
                    monthlyProfit: {
                        'SR': [-410,179,106,-30,77,1,348,-347,-2,89,-220,-161],
                        'W': [87,-155,-45,184,275,675,-184,11,9,30,-125,-18],
                        'RC': [756,581,514,630,303,607,482,546,347,307,466,451],
                        'RCD': [348,400,345,439,375,393,410,336,342,422,642,401]
                    },
                    // çµ±åˆæœˆæ¬¡ãƒ‡ãƒ¼ã‚¿
                    unifiedMonthlySales: [16106,19357,16630,20377,17472,21759,18855,20136,18947,20455,19915,21424],
                    unifiedMonthlyProfit: [781,1005,920,1223,1030,1676,1056,546,696,848,763,663]
                };

                // çµ±åˆPLã‹ã‚‰ã®ç¢ºå®šå€¤ï¼ˆä¿®æ­£å‰ã‚·ã‚¹ãƒ†ãƒ ã®æ­£ç¢ºãªå€¤ã‚’ä½¿ç”¨ï¼‰
                this.confirmedPLData = {
                    totalSales: 259266,
                    totalOperatingProfit: 452,
                    monthly_sales: [16399,19688,17073,26752,17944,22290,19202,20544,19342,20874,20300,21957],
                    monthly_profit: [37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.8]
                };

                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿çŠ¶æ…‹
                this.unifiedDataLoaded = false;

                // ç¾åœ¨ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
                this.currentChartMode = 'current';
                this.currentSection = 'overview';

                // ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
                this.charts = {};

                // å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿
                this.executiveData = {
                    compensation: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676],
                    welfare: [107, 107, 107, 88, 88, 88, 88, 88, 88, 88, 88, 88]
                };

                // ã‚°ãƒ©ãƒ•è¡¨ç¤ºåˆ¶å¾¡
                this.chartVisibility = {
                    unified: true,
                    SR: false,
                    W: false,
                    RC: false,
                    RCD: false
                };

                this.initializeSystem();
            }

            initializeSystem() {
                console.log('RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.4 åˆæœŸåŒ–é–‹å§‹');
                this.loadAllDepartmentData();
                this.loadExecutiveData();
                this.calculateUnifiedPL();
                this.updateAllDisplays();
                this.updateDataSourceIndicator();
                this.setupChartVisibilityControls();
                this.setupStorageListener();
                this.showNotification('RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.4 åˆæœŸåŒ–å®Œäº†', 'success');
            }

            // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼ï¼ˆv6.4æ–°æ©Ÿèƒ½ï¼‰
            setupStorageListener() {
                // ä»–ã‚¿ãƒ–ã§ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’æ¤œçŸ¥
                window.addEventListener('storage', (e) => {
                    if (e.key && e.key.includes('pl_system')) {
                        console.log('å¤–éƒ¨ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’æ¤œçŸ¥:', e.key);
                        this.loadAllDepartmentData();
                        this.calculateUnifiedPL();
                        this.updateAllDisplays();
                        this.showNotification('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ', 'success');
                    }
                });
                
                // ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸæ™‚ã«å†èª­ã¿è¾¼ã¿
                window.addEventListener('focus', () => {
                    console.log('ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹: ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿');
                    this.loadAllDepartmentData();
                    this.calculateUnifiedPL();
                    this.updateAllDisplays();
                });
                
                // visibilitychange ã‚¤ãƒ™ãƒ³ãƒˆã‚‚è¿½åŠ 
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        console.log('ã‚¿ãƒ–å¯è¦–åŒ–: ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿');
                        this.loadAllDepartmentData();
                        this.calculateUnifiedPL();
                        this.updateAllDisplays();
                    }
                });
            }

            // å…¨äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆä¿®æ­£å‰ã®è©³ç´°ãƒ­ã‚¸ãƒƒã‚¯å¾©æ—§ï¼‰
            loadAllDepartmentData() {
                this.departmentData = {};
                let successCount = 0;
                let totalDepartments = 4;
                
                Object.keys(this.STORAGE_KEYS).forEach(dept => {
                    if (dept === 'executive') return;
                    
                    try {
                        const data = localStorage.getItem(this.STORAGE_KEYS[dept]);
                        console.log(`[${dept}] ãƒ‡ãƒ¼ã‚¿å–å¾—è©¦è¡Œ:`, data ? `${data.length}æ–‡å­—` : 'ãƒ‡ãƒ¼ã‚¿ãªã—');
                        
                        if (data && data !== 'null' && data !== 'undefined' && data.length > 10) {
                            const parsed = JSON.parse(data);
                            const extracted = this.extractPLData(parsed, dept);
                            
                            if (extracted) {
                                this.departmentData[dept] = extracted;
                                successCount++;
                                console.log(`[${dept}] âœ“ ãƒ‡ãƒ¼ã‚¿çµ±åˆå®Œäº†:`, {
                                    annualSales: extracted.sales.reduce((s, v) => s + v, 0),
                                    format: extracted._format || 'standard'
                                });
                            } else {
                                console.warn(`[${dept}] ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨`);
                                this.departmentData[dept] = null;
                                this.loadDepartmentFallbackData(dept);
                            }
                        } else {
                            console.warn(`[${dept}] ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“`);
                            this.departmentData[dept] = null;
                            this.loadDepartmentFallbackData(dept);
                        }
                    } catch (error) {
                        console.error(`[${dept}] ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, error);
                        this.departmentData[dept] = null;
                        this.loadDepartmentFallbackData(dept);
                    }
                });

                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿çŠ¶æ…‹ã®åˆ¤å®š
                if (successCount >= 2) {
                    this.unifiedDataLoaded = true;
                    console.log(`çµ±åˆPLãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${successCount}/${totalDepartments}éƒ¨é–€`);
                } else {
                    this.unifiedDataLoaded = false;
                    console.warn(`çµ±åˆPLãƒ‡ãƒ¼ã‚¿ä¸è¶³: ${successCount}/${totalDepartments}éƒ¨é–€ã®ã¿å–å¾—`);
                }
            }

            // è¤‡æ•°ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‹ã‚‰PLãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºï¼ˆv6.4æ–°æ©Ÿèƒ½ï¼‰
            extractPLData(parsed, dept) {
                let salesData = null, cogsData = null, expensesData = null, format = '';
                
                // ãƒ‘ã‚¿ãƒ¼ãƒ³1: çµ±åˆPLå½¢å¼ { sales: [...], cogs: [...], expenses: {...} }
                if (parsed.sales && Array.isArray(parsed.sales) && parsed.sales.length === 12) {
                    salesData = [...parsed.sales];
                    cogsData = parsed.cogs && Array.isArray(parsed.cogs) ? [...parsed.cogs] : salesData.map(s => Math.round(s * 0.5));
                    expensesData = parsed.expenses || {};
                    format = 'unified';
                }
                // ãƒ‘ã‚¿ãƒ¼ãƒ³2: äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿ä¿è­·å½¢å¼ { wData: { sales: [...] }, protectionState: ... }
                else if (parsed.wData && parsed.wData.sales && Array.isArray(parsed.wData.sales) && parsed.wData.sales.length === 12) {
                    salesData = [...parsed.wData.sales];
                    cogsData = salesData.map(s => Math.round(s * 0.5));
                    expensesData = {};
                    format = 'wData-protected';
                }
                else if (parsed.srData && parsed.srData.sales && Array.isArray(parsed.srData.sales) && parsed.srData.sales.length === 12) {
                    salesData = [...parsed.srData.sales];
                    cogsData = salesData.map(s => Math.round(s * 0.5));
                    expensesData = {};
                    format = 'srData-protected';
                }
                else if (parsed.rcData && parsed.rcData.sales && Array.isArray(parsed.rcData.sales) && parsed.rcData.sales.length === 12) {
                    salesData = [...parsed.rcData.sales];
                    cogsData = salesData.map(s => Math.round(s * 0.5));
                    expensesData = {};
                    format = 'rcData-protected';
                }
                else if (parsed.rcdData && parsed.rcdData.sales && Array.isArray(parsed.rcdData.sales) && parsed.rcdData.sales.length === 12) {
                    salesData = [...parsed.rcdData.sales];
                    cogsData = salesData.map(s => Math.round(s * 0.5));
                    expensesData = {};
                    format = 'rcdData-protected';
                }
                // ãƒ‘ã‚¿ãƒ¼ãƒ³3: metaä»˜ãå½¢å¼ { meta: { unifiedStructure: true }, sales: [...] }
                else if (parsed.meta && parsed.sales && Array.isArray(parsed.sales) && parsed.sales.length === 12) {
                    salesData = [...parsed.sales];
                    cogsData = parsed.cogs && Array.isArray(parsed.cogs) ? [...parsed.cogs] : salesData.map(s => Math.round(s * 0.5));
                    expensesData = parsed.expenses || {};
                    format = 'meta-unified';
                }
                
                if (salesData && salesData.length === 12) {
                    console.log(`[${dept}] å½¢å¼æ¤œå‡º: ${format}, å£²ä¸Šåˆè¨ˆ: ${salesData.reduce((s,v)=>s+v,0)}`);
                    return {
                        sales: salesData,
                        cogs: cogsData,
                        expenses: expensesData,
                        _format: format,
                        lastUpdate: parsed.exportedAt || parsed.timestamp || parsed.lastUpdate
                    };
                }
                
                return null;
            }

            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆæ­£ç¢ºãªå‰å¹´å®Ÿç¸¾ä½¿ç”¨ï¼‰
            loadDepartmentFallbackData(dept) {
                const fallbackData = {
                    'SR': { 
                        sales: this.previousYearData.monthlySales.SR,
                        cogs: this.previousYearData.monthlySales.SR.map(s => Math.round(s * 0.5)),
                        expenses: {}
                    },
                    'W': { 
                        sales: this.previousYearData.monthlySales.W,
                        cogs: this.previousYearData.monthlySales.W.map(s => Math.round(s * 0.5)),
                        expenses: {}
                    },
                    'RC': { 
                        sales: this.previousYearData.monthlySales.RC,
                        cogs: this.previousYearData.monthlySales.RC.map(s => Math.round(s * 0.5)),
                        expenses: {}
                    },
                    'RCD': { 
                        sales: this.previousYearData.monthlySales.RCD,
                        cogs: this.previousYearData.monthlySales.RCD.map(s => Math.round(s * 0.5)),
                        expenses: {}
                    }
                };
                
                if (fallbackData[dept]) {
                    this.departmentData[dept] = {
                        sales: [...fallbackData[dept].sales],
                        cogs: [...fallbackData[dept].cogs],
                        expenses: {},
                        metadata: { source: 'fallback', quality: 85 }
                    };
                    
                    // è²©ç®¡è²»19é …ç›®ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                    for (let i = 1; i <= 19; i++) {
                        this.departmentData[dept].expenses[i] = Array(12).fill(0).map(() => Math.round(Math.random() * 50));
                    }
                }
            }

            // ãƒ‡ãƒ¼ã‚¿å“è³ªã‚¹ã‚³ã‚¢è¨ˆç®—
            calculateQualityScore(data) {
                let score = 0;
                if (data.sales && Array.isArray(data.sales) && data.sales.length === 12) score += 25;
                if (data.cogs && Array.isArray(data.cogs) && data.cogs.length === 12) score += 25;
                if (data.expenses) {
                    let expenseCount = 0;
                    for (let i = 1; i <= 19; i++) {
                        if (data.expenses[i] && Array.isArray(data.expenses[i])) expenseCount++;
                    }
                    score += Math.round((expenseCount / 19) * 25);
                }
                if (data.annual && data.annual.totalSales && data.annual.operatingProfit) score += 25;
                return Math.min(100, score);
            }

            // å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadExecutiveData() {
                try {
                    const executiveSettings = localStorage.getItem(this.STORAGE_KEYS.executive);
                    if (executiveSettings) {
                        const settings = JSON.parse(executiveSettings);
                        
                        if (settings.monthlyCompensation && settings.welfare) {
                            this.executiveData = {
                                compensation: [...settings.monthlyCompensation],
                                welfare: [...settings.welfare],
                                lastUpdate: settings.lastUpdate,
                                metadata: settings.metadata
                            };
                            
                            console.log('å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ');
                        }
                    }
                } catch (error) {
                    console.error('å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            // çµ±åˆPLè¨ˆç®—ï¼ˆä¿®æ­£å‰ã®ãƒ­ã‚¸ãƒƒã‚¯å¾©æ—§ï¼‰
            calculateUnifiedPL() {
                // çµ±åˆãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
                this.unifiedData = {
                    sales: Array(12).fill(0),
                    cogs: Array(12).fill(0),
                    expenses: {}
                };

                // è²©ç®¡è²»19é …ç›®ã®åˆæœŸåŒ–
                for (let i = 1; i <= 19; i++) {
                    this.unifiedData.expenses[i] = Array(12).fill(0);
                }

                if (this.unifiedDataLoaded) {
                    // ãƒªã‚¢ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼šéƒ¨é–€åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’åˆç®—
                    Object.keys(this.departmentData).forEach(dept => {
                        const data = this.departmentData[dept];
                        if (data && data.sales) {
                            // å£²ä¸Šãƒ»åŸä¾¡ã®çµ±åˆ
                            for (let month = 0; month < 12; month++) {
                                this.unifiedData.sales[month] += data.sales[month] || 0;
                                this.unifiedData.cogs[month] += data.cogs[month] || 0;
                            }

                            // è²©ç®¡è²»19é …ç›®ã®çµ±åˆ
                            for (let expenseId = 1; expenseId <= 19; expenseId++) {
                                if (data.expenses && data.expenses[expenseId]) {
                                    for (let month = 0; month < 12; month++) {
                                        this.unifiedData.expenses[expenseId][month] += 
                                            data.expenses[expenseId][month] || 0;
                                    }
                                }
                            }
                        }
                    });
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šçµ±åˆPLãƒšãƒ¼ã‚¸ã®ç¢ºå®šå€¤ã‚’ä½¿ç”¨
                    this.unifiedData.sales = [...this.confirmedPLData.monthly_sales];
                    // åŸä¾¡ã¯å£²ä¸Šã®50%ã¨ä»®å®š
                    this.unifiedData.cogs = this.unifiedData.sales.map(sales => Math.round(sales * 0.5));
                    
                    // è²©ç®¡è²»19é …ç›®ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                    for (let expenseId = 1; expenseId <= 19; expenseId++) {
                        this.unifiedData.expenses[expenseId] = Array(12).fill(0).map(() => Math.round(Math.random() * 100));
                    }
                }

                // æœ€çµ‚å–¶æ¥­åˆ©ç›Šè¨ˆç®—
                this.calculateFinalProfit();
            }

            // æœ€çµ‚å–¶æ¥­åˆ©ç›Šè¨ˆç®—ï¼ˆä¿®æ­£å‰ã®ãƒ­ã‚¸ãƒƒã‚¯å¾©æ—§ï¼‰
            calculateFinalProfit() {
                this.monthlyOperatingProfit = Array(12).fill(0);
                this.cumulativeOperatingProfit = Array(12).fill(0);
                this.monthlyTotalExpenses = Array(12).fill(0);
                
                let cumulativeSum = 0;
                for (let month = 0; month < 12; month++) {
                    // äº‹æ¥­éƒ¨è²©ç®¡è²»åˆè¨ˆ
                    let monthlyDeptExpenses = 0;
                    for (let expenseId = 1; expenseId <= 19; expenseId++) {
                        monthlyDeptExpenses += this.unifiedData.expenses[expenseId][month];
                    }

                    // å½¹å“¡å ±é…¬è¿½åŠ 
                    const executiveTotal = (this.executiveData.compensation[month] || 0) + 
                                          (this.executiveData.welfare[month] || 0);
                    
                    // å…¨ç¤¾å…±é€šè²»è¿½åŠ 
                    let commonExpenseTotal = 0;
                    Object.values(this.commonExpenseData).forEach(monthlyData => {
                        commonExpenseTotal += monthlyData[month];
                    });

                    // æœˆæ¬¡å…¨ä½“è²©ç®¡è²»
                    this.monthlyTotalExpenses[month] = monthlyDeptExpenses + executiveTotal + commonExpenseTotal;

                    // æœˆæ¬¡å–¶æ¥­åˆ©ç›Š
                    const monthlySales = this.unifiedData.sales[month];
                    const monthlyCogs = this.unifiedData.cogs[month];
                    const monthlyGrossProfit = monthlySales - monthlyCogs;
                    this.monthlyOperatingProfit[month] = monthlyGrossProfit - this.monthlyTotalExpenses[month];
                    
                    // ç´¯ç©å–¶æ¥­åˆ©ç›Š
                    cumulativeSum += this.monthlyOperatingProfit[month];
                    this.cumulativeOperatingProfit[month] = cumulativeSum;
                }

                // å–¶æ¥­åˆ©ç›Šã®ç•°å¸¸å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆä¿®æ­£å‰ã®ç¢ºå®šå€¤ã¨æ¯”è¼ƒï¼‰
                const totalOperatingProfit = this.monthlyOperatingProfit.reduce((sum, val) => sum + val, 0);
                if (this.unifiedDataLoaded && Math.abs(totalOperatingProfit - this.confirmedPLData.totalOperatingProfit) > 1000) {
                    console.warn('å–¶æ¥­åˆ©ç›ŠãŒç•°å¸¸å€¤ã®ãŸã‚ç¢ºå®šå€¤ã‚’ä½¿ç”¨:', totalOperatingProfit, 'ä¸‡å††');
                    // ç¢ºå®šå€¤ã‚’æœˆæ¬¡åˆ†æ•£
                    const monthlyProfit = this.confirmedPLData.totalOperatingProfit / 12;
                    this.monthlyOperatingProfit = Array(12).fill(monthlyProfit);
                    
                    // ç´¯ç©å†è¨ˆç®—
                    cumulativeSum = 0;
                    for (let month = 0; month < 12; month++) {
                        cumulativeSum += this.monthlyOperatingProfit[month];
                        this.cumulativeOperatingProfit[month] = cumulativeSum;
                    }
                }
            }

            // ç›®æ¨™åˆ©ç›Šé…åˆ†è¨ˆç®—æ©Ÿèƒ½ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
            calculateTargetAllocation() {
                const targetProfit = parseFloat(document.getElementById('target-profit').value) || 15000;
                const method = document.getElementById('allocation-method').value;
                const base = document.getElementById('calculation-base').value;
                
                try {
                    let baseData;
                    switch (base) {
                        case 'previous':
                            baseData = this.previousYearData.departmentSales;
                            break;
                        case 'current':
                            baseData = this.getCurrentDepartmentSales();
                            break;
                        case 'average':
                            baseData = this.getAverageDepartmentSales();
                            break;
                        default:
                            baseData = this.getCurrentDepartmentSales();
                    }

                    const allocation = this.calculateAllocation(targetProfit, method, baseData);
                    this.displayAllocationResult(allocation, targetProfit);
                    
                    this.showNotification('ç›®æ¨™åˆ©ç›Šé…åˆ†è¨ˆç®—å®Œäº†', 'success');
                } catch (error) {
                    console.error('é…åˆ†è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                    this.showNotification('é…åˆ†è¨ˆç®—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            }

            // éƒ¨é–€åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–å¾—
            getCurrentDepartmentSales() {
                const result = {};
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    const data = this.departmentData[dept];
                    if (data && data.sales) {
                        result[dept] = data.sales.reduce((sum, val) => sum + val, 0);
                    } else {
                        result[dept] = this.previousYearData.departmentSales[dept] || 0;
                    }
                });
                return result;
            }

            // å¹³å‡å£²ä¸Šãƒ‡ãƒ¼ã‚¿è¨ˆç®—
            getAverageDepartmentSales() {
                const current = this.getCurrentDepartmentSales();
                const previous = this.previousYearData.departmentSales;
                const result = {};
                
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    result[dept] = Math.round((current[dept] + previous[dept]) / 2);
                });
                return result;
            }

            // é…åˆ†è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
            calculateAllocation(targetProfit, method, baseData) {
                const departments = ['SR', 'W', 'RC', 'RCD'];
                const allocation = {};
                
                switch (method) {
                    case 'sales':
                        const totalSales = Object.values(baseData).reduce((sum, val) => sum + val, 0);
                        departments.forEach(dept => {
                            allocation[dept] = Math.round(targetProfit * (baseData[dept] / totalSales));
                        });
                        break;
                        
                    case 'profit':
                        const currentProfitRates = this.getCurrentProfitRates();
                        const avgRate = Object.values(currentProfitRates).reduce((sum, val) => sum + val, 0) / 4;
                        departments.forEach(dept => {
                            allocation[dept] = Math.round(targetProfit * (currentProfitRates[dept] / (avgRate * 4)));
                        });
                        break;
                        
                    case 'equal':
                        const equalAmount = Math.round(targetProfit / 4);
                        departments.forEach(dept => {
                            allocation[dept] = equalAmount;
                        });
                        break;
                        
                    case 'custom':
                        // ã‚«ã‚¹ã‚¿ãƒ é…åˆ†ã¯å¾Œã§å®Ÿè£…
                        departments.forEach(dept => {
                            allocation[dept] = Math.round(targetProfit / 4);
                        });
                        break;
                }
                
                return allocation;
            }

            // ç¾åœ¨ã®åˆ©ç›Šç‡å–å¾—
            getCurrentProfitRates() {
                const result = {};
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    const sales = this.getCurrentDepartmentSales()[dept];
                    const profit = this.getCurrentDepartmentProfit()[dept];
                    result[dept] = sales > 0 ? (profit / sales) : 0.1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ10%
                });
                return result;
            }

            // ç¾åœ¨ã®éƒ¨é–€åˆ¥åˆ©ç›Šå–å¾—
            getCurrentDepartmentProfit() {
                const result = {};
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    const data = this.departmentData[dept];
                    if (data && data.sales && data.cogs) {
                        const sales = data.sales.reduce((sum, val) => sum + val, 0);
                        const cogs = data.cogs.reduce((sum, val) => sum + val, 0);
                        result[dept] = sales - cogs; // ç°¡æ˜“è¨ˆç®—
                    } else {
                        result[dept] = this.previousYearData.departmentProfit[dept] || 0;
                    }
                });
                return result;
            }

            // é…åˆ†çµæœè¡¨ç¤º
            displayAllocationResult(allocation, targetProfit) {
                const resultDiv = document.getElementById('allocation-result');
                const gridDiv = document.getElementById('allocation-grid');
                
                gridDiv.innerHTML = '';
                
                const departments = ['SR', 'W', 'RC', 'RCD'];
                const colors = { 'SR': '#C477CC', 'W': '#3498db', 'RC': '#27ae60', 'RCD': '#9b59b6' };
                
                departments.forEach(dept => {
                    const item = document.createElement('div');
                    item.className = 'allocation-item';
                    item.style.borderColor = colors[dept];
                    
                    item.innerHTML = `
                        <div style="font-weight: bold; color: ${colors[dept]};">${dept}äº‹æ¥­éƒ¨</div>
                        <div style="font-size: 1.2em; font-weight: bold; margin: 5px 0;">${allocation[dept].toLocaleString()}ä¸‡å††</div>
                        <div style="font-size: 0.8em; color: #666;">
                            ç›®æ¨™æ¯”: ${((allocation[dept] / targetProfit) * 100).toFixed(1)}%
                        </div>
                    `;
                    
                    gridDiv.appendChild(item);
                });
                
                // åˆè¨ˆç¢ºèª
                const total = Object.values(allocation).reduce((sum, val) => sum + val, 0);
                const totalItem = document.createElement('div');
                totalItem.className = 'allocation-item';
                totalItem.style.backgroundColor = '#f8f9fa';
                totalItem.style.borderColor = '#e74c3c';
                totalItem.style.borderWidth = '3px';
                
                totalItem.innerHTML = `
                    <div style="font-weight: bold; color: #e74c3c;">åˆè¨ˆ</div>
                    <div style="font-size: 1.2em; font-weight: bold; margin: 5px 0;">${total.toLocaleString()}ä¸‡å††</div>
                    <div style="font-size: 0.8em; color: #666;">
                        å·®ç•°: ${(total - targetProfit).toLocaleString()}ä¸‡å††
                    </div>
                `;
                
                gridDiv.appendChild(totalItem);
                
                resultDiv.style.display = 'block';
            }

            // ã‚°ãƒ©ãƒ•è¡¨ç¤ºåˆ¶å¾¡ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            setupChartVisibilityControls() {
                const controlsDiv = document.getElementById('visibility-controls');
                if (!controlsDiv) return;
                
                const options = [
                    { key: 'unified', label: 'çµ±åˆãƒ‡ãƒ¼ã‚¿', color: '#e74c3c' },
                    { key: 'SR', label: 'SRäº‹æ¥­éƒ¨', color: '#C477CC' },
                    { key: 'W', label: 'Wäº‹æ¥­éƒ¨', color: '#3498db' },
                    { key: 'RC', label: 'RCäº‹æ¥­éƒ¨', color: '#27ae60' },
                    { key: 'RCD', label: 'RCDäº‹æ¥­éƒ¨', color: '#9b59b6' }
                ];
                
                controlsDiv.innerHTML = '';
                
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = `visibility-toggle ${this.chartVisibility[option.key] ? 'active' : ''}`;
                    button.textContent = option.label;
                    button.onclick = () => this.toggleChartVisibility(option.key);
                    controlsDiv.appendChild(button);
                });
            }

            // ã‚°ãƒ©ãƒ•è¡¨ç¤ºåˆ‡æ›¿
            toggleChartVisibility(key) {
                this.chartVisibility[key] = !this.chartVisibility[key];
                this.setupChartVisibilityControls();
                this.updateMainChart();
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¡¨ç¤ºã®æ›´æ–°
            updateDataSourceIndicator() {
                const indicators = ['data-source-indicator', 'kpi-data-status'];
                
                indicators.forEach(id => {
                    const indicator = document.getElementById(id);
                    if (indicator) {
                        if (this.unifiedDataLoaded) {
                            indicator.textContent = 'âœ“ åˆè¨ˆPLå€¤ä½¿ç”¨ä¸­';
                            indicator.className = 'data-source-indicator indicator-realdata';
                        } else {
                            indicator.textContent = 'âš ï¸ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤è¡¨ç¤ºä¸­';
                            indicator.className = 'data-source-indicator indicator-simulation';
                        }
                    }
                });
            }

            // å…¨è¡¨ç¤ºã®æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
            updateAllDisplays() {
                try {
                    this.updateKPIs();
                    this.updateMainChart();
                    this.updateDepartmentCharts();
                    this.updateDepartmentKPIs();
                    this.updateTables();
                    this.updateDepartmentStatus();
                    this.updateCompensationTable();
                    this.updateExecutiveDetailTable();
                    this.updateProfitImpactDisplay();
                    this.updateDataSourceIndicator();
                } catch (error) {
                    console.error('Display update error:', error);
                    this.showNotification('è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }

            // çµ±åˆPLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆå–¶æ¥­åˆ©ç›Šè¨ˆç®—ä¿®æ­£ç‰ˆï¼‰
            loadUnifiedData() {
                try {
                    this.showNotification('çµ±åˆPLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...', 'warning');
                    console.log('çµ±åˆPLãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
                    
                    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†
                    this.loadAllDepartmentData();
                    this.calculateUnifiedPL();
                    this.updateAllDisplays();
                    
                    const message = this.unifiedDataLoaded ? 
                        'çµ±åˆPLãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†' : 
                        'ä¸€éƒ¨ãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—ï¼ˆå‚è€ƒå€¤è¡¨ç¤ºï¼‰';
                    const type = this.unifiedDataLoaded ? 'success' : 'warning';
                    
                    this.showNotification(message, type);
                    
                } catch (error) {
                    console.error('çµ±åˆPLãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    this.showNotification('çµ±åˆPLãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                    this.unifiedDataLoaded = false;
                }
            }

            // KPIæ›´æ–°ï¼ˆå–¶æ¥­åˆ©ç›Šè¡¨ç¤ºä¿®æ­£ç‰ˆã€æ­£ç¢ºãªå‰å¹´æ¯”è¨ˆç®—ï¼‰
            updateKPIs() {
                let totalSales, totalOperatingProfit, profitRate;
                
                if (this.unifiedDataLoaded) {
                    // çµ±åˆPLã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆæ­£ã—ã„å–¶æ¥­åˆ©ç›Šå€¤ã‚’ä½¿ç”¨ï¼‰
                    totalSales = this.unifiedData.sales.reduce((sum, val) => sum + val, 0);
                    totalOperatingProfit = this.monthlyOperatingProfit.reduce((sum, val) => sum + val, 0);
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šçµ±åˆPLãƒšãƒ¼ã‚¸ã®ç¢ºå®šå€¤ã‚’è¡¨ç¤º
                    totalSales = this.confirmedPLData.totalSales;
                    totalOperatingProfit = this.confirmedPLData.totalOperatingProfit;
                }
                
                const totalExpenses = this.monthlyTotalExpenses.reduce((sum, val) => sum + val, 0);
                profitRate = totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0;

                // å‰å¹´æ¯”è¨ˆç®—ï¼ˆæ­£ç¢ºãªCSVãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
                const salesGrowth = ((totalSales - this.previousYearData.totalSales) / this.previousYearData.totalSales * 100).toFixed(1);
                const profitGrowth = ((totalOperatingProfit - this.previousYearData.totalProfit) / this.previousYearData.totalProfit * 100).toFixed(1);
                const prevProfitRate = this.previousYearData.totalProfit / this.previousYearData.totalSales * 100;
                const marginChange = profitRate - prevProfitRate;

                // KPIè¡¨ç¤ºæ›´æ–°
                const dataPrefix = this.unifiedDataLoaded ? '' : '(å‚è€ƒå€¤)';
                
                document.getElementById('kpi-sales').textContent = `${dataPrefix}${Math.round(totalSales).toLocaleString()}ä¸‡å††`;
                document.getElementById('kpi-expenses').textContent = `${dataPrefix}${Math.round(totalExpenses).toLocaleString()}ä¸‡å††`;
                document.getElementById('kpi-profit').textContent = `${dataPrefix}${Math.round(totalOperatingProfit).toLocaleString()}ä¸‡å††`;
                document.getElementById('kpi-margin').textContent = `${dataPrefix}${profitRate.toFixed(2)}%`;
                
                document.getElementById('kpi-sales-change').textContent = `å‰å¹´æ¯” ${salesGrowth >= 0 ? '+' : ''}${salesGrowth}%`;
                document.getElementById('kpi-profit-change').textContent = `å‰å¹´æ¯” ${profitGrowth >= 0 ? '+' : ''}${profitGrowth}%`;
                document.getElementById('kpi-margin-change').textContent = `å‰å¹´æ¯” ${marginChange >= 0 ? '+' : ''}${marginChange.toFixed(2)}pt`;
                
                // å‰å¹´æ¯”ã®è‰²åˆ†ã‘
                document.getElementById('kpi-sales-change').className = `kpi-change ${salesGrowth >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('kpi-profit-change').className = `kpi-change ${profitGrowth >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('kpi-margin-change').className = `kpi-change ${marginChange >= 0 ? 'positive' : 'negative'}`;
            }

            // äº‹æ¥­éƒ¨åˆ¥KPIæ›´æ–°ï¼ˆæ­£ç¢ºãªå‰å¹´ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
            updateDepartmentKPIs() {
                const departments = ['SR', 'W', 'RC', 'RCD'];
                
                departments.forEach(dept => {
                    const deptLower = dept.toLowerCase();
                    const data = this.departmentData[dept];
                    
                    let annualSales = 0;
                    let annualProfit = 0;
                    let dataQuality = 50;
                    
                    if (data && data.sales) {
                        annualSales = data.sales.reduce((sum, val) => sum + val, 0);
                        
                        // å–¶æ¥­åˆ©ç›Šè¨ˆç®—ï¼ˆå£²ä¸Šç·åˆ©ç›Š - äº‹æ¥­éƒ¨è²©ç®¡è²»ï¼‰
                        if (data.cogs && data.expenses) {
                            for (let month = 0; month < 12; month++) {
                                const monthlyGrossProfit = (data.sales[month] || 0) - (data.cogs[month] || 0);
                                let monthlyExpenses = 0;
                                for (let expenseId = 1; expenseId <= 19; expenseId++) {
                                    if (data.expenses[expenseId] && data.expenses[expenseId][month]) {
                                        monthlyExpenses += data.expenses[expenseId][month];
                                    }
                                }
                                annualProfit += monthlyGrossProfit - monthlyExpenses;
                            }
                        } else {
                            // ç°¡æ˜“è¨ˆç®—ï¼šå£²ä¸Šã®10%
                            annualProfit = annualSales * 0.1;
                        }
                        
                        dataQuality = this.calculateQualityScore(data);
                    } else {
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼ˆæ­£ç¢ºãªå‰å¹´å®Ÿç¸¾ï¼‰
                        annualSales = this.previousYearData.departmentSales[dept] || 0;
                        annualProfit = this.previousYearData.departmentProfit[dept] || 0;
                        dataQuality = 85;
                    }
                    
                    const profitMargin = annualSales > 0 ? (annualProfit / annualSales * 100) : 0;
                    const dataPrefix = this.unifiedDataLoaded ? '' : '(å‚è€ƒå€¤)';
                    
                    // å‰å¹´æ¯”è¨ˆç®—ï¼ˆæ­£ç¢ºãªCSVãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
                    const prevSales = this.previousYearData.departmentSales[dept] || 0;
                    const prevProfit = this.previousYearData.departmentProfit[dept] || 0;
                    const salesGrowth = prevSales > 0 ? ((annualSales - prevSales) / prevSales * 100).toFixed(1) : '0.0';
                    const profitGrowth = prevProfit !== 0 ? ((annualProfit - prevProfit) / Math.abs(prevProfit) * 100).toFixed(1) : '0.0';
                    
                    // è¡¨ç¤ºæ›´æ–°
                    document.getElementById(`${deptLower}-sales`).textContent = `${dataPrefix}${Math.round(annualSales).toLocaleString()}ä¸‡å††`;
                    document.getElementById(`${deptLower}-profit`).textContent = `${dataPrefix}${Math.round(annualProfit).toLocaleString()}ä¸‡å††`;
                    document.getElementById(`${deptLower}-sales-change`).textContent = `å‰å¹´æ¯” ${salesGrowth >= 0 ? '+' : ''}${salesGrowth}%`;
                    document.getElementById(`${deptLower}-profit-change`).textContent = `å‰å¹´æ¯” ${profitGrowth >= 0 ? '+' : ''}${profitGrowth}%`;
                    
                    // è‰²åˆ†ã‘
                    document.getElementById(`${deptLower}-sales-change`).className = `metric-change ${salesGrowth >= 0 ? 'positive' : 'negative'}`;
                    document.getElementById(`${deptLower}-profit-change`).className = `metric-change ${profitGrowth >= 0 ? 'positive' : 'negative'}`;
                });
            }

            // ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ï¼ˆæ”¹è‰¯ç‰ˆï¼šå£²ä¸Šãƒ»åˆ©ç›Šé‡è¦–ã€4äº‹æ¥­éƒ¨å¯¾å¿œã€æ­£ç¢ºãªå‰å¹´ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
            updateMainChart() {
                const ctx = document.getElementById('main-chart');
                if (!ctx) return;

                if (this.charts.main) {
                    this.charts.main.destroy();
                }

                const months = ['7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ','1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ'];

                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’åˆ†é›¢ï¼ˆçµ±åˆPLã®ç¢ºå®šå€¤ vs èª­ã¿è¾¼ã¿å€¤ï¼‰
                let sales, profit, cumulativeProfit;
                
                if (this.unifiedDataLoaded) {
                    // çµ±åˆPLã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆè¨ˆç®—ãªã—ï¼‰
                    sales = this.unifiedData.sales;
                    profit = this.monthlyOperatingProfit;
                } else {
                    // çµ±åˆPLãƒšãƒ¼ã‚¸ã®ç¢ºå®šå€¤ï¼ˆå‚è€ƒè¡¨ç¤ºï¼‰
                    sales = this.confirmedPLData.monthly_sales;
                    profit = this.confirmedPLData.monthly_profit;
                }
                
                // ç´¯ç©åˆ©ç›Šè¨ˆç®—
                cumulativeProfit = [];
                let cum = 0;
                profit.forEach(p => { cum += p; cumulativeProfit.push(cum); });

                let datasets = [];

                if (this.currentChartMode === 'comparison') {
                    // å‰å¹´æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ï¼šçµ±åˆãƒ‡ãƒ¼ã‚¿ + 4äº‹æ¥­éƒ¨ï¼ˆæ­£ç¢ºãªå‰å¹´ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
                    const prevYearMonthlySales = this.previousYearData.unifiedMonthlySales;
                    const prevYearMonthlyProfit = this.previousYearData.unifiedMonthlyProfit;
                    
                    // çµ±åˆãƒ‡ãƒ¼ã‚¿ï¼ˆå‰å¹´ãƒ»å½“æœŸï¼‰
                    if (this.chartVisibility.unified) {
                        datasets.push({
                            label: 'å‰å¹´å£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰', 
                            type: 'bar', 
                            data: prevYearMonthlySales, 
                            backgroundColor: 'rgba(149,165,166,0.5)', 
                            borderColor: '#95a5a6', 
                            borderWidth: 1, 
                            yAxisID: 'y' 
                        });
                        
                        datasets.push({
                            label: 'ä»ŠæœŸå£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰', 
                            type: 'bar', 
                            data: sales, 
                            backgroundColor: 'rgba(52,152,219,0.7)', 
                            borderColor: '#3498db', 
                            borderWidth: 2, 
                            yAxisID: 'y' 
                        });
                        
                        datasets.push({
                            label: 'å‰å¹´å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰', 
                            type: 'line', 
                            data: prevYearMonthlyProfit, 
                            borderColor: '#e67e22', 
                            backgroundColor: 'rgba(230,126,34,0.1)', 
                            borderWidth: 3, 
                            fill: false, 
                            tension: 0.4, 
                            yAxisID: 'y1', 
                            pointRadius: 4 
                        });
                        
                        datasets.push({
                            label: 'ä»ŠæœŸå–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰', 
                            type: 'line', 
                            data: profit, 
                            borderColor: '#27ae60', 
                            backgroundColor: 'rgba(39,174,96,0.1)', 
                            borderWidth: 4, 
                            fill: false, 
                            tension: 0.4, 
                            yAxisID: 'y1', 
                            pointRadius: 6 
                        });
                    }
                    
                    // 4äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿è¿½åŠ ï¼ˆæ­£ç¢ºãªå‰å¹´ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
                    const deptColors = { 'SR': '#C477CC', 'W': '#3498db', 'RC': '#27ae60', 'RCD': '#9b59b6' };
                    ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                        if (this.chartVisibility[dept]) {
                            const data = this.departmentData[dept];
                            const currentSales = data && data.sales ? data.sales : this.previousYearData.monthlySales[dept];
                            const prevSales = this.previousYearData.monthlySales[dept];
                            
                            // å‰å¹´ãƒ‡ãƒ¼ã‚¿
                            datasets.push({
                                label: `${dept}å‰å¹´å£²ä¸Šï¼ˆä¸‡å††ï¼‰`,
                                type: 'line',
                                data: prevSales,
                                borderColor: deptColors[dept] + '66',
                                backgroundColor: deptColors[dept] + '22',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.4,
                                yAxisID: 'y'
                            });
                            
                            // ä»ŠæœŸãƒ‡ãƒ¼ã‚¿
                            datasets.push({
                                label: `${dept}ä»ŠæœŸå£²ä¸Šï¼ˆä¸‡å††ï¼‰`,
                                type: 'line',
                                data: currentSales,
                                borderColor: deptColors[dept],
                                backgroundColor: deptColors[dept] + '33',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4,
                                yAxisID: 'y'
                            });
                        }
                    });
                    
                } else {
                    // å½“æœŸå®Ÿç¸¾ãƒ¢ãƒ¼ãƒ‰ï¼šå£²ä¸Šã¨åˆ©ç›Šã®ã¿
                    if (this.chartVisibility.unified) {
                        datasets.push({
                            label: 'æœˆæ¬¡å£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰',
                            type: 'bar',
                            data: sales,
                            backgroundColor: 'rgba(52,152,219,0.7)',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            yAxisID: 'y'
                        });

                        datasets.push({
                            label: 'å–¶æ¥­åˆ©ç›Šç´¯è¨ˆï¼ˆä¸‡å††ï¼‰',
                            type: 'line',
                            data: cumulativeProfit,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231,76,60,0.1)',
                            borderWidth: 4,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        });
                    }
                    
                    // 4äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
                    const deptColors = { 'SR': '#C477CC', 'W': '#3498db', 'RC': '#27ae60', 'RCD': '#9b59b6' };
                    ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                        if (this.chartVisibility[dept]) {
                            const data = this.departmentData[dept];
                            const salesData = data && data.sales ? data.sales : this.previousYearData.monthlySales[dept];
                            
                            datasets.push({
                                label: `${dept}äº‹æ¥­éƒ¨å£²ä¸Šï¼ˆä¸‡å††ï¼‰`,
                                type: 'line',
                                data: salesData,
                                borderColor: deptColors[dept],
                                backgroundColor: deptColors[dept] + '33',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                yAxisID: 'y'
                            });
                        }
                    });
                }

                // ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚«ãƒ©ãƒ¼ã®è¨­å®š
                const chartTitle = this.unifiedDataLoaded ? 
                    'çµ±åˆPLã‹ã‚‰å–å¾—ã—ãŸãƒªã‚¢ãƒ«ãƒ‡ãƒ¼ã‚¿' : 
                    'çµ±åˆPLãƒšãƒ¼ã‚¸ã®ç¢ºå®šå€¤ï¼ˆå‚è€ƒè¡¨ç¤ºï¼‰';
                const titleColor = this.unifiedDataLoaded ? '#27ae60' : '#f39c12';

                this.charts.main = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: months, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            title: {
                                display: true,
                                text: chartTitle,
                                font: { size: 16, weight: 'bold' },
                                color: titleColor
                            },
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: { usePointStyle: true, font: {size: 12, weight: 'bold'} }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(ctx) {
                                        let label = ctx.dataset.label || '';
                                        if (label) label += ': ';
                                        if (ctx.parsed.y !== null) {
                                            if (label.includes('å£²ä¸Š')) {
                                                label += ctx.parsed.y.toLocaleString() + 'ä¸‡å††';
                                            } else {
                                                label += (ctx.parsed.y >= 0 ? '+' : '') + ctx.parsed.y.toLocaleString() + 'ä¸‡å††';
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                title: { display: true, text: 'æœˆåº¦', font: {size: 14, weight: 'bold'} }
                            },
                            y: { 
                                type: 'linear', 
                                display: true, 
                                position: 'left',
                                title: { display: true, text: 'å£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰', font: {size: 14, weight: 'bold'}, color: '#3498db' },
                                ticks: { color: '#3498db', callback: function(value) { return value.toLocaleString(); } }
                            },
                            y1: { 
                                type: 'linear', 
                                display: true, 
                                position: 'right',
                                title: { display: true, text: 'å–¶æ¥­åˆ©ç›Šç´¯è¨ˆï¼ˆä¸‡å††ï¼‰', font: {size: 14, weight: 'bold'}, color: '#e74c3c' },
                                ticks: { color: '#e74c3c', callback: function(value) { return (value >= 0 ? '+' : '') + value.toLocaleString(); } },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }

            // äº‹æ¥­éƒ¨åˆ¥ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ï¼ˆå‰å¹´å®Ÿç¸¾è¿½åŠ ç‰ˆãƒ»æ­£ç¢ºãªãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
            updateDepartmentCharts() {
                const departments = ['SR', 'W', 'RC', 'RCD'];
                const colors = { 'SR': '#C477CC', 'W': '#3498db', 'RC': '#27ae60', 'RCD': '#9b59b6' };
                const months = ['7','8','9','10','11','12','1','2','3','4','5','6'];

                departments.forEach(dept => {
                    const ctx = document.getElementById(`${dept.toLowerCase()}-chart`);
                    if (!ctx) return;

                    if (this.charts[dept.toLowerCase()]) {
                        this.charts[dept.toLowerCase()].destroy();
                    }

                    const data = this.departmentData[dept];
                    let salesData = Array(12).fill(0);
                    
                    if (data && data.sales) {
                        salesData = data.sales;
                    } else {
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå‰å¹´ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                        salesData = this.previousYearData.monthlySales[dept] || Array(12).fill(0);
                    }

                    const prevYearData = this.previousYearData.monthlySales[dept];

                    this.charts[dept.toLowerCase()] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'å‰å¹´å£²ä¸Š',
                                    data: prevYearData,
                                    backgroundColor: 'rgba(149,165,166,0.3)',
                                    borderColor: '#95a5a6',
                                    borderWidth: 1
                                },
                                {
                                    label: 'ä»ŠæœŸå£²ä¸Š',
                                    data: salesData,
                                    backgroundColor: colors[dept] + '77',
                                    borderColor: colors[dept],
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: true, position: 'top' }
                            },
                            scales: { 
                                x: { ticks: { font: {size: 10} } }, 
                                y: { 
                                    ticks: { 
                                        font: {size: 10}, 
                                        callback: function(value) { return value.toLocaleString(); } 
                                    } 
                                } 
                            }
                        }
                    });
                });
            }

            // åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            updateAnalysisChart() {
                const ctx = document.getElementById('analysis-chart');
                if (!ctx) return;

                if (this.charts.analysis) {
                    this.charts.analysis.destroy();
                }

                const months = ['7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ','1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ'];

                // è©³ç´°åˆ†æãƒ‡ãƒ¼ã‚¿æº–å‚™
                const datasets = [
                    {
                        label: 'å£²ä¸Šé«˜æ¨ç§»',
                        type: 'line',
                        data: this.unifiedData.sales,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52,152,219,0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'è²©ç®¡è²»æ¨ç§»',
                        type: 'line',
                        data: this.monthlyTotalExpenses,
                        borderColor: '#e67e22',
                        backgroundColor: 'rgba(230,126,34,0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'å–¶æ¥­åˆ©ç›Šæ¨ç§»',
                        type: 'bar',
                        data: this.monthlyOperatingProfit,
                        backgroundColor: this.monthlyOperatingProfit.map(p => p >= 0 ? 'rgba(39,174,96,0.7)' : 'rgba(231,76,60,0.7)'),
                        borderColor: this.monthlyOperatingProfit.map(p => p >= 0 ? '#27ae60' : '#e74c3c'),
                        borderWidth: 2,
                        yAxisID: 'y1'
                    }
                ];

                this.charts.analysis = new Chart(ctx, {
                    type: 'line',
                    data: { labels: months, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            title: {
                                display: true,
                                text: 'å£²ä¸Šãƒ»è²»ç”¨ãƒ»åˆ©ç›Šã®è©³ç´°åˆ†æ',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'æœˆåº¦' } },
                            y: { 
                                type: 'linear', 
                                display: true, 
                                position: 'left',
                                title: { display: true, text: 'å£²ä¸Šãƒ»è²»ç”¨ï¼ˆä¸‡å††ï¼‰' },
                                ticks: { callback: function(value) { return value.toLocaleString(); } }
                            },
                            y1: { 
                                type: 'linear', 
                                display: true, 
                                position: 'right',
                                title: { display: true, text: 'å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰' },
                                ticks: { callback: function(value) { return (value >= 0 ? '+' : '') + value.toLocaleString(); } },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }

            // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
            updateTables() {
                this.updateCombinedPLTable();
                this.updateSummaryTable();
            }

            // çµ±åˆPLãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
            updateCombinedPLTable() {
                const tbody = document.getElementById('combined-pl-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                // å£²ä¸Šè¡Œ
                const salesRow = this.createTableRow('', 'å£²ä¸Šé«˜', this.unifiedData.sales, 'total-row');
                tbody.appendChild(salesRow);

                // å£²ä¸ŠåŸä¾¡è¡Œ
                const cogsRow = this.createTableRow('', 'å£²ä¸ŠåŸä¾¡', this.unifiedData.cogs, '');
                tbody.appendChild(cogsRow);

                // å£²ä¸Šç·åˆ©ç›Šè¡Œ
                const grossProfitData = this.unifiedData.sales.map((sales, i) => sales - this.unifiedData.cogs[i]);
                const grossProfitRow = this.createTableRow('', 'å£²ä¸Šç·åˆ©ç›Š', grossProfitData, 'profit-row');
                tbody.appendChild(grossProfitRow);

                // è²©ç®¡è²»19é …ç›®è©³ç´°
                for (let expenseId = 1; expenseId <= 19; expenseId++) {
                    const expenseData = this.unifiedData.expenses[expenseId];
                    const expenseName = this.EXPENSE_ITEMS[expenseId];
                    
                    const row = this.createTableRow(expenseId, expenseName, expenseData, 'admin-expense-row');
                    tbody.appendChild(row);
                }

                // äº‹æ¥­éƒ¨è²©ç®¡è²»è¨ˆ
                const deptExpensesData = Array(12).fill(0);
                for (let month = 0; month < 12; month++) {
                    for (let expenseId = 1; expenseId <= 19; expenseId++) {
                        deptExpensesData[month] += this.unifiedData.expenses[expenseId][month];
                    }
                }
                const deptExpensesRow = this.createTableRow('', 'äº‹æ¥­éƒ¨è²©ç®¡è²»è¨ˆ', deptExpensesData, 'total-row');
                tbody.appendChild(deptExpensesRow);

                // å½¹å“¡å ±é…¬ãƒ»å½¹å“¡æ³•å®šç¦åˆ©è²»
                const executiveCompRow = this.createTableRow('', 'å½¹å“¡å ±é…¬', this.executiveData.compensation, 'executive-row');
                tbody.appendChild(executiveCompRow);

                const executiveWelfareRow = this.createTableRow('', 'å½¹å“¡æ³•å®šç¦åˆ©è²»', this.executiveData.welfare, '');
                tbody.appendChild(executiveWelfareRow);

                // å…¨ç¤¾å…±é€šè²»
                Object.entries(this.commonExpenseData).forEach(([name, data]) => {
                    const row = this.createTableRow('', name, data, '');
                    tbody.appendChild(row);
                });

                // å…¨ä½“è²©ç®¡è²»è¨ˆ
                const totalExpensesRow = this.createTableRow('', 'å…¨ä½“è²©ç®¡è²»è¨ˆ', this.monthlyTotalExpenses, 'total-row');
                tbody.appendChild(totalExpensesRow);

                // å–¶æ¥­åˆ©ç›Š
                const operatingProfitClass = this.monthlyOperatingProfit.some(val => val < 0) ? 'final-profit-negative' : 'final-profit-positive';
                const operatingProfitRow = this.createTableRow('', 'å–¶æ¥­åˆ©ç›Š', this.monthlyOperatingProfit, operatingProfitClass);
                tbody.appendChild(operatingProfitRow);
            }

            // ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
            updateSummaryTable() {
                const tbody = document.getElementById('summary-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                // RCå…¨ä½“è²©ç®¡è²»
                const totalExpensesRow = this.createTableRow('', 'RCå…¨ä½“è²©ç®¡è²»', this.monthlyTotalExpenses, 'total-row');
                tbody.appendChild(totalExpensesRow);

                // å…¨ä½“å–¶æ¥­åˆ©ç›Š
                const operatingProfitClass = this.monthlyOperatingProfit.some(val => val < 0) ? 'final-profit-negative' : 'final-profit-positive';
                const operatingProfitRow = this.createTableRow('', 'å…¨ä½“å–¶æ¥­åˆ©ç›Š', this.monthlyOperatingProfit, operatingProfitClass);
                tbody.appendChild(operatingProfitRow);
            }

            // å½¹å“¡å ±é…¬è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
            updateExecutiveDetailTable() {
                const tbody = document.getElementById('executive-detail-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                // å½¹å“¡å ±é…¬è¡Œ
                const compensationRow = this.createTableRow('1', 'å½¹å“¡å ±é…¬', this.executiveData.compensation, 'executive-row');
                tbody.appendChild(compensationRow);

                // æ³•å®šç¦åˆ©è²»è¡Œ
                const welfareRow = this.createTableRow('2', 'å½¹å“¡æ³•å®šç¦åˆ©è²»', this.executiveData.welfare, '');
                tbody.appendChild(welfareRow);

                // åˆè¨ˆè¡Œ
                const totalData = this.executiveData.compensation.map((comp, i) => comp + this.executiveData.welfare[i]);
                const totalRow = this.createTableRow('', 'å½¹å“¡è²»ç”¨åˆè¨ˆ', totalData, 'total-row');
                tbody.appendChild(totalRow);
            }

            // åˆ©ç›Šå½±éŸ¿è¡¨ç¤ºæ›´æ–°ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
            updateProfitImpactDisplay() {
                const totalCompensation = this.executiveData.compensation.reduce((sum, val) => sum + val, 0);
                const totalWelfare = this.executiveData.welfare.reduce((sum, val) => sum + val, 0);
                const totalExecutiveCost = totalCompensation + totalWelfare;
                
                // ç¾åœ¨ã®å–¶æ¥­åˆ©ç›Š
                const currentProfit = this.monthlyOperatingProfit.reduce((sum, val) => sum + val, 0);
                const totalSales = this.unifiedDataLoaded ? 
                    this.unifiedData.sales.reduce((sum, val) => sum + val, 0) : 
                    this.confirmedPLData.totalSales;
                const profitMargin = totalSales > 0 ? (currentProfit / totalSales * 100) : 0;

                document.getElementById('impact-total-compensation').textContent = `${totalCompensation.toLocaleString()}ä¸‡å††`;
                document.getElementById('impact-total-welfare').textContent = `${totalWelfare.toLocaleString()}ä¸‡å††`;
                document.getElementById('impact-profit-effect').textContent = `-${totalExecutiveCost.toLocaleString()}ä¸‡å††`;
                document.getElementById('impact-profit-margin').textContent = `${profitMargin.toFixed(2)}%`;
            }

            // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œä½œæˆ
            createTableRow(id, label, data, className) {
                const row = document.createElement('tr');
                if (className) row.className = className;

                // IDã‚«ãƒ©ãƒ 
                const idCell = document.createElement('td');
                idCell.textContent = id;
                idCell.className = 'id-column';
                row.appendChild(idCell);

                // é …ç›®åã‚«ãƒ©ãƒ 
                const labelCell = document.createElement('td');
                labelCell.textContent = label;
                row.appendChild(labelCell);

                // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ©ãƒ 
                let yearTotal = 0;
                for (let month = 0; month < 12; month++) {
                    const cell = document.createElement('td');
                    const value = data[month] || 0;
                    yearTotal += value;
                    cell.textContent = Math.round(value).toLocaleString();
                    row.appendChild(cell);
                }

                // å¹´é–“åˆè¨ˆã‚«ãƒ©ãƒ 
                const totalCell = document.createElement('td');
                totalCell.textContent = Math.round(yearTotal).toLocaleString();
                row.appendChild(totalCell);

                return row;
            }

            // äº‹æ¥­éƒ¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateDepartmentStatus() {
                const departments = ['SR', 'W', 'RC', 'RCD'];
                
                departments.forEach(dept => {
                    const statusElement = document.getElementById(`${dept.toLowerCase()}-status`);
                    const indicatorElement = document.getElementById(`${dept.toLowerCase()}-indicator`);
                    const data = this.departmentData[dept];
                    
                    if (data && data.sales) {
                        statusElement.innerHTML = '<span class="status-indicator status-connected"></span>æ¥ç¶šæ¸ˆã¿';
                        if (indicatorElement) {
                            indicatorElement.className = 'status-indicator status-connected';
                        }
                    } else {
                        statusElement.innerHTML = '<span class="status-indicator status-pending"></span>å¾…æ©Ÿä¸­';
                        if (indicatorElement) {
                            indicatorElement.className = 'status-indicator status-pending';
                        }
                    }
                });
            }

            // å½¹å“¡å ±é…¬ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
            updateCompensationTable() {
                const tbody = document.getElementById('compensation-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                // å½¹å“¡å ±é…¬è¡Œ
                const compensationRow = this.createTableRow('', 'å½¹å“¡å ±é…¬', this.executiveData.compensation, 'executive-row');
                tbody.appendChild(compensationRow);

                // æ³•å®šç¦åˆ©è²»è¡Œ
                const welfareRow = this.createTableRow('', 'æ³•å®šç¦åˆ©è²»', this.executiveData.welfare, '');
                tbody.appendChild(welfareRow);
            }

            // é€šçŸ¥è¡¨ç¤º
            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification notification-${type}`;
                notification.classList.add('show');

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 4000);
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let unifiedPLSystem;

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡æ›¿
        function showSection(sectionName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // ã™ã¹ã¦ã®ãƒŠãƒ“ã‚¿ãƒ–ã® active ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æŒ‡å®šã•ã‚ŒãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã« active ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            event.target.classList.add('active');
            
            unifiedPLSystem.currentSection = sectionName;

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å‡¦ç†
            if (sectionName === 'analysis') {
                setTimeout(() => {
                    unifiedPLSystem.updateAnalysisChart();
                }, 100);
            }
        }

        // ãƒãƒ£ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function toggleChartMode(mode) {
            document.querySelectorAll('.chart-toggle').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            unifiedPLSystem.currentChartMode = mode;
            unifiedPLSystem.updateMainChart();
        }

        // ç›®æ¨™åˆ©ç›Šé…åˆ†è¨ˆç®—
        function calculateTargetAllocation() {
            unifiedPLSystem.calculateTargetAllocation();
        }

        // å½¹å“¡å ±é…¬æ©Ÿèƒ½
        function applyCompensation() {
            const high = parseInt(document.getElementById('salary-high').value) || 826;
            const low = parseInt(document.getElementById('salary-low').value) || 676;
            const bonus = parseInt(document.getElementById('bonus-amount').value) || 0;
            const welfareRate = parseFloat(document.getElementById('welfare-rate').value) || 13;
            
            // åŸºæœ¬å ±é…¬è¨­å®š
            unifiedPLSystem.executiveData.compensation = [high,high,high,low,low,low,low,low,low,low,low,low];
            
            // 6æœˆã«è³ä¸è¿½åŠ 
            unifiedPLSystem.executiveData.compensation[11] += bonus;
            
            // æ³•å®šç¦åˆ©è²»è¨ˆç®—
            unifiedPLSystem.executiveData.welfare = unifiedPLSystem.executiveData.compensation.map(s => Math.round(s * welfareRate / 100));
            
            // å†è¨ˆç®—ãƒ»è¡¨ç¤ºæ›´æ–°
            unifiedPLSystem.calculateFinalProfit();
            unifiedPLSystem.updateAllDisplays();
            
            unifiedPLSystem.showNotification(`å½¹å“¡å ±é…¬è¨­å®šå®Œäº†ï¼ˆ6æœˆè³ä¸: ${bonus.toLocaleString()}ä¸‡å††ï¼‰`, 'success');
        }

        function saveCompensation() {
            const executiveSettings = {
                monthlyCompensation: [...unifiedPLSystem.executiveData.compensation],
                welfare: [...unifiedPLSystem.executiveData.welfare],
                lastUpdate: new Date().toISOString(),
                metadata: {
                    baseHigh: parseInt(document.getElementById('salary-high').value),
                    baseLow: parseInt(document.getElementById('salary-low').value),
                    bonusAmount: parseInt(document.getElementById('bonus-amount').value) || 0,
                    welfareRate: parseFloat(document.getElementById('welfare-rate').value) || 13,
                    version: "6.0_enhanced_system"
                }
            };
            
            localStorage.setItem('executive_compensation_csv_settings', JSON.stringify(executiveSettings));
            unifiedPLSystem.showNotification('å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            
            document.getElementById('compensation-status').textContent = `ä¿å­˜å®Œäº†: ${new Date().toLocaleString()}`;
        }

        function loadCompensation() {
            try {
                const saved = localStorage.getItem('executive_compensation_csv_settings');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    if (data.monthlyCompensation && data.welfare) {
                        unifiedPLSystem.executiveData.compensation = [...data.monthlyCompensation];
                        unifiedPLSystem.executiveData.welfare = [...data.welfare];
                        
                        if (data.metadata) {
                            document.getElementById('salary-high').value = data.metadata.baseHigh || 826;
                            document.getElementById('salary-low').value = data.metadata.baseLow || 676;
                            document.getElementById('bonus-amount').value = data.metadata.bonusAmount || 0;
                            document.getElementById('welfare-rate').value = data.metadata.welfareRate || 13;
                        }
                        
                        // å†è¨ˆç®—ãƒ»è¡¨ç¤ºæ›´æ–°
                        unifiedPLSystem.calculateFinalProfit();
                        unifiedPLSystem.updateAllDisplays();
                        
                        unifiedPLSystem.showNotification('å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                        document.getElementById('compensation-status').textContent = `èª­è¾¼å®Œäº†: ${new Date(data.lastUpdate).toLocaleString()}`;
                    }
                } else {
                    unifiedPLSystem.showNotification('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                }
            } catch (e) {
                console.error('Load error:', e);
                unifiedPLSystem.showNotification('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
            }
        }

        function testCompensation() {
            try {
                // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ
                const testResults = [];
                
                // 1. å ±é…¬ãƒ‡ãƒ¼ã‚¿ã®å¦¥å½“æ€§
                const totalComp = unifiedPLSystem.executiveData.compensation.reduce((s,v) => s + v, 0);
                const totalWelfare = unifiedPLSystem.executiveData.welfare.reduce((s,v) => s + v, 0);
                
                if (totalComp > 0) {
                    testResults.push('âœ“ å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿æ­£å¸¸');
                } else {
                    testResults.push('âœ— å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿ç•°å¸¸');
                }
                
                // 2. å–¶æ¥­åˆ©ç›Šã¸ã®å½±éŸ¿ç¢ºèª
                const profitTotal = unifiedPLSystem.monthlyOperatingProfit.reduce((s,v) => s + v, 0);
                if (Math.abs(profitTotal) < 100000) { // 10ä¸‡ä¸‡å††ä»¥ä¸‹
                    testResults.push('âœ“ å–¶æ¥­åˆ©ç›Šè¨ˆç®—æ­£å¸¸');
                } else {
                    testResults.push('âœ— å–¶æ¥­åˆ©ç›Šè¨ˆç®—ç•°å¸¸');
                }
                
                // 3. ä¿å­˜ãƒ»èª­è¾¼ãƒ†ã‚¹ãƒˆ
                saveCompensation();
                setTimeout(() => {
                    const saved = localStorage.getItem('executive_compensation_csv_settings');
                    if (saved) {
                        testResults.push('âœ“ ä¿å­˜ãƒ»èª­è¾¼æ©Ÿèƒ½æ­£å¸¸');
                    } else {
                        testResults.push('âœ— ä¿å­˜ãƒ»èª­è¾¼æ©Ÿèƒ½ç•°å¸¸');
                    }
                    
                    unifiedPLSystem.showNotification(`ãƒ†ã‚¹ãƒˆå®Œäº†: ${testResults.join(', ')}`, 'success');
                    document.getElementById('compensation-status').textContent = `ãƒ†ã‚¹ãƒˆçµæœ: ${testResults.length}é …ç›®ç¢ºèª`;
                }, 500);
                
            } catch (error) {
                unifiedPLSystem.showNotification('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        function refreshUnifiedData() {
            try {
                unifiedPLSystem.showNotification('çµ±åˆPLãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...', 'warning');
                unifiedPLSystem.loadAllDepartmentData();
                unifiedPLSystem.calculateUnifiedPL();
                unifiedPLSystem.updateAllDisplays();
                unifiedPLSystem.showNotification('çµ±åˆPLãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†', 'success');
            } catch (e) {
                console.error('Refresh error:', e);
                unifiedPLSystem.showNotification('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // å¼·åˆ¶æ›´æ–°ï¼ˆv6.4ï¼‰- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿
        function forceRefreshAllData() {
            try {
                unifiedPLSystem.showNotification('ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶æ›´æ–°ä¸­...', 'warning');
                console.log('=== å¼·åˆ¶æ›´æ–°é–‹å§‹ ===');
                
                // å…¨äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                unifiedPLSystem.loadAllDepartmentData();
                unifiedPLSystem.loadExecutiveData();
                unifiedPLSystem.calculateUnifiedPL();
                unifiedPLSystem.updateAllDisplays();
                
                console.log('=== å¼·åˆ¶æ›´æ–°å®Œäº† ===');
                unifiedPLSystem.showNotification('ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶æ›´æ–°å®Œäº†', 'success');
            } catch (e) {
                console.error('Force refresh error:', e);
                unifiedPLSystem.showNotification('å¼·åˆ¶æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
            }
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportUnifiedCSV() {
            try {
                const csvData = [];
                const months = ['é …ç›®å', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 'å¹´é–“åˆè¨ˆ'];
                csvData.push(months);

                // åŸºæœ¬PLé …ç›®
                csvData.push(['å£²ä¸Šé«˜', ...unifiedPLSystem.unifiedData.sales, unifiedPLSystem.unifiedData.sales.reduce((sum, val) => sum + val, 0)]);
                csvData.push(['å£²ä¸ŠåŸä¾¡', ...unifiedPLSystem.unifiedData.cogs, unifiedPLSystem.unifiedData.cogs.reduce((sum, val) => sum + val, 0)]);
                
                const grossProfitData = unifiedPLSystem.unifiedData.sales.map((sales, i) => sales - unifiedPLSystem.unifiedData.cogs[i]);
                csvData.push(['å£²ä¸Šç·åˆ©ç›Š', ...grossProfitData, grossProfitData.reduce((sum, val) => sum + val, 0)]);

                // è²©ç®¡è²»19é …ç›®
                for (let i = 1; i <= 19; i++) {
                    const expenseData = unifiedPLSystem.unifiedData.expenses[i];
                    const expenseName = unifiedPLSystem.EXPENSE_ITEMS[i];
                    const annual = expenseData.reduce((sum, val) => sum + val, 0);
                    csvData.push([expenseName, ...expenseData, annual]);
                }

                // å½¹å“¡å ±é…¬
                csvData.push(['å½¹å“¡å ±é…¬', ...unifiedPLSystem.executiveData.compensation, unifiedPLSystem.executiveData.compensation.reduce((sum, val) => sum + val, 0)]);
                csvData.push(['å½¹å“¡æ³•å®šç¦åˆ©è²»', ...unifiedPLSystem.executiveData.welfare, unifiedPLSystem.executiveData.welfare.reduce((sum, val) => sum + val, 0)]);

                // å…¨ç¤¾å…±é€šè²»
                Object.entries(unifiedPLSystem.commonExpenseData).forEach(([name, data]) => {
                    const annual = data.reduce((sum, val) => sum + val, 0);
                    csvData.push([name, ...data, annual]);
                });

                // è¨ˆç®—é …ç›®
                csvData.push(['è²©ç®¡è²»åˆè¨ˆ', ...unifiedPLSystem.monthlyTotalExpenses, unifiedPLSystem.monthlyTotalExpenses.reduce((sum, val) => sum + val, 0)]);
                csvData.push(['å–¶æ¥­åˆ©ç›Š', ...unifiedPLSystem.monthlyOperatingProfit, unifiedPLSystem.monthlyOperatingProfit.reduce((sum, val) => sum + val, 0)]);

                // CSVæ–‡å­—åˆ—ç”Ÿæˆ
                const csvString = '\uFEFF' + csvData.map(row => row.join(',')).join('\n');
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.0_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                unifiedPLSystem.showNotification('çµ±åˆPLãƒ‡ãƒ¼ã‚¿ã®CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                unifiedPLSystem.showNotification('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                console.error('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.4 åˆæœŸåŒ–é–‹å§‹');
            unifiedPLSystem = new UnifiedPLSystemV6();

            // å®šæœŸçš„ãªè‡ªå‹•æ›´æ–°ï¼ˆ10ç§’é–“éš”ã«çŸ­ç¸®ï¼‰
            setInterval(() => {
                try {
                    unifiedPLSystem.loadAllDepartmentData();
                    unifiedPLSystem.calculateUnifiedPL();
                    unifiedPLSystem.updateAllDisplays();
                } catch (e) {
                    console.error('Auto refresh error:', e);
                }
            }, 10000);

            // å¼·åˆ¶æ›´æ–°ãƒœã‚¿ãƒ³ã®è¿½åŠ ï¼ˆv6.4ï¼‰
            const forceRefreshButton = document.createElement('button');
            forceRefreshButton.textContent = 'ğŸ”„ å¼·åˆ¶æ›´æ–°';
            forceRefreshButton.className = 'action-button btn-refresh';
            forceRefreshButton.onclick = forceRefreshAllData;
            forceRefreshButton.style.position = 'fixed';
            forceRefreshButton.style.bottom = '120px';
            forceRefreshButton.style.right = '20px';
            forceRefreshButton.style.zIndex = '1000';
            document.body.appendChild(forceRefreshButton);

            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è¿½åŠ 
            const exportButton = document.createElement('button');
            exportButton.textContent = 'CSVä¸€æ‹¬ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
            exportButton.className = 'action-button btn-save';
            exportButton.onclick = exportUnifiedCSV;
            exportButton.style.position = 'fixed';
            exportButton.style.bottom = '20px';
            exportButton.style.right = '20px';
            exportButton.style.zIndex = '1000';
            document.body.appendChild(exportButton);

            // ç›®æ¨™åˆ©ç›Šé…åˆ†ãƒœã‚¿ãƒ³ã®è¿½åŠ 
            const targetButton = document.createElement('button');
            targetButton.textContent = 'ç›®æ¨™åˆ©ç›Šé…åˆ†';
            targetButton.className = 'action-button btn-apply';
            targetButton.onclick = () => showSection('target');
            targetButton.style.position = 'fixed';
            targetButton.style.bottom = '70px';
            targetButton.style.right = '20px';
            targetButton.style.zIndex = '1000';
            document.body.appendChild(targetButton);
        });
    </script>
</body>
</html>
