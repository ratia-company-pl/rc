<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ ï¼ˆè²©ç®¡è²»31é …ç›®å®Œå…¨å®Ÿè£…ç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header-row1 {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .main-title {
            font-size: 2.2em;
            font-weight: 800;
            margin: 0;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.1em;
            margin-top: 8px;
            opacity: 0.9;
        }

        .header-row2 {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            padding: 12px 20px;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 140px;
            text-align: center;
            cursor: pointer;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* KPIã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .header-row3 {
            background: #f8f9fa;
            padding: 20px;
        }

        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #e74c3c;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .kpi-card.positive {
            border-color: #27ae60;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
        }

        .kpi-card.negative {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #fdf2f2 0%, #fef5f5 100%);
        }

        .kpi-label {
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.6em;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .kpi-value.positive { color: #27ae60; }
        .kpi-value.negative { color: #e74c3c; }

        .kpi-detail {
            font-size: 0.75em;
            color: #95a5a6;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .header-row4 {
            background: #ecf0f1;
            padding: 15px 20px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .dept-status {
            padding: 8px 12px;
            border-radius: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 0.8em;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        /* é€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .header-row5 {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            padding: 12px 20px;
            color: white;
            text-align: center;
        }

        .dashboard-linkage-status {
            font-size: 0.9em;
            font-weight: 600;
        }

        .linkage-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.2);
            margin-left: 10px;
        }

        .linkage-indicator.active {
            background: rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.6em;
            font-weight: 800;
            margin-bottom: 20px;
            border-bottom: 4px solid #e74c3c;
            padding-bottom: 10px;
        }

        /* ãƒãƒ£ãƒ¼ãƒˆ */
        .chart-container {
            position: relative;
            height: 250px;
            margin: 25px 0;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
        }

        .admin-expense-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
            font-size: 0.85em;
            background: white;
        }

        .admin-expense-table th, 
        .admin-expense-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .admin-expense-table th {
            background: #34495e;
            color: white;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .category-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .item-name {
            text-align: left !important;
            font-weight: 600;
            background: #ecf0f1;
            padding-left: 15px !important;
            min-width: 200px;
        }

        .expense-row:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .annual-total {
            font-weight: bold;
            background: #f8f9fa;
        }

        .total-row {
            background: rgba(231, 76, 60, 0.15);
            font-weight: 800;
        }

        .grand-total {
            font-weight: bold;
            color: #e74c3c;
            background: #fff3cd;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-section {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-info { background: #3498db; color: white; }
        .btn-warning { background: #f39c12; color: white; }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* åŒæœŸã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .sync-indicator.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .init-message {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #856404;
            font-weight: 600;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .main-title { font-size: 1.8em; }
            .nav-buttons { flex-direction: column; }
            .kpi-section { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: 1fr; }
            .action-section { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="header">
            <!-- 1è¡Œç›®: ã‚¿ã‚¤ãƒˆãƒ« -->
            <div class="header-row1">
                <h1 class="main-title">4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ </h1>
                <p class="subtitle">è²©ç®¡è²»31é …ç›®å®Œå…¨å®Ÿè£…ç‰ˆãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿é€£æºå¯¾å¿œ</p>
            </div>

            <!-- 2è¡Œç›®: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="header-row2">
                <div class="nav-buttons">
                    <a href="#" class="btn" onclick="showPage('dashboard'); return false;">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                    <a href="#" class="btn" onclick="showPage('budget'); return false;">äºˆç®—å…¥åŠ›</a>
                    <a href="#" class="btn" onclick="showPage('sr'); return false;">SRäº‹æ¥­éƒ¨</a>
                    <a href="#" class="btn" onclick="showPage('w'); return false;">Wäº‹æ¥­éƒ¨</a>
                    <a href="#" class="btn" onclick="showPage('rc'); return false;">RCå¸äº‹æ¥­éƒ¨</a>
                    <a href="#" class="btn" onclick="showPage('rcd'); return false;">RCDç¤¾äº‹æ¥­éƒ¨</a>
                </div>
            </div>

            <!-- 3è¡Œç›®: KPIè¡¨ç¤º -->
            <div class="header-row3">
                <div class="kpi-section">
                    <div class="kpi-card" id="total-sales-card">
                        <div class="kpi-label">çµ±åˆå¹´é–“å£²ä¸Š</div>
                        <div class="kpi-value" id="total-sales">---ä¸‡å††</div>
                        <div class="kpi-detail">4äº‹æ¥­éƒ¨åˆè¨ˆ</div>
                    </div>
                    <div class="kpi-card" id="total-profit-card">
                        <div class="kpi-label">çµ±åˆå–¶æ¥­åˆ©ç›Š</div>
                        <div class="kpi-value" id="total-profit">---ä¸‡å††</div>
                        <div class="kpi-detail">è²©ç®¡è²»31é …ç›®æ§é™¤å¾Œ</div>
                    </div>
                    <div class="kpi-card" id="profit-rate-card">
                        <div class="kpi-label">çµ±åˆåˆ©ç›Šç‡</div>
                        <div class="kpi-value" id="profit-rate">---%</div>
                        <div class="kpi-detail">å‰å¹´æ¯”è¼ƒå¯¾å¿œ</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">ãƒ‡ãƒ¼ã‚¿çµ±åˆçŠ¶æ³</div>
                        <div class="kpi-value" id="integration-count">-/4</div>
                        <div class="kpi-detail">äº‹æ¥­éƒ¨é€£æºå®Œäº†</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">è²©ç®¡è²»é …ç›®æ•°</div>
                        <div class="kpi-value" id="expense-items">31/31</div>
                        <div class="kpi-detail">é …ç›®è¡¨ç¤ºå®Œäº†</div>
                    </div>
                </div>
            </div>

            <!-- 4è¡Œç›®: å„äº‹æ¥­éƒ¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="header-row4">
                <div class="status-grid">
                    <div id="sr-status" class="dept-status status-warning">SRäº‹æ¥­éƒ¨: å¾…æ©Ÿä¸­</div>
                    <div id="w-status" class="dept-status status-warning">Wäº‹æ¥­éƒ¨: å¾…æ©Ÿä¸­</div>
                    <div id="rc-status" class="dept-status status-warning">RCå¸: å¾…æ©Ÿä¸­</div>
                    <div id="rcd-status" class="dept-status status-warning">RCDç¤¾: å¾…æ©Ÿä¸­</div>
                </div>
            </div>

            <!-- 5è¡Œç›®: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="header-row5">
                <div class="dashboard-linkage-status">
                    <span>ğŸ”„ è‡ªå‹•åŒæœŸã‚·ã‚¹ãƒ†ãƒ :</span>
                    <span class="linkage-indicator" id="sync-status">åœæ­¢ä¸­</span>
                    <span id="last-sync">æœ€çµ‚åŒæœŸ: --:--</span>
                </div>
            </div>
        </header>

        <!-- ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="init-message" id="init-message">
            âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ã€Œãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="main-content">
            <h2 class="section-title">è²©ç®¡è²»31é …ç›® è©³ç´°è¡¨ç¤ºï¼ˆæœˆæ¬¡æ¨ç§»ï¼‰</h2>
            
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="action-section">
                <button class="action-btn btn-success" onclick="generateTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
                <button class="action-btn btn-primary" onclick="startAutoSync()">è‡ªå‹•åŒæœŸé–‹å§‹</button>
                <button class="action-btn btn-warning" onclick="stopAutoSync()">è‡ªå‹•åŒæœŸåœæ­¢</button>
                <button class="action-btn btn-info" onclick="manualRefresh()">æ‰‹å‹•æ›´æ–°</button>
                <button class="action-btn btn-info" onclick="exportToCSV()">CSVå‡ºåŠ›</button>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º -->
            <div class="chart-container">
                <canvas id="expenseChart"></canvas>
            </div>

            <!-- è²©ç®¡è²»31é …ç›®ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="table-container" id="expense-table-container">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>
        </main>
    </div>

    <!-- åŒæœŸã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ -->
    <div class="sync-indicator" id="sync-indicator">
        ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...
    </div>

    <script>
        // ===== ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç† =====
        const DataStorage = {
            keys: {
                sr: 'pl_system_sr_data',
                w: 'pl_system_w_data',
                rc: 'pl_system_rc_data',
                rcd: 'pl_system_rcd_data',
                dashboard: 'dashboard_data',
                executive: 'executive_compensation_csv_settings'
            },
            
            get: function(key) {
                try {
                    const data = sessionStorage.getItem(this.keys[key]);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error(`ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼(${key}):`, error);
                    return null;
                }
            },
            
            set: function(key, data) {
                try {
                    sessionStorage.setItem(this.keys[key], JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error(`ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼(${key}):`, error);
                    return false;
                }
            },
            
            hasData: function() {
                return ['sr', 'w', 'rc', 'rcd'].some(key => this.get(key) !== null);
            }
        };

        // ===== è²©ç®¡è²»31é …ç›®å®šç¾© =====
        const ADMIN_EXPENSE_ITEMS = {
            // äººä»¶è²»é–¢é€£ï¼ˆ4é …ç›®ï¼‰
            personnel: { id: 1, name: 'äººä»¶è²»çµ±åˆ', category: 'personnel' },
            welfare: { id: 2, name: 'æ³•å®šç¦åˆ©è²»', category: 'personnel' },
            executiveComp: { id: 3, name: 'å½¹å“¡å ±é…¬', category: 'personnel' },
            retirement: { id: 17, name: 'é€€è·é‡‘', category: 'personnel' },
            
            // ç‰©æµãƒ»æ–½è¨­è²»ï¼ˆ5é …ç›®ï¼‰
            logistics: { id: 4, name: 'ç‰©æµç®¡ç†è²»', category: 'facility' },
            rent: { id: 5, name: 'åœ°ä»£å®¶è³ƒ', category: 'facility' },
            outsourcing: { id: 6, name: 'å¤–æ³¨è²»', category: 'facility' },
            freight: { id: 7, name: 'è²¨ç‰©é‹è³ƒ', category: 'facility' },
            lease: { id: 19, name: 'ãƒªãƒ¼ã‚¹æ–™', category: 'facility' },
            
            // å–¶æ¥­ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°è²»ï¼ˆ5é …ç›®ï¼‰
            advertising: { id: 8, name: 'åºƒå‘Šå®£ä¼è²»', category: 'marketing' },
            travel: { id: 9, name: 'æ—…è²»äº¤é€šè²»', category: 'marketing' },
            communication: { id: 10, name: 'é€šä¿¡è²»', category: 'marketing' },
            promotion: { id: 11, name: 'è²©å£²ä¿ƒé€²è²»', category: 'marketing' },
            consulting: { id: 25, name: 'æ”¯æ‰•å ±é…¬æ–™', category: 'marketing' },
            
            // é‹å–¶è²»ï¼ˆ8é …ç›®ï¼‰
            consumables: { id: 12, name: 'æ¶ˆè€—å“è²»', category: 'operation' },
            office: { id: 13, name: 'äº‹å‹™ç”¨å“è²»', category: 'operation' },
            utilities: { id: 14, name: 'æ°´é“å…‰ç†±è²»', category: 'operation' },
            fees: { id: 15, name: 'æ”¯æ‰•æ‰‹æ•°æ–™', category: 'operation' },
            hygiene: { id: 16, name: 'è¡›ç”Ÿè²»', category: 'operation' },
            insurance: { id: 20, name: 'ä¿é™ºæ–™', category: 'operation' },
            entertainment: { id: 21, name: 'æ¥å¾…äº¤éš›è²»', category: 'operation' },
            miscExpenses: { id: 31, name: 'ãã®ä»–çµŒè²»', category: 'operation' },
            
            // ãã®ä»–è²»ç”¨ï¼ˆ9é …ç›®ï¼‰
            meetings: { id: 22, name: 'ä¼šè­°è²»', category: 'other' },
            training: { id: 23, name: 'ç ”ä¿®è²»', category: 'other' },
            recruitment: { id: 24, name: 'æ¡ç”¨è²»', category: 'other' },
            depreciation: { id: 26, name: 'æ¸›ä¾¡å„Ÿå´è²»', category: 'other' },
            taxes: { id: 27, name: 'ç§Ÿç¨å…¬èª²', category: 'other' },
            dues: { id: 28, name: 'è«¸ä¼šè²»', category: 'other' },
            samples: { id: 29, name: 'è¦‹æœ¬è²»', category: 'other' },
            badDebt: { id: 30, name: 'è²¸å€’å¼•å½“é‡‘', category: 'other' },
            exhibition: { id: 18, name: 'å±•ç¤ºä¼šè²»ç”¨', category: 'other' }
        };

        // ===== ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ =====
        function generateTestData() {
            const testData = {
                sr: {
                    sales: [1000, 1100, 1200, 1050, 1150, 1250, 1300, 1350, 1400, 1450, 1500, 1550],
                    cogs: [600, 660, 720, 630, 690, 750, 780, 810, 840, 870, 900, 930],
                    personnel: [100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100],
                    welfare: [15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15],
                    logistics: [50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50, 50],
                    rent: [30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30],
                    outsourcing: [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20],
                    freight: [15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15],
                    advertising: [25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25],
                    promotion: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10],
                    utilities: [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5],
                    fees: [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
                    othersFixed: [40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40]
                },
                w: {
                    sales: [800, 850, 900, 820, 860, 920, 950, 980, 1000, 1020, 1050, 1080],
                    cogs: [480, 510, 540, 492, 516, 552, 570, 588, 600, 612, 630, 648],
                    personnel: [80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80],
                    welfare: [12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12],
                    rent: [25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25, 25],
                    advertising: [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20],
                    fees: [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5],
                    othersFixed: [30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30]
                },
                rc: {
                    sales: [500, 520, 540, 510, 530, 550, 570, 590, 610, 630, 650, 670],
                    cogs: [300, 312, 324, 306, 318, 330, 342, 354, 366, 378, 390, 402],
                    personnel: [60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60],
                    expenses: [250, 250, 250, 250, 250, 350, 250, 250, 250, 250, 250, 350]
                },
                rcd: {
                    sales: [300, 310, 320, 305, 315, 325, 330, 340, 350, 360, 370, 380],
                    cogs: [180, 186, 192, 183, 189, 195, 198, 204, 210, 216, 222, 228],
                    personnel: [40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40],
                    welfare: [6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6],
                    expenses: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]
                }
            };

            // å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿
            const executiveData = {
                monthlyCompensation: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676]
            };

            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            DataStorage.set('sr', testData.sr);
            DataStorage.set('w', testData.w);
            DataStorage.set('rc', testData.rc);
            DataStorage.set('rcd', testData.rcd);
            DataStorage.set('executive', executiveData);

            // åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            document.getElementById('init-message').style.display = 'none';
            
            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            generateExpenseTable();
            
            alert('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚');
        }

        // ===== ãƒ‡ãƒ¼ã‚¿åé›†ãƒ»çµ±åˆå‡¦ç† =====
        function collectDepartmentData() {
            const integratedExpenses = {};
            
            // 31é …ç›®ã‚’åˆæœŸåŒ–
            Object.keys(ADMIN_EXPENSE_ITEMS).forEach(key => {
                integratedExpenses[key] = new Array(12).fill(0);
            });
            
            let activeCount = 0;
            
            // SRäº‹æ¥­éƒ¨
            const srData = DataStorage.get('sr');
            if (srData) {
                activeCount++;
                updateDeptStatus('sr', 'success', 'ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆ');
                
                if (srData.personnel) addToExpenses(integratedExpenses, 'personnel', srData.personnel);
                if (srData.welfare) addToExpenses(integratedExpenses, 'welfare', srData.welfare);
                if (srData.logistics) addToExpenses(integratedExpenses, 'logistics', srData.logistics);
                if (srData.rent) addToExpenses(integratedExpenses, 'rent', srData.rent);
                if (srData.outsourcing) addToExpenses(integratedExpenses, 'outsourcing', srData.outsourcing);
                if (srData.freight) addToExpenses(integratedExpenses, 'freight', srData.freight);
                if (srData.advertising) addToExpenses(integratedExpenses, 'advertising', srData.advertising);
                if (srData.promotion) addToExpenses(integratedExpenses, 'promotion', srData.promotion);
                if (srData.utilities) addToExpenses(integratedExpenses, 'utilities', srData.utilities);
                if (srData.fees) addToExpenses(integratedExpenses, 'fees', srData.fees);
                if (srData.othersFixed) distributeOthersFixed(integratedExpenses, srData.othersFixed);
            } else {
                updateDeptStatus('sr', 'warning', 'ãƒ‡ãƒ¼ã‚¿ãªã—');
            }
            
            // Wäº‹æ¥­éƒ¨
            const wData = DataStorage.get('w');
            if (wData) {
                activeCount++;
                updateDeptStatus('w', 'success', 'ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆ');
                
                if (wData.personnel) addToExpenses(integratedExpenses, 'personnel', wData.personnel);
                if (wData.welfare) addToExpenses(integratedExpenses, 'welfare', wData.welfare);
                if (wData.rent) addToExpenses(integratedExpenses, 'rent', wData.rent);
                if (wData.advertising) addToExpenses(integratedExpenses, 'advertising', wData.advertising);
                if (wData.fees) addToExpenses(integratedExpenses, 'fees', wData.fees);
                if (wData.othersFixed) distributeOthersFixed(integratedExpenses, wData.othersFixed);
            } else {
                updateDeptStatus('w', 'warning', 'ãƒ‡ãƒ¼ã‚¿ãªã—');
            }
            
            // RCå¸äº‹æ¥­éƒ¨
            const rcData = DataStorage.get('rc');
            if (rcData) {
                activeCount++;
                updateDeptStatus('rc', 'success', 'ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆ');
                
                if (rcData.personnel) addToExpenses(integratedExpenses, 'personnel', rcData.personnel);
                if (rcData.expenses && Array.isArray(rcData.expenses)) {
                    rcData.expenses.forEach((expense, i) => {
                        distributeRCExpenses(integratedExpenses, expense, i);
                    });
                }
            } else {
                updateDeptStatus('rc', 'warning', 'ãƒ‡ãƒ¼ã‚¿ãªã—');
            }
            
            // RCDç¤¾äº‹æ¥­éƒ¨
            const rcdData = DataStorage.get('rcd');
            if (rcdData) {
                activeCount++;
                updateDeptStatus('rcd', 'success', 'ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆ');
                
                if (rcdData.personnel) addToExpenses(integratedExpenses, 'personnel', rcdData.personnel);
                if (rcdData.welfare) addToExpenses(integratedExpenses, 'welfare', rcdData.welfare);
                if (rcdData.expenses && Array.isArray(rcdData.expenses)) {
                    rcdData.expenses.forEach((expense, i) => {
                        integratedExpenses.fees[i] += expense;
                    });
                }
            } else {
                updateDeptStatus('rcd', 'warning', 'ãƒ‡ãƒ¼ã‚¿ãªã—');
            }
            
            // å½¹å“¡å ±é…¬ã®è¿½åŠ 
            addExecutiveCompensation(integratedExpenses);
            
            // çµ±åˆçŠ¶æ³æ›´æ–°
            document.getElementById('integration-count').textContent = `${activeCount}/4`;
            
            return integratedExpenses;
        }

        function distributeOthersFixed(expenses, othersFixedArray) {
            const distribution = {
                hygiene: 0.12,
                travel: 0.23,
                communication: 0.14,
                consumables: 0.03,
                office: 0.08,
                lease: 0.01,
                insurance: 0.04,
                consulting: 0.25,
                depreciation: 0.10
            };
            
            othersFixedArray.forEach((amount, i) => {
                Object.keys(distribution).forEach(key => {
                    if (expenses[key]) {
                        expenses[key][i] += Math.round(amount * distribution[key]);
                    }
                });
            });
        }

        function distributeRCExpenses(expenses, monthlyExpense, monthIndex) {
            expenses.welfare[monthIndex] += 6;
            expenses.fees[monthIndex] += 70;
            expenses.travel[monthIndex] += 15;
            expenses.advertising[monthIndex] += 40;
            expenses.promotion[monthIndex] += 10;
            expenses.logistics[monthIndex] += 67;
            expenses.communication[monthIndex] += 1;
            expenses.office[monthIndex] += 10;
            expenses.utilities[monthIndex] += 2;
            expenses.insurance[monthIndex] += 1;
            expenses.consulting[monthIndex] += 10;
            expenses.depreciation[monthIndex] += 7;
            
            // å±•ç¤ºä¼šè²»ç”¨ï¼ˆ5æœˆãƒ»12æœˆï¼‰
            if (monthIndex === 10 || monthIndex === 5) {
                expenses.exhibition[monthIndex] += 90;
            }
        }

        function addExecutiveCompensation(expenses) {
            const executiveData = DataStorage.get('executive');
            if (executiveData && executiveData.monthlyCompensation) {
                expenses.executiveComp = executiveData.monthlyCompensation;
                // å½¹å“¡å ±é…¬åˆ†ã®æ³•å®šç¦åˆ©è²»ã‚‚è¿½åŠ 
                executiveData.monthlyCompensation.forEach((comp, i) => {
                    expenses.welfare[i] += Math.round(comp * 0.13);
                });
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                expenses.executiveComp = [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676];
                expenses.executiveComp.forEach((comp, i) => {
                    expenses.welfare[i] += Math.round(comp * 0.13);
                });
            }
        }

        function addToExpenses(expenses, key, dataArray) {
            if (expenses[key] && Array.isArray(dataArray)) {
                dataArray.forEach((val, i) => {
                    expenses[key][i] += (val || 0);
                });
            }
        }

        // ===== ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ =====
        function generateExpenseTable() {
            if (!DataStorage.hasData()) {
                document.getElementById('expense-table-container').innerHTML = 
                    '<p style="text-align: center; color: #856404;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }
            
            const expenses = collectDepartmentData();
            const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            
            let html = `
                <table class="admin-expense-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th style="width: 200px;">è²©ç®¡è²»é …ç›®</th>
                            ${months.map(m => `<th>${m}</th>`).join('')}
                            <th style="width: 100px;">å¹´é–“è¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const categories = {
                personnel: 'äººä»¶è²»é–¢é€£',
                facility: 'ç‰©æµãƒ»æ–½è¨­è²»',
                marketing: 'å–¶æ¥­ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°è²»',
                operation: 'é‹å–¶è²»',
                other: 'ãã®ä»–è²»ç”¨'
            };
            
            let grandTotal = 0;
            const monthlyTotals = new Array(12).fill(0);
            
            Object.entries(categories).forEach(([catKey, catName]) => {
                // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼
                html += `
                    <tr class="category-header">
                        <td colspan="15">${catName}</td>
                    </tr>
                `;
                
                // é …ç›®è¡¨ç¤º
                Object.entries(ADMIN_EXPENSE_ITEMS)
                    .filter(([_, item]) => item.category === catKey)
                    .sort((a, b) => a[1].id - b[1].id)
                    .forEach(([key, item]) => {
                        const monthlyData = expenses[key] || new Array(12).fill(0);
                        const annual = monthlyData.reduce((sum, val) => sum + val, 0);
                        grandTotal += annual;
                        
                        monthlyData.forEach((val, i) => {
                            monthlyTotals[i] += val;
                        });
                        
                        html += `
                            <tr class="expense-row">
                                <td>${item.id}</td>
                                <td class="item-name">${item.name}</td>
                                ${monthlyData.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                                <td class="annual-total">${formatNumber(annual)}</td>
                            </tr>
                        `;
                    });
            });
            
            // åˆè¨ˆè¡Œ
            html += `
                    <tr class="total-row">
                        <td>-</td>
                        <td class="item-name">è²©ç®¡è²»åˆè¨ˆ</td>
                        ${monthlyTotals.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                        <td class="grand-total">${formatNumber(grandTotal)}</td>
                    </tr>
                </tbody>
            </table>
            `;
            
            document.getElementById('expense-table-container').innerHTML = html;
            
            // KPIæ›´æ–°
            updateKPIs(grandTotal);
            
            // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            updateExpenseChart(monthlyTotals);
        }

        // ===== KPIæ›´æ–° =====
        function updateKPIs(totalExpenses) {
            // å£²ä¸Šãƒ‡ãƒ¼ã‚¿åé›†
            let totalSales = 0;
            let totalCOGS = 0;
            
            ['sr', 'w', 'rc', 'rcd'].forEach(dept => {
                const data = DataStorage.get(dept);
                if (data) {
                    if (data.sales && Array.isArray(data.sales)) {
                        totalSales += data.sales.reduce((sum, val) => sum + val, 0);
                    }
                    if (data.cogs && Array.isArray(data.cogs)) {
                        totalCOGS += data.cogs.reduce((sum, val) => sum + val, 0);
                    }
                }
            });
            
            const grossProfit = totalSales - totalCOGS;
            const operatingProfit = grossProfit - totalExpenses;
            const profitRate = totalSales > 0 ? (operatingProfit / totalSales * 100).toFixed(1) : '0.0';
            
            // KPIè¡¨ç¤ºæ›´æ–°
            document.getElementById('total-sales').textContent = formatNumber(totalSales) + 'ä¸‡å††';
            document.getElementById('total-profit').textContent = formatNumber(operatingProfit) + 'ä¸‡å††';
            document.getElementById('profit-rate').textContent = profitRate + '%';
            
            // è‰²åˆ†ã‘
            const profitCard = document.getElementById('total-profit-card');
            const rateCard = document.getElementById('profit-rate-card');
            
            if (operatingProfit >= 0) {
                profitCard.className = 'kpi-card positive';
                rateCard.className = 'kpi-card positive';
                document.getElementById('total-profit').className = 'kpi-value positive';
                document.getElementById('profit-rate').className = 'kpi-value positive';
            } else {
                profitCard.className = 'kpi-card negative';
                rateCard.className = 'kpi-card negative';
                document.getElementById('total-profit').className = 'kpi-value negative';
                document.getElementById('profit-rate').className = 'kpi-value negative';
            }
        }

        // ===== ãƒãƒ£ãƒ¼ãƒˆæ›´æ–° =====
        let expenseChart = null;
        
        function updateExpenseChart(monthlyTotals) {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            
            expenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'è²©ç®¡è²»åˆè¨ˆ',
                        data: monthlyTotals,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: '#e74c3c',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'è²©ç®¡è²»: ' + formatNumber(context.parsed.y) + 'ä¸‡å††';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'é‡‘é¡ï¼ˆä¸‡å††ï¼‰'
                            }
                        }
                    }
                }
            });
        }

        // ===== è‡ªå‹•åŒæœŸã‚·ã‚¹ãƒ†ãƒ  =====
        const AUTO_SYNC = {
            timer: null,
            interval: 5000,
            isActive: false,
            
            start: function() {
                if (this.isActive) return;
                
                this.isActive = true;
                this.timer = setInterval(() => {
                    this.sync();
                }, this.interval);
                
                document.getElementById('sync-status').textContent = 'ç¨¼åƒä¸­';
                document.getElementById('sync-status').className = 'linkage-indicator active';
                
                this.sync(); // å³åº§ã«å®Ÿè¡Œ
            },
            
            stop: function() {
                if (!this.isActive) return;
                
                this.isActive = false;
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                
                document.getElementById('sync-status').textContent = 'åœæ­¢ä¸­';
                document.getElementById('sync-status').className = 'linkage-indicator';
            },
            
            sync: function() {
                const indicator = document.getElementById('sync-indicator');
                indicator.className = 'sync-indicator active';
                
                // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                generateExpenseTable();
                
                // æœ€çµ‚åŒæœŸæ™‚åˆ»æ›´æ–°
                const now = new Date();
                document.getElementById('last-sync').textContent = 
                    `æœ€çµ‚åŒæœŸ: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                setTimeout(() => {
                    indicator.className = 'sync-indicator';
                }, 1000);
            }
        };

        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        function formatNumber(num) {
            if (isNaN(num) || num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString();
        }

        function updateDeptStatus(dept, status, message) {
            const statusElement = document.getElementById(`${dept}-status`);
            if (statusElement) {
                statusElement.className = `dept-status status-${status}`;
                const deptNames = {
                    sr: 'SRäº‹æ¥­éƒ¨',
                    w: 'Wäº‹æ¥­éƒ¨',
                    rc: 'RCå¸',
                    rcd: 'RCDç¤¾'
                };
                statusElement.textContent = `${deptNames[dept]}: ${message}`;
            }
        }

        // ===== ãƒšãƒ¼ã‚¸åˆ‡æ›¿ =====
        function showPage(page) {
            const pageUrls = {
                dashboard: 'index.html',
                budget: 'budget-input.html',
                sr: 'sr-pl.html',
                w: 'w-pl.html',
                rc: 'rc-pl.html',
                rcd: 'rcd-pl.html'
            };
            
            // å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯é·ç§»
            if (pageUrls[page]) {
                // window.location.href = pageUrls[page];
                alert(`${page}ãƒšãƒ¼ã‚¸ã¸é·ç§»: ${pageUrls[page]}`);
            } else {
                alert(`${page}ãƒšãƒ¼ã‚¸ã¯æº–å‚™ä¸­ã§ã™`);
            }
        }

        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•° =====
        function startAutoSync() {
            if (!DataStorage.hasData()) {
                alert('å…ˆã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            AUTO_SYNC.start();
            alert('è‡ªå‹•åŒæœŸã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆ5ç§’é–“éš”ï¼‰');
        }

        function stopAutoSync() {
            AUTO_SYNC.stop();
            alert('è‡ªå‹•åŒæœŸã‚’åœæ­¢ã—ã¾ã—ãŸ');
        }

        function manualRefresh() {
            if (!DataStorage.hasData()) {
                alert('å…ˆã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            generateExpenseTable();
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•æ›´æ–°ã—ã¾ã—ãŸ');
        }

        function exportToCSV() {
            if (!DataStorage.hasData()) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const expenses = collectDepartmentData();
            const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            
            let csv = 'è²©ç®¡è²»31é …ç›®è©³ç´°,';
            csv += months.join(',') + ',å¹´é–“è¨ˆ\n';
            
            Object.entries(ADMIN_EXPENSE_ITEMS)
                .sort((a, b) => a[1].id - b[1].id)
                .forEach(([key, item]) => {
                    const monthlyData = expenses[key] || new Array(12).fill(0);
                    const annual = monthlyData.reduce((sum, val) => sum + val, 0);
                    csv += `"${item.id}.${item.name}",`;
                    csv += monthlyData.join(',') + ',' + annual + '\n';
                });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è²©ç®¡è²»31é …ç›®_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        // ===== åˆæœŸåŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ  è²©ç®¡è²»31é …ç›®å®Œå…¨å®Ÿè£…ç‰ˆ èµ·å‹•');
            
            // ãƒ‡ãƒ¼ã‚¿æœ‰ç„¡ãƒã‚§ãƒƒã‚¯
            if (!DataStorage.hasData()) {
                document.getElementById('init-message').style.display = 'block';
            } else {
                document.getElementById('init-message').style.display = 'none';
                // åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                generateExpenseTable();
            }
        });
    </script>
</body>
</html>
