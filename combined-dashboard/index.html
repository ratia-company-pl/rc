<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4事業部統合PLシステム（販管費31項目完全実装版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ヘッダー */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header-row1 {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .main-title {
            font-size: 2.2em;
            font-weight: 800;
            margin: 0;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.1em;
            margin-top: 8px;
            opacity: 0.9;
        }

        .header-row2 {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            padding: 12px 20px;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 140px;
            text-align: center;
            cursor: pointer;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* KPIセクション */
        .header-row3 {
            background: #f8f9fa;
            padding: 20px;
        }

        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #e74c3c;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .kpi-card.positive {
            border-color: #27ae60;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
        }

        .kpi-card.negative {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #fdf2f2 0%, #fef5f5 100%);
        }

        .kpi-label {
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.6em;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .kpi-value.positive { color: #27ae60; }
        .kpi-value.negative { color: #e74c3c; }

        .kpi-detail {
            font-size: 0.75em;
            color: #95a5a6;
        }

        /* ステータス表示 */
        .header-row4 {
            background: #ecf0f1;
            padding: 15px 20px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .dept-status {
            padding: 8px 12px;
            border-radius: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 0.8em;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        /* 連携ステータス */
        .header-row5 {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            padding: 12px 20px;
            color: white;
            text-align: center;
        }

        .dashboard-linkage-status {
            font-size: 0.9em;
            font-weight: 600;
        }

        .linkage-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.2);
            margin-left: 10px;
        }

        .linkage-indicator.active {
            background: rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* メインコンテンツ */
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.6em;
            font-weight: 800;
            margin-bottom: 20px;
            border-bottom: 4px solid #e74c3c;
            padding-bottom: 10px;
        }

        /* チャート */
        .chart-container {
            position: relative;
            height: 250px;
            margin: 25px 0;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        /* テーブル共通スタイル */
        .table-container {
            overflow-x: auto;
            margin-top: 25px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
            font-size: 0.85em;
            background: white;
        }

        .data-table th, 
        .data-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .data-table th {
            background: #34495e;
            color: white;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .category-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .item-name {
            text-align: left !important;
            font-weight: 600;
            background: #ecf0f1;
            padding-left: 15px !important;
            min-width: 200px;
        }

        .data-row:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .annual-total {
            font-weight: bold;
            background: #f8f9fa;
        }

        .total-row {
            background: rgba(231, 76, 60, 0.15);
            font-weight: 800;
        }

        .grand-total {
            font-weight: bold;
            color: #e74c3c;
            background: #fff3cd;
        }

        /* 売上・仕入・粗利テーブル専用 */
        .sales-header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .cogs-header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .profit-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        /* アクションボタン */
        .action-section {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-info { background: #3498db; color: white; }
        .btn-warning { background: #f39c12; color: white; }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* 同期インジケータ */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .sync-indicator.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* データ初期化メッセージ */
        .init-message {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #856404;
            font-weight: 600;
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .main-title { font-size: 1.8em; }
            .nav-buttons { flex-direction: column; }
            .kpi-section { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: 1fr; }
            .action-section { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="header">
            <!-- 1行目: タイトル -->
            <div class="header-row1">
                <h1 class="main-title">4事業部統合PLシステム</h1>
                <p class="subtitle">販管費31項目完全実装版・リアルタイムデータ連携対応</p>
            </div>

            <!-- 2行目: ナビゲーション -->
            <div class="header-row2">
                <div class="nav-buttons">
                    <a href="#" class="btn" onclick="showPage('dashboard'); return false;">ダッシュボード</a>
                    <a href="#" class="btn" onclick="showPage('budget'); return false;">予算入力</a>
                    <a href="#" class="btn" onclick="showPage('sr'); return false;">SR事業部</a>
                    <a href="#" class="btn" onclick="showPage('w'); return false;">W事業部</a>
                    <a href="#" class="btn" onclick="showPage('rc'); return false;">RC卸事業部</a>
                    <a href="#" class="btn" onclick="showPage('rcd'); return false;">RCD社事業部</a>
                </div>
            </div>

            <!-- 3行目: KPI表示 -->
            <div class="header-row3">
                <div class="kpi-section">
                    <div class="kpi-card" id="total-sales-card">
                        <div class="kpi-label">統合年間売上</div>
                        <div class="kpi-value" id="total-sales">---万円</div>
                        <div class="kpi-detail">4事業部合計</div>
                    </div>
                    <div class="kpi-card" id="total-profit-card">
                        <div class="kpi-label">統合営業利益</div>
                        <div class="kpi-value" id="total-profit">---万円</div>
                        <div class="kpi-detail">販管費31項目控除後</div>
                    </div>
                    <div class="kpi-card" id="profit-rate-card">
                        <div class="kpi-label">統合利益率</div>
                        <div class="kpi-value" id="profit-rate">---%</div>
                        <div class="kpi-detail">対売上高比率</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">データ統合状況</div>
                        <div class="kpi-value" id="integration-count">-/4</div>
                        <div class="kpi-detail">事業部連携完了</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">販管費項目数</div>
                        <div class="kpi-value" id="expense-items">31/31</div>
                        <div class="kpi-detail">項目表示完了</div>
                    </div>
                </div>
            </div>

            <!-- 4行目: 各事業部ステータス -->
            <div class="header-row4">
                <div class="status-grid">
                    <div id="sr-status" class="dept-status status-warning">SR事業部: 待機中</div>
                    <div id="w-status" class="dept-status status-warning">W事業部: 待機中</div>
                    <div id="rc-status" class="dept-status status-warning">RC卸: 待機中</div>
                    <div id="rcd-status" class="dept-status status-warning">RCD社: 待機中</div>
                </div>
            </div>

            <!-- 5行目: ダッシュボード連携ステータス -->
            <div class="header-row5">
                <div class="dashboard-linkage-status">
                    <span>🔄 自動同期システム:</span>
                    <span class="linkage-indicator" id="sync-status">停止中</span>
                    <span id="last-sync">最終同期: --:--</span>
                </div>
            </div>
        </header>

        <!-- データ初期化メッセージ -->
        <div class="init-message" id="init-message">
            ⚠️ データが存在しません。「テストデータ生成」ボタンをクリックしてください。
        </div>

        <!-- メインコンテンツ -->
        <main class="main-content">
            <!-- アクションボタン -->
            <div class="action-section">
                <button class="action-btn btn-success" onclick="generateTestData()">テストデータ生成</button>
                <button class="action-btn btn-primary" onclick="startAutoSync()">自動同期開始</button>
                <button class="action-btn btn-warning" onclick="stopAutoSync()">自動同期停止</button>
                <button class="action-btn btn-info" onclick="manualRefresh()">手動更新</button>
                <button class="action-btn btn-info" onclick="exportToCSV()">CSV出力</button>
            </div>

            <!-- チャート表示 -->
            <div class="chart-container">
                <canvas id="expenseChart"></canvas>
            </div>

            <!-- 売上・仕入・粗利テーブル -->
            <h2 class="section-title">売上・仕入・粗利推移</h2>
            <div class="table-container" id="sales-table-container">
                <!-- JavaScriptで動的生成 -->
            </div>

            <!-- 販管費31項目テーブル -->
            <h2 class="section-title" style="margin-top: 40px;">販管費31項目 詳細表示（月次推移）</h2>
            <div class="table-container" id="expense-table-container">
                <!-- JavaScriptで動的生成 -->
            </div>
        </main>
    </div>

    <!-- 同期インジケータ -->
    <div class="sync-indicator" id="sync-indicator">
        🔄 データ同期中...
    </div>

    <script>
        // ===== データストレージ管理 =====
        const DataStorage = {
            keys: {
                sr: 'pl_system_sr_data',
                w: 'pl_system_w_data',
                rc: 'pl_system_rc_data',
                rcd: 'pl_system_rcd_data',
                dashboard: 'dashboard_data',
                executive: 'executive_compensation_csv_settings'
            },
            
            get: function(key) {
                try {
                    const data = sessionStorage.getItem(this.keys[key]);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error(`データ取得エラー(${key}):`, error);
                    return null;
                }
            },
            
            set: function(key, data) {
                try {
                    sessionStorage.setItem(this.keys[key], JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error(`データ保存エラー(${key}):`, error);
                    return false;
                }
            },
            
            hasData: function() {
                return ['sr', 'w', 'rc', 'rcd'].some(key => this.get(key) !== null);
            }
        };

        // ===== 正しい販管費31項目定義 =====
        const ADMIN_EXPENSE_ITEMS = {
            // 人件費関連
            personnel: { id: 1, name: '人件費統合', category: 'personnel' },
            welfare: { id: 2, name: '法定福利費', category: 'personnel' },
            hygiene: { id: 3, name: '衛生費', category: 'personnel' },
            
            // 物流・施設費
            logistics: { id: 4, name: '物流管理費', category: 'facility' },
            rent: { id: 5, name: '地代家賃', category: 'facility' },
            outsourcing: { id: 6, name: '外注費', category: 'facility' },
            freight: { id: 7, name: '荷造運賃', category: 'facility' },
            
            // 営業・マーケティング費
            advertising: { id: 8, name: '広告宣伝費', category: 'marketing' },
            travel: { id: 9, name: '旅費交通費', category: 'marketing' },
            communication: { id: 10, name: '通信費', category: 'marketing' },
            promotion: { id: 11, name: '販売促進費', category: 'marketing' },
            
            // 運営費
            consumables: { id: 12, name: '消耗品費', category: 'operation' },
            office: { id: 13, name: '事務用品費', category: 'operation' },
            utilities: { id: 14, name: '水道光熱費', category: 'operation' },
            fees: { id: 15, name: '支払手数料', category: 'operation' },
            
            // 設備・保険
            lease: { id: 16, name: 'リース料', category: 'equipment' },
            insurance: { id: 17, name: '保険料', category: 'equipment' },
            paymentFees: { id: 18, name: '支払報酬料', category: 'equipment' },
            depreciation: { id: 19, name: '減価償却費', category: 'equipment' },
            
            // 役員・管理
            executiveComp: { id: 20, name: '役員報酬', category: 'executive' },
            adminExpenses: { id: 21, name: '管理諸費', category: 'executive' },
            repairs: { id: 22, name: '修繕費', category: 'executive' },
            vehicle: { id: 23, name: '車両費', category: 'executive' },
            
            // その他費用
            taxes: { id: 24, name: '租税公課', category: 'other' },
            entertainment: { id: 25, name: '交際費', category: 'other' },
            dues: { id: 26, name: '諸会費', category: 'other' },
            meetings: { id: 27, name: '会議費', category: 'other' },
            welfareExpenses: { id: 28, name: '福利厚生費', category: 'other' },
            training: { id: 29, name: '研修費', category: 'other' },
            miscExpenses: { id: 30, name: '雑費', category: 'other' },
            donations: { id: 31, name: '寄付金', category: 'other' }
        };

        // ===== テストデータ生成 =====
        function generateTestData() {
            const testData = {
                sr: {
                    sales: [3405, 3333, 3333, 3333, 3333, 3333, 3333, 3333, 3333, 3333, 3333, 3333],
                    cogs: [1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861, 1861],
                    personnel: [280, 280, 280, 280, 280, 280, 280, 280, 280, 280, 280, 280],
                    welfare: [140, 140, 140, 127, 127, 127, 127, 127, 127, 127, 127, 127],
                    logistics: [117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117],
                    rent: [55, 55, 55, 55, 55, 55, 55, 55, 55, 55, 55, 55],
                    outsourcing: [30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30],
                    freight: [15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15],
                    advertising: [30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30],
                    travel: [15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15],
                    communication: [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5],
                    promotion: [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20],
                    utilities: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10],
                    fees: [93, 93, 93, 93, 93, 93, 93, 93, 93, 93, 93, 93]
                },
                w: {
                    sales: [1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674, 1674],
                    cogs: [880, 880, 880, 880, 880, 880, 880, 880, 880, 880, 880, 880],
                    personnel: [117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117, 117],
                    welfare: [55, 55, 55, 55, 55, 55, 55, 55, 55, 55, 55, 55],
                    rent: [60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60],
                    advertising: [30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30],
                    fees: [11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11],
                    travel: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10],
                    communication: [3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3]
                },
                rc: {
                    sales: [1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244, 1244],
                    cogs: [932, 932, 932, 932, 932, 932, 932, 932, 932, 932, 932, 932],
                    personnel: [61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61, 61],
                    welfare: [6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6],
                    logistics: [67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67, 67],
                    advertising: [40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40],
                    fees: [70, 70, 70, 70, 70, 70, 70, 70, 70, 70, 70, 70],
                    travel: [15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15],
                    communication: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                    promotion: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10],
                    office: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10],
                    utilities: [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                    insurance: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                    paymentFees: [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10],
                    depreciation: [7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7]
                },
                rcd: {
                    sales: [532, 532, 532, 532, 532, 532, 532, 532, 532, 532, 532, 532],
                    cogs: [372, 372, 372, 372, 372, 372, 372, 372, 372, 372, 372, 372],
                    personnel: [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                    welfare: [13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13],
                    fees: [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2]
                }
            };

            // 役員報酬データ
            const executiveData = {
                monthlyCompensation: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676]
            };

            // データ保存
            DataStorage.set('sr', testData.sr);
            DataStorage.set('w', testData.w);
            DataStorage.set('rc', testData.rc);
            DataStorage.set('rcd', testData.rcd);
            DataStorage.set('executive', executiveData);

            // 初期化メッセージを非表示
            document.getElementById('init-message').style.display = 'none';
            
            // データ更新
            generateSalesTable();
            generateExpenseTable();
            
            alert('テストデータを生成しました。');
        }

        // ===== 売上・仕入・粗利テーブル生成 =====
        function generateSalesTable() {
            if (!DataStorage.hasData()) {
                document.getElementById('sales-table-container').innerHTML = 
                    '<p style="text-align: center; color: #856404;">データがありません。</p>';
                return;
            }

            const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
            let totalSales = new Array(12).fill(0);
            let totalCOGS = new Array(12).fill(0);
            let totalGrossProfit = new Array(12).fill(0);

            // 各事業部のデータを収集
            const departments = ['sr', 'w', 'rc', 'rcd'];
            const deptNames = {
                sr: 'SR事業部',
                w: 'W事業部',
                rc: 'RC卸事業部',
                rcd: 'RCD社事業部'
            };

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 200px;">項目</th>
                            ${months.map(m => `<th>${m}</th>`).join('')}
                            <th style="width: 100px;">年間計</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // 売上高セクション
            html += `<tr class="category-header sales-header"><td colspan="15">売上高</td></tr>`;
            
            departments.forEach(dept => {
                const data = DataStorage.get(dept);
                if (data && data.sales) {
                    const annual = data.sales.reduce((sum, val) => sum + val, 0);
                    html += `
                        <tr class="data-row">
                            <td class="item-name">${deptNames[dept]}</td>
                            ${data.sales.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                            <td class="annual-total">${formatNumber(annual)}</td>
                        </tr>
                    `;
                    data.sales.forEach((val, i) => totalSales[i] += val);
                }
            });

            const annualTotalSales = totalSales.reduce((sum, val) => sum + val, 0);
            html += `
                <tr class="total-row">
                    <td class="item-name">売上高合計</td>
                    ${totalSales.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                    <td class="grand-total">${formatNumber(annualTotalSales)}</td>
                </tr>
            `;

            // 売上原価セクション
            html += `<tr class="category-header cogs-header"><td colspan="15">売上原価</td></tr>`;
            
            departments.forEach(dept => {
                const data = DataStorage.get(dept);
                if (data && data.cogs) {
                    const annual = data.cogs.reduce((sum, val) => sum + val, 0);
                    html += `
                        <tr class="data-row">
                            <td class="item-name">${deptNames[dept]}</td>
                            ${data.cogs.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                            <td class="annual-total">${formatNumber(annual)}</td>
                        </tr>
                    `;
                    data.cogs.forEach((val, i) => totalCOGS[i] += val);
                }
            });

            const annualTotalCOGS = totalCOGS.reduce((sum, val) => sum + val, 0);
            html += `
                <tr class="total-row">
                    <td class="item-name">売上原価合計</td>
                    ${totalCOGS.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                    <td class="grand-total">${formatNumber(annualTotalCOGS)}</td>
                </tr>
            `;

            // 粗利益セクション
            html += `<tr class="category-header profit-header"><td colspan="15">粗利益</td></tr>`;
            
            departments.forEach(dept => {
                const data = DataStorage.get(dept);
                if (data && data.sales && data.cogs) {
                    const grossProfitData = data.sales.map((sales, i) => sales - data.cogs[i]);
                    const annual = grossProfitData.reduce((sum, val) => sum + val, 0);
                    html += `
                        <tr class="data-row">
                            <td class="item-name">${deptNames[dept]}</td>
                            ${grossProfitData.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                            <td class="annual-total">${formatNumber(annual)}</td>
                        </tr>
                    `;
                    grossProfitData.forEach((val, i) => totalGrossProfit[i] += val);
                }
            });

            const annualTotalGrossProfit = totalGrossProfit.reduce((sum, val) => sum + val, 0);
            html += `
                <tr class="total-row">
                    <td class="item-name">粗利益合計</td>
                    ${totalGrossProfit.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                    <td class="grand-total">${formatNumber(annualTotalGrossProfit)}</td>
                </tr>
            `;

            html += `</tbody></table>`;
            document.getElementById('sales-table-container').innerHTML = html;
        }

        // ===== データ収集・統合処理 =====
        function collectDepartmentData() {
            const integratedExpenses = {};
            
            // 31項目を初期化
            Object.keys(ADMIN_EXPENSE_ITEMS).forEach(key => {
                integratedExpenses[key] = new Array(12).fill(0);
            });
            
            let activeCount = 0;
            
            // SR事業部のデータ
            const srData = DataStorage.get('sr');
            if (srData) {
                activeCount++;
                updateDeptStatus('sr', 'success', 'データ取得済');
                
                // 直接マッピングできる項目
                ['personnel', 'welfare', 'logistics', 'rent', 'outsourcing', 'freight',
                 'advertising', 'travel', 'communication', 'promotion', 'utilities', 'fees'].forEach(key => {
                    if (srData[key]) {
                        addToExpenses(integratedExpenses, key, srData[key]);
                    }
                });
                
                // その他の項目に一部を配分（簡易的に）
                if (srData.fees) {
                    // 支払手数料の一部を他の項目にも配分
                    srData.fees.forEach((val, i) => {
                        integratedExpenses.consumables[i] += Math.round(val * 0.05);
                        integratedExpenses.office[i] += Math.round(val * 0.05);
                        integratedExpenses.hygiene[i] += Math.round(val * 0.03);
                    });
                }
            } else {
                updateDeptStatus('sr', 'warning', 'データなし');
            }
            
            // W事業部のデータ
            const wData = DataStorage.get('w');
            if (wData) {
                activeCount++;
                updateDeptStatus('w', 'success', 'データ取得済');
                
                ['personnel', 'welfare', 'rent', 'advertising', 'fees', 'travel', 'communication'].forEach(key => {
                    if (wData[key]) {
                        addToExpenses(integratedExpenses, key, wData[key]);
                    }
                });
            } else {
                updateDeptStatus('w', 'warning', 'データなし');
            }
            
            // RC卸事業部のデータ
            const rcData = DataStorage.get('rc');
            if (rcData) {
                activeCount++;
                updateDeptStatus('rc', 'success', 'データ取得済');
                
                ['personnel', 'welfare', 'logistics', 'advertising', 'fees', 'travel',
                 'communication', 'promotion', 'office', 'utilities', 'insurance',
                 'paymentFees', 'depreciation'].forEach(key => {
                    if (rcData[key]) {
                        addToExpenses(integratedExpenses, key, rcData[key]);
                    }
                });
            } else {
                updateDeptStatus('rc', 'warning', 'データなし');
            }
            
            // RCD社事業部のデータ
            const rcdData = DataStorage.get('rcd');
            if (rcdData) {
                activeCount++;
                updateDeptStatus('rcd', 'success', 'データ取得済');
                
                ['personnel', 'welfare', 'fees'].forEach(key => {
                    if (rcdData[key]) {
                        addToExpenses(integratedExpenses, key, rcdData[key]);
                    }
                });
            } else {
                updateDeptStatus('rcd', 'warning', 'データなし');
            }
            
            // 役員報酬の追加
            const executiveData = DataStorage.get('executive');
            if (executiveData && executiveData.monthlyCompensation) {
                integratedExpenses.executiveComp = executiveData.monthlyCompensation;
            } else {
                // デフォルト値
                integratedExpenses.executiveComp = [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676];
            }
            
            // 統合状況更新
            document.getElementById('integration-count').textContent = `${activeCount}/4`;
            
            return integratedExpenses;
        }

        function addToExpenses(expenses, key, dataArray) {
            if (expenses[key] && Array.isArray(dataArray)) {
                dataArray.forEach((val, i) => {
                    expenses[key][i] += (val || 0);
                });
            }
        }

        // ===== 販管費テーブル生成 =====
        function generateExpenseTable() {
            if (!DataStorage.hasData()) {
                document.getElementById('expense-table-container').innerHTML = 
                    '<p style="text-align: center; color: #856404;">データがありません。「テストデータ生成」ボタンをクリックしてください。</p>';
                return;
            }
            
            const expenses = collectDepartmentData();
            const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th style="width: 200px;">販管費項目</th>
                            ${months.map(m => `<th>${m}</th>`).join('')}
                            <th style="width: 100px;">年間計</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const categories = {
                personnel: '人件費関連',
                facility: '物流・施設費',
                marketing: '営業・マーケティング費',
                operation: '運営費',
                equipment: '設備・保険',
                executive: '役員・管理',
                other: 'その他費用'
            };
            
            let grandTotal = 0;
            const monthlyTotals = new Array(12).fill(0);
            
            Object.entries(categories).forEach(([catKey, catName]) => {
                // カテゴリヘッダー
                html += `
                    <tr class="category-header">
                        <td colspan="15">${catName}</td>
                    </tr>
                `;
                
                // 項目表示
                Object.entries(ADMIN_EXPENSE_ITEMS)
                    .filter(([_, item]) => item.category === catKey)
                    .sort((a, b) => a[1].id - b[1].id)
                    .forEach(([key, item]) => {
                        const monthlyData = expenses[key] || new Array(12).fill(0);
                        const annual = monthlyData.reduce((sum, val) => sum + val, 0);
                        grandTotal += annual;
                        
                        monthlyData.forEach((val, i) => {
                            monthlyTotals[i] += val;
                        });
                        
                        html += `
                            <tr class="data-row">
                                <td>${item.id}</td>
                                <td class="item-name">${item.name}</td>
                                ${monthlyData.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                                <td class="annual-total">${formatNumber(annual)}</td>
                            </tr>
                        `;
                    });
            });
            
            // 合計行
            html += `
                    <tr class="total-row">
                        <td>-</td>
                        <td class="item-name">販管費合計</td>
                        ${monthlyTotals.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                        <td class="grand-total">${formatNumber(grandTotal)}</td>
                    </tr>
                </tbody>
            </table>
            `;
            
            document.getElementById('expense-table-container').innerHTML = html;
            
            // 広告宣伝費の確認（デバッグ用）
            console.log('広告宣伝費の内訳:');
            console.log('SR事業部: 30万円 × 12ヶ月 = 360万円');
            console.log('W事業部: 30万円 × 12ヶ月 = 360万円');
            console.log('RC卸: 40万円 × 12ヶ月 = 480万円');
            console.log('合計: 100万円 × 12ヶ月 = 1,200万円');
            
            // KPI更新
            updateKPIs(grandTotal);
            
            // チャート更新
            updateExpenseChart(monthlyTotals);
        }

        // ===== KPI更新 =====
        function updateKPIs(totalExpenses) {
            // 売上データ収集
            let totalSales = 0;
            let totalCOGS = 0;
            
            ['sr', 'w', 'rc', 'rcd'].forEach(dept => {
                const data = DataStorage.get(dept);
                if (data) {
                    if (data.sales && Array.isArray(data.sales)) {
                        totalSales += data.sales.reduce((sum, val) => sum + val, 0);
                    }
                    if (data.cogs && Array.isArray(data.cogs)) {
                        totalCOGS += data.cogs.reduce((sum, val) => sum + val, 0);
                    }
                }
            });
            
            const grossProfit = totalSales - totalCOGS;
            const operatingProfit = grossProfit - totalExpenses;
            const profitRate = totalSales > 0 ? (operatingProfit / totalSales * 100).toFixed(1) : '0.0';
            
            // KPI表示更新
            document.getElementById('total-sales').textContent = formatNumber(totalSales) + '万円';
            document.getElementById('total-profit').textContent = formatNumber(operatingProfit) + '万円';
            document.getElementById('profit-rate').textContent = profitRate + '%';
            
            // 色分け
            const profitCard = document.getElementById('total-profit-card');
            const rateCard = document.getElementById('profit-rate-card');
            
            if (operatingProfit >= 0) {
                profitCard.className = 'kpi-card positive';
                rateCard.className = 'kpi-card positive';
                document.getElementById('total-profit').className = 'kpi-value positive';
                document.getElementById('profit-rate').className = 'kpi-value positive';
            } else {
                profitCard.className = 'kpi-card negative';
                rateCard.className = 'kpi-card negative';
                document.getElementById('total-profit').className = 'kpi-value negative';
                document.getElementById('profit-rate').className = 'kpi-value negative';
            }
        }

        // ===== チャート更新 =====
        let expenseChart = null;
        
        function updateExpenseChart(monthlyTotals) {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
            
            expenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: '販管費合計',
                        data: monthlyTotals,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: '#e74c3c',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '販管費: ' + formatNumber(context.parsed.y) + '万円';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '金額（万円）'
                            }
                        }
                    }
                }
            });
        }

        // ===== 自動同期システム =====
        const AUTO_SYNC = {
            timer: null,
            interval: 5000,
            isActive: false,
            
            start: function() {
                if (this.isActive) return;
                
                this.isActive = true;
                this.timer = setInterval(() => {
                    this.sync();
                }, this.interval);
                
                document.getElementById('sync-status').textContent = '稼働中';
                document.getElementById('sync-status').className = 'linkage-indicator active';
                
                this.sync(); // 即座に実行
            },
            
            stop: function() {
                if (!this.isActive) return;
                
                this.isActive = false;
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                
                document.getElementById('sync-status').textContent = '停止中';
                document.getElementById('sync-status').className = 'linkage-indicator';
            },
            
            sync: function() {
                const indicator = document.getElementById('sync-indicator');
                indicator.className = 'sync-indicator active';
                
                // データ更新
                generateSalesTable();
                generateExpenseTable();
                
                // 最終同期時刻更新
                const now = new Date();
                document.getElementById('last-sync').textContent = 
                    `最終同期: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                setTimeout(() => {
                    indicator.className = 'sync-indicator';
                }, 1000);
            }
        };

        // ===== ユーティリティ関数 =====
        function formatNumber(num) {
            if (isNaN(num) || num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString();
        }

        function updateDeptStatus(dept, status, message) {
            const statusElement = document.getElementById(`${dept}-status`);
            if (statusElement) {
                statusElement.className = `dept-status status-${status}`;
                const deptNames = {
                    sr: 'SR事業部',
                    w: 'W事業部',
                    rc: 'RC卸',
                    rcd: 'RCD社'
                };
                statusElement.textContent = `${deptNames[dept]}: ${message}`;
            }
        }

        // ===== ページ切替 =====
        function showPage(page) {
            const pageUrls = {
                dashboard: 'index.html',
                budget: 'budget-input.html',
                sr: 'sr-pl.html',
                w: 'w-pl.html',
                rc: 'rc-pl.html',
                rcd: 'rcd-pl.html'
            };
            
            // 実際のファイルがある場合は遷移
            if (pageUrls[page]) {
                // window.location.href = pageUrls[page];
                alert(`${page}ページへ遷移: ${pageUrls[page]}`);
            } else {
                alert(`${page}ページは準備中です`);
            }
        }

        // ===== グローバル関数 =====
        function startAutoSync() {
            if (!DataStorage.hasData()) {
                alert('先にテストデータを生成してください。');
                return;
            }
            AUTO_SYNC.start();
            alert('自動同期を開始しました（5秒間隔）');
        }

        function stopAutoSync() {
            AUTO_SYNC.stop();
            alert('自動同期を停止しました');
        }

        function manualRefresh() {
            if (!DataStorage.hasData()) {
                alert('先にテストデータを生成してください。');
                return;
            }
            generateSalesTable();
            generateExpenseTable();
            alert('データを手動更新しました');
        }

        function exportToCSV() {
            if (!DataStorage.hasData()) {
                alert('データがありません。先にテストデータを生成してください。');
                return;
            }
            
            const expenses = collectDepartmentData();
            const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
            
            // 売上・仕入・粗利データも含めたCSV作成
            let csv = '\uFEFF統合PLデータ\n\n';
            
            // 売上データセクション
            csv += '【売上高】\n';
            csv += '事業部,7月,8月,9月,10月,11月,12月,1月,2月,3月,4月,5月,6月,年間計\n';
            
            const departments = ['sr', 'w', 'rc', 'rcd'];
            const deptNames = {
                sr: 'SR事業部',
                w: 'W事業部', 
                rc: 'RC卸事業部',
                rcd: 'RCD社事業部'
            };
            
            let totalSalesRow = new Array(12).fill(0);
            departments.forEach(dept => {
                const data = DataStorage.get(dept);
                if (data && data.sales) {
                    csv += `${deptNames[dept]},`;
                    csv += data.sales.join(',') + ',';
                    csv += data.sales.reduce((sum, val) => sum + val, 0) + '\n';
                    data.sales.forEach((val, i) => totalSalesRow[i] += val);
                }
            });
            csv += '売上高合計,';
            csv += totalSalesRow.join(',') + ',';
            csv += totalSalesRow.reduce((sum, val) => sum + val, 0) + '\n\n';
            
            // 販管費データセクション
            csv += '【販管費31項目詳細】\n';
            csv += 'ID,項目名,';
            csv += months.join(',') + ',年間計\n';
            
            Object.entries(ADMIN_EXPENSE_ITEMS)
                .sort((a, b) => a[1].id - b[1].id)
                .forEach(([key, item]) => {
                    const monthlyData = expenses[key] || new Array(12).fill(0);
                    const annual = monthlyData.reduce((sum, val) => sum + val, 0);
                    csv += `${item.id},"${item.name}",`;
                    csv += monthlyData.join(',') + ',' + annual + '\n';
                });
            
            // 販管費合計行
            const monthlyTotals = new Array(12).fill(0);
            Object.keys(expenses).forEach(key => {
                if (expenses[key]) {
                    expenses[key].forEach((val, i) => {
                        monthlyTotals[i] += val;
                    });
                }
            });
            csv += '-,販管費合計,';
            csv += monthlyTotals.join(',') + ',';
            csv += monthlyTotals.reduce((sum, val) => sum + val, 0) + '\n';
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `統合PLデータ_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        // ===== 初期化 =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('統合PLシステム 販管費31項目完全実装版 起動');
            
            // データ有無チェック
            if (!DataStorage.hasData()) {
                document.getElementById('init-message').style.display = 'block';
            } else {
                document.getElementById('init-message').style.display = 'none';
                // 初回データ読み込み
                generateSalesTable();
                generateExpenseTable();
            }
        });
    </script>
</body>
</html>
