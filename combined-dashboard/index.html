<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統合PLシステム v5.0 - 全機能統合版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: #333;
            background: linear-gradient(135deg, #fdf2e9 0%, #fcf3cf 100%);
            min-height: 100vh;
        }

        /* 4行ヘッダー構造 */
        .header-row1 {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .header-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .version-info {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 16px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: inline-block;
        }

        /* 2行目: グローバルナビゲーション（5ボタン） */
        .header-row2 {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            padding: 8px 15px;
        }

        .nav-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 160px;
            max-width: 200px;
            padding: 8px 16px;
            font-size: 0.8em;
            border-radius: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
            text-align: center;
            cursor: pointer;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            color: white;
            text-decoration: none;
        }

        /* アクティブボタン（統合PLシステム） */
        .btn-active-unified { 
            background: #f39c12 !important; 
            box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5) !important;
        }

        .btn-active-sr { 
            background: #C477CC !important; 
            box-shadow: 0 4px 8px rgba(196, 119, 204, 0.3);
        }
        .btn-active-w { 
            background: #3498db !important; 
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        .btn-active-rc { 
            background: #27ae60 !important; 
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }
        .btn-active-rcd { 
            background: #9b59b6 !important; 
            box-shadow: 0 4px 8px rgba(155, 89, 182, 0.3);
        }

        /* 3行目: KPIカード */
        .header-row3 {
            background: #f8f9fa;
            padding: 12px 15px;
        }

        .mini-kpi-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mini-kpi {
            background: white;
            border-radius: 8px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            min-width: 120px;
            text-align: center;
        }

        .mini-kpi-label {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 3px;
        }

        .mini-kpi-value {
            font-size: 0.9em;
            font-weight: bold;
            color: #f39c12;
        }

        /* 4行目: 連携ステータス */
        .header-row4 {
            background: #ecf0f1;
            padding: 10px 15px;
            text-align: center;
        }

        .integration-status {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8em;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-connected { background-color: #27ae60; }
        .status-pending { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }

        /* 統合ヘッダー（従来スタイル維持） */
        .unified-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        /* ナビゲーションタブ */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid #3498db;
            border-radius: 25px;
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-tab:hover, .nav-tab.active {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        /* KPIダッシュボード */
        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .kpi-card-sales { border-color: #3498db; }
        .kpi-card-profit { border-color: #27ae60; }
        .kpi-card-expenses { border-color: #e67e22; }
        .kpi-card-margin { border-color: #9b59b6; }

        .kpi-label {
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .kpi-card-sales .kpi-value { color: #3498db; }
        .kpi-card-profit .kpi-value { color: #27ae60; }
        .kpi-card-expenses .kpi-value { color: #e67e22; }
        .kpi-card-margin .kpi-value { color: #9b59b6; }

        .kpi-change {
            font-size: 0.8em;
            font-weight: 600;
        }

        .kpi-change.positive { color: #27ae60; }
        .kpi-change.negative { color: #e74c3c; }

        /* 役員報酬設定セクション */
        .executive-compensation {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 3px solid #27ae60;
        }

        .section-title {
            font-size: 1.3em;
            color: #27ae60;
            margin-bottom: 20px;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 8px;
            font-weight: bold;
        }

        .compensation-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .control-input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .control-input:focus {
            border-color: #27ae60;
            outline: none;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .compensation-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9em;
        }

        .btn-apply { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .btn-save { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .btn-load { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .btn-test { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* 統一テーブルスタイル */
        .unified-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid rgba(243, 156, 18, 0.2);
        }

        .table-container {
            overflow-x: auto;
            margin: -5px;
            padding: 5px;
        }

        .unified-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            margin-bottom: 15px;
        }

        .unified-table th,
        .unified-table td {
            padding: 4px;
            text-align: right;
            border-bottom: 1px solid #fce4d6;
            border-right: 1px solid #fdf2e9;
        }

        .unified-table .id-column {
            width: 25px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            padding: 4px 2px;
        }

        .unified-table th:nth-child(2),
        .unified-table td:nth-child(2) {
            text-align: left;
            font-weight: bold;
            width: 120px;
            padding: 4px 8px;
        }

        .unified-table th:nth-child(n+3):nth-child(-n+14),
        .unified-table td:nth-child(n+3):nth-child(-n+14) {
            width: calc((100% - 25px - 120px - 80px) / 12);
            min-width: 50px;
            padding: 4px 6px;
        }

        .unified-table th:last-child,
        .unified-table td:last-child {
            width: 80px;
            font-weight: bold;
            background-color: #fef9f3;
            padding: 4px 6px;
        }

        .unified-table th {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 6px 4px;
        }

        .total-row {
            background-color: #fef9f3;
            font-weight: bold;
            border-top: 2px solid #f39c12;
        }

        .profit-row {
            background-color: #e8f5e8;
            font-weight: bold;
            color: #155724;
        }

        .admin-expense-row:nth-child(even) {
            background-color: #fefbf7;
        }

        .admin-expense-row:hover {
            background-color: #fcf3cf;
        }

        /* 事業部比較セクション */
        .department-comparison {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 3px solid #3498db;
        }

        .dept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dept-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 3px solid;
            transition: all 0.3s ease;
        }

        .dept-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .dept-sr { border-color: #C477CC; }
        .dept-w { border-color: #3498db; }
        .dept-rc { border-color: #27ae60; }
        .dept-rcd { border-color: #9b59b6; }

        .dept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
        }

        .dept-name {
            font-size: 1.1em;
            font-weight: bold;
        }

        .dept-status {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .dept-sr .dept-header { border-color: #C477CC; color: #C477CC; }
        .dept-w .dept-header { border-color: #3498db; color: #3498db; }
        .dept-rc .dept-header { border-color: #27ae60; color: #27ae60; }
        .dept-rcd .dept-header { border-color: #9b59b6; color: #9b59b6; }

        .dept-chart {
            height: 200px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }

        .dept-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .metric-change {
            font-size: 0.7em;
            margin-top: 3px;
        }

        /* チャートコンテナ */
        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 3px solid #e74c3c;
        }

        .chart-container {
            position: relative;
            height: 450px;
            margin-bottom: 20px;
        }

        .chart-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chart-toggle {
            padding: 8px 16px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .chart-toggle:hover, .chart-toggle.active {
            background: #3498db;
            color: white;
        }

        /* 通知システム */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 350px;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 0.9em;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            font-weight: 600;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-left: 5px solid #27ae60;
            color: #155724;
        }

        .notification-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left: 5px solid #f39c12;
            color: #856404;
        }

        .notification-error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-left: 5px solid #e74c3c;
            color: #721c24;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .header-row1, .header-row2, .header-row3, .header-row4 {
                padding: 10px;
            }
            
            .header-title {
                font-size: 1.3em;
            }
            
            .nav-container {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                min-width: 200px;
                max-width: 300px;
            }
            
            .mini-kpi-container {
                flex-direction: column;
                align-items: center;
            }
            
            .integration-status {
                flex-direction: column;
                gap: 10px;
            }
            
            .unified-table {
                font-size: 0.7em;
            }
            
            .unified-table th,
            .unified-table td {
                padding: 3px 2px;
            }

            .kpi-dashboard {
                grid-template-columns: 1fr;
            }
            
            .dept-grid {
                grid-template-columns: 1fr;
            }
            
            .compensation-controls {
                grid-template-columns: 1fr;
            }
            
            .compensation-actions {
                flex-direction: column;
                align-items: center;
            }
        }

        /* データソース表示 */
        .data-source {
            text-align: center;
            font-size: 0.8em;
            color: #666;
            margin: 10px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        /* 追加スタイル */
        .executive-row {
            background-color: #e8f5e8;
            font-weight: bold;
        }

        .final-profit-positive {
            background-color: #e8f5e8;
            color: #155724;
            font-weight: bold;
        }

        .final-profit-negative {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .metric-change.positive {
            color: #27ae60;
        }

        .metric-change.negative {
            color: #e74c3c;
        }

        .chart-section {
            border-left: 5px solid #e74c3c;
        }

        .department-comparison {
            border-left: 5px solid #3498db;
        }

        .executive-compensation {
            border-left: 5px solid #27ae60;
        }
    </style>
</head>
<body>
    <!-- 4行ヘッダー構造 -->
    <!-- 1行目: タイトル -->
    <div class="header-row1">
        <h1 class="header-title">統合PLシステム v5.0</h1>
        <div class="version-info">全機能統合版 - 役員報酬・前年比較・事業部分析・リアルタイム監視</div>
    </div>

    <!-- 2行目: グローバルナビゲーション（5ボタン） - GitHubファイル名に修正 -->
    <div class="header-row2">
        <div class="nav-container">
            <a href="../department-pl/sr-pl.html" class="btn">SR事業部PL</a>
            <a href="../department-pl/w-pl.html" class="btn">W事業部PL</a>
            <a href="../department-pl/rc-pl.html" class="btn">RC事業部PL</a>
            <a href="../department-pl/rcd-pl.html" class="btn">RCD事業部PL</a>
            <a href="#" class="btn btn-active-unified">統合PLシステム</a>
        </div>
    </div>

    <!-- 3行目: KPIカード -->
    <div class="header-row3">
        <div class="mini-kpi-container">
            <div class="mini-kpi">
                <div class="mini-kpi-label">統合売上高</div>
                <div class="mini-kpi-value" id="mini-kpi-sales">---万円</div>
            </div>
            <div class="mini-kpi">
                <div class="mini-kpi-label">全体販管費</div>
                <div class="mini-kpi-value" id="mini-kpi-expenses">---万円</div>
            </div>
            <div class="mini-kpi">
                <div class="mini-kpi-label">営業利益</div>
                <div class="mini-kpi-value" id="mini-kpi-profit">---万円</div>
            </div>
            <div class="mini-kpi">
                <div class="mini-kpi-label">利益率</div>
                <div class="mini-kpi-value" id="mini-kpi-margin">---%</div>
            </div>
        </div>
    </div>

    <!-- 4行目: 連携ステータス -->
    <div class="header-row4">
        <div class="integration-status">
            <div class="status-item">
                <span class="status-indicator" id="sr-indicator"></span>
                <span>SR事業部</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="w-indicator"></span>
                <span>W事業部</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="rc-indicator"></span>
                <span>RC事業部</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="rcd-indicator"></span>
                <span>RCD事業部</span>
            </div>
            <div class="status-item">
                <span class="status-indicator status-connected"></span>
                <span>統合PLシステム 稼働中</span>
            </div>
        </div>
    </div>

    <!-- 従来の統合ヘッダー -->
    <div class="unified-header">
        <!-- ナビゲーションタブ -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showSection('overview')">概要</div>
            <div class="nav-tab" onclick="showSection('executive')">役員報酬</div>
            <div class="nav-tab" onclick="showSection('departments')">事業部比較</div>
            <div class="nav-tab" onclick="showSection('analysis')">分析</div>
            <div class="nav-tab" onclick="showSection('pl-details')">PL詳細</div>
        </div>
    </div>

    <!-- 通知表示エリア -->
    <div id="notification" class="notification"></div>

    <div style="max-width: 1400px; margin: 0 auto; padding: 0 15px;">
        
        <!-- 概要セクション -->
        <div id="overview-section" class="tab-content">
            <!-- KPIダッシュボード -->
            <div class="kpi-dashboard">
                <div class="kpi-card kpi-card-sales">
                    <div class="kpi-label">統合売上高</div>
                    <div class="kpi-value" id="kpi-sales">---</div>
                    <div class="kpi-change" id="kpi-sales-change">前年比 ---%</div>
                </div>
                <div class="kpi-card kpi-card-expenses">
                    <div class="kpi-label">全体販管費</div>
                    <div class="kpi-value" id="kpi-expenses">---</div>
                    <div class="kpi-change" id="kpi-expenses-change">前年比 ---%</div>
                </div>
                <div class="kpi-card kpi-card-profit">
                    <div class="kpi-label">営業利益</div>
                    <div class="kpi-value" id="kpi-profit">---</div>
                    <div class="kpi-change" id="kpi-profit-change">前年比 ---%</div>
                </div>
                <div class="kpi-card kpi-card-margin">
                    <div class="kpi-label">利益率</div>
                    <div class="kpi-value" id="kpi-margin">---%</div>
                    <div class="kpi-change" id="kpi-margin-change">前年比 ---pt</div>
                </div>
            </div>

            <!-- メインチャート -->
            <div class="chart-section">
                <h2 class="section-title" style="color: #e74c3c;">月次推移グラフ（売上・販管費・営業利益累計）</h2>
                <div class="chart-controls">
                    <button class="chart-toggle active" onclick="toggleChartMode('current')">当期実績</button>
                    <button class="chart-toggle" onclick="toggleChartMode('comparison')">前年比較</button>
                    <button class="chart-toggle" onclick="toggleChartMode('department')">事業部別</button>
                </div>
                <div class="chart-container">
                    <canvas id="main-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- 役員報酬セクション -->
        <div id="executive-section" class="tab-content" style="display: none;">
            <div class="executive-compensation">
                <h2 class="section-title">役員報酬・賞与設定</h2>
                
                <div class="compensation-controls">
                    <div class="control-group">
                        <label class="control-label">7-9月基準額（万円）</label>
                        <input type="number" class="control-input" id="salary-high" value="826" step="10">
                    </div>
                    <div class="control-group">
                        <label class="control-label">10-6月基準額（万円）</label>
                        <input type="number" class="control-input" id="salary-low" value="676" step="10">
                    </div>
                    <div class="control-group">
                        <label class="control-label">6月賞与額（万円）</label>
                        <input type="number" class="control-input" id="bonus-amount" value="0" step="50">
                    </div>
                    <div class="control-group">
                        <label class="control-label">福利費率（%）</label>
                        <input type="number" class="control-input" id="welfare-rate" value="13" step="0.1" min="0" max="30">
                    </div>
                </div>

                <div class="compensation-actions">
                    <button class="action-button btn-apply" onclick="applyCompensation()">設定適用</button>
                    <button class="action-button btn-save" onclick="saveCompensation()">データ保存</button>
                    <button class="action-button btn-load" onclick="loadCompensation()">データ読込</button>
                    <button class="action-button btn-test" onclick="testCompensation()">動作テスト</button>
                </div>

                <div id="compensation-status" class="data-source">
                    ステータス: 待機中...
                </div>

                <!-- 役員報酬テーブル -->
                <div class="table-container">
                    <table class="unified-table" id="compensation-table">
                        <thead>
                            <tr>
                                <th class="id-column"></th>
                                <th>項目名</th>
                                <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                                <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                                <th>年間合計</th>
                            </tr>
                        </thead>
                        <tbody id="compensation-body">
                            <!-- 動的に生成される役員報酬データ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 事業部比較セクション -->
        <div id="departments-section" class="tab-content" style="display: none;">
            <div class="department-comparison">
                <h2 class="section-title" style="color: #3498db;">事業部別比較・前年対比分析</h2>
                
                <div class="dept-grid">
                    <div class="dept-card dept-sr">
                        <div class="dept-header">
                            <span class="dept-name">SR事業部</span>
                            <span class="dept-status" id="sr-status">
                                <span class="status-indicator status-pending"></span>待機中
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="sr-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">年間売上</div>
                                <div class="metric-value" id="sr-sales">---万円</div>
                                <div class="metric-change positive" id="sr-sales-change">前年比 ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">営業利益</div>
                                <div class="metric-value" id="sr-profit">---万円</div>
                                <div class="metric-change positive" id="sr-profit-change">前年比 ---%</div>
                            </div>
                        </div>
                    </div>

                    <div class="dept-card dept-w">
                        <div class="dept-header">
                            <span class="dept-name">W事業部</span>
                            <span class="dept-status" id="w-status">
                                <span class="status-indicator status-pending"></span>待機中
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="w-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">年間売上</div>
                                <div class="metric-value" id="w-sales">---万円</div>
                                <div class="metric-change positive" id="w-sales-change">前年比 ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">営業利益</div>
                                <div class="metric-value" id="w-profit">---万円</div>
                                <div class="metric-change positive" id="w-profit-change">前年比 ---%</div>
                            </div>
                        </div>
                    </div>

                    <div class="dept-card dept-rc">
                        <div class="dept-header">
                            <span class="dept-name">RC事業部</span>
                            <span class="dept-status" id="rc-status">
                                <span class="status-indicator status-pending"></span>待機中
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="rc-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">年間売上</div>
                                <div class="metric-value" id="rc-sales">---万円</div>
                                <div class="metric-change positive" id="rc-sales-change">前年比 ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">営業利益</div>
                                <div class="metric-value" id="rc-profit">---万円</div>
                                <div class="metric-change positive" id="rc-profit-change">前年比 ---%</div>
                            </div>
                        </div>
                    </div>

                    <div class="dept-card dept-rcd">
                        <div class="dept-header">
                            <span class="dept-name">RCD事業部</span>
                            <span class="dept-status" id="rcd-status">
                                <span class="status-indicator status-pending"></span>待機中
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="rcd-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">年間売上</div>
                                <div class="metric-value" id="rcd-sales">---万円</div>
                                <div class="metric-change positive" id="rcd-sales-change">前年比 ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">営業利益</div>
                                <div class="metric-value" id="rcd-profit">---万円</div>
                                <div class="metric-change positive" id="rcd-profit-change">前年比 ---%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分析セクション -->
        <div id="analysis-section" class="tab-content" style="display: none;">
            <div class="chart-section">
                <h2 class="section-title" style="color: #e74c3c;">詳細分析・トレンド分析</h2>
                <div class="chart-container">
                    <canvas id="analysis-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- PL詳細セクション -->
        <div id="pl-details-section" class="tab-content" style="display: none;">
            <!-- 統合損益計算書 -->
            <div class="unified-section">
                <h2 class="section-title">統合損益計算書・販管費19項目詳細（7月開始年度）</h2>
                <div class="table-container">
                    <table class="unified-table" id="combined-pl-table">
                        <thead>
                            <tr>
                                <th class="id-column">ID</th>
                                <th>項目名</th>
                                <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                                <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                                <th>年間合計</th>
                            </tr>
                        </thead>
                        <tbody id="combined-pl-body">
                            <!-- 動的に生成される統合PLデータ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- RC全体集計 -->
            <div class="unified-section">
                <h2 class="section-title" style="color: #e74c3c;">RC全体集計</h2>
                <div class="table-container">
                    <table class="unified-table" id="summary-table">
                        <thead>
                            <tr>
                                <th class="id-column"></th>
                                <th>項目名</th>
                                <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                                <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                                <th>年間合計</th>
                            </tr>
                        </thead>
                        <tbody id="summary-body">
                            <!-- 動的に生成される集計データ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 統合PLシステム v5.0 - 全機能統合版
        class UnifiedPLSystem {
            constructor() {
                // ストレージキー定義
                this.STORAGE_KEYS = {
                    'SR': 'pl_system_sr_corrected_data',
                    'W': 'pl_system_w_corrected_data', 
                    'RC': 'pl_system_rc_corrected_data',
                    'RCD': 'pl_system_rcd_corrected_data',
                    'executive': 'executive_compensation_csv_settings'
                };

                // 販管費19項目統一構造マッピング
                this.EXPENSE_ITEMS = {
                    1: '人件費統合', 2: '法定福利費', 3: '衛生費', 4: '物流管理費', 5: '地代家賃',
                    6: '外注費', 7: '貨物運賃', 8: '広告宣伝費', 9: '旅費交通費', 10: '通信費',
                    11: '販売促進費', 12: '消耗品費', 13: '事務用品費', 14: '水道光熱費', 15: '支払手数料',
                    16: 'リース料', 17: '保険料', 18: '支払報酬料', 19: '減価償却費'
                };

                // 全社共通費データ（万円単位・CSV更新対応）
                this.commonExpenseData = {
                    '管理諸費': [34, 37, 41, 34, 37, 44, 36, 39, 44, 36, 39, 44],
                    '修繕費': [22, 0, 1, 0, 0, 12, 13, 0, 7, 0, 3, 0],
                    '車両費': [2, 2, 1, 2, 3, 2, 2, 0, 19, 2, 4, 1],
                    '租税公課': [3, 3, 2, 1, 1, 1, 7, 2, 1, 12, 2, 5],
                    '交際費': [0, 1, 0, 2, 1, 0, 2, 4, 14, 1, 1, 9],
                    '諸会費': [1, 1, 1, 1, 1, 1, 0, 1, 18, 5, 2, 1],
                    '会議費': [0, 2, 2, 0, 2, 3, 1, 3, 1, 2, 1, 3],
                    '福利厚生費': [1, 1, 1, 1, 1, 2, 1, 1, 1, 2, 2, 2],
                    '研修費': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0],
                    '雑費': [1, 1, 1, 0, 0, 0, 0, 0, 0, 5, 0, 0],
                    '寄付金': [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0]
                };

                // 前年データ（比較用）
                this.previousYearData = {
                    totalSales: 231441,
                    totalProfit: 270,
                    departmentSales: {
                        'SR': 30382, 'W': 12721, 'RC': 18359, 'RCD': 169979
                    },
                    departmentProfit: {
                        'SR': 3038, 'W': 1272, 'RC': 1835, 'RCD': 16997
                    }
                };

                // 現在の表示モード
                this.currentChartMode = 'current';
                this.currentSection = 'overview';

                // チャートインスタンス
                this.charts = {};

                // 役員報酬データ
                this.executiveData = {
                    compensation: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676],
                    welfare: [107, 107, 107, 88, 88, 88, 88, 88, 88, 88, 88, 88]
                };

                this.initializeSystem();
            }

            initializeSystem() {
                console.log('統合PLシステム v5.0 初期化開始');
                this.loadAllDepartmentData();
                this.loadExecutiveData();
                this.calculateUnifiedPL();
                this.updateAllDisplays();
                this.showNotification('統合PLシステム v5.0 初期化完了', 'success');
            }

            // 全事業部データ読み込み
            loadAllDepartmentData() {
                this.departmentData = {};
                
                Object.keys(this.STORAGE_KEYS).forEach(dept => {
                    if (dept === 'executive') return;
                    
                    const data = localStorage.getItem(this.STORAGE_KEYS[dept]);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            this.departmentData[dept] = parsed;
                            console.log(`${dept} データ読み込み成功`);
                        } catch (e) {
                            console.error(`Error parsing ${dept} data:`, e);
                            this.departmentData[dept] = null;
                        }
                    } else {
                        console.warn(`${dept} データが見つかりません`);
                        this.departmentData[dept] = null;
                    }
                });
            }

            // 役員報酬データ読み込み
            loadExecutiveData() {
                try {
                    const executiveSettings = localStorage.getItem(this.STORAGE_KEYS.executive);
                    if (executiveSettings) {
                        const settings = JSON.parse(executiveSettings);
                        
                        if (settings.monthlyCompensation && settings.welfare) {
                            this.executiveData = {
                                compensation: [...settings.monthlyCompensation],
                                welfare: [...settings.welfare],
                                lastUpdate: settings.lastUpdate,
                                metadata: settings.metadata
                            };
                            
                            console.log('役員報酬データ読み込み成功');
                        }
                    }
                } catch (error) {
                    console.error('役員報酬データ読み込みエラー:', error);
                }
            }

            // 統合PL計算
            calculateUnifiedPL() {
                // 統合データの初期化
                this.unifiedData = {
                    sales: Array(12).fill(0),
                    cogs: Array(12).fill(0),
                    expenses: {}
                };

                // 販管費19項目の初期化
                for (let i = 1; i <= 19; i++) {
                    this.unifiedData.expenses[i] = Array(12).fill(0);
                }

                // 各事業部データの統合
                Object.keys(this.departmentData).forEach(dept => {
                    const data = this.departmentData[dept];
                    if (data && data.metadata) {
                        // 売上・原価の統合
                        for (let month = 0; month < 12; month++) {
                            this.unifiedData.sales[month] += data.sales[month] || 0;
                            this.unifiedData.cogs[month] += data.cogs[month] || 0;
                        }

                        // 販管費19項目の統合
                        for (let expenseId = 1; expenseId <= 19; expenseId++) {
                            if (data.expenses && data.expenses[expenseId]) {
                                for (let month = 0; month < 12; month++) {
                                    this.unifiedData.expenses[expenseId][month] += 
                                        data.expenses[expenseId][month] || 0;
                                }
                            }
                        }
                    }
                });

                // 営業利益の計算
                this.calculateFinalProfit();
            }

            // 最終営業利益計算
            calculateFinalProfit() {
                this.monthlyOperatingProfit = Array(12).fill(0);
                this.cumulativeOperatingProfit = Array(12).fill(0);
                this.monthlyTotalExpenses = Array(12).fill(0);
                
                let cumulativeSum = 0;
                for (let month = 0; month < 12; month++) {
                    // 事業部販管費合計
                    let monthlyDeptExpenses = 0;
                    for (let expenseId = 1; expenseId <= 19; expenseId++) {
                        monthlyDeptExpenses += this.unifiedData.expenses[expenseId][month];
                    }

                    // 役員報酬追加
                    const executiveTotal = (this.executiveData.compensation[month] || 0) + 
                                          (this.executiveData.welfare[month] || 0);
                    
                    // 全社共通費追加
                    let commonExpenseTotal = 0;
                    Object.values(this.commonExpenseData).forEach(monthlyData => {
                        commonExpenseTotal += monthlyData[month];
                    });

                    // 月次全体販管費
                    this.monthlyTotalExpenses[month] = monthlyDeptExpenses + executiveTotal + commonExpenseTotal;

                    // 月次営業利益
                    const monthlySales = this.unifiedData.sales[month];
                    const monthlyCogs = this.unifiedData.cogs[month];
                    const monthlyGrossProfit = monthlySales - monthlyCogs;
                    this.monthlyOperatingProfit[month] = monthlyGrossProfit - this.monthlyTotalExpenses[month];
                    
                    // 累計営業利益
                    cumulativeSum += this.monthlyOperatingProfit[month];
                    this.cumulativeOperatingProfit[month] = cumulativeSum;
                }
            }

            // 全表示更新
            updateAllDisplays() {
                this.updateKPIs();
                this.updateMiniKPIs();
                this.updateCharts();
                this.updateTables();
                this.updateDepartmentStatus();
                this.updateCompensationTable();
            }

            // KPI更新
            updateKPIs() {
                const totalSales = this.unifiedData.sales.reduce((sum, val) => sum + val, 0);
                const totalExpenses = this.monthlyTotalExpenses.reduce((sum, val) => sum + val, 0);
                const totalOperatingProfit = this.monthlyOperatingProfit.reduce((sum, val) => sum + val, 0);
                const profitMargin = totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0;

                // 前年比計算
                const salesGrowth = ((totalSales - this.previousYearData.totalSales) / this.previousYearData.totalSales * 100).toFixed(1);
                const profitGrowth = ((totalOperatingProfit - this.previousYearData.totalProfit) / this.previousYearData.totalProfit * 100).toFixed(1);

                // KPI表示更新
                document.getElementById('kpi-sales').textContent = `${Math.round(totalSales).toLocaleString()}万円`;
                document.getElementById('kpi-expenses').textContent = `${Math.round(totalExpenses).toLocaleString()}万円`;
                document.getElementById('kpi-profit').textContent = `${Math.round(totalOperatingProfit).toLocaleString()}万円`;
                document.getElementById('kpi-margin').textContent = `${profitMargin.toFixed(1)}%`;
                
                document.getElementById('kpi-sales-change').textContent = `前年比 ${salesGrowth >= 0 ? '+' : ''}${salesGrowth}%`;
                document.getElementById('kpi-profit-change').textContent = `前年比 ${profitGrowth >= 0 ? '+' : ''}${profitGrowth}%`;
                
                // 前年比の色分け
                document.getElementById('kpi-sales-change').className = `kpi-change ${salesGrowth >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('kpi-profit-change').className = `kpi-change ${profitGrowth >= 0 ? 'positive' : 'negative'}`;
            }

            // ミニKPI更新
            updateMiniKPIs() {
                const totalSales = this.unifiedData.sales.reduce((sum, val) => sum + val, 0);
                const totalExpenses = this.monthlyTotalExpenses.reduce((sum, val) => sum + val, 0);
                const totalOperatingProfit = this.monthlyOperatingProfit.reduce((sum, val) => sum + val, 0);
                const profitMargin = totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0;

                document.getElementById('mini-kpi-sales').textContent = `${Math.round(totalSales).toLocaleString()}万円`;
                document.getElementById('mini-kpi-expenses').textContent = `${Math.round(totalExpenses).toLocaleString()}万円`;
                document.getElementById('mini-kpi-profit').textContent = `${Math.round(totalOperatingProfit).toLocaleString()}万円`;
                document.getElementById('mini-kpi-margin').textContent = `${profitMargin.toFixed(1)}%`;
            }

            // チャート更新
            updateCharts() {
                this.updateMainChart();
                this.updateDepartmentCharts();
            }

            // メインチャート更新
            updateMainChart() {
                const ctx = document.getElementById('main-chart');
                if (!ctx) return;

                if (this.charts.main) {
                    this.charts.main.destroy();
                }

                const months = ['7月','8月','9月','10月','11月','12月','1月','2月','3月','4月','5月','6月'];

                let datasets = [];
                
                if (this.currentChartMode === 'current') {
                    datasets = [
                        {
                            label: '月次売上高（万円）',
                            type: 'bar',
                            data: this.unifiedData.sales,
                            backgroundColor: 'rgba(52,152,219,0.7)',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: '月次販管費（万円）',
                            type: 'bar',
                            data: this.monthlyTotalExpenses,
                            backgroundColor: 'rgba(243,156,18,0.7)',
                            borderColor: '#f39c12',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: '営業利益累計（万円）',
                            type: 'line',
                            data: this.cumulativeOperatingProfit,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231,76,60,0.1)',
                            borderWidth: 4,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ];
                } else if (this.currentChartMode === 'comparison') {
                    // 前年比較モード（実装は省略）
                    datasets = [
                        {
                            label: '今期売上高（万円）',
                            type: 'bar',
                            data: this.unifiedData.sales,
                            backgroundColor: 'rgba(52,152,219,0.7)',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            yAxisID: 'y'
                        }
                        // 前年データは省略
                    ];
                }

                this.charts.main = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: months, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '統合PLシステム - 月次推移分析',
                                font: { size: 16, weight: 'bold' },
                                color: '#2c3e50'
                            },
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: { usePointStyle: true, font: {size: 12, weight: 'bold'} }
                            }
                        },
                        scales: {
                            x: { 
                                title: { display: true, text: '月度', font: {size: 14, weight: 'bold'} }
                            },
                            y: { 
                                type: 'linear', 
                                display: true, 
                                position: 'left',
                                title: { display: true, text: '売上高・販管費（万円）', font: {size: 14, weight: 'bold'}, color: '#3498db' },
                                ticks: { color: '#3498db', callback: function(value) { return value.toLocaleString(); } }
                            },
                            y1: { 
                                type: 'linear', 
                                display: true, 
                                position: 'right',
                                title: { display: true, text: '営業利益累計（万円）', font: {size: 14, weight: 'bold'}, color: '#e74c3c' },
                                ticks: { color: '#e74c3c', callback: function(value) { return value.toLocaleString(); } },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }

            // 事業部別チャート更新
            updateDepartmentCharts() {
                const departments = ['SR', 'W', 'RC', 'RCD'];
                const colors = { 'SR': '#C477CC', 'W': '#3498db', 'RC': '#27ae60', 'RCD': '#9b59b6' };
                const months = ['7','8','9','10','11','12','1','2','3','4','5','6'];

                departments.forEach(dept => {
                    const ctx = document.getElementById(`${dept.toLowerCase()}-chart`);
                    if (!ctx) return;

                    if (this.charts[dept.toLowerCase()]) {
                        this.charts[dept.toLowerCase()].destroy();
                    }

                    const data = this.departmentData[dept];
                    let salesData = Array(12).fill(0);
                    
                    if (data && data.sales) {
                        salesData = data.sales;
                    }

                    this.charts[dept.toLowerCase()] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: [{
                                label: '月次売上',
                                data: salesData,
                                backgroundColor: colors[dept] + '77',
                                borderColor: colors[dept],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false }
                            },
                            scales: { 
                                x: { ticks: { font: {size: 10} } },
