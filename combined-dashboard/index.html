<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統合PL v4.0 - リアルタイム監視・整合性チェック対応版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: #333;
            background: linear-gradient(135deg, #fdf2e9 0%, #fcf3cf 100%);
            min-height: 100vh;
        }

        /* 4行ヘッダー構造 */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* 1行目: タイトル */
        .header-row1 {
            background: linear-gradient(135deg, #fdf2e9 0%, #fcf3cf 100%);
            color: #8b4513;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-row1 h1 {
            font-size: 1.8em;
            margin: 0;
            color: #d35400;
            font-weight: bold;
        }

        .version-badge {
            background: rgba(243, 156, 18, 0.15);
            color: #d35400;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8em;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        /* 2行目: グローバルナビゲーション */
        .header-row2 {
            background: linear-gradient(135deg, #fdf2e9 0%, #fcf3cf 100%);
            padding: 8px 15px;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .btn {
            flex: 1;
            min-width: 140px;
            max-width: 180px;
            padding: 8px 16px;
            font-size: 0.8em;
            border-radius: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: #8b4513;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn-active-analysis { 
            background: #f39c12 !important; 
            color: white !important;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        /* 3行目: KPIカード */
        .header-row3 {
            background: #fef9f3;
            padding: 12px 15px;
        }

        .kpi-cards {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 10px 15px;
            min-width: 120px;
            text-align: center;
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        .kpi-label {
            font-size: 0.7em;
            color: #d35400;
            font-weight: bold;
        }

        .kpi-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #e67e22;
        }

        /* CSVエクスポートカード */
        .csv-export-card {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 2px solid #27ae60 !important;
            min-width: 140px;
        }

        .csv-export-card .kpi-label {
            color: #155724;
            margin-bottom: 8px;
        }

        .csv-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .csv-btn:hover {
            background: linear-gradient(135deg, #219a52, #27ae60);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
        }

        /* 4行目: ステータス情報 */
        .header-row4 {
            background: #fdf2e9;
            padding: 10px 15px;
            text-align: center;
        }

        .status-info {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .department-description {
            font-size: 0.9em;
            color: #8b4513;
            font-weight: bold;
        }

        /* 通知システム */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 350px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-left: 4px solid #27ae60;
            color: #155724;
        }

        .notification-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left: 4px solid #f39c12;
            color: #856404;
        }

        .notification-error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }

        .container {
            max-width: 1400px;
            margin: 15px auto;
            padding: 0 15px;
        }

        /* データ受信状況テーブル */
        .status-section {
            background: rgba(253, 242, 233, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid rgba(243, 156, 18, 0.2);
        }

        .status-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .status-table th,
        .status-table td {
            padding: 10px 15px;
            text-align: center;
            border: 1px solid #fce4d6;
        }

        .status-table th {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            font-weight: bold;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-completed { background-color: #27ae60; }
        .status-pending { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }

        /* チャート表示 */
        .chart-container {
            background: rgba(253, 242, 233, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: 450px;
            border: 2px solid rgba(243, 156, 18, 0.2);
        }

        .section-title {
            font-size: 1.3em;
            color: #d35400;
            margin-bottom: 15px;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 8px;
        }

        /* 統一テーブルスタイル */
        .pl-section {
            background: rgba(253, 242, 233, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid rgba(243, 156, 18, 0.2);
        }

        .unified-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            margin-bottom: 15px;
        }

        .unified-table th,
        .unified-table td {
            padding: 4px;
            text-align: right;
            border-bottom: 1px solid #fce4d6;
            border-right: 1px solid #fdf2e9;
        }

        .unified-table .id-column {
            width: 25px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            padding: 4px 2px;
        }

        .unified-table th:nth-child(2),
        .unified-table td:nth-child(2) {
            text-align: left;
            font-weight: bold;
            width: 120px;
            padding: 4px 8px;
        }

        .unified-table th:nth-child(n+3):nth-child(-n+14),
        .unified-table td:nth-child(n+3):nth-child(-n+14) {
            width: calc((100% - 25px - 120px - 80px) / 12);
            min-width: 50px;
            padding: 4px 6px;
        }

        .unified-table th:last-child,
        .unified-table td:last-child {
            width: 80px;
            font-weight: bold;
            background-color: #fef9f3;
            padding: 4px 6px;
        }

        .unified-table th {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 6px 4px;
        }

        .total-row {
            background-color: #fef9f3;
            font-weight: bold;
            border-top: 2px solid #f39c12;
        }

        .profit-row {
            background-color: #e8f5e8;
            font-weight: bold;
            color: #155724;
        }

        .admin-expense-row:nth-child(even) {
            background-color: #fefbf7;
        }

        .admin-expense-row:hover {
            background-color: #fcf3cf;
        }

        /* 役員報酬セクション強化 */
        .executive-section {
            background: rgba(253, 242, 233, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid rgba(39, 174, 96, 0.3);
        }

        .executive-section .section-title {
            border-bottom-color: #27ae60;
            color: #27ae60;
        }

        .executive-section .unified-table th {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .executive-row {
            background-color: #e8f5e8;
        }

        .summary-section {
            background: rgba(253, 242, 233, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid #e74c3c;
        }

        .summary-section .section-title {
            border-bottom-color: #e74c3c;
            color: #e74c3c;
        }

        .summary-section .unified-table th {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .final-profit-positive {
            background-color: #e8f5e8;
            color: #155724;
            font-weight: bold;
        }

        .final-profit-negative {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        /* 監視パネル - フッター情報として統合 */
        .monitoring-section {
            background: rgba(253, 242, 233, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid rgba(52, 152, 219, 0.3);
        }

        .monitoring-section .section-title {
            border-bottom-color: #3498db;
            color: #3498db;
        }

        .monitoring-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            font-size: 0.85em;
        }

        .dept-status-grid {
            display: flex;
            gap: 12px;
        }

        .dept-status-item {
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
            min-width: 90px;
        }

        .dept-status-complete {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #27ae60;
            color: #155724;
        }

        .dept-status-waiting {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #f39c12;
            color: #856404;
        }

        .dept-status-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border: 1px solid #e74c3c;
            color: #721c24;
        }

        .dept-name {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        .quality-score {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .monitoring-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .monitor-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .monitor-btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .monitor-btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #1f6391);
            transform: translateY(-1px);
        }

        .monitor-btn-toggle {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .monitor-btn-toggle.disabled {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .monitor-btn-toggle:hover {
            background: linear-gradient(135deg, #219a52, #27ae60);
            transform: translateY(-1px);
        }

        .last-update-time {
            font-size: 0.75em;
            color: #666;
            font-weight: 500;
        }

        .data-source {
            font-size: 0.8em;
            color: #8b4513;
            margin-top: 10px;
            text-align: center;
        }

        /* レスポンシブ対応 */
        @media (max-width: 1024px) {
            .monitoring-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .dept-status-grid {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .header-row1 {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .header-row1 h1 {
                font-size: 1.5em;
            }
            
            .unified-table {
                font-size: 0.7em;
            }
            
            .unified-table th,
            .unified-table td {
                padding: 3px 2px;
            }

            .kpi-cards {
                gap: 10px;
            }
            
            .dept-status-grid {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }
            
            .dept-status-item {
                min-width: 80px;
                padding: 6px 10px;
            }
            
            .monitoring-controls {
                flex-direction: column;
                gap: 8px;
            }
        }

        /* スクロール用コンテナ */
        .table-scroll {
            overflow-x: auto;
            margin: -5px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <!-- 1行目: タイトル -->
        <div class="header-row1">
            <h1>統合PLシステム v4.0</h1>
            <div class="version-badge">リアルタイム監視・整合性チェック対応版</div>
        </div>

        <!-- 2行目: グローバルナビゲーション -->
        <div class="header-row2">
            <div class="nav-buttons">
                <a href="../index.html" class="btn">ダッシュボード</a>
                <a href="../department-pl/sr-pl.html" class="btn">SR事業部PL</a>
                <a href="../department-pl/w-pl.html" class="btn">W事業部PL</a>
                <a href="../department-pl/rc-pl.html" class="btn">RC事業部PL</a>
                <a href="../department-pl/rcd-pl.html" class="btn">RCD事業部PL</a>
                <a href="#" class="btn btn-active-analysis">統合PLシステム</a>
            </div>
        </div>

        <!-- 3行目: KPIカード + CSVエクスポート -->
        <div class="header-row3">
            <div class="kpi-cards">
                <div class="kpi-card">
                    <div class="kpi-label">統合売上高</div>
                    <div class="kpi-value" id="totalSalesKPI">---</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">全体販管費</div>
                    <div class="kpi-value" id="totalExpensesKPI">---</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">全体営業利益</div>
                    <div class="kpi-value" id="operatingProfitKPI">---</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">利益率</div>
                    <div class="kpi-value" id="profitMarginKPI">---%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">役員報酬計</div>
                    <div class="kpi-value" id="executiveCompKPI">---万円</div>
                </div>
                <div class="kpi-card csv-export-card">
                    <div class="kpi-label">データエクスポート</div>
                    <button class="csv-btn" onclick="exportUnifiedCSV()">CSVエクスポート</button>
                </div>
            </div>
        </div>

        <!-- 4行目: ステータス情報 -->
        <div class="header-row4">
            <div class="status-info">
                <div class="department-description">統合PLシステム v4.0 - 4事業部統合分析・リアルタイム監視対応</div>
                <div id="lastUpdate" class="data-source">最終更新: 自動取得中...</div>
            </div>
        </div>
    </div>

    <!-- 通知表示エリア -->
    <div id="notification" class="notification"></div>

    <div class="container">
        <!-- 事業部データ受信状況 -->
        <div class="status-section">
            <h2 class="section-title">事業部別データ受信状況</h2>
            <table class="status-table">
                <thead>
                    <tr>
                        <th>SR事業部</th>
                        <th>W事業部</th>
                        <th>RC事業部</th>
                        <th>RCD事業部</th>
                        <th>全体進捗</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <span class="status-indicator" id="srStatusIndicator"></span>
                            <div id="srLastUpdate">未受信</div>
                        </td>
                        <td>
                            <span class="status-indicator" id="wStatusIndicator"></span>
                            <div id="wLastUpdate">未受信</div>
                        </td>
                        <td>
                            <span class="status-indicator" id="rcStatusIndicator"></span>
                            <div id="rcLastUpdate">未受信</div>
                        </td>
                        <td>
                            <span class="status-indicator" id="rcdStatusIndicator"></span>
                            <div id="rcdLastUpdate">未受信</div>
                        </td>
                        <td>
                            <strong id="overallProgress">0/4完了</strong>
                            <br>
                            <span id="progressPercentage">0%</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 月次推移グラフ -->
        <div class="chart-container">
            <h2 class="section-title">月次推移グラフ（売上・販管費・営業利益累計）</h2>
            <canvas id="salesChart"></canvas>
        </div>

        <!-- 統合損益計算書 -->
        <div class="pl-section">
            <h2 class="section-title">統合損益計算書・販管費19項目詳細（7月開始年度）</h2>
            <div class="table-scroll">
                <table class="unified-table" id="combinedPLTable">
                    <thead>
                        <tr>
                            <th class="id-column">ID</th>
                            <th>項目名</th>
                            <th>7月</th>
                            <th>8月</th>
                            <th>9月</th>
                            <th>10月</th>
                            <th>11月</th>
                            <th>12月</th>
                            <th>1月</th>
                            <th>2月</th>
                            <th>3月</th>
                            <th>4月</th>
                            <th>5月</th>
                            <th>6月</th>
                            <th>年間合計</th>
                        </tr>
                    </thead>
                    <tbody id="combinedPLBody">
                        <!-- 動的に生成される統合PLデータ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 役員報酬 -->
        <div class="executive-section">
            <h2 class="section-title">役員報酬（ダッシュボード連携強化版）</h2>
            <div class="table-scroll">
                <table class="unified-table" id="executiveTable">
                    <thead>
                        <tr>
                            <th class="id-column"></th>
                            <th>項目名</th>
                            <th>7月</th>
                            <th>8月</th>
                            <th>9月</th>
                            <th>10月</th>
                            <th>11月</th>
                            <th>12月</th>
                            <th>1月</th>
                            <th>2月</th>
                            <th>3月</th>
                            <th>4月</th>
                            <th>5月</th>
                            <th>6月</th>
                            <th>年間合計</th>
                        </tr>
                    </thead>
                    <tbody id="executiveBody">
                        <!-- 動的に生成される役員報酬データ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- RC全体集計 -->
        <div class="summary-section">
            <h2 class="section-title">RC全体集計</h2>
            <div class="table-scroll">
                <table class="unified-table" id="summaryTable">
                    <thead>
                        <tr>
                            <th class="id-column"></th>
                            <th>項目名</th>
                            <th>7月</th>
                            <th>8月</th>
                            <th>9月</th>
                            <th>10月</th>
                            <th>11月</th>
                            <th>12月</th>
                            <th>1月</th>
                            <th>2月</th>
                            <th>3月</th>
                            <th>4月</th>
                            <th>5月</th>
                            <th>6月</th>
                            <th>年間合計</th>
                        </tr>
                    </thead>
                    <tbody id="summaryBody">
                        <!-- 動的に生成される集計データ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- データ受信・整合性監視（フッター情報として統合） -->
        <div class="monitoring-section">
            <h2 class="section-title">データ受信・整合性監視</h2>
            <div class="monitoring-content">
                <div class="dept-status-grid">
                    <div class="dept-status-item dept-status-waiting" id="statusSR">
                        <div class="dept-name">SR事業部</div>
                        <div class="quality-score" id="qualitySR">品質: ---%</div>
                    </div>
                    <div class="dept-status-item dept-status-waiting" id="statusW">
                        <div class="dept-name">W事業部</div>
                        <div class="quality-score" id="qualityW">品質: ---%</div>
                    </div>
                    <div class="dept-status-item dept-status-waiting" id="statusRC">
                        <div class="dept-name">RC事業部</div>
                        <div class="quality-score" id="qualityRC">品質: ---%</div>
                    </div>
                    <div class="dept-status-item dept-status-waiting" id="statusRCD">
                        <div class="dept-name">RCD事業部</div>
                        <div class="quality-score" id="qualityRCD">品質: ---%</div>
                    </div>
                </div>

                <div class="monitoring-controls">
                    <button class="monitor-btn monitor-btn-primary" onclick="manualUpdate()">手動更新</button>
                    <button class="monitor-btn monitor-btn-toggle" id="autoToggleBtn" onclick="toggleAutoUpdate()">自動更新:ON</button>
                </div>

                <div class="last-update-time" id="monitorLastUpdate">
                    最終更新: --:--:--
                </div>
            </div>
        </div>
    </div>

    <script>
        // 統合PLシステム v4.0 - リアルタイム監視・整合性チェック対応版
        class EnhancedPLManager {
            constructor() {
                // 修正済みLocalStorageキー構造（v4.0対応）
                this.STORAGE_KEYS = {
                    'SR': 'pl_system_sr_corrected_data',
                    'W': 'pl_system_w_corrected_data', 
                    'RC': 'pl_system_rc_corrected_data',
                    'RCD': 'pl_system_rcd_corrected_data',
                    'executive': 'executive_compensation_csv_settings'
                };

                // 販管費19項目統一構造マッピング
                this.EXPENSE_ITEMS = {
                    1: '人件費統合',
                    2: '法定福利費',
                    3: '衛生費',
                    4: '物流管理費',
                    5: '地代家賃',
                    6: '外注費',
                    7: '貨物運賃',
                    8: '広告宣伝費',
                    9: '旅費交通費',
                    10: '通信費',
                    11: '販売促進費',
                    12: '消耗品費',
                    13: '事務用品費',
                    14: '水道光熱費',
                    15: '支払手数料',
                    16: 'リース料',
                    17: '保険料',
                    18: '支払報酬料',
                    19: '減価償却費'
                };

                // 品質チェック項目（各20点満点）
                this.QUALITY_CHECKS = {
                    departmentMatch: 20,
                    dataProtection: 15,
                    salesData: 25,
                    cogsData: 20,
                    annualData: 20
                };

                // 全社共通費データ（万円単位・CSV更新対応）
                this.commonExpenseData = {
                    '管理諸費': [34, 37, 41, 34, 37, 44, 36, 39, 44, 36, 39, 44],
                    '修繕費': [22, 0, 1, 0, 0, 12, 13, 0, 7, 0, 3, 0],
                    '車両費': [2, 2, 1, 2, 3, 2, 2, 0, 19, 2, 4, 1],
                    '租税公課': [3, 3, 2, 1, 1, 1, 7, 2, 1, 12, 2, 5],
                    '交際費': [0, 1, 0, 2, 1, 0, 2, 4, 14, 1, 1, 9],
                    '諸会費': [1, 1, 1, 1, 1, 1, 0, 1, 18, 5, 2, 1],
                    '会議費': [0, 2, 2, 0, 2, 3, 1, 3, 1, 2, 1, 3],
                    '福利厚生費': [1, 1, 1, 1, 1, 2, 1, 1, 1, 2, 2, 2],
                    '研修費': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0],
                    '雑費': [1, 1, 1, 0, 0, 0, 0, 0, 0, 5, 0, 0],
                    '寄付金': [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0]
                };

                // 監視システム設定
                this.autoUpdateEnabled = true;
                this.monitoringInterval = null;

                this.initializeSystem();
            }

            initializeSystem() {
                console.log('統合PLシステム v4.0 初期化開始');
                this.loadAllDepartmentData();
                this.loadExecutiveDataFromDashboard();
                this.calculateUnifiedPL();
                this.updateDisplay();
                this.startMonitoring();
                this.showNotification('システム初期化完了', 'success');
            }

            // リアルタイム監視システム
            startMonitoring() {
                this.monitoringInterval = setInterval(() => {
                    if (this.autoUpdateEnabled) {
                        this.checkAllDepartments();
                        this.loadAllDepartmentData();
                        this.loadExecutiveDataFromDashboard();
                        this.calculateUnifiedPL();
                        this.updateDisplay();
                        this.updateMonitoringPanel();
                    }
                }, 5000); // 5秒間隔

                console.log('リアルタイム監視システム開始');
            }

            // 全事業部データチェック
            checkAllDepartments() {
                const departments = ['SR', 'W', 'RC', 'RCD'];
                let issuesFound = [];

                departments.forEach(dept => {
                    const data = this.loadDepartmentData(dept);
                    const quality = this.calculateQualityScore(data, dept);
                    
                    if (quality < 80) {
                        issuesFound.push(`${dept}事業部: 品質スコア${quality}%`);
                    }
                });

                if (issuesFound.length > 0) {
                    this.showNotification(`品質警告: ${issuesFound.join(', ')}`, 'warning');
                }
            }

            // データ品質スコア算出
            calculateQualityScore(data, dept) {
                if (!data) return 0;

                let score = 0;
                
                // 部署情報一致チェック（20点）
                if (data.metadata && data.metadata.department === dept) {
                    score += this.QUALITY_CHECKS.departmentMatch;
                }

                // データ保護状況チェック（15点）
                if (data.metadata && data.metadata.dataProtectionEnabled) {
                    score += this.QUALITY_CHECKS.dataProtection;
                }

                // 売上データ完全性チェック（25点）
                if (data.sales && Array.isArray(data.sales) && data.sales.length === 12) {
                    const validSales = data.sales.filter(val => typeof val === 'number' && val >= 0);
                    score += Math.round((validSales.length / 12) * this.QUALITY_CHECKS.salesData);
                }

                // 原価データ完全性チェック（20点）
                if (data.cogs && Array.isArray(data.cogs) && data.cogs.length === 12) {
                    const validCogs = data.cogs.filter(val => typeof val === 'number' && val >= 0);
                    score += Math.round((validCogs.length / 12) * this.QUALITY_CHECKS.cogsData);
                }

                // 年間集計データチェック（20点）
                if (data.annual && typeof data.annual === 'object') {
                    const requiredFields = ['totalSales', 'totalCogs', 'grossProfit', 'operatingProfit'];
                    const validFields = requiredFields.filter(field => 
                        data.annual[field] !== undefined && typeof data.annual[field] === 'number'
                    );
                    score += Math.round((validFields.length / requiredFields.length) * this.QUALITY_CHECKS.annualData);
                }

                return Math.min(100, score);
            }

            // 統一キーでのデータ読み込み
            loadAllDepartmentData() {
                this.departmentData = {};
                
                Object.keys(this.STORAGE_KEYS).forEach(dept => {
                    if (dept === 'executive') return;
                    
                    this.departmentData[dept] = this.loadDepartmentData(dept);
                });
            }

            loadDepartmentData(dept) {
                const data = localStorage.getItem(this.STORAGE_KEYS[dept]);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        console.log(`${dept} データ読み込み成功:`, parsed.metadata || 'メタデータなし');
                        return parsed;
                    } catch (e) {
                        console.error(`Error parsing ${dept} data:`, e);
                        return null;
                    }
                } else {
                    console.warn(`${dept} データが見つかりません (キー: ${this.STORAGE_KEYS[dept]})`);
                    return null;
                }
            }

            // 役員報酬データ強化読み込み
            loadExecutiveDataFromDashboard() {
                try {
                    const executiveSettings = localStorage.getItem(this.STORAGE_KEYS.executive);
                    if (executiveSettings) {
                        const settings = JSON.parse(executiveSettings);
                        
                        if (settings.monthlyCompensation && settings.welfare) {
                            this.executiveData = {
                                compensation: [...settings.monthlyCompensation],
                                welfare: [...settings.welfare],
                                lastUpdate: settings.lastUpdate,
                                metadata: settings.metadata
                            };
                            
                            console.log('Executive data loaded from dashboard:', {
                                totalCompensation: this.executiveData.compensation.reduce((sum, val) => sum + val, 0),
                                totalWelfare: this.executiveData.welfare.reduce((sum, val) => sum + val, 0),
                                version: settings.metadata?.version
                            });
                        } else {
                            throw new Error('データ構造が無効です');
                        }
                    } else {
                        // デフォルトデータ（ダッシュボード未連携時）
                        this.executiveData = {
                            compensation: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676],
                            welfare: [107, 107, 107, 88, 88, 88, 88, 88, 88, 88, 88, 88],
                            lastUpdate: new Date().toISOString(),
                            metadata: { version: 'default' }
                        };
                    }
                } catch (error) {
                    console.error('役員報酬データ取得エラー:', error);
                    
                    // エラー時デフォルトデータ
                    this.executiveData = {
                        compensation: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676],
                        welfare: [107, 107, 107, 88, 88, 88, 88, 88, 88, 88, 88, 88],
                        lastUpdate: new Date().toISOString(),
                        metadata: { version: 'error_fallback' }
                    };
                }
            }

            calculateUnifiedPL() {
                // 統合データの初期化（7月開始の12ヶ月）
                this.unifiedData = {
                    sales: Array(12).fill(0),
                    cogs: Array(12).fill(0),
                    expenses: {}
                };

                // 販管費19項目の初期化
                for (let i = 1; i <= 19; i++) {
                    this.unifiedData.expenses[i] = Array(12).fill(0);
                }

                // 各事業部データの統合
                Object.keys(this.departmentData).forEach(dept => {
                    const data = this.departmentData[dept];
                    if (data && data.metadata) {
                        console.log(`${dept} データを統合中... バージョン:`, data.metadata.version);
                        
                        // 売上・原価の統合
                        for (let month = 0; month < 12; month++) {
                            this.unifiedData.sales[month] += data.sales[month] || 0;
                            this.unifiedData.cogs[month] += data.cogs[month] || 0;
                        }

                        // 販管費19項目の統合
                        for (let expenseId = 1; expenseId <= 19; expenseId++) {
                            if (data.expenses && data.expenses[expenseId]) {
                                for (let month = 0; month < 12; month++) {
                                    this.unifiedData.expenses[expenseId][month] += 
                                        data.expenses[expenseId][month] || 0;
                                }
                            }
                        }
                    } else {
                        console.warn(`${dept} データが無効または古い形式です`);
                    }
                });

                // 営業利益と累計営業利益の計算（役員報酬・共通費含む）
                this.calculateFinalProfit();
            }

            calculateFinalProfit() {
                // 各月の営業利益計算（全社共通費含む）
                this.monthlyOperatingProfit = Array(12).fill(0);
                this.cumulativeOperatingProfit = Array(12).fill(0);
                this.monthlyTotalExpenses = Array(12).fill(0);
                
                let cumulativeSum = 0;
                for (let month = 0; month < 12; month++) {
                    // 月次販管費合計（事業部分）
                    let monthlyDeptExpenses = 0;
                    for (let expenseId = 1; expenseId <= 19; expenseId++) {
                        monthlyDeptExpenses += this.unifiedData.expenses[expenseId][month];
                    }

                    // 役員報酬追加（ダッシュボードから受信・万円単位）
                    const executiveTotal = (this.executiveData.compensation[month] || 0) + 
                                          (this.executiveData.welfare[month] || 0);
                    
                    // 全社共通費追加（万円単位）
                    let commonExpenseTotal = 0;
                    Object.values(this.commonExpenseData).forEach(monthlyData => {
                        commonExpenseTotal += monthlyData[month];
                    });

                    // 月次全体販管費
                    this.monthlyTotalExpenses[month] = monthlyDeptExpenses + executiveTotal + commonExpenseTotal;

                    // 月次営業利益
                    const monthlySales = this.unifiedData.sales[month];
                    const monthlyCogs = this.unifiedData.cogs[month];
                    const monthlyGrossProfit = monthlySales - monthlyCogs;
                    this.monthlyOperatingProfit[month] = monthlyGrossProfit - this.monthlyTotalExpenses[month];
                    
                    // 累計営業利益
                    cumulativeSum += this.monthlyOperatingProfit[month];
                    this.cumulativeOperatingProfit[month] = cumulativeSum;
                }
            }

            updateDisplay() {
                this.updateKPICards();
                this.updateCombinedPLTable();
                this.updateExecutiveTable();
                this.updateSummaryTable();
                this.updateDepartmentStatus();
                this.updateChart();
                this.updateLastUpdate();
                this.updateMonitoringPanel();
            }

            updateKPICards() {
                // KPIカードの更新
                const totalSales = this.unifiedData.sales.reduce((sum, val) => sum + val, 0);
                const totalExpenses = this.monthlyTotalExpenses.reduce((sum, val) => sum + val, 0);
                const totalOperatingProfit = this.monthlyOperatingProfit.reduce((sum, val) => sum + val, 0);
                const profitMargin = totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0;
                
                // 役員報酬合計の追加表示
                const totalExecutiveComp = this.executiveData.compensation.reduce((sum, val) => sum + val, 0) + 
                                         this.executiveData.welfare.reduce((sum, val) => sum + val, 0);

                document.getElementById('totalSalesKPI').textContent = `${Math.round(totalSales).toLocaleString()}万円`;
                document.getElementById('totalExpensesKPI').textContent = `${Math.round(totalExpenses).toLocaleString()}万円`;
                document.getElementById('operatingProfitKPI').textContent = `${Math.round(totalOperatingProfit).toLocaleString()}万円`;
                document.getElementById('profitMarginKPI').textContent = `${profitMargin.toFixed(1)}%`;
                document.getElementById('executiveCompKPI').textContent = `${Math.round(totalExecutiveComp).toLocaleString()}万円`;
            }

            // 監視パネル更新
            updateMonitoringPanel() {
                const departments = ['SR', 'W', 'RC', 'RCD'];
                
                departments.forEach(dept => {
                    const data = this.loadDepartmentData(dept);
                    const quality = this.calculateQualityScore(data, dept);
                    const statusElement = document.getElementById(`status${dept}`);
                    
                    if (data && data.metadata) {
                        statusElement.className = 'dept-status-item dept-status-complete';
                        document.getElementById(`quality${dept}`).textContent = `品質: ${quality}%`;
                    } else {
                        statusElement.className = 'dept-status-item dept-status-waiting';
                        document.getElementById(`quality${dept}`).textContent = '品質: ---%';
                    }
                });

                // 最終更新時刻
                document.getElementById('monitorLastUpdate').textContent = 
                    `最終更新: ${new Date().toLocaleTimeString()}`;
            }

            updateCombinedPLTable() {
                const tbody = document.getElementById('combinedPLBody');
                tbody.innerHTML = '';

                // 売上行
                const salesRow = this.createUnifiedRow('', '売上高', this.unifiedData.sales, 'total-row');
                tbody.appendChild(salesRow);

                // 売上原価行
                const cogsRow = this.createUnifiedRow('', '売上原価', this.unifiedData.cogs, '');
                tbody.appendChild(cogsRow);

                // 売上総利益行
                const grossProfitData = this.unifiedData.sales.map((sales, i) => sales - this.unifiedData.cogs[i]);
                const grossProfitRow = this.createUnifiedRow('', '売上総利益', grossProfitData, 'profit-row');
                tbody.appendChild(grossProfitRow);

                // 販管費19項目詳細
                for (let expenseId = 1; expenseId <= 19; expenseId++) {
                    const expenseData = this.unifiedData.expenses[expenseId];
                    const expenseName = this.EXPENSE_ITEMS[expenseId];
                    
                    const row = this.createUnifiedRow(expenseId, expenseName, expenseData, 'admin-expense-row');
                    tbody.appendChild(row);
                }

                // 販管費合計行（事業部分のみ）
                const deptExpensesData = Array(12).fill(0);
                for (let month = 0; month < 12; month++) {
                    for (let expenseId = 1; expenseId <= 19; expenseId++) {
                        deptExpensesData[month] += this.unifiedData.expenses[expenseId][month];
                    }
                }
                const deptExpensesRow = this.createUnifiedRow('', '事業部販管費計', deptExpensesData, 'total-row');
                tbody.appendChild(deptExpensesRow);
            }

            updateExecutiveTable() {
                const tbody = document.getElementById('executiveBody');
                tbody.innerHTML = '';

                // 役員報酬行（ダッシュボードから受信・賞与含む）
                const compensationRow = this.createUnifiedRow('', '役員報酬', this.executiveData.compensation || [], 'executive-row');
                tbody.appendChild(compensationRow);

                // 法定福利費行（ダッシュボードから受信）
                const welfareRow = this.createUnifiedRow('', '法定福利費', this.executiveData.welfare || [], '');
                tbody.appendChild(welfareRow);
            }

            updateSummaryTable() {
                const tbody = document.getElementById('summaryBody');
                tbody.innerHTML = '';

                // RC全体販管費
                const totalExpensesRow = this.createUnifiedRow('', 'RC全体販管費', 
                    this.monthlyTotalExpenses, 'total-row');
                tbody.appendChild(totalExpensesRow);

                // 全体営業利益
                const operatingProfitClass = this.monthlyOperatingProfit.some(val => val < 0) ? 'final-profit-negative' : 'final-profit-positive';
                const operatingProfitRow = this.createUnifiedRow('', '全体営業利益', 
                    this.monthlyOperatingProfit, operatingProfitClass);
                tbody.appendChild(operatingProfitRow);
            }

            createUnifiedRow(id, label, data, className) {
                const row = document.createElement('tr');
                if (className) row.className = className;

                // IDカラム（統一レイアウト）
                const idCell = document.createElement('td');
                idCell.textContent = id;
                idCell.className = 'id-column';
                row.appendChild(idCell);

                // 項目名カラム（統一レイアウト）
                const labelCell = document.createElement('td');
                labelCell.textContent = label;
                row.appendChild(labelCell);

                // 月別データカラム（12ヶ月・統一レイアウト）
                let yearTotal = 0;
                for (let month = 0; month < 12; month++) {
                    const cell = document.createElement('td');
                    const value = data[month] || 0;
                    yearTotal += value;
                    // 万円単位として直接表示（除算不要）
                    const displayValue = Math.round(value);
                    cell.textContent = displayValue.toLocaleString();
                    row.appendChild(cell);
                }

                // 年間合計カラム（統一レイアウト）
                const totalCell = document.createElement('td');
                // 万円単位として直接表示
                totalCell.textContent = Math.round(yearTotal).toLocaleString();
                row.appendChild(totalCell);

                return row;
            }

            updateDepartmentStatus() {
                const departments = ['sr', 'w', 'rc', 'rcd'];
                let completedCount = 0;
                
                departments.forEach(dept => {
                    const deptUpper = dept.toUpperCase();
                    const statusElement = document.getElementById(`${dept}StatusIndicator`);
                    const updateElement = document.getElementById(`${dept}LastUpdate`);
                    
                    const data = this.departmentData[deptUpper];
                    
                    if (data && data.metadata) {
                        statusElement.className = 'status-indicator status-completed';
                        updateElement.textContent = new Date(data.metadata.lastUpdate).toLocaleString();
                        completedCount++;
                    } else {
                        statusElement.className = 'status-indicator status-pending';
                        updateElement.textContent = '未受信';
                    }
                });

                // 全体進捗の更新
                document.getElementById('overallProgress').textContent = `${completedCount}/4完了`;
                document.getElementById('progressPercentage').textContent = `${Math.round((completedCount / 4) * 100)}%`;
            }

            updateChart() {
                const ctx = document.getElementById('salesChart').getContext('2d');
                
                if (this.chart) {
                    this.chart.destroy();
                }

                const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
                
                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                type: 'bar',
                                label: '月次売上高（万円）',
                                data: this.unifiedData.sales,
                                backgroundColor: 'rgba(243, 156, 18, 0.7)',
                                borderColor: '#f39c12',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                type: 'bar',
                                label: 'RC全体販管費（万円）',
                                data: this.monthlyTotalExpenses,
                                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                borderColor: '#3498db',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                type: 'line',
                                label: '全体営業利益累計（万円）',
                                data: this.cumulativeOperatingProfit,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                borderWidth: 4,
                                fill: false,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '月次推移（売上・RC全体販管費・全体営業利益累計）',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: '#d35400'
                            },
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '売上高・販管費（万円）',
                                    color: '#d35400'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '営業利益累計（万円）',
                                    color: '#e74c3c'
                                },
                                grid: {
                                    drawOnChartArea: true,
                                }
                            }
                        }
                    }
                });
            }

            updateLastUpdate() {
                document.getElementById('lastUpdate').textContent = 
                    `最終更新: ${new Date().toLocaleString()}`;
            }

            // 通知システム
            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification notification-${type}`;
                notification.classList.add('show');

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // 手動更新機能
        function manualUpdate() {
            try {
                const manager = window.enhancedPLManager;
                if (manager) {
                    manager.loadAllDepartmentData();
                    manager.loadExecutiveDataFromDashboard();
                    manager.calculateUnifiedPL();
                    manager.updateDisplay();
                    manager.showNotification('手動更新完了', 'success');
                } else {
                    throw new Error('システムが初期化されていません');
                }
            } catch (error) {
                manager.showNotification(`更新エラー: ${error.message}`, 'error');
                console.error('Manual update error:', error);
            }
        }

        // 自動更新切り替え
        function toggleAutoUpdate() {
            const manager = window.enhancedPLManager;
            const toggleBtn = document.getElementById('autoToggleBtn');
            
            if (manager) {
                manager.autoUpdateEnabled = !manager.autoUpdateEnabled;
                
                if (manager.autoUpdateEnabled) {
                    toggleBtn.textContent = '自動更新:ON';
                    toggleBtn.classList.remove('disabled');
                    manager.showNotification('自動更新を有効にしました', 'success');
                } else {
                    toggleBtn.textContent = '自動更新:OFF';
                    toggleBtn.classList.add('disabled');
                    manager.showNotification('自動更新を無効にしました', 'warning');
                }
            }
        }

        // CSVエクスポート機能（統合PL版）
        function exportUnifiedCSV() {
            try {
                const manager = window.enhancedPLManager;
                if (!manager) {
                    alert('システムが初期化されていません。');
                    return;
                }

                // CSVエクスポートデータ生成（37項目統一仕様）
                const csvData = [];
                const months = ['項目名', '7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月', '年間合計'];
                csvData.push(months);

                // 基本PL項目（3項目）
                csvData.push(['売上高', ...manager.unifiedData.sales, manager.unifiedData.sales.reduce((sum, val) => sum + val, 0)]);
                csvData.push(['売上原価', ...manager.unifiedData.cogs, manager.unifiedData.cogs.reduce((sum, val) => sum + val, 0)]);
                
                const grossProfitData = manager.unifiedData.sales.map((sales, i) => sales - manager.unifiedData.cogs[i]);
                csvData.push(['売上総利益', ...grossProfitData, grossProfitData.reduce((sum, val) => sum + val, 0)]);

                // 販管費19項目
                for (let i = 1; i <= 19; i++) {
                    const expenseData = manager.unifiedData.expenses[i];
                    const expenseName = manager.EXPENSE_ITEMS[i];
                    const annual = expenseData.reduce((sum, val) => sum + val, 0);
                    csvData.push([expenseName, ...expenseData, annual]);
                }

                // 統合PL専用項目
                csvData.push(['役員報酬', ...manager.executiveData.compensation, manager.executiveData.compensation.reduce((sum, val) => sum + val, 0)]);
                csvData.push(['役員法定福利費', ...manager.executiveData.welfare, manager.executiveData.welfare.reduce((sum, val) => sum + val, 0)]);

                // 全社共通費11項目
                const commonExpenseNames = ['管理諸費', '修繕費', '車両費', '租税公課', '交際費', '諸会費', '会議費', '福利厚生費', '研修費', '雑費', '寄付金'];
                commonExpenseNames.forEach(name => {
                    const data = manager.commonExpenseData[name];
                    const annual = data.reduce((sum, val) => sum + val, 0);
                    csvData.push([name, ...data, annual]);
                });

                // 計算項目
                csvData.push(['販管費合計', ...manager.monthlyTotalExpenses, manager.monthlyTotalExpenses.reduce((sum, val) => sum + val, 0)]);
                csvData.push(['営業利益', ...manager.monthlyOperatingProfit, manager.monthlyOperatingProfit.reduce((sum, val) => sum + val, 0)]);

                // CSV文字列生成
                const csvString = '\uFEFF' + csvData.map(row => row.join(',')).join('\n');
                
                // ダウンロード実行
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `統合PL_v4.0_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                manager.showNotification('統合PLデータのCSVエクスポートが完了しました。', 'success');
                
            } catch (error) {
                const manager = window.enhancedPLManager;
                if (manager) {
                    manager.showNotification('CSVエクスポートでエラーが発生しました: ' + error.message, 'error');
                } else {
                    alert('CSVエクスポートでエラーが発生しました: ' + error.message);
                }
                console.error('CSVエクスポートエラー:', error);
            }
        }

        // システム初期化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('統合PLシステム v4.0 初期化開始');
            window.enhancedPLManager = new EnhancedPLManager();
        });
    </script>
</body>
</html>
