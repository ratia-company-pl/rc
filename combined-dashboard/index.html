<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4事業部統合PLシステム（シンプル版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9ff;
        }
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: transform 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        .kpi-card:nth-child(1) { border-left-color: #4CAF50; }
        .kpi-card:nth-child(2) { border-left-color: #2196F3; }
        .kpi-card:nth-child(3) { border-left-color: #FF9800; }
        .kpi-card:nth-child(4) { border-left-color: #9C27B0; }
        .kpi-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .kpi-change {
            font-size: 12px;
            color: #888;
        }
        .content-section {
            padding: 30px;
        }
        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4ECDC4;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
            color: white;
        }
        .btn-primary { background: #667eea; }
        .btn-success { background: #4CAF50; }
        .btn-info { background: #2196F3; }
        .btn-warning { background: #FF9800; }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            height: 400px;
        }
        .data-table {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9ff;
            font-weight: 600;
            color: #333;
        }
        td:first-child, th:first-child {
            text-align: left;
            font-weight: 600;
        }
        .positive { color: #4CAF50; }
        .negative { color: #f44336; }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>4事業部統合PLシステム</h1>
            <p class="subtitle">v3.0版 販管費動的統合対応 シンプル版</p>
        </div>

        <div class="kpi-section">
            <div class="kpi-card">
                <div class="kpi-label">統合年間売上</div>
                <div class="kpi-value" id="totalRevenue">0万円</div>
                <div class="kpi-change">全事業部統合</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">統合営業利益</div>
                <div class="kpi-value" id="totalProfit">0万円</div>
                <div class="kpi-change">変動費・固定費統合済</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">統合利益率</div>
                <div class="kpi-value" id="totalMargin">0.0%</div>
                <div class="kpi-change">業界平均5.2%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">データ統合状況</div>
                <div class="kpi-value" id="dataStatus">0/4</div>
                <div class="kpi-change">事業部データ統合</div>
            </div>
        </div>

        <div class="content-section">
            <h2 class="section-title">4事業部統合月次PL</h2>
            
            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="updateData()">データ統合更新</button>
                <button class="action-btn btn-success" onclick="exportCSV()">CSVエクスポート</button>
                <button class="action-btn btn-info" onclick="inspectData()">データ検査</button>
                <button class="action-btn btn-warning" onclick="toggleDebug()">デバッグ表示</button>
            </div>

            <div id="successMsg" class="message success-message"></div>
            <div id="errorMsg" class="message error-message"></div>
            <div id="debugInfo" class="debug-info"></div>

            <div class="chart-container">
                <canvas id="plChart"></canvas>
            </div>

            <div class="data-table">
                <h3>統合損益計算書（月次）</h3>
                <table>
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                            <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                            <th>年間計</th>
                        </tr>
                    </thead>
                    <tbody id="plTableBody">
                        <tr>
                            <td>データを読み込み中...</td>
                            <td colspan="13">統合処理を実行してください</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let plChart = null;
        let debugMode = false;
        let integrationData = {
            sales: new Array(12).fill(0),
            cogs: new Array(12).fill(0),
            personnel: new Array(12).fill(0),
            expenses: new Array(12).fill(0),
            lastUpdate: null,
            activeDepartments: 0
        };

        // ユーティリティ関数
        function formatNumber(num) {
            if (isNaN(num) || num === null || num === undefined) return '0';
            return Math.round(num).toLocaleString();
        }

        function showMessage(message, isError = false) {
            const successEl = document.getElementById('successMsg');
            const errorEl = document.getElementById('errorMsg');
            
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
                setTimeout(() => { errorEl.style.display = 'none'; }, 5000);
            } else {
                successEl.textContent = message;
                successEl.style.display = 'block';
                errorEl.style.display = 'none';
                setTimeout(() => { successEl.style.display = 'none'; }, 3000);
            }
        }

        function logDebug(message, data = null) {
            console.log(`[統合PL] ${message}`, data || '');
            if (debugMode) {
                const debugEl = document.getElementById('debugInfo');
                if (debugEl) {
                    const time = new Date().toLocaleTimeString();
                    debugEl.innerHTML += `<div>[${time}] ${message}${data ? ': ' + JSON.stringify(data, null, 2) : ''}</div>`;
                    debugEl.scrollTop = debugEl.scrollHeight;
                }
            }
        }

        // データ読み込み関数
        function loadDepartmentData(deptKey) {
            logDebug(`${deptKey}事業部データ読み込み開始`);
            
            const possibleKeys = [
                `pl_system_${deptKey}_data`,
                `${deptKey}_dashboard_data`,
                `${deptKey}_data`,
                `${deptKey}Data`,
                `${deptKey}Dashboard`
            ];
            
            for (const key of possibleKeys) {
                try {
                    const stored = localStorage.getItem(key);
                    if (stored && stored !== 'null') {
                        const data = JSON.parse(stored);
                        logDebug(`${deptKey}: データ取得成功 (${key})`, { hasData: !!data });
                        return convertDataStructure(data, deptKey);
                    }
                } catch (e) {
                    logDebug(`${deptKey}: ${key} 読み取りエラー`, e.message);
                }
            }
            
            logDebug(`${deptKey}: データなし`);
            return null;
        }

        function convertDataStructure(rawData, dept) {
            try {
                const result = {
                    sales: new Array(12).fill(0),
                    cogs: new Array(12).fill(0),
                    personnel: new Array(12).fill(0),
                    expenses: new Array(12).fill(0)
                };

                // パターン1: 完全なv3.0形式
                if (rawData.sales && Array.isArray(rawData.sales) && rawData.sales.length === 12) {
                    result.sales = rawData.sales.map(v => parseFloat(v) || 0);
                    result.cogs = rawData.cogs ? rawData.cogs.map(v => parseFloat(v) || 0) : result.cogs;
                    result.personnel = rawData.personnel ? rawData.personnel.map(v => parseFloat(v) || 0) : result.personnel;
                    result.expenses = rawData.expenses ? rawData.expenses.map(v => parseFloat(v) || 0) : result.expenses;
                    return result;
                }

                // パターン2: monthly配列
                if (rawData.monthly && Array.isArray(rawData.monthly)) {
                    rawData.monthly.slice(0, 12).forEach((month, i) => {
                        if (month && typeof month === 'object') {
                            result.sales[i] = parseFloat(month.sales || month.売上 || month.revenue || 0);
                            result.cogs[i] = parseFloat(month.cogs || month.原価 || month.cost || 0);
                            result.personnel[i] = parseFloat(month.personnel || month.人件費 || 0);
                            result.expenses[i] = parseFloat(month.expenses || month.経費 || 0);
                        }
                    });
                    return result;
                }

                // パターン3: 年間データ分割
                if (typeof rawData.sales === 'number' || rawData.annual) {
                    const annualSales = parseFloat(rawData.annual?.sales || rawData.sales || 0);
                    const annualCogs = parseFloat(rawData.annual?.cogs || rawData.cogs || 0);
                    const annualPersonnel = parseFloat(rawData.annual?.personnel || rawData.personnel || 0);
                    const annualExpenses = parseFloat(rawData.annual?.expenses || rawData.expenses || 0);
                    
                    if (annualSales > 0) {
                        for (let i = 0; i < 12; i++) {
                            result.sales[i] = Math.round(annualSales / 12);
                            result.cogs[i] = Math.round(annualCogs / 12);
                            result.personnel[i] = Math.round(annualPersonnel / 12);
                            result.expenses[i] = Math.round(annualExpenses / 12);
                        }
                        return result;
                    }
                }

                logDebug(`${dept}: データ構造変換失敗`);
                return null;
            } catch (error) {
                logDebug(`${dept}: データ変換エラー`, error.message);
                return null;
            }
        }

        // データ統合処理
        function integrateAllData() {
            logDebug('=== データ統合開始 ===');
            
            const departments = ['sr', 'w', 'rc', 'rcd'];
            let successCount = 0;
            
            // 初期化
            integrationData.sales.fill(0);
            integrationData.cogs.fill(0);
            integrationData.personnel.fill(0);
            integrationData.expenses.fill(0);
            
            departments.forEach(dept => {
                const deptData = loadDepartmentData(dept);
                if (deptData) {
                    successCount++;
                    for (let i = 0; i < 12; i++) {
                        integrationData.sales[i] += deptData.sales[i];
                        integrationData.cogs[i] += deptData.cogs[i];
                        integrationData.personnel[i] += deptData.personnel[i];
                        integrationData.expenses[i] += deptData.expenses[i];
                    }
                    logDebug(`${dept}事業部: 統合完了`);
                } else {
                    logDebug(`${dept}事業部: データなし`);
                }
            });
            
            integrationData.activeDepartments = successCount;
            integrationData.lastUpdate = new Date();
            
            logDebug('=== データ統合完了 ===', { successCount, totalDepartments: departments.length });
            return successCount > 0;
        }

        // UI更新関数
        function updateKPIs() {
            const totalSales = integrationData.sales.reduce((sum, val) => sum + val, 0);
            const totalCogs = integrationData.cogs.reduce((sum, val) => sum + val, 0);
            const totalPersonnel = integrationData.personnel.reduce((sum, val) => sum + val, 0);
            const totalExpenses = integrationData.expenses.reduce((sum, val) => sum + val, 0);
            
            const grossProfit = totalSales - totalCogs;
            const operatingProfit = grossProfit - totalPersonnel - totalExpenses;
            const profitRate = totalSales > 0 ? (operatingProfit / totalSales * 100) : 0;
            
            document.getElementById('totalRevenue').textContent = `${formatNumber(totalSales)}万円`;
            document.getElementById('totalProfit').textContent = `${formatNumber(operatingProfit)}万円`;
            document.getElementById('totalMargin').textContent = `${profitRate.toFixed(1)}%`;
            document.getElementById('dataStatus').textContent = `${integrationData.activeDepartments}/4`;
            
            // 色分け
            const profitEl = document.getElementById('totalProfit');
            profitEl.className = operatingProfit >= 0 ? 'kpi-value positive' : 'kpi-value negative';
            
            logDebug('KPI更新完了', { totalSales, operatingProfit, profitRate });
        }

        function updateChart() {
            const ctx = document.getElementById('plChart');
            if (!ctx) return;
            
            if (plChart) {
                plChart.destroy();
            }
            
            const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
            const monthlyProfit = integrationData.sales.map((sales, i) => {
                return sales - integrationData.cogs[i] - integrationData.personnel[i] - integrationData.expenses[i];
            });
            
            plChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '月次売上',
                            data: integrationData.sales,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: '月次営業利益',
                            data: monthlyProfit,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '4事業部統合PL推移'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '金額（万円）'
                            }
                        }
                    }
                }
            });
            
            logDebug('チャート更新完了');
        }

        function updateTable() {
            const tbody = document.getElementById('plTableBody');
            if (!tbody) return;
            
            const monthlyProfit = integrationData.sales.map((sales, i) => {
                return sales - integrationData.cogs[i] - integrationData.personnel[i] - integrationData.expenses[i];
            });
            
            const rows = [
                { label: '売上高', values: integrationData.sales, className: '' },
                { label: '売上原価', values: integrationData.cogs, className: 'negative' },
                { label: '人件費', values: integrationData.personnel, className: 'negative' },
                { label: '販管費', values: integrationData.expenses, className: 'negative' },
                { label: '営業利益', values: monthlyProfit, className: '' }
            ];
            
            tbody.innerHTML = rows.map(row => {
                const annual = row.values.reduce((sum, val) => sum + val, 0);
                const cells = [
                    `<td><strong>${row.label}</strong></td>`,
                    ...row.values.map(val => `<td class="${row.className}">${formatNumber(val)}</td>`),
                    `<td class="${row.className}"><strong>${formatNumber(annual)}</strong></td>`
                ];
                return `<tr>${cells.join('')}</tr>`;
            }).join('');
            
            logDebug('テーブル更新完了');
        }

        // ボタンアクション関数
        function updateData() {
            try {
                logDebug('手動データ更新開始');
                const success = integrateAllData();
                if (success) {
                    updateKPIs();
                    updateChart();
                    updateTable();
                    showMessage(`データ統合完了: ${integrationData.activeDepartments}/4事業部`);
                } else {
                    showMessage('データが見つかりません。各事業部のPLページでデータを保存してください。', true);
                }
            } catch (error) {
                logDebug('データ更新エラー', error.message);
                showMessage(`エラー: ${error.message}`, true);
            }
        }

        function exportCSV() {
            try {
                showMessage('CSV出力機能は開発中です。');
                logDebug('CSV出力要求');
            } catch (error) {
                showMessage(`CSV出力エラー: ${error.message}`, true);
            }
        }

        function inspectData() {
            try {
                let report = 'LocalStorage検査結果\n\n';
                const departments = ['sr', 'w', 'rc', 'rcd'];
                let totalKeys = 0;
                
                departments.forEach(dept => {
                    const possibleKeys = [
                        `pl_system_${dept}_data`,
                        `${dept}_dashboard_data`,
                        `${dept}_data`
                    ];
                    
                    let found = false;
                    possibleKeys.forEach(key => {
                        const data = localStorage.getItem(key);
                        if (data && data !== 'null') {
                            try {
                                const parsed = JSON.parse(data);
                                report += `✓ ${dept.toUpperCase()}事業部 (${key}): データあり (${(data.length/1024).toFixed(1)}KB)\n`;
                                found = true;
                                totalKeys++;
                            } catch (e) {
                                report += `✗ ${dept.toUpperCase()}事業部 (${key}): 解析エラー\n`;
                            }
                        }
                    });
                    
                    if (!found) {
                        report += `- ${dept.toUpperCase()}事業部: データなし\n`;
                    }
                });
                
                report += `\n統合可能事業部: ${totalKeys}/4`;
                alert(report);
                logDebug('データ検査完了', { totalKeys });
            } catch (error) {
                showMessage(`データ検査エラー: ${error.message}`, true);
            }
        }

        function toggleDebug() {
            try {
                debugMode = !debugMode;
                const debugEl = document.getElementById('debugInfo');
                if (debugEl) {
                    debugEl.style.display = debugMode ? 'block' : 'none';
                    if (debugMode) {
                        debugEl.innerHTML = '<div>デバッグモード開始</div>';
                    }
                }
                showMessage(debugMode ? 'デバッグモードを開始しました' : 'デバッグモードを終了しました');
                logDebug('デバッグモード切り替え', debugMode);
            } catch (error) {
                showMessage(`デバッグ切り替えエラー: ${error.message}`, true);
            }
        }

        // 初期化処理
        function initialize() {
            try {
                logDebug('=== システム初期化開始 ===');
                
                // Chart.js確認
                if (typeof Chart === 'undefined') {
                    logDebug('Chart.js未読み込み');
                }
                
                // データ統合実行
                const success = integrateAllData();
                if (success) {
                    updateKPIs();
                    updateChart();
                    updateTable();
                } else {
                    logDebug('初期データなし - デフォルト表示');
                    updateKPIs();
                    updateTable();
                }
                
                logDebug('=== システム初期化完了 ===');
            } catch (error) {
                logDebug('初期化エラー', error.message);
                console.error('初期化エラー:', error);
            }
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('DOM読み込み完了');
            setTimeout(initialize, 100);
        });

        // エラーキャッチ
        window.addEventListener('error', function(event) {
            logDebug('JavaScript Error:', event.error?.message || event.message);
            console.error('Global error:', event.error);
        });
    </script>
</body>
</html>
