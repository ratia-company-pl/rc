<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: #333;
            background: linear-gradient(135deg, #fdf2e9 0%, #fcf3cf 100%);
            min-height: 100vh;
        }

        .header-row1 {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 2.2em;
            font-weight: bold;
        }

        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.5em;
            margin-left: 10px;
        }

        .status-legend {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-connected { background-color: #27ae60; }
        .legend-pending { background-color: #f39c12; }
        .legend-error { background-color: #e74c3c; }

        .header-row2 {
            background: #ecf0f1;
            padding: 12px 20px;
            text-align: center;
        }

        .integration-status {
            display: flex;
            gap: 25px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .header-row3 {
            background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
            padding: 12px 20px;
        }

        .nav-container {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 180px;
            max-width: 220px;
            padding: 12px 20px;
            font-size: 0.9em;
            border-radius: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
            text-align: center;
            cursor: pointer;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-active-unified { 
            background: #f39c12 !important; 
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.6) !important;
        }

        .status-connected { background-color: #27ae60; }
        .status-pending { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }

        .data-source-indicator {
            text-align: center;
            font-size: 0.85em;
            color: #666;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            font-weight: 500;
        }

        .indicator-simulation {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .indicator-realdata {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        .unified-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid #3498db;
            border-radius: 25px;
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 0.95em;
        }

        .nav-tab:hover, .nav-tab.active {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 3px solid;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .kpi-card-sales { border-color: #3498db; }
        .kpi-card-expenses { border-color: #e67e22; }
        .kpi-card-profit { border-color: #27ae60; }
        .kpi-card-margin { border-color: #9b59b6; }

        .kpi-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .kpi-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .kpi-change {
            font-size: 0.75em;
            margin-top: 5px;
            font-weight: 600;
        }

        .kpi-change.positive { color: #27ae60; }
        .kpi-change.negative { color: #e74c3c; }

        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            font-weight: bold;
        }

        .section-title.red {
            border-bottom-color: #e74c3c;
            color: #e74c3c;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .chart-toggle {
            padding: 8px 16px;
            border: 2px solid #3498db;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85em;
        }

        .chart-toggle:hover, .chart-toggle.active {
            background: #3498db;
            color: white;
        }

        .dept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dept-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }

        .dept-sr { border-color: #C477CC; }
        .dept-w { border-color: #3498db; }
        .dept-rc { border-color: #27ae60; }
        .dept-rcd { border-color: #9b59b6; }

        .dept-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .dept-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .dept-status {
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dept-chart {
            height: 220px;
            padding: 10px;
        }

        .dept-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
        }

        .metric-item {
            text-align: center;
        }

        .metric-label {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 3px;
        }

        .metric-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-change {
            font-size: 0.7em;
            margin-top: 2px;
            font-weight: 600;
        }

        .metric-change.positive { color: #27ae60; }
        .metric-change.negative { color: #e74c3c; }

        .unified-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border: 2px solid #e67e22;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        .unified-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .unified-table th, .unified-table td {
            padding: 10px 8px;
            text-align: right;
            border: 1px solid #ddd;
        }

        .unified-table th {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .unified-table td:nth-child(2) {
            text-align: left;
            font-weight: 500;
            min-width: 120px;
        }

        .unified-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .unified-table tbody tr:hover {
            background-color: #fff3cd;
        }

        .unified-table .id-column {
            width: 30px;
            text-align: center;
            color: #999;
            font-size: 0.8em;
        }

        .unified-table .total-column {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            font-weight: bold;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #3498db;
        }

        .action-button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-calculate {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-apply {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-apply:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-save {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        .notification.success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .notification.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .notification.warning { background: linear-gradient(135deg, #f39c12, #e67e22); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .target-profit-section {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
            border: 2px solid #e74c3c;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .target-input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .allocation-result {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #27ae60;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .allocation-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .allocation-card h4 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .allocation-card .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .executive-section {
            background: linear-gradient(135deg, #f5f0ff 0%, #e8e0f0 100%);
            border: 2px solid #9b59b6;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .impact-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .impact-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #ddd;
        }

        .impact-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .impact-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .confirmed-month-section {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #27ae60;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .confirmed-month-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .month-checkbox-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .month-checkbox-item:hover {
            border-color: #27ae60;
        }

        .month-checkbox-item.confirmed {
            background: #27ae60;
            border-color: #27ae60;
            color: white;
        }

        .month-checkbox-item.budget {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        .month-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        .month-checkbox-item label {
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
        }

        .month-status-text {
            font-size: 0.7em;
            margin-top: 3px;
        }

        .row-highlight-sales {
            background-color: #e3f2fd !important;
        }

        .row-highlight-profit {
            background-color: #e8f5e9 !important;
        }

        .row-subtotal {
            background-color: #fff3cd !important;
            font-weight: bold;
        }

        .row-total {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auto-detect-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 10px;
        }

        .manual-mode-badge {
            display: inline-block;
            background: #e67e22;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 10px;
        }

        /* ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .data-refresh-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            z-index: 9999;
            display: none;
        }

        .data-refresh-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="data-refresh-indicator" class="data-refresh-indicator">ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­...</div>

    <!-- 3è¡Œãƒ˜ãƒƒãƒ€ãƒ¼æ§‹é€  -->
    <div class="header-row1">
        <h1 class="header-title">RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼<span class="version-badge">v6.2</span></h1>
        <div class="status-legend">
            <div class="legend-item">
                <div class="legend-dot legend-connected"></div>
                <span>æ¥ç¶šæ¸ˆã¿</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot legend-pending"></div>
                <span>å¾…æ©Ÿä¸­</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot legend-error"></div>
                <span>ã‚¨ãƒ©ãƒ¼</span>
            </div>
        </div>
    </div>

    <div class="header-row2">
        <div class="integration-status">
            <div class="status-item">
                <span class="status-indicator" id="sr-indicator"></span>
                <span>SRäº‹æ¥­éƒ¨</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="w-indicator"></span>
                <span>Wäº‹æ¥­éƒ¨</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="rc-indicator"></span>
                <span>RCäº‹æ¥­éƒ¨</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="rcd-indicator"></span>
                <span>RCDäº‹æ¥­éƒ¨</span>
            </div>
            <div class="status-item">
                <span class="status-indicator status-connected"></span>
                <span>çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ  v6.2</span>
            </div>
        </div>
    </div>

    <div class="header-row3">
        <div class="nav-container">
            <a href="../department-pl/sr-pl.html" class="btn">SRäº‹æ¥­éƒ¨PL</a>
            <a href="../department-pl/w-pl.html" class="btn">Wäº‹æ¥­éƒ¨PL</a>
            <a href="../department-pl/rc-pl.html" class="btn">RCäº‹æ¥­éƒ¨PL</a>
            <a href="../department-pl/rcd-pl.html" class="btn">RCDäº‹æ¥­éƒ¨PL</a>
            <a href="#" class="btn btn-active-unified">çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ </a>
        </div>
    </div>

    <div class="unified-header">
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showSection('overview')">æ¦‚è¦</div>
            <div class="nav-tab" onclick="showSection('target')">ç›®æ¨™åˆ©ç›Šé…åˆ†</div>
            <div class="nav-tab" onclick="showSection('executive')">å½¹å“¡å ±é…¬</div>
            <div class="nav-tab" onclick="showSection('departments')">äº‹æ¥­éƒ¨æ¯”è¼ƒ</div>
            <div class="nav-tab" onclick="showSection('analysis')">åˆ†æ</div>
            <div class="nav-tab" onclick="showSection('pl-details')">PLè©³ç´°</div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <div style="max-width: 1400px; margin: 0 auto; padding: 0 20px;">
        
        <!-- æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="overview-section" class="tab-content">
            <div class="kpi-dashboard">
                <div class="kpi-card kpi-card-sales">
                    <div class="kpi-label">çµ±åˆå£²ä¸Šé«˜</div>
                    <div class="kpi-value" id="kpi-sales">---</div>
                    <div class="kpi-change" id="kpi-sales-change">å‰å¹´æ¯” ---%</div>
                </div>
                <div class="kpi-card kpi-card-expenses">
                    <div class="kpi-label">å…¨ä½“è²©ç®¡è²»</div>
                    <div class="kpi-value" id="kpi-expenses">---</div>
                    <div class="kpi-change" id="kpi-expenses-change">å‰å¹´æ¯” ---%</div>
                </div>
                <div class="kpi-card kpi-card-profit">
                    <div class="kpi-label">å–¶æ¥­åˆ©ç›Š</div>
                    <div class="kpi-value" id="kpi-profit">---</div>
                    <div class="kpi-change" id="kpi-profit-change">å‰å¹´æ¯” ---%</div>
                </div>
                <div class="kpi-card kpi-card-margin">
                    <div class="kpi-label">åˆ©ç›Šç‡</div>
                    <div class="kpi-value" id="kpi-margin">---%</div>
                    <div class="kpi-change" id="kpi-margin-change">å‰å¹´æ¯” ---pt</div>
                </div>
            </div>

            <div class="chart-section">
                <h2 class="section-title" style="color: #e74c3c;">æœˆæ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•</h2>
                <div id="data-source-indicator" class="data-source-indicator indicator-simulation">
                    âš ï¸ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤è¡¨ç¤ºä¸­
                </div>
                <div class="chart-controls">
                    <button class="chart-toggle active" onclick="toggleChartMode('current')">å½“æœŸå®Ÿç¸¾</button>
                    <button class="chart-toggle" onclick="toggleChartMode('comparison')">å‰å¹´æ¯”è¼ƒ</button>
                </div>
                <div class="chart-container">
                    <canvas id="main-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- ç›®æ¨™åˆ©ç›Šé…åˆ†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="target-section" class="tab-content" style="display: none;">
            <div class="target-profit-section">
                <h2 class="section-title red">ç›®æ¨™åˆ©ç›Šé…åˆ†ææ¡ˆã‚·ã‚¹ãƒ†ãƒ </h2>
                
                <div class="target-input-group">
                    <div class="input-group">
                        <label class="input-label">ç›®æ¨™å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰</label>
                        <input type="number" class="input-field" id="target-profit" value="15000" step="100">
                    </div>
                    <div class="input-group">
                        <label class="input-label">é…åˆ†æ–¹å¼</label>
                        <select class="input-field" id="allocation-method">
                            <option value="sales">å£²ä¸Šæ¯”ä¾‹é…åˆ†</option>
                            <option value="profit">åˆ©ç›Šç‡æ¯”ä¾‹é…åˆ†</option>
                            <option value="equal">å‡ç­‰é…åˆ†</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">è¨ˆç®—åŸºæº–</label>
                        <select class="input-field" id="calculation-base">
                            <option value="current">å½“æœŸå®Ÿç¸¾</option>
                            <option value="previous">å‰å¹´å®Ÿç¸¾</option>
                            <option value="average">å¹³å‡å€¤</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="action-button btn-calculate" onclick="unifiedPLSystem.calculateTargetAllocation()">é…åˆ†è¨ˆç®—å®Ÿè¡Œ</button>
                </div>
                
                <div class="allocation-result" id="allocation-result">
                    <h3 style="color: #27ae60; margin-bottom: 15px;">é…åˆ†çµæœ</h3>
                    <div class="allocation-grid" id="allocation-grid"></div>
                </div>
            </div>
        </div>

        <!-- å½¹å“¡å ±é…¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="executive-section" class="tab-content" style="display: none;">
            <div class="executive-section">
                <h2 class="section-title" style="color: #9b59b6; border-bottom-color: #9b59b6;">å½¹å“¡å ±é…¬ç®¡ç†</h2>
                
                <div style="max-width: 300px; margin-bottom: 20px;">
                    <label style="font-weight: 600; color: #555;">å ±é…¬è¨­å®šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <div id="compensation-status" style="padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em; margin-top: 5px;">
                        åˆæœŸãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºä¸­
                    </div>
                </div>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="action-button btn-apply" onclick="saveCompensation()">å ±é…¬è¨­å®šã‚’ä¿å­˜</button>
                    <button class="action-button btn-calculate" onclick="loadCompensation()">ä¿å­˜ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
                </div>

                <div class="impact-summary">
                    <div class="impact-card">
                        <div class="impact-label">å¹´é–“å½¹å“¡å ±é…¬åˆè¨ˆ</div>
                        <div class="impact-value" id="impact-compensation">---ä¸‡å††</div>
                    </div>
                    <div class="impact-card">
                        <div class="impact-label">å¹´é–“æ³•å®šç¦åˆ©è²»</div>
                        <div class="impact-value" id="impact-welfare">---ä¸‡å††</div>
                    </div>
                    <div class="impact-card">
                        <div class="impact-label">å–¶æ¥­åˆ©ç›Šã¸ã®å½±éŸ¿</div>
                        <div class="impact-value" id="impact-profit-effect">---ä¸‡å††</div>
                    </div>
                    <div class="impact-card">
                        <div class="impact-label">åˆ©ç›Šç‡ã¸ã®å½±éŸ¿</div>
                        <div class="impact-value" id="impact-profit-margin">---%</div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="unified-table" id="compensation-table">
                        <thead>
                            <tr>
                                <th class="id-column"></th>
                                <th>é …ç›®å</th>
                                <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                                <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                                <th>å¹´é–“åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="compensation-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- äº‹æ¥­éƒ¨æ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="departments-section" class="tab-content" style="display: none;">
            <div class="department-comparison">
                <h2 class="section-title" style="color: #3498db;">äº‹æ¥­éƒ¨åˆ¥æ¯”è¼ƒãƒ»å‰å¹´å¯¾æ¯”åˆ†æ</h2>
                
                <!-- ç¢ºå®šæœˆè¨­å®š -->
                <div class="confirmed-month-section">
                    <h3 style="color: #27ae60; margin-bottom: 10px;">
                        ğŸ“… ç¢ºå®šæœˆè¨­å®š
                        <span id="confirmed-mode-badge" class="auto-detect-badge">è‡ªå‹•åˆ¤å®šãƒ¢ãƒ¼ãƒ‰</span>
                    </h3>
                    <p style="font-size: 0.9em; color: #555; margin-bottom: 15px;">
                        âœ“ãƒã‚§ãƒƒã‚¯ = ç¢ºå®šå®Ÿç¸¾ï¼ˆæ¿ƒè‰²ï¼‰ã€€â–¡ãƒãƒ¼ãƒã‚§ãƒƒã‚¯ = äºˆç®—ï¼ˆè–„è‰²ï¼‰
                        <button onclick="autoDetectConfirmedMonths()" style="padding: 5px 15px; border-radius: 15px; border: 1px solid #3498db; background: #3498db; color: white; cursor: pointer; font-size: 0.85em; margin-left: 10px;">
                            è‡ªå‹•åˆ¤å®š
                        </button>
                        <button onclick="forceRefreshAllData()" style="padding: 5px 15px; border-radius: 15px; border: 1px solid #e74c3c; background: #e74c3c; color: white; cursor: pointer; font-size: 0.85em; margin-left: 5px;">
                            ğŸ”„ å¼·åˆ¶æ›´æ–°
                        </button>
                    </p>
                    
                    <div class="confirmed-month-grid" id="confirmed-month-grid"></div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="action-button btn-apply" onclick="applyConfirmedMonthSettings()">ç¢ºå®šæœˆè¨­å®šã‚’é©ç”¨</button>
                        <button class="action-button btn-save" onclick="saveConfirmedMonthSettings()">è¨­å®šã‚’ä¿å­˜</button>
                    </div>
                </div>
                
                <!-- äº‹æ¥­éƒ¨ã‚°ãƒªãƒƒãƒ‰ -->
                <div class="dept-grid">
                    <div class="dept-card dept-sr">
                        <div class="dept-header">
                            <span class="dept-name">SRäº‹æ¥­éƒ¨</span>
                            <span class="dept-status" id="sr-status">
                                <span class="status-indicator status-pending"></span>å¾…æ©Ÿä¸­
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="sr-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">å¹´é–“å£²ä¸Š</div>
                                <div class="metric-value" id="sr-sales">---ä¸‡å††</div>
                                <div class="metric-change positive" id="sr-sales-change">å‰å¹´æ¯” ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å–¶æ¥­åˆ©ç›Š</div>
                                <div class="metric-value" id="sr-profit">---ä¸‡å††</div>
                                <div class="metric-change positive" id="sr-profit-change">å‰å¹´æ¯” ---%</div>
                            </div>
                        </div>
                    </div>

                    <div class="dept-card dept-w">
                        <div class="dept-header">
                            <span class="dept-name">Wäº‹æ¥­éƒ¨</span>
                            <span class="dept-status" id="w-status">
                                <span class="status-indicator status-pending"></span>å¾…æ©Ÿä¸­
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="w-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">å¹´é–“å£²ä¸Š</div>
                                <div class="metric-value" id="w-sales">---ä¸‡å††</div>
                                <div class="metric-change positive" id="w-sales-change">å‰å¹´æ¯” ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å–¶æ¥­åˆ©ç›Š</div>
                                <div class="metric-value" id="w-profit">---ä¸‡å††</div>
                                <div class="metric-change positive" id="w-profit-change">å‰å¹´æ¯” ---%</div>
                            </div>
                        </div>
                    </div>

                    <div class="dept-card dept-rc">
                        <div class="dept-header">
                            <span class="dept-name">RCäº‹æ¥­éƒ¨</span>
                            <span class="dept-status" id="rc-status">
                                <span class="status-indicator status-pending"></span>å¾…æ©Ÿä¸­
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="rc-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">å¹´é–“å£²ä¸Š</div>
                                <div class="metric-value" id="rc-sales">---ä¸‡å††</div>
                                <div class="metric-change positive" id="rc-sales-change">å‰å¹´æ¯” ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å–¶æ¥­åˆ©ç›Š</div>
                                <div class="metric-value" id="rc-profit">---ä¸‡å††</div>
                                <div class="metric-change positive" id="rc-profit-change">å‰å¹´æ¯” ---%</div>
                            </div>
                        </div>
                    </div>

                    <div class="dept-card dept-rcd">
                        <div class="dept-header">
                            <span class="dept-name">RCDäº‹æ¥­éƒ¨</span>
                            <span class="dept-status" id="rcd-status">
                                <span class="status-indicator status-pending"></span>å¾…æ©Ÿä¸­
                            </span>
                        </div>
                        <div class="dept-chart">
                            <canvas id="rcd-chart"></canvas>
                        </div>
                        <div class="dept-metrics">
                            <div class="metric-item">
                                <div class="metric-label">å¹´é–“å£²ä¸Š</div>
                                <div class="metric-value" id="rcd-sales">---ä¸‡å††</div>
                                <div class="metric-change positive" id="rcd-sales-change">å‰å¹´æ¯” ---%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">å–¶æ¥­åˆ©ç›Š</div>
                                <div class="metric-value" id="rcd-profit">---ä¸‡å††</div>
                                <div class="metric-change positive" id="rcd-profit-change">å‰å¹´æ¯” ---%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="analysis-section" class="tab-content" style="display: none;">
            <div class="chart-section">
                <h2 class="section-title" style="color: #9b59b6; border-bottom-color: #9b59b6;">è©³ç´°åˆ†æ</h2>
                <div class="chart-container" style="height: 450px;">
                    <canvas id="analysis-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- PLè©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="pl-details-section" class="tab-content" style="display: none;">
            <div class="unified-section">
                <h2 class="section-title" style="color: #e67e22;">çµ±åˆPLãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ4äº‹æ¥­éƒ¨åˆç®—ï¼‰</h2>
                <div style="text-align: right; margin-bottom: 10px;">
                    <button class="action-button btn-calculate" onclick="forceRefreshAllData()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶æ›´æ–°</button>
                </div>
                <div class="table-container">
                    <table class="unified-table" id="combined-pl-table">
                        <thead>
                            <tr>
                                <th class="id-column"></th>
                                <th>é …ç›®å</th>
                                <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                                <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                                <th>å¹´é–“åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="combined-pl-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="unified-section">
                <h2 class="section-title" style="color: #e74c3c;">RCå…¨ä½“é›†è¨ˆ</h2>
                <div class="table-container">
                    <table class="unified-table" id="summary-table">
                        <thead>
                            <tr>
                                <th class="id-column"></th>
                                <th>é …ç›®å</th>
                                <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                                <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                                <th>å¹´é–“åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="summary-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.2 - ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå®Œå…¨ä¿®æ­£ç‰ˆ
        let unifiedPLSystem;

        class UnifiedPLSystemV6 {
            constructor() {
                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼å®šç¾©ï¼ˆäº‹æ¥­éƒ¨PLã¨å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
                this.STORAGE_KEYS = {
                    'SR': 'pl_system_sr_corrected_data',
                    'W': 'pl_system_w_corrected_data', 
                    'RC': 'pl_system_rc_corrected_data',
                    'RCD': 'pl_system_rcd_corrected_data',
                    'executive': 'executive_compensation_csv_settings',
                    'confirmedMonths': 'unified_pl_confirmed_months_v6'
                };

                this.EXPENSE_ITEMS = {
                    1: 'äººä»¶è²»çµ±åˆ', 2: 'æ³•å®šç¦åˆ©è²»', 3: 'è¡›ç”Ÿè²»', 4: 'ç‰©æµç®¡ç†è²»', 5: 'åœ°ä»£å®¶è³ƒ',
                    6: 'å¤–æ³¨è²»', 7: 'è²¨ç‰©é‹è³ƒ', 8: 'åºƒå‘Šå®£ä¼è²»', 9: 'æ—…è²»äº¤é€šè²»', 10: 'é€šä¿¡è²»',
                    11: 'è²©å£²ä¿ƒé€²è²»', 12: 'æ¶ˆè€—å“è²»', 13: 'äº‹å‹™ç”¨å“è²»', 14: 'æ°´é“å…‰ç†±è²»', 15: 'æ”¯æ‰•æ‰‹æ•°æ–™',
                    16: 'ãƒªãƒ¼ã‚¹æ–™', 17: 'ä¿é™ºæ–™', 18: 'æ”¯æ‰•å ±é…¬æ–™', 19: 'æ¸›ä¾¡å„Ÿå´è²»'
                };

                this.MONTH_LABELS = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];

                // ç¢ºå®šæœˆè¨­å®š
                this.confirmedMonths = Array(12).fill(false);
                this.confirmedModeAuto = true;

                // å…¨ç¤¾å…±é€šè²»ãƒ‡ãƒ¼ã‚¿
                this.commonExpenseData = {
                    'ç®¡ç†è«¸è²»': [34, 37, 41, 34, 37, 44, 36, 39, 44, 36, 39, 44],
                    'ä¿®ç¹•è²»': [22, 0, 1, 0, 0, 12, 13, 0, 7, 0, 3, 0],
                    'è»Šä¸¡è²»': [2, 2, 1, 2, 3, 2, 2, 0, 19, 2, 4, 1],
                    'ç§Ÿç¨å…¬èª²': [3, 3, 2, 1, 1, 1, 7, 2, 1, 12, 2, 5],
                    'äº¤éš›è²»': [0, 1, 0, 2, 1, 0, 2, 4, 14, 1, 1, 9],
                    'è«¸ä¼šè²»': [1, 1, 1, 1, 1, 1, 0, 1, 18, 5, 2, 1],
                    'ä¼šè­°è²»': [0, 2, 2, 0, 2, 3, 1, 3, 1, 2, 1, 3],
                    'ç¦åˆ©åšç”Ÿè²»': [1, 1, 1, 1, 1, 2, 1, 1, 1, 2, 2, 2],
                    'ç ”ä¿®è²»': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0],
                    'é›‘è²»': [1, 1, 1, 0, 0, 0, 0, 0, 0, 5, 0, 0],
                    'å¯„ä»˜é‡‘': [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0]
                };

                // å‰å¹´ãƒ‡ãƒ¼ã‚¿
                this.previousYearData = {
                    totalSales: 231433,
                    totalProfit: 11217,
                    departmentSales: { 'SR': 31382, 'W': 11521, 'RC': 18359, 'RCD': 170171 },
                    departmentProfit: { 'SR': -370, 'W': 744, 'RC': 5990, 'RCD': 4853 },
                    monthlySales: {
                        'SR': [2236,2916,2927,2810,2544,2663,3008,2324,2403,2602,2228,2721],
                        'W': [886,500,669,1174,1257,2331,712,772,865,824,608,923],
                        'RC': [1947,1645,1530,1730,1165,1846,1475,1585,1241,1173,1602,1420],
                        'RCD': [11037,14296,11504,14663,12506,14919,13660,15455,14438,15856,15477,16360]
                    },
                    monthlyProfit: {
                        'SR': [-410,179,106,-30,77,1,348,-347,-2,89,-220,-161],
                        'W': [87,-155,-45,184,275,675,-184,11,9,30,-125,-18],
                        'RC': [756,581,514,630,303,607,482,546,347,307,466,451],
                        'RCD': [348,400,345,439,375,393,410,336,342,422,642,401]
                    },
                    unifiedMonthlySales: [16106,19357,16630,20377,17472,21759,18855,20136,18947,20455,19915,21424],
                    unifiedMonthlyProfit: [781,1005,920,1223,1030,1676,1056,546,696,848,763,663]
                };

                this.confirmedPLData = {
                    totalSales: 259266,
                    totalOperatingProfit: 452,
                    monthly_sales: [16399,19688,17073,26752,17944,22290,19202,20544,19342,20874,20300,21957],
                    monthly_profit: [37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.6, 37.8]
                };

                this.unifiedDataLoaded = false;
                this.currentChartMode = 'current';
                this.currentSection = 'overview';
                this.charts = {};
                this.departmentData = {};

                this.executiveData = {
                    compensation: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676],
                    welfare: [107, 107, 107, 88, 88, 88, 88, 88, 88, 88, 88, 88]
                };

                this.monthlyTotalExpenses = Array(12).fill(0);
                this.monthlyOperatingProfit = Array(12).fill(0);
                this.cumulativeOperatingProfit = Array(12).fill(0);

                this.initializeSystem();
            }

            initializeSystem() {
                console.log('RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.2 åˆæœŸåŒ–é–‹å§‹');
                this.loadConfirmedMonthSettings();
                this.forceLoadAllDepartmentData(); // å¼·åˆ¶èª­ã¿è¾¼ã¿
                this.loadExecutiveData();
                this.calculateUnifiedPL();
                this.updateAllDisplays();
                this.updateDataSourceIndicator();
                this.renderConfirmedMonthGrid();
                this.setupStorageListener(); // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´ç›£è¦–
                this.showNotification('RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.2 åˆæœŸåŒ–å®Œäº†', 'success');
            }

            // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´ã‚’ç›£è¦–ï¼ˆä»–ã‚¿ãƒ–ã§ã®å¤‰æ›´ã‚’æ¤œçŸ¥ï¼‰
            setupStorageListener() {
                window.addEventListener('storage', (e) => {
                    console.log('Storageå¤‰æ›´æ¤œçŸ¥:', e.key);
                    if (e.key && (e.key.includes('pl_system') || e.key.includes('corrected_data'))) {
                        console.log('äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ã‚’æ¤œçŸ¥ã€å†èª­ã¿è¾¼ã¿å®Ÿè¡Œ');
                        this.forceLoadAllDepartmentData();
                        this.calculateUnifiedPL();
                        this.updateAllDisplays();
                        this.showNotification('äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'success');
                    }
                });

                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ã‚‚å†èª­ã¿è¾¼ã¿
                window.addEventListener('focus', () => {
                    console.log('ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã€ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿');
                    this.forceLoadAllDepartmentData();
                    this.calculateUnifiedPL();
                    this.updateAllDisplays();
                });
            }

            loadConfirmedMonthSettings() {
                try {
                    const saved = localStorage.getItem(this.STORAGE_KEYS.confirmedMonths);
                    if (saved) {
                        const settings = JSON.parse(saved);
                        this.confirmedMonths = settings.months || Array(12).fill(false);
                        this.confirmedModeAuto = settings.autoMode !== false;
                    } else {
                        this.autoDetectConfirmedMonths();
                    }
                } catch (e) {
                    console.error('ç¢ºå®šæœˆè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                    this.autoDetectConfirmedMonths();
                }
            }

            autoDetectConfirmedMonths() {
                const now = new Date();
                const currentMonth = now.getMonth() + 1;
                
                this.confirmedMonths = Array(12).fill(false);
                
                let confirmedIndex;
                if (currentMonth >= 7) {
                    confirmedIndex = currentMonth - 7;
                } else {
                    confirmedIndex = currentMonth + 5;
                }
                
                for (let i = 0; i <= confirmedIndex; i++) {
                    this.confirmedMonths[i] = true;
                }
                
                this.confirmedModeAuto = true;
                console.log('è‡ªå‹•åˆ¤å®šçµæœ:', this.confirmedMonths);
            }

            renderConfirmedMonthGrid() {
                const grid = document.getElementById('confirmed-month-grid');
                if (!grid) return;

                grid.innerHTML = '';
                
                this.MONTH_LABELS.forEach((label, index) => {
                    const isConfirmed = this.confirmedMonths[index];
                    const item = document.createElement('div');
                    item.className = `month-checkbox-item ${isConfirmed ? 'confirmed' : 'budget'}`;
                    item.innerHTML = `
                        <input type="checkbox" id="month-${index}" ${isConfirmed ? 'checked' : ''} 
                               onchange="unifiedPLSystem.toggleMonthConfirmed(${index})">
                        <label for="month-${index}">${label}</label>
                        <span class="month-status-text">${isConfirmed ? 'ç¢ºå®š' : 'äºˆç®—'}</span>
                    `;
                    grid.appendChild(item);
                });

                const badge = document.getElementById('confirmed-mode-badge');
                if (badge) {
                    badge.className = this.confirmedModeAuto ? 'auto-detect-badge' : 'manual-mode-badge';
                    badge.textContent = this.confirmedModeAuto ? 'è‡ªå‹•åˆ¤å®šãƒ¢ãƒ¼ãƒ‰' : 'æ‰‹å‹•è¨­å®šãƒ¢ãƒ¼ãƒ‰';
                }
            }

            toggleMonthConfirmed(index) {
                this.confirmedMonths[index] = !this.confirmedMonths[index];
                this.confirmedModeAuto = false;
                this.renderConfirmedMonthGrid();
            }

            // å¼·åˆ¶çš„ã«localStorageã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            forceLoadAllDepartmentData() {
                const indicator = document.getElementById('data-refresh-indicator');
                if (indicator) indicator.classList.add('active');

                this.departmentData = {};
                let successCount = 0;
                
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    try {
                        // localStorageã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
                        const key = this.STORAGE_KEYS[dept];
                        const rawData = localStorage.getItem(key);
                        
                        console.log(`[${dept}] ã‚­ãƒ¼: ${key}`);
                        console.log(`[${dept}] ç”Ÿãƒ‡ãƒ¼ã‚¿é•·: ${rawData ? rawData.length : 0}`);
                        
                        if (rawData && rawData !== 'null' && rawData !== 'undefined' && rawData.length > 10) {
                            const parsed = JSON.parse(rawData);
                            
                            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®è©³ç´°ãƒ­ã‚°
                            console.log(`[${dept}] ãƒ‘ãƒ¼ã‚¹æˆåŠŸ:`, {
                                hasSales: !!parsed.sales,
                                salesLength: parsed.sales ? parsed.sales.length : 0,
                                salesData: parsed.sales,
                                lastUpdate: parsed.lastUpdate
                            });
                            
                            if (parsed.sales && Array.isArray(parsed.sales) && parsed.sales.length === 12) {
                                this.departmentData[dept] = {
                                    sales: [...parsed.sales],
                                    cogs: parsed.cogs ? [...parsed.cogs] : parsed.sales.map(s => Math.round(s * 0.5)),
                                    expenses: parsed.expenses || {},
                                    lastUpdate: parsed.lastUpdate
                                };
                                successCount++;
                                console.log(`[${dept}] ãƒ‡ãƒ¼ã‚¿çµ±åˆå®Œäº†:`, this.departmentData[dept].sales);
                            } else {
                                console.warn(`[${dept}] ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ `);
                                this.loadDepartmentFallbackData(dept);
                            }
                        } else {
                            console.warn(`[${dept}] ãƒ‡ãƒ¼ã‚¿ãªã—ã¾ãŸã¯ç©º`);
                            this.loadDepartmentFallbackData(dept);
                        }
                    } catch (error) {
                        console.error(`[${dept}] èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
                        this.loadDepartmentFallbackData(dept);
                    }
                });

                this.unifiedDataLoaded = successCount >= 2;
                console.log(`çµ±åˆå®Œäº†: ${successCount}/4éƒ¨é–€`);

                setTimeout(() => {
                    if (indicator) indicator.classList.remove('active');
                }, 500);
            }

            loadDepartmentFallbackData(dept) {
                this.departmentData[dept] = {
                    sales: [...this.previousYearData.monthlySales[dept]],
                    cogs: this.previousYearData.monthlySales[dept].map(s => Math.round(s * 0.5)),
                    expenses: {},
                    isFallback: true
                };
                
                for (let i = 1; i <= 19; i++) {
                    this.departmentData[dept].expenses[i] = Array(12).fill(0).map(() => Math.round(Math.random() * 50));
                }
            }

            loadExecutiveData() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEYS.executive);
                    if (data) {
                        const settings = JSON.parse(data);
                        if (settings.monthlyCompensation && settings.welfare) {
                            this.executiveData = {
                                compensation: [...settings.monthlyCompensation],
                                welfare: [...settings.welfare]
                            };
                        }
                    }
                } catch (error) {
                    console.error('å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            calculateUnifiedPL() {
                this.unifiedData = {
                    sales: Array(12).fill(0),
                    cogs: Array(12).fill(0),
                    expenses: {}
                };

                for (let i = 1; i <= 19; i++) {
                    this.unifiedData.expenses[i] = Array(12).fill(0);
                }

                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    const deptData = this.departmentData[dept];
                    if (!deptData) return;
                    
                    for (let month = 0; month < 12; month++) {
                        this.unifiedData.sales[month] += deptData.sales[month] || 0;
                        this.unifiedData.cogs[month] += deptData.cogs[month] || 0;
                        
                        if (deptData.expenses) {
                            for (let expenseId = 1; expenseId <= 19; expenseId++) {
                                if (deptData.expenses[expenseId]) {
                                    this.unifiedData.expenses[expenseId][month] += deptData.expenses[expenseId][month] || 0;
                                }
                            }
                        }
                    }
                });

                this.calculateFinalProfit();
            }

            calculateFinalProfit() {
                this.monthlyTotalExpenses = Array(12).fill(0);
                this.monthlyOperatingProfit = Array(12).fill(0);
                this.cumulativeOperatingProfit = Array(12).fill(0);
                let cumulativeSum = 0;

                for (let month = 0; month < 12; month++) {
                    let monthlyDeptExpenses = 0;
                    for (let expenseId = 1; expenseId <= 19; expenseId++) {
                        monthlyDeptExpenses += this.unifiedData.expenses[expenseId][month];
                    }

                    const executiveTotal = (this.executiveData.compensation[month] || 0) + 
                                          (this.executiveData.welfare[month] || 0);
                    
                    let commonExpenseTotal = 0;
                    Object.values(this.commonExpenseData).forEach(monthlyData => {
                        commonExpenseTotal += monthlyData[month];
                    });

                    this.monthlyTotalExpenses[month] = monthlyDeptExpenses + executiveTotal + commonExpenseTotal;

                    const monthlySales = this.unifiedData.sales[month];
                    const monthlyCogs = this.unifiedData.cogs[month];
                    const monthlyGrossProfit = monthlySales - monthlyCogs;
                    this.monthlyOperatingProfit[month] = monthlyGrossProfit - this.monthlyTotalExpenses[month];
                    
                    cumulativeSum += this.monthlyOperatingProfit[month];
                    this.cumulativeOperatingProfit[month] = cumulativeSum;
                }
            }

            calculateTargetAllocation() {
                const targetProfit = parseFloat(document.getElementById('target-profit').value) || 15000;
                const method = document.getElementById('allocation-method').value;
                const base = document.getElementById('calculation-base').value;
                
                let baseData;
                switch (base) {
                    case 'previous':
                        baseData = this.previousYearData.departmentSales;
                        break;
                    case 'current':
                        baseData = this.getCurrentDepartmentSales();
                        break;
                    case 'average':
                        baseData = this.getAverageDepartmentSales();
                        break;
                    default:
                        baseData = this.getCurrentDepartmentSales();
                }

                const allocation = {};
                const departments = ['SR', 'W', 'RC', 'RCD'];
                
                if (method === 'sales') {
                    const totalSales = Object.values(baseData).reduce((sum, val) => sum + val, 0);
                    departments.forEach(dept => {
                        allocation[dept] = Math.round(targetProfit * (baseData[dept] / totalSales));
                    });
                } else if (method === 'equal') {
                    const equalAmount = Math.round(targetProfit / 4);
                    departments.forEach(dept => {
                        allocation[dept] = equalAmount;
                    });
                } else {
                    const rates = this.getCurrentProfitRates();
                    const avgRate = Object.values(rates).reduce((sum, val) => sum + val, 0) / 4;
                    departments.forEach(dept => {
                        allocation[dept] = Math.round(targetProfit * (rates[dept] / (avgRate * 4)));
                    });
                }

                this.displayAllocationResult(allocation, targetProfit);
                this.showNotification('ç›®æ¨™åˆ©ç›Šé…åˆ†è¨ˆç®—å®Œäº†', 'success');
            }

            getCurrentDepartmentSales() {
                const result = {};
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    const data = this.departmentData[dept];
                    result[dept] = data && data.sales ? data.sales.reduce((sum, val) => sum + val, 0) : this.previousYearData.departmentSales[dept];
                });
                return result;
            }

            getAverageDepartmentSales() {
                const current = this.getCurrentDepartmentSales();
                const previous = this.previousYearData.departmentSales;
                const result = {};
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    result[dept] = Math.round((current[dept] + previous[dept]) / 2);
                });
                return result;
            }

            getCurrentProfitRates() {
                const result = {};
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    const sales = this.getCurrentDepartmentSales()[dept];
                    const data = this.departmentData[dept];
                    let profit = 0;
                    if (data && data.sales && data.cogs) {
                        profit = data.sales.reduce((s, v) => s + v, 0) - data.cogs.reduce((s, v) => s + v, 0);
                    }
                    result[dept] = sales > 0 ? (profit / sales) : 0.1;
                });
                return result;
            }

            displayAllocationResult(allocation, targetProfit) {
                const resultDiv = document.getElementById('allocation-result');
                const gridDiv = document.getElementById('allocation-grid');
                
                gridDiv.innerHTML = '';
                
                const deptNames = { 'SR': 'SRäº‹æ¥­éƒ¨', 'W': 'Wäº‹æ¥­éƒ¨', 'RC': 'RCäº‹æ¥­éƒ¨', 'RCD': 'RCDäº‹æ¥­éƒ¨' };
                const deptColors = { 'SR': '#C477CC', 'W': '#3498db', 'RC': '#27ae60', 'RCD': '#9b59b6' };
                
                let totalAllocated = 0;
                Object.entries(allocation).forEach(([dept, value]) => {
                    totalAllocated += value;
                    const card = document.createElement('div');
                    card.className = 'allocation-card';
                    card.style.borderLeft = `4px solid ${deptColors[dept]}`;
                    card.innerHTML = `
                        <h4>${deptNames[dept]}</h4>
                        <div class="value" style="color: ${deptColors[dept]}">${value.toLocaleString()}ä¸‡å††</div>
                        <div style="font-size: 0.8em; color: #666;">é…åˆ†ç‡: ${((value / targetProfit) * 100).toFixed(1)}%</div>
                    `;
                    gridDiv.appendChild(card);
                });

                const summaryCard = document.createElement('div');
                summaryCard.className = 'allocation-card';
                summaryCard.style.background = '#e8f5e9';
                summaryCard.innerHTML = `
                    <h4>åˆè¨ˆ</h4>
                    <div class="value" style="color: #27ae60">${totalAllocated.toLocaleString()}ä¸‡å††</div>
                `;
                gridDiv.appendChild(summaryCard);
                
                resultDiv.style.display = 'block';
            }

            updateAllDisplays() {
                this.updateKPIs();
                this.updateDepartmentKPIs();
                this.updateMainChart();
                this.updateDepartmentCharts();
                this.updateAnalysisChart();
                this.updateTables();
                this.updateConnectionStatus();
                this.updateExecutiveSummary();
            }

            updateKPIs() {
                const totalSales = this.unifiedData.sales.reduce((sum, val) => sum + val, 0);
                const totalExpenses = this.monthlyTotalExpenses.reduce((sum, val) => sum + val, 0);
                const totalOperatingProfit = this.monthlyOperatingProfit.reduce((sum, val) => sum + val, 0);
                const profitRate = totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0;

                const salesGrowth = ((totalSales - this.previousYearData.totalSales) / this.previousYearData.totalSales * 100).toFixed(1);
                const profitGrowth = ((totalOperatingProfit - this.previousYearData.totalProfit) / this.previousYearData.totalProfit * 100).toFixed(1);
                const prevProfitRate = this.previousYearData.totalProfit / this.previousYearData.totalSales * 100;
                const marginChange = profitRate - prevProfitRate;

                document.getElementById('kpi-sales').textContent = `${Math.round(totalSales).toLocaleString()}ä¸‡å††`;
                document.getElementById('kpi-expenses').textContent = `${Math.round(totalExpenses).toLocaleString()}ä¸‡å††`;
                document.getElementById('kpi-profit').textContent = `${Math.round(totalOperatingProfit).toLocaleString()}ä¸‡å††`;
                document.getElementById('kpi-margin').textContent = `${profitRate.toFixed(2)}%`;
                
                document.getElementById('kpi-sales-change').textContent = `å‰å¹´æ¯” ${salesGrowth >= 0 ? '+' : ''}${salesGrowth}%`;
                document.getElementById('kpi-profit-change').textContent = `å‰å¹´æ¯” ${profitGrowth >= 0 ? '+' : ''}${profitGrowth}%`;
                document.getElementById('kpi-margin-change').textContent = `å‰å¹´æ¯” ${marginChange >= 0 ? '+' : ''}${marginChange.toFixed(2)}pt`;
                
                document.getElementById('kpi-sales-change').className = `kpi-change ${salesGrowth >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('kpi-profit-change').className = `kpi-change ${profitGrowth >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('kpi-margin-change').className = `kpi-change ${marginChange >= 0 ? 'positive' : 'negative'}`;
            }

            updateDepartmentKPIs() {
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    const deptLower = dept.toLowerCase();
                    const data = this.departmentData[dept];
                    
                    let annualSales = 0;
                    let annualProfit = 0;
                    
                    if (data && data.sales) {
                        annualSales = data.sales.reduce((sum, val) => sum + val, 0);
                        if (data.cogs) {
                            annualProfit = annualSales - data.cogs.reduce((sum, val) => sum + val, 0);
                        } else {
                            annualProfit = annualSales * 0.1;
                        }
                    } else {
                        annualSales = this.previousYearData.departmentSales[dept];
                        annualProfit = this.previousYearData.departmentProfit[dept];
                    }
                    
                    const prevSales = this.previousYearData.departmentSales[dept];
                    const prevProfit = this.previousYearData.departmentProfit[dept];
                    const salesGrowth = prevSales > 0 ? ((annualSales - prevSales) / prevSales * 100).toFixed(1) : '0.0';
                    const profitGrowth = prevProfit !== 0 ? ((annualProfit - prevProfit) / Math.abs(prevProfit) * 100).toFixed(1) : '0.0';
                    
                    document.getElementById(`${deptLower}-sales`).textContent = `${Math.round(annualSales).toLocaleString()}ä¸‡å††`;
                    document.getElementById(`${deptLower}-profit`).textContent = `${Math.round(annualProfit).toLocaleString()}ä¸‡å††`;
                    document.getElementById(`${deptLower}-sales-change`).textContent = `å‰å¹´æ¯” ${salesGrowth >= 0 ? '+' : ''}${salesGrowth}%`;
                    document.getElementById(`${deptLower}-profit-change`).textContent = `å‰å¹´æ¯” ${profitGrowth >= 0 ? '+' : ''}${profitGrowth}%`;
                    
                    document.getElementById(`${deptLower}-sales-change`).className = `metric-change ${salesGrowth >= 0 ? 'positive' : 'negative'}`;
                    document.getElementById(`${deptLower}-profit-change`).className = `metric-change ${profitGrowth >= 0 ? 'positive' : 'negative'}`;
                });
            }

            updateMainChart() {
                const ctx = document.getElementById('main-chart');
                if (!ctx) return;

                if (this.charts.main) {
                    this.charts.main.destroy();
                }

                const months = this.MONTH_LABELS;
                const sales = this.unifiedData.sales;
                const profit = this.monthlyOperatingProfit;
                
                let cumulativeProfit = [];
                let cum = 0;
                profit.forEach(p => { cum += p; cumulativeProfit.push(cum); });

                let datasets = [];

                if (this.currentChartMode === 'comparison') {
                    datasets = [
                        {
                            label: 'å‰å¹´å£²ä¸Šé«˜', 
                            type: 'bar', 
                            data: this.previousYearData.unifiedMonthlySales, 
                            backgroundColor: 'rgba(149,165,166,0.5)', 
                            borderColor: '#95a5a6', 
                            borderWidth: 1, 
                            yAxisID: 'y' 
                        },
                        {
                            label: 'ä»ŠæœŸå£²ä¸Šé«˜', 
                            type: 'bar', 
                            data: sales, 
                            backgroundColor: 'rgba(52,152,219,0.7)', 
                            borderColor: '#3498db', 
                            borderWidth: 2, 
                            yAxisID: 'y' 
                        },
                        {
                            label: 'å‰å¹´å–¶æ¥­åˆ©ç›Š', 
                            type: 'line', 
                            data: this.previousYearData.unifiedMonthlyProfit, 
                            borderColor: '#e67e22', 
                            borderWidth: 3, 
                            fill: false, 
                            tension: 0.4, 
                            yAxisID: 'y1'
                        },
                        {
                            label: 'ä»ŠæœŸå–¶æ¥­åˆ©ç›Š', 
                            type: 'line', 
                            data: profit, 
                            borderColor: '#27ae60', 
                            borderWidth: 4, 
                            fill: false, 
                            tension: 0.4, 
                            yAxisID: 'y1'
                        }
                    ];
                } else {
                    datasets = [
                        {
                            label: 'æœˆæ¬¡å£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰',
                            type: 'bar',
                            data: sales,
                            backgroundColor: 'rgba(52,152,219,0.7)',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'å–¶æ¥­åˆ©ç›Šç´¯è¨ˆï¼ˆä¸‡å††ï¼‰',
                            type: 'line',
                            data: cumulativeProfit,
                            borderColor: '#e74c3c',
                            borderWidth: 4,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ];
                }

                this.charts.main = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: months, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            title: {
                                display: true,
                                text: this.currentChartMode === 'comparison' ? 'å‰å¹´æ¯”è¼ƒã‚°ãƒ©ãƒ•' : 'å½“æœŸå®Ÿç¸¾ã‚°ãƒ©ãƒ•',
                                font: { size: 18, weight: 'bold' }
                            },
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'æœˆåº¦' } },
                            y: { 
                                type: 'linear', 
                                display: true, 
                                position: 'left',
                                title: { display: true, text: 'å£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰', color: '#3498db' },
                                ticks: { color: '#3498db', callback: v => v.toLocaleString() }
                            },
                            y1: { 
                                type: 'linear', 
                                display: true, 
                                position: 'right',
                                title: { display: true, text: 'å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰', color: '#e74c3c' },
                                ticks: { color: '#e74c3c', callback: v => (v >= 0 ? '+' : '') + v.toLocaleString() },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }

            // v6.2: äº‹æ¥­éƒ¨ãƒãƒ£ãƒ¼ãƒˆ - æ£’ã‚’å®Œå…¨ã«ãã£ã¤ã‘ã‚‹ï¼ˆ2æœ¬ã®ã¿ï¼šä»ŠæœŸï¼‹å‰å¹´ï¼‰
            updateDepartmentCharts() {
                const departments = ['SR', 'W', 'RC', 'RCD'];
                const colors = { 
                    'SR': { main: '#8B4B9A', light: '#C477CC' },
                    'W': { main: '#2874A6', light: '#3498db' },
                    'RC': { main: '#1E8449', light: '#27ae60' },
                    'RCD': { main: '#6C3483', light: '#9b59b6' }
                };
                const months = ['7','8','9','10','11','12','1','2','3','4','5','6'];

                departments.forEach(dept => {
                    const ctx = document.getElementById(`${dept.toLowerCase()}-chart`);
                    if (!ctx) return;

                    if (this.charts[dept.toLowerCase()]) {
                        this.charts[dept.toLowerCase()].destroy();
                    }

                    const data = this.departmentData[dept];
                    let salesData = data && data.sales ? [...data.sales] : [...this.previousYearData.monthlySales[dept]];
                    const prevYearData = this.previousYearData.monthlySales[dept];

                    // ä»ŠæœŸãƒ‡ãƒ¼ã‚¿ã®èƒŒæ™¯è‰²ã‚’æœˆã”ã¨ã«è¨­å®šï¼ˆç¢ºå®š=æ¿ƒã€äºˆç®—=è–„ï¼‰
                    const backgroundColors = salesData.map((_, i) => 
                        this.confirmedMonths[i] ? colors[dept].main : colors[dept].light + '88'
                    );
                    const borderColors = salesData.map((_, i) => 
                        this.confirmedMonths[i] ? colors[dept].main : colors[dept].light
                    );

                    this.charts[dept.toLowerCase()] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'å‰å¹´å£²ä¸Š',
                                    data: prevYearData,
                                    backgroundColor: 'rgba(180,180,180,0.4)',
                                    borderColor: 'rgba(150,150,150,0.8)',
                                    borderWidth: 1,
                                    order: 2
                                },
                                {
                                    label: 'ä»ŠæœŸå£²ä¸Š',
                                    data: salesData,
                                    backgroundColor: backgroundColors,
                                    borderColor: borderColors,
                                    borderWidth: 2,
                                    order: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { 
                                    display: true, 
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        font: { size: 9, weight: 'bold' },
                                        boxWidth: 12,
                                        generateLabels: function(chart) {
                                            return [
                                                { text: 'å‰å¹´å£²ä¸Š', fillStyle: 'rgba(180,180,180,0.4)', strokeStyle: 'rgba(150,150,150,0.8)' },
                                                { text: 'ç¢ºå®šå®Ÿç¸¾', fillStyle: colors[dept].main, strokeStyle: colors[dept].main },
                                                { text: 'äºˆç®—', fillStyle: colors[dept].light + '88', strokeStyle: colors[dept].light }
                                            ];
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        title: (context) => {
                                            const idx = context[0].dataIndex;
                                            const isConfirmed = unifiedPLSystem.confirmedMonths[idx];
                                            return months[idx] + 'æœˆ' + (isConfirmed ? ' [ç¢ºå®š]' : ' [äºˆç®—]');
                                        },
                                        label: (context) => {
                                            const label = context.dataset.label || '';
                                            const value = context.parsed.y;
                                            return value ? `${label}: ${value.toLocaleString()}ä¸‡å††` : null;
                                        }
                                    }
                                }
                            },
                            scales: { 
                                x: { 
                                    ticks: { font: {size: 10} },
                                    grid: {
                                        color: (context) => {
                                            const idx = context.index;
                                            // ç¢ºå®šâ†’äºˆç®—ã®å¢ƒç•Œã‚’æ¤œå‡º
                                            if (idx > 0 && unifiedPLSystem.confirmedMonths[idx-1] && !unifiedPLSystem.confirmedMonths[idx]) {
                                                return 'rgba(231, 76, 60, 0.8)';
                                            }
                                            return 'rgba(0, 0, 0, 0.1)';
                                        },
                                        lineWidth: (context) => {
                                            const idx = context.index;
                                            if (idx > 0 && unifiedPLSystem.confirmedMonths[idx-1] && !unifiedPLSystem.confirmedMonths[idx]) {
                                                return 3;
                                            }
                                            return 1;
                                        }
                                    }
                                }, 
                                y: { 
                                    ticks: { font: {size: 10}, callback: v => v.toLocaleString() },
                                    beginAtZero: true
                                } 
                            },
                            // v6.2: æ£’ã‚’å®Œå…¨ã«ãã£ã¤ã‘ã‚‹
                            barPercentage: 0.9,
                            categoryPercentage: 0.95
                        }
                    });
                });
            }

            updateAnalysisChart() {
                const ctx = document.getElementById('analysis-chart');
                if (!ctx) return;

                if (this.charts.analysis) {
                    this.charts.analysis.destroy();
                }

                const months = this.MONTH_LABELS;

                this.charts.analysis = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'å£²ä¸Šé«˜æ¨ç§»',
                                type: 'line',
                                data: this.unifiedData.sales,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52,152,219,0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'è²©ç®¡è²»æ¨ç§»',
                                type: 'line',
                                data: this.monthlyTotalExpenses,
                                borderColor: '#e67e22',
                                backgroundColor: 'rgba(230,126,34,0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y'
                            },
                            {
                                label: 'å–¶æ¥­åˆ©ç›Šæ¨ç§»',
                                type: 'bar',
                                data: this.monthlyOperatingProfit,
                                backgroundColor: this.monthlyOperatingProfit.map(p => p >= 0 ? 'rgba(39,174,96,0.7)' : 'rgba(231,76,60,0.7)'),
                                borderColor: this.monthlyOperatingProfit.map(p => p >= 0 ? '#27ae60' : '#e74c3c'),
                                borderWidth: 2,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            title: { display: true, text: 'å£²ä¸Šãƒ»è²»ç”¨ãƒ»åˆ©ç›Šã®è©³ç´°åˆ†æ', font: { size: 16, weight: 'bold' } },
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'æœˆåº¦' } },
                            y: { 
                                type: 'linear', 
                                display: true, 
                                position: 'left',
                                title: { display: true, text: 'å£²ä¸Šãƒ»è²»ç”¨ï¼ˆä¸‡å††ï¼‰' },
                                ticks: { callback: v => v.toLocaleString() }
                            },
                            y1: { 
                                type: 'linear', 
                                display: true, 
                                position: 'right',
                                title: { display: true, text: 'å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰' },
                                ticks: { callback: v => (v >= 0 ? '+' : '') + v.toLocaleString() },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }

            updateTables() {
                this.updateCombinedPLTable();
                this.updateSummaryTable();
            }

            updateCombinedPLTable() {
                const tbody = document.getElementById('combined-pl-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const rows = [
                    { id: '', name: 'å£²ä¸Šé«˜', data: this.unifiedData.sales, class: 'row-highlight-sales' },
                    { id: '', name: 'å£²ä¸ŠåŸä¾¡', data: this.unifiedData.cogs, class: '' }
                ];
                
                const grossProfit = this.unifiedData.sales.map((s, i) => s - this.unifiedData.cogs[i]);
                rows.push({ id: '', name: 'å£²ä¸Šç·åˆ©ç›Š', data: grossProfit, class: 'row-subtotal' });
                
                for (let i = 1; i <= 19; i++) {
                    rows.push({ id: i, name: this.EXPENSE_ITEMS[i], data: this.unifiedData.expenses[i], class: '' });
                }
                
                rows.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = row.class;
                    const annual = row.data.reduce((sum, val) => sum + val, 0);
                    tr.innerHTML = `
                        <td class="id-column">${row.id}</td>
                        <td>${row.name}</td>
                        ${row.data.map(val => `<td>${Math.round(val).toLocaleString()}</td>`).join('')}
                        <td class="total-column">${Math.round(annual).toLocaleString()}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            updateSummaryTable() {
                const tbody = document.getElementById('summary-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const rows = [
                    { name: 'å£²ä¸Šé«˜åˆè¨ˆ', data: this.unifiedData.sales },
                    { name: 'å£²ä¸ŠåŸä¾¡åˆè¨ˆ', data: this.unifiedData.cogs },
                    { name: 'å£²ä¸Šç·åˆ©ç›Š', data: this.unifiedData.sales.map((s, i) => s - this.unifiedData.cogs[i]) },
                    { name: 'è²©ç®¡è²»åˆè¨ˆ', data: this.monthlyTotalExpenses },
                    { name: 'å–¶æ¥­åˆ©ç›Š', data: this.monthlyOperatingProfit },
                    { name: 'å–¶æ¥­åˆ©ç›Šç´¯è¨ˆ', data: this.cumulativeOperatingProfit }
                ];
                
                rows.forEach((row, idx) => {
                    const tr = document.createElement('tr');
                    if (idx >= 4) tr.className = 'row-highlight-profit';
                    const annual = row.data.reduce((sum, val) => sum + val, 0);
                    tr.innerHTML = `
                        <td class="id-column">${idx + 1}</td>
                        <td>${row.name}</td>
                        ${row.data.map(val => `<td>${Math.round(val).toLocaleString()}</td>`).join('')}
                        <td class="total-column">${idx === 5 ? Math.round(row.data[11]).toLocaleString() : Math.round(annual).toLocaleString()}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            updateConnectionStatus() {
                ['SR', 'W', 'RC', 'RCD'].forEach(dept => {
                    const indicator = document.getElementById(`${dept.toLowerCase()}-indicator`);
                    const status = document.getElementById(`${dept.toLowerCase()}-status`);
                    
                    if (indicator && status) {
                        const data = this.departmentData[dept];
                        const hasData = data && data.sales && !data.isFallback;
                        
                        indicator.className = `status-indicator ${hasData ? 'status-connected' : 'status-pending'}`;
                        status.innerHTML = `<span class="status-indicator ${hasData ? 'status-connected' : 'status-pending'}"></span>${hasData ? 'æ¥ç¶šæ¸ˆã¿' : 'å¾…æ©Ÿä¸­'}`;
                    }
                });
            }

            updateExecutiveSummary() {
                const totalComp = this.executiveData.compensation.reduce((s, v) => s + v, 0);
                const totalWelfare = this.executiveData.welfare.reduce((s, v) => s + v, 0);
                const totalEffect = totalComp + totalWelfare;
                const totalSales = this.unifiedData.sales.reduce((s, v) => s + v, 0);
                const marginEffect = totalSales > 0 ? (totalEffect / totalSales * 100) : 0;
                
                document.getElementById('impact-compensation').textContent = `${totalComp.toLocaleString()}ä¸‡å††`;
                document.getElementById('impact-welfare').textContent = `${totalWelfare.toLocaleString()}ä¸‡å††`;
                document.getElementById('impact-profit-effect').textContent = `-${totalEffect.toLocaleString()}ä¸‡å††`;
                document.getElementById('impact-profit-margin').textContent = `-${marginEffect.toFixed(2)}%`;
            }

            updateDataSourceIndicator() {
                const indicator = document.getElementById('data-source-indicator');
                if (indicator) {
                    if (this.unifiedDataLoaded) {
                        indicator.className = 'data-source-indicator indicator-realdata';
                        indicator.textContent = 'âœ“ å®Ÿãƒ‡ãƒ¼ã‚¿çµ±åˆè¡¨ç¤ºä¸­';
                    } else {
                        indicator.className = 'data-source-indicator indicator-simulation';
                        indicator.textContent = 'âš ï¸ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤è¡¨ç¤ºä¸­';
                    }
                }
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        function showSection(section) {
            const sections = ['overview', 'target', 'executive', 'departments', 'analysis', 'pl-details'];
            sections.forEach(s => {
                const el = document.getElementById(`${s}-section`);
                if (el) el.style.display = 'none';
            });

            const targetSection = document.getElementById(`${section}-section`);
            if (targetSection) targetSection.style.display = 'block';

            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            unifiedPLSystem.currentSection = section;
            
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡æ›¿æ™‚ã«å¼·åˆ¶ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼‹ã‚°ãƒ©ãƒ•å†æç”»
            setTimeout(() => {
                unifiedPLSystem.forceLoadAllDepartmentData();
                unifiedPLSystem.calculateUnifiedPL();
                
                if (section === 'departments') {
                    unifiedPLSystem.updateDepartmentCharts();
                    unifiedPLSystem.updateDepartmentKPIs();
                } else if (section === 'analysis') {
                    unifiedPLSystem.updateAnalysisChart();
                } else if (section === 'overview') {
                    unifiedPLSystem.updateMainChart();
                    unifiedPLSystem.updateKPIs();
                }
            }, 50);
        }

        function toggleChartMode(mode) {
            unifiedPLSystem.currentChartMode = mode;
            document.querySelectorAll('.chart-toggle').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            unifiedPLSystem.updateMainChart();
        }

        function autoDetectConfirmedMonths() {
            unifiedPLSystem.autoDetectConfirmedMonths();
            unifiedPLSystem.renderConfirmedMonthGrid();
            unifiedPLSystem.updateDepartmentCharts();
            unifiedPLSystem.showNotification('ç¢ºå®šæœˆã‚’è‡ªå‹•åˆ¤å®šã—ã¾ã—ãŸ', 'success');
        }

        function applyConfirmedMonthSettings() {
            unifiedPLSystem.updateDepartmentCharts();
            unifiedPLSystem.showNotification('ç¢ºå®šæœˆè¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ', 'success');
        }

        function saveConfirmedMonthSettings() {
            try {
                const settings = {
                    months: unifiedPLSystem.confirmedMonths,
                    autoMode: unifiedPLSystem.confirmedModeAuto,
                    lastUpdate: new Date().toISOString()
                };
                localStorage.setItem(unifiedPLSystem.STORAGE_KEYS.confirmedMonths, JSON.stringify(settings));
                unifiedPLSystem.showNotification('ç¢ºå®šæœˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            } catch (e) {
                unifiedPLSystem.showNotification('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        function forceRefreshAllData() {
            unifiedPLSystem.showNotification('ãƒ‡ãƒ¼ã‚¿å¼·åˆ¶æ›´æ–°ä¸­...', 'warning');
            unifiedPLSystem.forceLoadAllDepartmentData();
            unifiedPLSystem.calculateUnifiedPL();
            unifiedPLSystem.updateAllDisplays();
            unifiedPLSystem.showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        }

        function saveCompensation() {
            try {
                const data = {
                    monthlyCompensation: unifiedPLSystem.executiveData.compensation,
                    welfare: unifiedPLSystem.executiveData.welfare,
                    lastUpdate: new Date().toISOString()
                };
                localStorage.setItem(unifiedPLSystem.STORAGE_KEYS.executive, JSON.stringify(data));
                unifiedPLSystem.showNotification('å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                document.getElementById('compensation-status').textContent = `ä¿å­˜å®Œäº†: ${new Date().toLocaleString()}`;
            } catch (e) {
                unifiedPLSystem.showNotification('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        function loadCompensation() {
            try {
                const data = localStorage.getItem(unifiedPLSystem.STORAGE_KEYS.executive);
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed.monthlyCompensation && parsed.welfare) {
                        unifiedPLSystem.executiveData = {
                            compensation: [...parsed.monthlyCompensation],
                            welfare: [...parsed.welfare]
                        };
                        unifiedPLSystem.calculateFinalProfit();
                        unifiedPLSystem.updateAllDisplays();
                        unifiedPLSystem.showNotification('å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                        document.getElementById('compensation-status').textContent = `èª­è¾¼å®Œäº†: ${new Date(parsed.lastUpdate).toLocaleString()}`;
                    }
                } else {
                    unifiedPLSystem.showNotification('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                }
            } catch (e) {
                unifiedPLSystem.showNotification('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        function exportUnifiedCSV() {
            try {
                const csvData = [];
                const months = ['é …ç›®å', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 'å¹´é–“åˆè¨ˆ'];
                csvData.push(months);

                csvData.push(['å£²ä¸Šé«˜', ...unifiedPLSystem.unifiedData.sales, unifiedPLSystem.unifiedData.sales.reduce((s, v) => s + v, 0)]);
                csvData.push(['å£²ä¸ŠåŸä¾¡', ...unifiedPLSystem.unifiedData.cogs, unifiedPLSystem.unifiedData.cogs.reduce((s, v) => s + v, 0)]);
                
                const grossProfit = unifiedPLSystem.unifiedData.sales.map((s, i) => s - unifiedPLSystem.unifiedData.cogs[i]);
                csvData.push(['å£²ä¸Šç·åˆ©ç›Š', ...grossProfit, grossProfit.reduce((s, v) => s + v, 0)]);

                for (let i = 1; i <= 19; i++) {
                    const exp = unifiedPLSystem.unifiedData.expenses[i];
                    csvData.push([unifiedPLSystem.EXPENSE_ITEMS[i], ...exp, exp.reduce((s, v) => s + v, 0)]);
                }

                csvData.push(['è²©ç®¡è²»åˆè¨ˆ', ...unifiedPLSystem.monthlyTotalExpenses, unifiedPLSystem.monthlyTotalExpenses.reduce((s, v) => s + v, 0)]);
                csvData.push(['å–¶æ¥­åˆ©ç›Š', ...unifiedPLSystem.monthlyOperatingProfit, unifiedPLSystem.monthlyOperatingProfit.reduce((s, v) => s + v, 0)]);

                const csvString = '\uFEFF' + csvData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼_v6.2_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                unifiedPLSystem.showNotification('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†', 'success');
            } catch (error) {
                unifiedPLSystem.showNotification('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼', 'error');
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('RCå£²ä¸Šåˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v6.2 åˆæœŸåŒ–');
            unifiedPLSystem = new UnifiedPLSystemV6();

            // è‡ªå‹•æ›´æ–°ï¼ˆ10ç§’é–“éš”ï¼‰
            setInterval(() => {
                try {
                    unifiedPLSystem.forceLoadAllDepartmentData();
                    unifiedPLSystem.calculateUnifiedPL();
                    unifiedPLSystem.updateAllDisplays();
                } catch (e) {
                    console.error('Auto refresh error:', e);
                }
            }, 10000);

            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
            const exportButton = document.createElement('button');
            exportButton.textContent = 'CSVå‡ºåŠ›';
            exportButton.className = 'action-button btn-save';
            exportButton.onclick = exportUnifiedCSV;
            exportButton.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:1000;';
            document.body.appendChild(exportButton);
        });
    </script>
</body>
</html>
