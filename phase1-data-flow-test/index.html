
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLçµ±åˆã‚·ã‚¹ãƒ†ãƒ  - ãƒ‡ãƒ¼ã‚¿é€å—ä¿¡ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ï¼ˆãƒ•ã‚§ãƒ¼ã‚º1ï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #C477CC 0%, #B366BD 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }

        .section h2 {
            color: #C477CC;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #C477CC;
            padding-bottom: 10px;
        }

        .department-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .department-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .department-card:hover {
            border-color: #C477CC;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(196, 119, 204, 0.2);
        }

        .department-card h3 {
            color: #C477CC;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #C477CC 0%, #B366BD 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(196, 119, 204, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .status-display {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #C477CC;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-success {
            color: #27ae60;
            font-weight: bold;
        }

        .status-error {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-pending {
            color: #f39c12;
            font-weight: bold;
        }

        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .validation-results {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .validation-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }

        .validation-success {
            background: #d4edda;
            border-left-color: #27ae60;
            color: #155724;
        }

        .validation-warning {
            background: #fff3cd;
            border-left-color: #f39c12;
            color: #856404;
        }

        .validation-error {
            background: #f8d7da;
            border-left-color: #e74c3c;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PLçµ±åˆã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>ãƒ‡ãƒ¼ã‚¿é€å—ä¿¡ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ - ãƒ•ã‚§ãƒ¼ã‚º1</p>
        </div>

        <div class="main-content">
            <!-- äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“¤ äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡ãƒ†ã‚¹ãƒˆ</h2>
                <div class="department-grid">
                    <div class="department-card">
                        <h3>SRäº‹æ¥­éƒ¨</h3>
                        <button class="btn btn-primary" onclick="sendDepartmentData('sr')">ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡</button>
                        <button class="btn btn-success" onclick="validateDepartmentData('sr')">ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</button>
                    </div>
                    <div class="department-card">
                        <h3>Wäº‹æ¥­éƒ¨</h3>
                        <button class="btn btn-primary" onclick="sendDepartmentData('w')">ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡</button>
                        <button class="btn btn-success" onclick="validateDepartmentData('w')">ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</button>
                    </div>
                    <div class="department-card">
                        <h3>RCå¸äº‹æ¥­éƒ¨</h3>
                        <button class="btn btn-primary" onclick="sendDepartmentData('rc')">ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡</button>
                        <button class="btn btn-success" onclick="validateDepartmentData('rc')">ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</button>
                    </div>
                    <div class="department-card">
                        <h3>RCDç¤¾äº‹æ¥­éƒ¨</h3>
                        <button class="btn btn-primary" onclick="sendDepartmentData('rcd')">ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿é€ä¿¡</button>
                        <button class="btn btn-success" onclick="validateDepartmentData('rcd')">ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</button>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="sendAllData()">ğŸš€ å…¨äº‹æ¥­éƒ¨ä¸€æ‹¬é€ä¿¡</button>
                    <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ»çµ±åˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
                <div class="controls">
                    <button class="btn btn-success" onclick="receiveAndCombineData()">ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ»çµ±åˆå®Ÿè¡Œ</button>
                    <button class="btn btn-primary" onclick="showCombinedData()">çµ±åˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</button>
                </div>
                <div class="status-display" id="dataStatus">
                    <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿é€å—ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                    <div class="status-item">
                        <span>SRäº‹æ¥­éƒ¨:</span>
                        <span id="status-sr" class="status-pending">æœªé€ä¿¡</span>
                    </div>
                    <div class="status-item">
                        <span>Wäº‹æ¥­éƒ¨:</span>
                        <span id="status-w" class="status-pending">æœªé€ä¿¡</span>
                    </div>
                    <div class="status-item">
                        <span>RCå¸äº‹æ¥­éƒ¨:</span>
                        <span id="status-rc" class="status-pending">æœªé€ä¿¡</span>
                    </div>
                    <div class="status-item">
                        <span>RCDç¤¾äº‹æ¥­éƒ¨:</span>
                        <span id="status-rcd" class="status-pending">æœªé€ä¿¡</span>
                    </div>
                    <div class="status-item">
                        <span>çµ±åˆãƒ‡ãƒ¼ã‚¿:</span>
                        <span id="status-combined" class="status-pending">æœªä½œæˆ</span>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h2>
                <div class="validation-results" id="validationResults">
                    <p>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„...</p>
                </div>
            </div>

            <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</h2>
                <div class="log-area" id="systemLog">
                    <div>ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†...</div>
                    <div>ãƒ‡ãƒ¼ã‚¿é€å—ä¿¡ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸æº–å‚™å®Œäº†</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // LocalStorageã‚­ãƒ¼ç®¡ç†ï¼ˆå¼•ç¶™ãæ›¸ã«åŸºã¥ãï¼‰
        const STORAGE_KEYS = {
            sr_data: 'pl_system_sr_data',
            w_data: 'pl_system_w_data',
            rc_data: 'pl_system_rc_data',
            rcd_data: 'pl_system_rcd_data',
            combined_data: 'pl_system_combined_data',
            test_mode: 'pl_system_test_mode'
        };

        // æ¨™æº–ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        function createStandardPLData(department) {
            const now = new Date().toISOString();
            return {
                department: department,
                timestamp: now,
                metadata: {
                    source: `${department}_simulator`,
                    version: "1.0",
                    checksum: generateChecksum(department + now)
                },
                sales: {
                    monthly: new Array(12).fill(0).map(() => Math.floor(Math.random() * 10000) + 5000),
                    annual: 0
                },
                cogs: {
                    monthly: new Array(12).fill(0).map(() => Math.floor(Math.random() * 3000) + 1500),
                    annual: 0
                },
                expenses: {
                    personnel: { 
                        monthly: new Array(12).fill(0).map(() => Math.floor(Math.random() * 1000) + 500), 
                        annual: 0 
                    },
                    welfare: { 
                        monthly: new Array(12).fill(0).map(() => Math.floor(Math.random() * 200) + 100), 
                        annual: 0 
                    },
                    rent: { 
                        monthly: new Array(12).fill(0).map(() => Math.floor(Math.random() * 300) + 200), 
                        annual: 0 
                    },
                    utilities: { 
                        monthly: new Array(12).fill(0).map(() => Math.floor(Math.random() * 150) + 50), 
                        annual: 0 
                    },
                    communication: { 
                        monthly: new Array(12).fill(0).map(() => Math.floor(Math.random() * 100) + 30), 
                        annual: 0 
                    },
                    // ä»–ã®è²©ç®¡è²»é …ç›®ã‚‚åŒæ§˜ã«å®šç¾©
                },
                validation: {
                    errors: [],
                    warnings: [],
                    status: "success"
                }
            };
        }

        // ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function generateChecksum(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        function validatePLData(data) {
            const errors = [];
            const warnings = [];

            // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
            if (!data.department) errors.push("äº‹æ¥­éƒ¨åãŒæœªè¨­å®šã§ã™");
            if (!data.timestamp) errors.push("ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœªè¨­å®šã§ã™");
            if (!data.sales || !data.sales.monthly) errors.push("å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™");
            if (!data.cogs || !data.cogs.monthly) errors.push("å£²ä¸ŠåŸä¾¡ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™");

            // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿é…åˆ—é•·ãƒã‚§ãƒƒã‚¯
            if (data.sales.monthly && data.sales.monthly.length !== 12) {
                errors.push(`å£²ä¸Šæœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ãŒ12é …ç›®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ${data.sales.monthly.length}é …ç›®ï¼‰`);
            }
            if (data.cogs.monthly && data.cogs.monthly.length !== 12) {
                errors.push(`å£²ä¸ŠåŸä¾¡æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ãŒ12é …ç›®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ${data.cogs.monthly.length}é …ç›®ï¼‰`);
            }

            // æ•°å€¤ç¯„å›²ãƒã‚§ãƒƒã‚¯
            if (data.sales.monthly) {
                data.sales.monthly.forEach((value, index) => {
                    if (typeof value !== 'number' || value < 0) {
                        errors.push(`å£²ä¸Šãƒ‡ãƒ¼ã‚¿${index + 1}æœˆç›®ãŒä¸æ­£ãªå€¤ã§ã™: ${value}`);
                    }
                });
            }

            // å¹´é–“åˆè¨ˆãƒã‚§ãƒƒã‚¯
            if (data.sales.monthly) {
                const calculatedAnnual = data.sales.monthly.reduce((sum, value) => sum + value, 0);
                if (Math.abs(calculatedAnnual - data.sales.annual) > 1) {
                    warnings.push(`å£²ä¸Šå¹´é–“åˆè¨ˆãŒæœˆæ¬¡åˆè¨ˆã¨ä¸€è‡´ã—ã¾ã›ã‚“ï¼ˆå·®é¡: ${Math.abs(calculatedAnnual - data.sales.annual)}ï¼‰`);
                }
            }

            return {
                errors,
                warnings,
                isValid: errors.length === 0,
                status: errors.length === 0 ? (warnings.length === 0 ? "success" : "warning") : "error"
            };
        }

        // äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡
        function sendDepartmentData(department) {
            try {
                logMessage(`ğŸ“¤ ${department.toUpperCase()}äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’é–‹å§‹...`);
                
                const data = createStandardPLData(department);
                
                // å¹´é–“åˆè¨ˆã‚’è¨ˆç®—
                data.sales.annual = data.sales.monthly.reduce((sum, val) => sum + val, 0);
                data.cogs.annual = data.cogs.monthly.reduce((sum, val) => sum + val, 0);
                
                // å„è²»ç”¨é …ç›®ã®å¹´é–“åˆè¨ˆã‚‚è¨ˆç®—
                Object.keys(data.expenses).forEach(key => {
                    if (data.expenses[key].monthly) {
                        data.expenses[key].annual = data.expenses[key].monthly.reduce((sum, val) => sum + val, 0);
                    }
                });

                // LocalStorageã«ä¿å­˜
                const storageKey = STORAGE_KEYS[`${department}_data`];
                const jsonData = JSON.stringify(data);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
                if (jsonData.length > 5000000) { // 5MBåˆ¶é™
                    throw new Error("ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™");
                }
                
                localStorage.setItem(storageKey, jsonData);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                updateStatus(department, "success", "é€ä¿¡å®Œäº†");
                logMessage(`âœ… ${department.toUpperCase()}äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†`);
                
            } catch (error) {
                updateStatus(department, "error", "é€ä¿¡å¤±æ•—");
                logMessage(`âŒ ${department.toUpperCase()}äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡å¤±æ•—: ${error.message}`);
            }
        }

        // äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
        function validateDepartmentData(department) {
            try {
                const storageKey = STORAGE_KEYS[`${department}_data`];
                const storedData = localStorage.getItem(storageKey);
                
                if (!storedData) {
                    showValidationResults([{
                        type: 'error',
                        message: `${department.toUpperCase()}äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`
                    }]);
                    return;
                }

                const data = JSON.parse(storedData);
                const validation = validatePLData(data);
                
                const results = [];
                
                if (validation.isValid) {
                    results.push({
                        type: 'success',
                        message: `${department.toUpperCase()}äº‹æ¥­éƒ¨: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼æˆåŠŸ`
                    });
                }
                
                validation.errors.forEach(error => {
                    results.push({
                        type: 'error',
                        message: `${department.toUpperCase()}äº‹æ¥­éƒ¨ã‚¨ãƒ©ãƒ¼: ${error}`
                    });
                });
                
                validation.warnings.forEach(warning => {
                    results.push({
                        type: 'warning',
                        message: `${department.toUpperCase()}äº‹æ¥­éƒ¨è­¦å‘Š: ${warning}`
                    });
                });
                
                showValidationResults(results);
                logMessage(`ğŸ” ${department.toUpperCase()}äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å®Œäº†: ${validation.status}`);
                
            } catch (error) {
                showValidationResults([{
                    type: 'error',
                    message: `${department.toUpperCase()}äº‹æ¥­éƒ¨ã®æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`
                }]);
                logMessage(`âŒ ${department.toUpperCase()}äº‹æ¥­éƒ¨ã®æ¤œè¨¼å¤±æ•—: ${error.message}`);
            }
        }

        // å…¨äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡
        function sendAllData() {
            logMessage("ğŸš€ å…¨äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬é€ä¿¡ã‚’é–‹å§‹...");
            const departments = ['sr', 'w', 'rc', 'rcd'];
            
            departments.forEach((dept, index) => {
                setTimeout(() => {
                    sendDepartmentData(dept);
                }, index * 500); // 0.5ç§’é–“éš”ã§å®Ÿè¡Œ
            });
        }

        // ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ»çµ±åˆ
        function receiveAndCombineData() {
            try {
                logMessage("ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å—ä¿¡ãƒ»çµ±åˆå‡¦ç†ã‚’é–‹å§‹...");
                
                const departments = ['sr', 'w', 'rc', 'rcd'];
                const combinedData = {
                    timestamp: new Date().toISOString(),
                    departments: {},
                    totals: {
                        sales: { monthly: new Array(12).fill(0), annual: 0 },
                        cogs: { monthly: new Array(12).fill(0), annual: 0 },
                        grossProfit: { monthly: new Array(12).fill(0), annual: 0 }
                    },
                    validation: {
                        errors: [],
                        warnings: [],
                        status: "success"
                    }
                };

                let allDataValid = true;

                departments.forEach(dept => {
                    const storageKey = STORAGE_KEYS[`${dept}_data`];
                    const storedData = localStorage.getItem(storageKey);
                    
                    if (storedData) {
                        try {
                            const data = JSON.parse(storedData);
                            const validation = validatePLData(data);
                            
                            if (validation.isValid) {
                                combinedData.departments[dept] = data;
                                
                                // åˆè¨ˆå€¤ã«åŠ ç®—
                                for (let i = 0; i < 12; i++) {
                                    combinedData.totals.sales.monthly[i] += data.sales.monthly[i] || 0;
                                    combinedData.totals.cogs.monthly[i] += data.cogs.monthly[i] || 0;
                                    combinedData.totals.grossProfit.monthly[i] = 
                                        combinedData.totals.sales.monthly[i] - combinedData.totals.cogs.monthly[i];
                                }
                                
                                logMessage(`âœ… ${dept.toUpperCase()}äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã«è¿½åŠ `);
                            } else {
                                allDataValid = false;
                                combinedData.validation.errors.push(`${dept}äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™`);
                                logMessage(`âŒ ${dept.toUpperCase()}äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™`);
                            }
                        } catch (error) {
                            allDataValid = false;
                            combinedData.validation.errors.push(`${dept}äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿è§£æã«å¤±æ•—`);
                            logMessage(`âŒ ${dept.toUpperCase()}äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿ã®è§£æå¤±æ•—: ${error.message}`);
                        }
                    } else {
                        allDataValid = false;
                        combinedData.validation.errors.push(`${dept}äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                        logMessage(`âš ï¸ ${dept.toUpperCase()}äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                    }
                });

                // å¹´é–“åˆè¨ˆè¨ˆç®—
                combinedData.totals.sales.annual = combinedData.totals.sales.monthly.reduce((sum, val) => sum + val, 0);
                combinedData.totals.cogs.annual = combinedData.totals.cogs.monthly.reduce((sum, val) => sum + val, 0);
                combinedData.totals.grossProfit.annual = combinedData.totals.grossProfit.monthly.reduce((sum, val) => sum + val, 0);

                // çµ±åˆãƒ‡ãƒ¼ã‚¿ä¿å­˜
                localStorage.setItem(STORAGE_KEYS.combined_data, JSON.stringify(combinedData));
                
                if (allDataValid) {
                    updateStatus('combined', 'success', 'çµ±åˆå®Œäº†');
                    logMessage("âœ… ãƒ‡ãƒ¼ã‚¿çµ±åˆå‡¦ç†å®Œäº†");
                } else {
                    updateStatus('combined', 'error', 'çµ±åˆå¤±æ•—');
                    logMessage("âŒ ãƒ‡ãƒ¼ã‚¿çµ±åˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                }

            } catch (error) {
                updateStatus('combined', 'error', 'çµ±åˆå¤±æ•—');
                logMessage(`âŒ ãƒ‡ãƒ¼ã‚¿çµ±åˆå‡¦ç†å¤±æ•—: ${error.message}`);
            }
        }

        // çµ±åˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function showCombinedData() {
            try {
                const combinedData = localStorage.getItem(STORAGE_KEYS.combined_data);
                if (!combinedData) {
                    alert("çµ±åˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ‡ãƒ¼ã‚¿çµ±åˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
                    return;
                }

                const data = JSON.parse(combinedData);
                const results = [];

                results.push({
                    type: 'success',
                    message: `çµ±åˆãƒ‡ãƒ¼ã‚¿ä½œæˆæ—¥æ™‚: ${new Date(data.timestamp).toLocaleString('ja-JP')}`
                });

                results.push({
                    type: 'success',
                    message: `çµ±åˆå¯¾è±¡äº‹æ¥­éƒ¨æ•°: ${Object.keys(data.departments).length}éƒ¨é–€`
                });

                results.push({
                    type: 'success',
                    message: `å¹´é–“å£²ä¸Šåˆè¨ˆ: ${data.totals.sales.annual.toLocaleString()}ä¸‡å††`
                });

                results.push({
                    type: 'success',
                    message: `å¹´é–“å£²ä¸ŠåŸä¾¡åˆè¨ˆ: ${data.totals.cogs.annual.toLocaleString()}ä¸‡å††`
                });

                results.push({
                    type: 'success',
                    message: `å¹´é–“ç²—åˆ©åˆè¨ˆ: ${data.totals.grossProfit.annual.toLocaleString()}ä¸‡å††`
                });

                if (data.validation.errors.length > 0) {
                    data.validation.errors.forEach(error => {
                        results.push({
                            type: 'error',
                            message: `çµ±åˆã‚¨ãƒ©ãƒ¼: ${error}`
                        });
                    });
                }

                showValidationResults(results);
                logMessage("ğŸ“Š çµ±åˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œäº†");

            } catch (error) {
                logMessage(`âŒ çµ±åˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå¤±æ•—: ${error.message}`);
            }
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (confirm("å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚»ãƒƒãƒˆ
                const departments = ['sr', 'w', 'rc', 'rcd', 'combined'];
                departments.forEach(dept => {
                    updateStatus(dept, 'pending', dept === 'combined' ? 'æœªä½œæˆ' : 'æœªé€ä¿¡');
                });
                
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚¯ãƒªã‚¢
                document.getElementById('validationResults').innerHTML = '<p>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„...</p>';
                
                logMessage("ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†");
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(department, status, message) {
            const statusElement = document.getElementById(`status-${department}`);
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `status-${status}`;
            }
        }

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœè¡¨ç¤º
        function showValidationResults(results) {
            const container = document.getElementById('validationResults');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = '<p>ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `validation-item validation-${result.type}`;
                div.textContent = result.message;
                container.appendChild(div);
            });
        }

        // ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
        function logMessage(message) {
            const logArea = document.getElementById('systemLog');
            const now = new Date().toLocaleTimeString('ja-JP');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${now}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logMessage("ğŸš€ PLçµ±åˆã‚·ã‚¹ãƒ†ãƒ  ãƒ‡ãƒ¼ã‚¿é€å—ä¿¡ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†");
            
            // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰è¨­å®š
            localStorage.setItem(STORAGE_KEYS.test_mode, 'true');
            logMessage("ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–");
        });
    </script>
</body>
</html>
