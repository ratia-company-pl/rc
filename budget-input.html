<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4事業部統合PLシミュレーター - 予算入力システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ヘッダー部 - 高情報密度版 */
        .header-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 12px 20px;
        }
        
        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .main-title {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 6px;
            margin: 0;
        }
        
        .subtitle {
            color: #4a5568;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .kpi-card {
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
        }
        
        .kpi-card:nth-child(1) { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .kpi-card:nth-child(2) { background: linear-gradient(135deg, #374151, #1f2937); }
        .kpi-card:nth-child(3) { background: linear-gradient(135deg, #dc2626, #991b1b); }
        .kpi-card:nth-child(4) { background: linear-gradient(135deg, #7c3aed, #5b21b6); }
        
        .kpi-label {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .kpi-value {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .action-buttons {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* 連携状態表示は削除 */
        
        /* 事業部セクション - コンパクト版 */
        .department-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--dept-color);
        }
        
        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .department-title {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .department-title::before {
            content: '';
            width: 14px;
            height: 14px;
            background: var(--dept-color);
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .annual-summary {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dept-color);
        }
        
        /* チャート部分 - コンパクト版 */
        .chart-container {
            height: 140px;
            margin-bottom: 15px;
            background: white;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .chart-legend {
            position: absolute;
            top: 2px;
            right: 8px;
            display: flex;
            gap: 8px;
            font-size: 0.7rem;
            z-index: 10;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .legend-color {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }
        
        .legend-blue { background: rgba(59, 130, 246, 0.7); }
        .legend-green { background: rgba(34, 197, 94, 0.7); }
        
        /* ボタン統合行 */
        .action-buttons-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .preset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            flex: 1;
        }
        
        .preset-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preset-btn.green { background: #48bb78; color: white; }
        .preset-btn.orange { background: #ed8936; color: white; }
        .preset-btn.red { background: #e53e3e; color: white; }
        .preset-btn.blue { background: #4299e1; color: white; }
        .preset-btn.purple { background: #805ad5; color: white; }
        
        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .send-buttons {
            display: flex;
            gap: 8px;
        }
        
        .send-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .send-btn.sr-send { background: linear-gradient(135deg, #e53e3e, #c53030); }
        .send-btn.w-send { background: linear-gradient(135deg, #3182ce, #2c5aa0); }
        .send-btn.rc-send { background: linear-gradient(135deg, #38a169, #2f855a); }
        .send-btn.rcd-send { background: linear-gradient(135deg, #805ad5, #6b46c1); }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* データテーブル */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: center;
        }
        
        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        .data-table input {
            width: 100%;
            padding: 4px 6px;
            border: none;
            background: rgba(66, 153, 225, 0.1);
            border-radius: 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        
        .data-table input:focus {
            background: rgba(66, 153, 225, 0.2);
            outline: none;
        }
        
        /* 設定統合エリア - 簡潔版 */
        .settings-consolidated {
            background: linear-gradient(135deg, #fffcf0, #fff8e1);
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .setting-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }
        
        .setting-item label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }
        
        .setting-item input,
        .setting-item select {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #d2d6dc;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        
        /* 情報表示エリア - テーブル下に移動 */
        .info-panel {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            padding: 10px;
            margin-top: 15px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }
        
        .info-item {
            font-size: 0.8rem;
        }
        
        .info-item strong {
            color: #1e40af;
        }
        
        /* RC用の特別設定 */
        .rc-target-setting {
            background: #ebf8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .rc-target-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rc-target-input input {
            width: 80px;
            padding: 6px;
            text-align: center;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
        }
        
        .rc-current-display {
            font-weight: 600;
            color: #3182ce;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .kpi-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .preset-buttons {
                justify-content: center;
            }
            
            .send-buttons {
                justify-content: center;
            }
            
            .department-header {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 10px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー部 - KPIカード形式 -->
        <div class="header-section">
            <div class="title-row">
                <div class="main-title">4事業部統合PLシミュレーター - 予算入力システム</div>
                <div class="subtitle">4事業部統合売上予算管理システム</div>
            </div>
            
            <div class="kpi-cards">
                <div class="kpi-card">
                    <div class="kpi-label">統合年間売上</div>
                    <div class="kpi-value" id="total-revenue">0万円</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">前年比増減</div>
                    <div class="kpi-value" id="revenue-diff">+0万円</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">データ送信状況</div>
                    <div class="kpi-value" id="sync-status">準備中</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">完成進度</div>
                    <div class="kpi-value">100%</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn btn-secondary" onclick="location.href='index.html'">
                    メインダッシュボード
                </button>
                <button class="action-btn btn-primary" onclick="sendAllDataAndNavigateToPL()">
                    一括送信・事業部合計PL確認
                </button>
                <button class="action-btn btn-secondary" onclick="exportToJSON()">
                    データエクスポート
                </button>
            </div>
        </div>
        
        <!-- 連携状態表示は削除 -->
        
        <!-- SR事業部 -->
        <div class="department-section" style="--dept-color: #e53e3e;">
            <div class="department-header">
                <div class="department-title">SR事業部</div>
                <div class="annual-summary" id="sr-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <!-- チャート -->
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="sr-chart"></canvas>
            </div>
            
            <!-- ボタン統合行 -->
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applySRPreset('actual')">実績値</button>
                    <button class="preset-btn orange" onclick="applySRPreset('50p')">店舗50万増</button>
                    <button class="preset-btn orange" onclick="applySRPreset('100p')">店舗100万増</button>
                    <button class="preset-btn red" onclick="applySRPreset('150p')">店舗150万増</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn sr-send" onclick="sendSRDataToPLSystem()">
                        PL送信
                    </button>
                    <button class="send-btn sr-send" onclick="navigateToSRPL()">
                        SR詳細
                    </button>
                </div>
            </div>
            
            <!-- データテーブル -->
            <div style="overflow-x: auto;">
                <table class="data-table" id="sr-table">
                    <!-- SRテーブル（JavaScript生成） -->
                </table>
            </div>
            
            <!-- 情報パネル - テーブル下に移動 -->
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>店舗数:</strong> 6店舗</div>
                    <div class="info-item"><strong>仕入原価率:</strong> 27.2%</div>
                    <div class="info-item"><strong>人件費:</strong> 売上レンジ別係数</div>
                    <div class="info-item"><strong>特殊手当:</strong> 営業コミッション・賞与</div>
                </div>
            </div>
            
            <!-- 設定統合エリア -->
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>営業手当 <span style="color: #718096; font-size: 0.65rem;">2/6/10月</span></label>
                        <input type="number" id="sr-commission" value="100" onchange="calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>6月賞与</label>
                        <input type="number" id="sr-bonus6" value="100" onchange="calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>12月賞与</label>
                        <input type="number" id="sr-bonus12" value="0" onchange="calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>広告宣伝費</label>
                        <input type="number" id="sr-advertising" value="30" onchange="calculateSR()">
                    </div>
                </div>
            </div>
        </div>

        <!-- W事業部 -->
        <div class="department-section" style="--dept-color: #3182ce;">
            <div class="department-header">
                <div class="department-title">W事業部</div>
                <div class="annual-summary" id="w-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <!-- チャート -->
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="w-chart"></canvas>
            </div>
            
            <!-- ボタン統合行 -->
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyWPreset('actual')">実績値</button>
                    <button class="preset-btn blue" onclick="applyWPreset('200')">毎月200万増</button>
                    <button class="preset-btn purple" onclick="applyWPreset('400')">毎月400万増</button>
                    <button class="preset-btn red" onclick="applyWPreset('600')">毎月600万増</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn w-send" onclick="sendWDataToPLSystem()">
                        PL送信
                    </button>
                    <button class="send-btn w-send" onclick="navigateToWPL()">
                        W詳細
                    </button>
                </div>
            </div>
            
            <!-- データテーブル -->
            <div style="overflow-x: auto;">
                <table class="data-table" id="w-table">
                    <!-- Wテーブル（JavaScript生成） -->
                </table>
            </div>
            
            <!-- 情報パネル - テーブル下に移動 -->
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>入力方式:</strong> 統合月別売上</div>
                    <div class="info-item"><strong>仕入原価率:</strong> 29.96%</div>
                    <div class="info-item"><strong>人件費:</strong> 売上レンジ別固定金額</div>
                    <div class="info-item"><strong>支払手数料:</strong> 売上連動(6%/8%)</div>
                </div>
            </div>
            
            <!-- 設定統合エリア -->
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>広告宣伝費</label>
                        <input type="number" id="w-advertising" value="50" onchange="calculateW()">
                    </div>
                </div>
            </div>
        </div>

        <!-- RC卸事業部 -->
        <div class="department-section" style="--dept-color: #38a169;">
            <div class="department-header">
                <div class="department-title">RC卸</div>
                <div class="annual-summary" id="rc-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <!-- チャート -->
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="rc-chart"></canvas>
            </div>
            
            <!-- 目標設定エリア -->
            <div class="rc-target-setting">
                <span style="font-size: 0.9rem; font-weight: 600;">目標売上設定(%):</span>
                <div class="rc-target-input">
                    <input type="number" id="rc-target-rate" value="0" step="0.1" min="0" max="50" onchange="applyRCTargetRate()">
                    <span>%</span>
                </div>
                <div class="rc-current-display">
                    現在の設定: カスタム設定 <span id="rc-current-rate">0</span>%
                </div>
            </div>
            
            <!-- ボタン統合行 -->
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn blue" onclick="applyRCPreset('standard')">標準設定</button>
                    <button class="preset-btn green" onclick="applyRCPreset('actual')">実績パターン</button>
                    <button class="preset-btn green" onclick="applyRCPreset('growth')">成長モデル(4%)</button>
                    <button class="preset-btn purple" onclick="applyRCPreset('improvement')">大幅改善(7%)</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn rc-send" onclick="sendRCDataToPLSystem()">
                        PL送信
                    </button>
                    <button class="send-btn rc-send" onclick="navigateToRCPL()">
                        RC詳細
                    </button>
                </div>
            </div>
            
            <!-- データテーブル -->
            <div style="overflow-x: auto;">
                <table class="data-table" id="rc-table">
                    <!-- RCテーブル（JavaScript生成） -->
                </table>
            </div>
            
            <!-- 情報パネル - テーブル下に移動 -->
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>基準売上:</strong> 1550万円/月</div>
                    <div class="info-item"><strong>仕入原価率:</strong> 35.2%</div>
                    <div class="info-item"><strong>人件費:</strong> 固定50万円/月</div>
                    <div class="info-item"><strong>計算方式:</strong> 基準+増減額</div>
                </div>
            </div>
            
            <!-- 設定統合エリア -->
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>広告宣伝費</label>
                        <input type="number" id="rc-advertising" value="40" onchange="calculateRC()">
                    </div>
                    <div class="setting-item">
                        <label>展示会関連費</label>
                        <input type="number" id="rc-exhibition" value="20" onchange="calculateRC()">
                    </div>
                </div>
            </div>
        </div>

        <!-- RCD社事業部 -->
        <div class="department-section" style="--dept-color: #805ad5;">
            <div class="department-header">
                <div class="department-title">RCD社</div>
                <div class="annual-summary" id="rcd-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <!-- チャート -->
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="rcd-chart"></canvas>
            </div>
            
            <!-- ボタン統合行 -->
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn red" onclick="applyRCDPreset('zero')">0設定</button>
                    <button class="preset-btn green" onclick="applyRCDPreset('actual')">実績パターン</button>
                    <button class="preset-btn blue" onclick="applyRCDPreset('standard')">標準設定(月8本)</button>
                    <button class="preset-btn orange" onclick="applyRCDPreset('seven')">月7本設定</button>
                    <button class="preset-btn purple" onclick="applyRCDPreset('six')">月6本設定</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn rcd-send" onclick="sendRCDDataToPLSystem()">
                        PL送信
                    </button>
                    <button class="send-btn rcd-send" onclick="navigateToRCDPL()">
                        RCD詳細
                    </button>
                </div>
            </div>
            
            <!-- データテーブル -->
            <div style="overflow-x: auto;">
                <table class="data-table" id="rcd-table">
                    <!-- RCDテーブル（JavaScript生成） -->
                </table>
            </div>
            
            <!-- 情報パネル - テーブル下に移動 -->
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>仕入単価:</strong> 2,000万円/本</div>
                    <div class="info-item"><strong>利益率:</strong> 3%固定</div>
                    <div class="info-item"><strong>支払手数料:</strong> 1件90.6万円×回数</div>
                    <div class="info-item"><strong>外部委託:</strong> 人件費・経費0円</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // localStorage統一ルール - 新プレフィックス対応
        const LOCAL_STORAGE_KEYS = {
            sr_data: 'pl_system_sr_data',
            w_data: 'pl_system_w_data',
            rc_data: 'pl_system_rc_data',
            rcd_data: 'pl_system_rcd_data',
            sr_settings: 'pl_system_sr_settings',
            w_settings: 'pl_system_w_settings',
            rc_settings: 'pl_system_rc_settings',
            rcd_settings: 'pl_system_rcd_settings'
        };

        // 旧キーから新キーへの移行処理
        function migrateLocalStorageKeys() {
            const migrations = [
                { old: 'sr_sales_data', new: LOCAL_STORAGE_KEYS.sr_data },
                { old: 'w_sales_data', new: LOCAL_STORAGE_KEYS.w_data },
                { old: 'rc_sales_data', new: LOCAL_STORAGE_KEYS.rc_data },
                { old: 'rcd_sales_data', new: LOCAL_STORAGE_KEYS.rcd_data },
                { old: 'sr_pl_settings', new: LOCAL_STORAGE_KEYS.sr_settings },
                { old: 'w_pl_settings', new: LOCAL_STORAGE_KEYS.w_settings },
                { old: 'rc_pl_settings', new: LOCAL_STORAGE_KEYS.rc_settings },
                { old: 'rcd_pl_settings', new: LOCAL_STORAGE_KEYS.rcd_settings }
            ];

            migrations.forEach(migration => {
                const oldData = localStorage.getItem(migration.old);
                const newData = localStorage.getItem(migration.new);
                
                if (oldData && !newData) {
                    localStorage.setItem(migration.new, oldData);
                    console.log(`Migrated ${migration.old} to ${migration.new}`);
                }
            });
        }

        // 基本データ（integrated_pl_engine.tsxから移植）
        const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
        
        // 参考データ（前年実績）
        const referenceData = {
            SR: [2236, 2916, 2927, 2810, 2544, 2663, 3008, 2324, 2403, 2602, 2228, 2721],
            W: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
            RC: [1947, 1645, 1530, 1730, 1165, 1846, 1475, 1585, 1241, 1173, 1602, 1420],
            RCD: [11037, 14297, 11504, 14664, 12507, 14920, 13661, 15455, 14439, 15857, 15478, 16360]
        };

        // 現在のデータ状態
        let currentData = {
            sr: {
                stores: {
                    '清水店': [416, 397, 421, 502, 471, 544, 567, 476, 355, 408, 299, 346],
                    '静岡店': [369, 386, 600, 535, 285, 437, 351, 270, 369, 391, 256, 242],
                    '掛川店': [284, 375, 508, 278, 394, 394, 377, 309, 248, 469, 448, 535],
                    '市野店': [328, 547, 723, 520, 528, 607, 574, 318, 714, 657, 700, 600],
                    '住吉小店': [349, 719, 247, 433, 308, 265, 516, 311, 222, 293, 272, 379],
                    '広島店': [490, 493, 427, 542, 558, 416, 622, 641, 496, 385, 253, 620]
                },
                variables: {
                    commission: 100,
                    bonus6: 100,
                    bonus12: 0,
                    advertising: 30
                }
            },
            w: {
                sales: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
                variables: {
                    advertising: 50
                }
            },
            rc: {
                baseSales: 1550,
                variations: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                targetRate: 0,
                variables: {
                    advertising: 40,
                    exhibition: 20
                }
            },
            rcd: {
                purchases: [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
                fees: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
            }
        };

        // チャートインスタンス保存用
        let charts = {};

        // 一括送信・事業部合計PL確認機能
        function sendAllDataAndNavigateToPL() {
            try {
                // 4事業部のデータを一括送信
                sendSRDataToPLSystem();
                sendWDataToPLSystem(); 
                sendRCDataToPLSystem();
                sendRCDDataToPLSystem();
                
                // 一括送信完了フラグを設定
                localStorage.setItem('all_data_sync_flag', JSON.stringify({
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                }));
                
                updateLinkageStatus('success', '✅ 全事業部データを一括送信しました');
                
                // 事業部合計PLページへ遷移
                setTimeout(() => {
                    window.location.href = 'combined-dashboard/index.html';
                }, 1000);
                
                alert('全事業部データを事業部合計PLに送信しました！\n\n1秒後に事業部合計PLページに移動します。');
                
            } catch (error) {
                updateLinkageStatus('error', '❌ 一括送信に失敗しました');
                alert('一括送信に失敗しました: ' + error.message);
            }
        }

        // 数値フォーマット
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        // チャート作成関数
        function createDepartmentChart(containerId, referenceData, currentData, deptName) {
            const ctx = document.getElementById(containerId).getContext('2d');
            
            // 既存のチャートを破棄
            if (charts[containerId]) {
                charts[containerId].destroy();
            }
            
            charts[containerId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '参考売上',
                            data: referenceData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '予算設定',
                            data: currentData,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false  // レジェンドを非表示
                        },
                        title: {
                            display: false  // タイトルを非表示
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 9
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 9
                                }
                            }
                        }
                    }
                }
            });
        }

        // SRデータをPLシステムに送信する新機能
        function sendSRDataToPLSystem() {
            try {
                // SRの月次売上合計を計算
                const monthlySales = months.map((_, i) => {
                    return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
                });

                // SRデータを保存
                const srSalesData = {
                    monthlySales: monthlySales,
                    timestamp: new Date().toISOString()
                };

                const srSettings = {
                    commission: currentData.sr.variables.commission,
                    bonus6: currentData.sr.variables.bonus6,
                    bonus12: currentData.sr.variables.bonus12,
                    advertising: currentData.sr.variables.advertising
                };

                // localStorage に保存（新ルール適用）
                localStorage.setItem(LOCAL_STORAGE_KEYS.sr_data, JSON.stringify(srSalesData));
                localStorage.setItem(LOCAL_STORAGE_KEYS.sr_settings, JSON.stringify(srSettings));

                // 状態表示を更新
                updateLinkageStatus('success', '✅ SRデータを正常に送信しました');

                // 成功メッセージ
                alert('SRデータをPLシステムに送信しました！\n\n' +
                      '年間合計: ' + formatNumber(monthlySales.reduce((sum, val) => sum + val, 0)) + '万円\n' +
                      '送信時刻: ' + new Date().toLocaleTimeString());

            } catch (error) {
                updateLinkageStatus('error', '❌ データ送信に失敗しました');
                alert('データ送信に失敗しました: ' + error.message);
            
