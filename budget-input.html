<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4事業部統合PLシミュレーター - 予算入力システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* ヘッダー部 - 超コンパクト版 */
        .header-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 8px 15px;
        }
        
        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .main-title {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 4px;
            margin: 0;
        }
        
        .subtitle {
            color: #4a5568;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .kpi-card {
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.7rem;
        }
        
        .kpi-card:nth-child(1) { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .kpi-card:nth-child(2) { background: linear-gradient(135deg, #374151, #1f2937); }
        .kpi-card:nth-child(3) { background: linear-gradient(135deg, #dc2626, #991b1b); }
        .kpi-card:nth-child(4) { background: linear-gradient(135deg, #7c3aed, #5b21b6); }
        
        .kpi-label {
            font-size: 0.6rem;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .kpi-value {
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .action-buttons {
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
        }
        
        .restore-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        /* 事業部セクション - 超コンパクト版 */
        .department-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 3px solid var(--dept-color);
        }
        
        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .department-title {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .department-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--dept-color);
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .annual-summary {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--dept-color);
        }
        
        /* チャート部分 - 超コンパクト版 */
        .chart-container {
            height: 80px;
            margin-bottom: 8px;
            background: white;
            border-radius: 4px;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .chart-legend {
            position: absolute;
            top: 2px;
            right: 6px;
            display: flex;
            gap: 6px;
            font-size: 0.6rem;
            z-index: 10;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .legend-color {
            width: 6px;
            height: 6px;
            border-radius: 1px;
        }
        
        .legend-blue { background: rgba(59, 130, 246, 0.7); }
        .legend-green { background: rgba(34, 197, 94, 0.7); }
        
        /* ボタン統合行 - 超コンパクト版 */
        .action-buttons-row {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .preset-buttons {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            flex: 1;
        }
        
        .preset-btn {
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preset-btn.green { background: #48bb78; color: white; }
        .preset-btn.orange { background: #ed8936; color: white; }
        .preset-btn.red { background: #e53e3e; color: white; }
        .preset-btn.blue { background: #4299e1; color: white; }
        .preset-btn.purple { background: #805ad5; color: white; }
        
        .preset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .send-buttons {
            display: flex;
            gap: 3px;
        }
        
        .send-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .send-btn.sr-send { background: linear-gradient(135deg, #e53e3e, #c53030); }
        .send-btn.w-send { background: linear-gradient(135deg, #3182ce, #2c5aa0); }
        .send-btn.rc-send { background: linear-gradient(135deg, #38a169, #2f855a); }
        .send-btn.rcd-send { background: linear-gradient(135deg, #805ad5, #6b46c1); }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* データテーブル - 超コンパクト版 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 8px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #e2e8f0;
            padding: 3px 4px;
            text-align: center;
            line-height: 1.1;
        }
        
        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.6rem;
        }
        
        .data-table input {
            width: 100%;
            padding: 1px 3px;
            border: 1px solid #ddd;
            background: rgba(66, 153, 225, 0.1);
            border-radius: 2px;
            text-align: center;
            font-size: 0.6rem;
            height: 18px;
        }
        
        .data-table input:focus {
            background: rgba(66, 153, 225, 0.2);
            outline: 1px solid #4299e1;
        }
        
        /* 設定統合エリア - 超コンパクト版 */
        .settings-consolidated {
            background: linear-gradient(135deg, #fffcf0, #fff8e1);
            border: 1px solid #f6e05e;
            border-radius: 4px;
            padding: 6px;
            margin-top: 6px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 4px;
        }
        
        .setting-item {
            background: white;
            padding: 3px;
            border-radius: 2px;
            border: 1px solid #e2e8f0;
        }
        
        .setting-item label {
            display: block;
            font-size: 0.6rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1px;
        }
        
        .setting-item input,
        .setting-item select {
            width: 100%;
            padding: 1px 3px;
            border: 1px solid #d2d6dc;
            border-radius: 2px;
            font-size: 0.6rem;
            height: 18px;
        }
        
        /* 情報表示エリア - 超コンパクト版 */
        .info-panel {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 4px;
            padding: 4px;
            margin-top: 6px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 3px;
        }
        
        .info-item {
            font-size: 0.6rem;
        }
        
        .info-item strong {
            color: #1e40af;
        }
        
        /* RC用の特別設定 - 超コンパクト版 */
        .rc-target-setting {
            background: #ebf8ff;
            padding: 6px;
            border-radius: 4px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .rc-target-input {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .rc-target-input input {
            width: 50px;
            padding: 2px;
            text-align: center;
            border: 1px solid #cbd5e0;
            border-radius: 2px;
            font-size: 0.6rem;
            height: 18px;
        }
        
        .rc-current-display {
            font-weight: 600;
            color: #3182ce;
            font-size: 0.6rem;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .kpi-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .preset-buttons,
            .send-buttons {
                justify-content: center;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー部 -->
        <div class="header-section">
            <div class="title-row">
                <div class="main-title">4事業部統合PLシミュレーター - 予算入力システム</div>
                <div class="subtitle">4事業部統合売上予算管理システム</div>
            </div>
            
            <div class="kpi-cards">
                <div class="kpi-card">
                    <div class="kpi-label">統合年間売上</div>
                    <div class="kpi-value" id="total-revenue">0万円</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">前年比増減</div>
                    <div class="kpi-value" id="revenue-diff">+0万円</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">データ送信状況</div>
                    <div class="kpi-value" id="sync-status">準備中</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">完成進度</div>
                    <div class="kpi-value">100%</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn btn-secondary" onclick="location.href='index.html'">
                    メインダッシュボード
                </button>
                <button class="action-btn btn-primary" onclick="sendAllDataAndNavigateToPL()">
                    一括送信・事業部合計PL確認
                </button>
                <button class="action-btn btn-secondary" onclick="exportToJSON()">
                    データエクスポート
                </button>
                <button class="action-btn restore-btn" onclick="restoreFromLocalStorage()">
                    保存データ復元
                </button>
            </div>
        </div>
        
        <!-- SR事業部 -->
        <div class="department-section" style="--dept-color: #e53e3e;">
            <div class="department-header">
                <div class="department-title">SR事業部</div>
                <div class="annual-summary" id="sr-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="sr-chart"></canvas>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applySRPreset('actual')">実績値</button>
                    <button class="preset-btn orange" onclick="applySRPreset('50p')">店舗50万増</button>
                    <button class="preset-btn orange" onclick="applySRPreset('100p')">店舗100万増</button>
                    <button class="preset-btn red" onclick="applySRPreset('150p')">店舗150万増</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn sr-send" onclick="sendSRDataToPLSystem()">PL送信</button>
                    <button class="send-btn sr-send" onclick="navigateToSRPL()">SR詳細</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="sr-table">
                    <thead>
                        <tr>
                            <th>店舗</th>
                            <th>項目</th>
                            <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                            <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        </tr>
                    </thead>
                    <tbody id="sr-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>店舗数:</strong> 6店舗</div>
                    <div class="info-item"><strong>仕入原価率:</strong> 27.2%</div>
                    <div class="info-item"><strong>人件費:</strong> 売上レンジ別係数</div>
                    <div class="info-item"><strong>特殊手当:</strong> 営業コミッション・賞与</div>
                </div>
            </div>
            
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>営業手当</label>
                        <input type="number" id="sr-commission" value="100" onchange="updateSRSettings(); calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>6月賞与</label>
                        <input type="number" id="sr-bonus6" value="100" onchange="updateSRSettings(); calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>12月賞与</label>
                        <input type="number" id="sr-bonus12" value="0" onchange="updateSRSettings(); calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>広告宣伝費</label>
                        <input type="number" id="sr-advertising" value="30" onchange="updateSRSettings(); calculateSR()">
                    </div>
                </div>
            </div>
        </div>

        <!-- W事業部 -->
        <div class="department-section" style="--dept-color: #3182ce;">
            <div class="department-header">
                <div class="department-title">W事業部</div>
                <div class="annual-summary" id="w-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="w-chart"></canvas>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyWPreset('actual')">実績値</button>
                    <button class="preset-btn blue" onclick="applyWPreset('200')">毎月200万増</button>
                    <button class="preset-btn purple" onclick="applyWPreset('400')">毎月400万増</button>
                    <button class="preset-btn red" onclick="applyWPreset('600')">毎月600万増</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn w-send" onclick="sendWDataToPLSystem()">PL送信</button>
                    <button class="send-btn w-send" onclick="navigateToWPL()">W詳細</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="w-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                            <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        </tr>
                    </thead>
                    <tbody id="w-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>入力方式:</strong> 統合月別売上</div>
                    <div class="info-item"><strong>仕入原価率:</strong> 29.96%</div>
                    <div class="info-item"><strong>人件費:</strong> 売上レンジ別固定金額</div>
                    <div class="info-item"><strong>支払手数料:</strong> 売上連動(6%/8%)</div>
                </div>
            </div>
            
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>広告宣伝費</label>
                        <input type="number" id="w-advertising" value="50" onchange="updateWSettings(); calculateW()">
                    </div>
                </div>
            </div>
        </div>

        <!-- RC店事業部 -->
        <div class="department-section" style="--dept-color: #38a169;">
            <div class="department-header">
                <div class="department-title">RC店</div>
                <div class="annual-summary" id="rc-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="rc-chart"></canvas>
            </div>
            
            <div class="rc-target-setting">
                <span style="font-size: 0.6rem; font-weight: 600;">目標売上設定(%):</span>
                <div class="rc-target-input">
                    <input type="number" id="rc-target-rate" value="0" step="0.1" min="0" max="50" onchange="applyRCTargetRate()">
                    <span style="font-size: 0.6rem;">%</span>
                </div>
                <div class="rc-current-display">
                    現在の設定: カスタム設定 <span id="rc-current-rate">0</span>%
                </div>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn blue" onclick="applyRCPreset('standard')">標準設定</button>
                    <button class="preset-btn green" onclick="applyRCPreset('actual')">実績パターン</button>
                    <button class="preset-btn green" onclick="applyRCPreset('growth')">成長モデル(4%)</button>
                    <button class="preset-btn purple" onclick="applyRCPreset('improvement')">大幅改善(7%)</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn rc-send" onclick="sendRCDataToPLSystem()">PL送信</button>
                    <button class="send-btn rc-send" onclick="navigateToRCPL()">RC詳細</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="rc-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                            <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        </tr>
                    </thead>
                    <tbody id="rc-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>基準売上:</strong> 1550万円/月</div>
                    <div class="info-item"><strong>仕入原価率:</strong> 35.2%</div>
                    <div class="info-item"><strong>人件費:</strong> 固定50万円/月</div>
                    <div class="info-item"><strong>計算方式:</strong> 基準+増減額</div>
                </div>
            </div>
            
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>広告宣伝費</label>
                        <input type="number" id="rc-advertising" value="40" onchange="updateRCSettings(); calculateRC()">
                    </div>
                    <div class="setting-item">
                        <label>展示会関連費</label>
                        <input type="number" id="rc-exhibition" value="20" onchange="updateRCSettings(); calculateRC()">
                    </div>
                </div>
            </div>
        </div>

        <!-- RCD社事業部 -->
        <div class="department-section" style="--dept-color: #805ad5;">
            <div class="department-header">
                <div class="department-title">RCD社</div>
                <div class="annual-summary" id="rcd-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="rcd-chart"></canvas>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn red" onclick="applyRCDPreset('zero')">0設定</button>
                    <button class="preset-btn green" onclick="applyRCDPreset('actual')">実績パターン</button>
                    <button class="preset-btn blue" onclick="applyRCDPreset('standard')">標準設定(月8本)</button>
                    <button class="preset-btn orange" onclick="applyRCDPreset('seven')">月7本設定</button>
                    <button class="preset-btn purple" onclick="applyRCDPreset('six')">月6本設定</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn rcd-send" onclick="sendRCDDataToPLSystem()">PL送信</button>
                    <button class="send-btn rcd-send" onclick="navigateToRCDPL()">RCD詳細</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="rcd-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                            <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        </tr>
                    </thead>
                    <tbody id="rcd-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>仕入単価:</strong> 2,000万円/本</div>
                    <div class="info-item"><strong>利益率:</strong> 3%固定</div>
                    <div class="info-item"><strong>支払手数料:</strong> 1件90.6万円×回数</div>
                    <div class="info-item"><strong>外部委託:</strong> 人件費・経費0円</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // localStorage統一ルール
        const LOCAL_STORAGE_KEYS = {
            sr_data: 'pl_system_sr_data',
            w_data: 'pl_system_w_data',
            rc_data: 'pl_system_rc_data',
            rcd_data: 'pl_system_rcd_data',
            sr_settings: 'pl_system_sr_settings',
            w_settings: 'pl_system_w_settings',
            rc_settings: 'pl_system_rc_settings',
            rcd_settings: 'pl_system_rcd_settings',
            input_values: 'pl_system_input_values'
        };

        // 基本データ
        const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
        
        const referenceData = {
            SR: [2236, 2916, 2927, 2810, 2544, 2663, 3008, 2324, 2403, 2602, 2228, 2721],
            W: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
            RC: [1947, 1645, 1530, 1730, 1165, 1846, 1475, 1585, 1241, 1173, 1602, 1420],
            RCD: [11037, 14297, 11504, 14664, 12507, 14920, 13661, 15455, 14439, 15857, 15478, 16360]
        };

        let currentData = {
            sr: {
                stores: {
                    '清水店': [416, 397, 421, 502, 471, 544, 567, 476, 355, 408, 299, 346],
                    '静岡店': [369, 386, 600, 535, 285, 437, 351, 270, 369, 391, 256, 242],
                    '掛川店': [284, 375, 508, 278, 394, 394, 377, 309, 248, 469, 448, 535],
                    '市野店': [328, 547, 723, 520, 528, 607, 574, 318, 714, 657, 700, 600],
                    '住吉台店': [349, 719, 247, 433, 308, 265, 516, 311, 222, 293, 272, 379],
                    '広島店': [490, 493, 427, 542, 558, 416, 622, 641, 496, 385, 253, 620]
                },
                variables: {
                    commission: 100,
                    bonus6: 100,
                    bonus12: 0,
                    advertising: 30
                }
            },
            w: {
                sales: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
                variables: {
                    advertising: 50
                }
            },
            rc: {
                baseSales: 1550,
                variations: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                targetRate: 0,
                variables: {
                    advertising: 40,
                    exhibition: 20
                }
            },
            rcd: {
                purchases: [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
                fees: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
            }
        };

        let charts = {};

        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        // 入力値の自動保存・復元
        function saveInputValues() {
            try {
                const inputValues = {
                    timestamp: new Date().toISOString(),
                    currentData: JSON.parse(JSON.stringify(currentData))
                };
                localStorage.setItem(LOCAL_STORAGE_KEYS.input_values, JSON.stringify(inputValues));
            } catch (error) {
                console.error('Error saving input values:', error);
            }
        }

        function loadInputValues() {
            try {
                const saved = localStorage.getItem(LOCAL_STORAGE_KEYS.input_values);
                if (saved) {
                    const inputValues = JSON.parse(saved);
                    if (inputValues.currentData) {
                        currentData = inputValues.currentData;
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error loading input values:', error);
                return false;
            }
        }

        function restoreFromLocalStorage() {
            const restored = loadInputValues();
            if (restored) {
                updateAllUIElements();
                generateAllTables();
                calculateAllDepartments();
                updateAllCharts();
                alert('保存されたデータを復元しました！\n復元時刻: ' + new Date().toLocaleTimeString());
            } else {
                alert('復元可能なデータが見つかりませんでした。');
            }
        }

        function updateAllUIElements() {
            const elements = {
                'sr-commission': currentData.sr.variables.commission,
                'sr-bonus6': currentData.sr.variables.bonus6,
                'sr-bonus12': currentData.sr.variables.bonus12,
                'sr-advertising': currentData.sr.variables.advertising,
                'w-advertising': currentData.w.variables.advertising,
                'rc-advertising': currentData.rc.variables.advertising,
                'rc-exhibition': currentData.rc.variables.exhibition,
                'rc-target-rate': currentData.rc.targetRate
            };

            Object.entries(elements).forEach(([id, value]) => {
                const elem = document.getElementById(id);
                if (elem) elem.value = value;
            });

            const rcCurrentRateElem = document.getElementById('rc-current-rate');
            if (rcCurrentRateElem) rcCurrentRateElem.textContent = currentData.rc.targetRate;
        }

        function generateAllTables() {
            generateSRTable();
            generateWTable();
            generateRCTable();
            generateRCDTable();
        }

        function calculateAllDepartments() {
            calculateSR();
            calculateW();
            calculateRC();
            calculateRCD();
        }

        function updateAllCharts() {
            setTimeout(() => {
                updateSRChart();
                updateWChart();
                updateRCChart();
                updateRCDChart();
            }, 100);
        }

        // 設定値更新関数群
        function updateSRSettings() {
            currentData.sr.variables.commission = parseInt(document.getElementById('sr-commission').value) || 0;
            currentData.sr.variables.bonus6 = parseInt(document.getElementById('sr-bonus6').value) || 0;
            currentData.sr.variables.bonus12 = parseInt(document.getElementById('sr-bonus12').value) || 0;
            currentData.sr.variables.advertising = parseInt(document.getElementById('sr-advertising').value) || 0;
            saveInputValues();
        }

        function updateWSettings() {
            currentData.w.variables.advertising = parseInt(document.getElementById('w-advertising').value) || 0;
            saveInputValues();
        }

        function updateRCSettings() {
            currentData.rc.variables.advertising = parseInt(document.getElementById('rc-advertising').value) || 0;
            currentData.rc.variables.exhibition = parseInt(document.getElementById('rc-exhibition').value) || 0;
            saveInputValues();
        }

        // テーブル生成関数
        function generateSRTable() {
            try {
                const tableBody = document.getElementById('sr-table-body');
                if (!tableBody) return;

                let html = '';
                
                const totals = months.map((_, i) => {
                    return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
                });

                html += `
                    <tr style="background: #ebf8ff; font-weight: 600;">
                        <td rowspan="3" style="background: #3182ce; color: white;">合計</td>
                        <td style="color: #1e40af;">売上</td>
                        ${totals.map(total => `<td style="color: #1e40af;"><strong>${formatNumber(total)}</strong></td>`).join('')}
                    </tr>
                    <tr style="background: #ebf8ff;">
                        <td style="color: #059669;">増減</td>
                        ${totals.map((total, i) => {
                            const diff = total - referenceData.SR[i];
                            const color = diff >= 0 ? '#059669' : '#dc2626';
                            return `<td style="color: ${color}; font-weight: 600;">${diff >= 0 ? '+' : ''}${formatNumber(diff)}</td>`;
                        }).join('')}
                    </tr>
                    <tr style="background: #f3f4f6;">
                        <td style="color: #6b7280;">参考</td>
                        ${referenceData.SR.map(val => `<td style="color: #6b7280;">${formatNumber(val)}</td>`).join('')}
                    </tr>
                `;

                Object.entries(currentData.sr.stores).forEach(([storeName, values]) => {
                    html += `
                        <tr style="background: white;">
                            <td rowspan="2" style="font-weight: 600;">${storeName}</td>
                            <td style="color: #3182ce; font-weight: 600;">売上</td>
                            ${values.map((val, i) => `
                                <td>
                                    <input type="number" value="${val}" 
                                           onchange="updateSRStore('${storeName}', ${i}, this.value)">
                                </td>
                            `).join('')}
                        </tr>
                        <tr style="background: #f9fafb;">
                            <td style="color: #6b7280;">参考</td>
                            ${values.map(val => `<td style="color: #6b7280; font-size: 0.55rem;">${formatNumber(val)}</td>`).join('')}
                        </tr>
                    `;
                });

                tableBody.innerHTML = html;
            } catch (error) {
                console.error('Error generating SR table:', error);
            }
        }

        function generateWTable() {
            try {
                const tableBody = document.getElementById('w-table-body');
                if (!tableBody) return;

                let html = `
                    <tr style="background: white;">
                        <td style="font-weight: 600; color: #3182ce;">売上</td>
                        ${currentData.w.sales.map((val, i) => `
                            <td>
                                <input type="number" value="${val}" 
                                       onchange="updateWSales(${i}, this.value)">
                            </td>
                        `).join('')}
                    </tr>
                    <tr style="background: white;">
                        <td style="font-weight: 600;">増減</td>
                        ${currentData.w.sales.map((val, i) => {
                            const diff = val - referenceData.W[i];
                            const color = diff >= 0 ? '#059669' : '#dc2626';
                            return `<td style="color: ${color}; font-weight: 600; text-align: center;">${diff >= 0 ? '+' : ''}${formatNumber(diff)}</td>`;
                        }).join('')}
                    </tr>
                    <tr style="background: #f3f4f6;">
                        <td style="color: #6b7280;">参考</td>
                        ${referenceData.W.map(val => `<td style="color: #6b7280; text-align: center;">${formatNumber(val)}</td>`).join('')}
                    </tr>
                `;
                tableBody.innerHTML = html;
            } catch (error) {
                console.error('Error generating W table:', error);
            }
        }

        function generateRCTable() {
            try {
                const tableBody = document.getElementById('rc-table-body');
                if (!tableBody) return;

                let html = `
                    <tr style="background: white;">
                        <td style="font-weight: 600; color: #3182ce;">増減</td>
                        ${currentData.rc.variations.map((val, i) => `
                            <td>
                                <input type="number" value="${val}" 
                                       onchange="updateRCVariation(${i}, this.value)">
                            </td>
                        `).join('')}
                    </tr>
                    <tr style="background: #f0fff4; border-left: 4px solid #059669;">
                        <td style="font-weight: 600; color: #059669;">売上</td>
                        ${currentData.rc.variations.map(val => `
                            <td style="color: #059669; font-weight: 600; text-align: center;">
                                ${formatNumber(currentData.rc.baseSales + val)}
                            </td>
                        `).join('')}
                    </tr>
                    <tr style="background: white;">
                        <td style="font-weight: 600;">対前年増減</td>
                        ${currentData.rc.variations.map((val, i) => {
                            const currentSales = currentData.rc.baseSales + val;
                            const diff = currentSales - referenceData.RC[i];
                            const color = diff >= 0 ? '#059669' : '#dc2626';
                            return `<td style="color: ${color}; font-weight: 600; text-align: center;">${diff >= 0 ? '+' : ''}${formatNumber(diff)}</td>`;
                        }).join('')}
                    </tr>
                    <tr style="background: #f3f4f6;">
                        <td style="color: #6b7280;">参考</td>
                        ${referenceData.RC.map(val => `<td style="color: #6b7280; text-align: center;">${formatNumber(val)}</td>`).join('')}
                    </tr>
                `;
                tableBody.innerHTML = html;
            } catch (error) {
                console.error('Error generating RC table:', error);
            }
        }

        function generateRCDTable() {
            try {
                const tableBody = document.getElementById('rcd-table-body');
                if (!tableBody) return;

                let html = `
                    <tr style="background: white;">
                        <td style="font-weight: 600; color: #3182ce;">仕入</td>
                        ${currentData.rcd.purchases.map((val, i) => `
                            <td>
                                <input type="number" step="0.1" value="${val}" 
                                       onchange="updateRCDPurchase(${i}, this.value)">
                            </td>
                        `).join('')}
                    </tr>
                    <tr style="background: #f0fff4; border-left: 4px solid #059669;">
                        <td style="font-weight: 600; color: #059669;">売上</td>
                        ${currentData.rcd.purchases.map(val => `
                            <td style="color: #059669; font-weight: 600; text-align: center;">
                                ${formatNumber(Math.round(val * 2000 * 1.03))}
                            </td>
                        `).join('')}
                    </tr>
                    <tr style="background: white;">
                        <td style="font-weight: 600;">対前年増減</td>
                        ${currentData.rcd.purchases.map((val, i) => {
                            const currentSales = Math.round(val * 2000 * 1.03);
                            const diff = currentSales - referenceData.RCD[i];
                            const color = diff >= 0 ? '#059669' : '#dc2626';
                            return `<td style="color: ${color}; font-weight: 600; text-align: center;">${diff >= 0 ? '+' : ''}${formatNumber(diff)}</td>`;
                        }).join('')}
                    </tr>
                    <tr style="background: #fffbeb; border-left: 4px solid #f59e0b;">
                        <td style="font-weight: 600; color: #b45309;">手数料</td>
                        ${currentData.rcd.fees.map((val, i) => `
                            <td>
                                <input type="number" min="0" max="10" value="${val}" 
                                       onchange="updateRCDFee(${i}, this.value)">
                                <div style="font-size: 0.55rem; color: #b45309; text-align: center; line-height: 1;">
                                    ${formatNumber(Math.round(val * 90.6))}万
                                </div>
                            </td>
                        `).join('')}
                    </tr>
                    <tr style="background: #f3f4f6;">
                        <td style="color: #6b7280;">参考</td>
                        ${referenceData.RCD.map(val => `<td style="color: #6b7280; text-align: center;">${formatNumber(val)}</td>`).join('')}
                    </tr>
                `;
                tableBody.innerHTML = html;
            } catch (error) {
                console.error('Error generating RCD table:', error);
            }
        }

        // チャート作成関数
        function createDepartmentChart(containerId, referenceDataArray, currentDataArray, deptName) {
            try {
                const ctx = document.getElementById(containerId);
                if (!ctx) {
                    console.error(`Chart container ${containerId} not found`);
                    return;
                }
                
                if (charts[containerId]) {
                    charts[containerId].destroy();
                }
                
                charts[containerId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: '参考売上',
                                data: referenceDataArray,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '予算設定',
                                data: currentDataArray,
                                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: { size: 8 }
                                }
                            },
                            x: {
                                ticks: {
                                    font: { size: 8 }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error(`Error creating chart ${containerId}:`, error);
            }
        }

        // データ更新関数群
        function updateSRStore(storeName, monthIndex, value) {
            currentData.sr.stores[storeName][monthIndex] = parseInt(value) || 0;
            saveInputValues();
            calculateSR();
            generateSRTable();
            updateSRChart();
        }

        function updateWSales(monthIndex, value) {
            currentData.w.sales[monthIndex] = parseInt(value) || 0;
            saveInputValues();
            calculateW();
            generateWTable();
            updateWChart();
        }

        function updateRCVariation(monthIndex, value) {
            currentData.rc.variations[monthIndex] = parseInt(value) || 0;
            saveInputValues();
            calculateRC();
            generateRCTable();
            updateRCChart();
        }

        function updateRCDPurchase(monthIndex, value) {
            currentData.rcd.purchases[monthIndex] = parseFloat(value) || 0;
            saveInputValues();
            calculateRCD();
            generateRCDTable();
            updateRCDChart();
        }

        function updateRCDFee(monthIndex, value) {
            currentData.rcd.fees[monthIndex] = parseInt(value) || 0;
            saveInputValues();
            calculateRCD();
            generateRCDTable();
        }

        // 計算関数群
        function calculateSR() {
            try {
                const totals = months.map((_, i) => {
                    return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
                });
                const annual = totals.reduce((sum, val) => sum + val, 0);
                const refTotal = referenceData.SR.reduce((sum, val) => sum + val, 0);
                const diff = annual - refTotal;

                const annualElement = document.getElementById('sr-annual');
                if (annualElement) {
                    annualElement.textContent = 
                        `年間合計: ${formatNumber(annual)}万円　前年増減: ${diff >= 0 ? '+' : ''}${formatNumber(diff)}万円`;
                }
                
                updateKPIs();
            } catch (error) {
                console.error('Error in calculateSR:', error);
            }
        }

        function calculateW() {
            try {
                const annual = currentData.w.sales.reduce((sum, val) => sum + val, 0);
                const refTotal = referenceData.W.reduce((sum, val) => sum + val, 0);
                const diff = annual - refTotal;

                const annualElement = document.getElementById('w-annual');
                if (annualElement) {
                    annualElement.textContent = 
                        `年間合計: ${formatNumber(annual)}万円　前年増減: ${diff >= 0 ? '+' : ''}${formatNumber(diff)}万円`;
                }
                
                updateKPIs();
            } catch (error) {
                console.error('Error in calculateW:', error);
            }
        }

        function calculateRC() {
            try {
                const totals = currentData.rc.variations.map(variation => currentData.rc.baseSales + variation);
                const annual = totals.reduce((sum, val) => sum + val, 0);
                const refTotal = referenceData.RC.reduce((sum, val) => sum + val, 0);
                const diff = annual - refTotal;

                const annualElement = document.getElementById('rc-annual');
                if (annualElement) {
                    annualElement.textContent = 
                        `年間合計: ${formatNumber(annual)}万円　前年増減: ${diff >= 0 ? '+' : ''}${formatNumber(diff)}万円`;
                }
                
                updateKPIs();
            } catch (error) {
                console.error('Error in calculateRC:', error);
            }
        }

        function calculateRCD() {
            try {
                const totals = currentData.rcd.purchases.map(purchase => Math.round(purchase * 2000 * 1.03));
                const annual = totals.reduce((sum, val) => sum + val, 0);
                const refTotal = referenceData.RCD.reduce((sum, val) => sum + val, 0);
                const diff = annual - refTotal;

                const annualElement = document.getElementById('rcd-annual');
                if (annualElement) {
                    annualElement.textContent = 
                        `年間合計: ${formatNumber(annual)}万円　前年増減: ${diff >= 0 ? '+' : ''}${formatNumber(diff)}万円`;
                }
                
                updateKPIs();
            } catch (error) {
                console.error('Error in calculateRCD:', error);
            }
        }

        function updateKPIs() {
            try {
                const srTotal = months.map((_, i) => {
                    return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
                }).reduce((sum, val) => sum + val, 0);

                const wTotal = currentData.w.sales.reduce((sum, val) => sum + val, 0);
                const rcTotal = currentData.rc.variations.map(variation => 
                    currentData.rc.baseSales + variation
                ).reduce((sum, val) => sum + val, 0);
                const rcdTotal = currentData.rcd.purchases.map(purchase => 
                    Math.round(purchase * 2000 * 1.03)
                ).reduce((sum, val) => sum + val, 0);

                const totalRevenue = srTotal + wTotal + rcTotal + rcdTotal;

                const refTotals = {
                    SR: referenceData.SR.reduce((sum, val) => sum + val, 0),
                    W: referenceData.W.reduce((sum, val) => sum + val, 0),
                    RC: referenceData.RC.reduce((sum, val) => sum + val, 0),
                    RCD: referenceData.RCD.reduce((sum, val) => sum + val, 0)
                };
                const totalRefRevenue = refTotals.SR + refTotals.W + refTotals.RC + refTotals.RCD;
                const totalDiff = totalRevenue - totalRefRevenue;

                const totalRevenueElement = document.getElementById('total-revenue');
                const revenueDiffElement = document.getElementById('revenue-diff');
                const syncStatusElement = document.getElementById('sync-status');

                if (totalRevenueElement) {
                    totalRevenueElement.textContent = formatNumber(totalRevenue) + '万円';
                }
                if (revenueDiffElement) {
                    revenueDiffElement.textContent = (totalDiff >= 0 ? '+' : '') + formatNumber(totalDiff) + '万円';
                }
                if (syncStatusElement) {
                    syncStatusElement.textContent = '送信準備完了';
                }
            } catch (error) {
                console.error('Error in updateKPIs:', error);
            }
        }

        // チャート更新関数群
        function updateSRChart() {
            const totals = months.map((_, i) => {
                return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
            });
            createDepartmentChart('sr-chart', referenceData.SR, totals, 'SR事業部');
        }

        function updateWChart() {
            createDepartmentChart('w-chart', referenceData.W, currentData.w.sales, 'W事業部');
        }

        function updateRCChart() {
            const totals = currentData.rc.variations.map(variation => currentData.rc.baseSales + variation);
            createDepartmentChart('rc-chart', referenceData.RC, totals, 'RC店事業部');
        }

        function updateRCDChart() {
            const totals = currentData.rcd.purchases.map(purchase => Math.round(purchase * 2000 * 1.03));
            createDepartmentChart('rcd-chart', referenceData.RCD, totals, 'RCD社事業部');
        }

        // プリセット関数群
        function applySRPreset(presetType) {
            const storeNames = Object.keys(currentData.sr.stores);
            storeNames.forEach(storeName => {
                for (let i = 0; i < 12; i++) {
                    switch(presetType) {
                        case 'actual':
                            const storeIndex = storeNames.indexOf(storeName);
                            const storeData = [
                                [416, 397, 421, 502, 471, 544, 567, 476, 355, 408, 299, 346],
                                [369, 386, 600, 535, 285, 437, 351, 270, 369, 391, 256, 242],
                                [284, 375, 508, 278, 394, 394, 377, 309, 248, 469, 448, 535],
                                [328, 547, 723, 520, 528, 607, 574, 318, 714, 657, 700, 600],
                                [349, 719, 247, 433, 308, 265, 516, 311, 222, 293, 272, 379],
                                [490, 493, 427, 542, 558, 416, 622, 641, 496, 385, 253, 620]
                            ];
                            currentData.sr.stores[storeName][i] = storeData[storeIndex][i];
                            break;
                        case '50p':
                            currentData.sr.stores[storeName][i] += 50;
                            break;
                        case '100p':
                            currentData.sr.stores[storeName][i] += 100;
                            break;
                        case '150p':
                            currentData.sr.stores[storeName][i] += 150;
                            break;
                    }
                }
            });
            saveInputValues();
            calculateSR();
            generateSRTable();
            updateSRChart();
        }

        function applyWPreset(presetType) {
            for (let i = 0; i < 12; i++) {
                switch(presetType) {
                    case 'actual':
                        currentData.w.sales[i] = referenceData.W[i];
                        break;
                    case '200':
                        currentData.w.sales[i] = referenceData.W[i] + 200;
                        break;
                    case '400':
                        currentData.w.sales[i] = referenceData.W[i] + 400;
                        break;
                    case '600':
                        currentData.w.sales[i] = referenceData.W[i] + 600;
                        break;
                }
            }
            saveInputValues();
            calculateW();
            generateWTable();
            updateWChart();
        }

        function applyRCPreset(presetType) {
            switch(presetType) {
                case 'standard':
                    currentData.rc.variations = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                    currentData.rc.targetRate = 0;
                    break;
                case 'actual':
                    currentData.rc.variations = referenceData.RC.map(ref => ref - currentData.rc.baseSales);
                    currentData.rc.targetRate = 0;
                    break;
                case 'growth':
                    currentData.rc.variations = referenceData.RC.map(ref => {
                        const targetSales = Math.round(ref * 1.04);
                        return targetSales - currentData.rc.baseSales;
                    });
                    currentData.rc.targetRate = 4;
                    break;
                case 'improvement':
                    currentData.rc.variations = referenceData.RC.map(ref => {
                        const targetSales = Math.round(ref * 1.07);
                        return targetSales - currentData.rc.baseSales;
                    });
                    currentData.rc.targetRate = 7;
                    break;
            }
            const rcTargetRateElem = document.getElementById('rc-target-rate');
            const rcCurrentRateElem = document.getElementById('rc-current-rate');
            if (rcTargetRateElem) rcTargetRateElem.value = currentData.rc.targetRate;
            if (rcCurrentRateElem) rcCurrentRateElem.textContent = currentData.rc.targetRate;
            saveInputValues();
            calculateRC();
            generateRCTable();
            updateRCChart();
        }

        function applyRCDPreset(presetType) {
            switch(presetType) {
                case 'zero':
                    currentData.rcd.fees = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                    break;
                case 'actual':
                    currentData.rcd.purchases = referenceData.RCD.map(refSales => {
                        const purchaseCount = refSales / (2000 * 1.03);
                        return Math.floor(purchaseCount * 10) / 10;
                    });
                    currentData.rcd.fees = [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1];
                    break;
                case 'standard':
                    currentData.rcd.purchases = [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8];
                    currentData.rcd.fees = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
                    break;
                case 'seven':
                    currentData.rcd.purchases = [7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7];
                    currentData.rcd.fees = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
                    break;
                case 'six':
                    currentData.rcd.purchases = [6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6];
                    currentData.rcd.fees = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                    break;
            }
            saveInputValues();
            calculateRCD();
            generateRCDTable();
            updateRCDChart();
        }

        function applyRCTargetRate() {
            const targetRateElem = document.getElementById('rc-target-rate');
            const currentRateElem = document.getElementById('rc-current-rate');
            
            if (targetRateElem && currentRateElem) {
                const targetRate = parseFloat(targetRateElem.value) || 0;
                currentData.rc.variations = referenceData.RC.map(ref => {
                    const targetSales = Math.round(ref * (1 + targetRate / 100));
                    return targetSales - currentData.rc.baseSales;
                });
                currentData.rc.targetRate = targetRate;
                currentRateElem.textContent = targetRate;
                saveInputValues();
                calculateRC();
                generateRCTable();
                updateRCChart();
            }
        }

        // 送信機能群
        function sendSRDataToPLSystem() {
            try {
                const monthlySales = months.map((_, i) => {
                    return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
                });

                const srSalesData = {
                    monthlySales: monthlySales,
                    timestamp: new Date().toISOString()
                };

                const srSettings = {
                    commission: currentData.sr.variables.commission,
                    bonus6: currentData.sr.variables.bonus6,
                    bonus12: currentData.sr.variables.bonus12,
                    advertising: currentData.sr.variables.advertising
                };

                localStorage.setItem(LOCAL_STORAGE_KEYS.sr_data, JSON.stringify(srSalesData));
                localStorage.setItem(LOCAL_STORAGE_KEYS.sr_settings, JSON.stringify(srSettings));

                const annual = monthlySales.reduce((sum, val) => sum + val, 0);
                alert('SRデータをPLシステムに送信しました！\n\n' +
                      '年間合計: ' + formatNumber(annual) + '万円\n' +
                      '送信時刻: ' + new Date().toLocaleTimeString());

            } catch (error) {
                alert('データ送信に失敗しました: ' + error.message);
            }
        }

        function sendWDataToPLSystem() {
            try {
                const wSalesData = {
                    monthlySales: currentData.w.sales,
                    timestamp: new Date().toISOString()
                };

                const wSettings = {
                    advertising: currentData.w.variables.advertising
                };

                localStorage.setItem(LOCAL_STORAGE_KEYS.w_data, JSON.stringify(wSalesData));
                localStorage.setItem(LOCAL_STORAGE_KEYS.w_settings, JSON.stringify(wSettings));

                const annual = currentData.w.sales.reduce((sum, val) => sum + val, 0);
                alert('WデータをPLシステムに送信しました！\n\n' +
                      '年間合計: ' + formatNumber(annual) + '万円\n' +
                      '送信時刻: ' + new Date().toLocaleTimeString());

            } catch (error) {
                alert('Wデータ送信に失敗しました: ' + error.message);
            }
        }

        function sendRCDataToPLSystem() {
            try {
                const rcSalesData = {
                    baseSales: currentData.rc.baseSales,
                    variations: currentData.rc.variations,
                    timestamp: new Date().toISOString()
                };

                const rcSettings = {
                    advertising: currentData.rc.variables.advertising,
                    decemberExhibition: currentData.rc.variables.exhibition,
                    aprilBoothFee: currentData.rc.variables.exhibition
                };

                localStorage.setItem(LOCAL_STORAGE_KEYS.rc_data, JSON.stringify(rcSalesData));
                localStorage.setItem(LOCAL_STORAGE_KEYS.rc_settings, JSON.stringify(rcSettings));

                const monthlySales = currentData.rc.variations.map(variation => currentData.rc.baseSales + variation);
                const annual = monthlySales.reduce((sum, val) => sum + val, 0);
                alert('RCデータをPLシステムに送信しました！\n\n' +
                      '年間合計: ' + formatNumber(annual) + '万円\n' +
                      '送信時刻: ' + new Date().toLocaleTimeString());

            } catch (error) {
                alert('RCデータ送信に失敗しました: ' + error.message);
            }
        }

        function sendRCDDataToPLSystem() {
            try {
                const rcdSalesData = {
                    purchases: currentData.rcd.purchases,
                    timestamp: new Date().toISOString()
                };

                const rcdSettings = {
                    feeOccurrences: currentData.rcd.fees
                };

                localStorage.setItem(LOCAL_STORAGE_KEYS.rcd_data, JSON.stringify(rcdSalesData));
                localStorage.setItem(LOCAL_STORAGE_KEYS.rcd_settings, JSON.stringify(rcdSettings));

                const monthlySales = currentData.rcd.purchases.map(purchase => Math.round(purchase * 2000 * 1.03));
                const annual = monthlySales.reduce((sum, val) => sum + val, 0);
                alert('RCDデータをPLシステムに送信しました！\n\n' +
                      '年間合計: ' + formatNumber(annual) + '万円\n' +
                      '送信時刻: ' + new Date().toLocaleTimeString());

            } catch (error) {
                alert('RCDデータ送信に失敗しました: ' + error.message);
            }
        }

        function sendAllDataAndNavigateToPL() {
            try {
                sendSRDataToPLSystem();
                sendWDataToPLSystem(); 
                sendRCDataToPLSystem();
                sendRCDDataToPLSystem();
                
                localStorage.setItem('all_data_sync_flag', JSON.stringify({
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                }));
                
                setTimeout(() => {
                    window.location.href = 'combined-dashboard/index.html';
                }, 1000);
                
                alert('全事業部データを事業部合計PLに送信しました！\n\n1秒後に事業部合計PLページに移動します。');
                
            } catch (error) {
                alert('一括送信に失敗しました: ' + error.message);
            }
        }

        // ナビゲーション機能
        function navigateToSRPL() {
            window.location.href = 'department-pl/sr-pl.html';
        }

        function navigateToWPL() {
            window.location.href = 'department-pl/w-pl.html';
        }

        function navigateToRCPL() {
            window.location.href = 'department-pl/rc-pl.html';
        }

        function navigateToRCDPL() {
            window.location.href = 'department-pl/rcd-pl.html';
        }

        // エクスポート機能
        function exportToJSON() {
            const exportData = {
                timestamp: new Date().toISOString(),
                data: currentData,
                summary: {
                    totalRevenue: getCurrentTotalRevenue(),
                    breakdown: getCurrentBreakdown()
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'budget_input_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function getCurrentTotalRevenue() {
            const srTotal = months.map((_, i) => {
                return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
            }).reduce((sum, val) => sum + val, 0);

            const wTotal = currentData.w.sales.reduce((sum, val) => sum + val, 0);
            const rcTotal = currentData.rc.variations.map(variation => 
                currentData.rc.baseSales + variation
            ).reduce((sum, val) => sum + val, 0);
            const rcdTotal = currentData.rcd.purchases.map(purchase => 
                Math.round(purchase * 2000 * 1.03)
            ).reduce((sum, val) => sum + val, 0);

            return srTotal + wTotal + rcTotal + rcdTotal;
        }

        function getCurrentBreakdown() {
            const srTotal = months.map((_, i) => {
                return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
            }).reduce((sum, val) => sum + val, 0);

            return {
                SR: srTotal,
                W: currentData.w.sales.reduce((sum, val) => sum + val, 0),
                RC: currentData.rc.variations.map(variation => 
                    currentData.rc.baseSales + variation
                ).reduce((sum, val) => sum + val, 0),
                RCD: currentData.rcd.purchases.map(purchase => 
                    Math.round(purchase * 2000 * 1.03)
                ).reduce((sum, val) => sum + val, 0)
            };
        }

        // 初期化関数
        function initialize() {
            try {
                console.log('Initializing budget input system...');
                
                // 保存されたデータがあれば復元
                const restored = loadInputValues();
                
                if (restored) {
                    updateAllUIElements();
                } else {
                    // 初期値設定
                    updateAllUIElements();
                }

                // テーブル生成
                generateAllTables();
                
                // 計算実行
                calculateAllDepartments();
                
                // チャート初期化
                updateAllCharts();
                
                // KPI更新
                updateKPIs();
                
                console.log('Initialization completed successfully');
                
                // 初期保存（まだ保存データがない場合）
                if (!restored) {
                    saveInputValues();
                }
                
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        }

        // ページ読み込み時に初期化実行
        document.addEventListener('DOMContentLoaded', initialize);
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
