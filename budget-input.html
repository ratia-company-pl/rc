<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - äºˆç®—å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ  Phase 3ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨ - è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆ */
        .header-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 8px 15px;
        }
        
        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .main-title {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 4px;
            margin: 0;
        }
        
        .subtitle {
            color: #4a5568;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* å…±é€šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ  */
        .nav-section {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            margin: -8px -15px 10px -15px;
            padding: 10px 15px;
            border-radius: 0 0 6px 6px;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .btn-nav {
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-nav:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .btn-nav.active {
            background: #3498db;
            border-color: #3498db;
        }
        
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .kpi-card {
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.7rem;
        }
        
        .kpi-card:nth-child(1) { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .kpi-card:nth-child(2) { background: linear-gradient(135deg, #374151, #1f2937); }
        .kpi-card:nth-child(3) { background: linear-gradient(135deg, #dc2626, #991b1b); }
        .kpi-card:nth-child(4) { background: linear-gradient(135deg, #7c3aed, #5b21b6); }
        
        .kpi-label {
            font-size: 0.6rem;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .kpi-value {
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .action-buttons {
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
        }
        
        .restore-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* Phase 3è¿½åŠ : ä¸€æ‹¬é€ä¿¡çŠ¶æ…‹è¡¨ç¤º */
        .batch-send-status {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .batch-send-status.active {
            display: block;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* äº‹æ¥­éƒ¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆ */
        .department-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 3px solid var(--dept-color);
        }
        
        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .department-title {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .department-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--dept-color);
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .annual-summary {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--dept-color);
        }
        
        /* ãƒãƒ£ãƒ¼ãƒˆéƒ¨åˆ† - è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆ */
        .chart-container {
            height: 80px;
            margin-bottom: 8px;
            background: white;
            border-radius: 4px;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .chart-legend {
            position: absolute;
            top: 2px;
            right: 6px;
            display: flex;
            gap: 6px;
            font-size: 0.6rem;
            z-index: 10;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .legend-color {
            width: 6px;
            height: 6px;
            border-radius: 1px;
        }
        
        .legend-blue { background: rgba(59, 130, 246, 0.7); }
        .legend-green { background: rgba(34, 197, 94, 0.7); }
        
        /* ãƒœã‚¿ãƒ³çµ±åˆè¡Œ - è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆ */
        .action-buttons-row {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .preset-buttons {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            flex: 1;
        }
        
        .preset-btn {
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preset-btn.green { background: #48bb78; color: white; }
        .preset-btn.orange { background: #ed8936; color: white; }
        .preset-btn.red { background: #e53e3e; color: white; }
        .preset-btn.blue { background: #4299e1; color: white; }
        .preset-btn.purple { background: #805ad5; color: white; }
        
        .preset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .send-buttons {
            display: flex;
            gap: 3px;
        }
        
        .send-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .send-btn.sr-send { background: linear-gradient(135deg, #e53e3e, #c53030); }
        .send-btn.w-send { background: linear-gradient(135deg, #3182ce, #2c5aa0); }
        .send-btn.rc-send { background: linear-gradient(135deg, #38a169, #2f855a); }
        .send-btn.rcd-send { background: linear-gradient(135deg, #805ad5, #6b46c1); }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« - è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 8px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #e2e8f0;
            padding: 3px 4px;
            text-align: center;
            line-height: 1.1;
        }
        
        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.6rem;
        }
        
        .data-table input {
            width: 100%;
            padding: 1px 3px;
            border: 1px solid #ddd;
            background: rgba(66, 153, 225, 0.1);
            border-radius: 2px;
            text-align: center;
            font-size: 0.6rem;
            height: 18px;
        }
        
        .data-table input:focus {
            background: rgba(66, 153, 225, 0.2);
            outline: 1px solid #4299e1;
        }
        
        /* è¨­å®šçµ±åˆã‚¨ãƒªã‚¢ - è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆ */
        .settings-consolidated {
            background: linear-gradient(135deg, #fffcf0, #fff8e1);
            border: 1px solid #f6e05e;
            border-radius: 4px;
            padding: 6px;
            margin-top: 6px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 4px;
        }
        
        .setting-item {
            background: white;
            padding: 3px;
            border-radius: 2px;
            border: 1px solid #e2e8f0;
        }
        
        .setting-item label {
            display: block;
            font-size: 0.6rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1px;
        }
        
        .setting-item input,
        .setting-item select {
            width: 100%;
            padding: 1px 3px;
            border: 1px solid #d2d6dc;
            border-radius: 2px;
            font-size: 0.6rem;
            height: 18px;
        }
        
        /* æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ - è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆ */
        .info-panel {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 4px;
            padding: 4px;
            margin-top: 6px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 3px;
        }
        
        .info-item {
            font-size: 0.6rem;
        }
        
        .info-item strong {
            color: #1e40af;
        }
        
        /* RCç”¨ã®ç‰¹åˆ¥è¨­å®š - è¶…ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆ */
        .rc-target-setting {
            background: #ebf8ff;
            padding: 6px;
            border-radius: 4px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .rc-target-input {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .rc-target-input input {
            width: 50px;
            padding: 2px;
            text-align: center;
            border: 1px solid #cbd5e0;
            border-radius: 2px;
            font-size: 0.6rem;
            height: 18px;
        }
        
        .rc-current-display {
            font-weight: 600;
            color: #3182ce;
            font-size: 0.6rem;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .kpi-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .preset-buttons,
            .send-buttons {
                justify-content: center;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .nav-buttons {
                gap: 4px;
            }

            .btn-nav {
                padding: 6px 8px;
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨ -->
        <div class="header-section">
            <div class="title-row">
                <div class="main-title">4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - äºˆç®—å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ  Phase 3ä¿®æ­£ç‰ˆ</div>
                <div class="subtitle">ä¸€æ‹¬é€ä¿¡ã‚·ã‚¹ãƒ†ãƒ æ ¹æœ¬ä¿®æ­£å®Œäº†ç‰ˆ</div>
            </div>

            <!-- å…±é€šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ  -->
            <div class="nav-section">
                <div class="nav-buttons">
                    <a href="index.html" class="btn-nav">ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                    <a href="budget-input.html" class="btn-nav active">äºˆç®—å…¥åŠ›</a>
                    <a href="department-pl/sr-pl.html" class="btn-nav">SRäº‹æ¥­éƒ¨PL</a>
                    <a href="department-pl/w-pl.html" class="btn-nav">Wäº‹æ¥­éƒ¨PL</a>
                    <a href="department-pl/rc-pl.html" class="btn-nav">RCå¸äº‹æ¥­éƒ¨PL</a>
                    <a href="department-pl/rcd-pl.html" class="btn-nav">RCDç¤¾äº‹æ¥­éƒ¨PL</a>
                    <a href="combined-dashboard/index.html" class="btn-nav">å…¨ä½“PLanalysis</a>
                </div>
            </div>
            
            <!-- Phase 3è¿½åŠ : ä¸€æ‹¬é€ä¿¡çŠ¶æ…‹è¡¨ç¤º -->
            <div class="batch-send-status" id="batch-status">
                ğŸš€ ä¸€æ‹¬é€ä¿¡å‡¦ç†ä¸­... SRäº‹æ¥­éƒ¨ â†’ Wäº‹æ¥­éƒ¨ â†’ RCå¸ â†’ RCDç¤¾ â†’ çµ±åˆPLé·ç§»
            </div>
            
            <div class="kpi-cards">
                <div class="kpi-card">
                    <div class="kpi-label">çµ±åˆå¹´é–“å£²ä¸Š</div>
                    <div class="kpi-value" id="total-revenue">0ä¸‡å††</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">å‰å¹´æ¯”å¢—æ¸›</div>
                    <div class="kpi-value" id="revenue-diff">+0ä¸‡å††</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">é€ä¿¡çŠ¶æ³</div>
                    <div class="kpi-value" id="sync-status">æº–å‚™ä¸­</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">å®Œæˆé€²åº¦</div>
                    <div class="kpi-value">100%</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn btn-secondary" onclick="location.href='index.html'">
                    ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </button>
                <button class="action-btn btn-primary" onclick="sendAllDataAndNavigateToPL()">
                    ä¸€æ‹¬é€ä¿¡ãƒ»äº‹æ¥­éƒ¨åˆè¨ˆPLç¢ºèª
                </button>
                <button class="action-btn btn-secondary" onclick="exportToJSON()">
                    ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
                <button class="action-btn restore-btn" onclick="restoreFromLocalStorage()">
                    ä¿å­˜ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                </button>
            </div>
        </div>
        
        <!-- SRäº‹æ¥­éƒ¨ -->
        <div class="department-section" style="--dept-color: #e53e3e;">
            <div class="department-header">
                <div class="department-title">SRäº‹æ¥­éƒ¨</div>
                <div class="annual-summary" id="sr-annual">
                    å¹´é–“åˆè¨ˆ: 0ä¸‡å††ã€€å‰å¹´å¢—æ¸›: +0ä¸‡å††
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>å‚è€ƒ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>äºˆç®—</span>
                    </div>
                </div>
                <canvas id="sr-chart"></canvas>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applySRPreset('actual')">å®Ÿç¸¾å€¤</button>
                    <button class="preset-btn orange" onclick="applySRPreset('50p')">åº—èˆ—50ä¸‡å¢—</button>
                    <button class="preset-btn orange" onclick="applySRPreset('100p')">åº—èˆ—100ä¸‡å¢—</button>
                    <button class="preset-btn red" onclick="applySRPreset('150p')">åº—èˆ—150ä¸‡å¢—</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn sr-send" onclick="sendSRDataToPLSystem()">PLé€ä¿¡</button>
                    <button class="send-btn sr-send" onclick="navigateToSRPL()">SRè©³ç´°</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="sr-table">
                    <thead>
                        <tr>
                            <th>åº—èˆ—</th>
                            <th>é …ç›®</th>
                            <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                            <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                        </tr>
                    </thead>
                    <tbody id="sr-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>åº—èˆ—æ•°:</strong> 6åº—èˆ—</div>
                    <div class="info-item"><strong>ä»•å…¥åŸä¾¡ç‡:</strong> 27.2%</div>
                    <div class="info-item"><strong>äººä»¶è²»:</strong> å£²ä¸Šãƒ¬ãƒ³ã‚¸åˆ¥ä¿‚æ•°</div>
                    <div class="info-item"><strong>ç‰¹æ®Šæ‰‹å½“:</strong> å–¶æ¥­ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ»è³ä¸</div>
                </div>
            </div>
            
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>å–¶æ¥­æ‰‹å½“</label>
                        <input type="number" id="sr-commission" value="100" onchange="updateSRSettings(); calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>6æœˆè³ä¸</label>
                        <input type="number" id="sr-bonus6" value="100" onchange="updateSRSettings(); calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>12æœˆè³ä¸</label>
                        <input type="number" id="sr-bonus12" value="0" onchange="updateSRSettings(); calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>åºƒå‘Šå®£ä¼è²»</label>
                        <input type="number" id="sr-advertising" value="30" onchange="updateSRSettings(); calculateSR()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Wäº‹æ¥­éƒ¨ -->
        <div class="department-section" style="--dept-color: #3182ce;">
            <div class="department-header">
                <div class="department-title">Wäº‹æ¥­éƒ¨</div>
                <div class="annual-summary" id="w-annual">
                    å¹´é–“åˆè¨ˆ: 0ä¸‡å††ã€€å‰å¹´å¢—æ¸›: +0ä¸‡å††
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>å‚è€ƒ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>äºˆç®—</span>
                    </div>
                </div>
                <canvas id="w-chart"></canvas>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyWPreset('actual')">å®Ÿç¸¾å€¤</button>
                    <button class="preset-btn blue" onclick="applyWPreset('200')">æ¯æœˆ200ä¸‡å¢—</button>
                    <button class="preset-btn purple" onclick="applyWPreset('400')">æ¯æœˆ400ä¸‡å¢—</button>
                    <button class="preset-btn red" onclick="applyWPreset('600')">æ¯æœˆ600ä¸‡å¢—</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn w-send" onclick="sendWDataToPLSystem()">PLé€ä¿¡</button>
                    <button class="send-btn w-send" onclick="navigateToWPL()">Wè©³ç´°</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="w-table">
                    <thead>
                        <tr>
                            <th>é …ç›®</th>
                            <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                            <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                        </tr>
                    </thead>
                    <tbody id="w-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>å…¥åŠ›æ–¹å¼:</strong> çµ±åˆæœˆåˆ¥å£²ä¸Š</div>
                    <div class="info-item"><strong>ä»•å…¥åŸä¾¡ç‡:</strong> 29.96%</div>
                    <div class="info-item"><strong>äººä»¶è²»:</strong> å£²ä¸Šãƒ¬ãƒ³ã‚¸åˆ¥å›ºå®šé‡‘é¡</div>
                    <div class="info-item"><strong>æ”¯æ‰•æ‰‹æ•°æ–™:</strong> å£²ä¸Šé€£å‹•(6%/8%)</div>
                </div>
            </div>
            
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>åºƒå‘Šå®£ä¼è²»</label>
                        <input type="number" id="w-advertising" value="30" onchange="updateWSettings(); calculateW()">
                    </div>
                </div>
            </div>
        </div>

        <!-- RCå¸åº—äº‹æ¥­éƒ¨ -->
        <div class="department-section" style="--dept-color: #38a169;">
            <div class="department-header">
                <div class="department-title">RCå¸åº—</div>
                <div class="annual-summary" id="rc-annual">
                    å¹´é–“åˆè¨ˆ: 0ä¸‡å††ã€€å‰å¹´å¢—æ¸›: +0ä¸‡å††
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>å‚è€ƒ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>äºˆç®—</span>
                    </div>
                </div>
                <canvas id="rc-chart"></canvas>
            </div>
            
            <div class="rc-target-setting">
                <span style="font-size: 0.6rem; font-weight: 600;">ç›®æ¨™å£²ä¸Šè¨­å®š(%):</span>
                <div class="rc-target-input">
                    <input type="number" id="rc-target-rate" value="0" step="0.1" min="0" max="50" onchange="applyRCTargetRate()">
                    <span style="font-size: 0.6rem;">%</span>
                </div>
                <div class="rc-current-display">
                    ç¾åœ¨ã®è¨­å®š: ã‚«ã‚¹ã‚¿ãƒ è¨­å®š <span id="rc-current-rate">0</span>%
                </div>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyRCPreset('actual')">å®Ÿç¸¾ãƒ‘ã‚¿ãƒ¼ãƒ³</button>
                    <button class="preset-btn blue" onclick="applyRCPreset('standard')">æ¨™æº–è¨­å®š</button>
                    <button class="preset-btn green" onclick="applyRCPreset('growth')">æˆé•·ãƒ¢ãƒ‡ãƒ«(4%)</button>
                    <button class="preset-btn purple" onclick="applyRCPreset('improvement')">å¤§å¹…æ”¹å–„(7%)</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn rc-send" onclick="sendRCDataToPLSystem()">PLé€ä¿¡</button>
                    <button class="send-btn rc-send" onclick="navigateToRCPL()">RCè©³ç´°</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="rc-table">
                    <thead>
                        <tr>
                            <th>é …ç›®</th>
                            <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                            <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                        </tr>
                    </thead>
                    <tbody id="rc-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>åŸºæº–å£²ä¸Š:</strong> 1550ä¸‡å††/æœˆ</div>
                    <div class="info-item"><strong>ä»•å…¥åŸä¾¡ç‡:</strong> 35.2%</div>
                    <div class="info-item"><strong>äººä»¶è²»:</strong> å›ºå®š50ä¸‡å††/æœˆ</div>
                    <div class="info-item"><strong>è¨ˆç®—æ–¹å¼:</strong> åŸºæº–+å¢—æ¸›é¡</div>
                </div>
            </div>
            
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>åºƒå‘Šå®£ä¼è²»ï¼ˆå–¶æ¥­ã‚½ãƒ¼ã‚·ãƒ³ã‚°æƒ³å®šè²»ï¼‰</label>
                        <input type="number" id="rc-advertising" value="40" onchange="updateRCSettings(); calculateRC()">
                    </div>
                    <div class="setting-item">
                        <label>BWJæ±äº¬ãƒ»12æœˆãƒ–ãƒ¼ã‚¹è²»æ”¯æ‰•</label>
                        <input type="number" id="rc-december-booth" value="90" onchange="updateRCSettings(); calculateRC()">
                    </div>
                    <div class="setting-item">
                        <label>5æœˆBWJæ–½å·¥è²»æ”¯æ‰•</label>
                        <input type="number" id="rc-may-booth" value="90" onchange="updateRCSettings(); calculateRC()">
                    </div>
                </div>
            </div>
        </div>

        <!-- RCDç¤¾äº‹æ¥­éƒ¨ -->
        <div class="department-section" style="--dept-color: #805ad5;">
            <div class="department-header">
                <div class="department-title">RCDç¤¾</div>
                <div class="annual-summary" id="rcd-annual">
                    å¹´é–“åˆè¨ˆ: 0ä¸‡å††ã€€å‰å¹´å¢—æ¸›: +0ä¸‡å††
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>å‚è€ƒ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>äºˆç®—</span>
                    </div>
                </div>
                <canvas id="rcd-chart"></canvas>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyRCDPreset('actual')">å®Ÿç¸¾ãƒ‘ã‚¿ãƒ¼ãƒ³</button>
                    <button class="preset-btn red" onclick="applyRCDPreset('zero')">0è¨­å®š</button>
                    <button class="preset-btn blue" onclick="applyRCDPreset('standard')">æ¨™æº–è¨­å®š(æœˆ8æœ¬)</button>
                    <button class="preset-btn orange" onclick="applyRCDPreset('seven')">æœˆ7æœ¬è¨­å®š</button>
                    <button class="preset-btn purple" onclick="applyRCDPreset('six')">æœˆ6æœ¬è¨­å®š</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn rcd-send" onclick="sendRCDDataToPLSystem()">PLé€ä¿¡</button>
                    <button class="send-btn rcd-send" onclick="navigateToRCDPL()">RCDè©³ç´°</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="rcd-table">
                    <thead>
                        <tr>
                            <th>é …ç›®</th>
                            <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                            <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                        </tr>
                    </thead>
                    <tbody id="rcd-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>ä»•å…¥å˜ä¾¡:</strong> 2,000ä¸‡å††/æœ¬</div>
                    <div class="info-item"><strong>åˆ©ç›Šç‡:</strong> 3%å›ºå®š</div>
                    <div class="info-item"><strong>æ”¯æ‰•æ‰‹æ•°æ–™:</strong> 1ä»¶90.6ä¸‡å††Ã—å›æ•°</div>
                    <div class="info-item"><strong>å¤–éƒ¨å§”è¨—:</strong> äººä»¶è²»ãƒ»çµŒè²»0å††</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== Phase 3ä¿®æ­£ç‰ˆ: localStorageãƒ«ãƒ¼ãƒ«ï¼ˆå®Œå…¨ç‰ˆï¼‰ =====
        const LOCAL_STORAGE_KEYS = {
            sr_data: 'pl_system_sr_data',      // çµ±ä¸€ã‚­ãƒ¼ï¼ˆå¤‰æ›´ç¦æ­¢ï¼‰
            w_data: 'pl_system_w_data',
            rc_data: 'pl_system_rc_data',
            rcd_data: 'pl_system_rcd_data',
            sr_settings: 'pl_system_sr_settings',
            w_settings: 'pl_system_w_settings',
            rc_settings: 'pl_system_rc_settings',
            rcd_settings: 'pl_system_rcd_settings',
            input_values: 'pl_system_input_values',
            batch_status: 'pl_system_batch_status'  // Phase 3è¿½åŠ 
        };

        // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿
        const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
        
        const referenceData = {
            SR: [2236, 2916, 2927, 2810, 2544, 2663, 3008, 2324, 2403, 2602, 2228, 2721],
            W: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
            RC: [1947, 1645, 1530, 1730, 1165, 1846, 1475, 1585, 1241, 1173, 1602, 1420],
            RCD: [11037, 14297, 11504, 14664, 12507, 14920, 13661, 15455, 14439, 15857, 15478, 16360]
        };

        let currentData = {
            sr: {
                stores: {
                    'æ¸…æ°´åº—': [416, 397, 421, 502, 471, 544, 567, 476, 355, 408, 299, 346],
                    'é™å²¡åº—': [369, 386, 600, 535, 285, 437, 351, 270, 369, 391, 256, 242],
                    'æ›å·åº—': [284, 375, 508, 278, 394, 394, 377, 309, 248, 469, 448, 535],
                    'å¸‚é‡åº—': [328, 547, 723, 520, 528, 607, 574, 318, 714, 657, 700, 600],
                    'ä½é³´å°åº—': [349, 719, 247, 433, 308, 265, 516, 311, 222, 293, 272, 379],
                    'åºƒå³¶åº—': [490, 493, 427, 542, 558, 416, 622, 641, 496, 385, 253, 620]
                },
                variables: {
                    commission: 100,
                    bonus6: 100,
                    bonus12: 0,
                    advertising: 30
                }
            },
            w: {
                sales: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
                variables: {
                    advertising: 30
                }
            },
            rc: {
                baseSales: 1550,
                variations: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                targetRate: 0,
                variables: {
                    advertising: 40,
                    decemberBooth: 90,
                    mayBooth: 90
                }
            },
            rcd: {
                purchases: [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
                fees: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
            }
        };

        let charts = {};

        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        // ===== Phase 3ä¿®æ­£ç‰ˆ: Promise/async-awaitå¯¾å¿œã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡é–¢æ•°ç¾¤ =====
        
        // SRäº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼ˆPromiseå¯¾å¿œç‰ˆï¼‰
        function sendSRDataToPLSystemAsync(silent = false) {
            return new Promise((resolve, reject) => {
                try {
                    const monthlySales = months.map((_, i) => {
                        return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
                    });

                    // ä¿®æ­£ç‰ˆ: çµ±ä¸€æ§‹é€ ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                    const srUnifiedData = {
                        metadata: {
                            department: 'SR',
                            lastUpdate: new Date().toISOString(),
                            version: '3.0',
                            unifiedStructure: true
                        },
                        
                        // å£²ä¸Šãƒ»åŸä¾¡ãƒ‡ãƒ¼ã‚¿
                        sales: monthlySales,
                        cogs: monthlySales.map(sales => Math.round(sales * 0.272)), // ä»•å…¥åŸä¾¡ç‡27.2%
                        
                        // 19é …ç›®è²©ç®¡è²»ãƒ‡ãƒ¼ã‚¿ï¼ˆç°¡ç•¥ç‰ˆï¼‰
                        expenses: {
                            1: monthlySales.map(sales => Math.round(sales * 0.12)), // äººä»¶è²»çµ±åˆï¼ˆ12%ï¼‰
                            2: monthlySales.map(sales => Math.round(sales * 0.05)), // æ³•å®šç¦åˆ©è²»ï¼ˆ5%ï¼‰
                            3: new Array(12).fill(Math.round(166/12)), // è¡›ç”Ÿè²»ï¼ˆå¹´166ä¸‡å††Ã·12ï¼‰
                            4: new Array(12).fill(Math.round(2500/12)), // ç‰©æµç®¡ç†è²»
                            5: new Array(12).fill(Math.round(2574/12)), // åœ°ä»£å®¶è³ƒ
                            6: new Array(12).fill(Math.round(1470/12)), // å¤–æ³¨è²»
                            7: new Array(12).fill(Math.round(851/12)), // è²¨ç‰©é‹è³ƒ
                            8: new Array(12).fill(currentData.sr.variables.advertising), // åºƒå‘Šå®£ä¼è²»
                            9: new Array(12).fill(Math.round(374/12)), // æ—…è²»äº¤é€šè²»
                            10: new Array(12).fill(Math.round(227/12)), // é€šä¿¡è²»
                            11: new Array(12).fill(Math.round(468/12)), // è²©å£²ä¿ƒé€²è²»
                            12: new Array(12).fill(Math.round(43/12)), // æ¶ˆè€—å“è²»
                            13: new Array(12).fill(Math.round(127/12)), // äº‹å‹™ç”¨å“è²»
                            14: new Array(12).fill(Math.round(579/12)), // æ°´é“å…‰ç†±è²»
                            15: monthlySales.map(sales => Math.round(sales * 0.04)), // æ”¯æ‰•æ‰‹æ•°æ–™ï¼ˆ4%ï¼‰
                            16: new Array(12).fill(Math.round(14/12)), // ãƒªãƒ¼ã‚¹æ–™
                            17: new Array(12).fill(Math.round(67/12)), // ä¿é™ºæ–™
                            18: new Array(12).fill(Math.round(408/12)), // æ”¯æ‰•å ±é…¬æ–™
                            19: new Array(12).fill(Math.round(230/12))  // æ¸›ä¾¡å„Ÿå´è²»
                        }
                    };

                    // çµ±ä¸€ã‚­ãƒ¼ã§ä¿å­˜
                    localStorage.setItem(LOCAL_STORAGE_KEYS.sr_data, JSON.stringify(srUnifiedData));
                    console.log('SRçµ±ä¸€æ§‹é€ ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†:', srUnifiedData);

                    if (!silent) {
                        const annual = monthlySales.reduce((sum, val) => sum + val, 0);
                        alert('SRãƒ‡ãƒ¼ã‚¿ã‚’PLã‚·ã‚¹ãƒ†ãƒ ã«é€ä¿¡ã—ã¾ã—ãŸï¼\n\n' +
                              'å¹´é–“åˆè¨ˆ: ' + formatNumber(annual) + 'ä¸‡å††\n' +
                              'é€ä¿¡æ™‚åˆ»: ' + new Date().toLocaleTimeString());
                    }

                    const totalRevenue = monthlySales.reduce((sum, val) => sum + val, 0);
                    resolve(totalRevenue);

                } catch (error) {
                    if (!silent) {
                        alert('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                    console.error('SRé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                    reject(error);
                }
            });
        }

        function sendWDataToPLSystemAsync(silent = false) {
            return new Promise((resolve, reject) => {
                try {
                    const wSalesData = {
                        monthlySales: currentData.w.sales,
                        timestamp: new Date().toISOString()
                    };

                    const wSettings = {
                        advertising: currentData.w.variables.advertising
                    };

                    localStorage.setItem(LOCAL_STORAGE_KEYS.w_data, JSON.stringify(wSalesData));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.w_settings, JSON.stringify(wSettings));

                    if (!silent) {
                        const annual = currentData.w.sales.reduce((sum, val) => sum + val, 0);
                        alert('Wãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\n' +
                              'å¹´é–“åˆè¨ˆ: ' + formatNumber(annual) + 'ä¸‡å††');
                    }

                    const totalRevenue = currentData.w.sales.reduce((sum, val) => sum + val, 0);
                    resolve(totalRevenue);

                } catch (error) {
                    if (!silent) {
                        alert('Wãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                    reject(error);
                }
            });
        }

        function sendRCDataToPLSystemAsync(silent = false) {
            return new Promise((resolve, reject) => {
                try {
                    const rcSalesData = {
                        baseSales: currentData.rc.baseSales,
                        variations: currentData.rc.variations,
                        timestamp: new Date().toISOString()
                    };

                    const rcSettings = {
                        advertising: currentData.rc.variables.advertising,
                        decemberBooth: currentData.rc.variables.decemberBooth,
                        mayBooth: currentData.rc.variables.mayBooth
                    };

                    localStorage.setItem(LOCAL_STORAGE_KEYS.rc_data, JSON.stringify(rcSalesData));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.rc_settings, JSON.stringify(rcSettings));

                    if (!silent) {
                        const monthlySales = currentData.rc.variations.map(variation => currentData.rc.baseSales + variation);
                        const annual = monthlySales.reduce((sum, val) => sum + val, 0);
                        alert('RCãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\n' +
                              'å¹´é–“åˆè¨ˆ: ' + formatNumber(annual) + 'ä¸‡å††');
                    }

                    const monthlySales = currentData.rc.variations.map(variation => currentData.rc.baseSales + variation);
                    const totalRevenue = monthlySales.reduce((sum, val) => sum + val, 0);
                    resolve(totalRevenue);

                } catch (error) {
                    if (!silent) {
                        alert('RCãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                    reject(error);
                }
            });
        }

        function sendRCDDataToPLSystemAsync(silent = false) {
            return new Promise((resolve, reject) => {
                try {
                    const rcdSalesData = {
                        purchases: currentData.rcd.purchases,
                        timestamp: new Date().toISOString()
                    };

                    const rcdSettings = {
                        feeOccurrences: currentData.rcd.fees
                    };

                    localStorage.setItem(LOCAL_STORAGE_KEYS.rcd_data, JSON.stringify(rcdSalesData));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.rcd_settings, JSON.stringify(rcdSettings));

                    if (!silent) {
                        const monthlySales = currentData.rcd.purchases.map(purchase => Math.round(purchase * 2000 * 1.03));
                        const annual = monthlySales.reduce((sum, val) => sum + val, 0);
                        alert('RCDãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\n' +
                              'å¹´é–“åˆè¨ˆ: ' + formatNumber(annual) + 'ä¸‡å††');
                    }

                    const monthlySales = currentData.rcd.purchases.map(purchase => Math.round(purchase * 2000 * 1.03));
                    const totalRevenue = monthlySales.reduce((sum, val) => sum + val, 0);
                    resolve(totalRevenue);

                } catch (error) {
                    if (!silent) {
                        alert('RCDãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                    reject(error);
                }
            });
        }

        // ===== Phase 3æ ¹æœ¬ä¿®æ­£ç‰ˆ: ä¸€æ‹¬é€ä¿¡æ©Ÿèƒ½ï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰ =====
        async function sendAllDataAndNavigateToPL() {
            const batchStatus = document.getElementById('batch-status');
            
            try {
                console.log('Phase 3ä¸€æ‹¬é€ä¿¡é–‹å§‹');
                
                // Phase 3: çŠ¶æ…‹è¡¨ç¤ºé–‹å§‹
                batchStatus.className = 'batch-send-status active';
                batchStatus.textContent = 'ğŸš€ ä¸€æ‹¬é€ä¿¡é–‹å§‹ - SRäº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­...';
                
                // Phase 3: Promise/async-awaitã«ã‚ˆã‚‹ç¢ºå®Ÿãªé †æ¬¡å‡¦ç†
                
                // 1. SRäº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼ˆçµ±ä¸€æ§‹é€ ï¼‰
                batchStatus.textContent = 'ğŸš€ SRäº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­...';
                const srTotal = await sendSRDataToPLSystemAsync(true);
                console.log('SRé€ä¿¡å®Œäº†:', srTotal);
                await delay(500);
                
                // 2. Wäº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡
                batchStatus.textContent = 'ğŸš€ Wäº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­...';
                const wTotal = await sendWDataToPLSystemAsync(true);
                console.log('Wé€ä¿¡å®Œäº†:', wTotal);
                await delay(500);
                
                // 3. RCå¸ãƒ‡ãƒ¼ã‚¿é€ä¿¡
                batchStatus.textContent = 'ğŸš€ RCå¸äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­...';
                const rcTotal = await sendRCDataToPLSystemAsync(true);
                console.log('RCé€ä¿¡å®Œäº†:', rcTotal);
                await delay(500);
                
                // 4. RCDç¤¾ãƒ‡ãƒ¼ã‚¿é€ä¿¡
                batchStatus.textContent = 'ğŸš€ RCDç¤¾ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­...';
                const rcdTotal = await sendRCDDataToPLSystemAsync(true);
                console.log('RCDé€ä¿¡å®Œäº†:', rcdTotal);
                await delay(500);
                
                const grandTotal = srTotal + wTotal + rcTotal + rcdTotal;
                
                // Phase 3: LocalStorageæ›¸ãè¾¼ã¿å®Œäº†ç¢ºèª
                batchStatus.textContent = 'ğŸš€ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç¢ºèªä¸­...';
                await verifyAllDataSaved();
                console.log('å…¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç¢ºèªå®Œäº†');
                
                // Phase 3: çµ±åˆå®Œäº†ãƒ•ãƒ©ã‚°è¨­å®šï¼ˆä¿®æ­£ç‰ˆï¼‰
                const completionFlag = {
                    timestamp: new Date().toISOString(),
                    status: 'completed',
                    version: 'phase3',
                    totals: { 
                        sr: srTotal, 
                        w: wTotal, 
                        rc: rcTotal, 
                        rcd: rcdTotal,
                        grand: grandTotal
                    }
                };
                localStorage.setItem('all_data_sync_flag', JSON.stringify(completionFlag));
                console.log('ä¸€æ‹¬é€ä¿¡å®Œäº†ãƒ•ãƒ©ã‚°è¨­å®š:', completionFlag);
                
                // Phase 3: çµ±åˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                batchStatus.textContent = 'âœ… å…¨äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†ï¼çµ±åˆPLãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...';
                
                alert(`ã€Phase 3ä¸€æ‹¬é€ä¿¡æˆåŠŸã€‘\n\n` +
                      `å…¨äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬é€ä¿¡ã—ã¾ã—ãŸï¼\n\n` +
                      `ã€å„äº‹æ¥­éƒ¨å£²ä¸Šåˆè¨ˆã€‘\n` +
                      `SRäº‹æ¥­éƒ¨: ${formatNumber(srTotal)}ä¸‡å††\n` +
                      `Wäº‹æ¥­éƒ¨: ${formatNumber(wTotal)}ä¸‡å††\n` +
                      `RCå¸åº—: ${formatNumber(rcTotal)}ä¸‡å††\n` +
                      `RCDç¤¾: ${formatNumber(rcdTotal)}ä¸‡å††\n` +
                      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                      `ğŸ”¥ çµ±åˆå£²ä¸Šåˆè¨ˆ: ${formatNumber(grandTotal)}ä¸‡å††\n\n` +
                      `ğŸš€ 3ç§’å¾Œã«çµ±åˆPLãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚\n` +
                      `â€»ãƒ‡ãƒ¼ã‚¿ã¯ç¢ºå®Ÿã«ä¿å­˜ãƒ»é€£æºæ¸ˆã¿ã§ã™`);
                
                // Phase 3: ç”»é¢é·ç§»ï¼ˆå¾…æ©Ÿæ™‚é–“å»¶é•·ï¼‰
                setTimeout(() => {
                    batchStatus.className = 'batch-send-status';
                    window.location.href = 'combined-dashboard/index.html';
                }, 3000); // 3ç§’å¾…æ©Ÿ
                
            } catch (error) {
                batchStatus.className = 'batch-send-status';
                batchStatus.textContent = 'âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                
                alert('ã€Phase 3ä¸€æ‹¬é€ä¿¡ã‚¨ãƒ©ãƒ¼ã€‘\n\n' + 
                      'ä¸€æ‹¬é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '\n\n' +
                      'å€‹åˆ¥é€ä¿¡ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
                console.error('Phase 3ä¸€æ‹¬é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // Phase 3è¿½åŠ : é…å»¶é–¢æ•°
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Phase 3è¿½åŠ : LocalStorageæ›¸ãè¾¼ã¿å®Œäº†ç¢ºèª
        async function verifyAllDataSaved() {
            const keys = [
                LOCAL_STORAGE_KEYS.sr_data, 
                LOCAL_STORAGE_KEYS.w_data, 
                LOCAL_STORAGE_KEYS.rc_data, 
                LOCAL_STORAGE_KEYS.rcd_data
            ];
            
            for (let key of keys) {
                let retries = 0;
                while (retries < 10) { // æœ€å¤§1ç§’å¾…æ©Ÿ
                    const data = localStorage.getItem(key);
                    if (data && data.length > 100) break; // ãƒ‡ãƒ¼ã‚¿ãŒååˆ†ãªé•·ã•ã‹ãƒã‚§ãƒƒã‚¯
                    
                    await delay(100);
                    retries++;
                }
                
                if (retries >= 10) {
                    throw new Error(`${key} ã®ä¿å­˜ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ`);
                }
            }
            console.log('å…¨LocalStorageã‚­ãƒ¼ä¿å­˜ç¢ºèªå®Œäº†');
        }

        // ===== å€‹åˆ¥é€ä¿¡æ©Ÿèƒ½ï¼ˆPhase 2äº’æ›æ€§ç¶­æŒï¼‰ =====
        function sendSRDataToPLSystem(silent = false) {
            sendSRDataToPLSystemAsync(silent);
        }

        function sendWDataToPLSystem(silent = false) {
            sendWDataToPLSystemAsync(silent);
        }

        function sendRCDataToPLSystem(silent = false) {
            sendRCDataToPLSystemAsync(silent);
        }

        function sendRCDDataToPLSystem(silent = false) {
            sendRCDDataToPLSystemAsync(silent);
        }

        // ===== ä»¥ä¸‹ã€Phase 2ã®æ©Ÿèƒ½ï¼ˆå¤‰æ›´ãªã—ï¼‰ =====
        
        // å…¥åŠ›å€¤ã®è‡ªå‹•ä¿å­˜ãƒ»å¾©å…ƒ
        function saveInputValues() {
            try {
                const inputValues = {
                    timestamp: new Date().toISOString(),
                    currentData: JSON.parse(JSON.stringify(currentData))
                };
                localStorage.setItem(LOCAL_STORAGE_KEYS.input_values, JSON.stringify(inputValues));
            } catch (error) {
                console.error('Error saving input values:', error);
            }
        }

        function loadInputValues() {
            try {
                const saved = localStorage.getItem(LOCAL_STORAGE_KEYS.input_values);
                if (saved) {
                    const inputValues = JSON.parse(saved);
                    if (inputValues.currentData) {
                        currentData = inputValues.currentData;
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error loading input values:', error);
                return false;
            }
        }

        function restoreFromLocalStorage() {
            const restored = loadInputValues();
            if (restored) {
                updateAllUIElements();
                generateAllTables();
                calculateAllDepartments();
                updateAllCharts();
                alert('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼\nå¾©å…ƒæ™‚åˆ»: ' + new Date().toLocaleTimeString());
            } else {
                alert('å¾©å…ƒå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
        }

        function updateAllUIElements() {
            const elements = {
                'sr-commission': currentData.sr.variables.commission,
                'sr-bonus6': currentData.sr.variables.bonus6,
                'sr-bonus12': currentData.sr.variables.bonus12,
                'sr-advertising': currentData.sr.variables.advertising,
                'w-advertising': currentData.w.variables.advertising,
                'rc-advertising': currentData.rc.variables.advertising,
                'rc-december-booth': currentData.rc.variables.decemberBooth,
                'rc-may-booth': currentData.rc.variables.mayBooth,
                'rc-target-rate': currentData.rc.targetRate
            };

            Object.entries(elements).forEach(([id, value]) => {
                const elem = document.getElementById(id);
                if (elem) elem.value = value;
            });

            const rcCurrentRateElem = document.getElementById('rc-current-rate');
            if (rcCurrentRateElem) rcCurrentRateElem.textContent = currentData.rc.targetRate;
        }

        function generateAllTables() {
            generateSRTable();
            generateWTable();
            generateRCTable();
            generateRCDTable();
        }

        function calculateAllDepartments() {
            calculateSR();
            calculateW();
            calculateRC();
            calculateRCD();
        }

        function updateAllCharts() {
            setTimeout(() => {
                updateSRChart();
                updateWChart();
                updateRCChart();
                updateRCDChart();
            }, 100);
        }

        // è¨­å®šå€¤æ›´æ–°é–¢æ•°ç¾¤
        function updateSRSettings() {
            currentData.sr.variables.commission = parseInt(document.getElementById('sr-commission').value) || 0;
            currentData.sr.variables.bonus6 = parseInt(document.getElementById('sr-bonus6').value) || 0;
            currentData.sr.variables.bonus12 = parseInt(document.getElementById('sr-bonus12').value) || 0;
            currentData.sr.variables.advertising = parseInt(document.getElementById('sr-advertising').value) || 0;
            saveInputValues();
        }

        function updateWSettings() {
            currentData.w.variables.advertising = parseInt(document.getElementById('w-advertising').value) || 0;
            saveInputValues();
        }

        function updateRCSettings() {
            currentData.rc.variables.advertising = parseInt(document.getElementById('rc-advertising').value) || 0;
            currentData.rc.variables.decemberBooth = parseInt(document.getElementById('rc-december-booth').value) || 0;
            currentData.rc.variables.mayBooth = parseInt(document.getElementById('rc-may-booth').value) || 0;
            saveInputValues();
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆé–¢æ•°
        function generateSRTable() {
            try {
                const tableBody = document.getElementById('sr-table-body');
                if (!tableBody) return;

                let html = '';
                
                const totals = months.map((_, i) => {
                    return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
                });

                html += `
                    <tr style="background: #ebf8ff; font-weight: 600;">
                        <td rowspan="3" style="background: #3182ce; color: white;">åˆè¨ˆ</td>
                        <td style="color: #1e40af;">å£²ä¸Š</td>
                        ${totals.map(total => `<td style="color: #1e40af;"><strong>${formatNumber(total)}</strong></td>`).join('')}
                    </tr>
                    <tr style="background: #ebf8ff;">
                        <td style="color: #059669;">å¢—æ¸›</td>
                        ${totals.map((total, i) => {
                            const diff = total - referenceData.SR[i];
                            const color = diff >= 0 ? '#059669' : '#dc2626';
                            return `
