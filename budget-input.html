<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4事業部統合PLシミュレーター - 予算入力システム Phase 3修正版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        
        /* ヘッダー部 - 超コンパクト版 */
        .header-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 8px 15px;
        }
        
        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .main-title {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 4px;
            margin: 0;
        }
        
        .subtitle {
            color: #4a5568;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* 共通ナビゲーション追加 */
        .nav-section {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            margin: -8px -15px 10px -15px;
            padding: 10px 15px;
            border-radius: 0 0 6px 6px;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .btn-nav {
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-nav:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .btn-nav.active {
            background: #3498db;
            border-color: #3498db;
        }
        
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .kpi-card {
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 0.7rem;
        }
        
        .kpi-card:nth-child(1) { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .kpi-card:nth-child(2) { background: linear-gradient(135deg, #374151, #1f2937); }
        .kpi-card:nth-child(3) { background: linear-gradient(135deg, #dc2626, #991b1b); }
        .kpi-card:nth-child(4) { background: linear-gradient(135deg, #7c3aed, #5b21b6); }
        
        .kpi-label {
            font-size: 0.6rem;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .kpi-value {
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .action-buttons {
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
        }
        
        .restore-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* Phase 3追加: 一括送信状態表示 */
        .batch-send-status {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .batch-send-status.active {
            display: block;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* 事業部セクション - 超コンパクト版 */
        .department-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 3px solid var(--dept-color);
        }
        
        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .department-title {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .department-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--dept-color);
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .annual-summary {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--dept-color);
        }
        
        /* チャート部分 - 超コンパクト版 */
        .chart-container {
            height: 80px;
            margin-bottom: 8px;
            background: white;
            border-radius: 4px;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .chart-legend {
            position: absolute;
            top: 2px;
            right: 6px;
            display: flex;
            gap: 6px;
            font-size: 0.6rem;
            z-index: 10;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .legend-color {
            width: 6px;
            height: 6px;
            border-radius: 1px;
        }
        
        .legend-blue { background: rgba(59, 130, 246, 0.7); }
        .legend-green { background: rgba(34, 197, 94, 0.7); }
        
        /* ボタン統合行 - 超コンパクト版 */
        .action-buttons-row {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .preset-buttons {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            flex: 1;
        }
        
        .preset-btn {
            padding: 3px 6px;
            border: none;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preset-btn.green { background: #48bb78; color: white; }
        .preset-btn.orange { background: #ed8936; color: white; }
        .preset-btn.red { background: #e53e3e; color: white; }
        .preset-btn.blue { background: #4299e1; color: white; }
        .preset-btn.purple { background: #805ad5; color: white; }
        
        .preset-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .send-buttons {
            display: flex;
            gap: 3px;
        }
        
        .send-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        
        .send-btn.sr-send { background: linear-gradient(135deg, #e53e3e, #c53030); }
        .send-btn.w-send { background: linear-gradient(135deg, #3182ce, #2c5aa0); }
        .send-btn.rc-send { background: linear-gradient(135deg, #38a169, #2f855a); }
        .send-btn.rcd-send { background: linear-gradient(135deg, #805ad5, #6b46c1); }
        
        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* データテーブル - 超コンパクト版 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 8px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #e2e8f0;
            padding: 3px 4px;
            text-align: center;
            line-height: 1.1;
        }
        
        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.6rem;
        }
        
        .data-table input {
            width: 100%;
            padding: 1px 3px;
            border: 1px solid #ddd;
            background: rgba(66, 153, 225, 0.1);
            border-radius: 2px;
            text-align: center;
            font-size: 0.6rem;
            height: 18px;
        }
        
        .data-table input:focus {
            background: rgba(66, 153, 225, 0.2);
            outline: 1px solid #4299e1;
        }
        
        /* 設定統合エリア - 超コンパクト版 */
        .settings-consolidated {
            background: linear-gradient(135deg, #fffcf0, #fff8e1);
            border: 1px solid #f6e05e;
            border-radius: 4px;
            padding: 6px;
            margin-top: 6px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 4px;
        }
        
        .setting-item {
            background: white;
            padding: 3px;
            border-radius: 2px;
            border: 1px solid #e2e8f0;
        }
        
        .setting-item label {
            display: block;
            font-size: 0.6rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1px;
        }
        
        .setting-item input,
        .setting-item select {
            width: 100%;
            padding: 1px 3px;
            border: 1px solid #d2d6dc;
            border-radius: 2px;
            font-size: 0.6rem;
            height: 18px;
        }
        
        /* 情報表示エリア - 超コンパクト版 */
        .info-panel {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 4px;
            padding: 4px;
            margin-top: 6px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 3px;
        }
        
        .info-item {
            font-size: 0.6rem;
        }
        
        .info-item strong {
            color: #1e40af;
        }
        
        /* RC用の特別設定 - 超コンパクト版 */
        .rc-target-setting {
            background: #ebf8ff;
            padding: 6px;
            border-radius: 4px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .rc-target-input {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .rc-target-input input {
            width: 50px;
            padding: 2px;
            text-align: center;
            border: 1px solid #cbd5e0;
            border-radius: 2px;
            font-size: 0.6rem;
            height: 18px;
        }
        
        .rc-current-display {
            font-weight: 600;
            color: #3182ce;
            font-size: 0.6rem;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .kpi-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .preset-buttons,
            .send-buttons {
                justify-content: center;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .nav-buttons {
                gap: 4px;
            }

            .btn-nav {
                padding: 6px 8px;
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー部 -->
        <div class="header-section">
            <div class="title-row">
                <div class="main-title">4事業部統合PLシミュレーター - 予算入力システム Phase 3修正版</div>
                <div class="subtitle">一括送信システム根本修正完了版</div>
            </div>

            <!-- 共通ナビゲーション追加 -->
            <div class="nav-section">
                <div class="nav-buttons">
                    <a href="index.html" class="btn-nav">メインダッシュボード</a>
                    <a href="budget-input.html" class="btn-nav active">予算入力</a>
                    <a href="department-pl/sr-pl.html" class="btn-nav">SR事業部PL</a>
                    <a href="department-pl/w-pl.html" class="btn-nav">W事業部PL</a>
                    <a href="department-pl/rc-pl.html" class="btn-nav">RC卸事業部PL</a>
                    <a href="department-pl/rcd-pl.html" class="btn-nav">RCD社事業部PL</a>
                    <a href="combined-dashboard/index.html" class="btn-nav">全体PLanalysis</a>
                </div>
            </div>
            
            <!-- Phase 3追加: 一括送信状態表示 -->
            <div class="batch-send-status" id="batch-status">
                🚀 一括送信処理中... SR事業部 → W事業部 → RC卸 → RCD社 → 統合PL遷移
            </div>
            
            <div class="kpi-cards">
                <div class="kpi-card">
                    <div class="kpi-label">統合年間売上</div>
                    <div class="kpi-value" id="total-revenue">0万円</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">前年比増減</div>
                    <div class="kpi-value" id="revenue-diff">+0万円</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">送信状況</div>
                    <div class="kpi-value" id="sync-status">準備中</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">完成進度</div>
                    <div class="kpi-value">100%</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn btn-secondary" onclick="location.href='index.html'">
                    メインダッシュボード
                </button>
                <button class="action-btn btn-primary" onclick="sendAllDataAndNavigateToPL()">
                    一括送信・事業部合計PL確認
                </button>
                <button class="action-btn btn-secondary" onclick="exportToJSON()">
                    データエクスポート
                </button>
                <button class="action-btn restore-btn" onclick="restoreFromLocalStorage()">
                    保存データ復元
                </button>
            </div>
        </div>
        
        <!-- SR事業部 -->
        <div class="department-section" style="--dept-color: #e53e3e;">
            <div class="department-header">
                <div class="department-title">SR事業部</div>
                <div class="annual-summary" id="sr-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="sr-chart"></canvas>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applySRPreset('actual')">実績値</button>
                    <button class="preset-btn orange" onclick="applySRPreset('50p')">店舗50万増</button>
                    <button class="preset-btn orange" onclick="applySRPreset('100p')">店舗100万増</button>
                    <button class="preset-btn red" onclick="applySRPreset('150p')">店舗150万増</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn sr-send" onclick="sendSRDataToPLSystem()">PL送信</button>
                    <button class="send-btn sr-send" onclick="navigateToSRPL()">SR詳細</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="sr-table">
                    <thead>
                        <tr>
                            <th>店舗</th>
                            <th>項目</th>
                            <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                            <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        </tr>
                    </thead>
                    <tbody id="sr-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>店舗数:</strong> 6店舗</div>
                    <div class="info-item"><strong>仕入原価率:</strong> 27.2%</div>
                    <div class="info-item"><strong>人件費:</strong> 売上レンジ別係数</div>
                    <div class="info-item"><strong>特殊手当:</strong> 営業コミッション・賞与</div>
                </div>
            </div>
            
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>営業手当</label>
                        <input type="number" id="sr-commission" value="100" onchange="updateSRSettings(); calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>6月賞与</label>
                        <input type="number" id="sr-bonus6" value="100" onchange="updateSRSettings(); calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>12月賞与</label>
                        <input type="number" id="sr-bonus12" value="0" onchange="updateSRSettings(); calculateSR()">
                    </div>
                    <div class="setting-item">
                        <label>広告宣伝費</label>
                        <input type="number" id="sr-advertising" value="30" onchange="updateSRSettings(); calculateSR()">
                    </div>
                </div>
            </div>
        </div>

        <!-- W事業部 -->
        <div class="department-section" style="--dept-color: #3182ce;">
            <div class="department-header">
                <div class="department-title">W事業部</div>
                <div class="annual-summary" id="w-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="w-chart"></canvas>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyWPreset('actual')">実績値</button>
                    <button class="preset-btn blue" onclick="applyWPreset('200')">毎月200万増</button>
                    <button class="preset-btn purple" onclick="applyWPreset('400')">毎月400万増</button>
                    <button class="preset-btn red" onclick="applyWPreset('600')">毎月600万増</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn w-send" onclick="sendWDataToPLSystem()">PL送信</button>
                    <button class="send-btn w-send" onclick="navigateToWPL()">W詳細</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="w-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                            <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        </tr>
                    </thead>
                    <tbody id="w-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>入力方式:</strong> 統合月別売上</div>
                    <div class="info-item"><strong>仕入原価率:</strong> 29.96%</div>
                    <div class="info-item"><strong>人件費:</strong> 売上レンジ別固定金額</div>
                    <div class="info-item"><strong>支払手数料:</strong> 売上連動(6%/8%)</div>
                </div>
            </div>
            
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>広告宣伝費</label>
                        <input type="number" id="w-advertising" value="30" onchange="updateWSettings(); calculateW()">
                    </div>
                </div>
            </div>
        </div>

        <!-- RC卸店事業部 -->
        <div class="department-section" style="--dept-color: #38a169;">
            <div class="department-header">
                <div class="department-title">RC卸店</div>
                <div class="annual-summary" id="rc-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="rc-chart"></canvas>
            </div>
            
            <div class="rc-target-setting">
                <span style="font-size: 0.6rem; font-weight: 600;">目標売上設定(%):</span>
                <div class="rc-target-input">
                    <input type="number" id="rc-target-rate" value="0" step="0.1" min="0" max="50" onchange="applyRCTargetRate()">
                    <span style="font-size: 0.6rem;">%</span>
                </div>
                <div class="rc-current-display">
                    現在の設定: カスタム設定 <span id="rc-current-rate">0</span>%
                </div>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyRCPreset('actual')">実績パターン</button>
                    <button class="preset-btn blue" onclick="applyRCPreset('standard')">標準設定</button>
                    <button class="preset-btn green" onclick="applyRCPreset('growth')">成長モデル(4%)</button>
                    <button class="preset-btn purple" onclick="applyRCPreset('improvement')">大幅改善(7%)</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn rc-send" onclick="sendRCDataToPLSystem()">PL送信</button>
                    <button class="send-btn rc-send" onclick="navigateToRCPL()">RC詳細</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="rc-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                            <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        </tr>
                    </thead>
                    <tbody id="rc-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>基準売上:</strong> 1550万円/月</div>
                    <div class="info-item"><strong>仕入原価率:</strong> 35.2%</div>
                    <div class="info-item"><strong>人件費:</strong> 固定50万円/月</div>
                    <div class="info-item"><strong>計算方式:</strong> 基準+増減額</div>
                </div>
            </div>
            
            <div class="settings-consolidated">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>広告宣伝費（営業ソーシング想定費）</label>
                        <input type="number" id="rc-advertising" value="40" onchange="updateRCSettings(); calculateRC()">
                    </div>
                    <div class="setting-item">
                        <label>BWJ東京・12月ブース費支払</label>
                        <input type="number" id="rc-december-booth" value="90" onchange="updateRCSettings(); calculateRC()">
                    </div>
                    <div class="setting-item">
                        <label>5月BWJ施工費支払</label>
                        <input type="number" id="rc-may-booth" value="90" onchange="updateRCSettings(); calculateRC()">
                    </div>
                </div>
            </div>
        </div>

        <!-- RCD社事業部 -->
        <div class="department-section" style="--dept-color: #805ad5;">
            <div class="department-header">
                <div class="department-title">RCD社</div>
                <div class="annual-summary" id="rcd-annual">
                    年間合計: 0万円　前年増減: +0万円
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="rcd-chart"></canvas>
            </div>
            
            <div class="action-buttons-row">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyRCDPreset('actual')">実績パターン</button>
                    <button class="preset-btn red" onclick="applyRCDPreset('zero')">0設定</button>
                    <button class="preset-btn blue" onclick="applyRCDPreset('standard')">標準設定(月8本)</button>
                    <button class="preset-btn orange" onclick="applyRCDPreset('seven')">月7本設定</button>
                    <button class="preset-btn purple" onclick="applyRCDPreset('six')">月6本設定</button>
                </div>
                <div class="send-buttons">
                    <button class="send-btn rcd-send" onclick="sendRCDDataToPLSystem()">PL送信</button>
                    <button class="send-btn rcd-send" onclick="navigateToRCDPL()">RCD詳細</button>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="rcd-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                            <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        </tr>
                    </thead>
                    <tbody id="rcd-table-body"></tbody>
                </table>
            </div>
            
            <div class="info-panel">
                <div class="info-grid">
                    <div class="info-item"><strong>仕入単価:</strong> 2,000万円/本</div>
                    <div class="info-item"><strong>利益率:</strong> 3%固定</div>
                    <div class="info-item"><strong>支払手数料:</strong> 1件90.6万円×回数</div>
                    <div class="info-item"><strong>外部委託:</strong> 人件費・経費0円</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== Phase 3修正版: localStorageルール（完全版） =====
        const LOCAL_STORAGE_KEYS = {
            sr_data: 'pl_system_sr_data',      // 統一キー（変更禁止）
            w_data: 'pl_system_w_data',
            rc_data: 'pl_system_rc_data',
            rcd_data: 'pl_system_rcd_data',
            sr_settings: 'pl_system_sr_settings',
            w_settings: 'pl_system_w_settings',
            rc_settings: 'pl_system_rc_settings',
            rcd_settings: 'pl_system_rcd_settings',
            input_values: 'pl_system_input_values',
            batch_status: 'pl_system_batch_status'  // Phase 3追加
        };

        // 基本データ
        const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
        
        const referenceData = {
            SR: [2236, 2916, 2927, 2810, 2544, 2663, 3008, 2324, 2403, 2602, 2228, 2721],
            W: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
            RC: [1947, 1645, 1530, 1730, 1165, 1846, 1475, 1585, 1241, 1173, 1602, 1420],
            RCD: [11037, 14297, 11504, 14664, 12507, 14920, 13661, 15455, 14439, 15857, 15478, 16360]
        };

        let currentData = {
            sr: {
                stores: {
                    '清水店': [416, 397, 421, 502, 471, 544, 567, 476, 355, 408, 299, 346],
                    '静岡店': [369, 386, 600, 535, 285, 437, 351, 270, 369, 391, 256, 242],
                    '掛川店': [284, 375, 508, 278, 394, 394, 377, 309, 248, 469, 448, 535],
                    '市野店': [328, 547, 723, 520, 528, 607, 574, 318, 714, 657, 700, 600],
                    '佐鳴台店': [349, 719, 247, 433, 308, 265, 516, 311, 222, 293, 272, 379],
                    '広島店': [490, 493, 427, 542, 558, 416, 622, 641, 496, 385, 253, 620]
                },
                variables: {
                    commission: 100,
                    bonus6: 100,
                    bonus12: 0,
                    advertising: 30
                }
            },
            w: {
                sales: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
                variables: {
                    advertising: 30
                }
            },
            rc: {
                baseSales: 1550,
                variations: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                targetRate: 0,
                variables: {
                    advertising: 40,
                    decemberBooth: 90,
                    mayBooth: 90
                }
            },
            rcd: {
                purchases: [8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8],
                fees: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
            }
        };

        let charts = {};

        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        // ===== Phase 3修正版: Promise/async-await対応のデータ送信関数群 =====
        
        // SR事業部データ送信（Promise対応版）
        function sendSRDataToPLSystemAsync(silent = false) {
            return new Promise((resolve, reject) => {
                try {
                    const monthlySales = months.map((_, i) => {
                        return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
                    });

                    // 修正版: 統一構造データ生成
                    const srUnifiedData = {
                        metadata: {
                            department: 'SR',
                            lastUpdate: new Date().toISOString(),
                            version: '3.0',
                            unifiedStructure: true
                        },
                        
                        // 売上・原価データ
                        sales: monthlySales,
                        cogs: monthlySales.map(sales => Math.round(sales * 0.272)), // 仕入原価率27.2%
                        
                        // 19項目販管費データ（簡略版）
                        expenses: {
                            1: monthlySales.map(sales => Math.round(sales * 0.12)), // 人件費統合（12%）
                            2: monthlySales.map(sales => Math.round(sales * 0.05)), // 法定福利費（5%）
                            3: new Array(12).fill(Math.round(166/12)), // 衛生費（年166万円÷12）
                            4: new Array(12).fill(Math.round(2500/12)), // 物流管理費
                            5: new Array(12).fill(Math.round(2574/12)), // 地代家賃
                            6: new Array(12).fill(Math.round(1470/12)), // 外注費
                            7: new Array(12).fill(Math.round(851/12)), // 貨物運賃
                            8: new Array(12).fill(currentData.sr.variables.advertising), // 広告宣伝費
                            9: new Array(12).fill(Math.round(374/12)), // 旅費交通費
                            10: new Array(12).fill(Math.round(227/12)), // 通信費
                            11: new Array(12).fill(Math.round(468/12)), // 販売促進費
                            12: new Array(12).fill(Math.round(43/12)), // 消耗品費
                            13: new Array(12).fill(Math.round(127/12)), // 事務用品費
                            14: new Array(12).fill(Math.round(579/12)), // 水道光熱費
                            15: monthlySales.map(sales => Math.round(sales * 0.04)), // 支払手数料（4%）
                            16: new Array(12).fill(Math.round(14/12)), // リース料
                            17: new Array(12).fill(Math.round(67/12)), // 保険料
                            18: new Array(12).fill(Math.round(408/12)), // 支払報酬料
                            19: new Array(12).fill(Math.round(230/12))  // 減価償却費
                        }
                    };

                    // 統一キーで保存
                    localStorage.setItem(LOCAL_STORAGE_KEYS.sr_data, JSON.stringify(srUnifiedData));
                    console.log('SR統一構造データ送信完了:', srUnifiedData);

                    if (!silent) {
                        const annual = monthlySales.reduce((sum, val) => sum + val, 0);
                        alert('SRデータをPLシステムに送信しました！\n\n' +
                              '年間合計: ' + formatNumber(annual) + '万円\n' +
                              '送信時刻: ' + new Date().toLocaleTimeString());
                    }

                    const totalRevenue = monthlySales.reduce((sum, val) => sum + val, 0);
                    resolve(totalRevenue);

                } catch (error) {
                    if (!silent) {
                        alert('データ送信に失敗しました: ' + error.message);
                    }
                    console.error('SR送信エラー:', error);
                    reject(error);
                }
            });
        }

        function sendWDataToPLSystemAsync(silent = false) {
            return new Promise((resolve, reject) => {
                try {
                    const wSalesData = {
                        monthlySales: currentData.w.sales,
                        timestamp: new Date().toISOString()
                    };

                    const wSettings = {
                        advertising: currentData.w.variables.advertising
                    };

                    localStorage.setItem(LOCAL_STORAGE_KEYS.w_data, JSON.stringify(wSalesData));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.w_settings, JSON.stringify(wSettings));

                    if (!silent) {
                        const annual = currentData.w.sales.reduce((sum, val) => sum + val, 0);
                        alert('Wデータを送信しました！\n' +
                              '年間合計: ' + formatNumber(annual) + '万円');
                    }

                    const totalRevenue = currentData.w.sales.reduce((sum, val) => sum + val, 0);
                    resolve(totalRevenue);

                } catch (error) {
                    if (!silent) {
                        alert('Wデータ送信に失敗しました: ' + error.message);
                    }
                    reject(error);
                }
            });
        }

        function sendRCDataToPLSystemAsync(silent = false) {
            return new Promise((resolve, reject) => {
                try {
                    const rcSalesData = {
                        baseSales: currentData.rc.baseSales,
                        variations: currentData.rc.variations,
                        timestamp: new Date().toISOString()
                    };

                    const rcSettings = {
                        advertising: currentData.rc.variables.advertising,
                        decemberBooth: currentData.rc.variables.decemberBooth,
                        mayBooth: currentData.rc.variables.mayBooth
                    };

                    localStorage.setItem(LOCAL_STORAGE_KEYS.rc_data, JSON.stringify(rcSalesData));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.rc_settings, JSON.stringify(rcSettings));

                    if (!silent) {
                        const monthlySales = currentData.rc.variations.map(variation => currentData.rc.baseSales + variation);
                        const annual = monthlySales.reduce((sum, val) => sum + val, 0);
                        alert('RCデータを送信しました！\n' +
                              '年間合計: ' + formatNumber(annual) + '万円');
                    }

                    const monthlySales = currentData.rc.variations.map(variation => currentData.rc.baseSales + variation);
                    const totalRevenue = monthlySales.reduce((sum, val) => sum + val, 0);
                    resolve(totalRevenue);

                } catch (error) {
                    if (!silent) {
                        alert('RCデータ送信に失敗しました: ' + error.message);
                    }
                    reject(error);
                }
            });
        }

        function sendRCDDataToPLSystemAsync(silent = false) {
            return new Promise((resolve, reject) => {
                try {
                    const rcdSalesData = {
                        purchases: currentData.rcd.purchases,
                        timestamp: new Date().toISOString()
                    };

                    const rcdSettings = {
                        feeOccurrences: currentData.rcd.fees
                    };

                    localStorage.setItem(LOCAL_STORAGE_KEYS.rcd_data, JSON.stringify(rcdSalesData));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.rcd_settings, JSON.stringify(rcdSettings));

                    if (!silent) {
                        const monthlySales = currentData.rcd.purchases.map(purchase => Math.round(purchase * 2000 * 1.03));
                        const annual = monthlySales.reduce((sum, val) => sum + val, 0);
                        alert('RCDデータを送信しました！\n' +
                              '年間合計: ' + formatNumber(annual) + '万円');
                    }

                    const monthlySales = currentData.rcd.purchases.map(purchase => Math.round(purchase * 2000 * 1.03));
                    const totalRevenue = monthlySales.reduce((sum, val) => sum + val, 0);
                    resolve(totalRevenue);

                } catch (error) {
                    if (!silent) {
                        alert('RCDデータ送信に失敗しました: ' + error.message);
                    }
                    reject(error);
                }
            });
        }

        // ===== Phase 3根本修正版: 一括送信機能（完全修正版） =====
        async function sendAllDataAndNavigateToPL() {
            const batchStatus = document.getElementById('batch-status');
            
            try {
                console.log('Phase 3一括送信開始');
                
                // Phase 3: 状態表示開始
                batchStatus.className = 'batch-send-status active';
                batchStatus.textContent = '🚀 一括送信開始 - SR事業部データ準備中...';
                
                // Phase 3: Promise/async-awaitによる確実な順次処理
                
                // 1. SR事業部データ送信（統一構造）
                batchStatus.textContent = '🚀 SR事業部データ送信中...';
                const srTotal = await sendSRDataToPLSystemAsync(true);
                console.log('SR送信完了:', srTotal);
                await delay(500);
                
                // 2. W事業部データ送信
                batchStatus.textContent = '🚀 W事業部データ送信中...';
                const wTotal = await sendWDataToPLSystemAsync(true);
                console.log('W送信完了:', wTotal);
                await delay(500);
                
                // 3. RC卸データ送信
                batchStatus.textContent = '🚀 RC卸事業部データ送信中...';
                const rcTotal = await sendRCDataToPLSystemAsync(true);
                console.log('RC送信完了:', rcTotal);
                await delay(500);
                
                // 4. RCD社データ送信
                batchStatus.textContent = '🚀 RCD社データ送信中...';
                const rcdTotal = await sendRCDDataToPLSystemAsync(true);
                console.log('RCD送信完了:', rcdTotal);
                await delay(500);
                
                const grandTotal = srTotal + wTotal + rcTotal + rcdTotal;
                
                // Phase 3: LocalStorage書き込み完了確認
                batchStatus.textContent = '🚀 データ保存確認中...';
                await verifyAllDataSaved();
                console.log('全データ保存確認完了');
                
                // Phase 3: 統合完了フラグ設定（修正版）
                const completionFlag = {
                    timestamp: new Date().toISOString(),
                    status: 'completed',
                    version: 'phase3',
                    totals: { 
                        sr: srTotal, 
                        w: wTotal, 
                        rc: rcTotal, 
                        rcd: rcdTotal,
                        grand: grandTotal
                    }
                };
                localStorage.setItem('all_data_sync_flag', JSON.stringify(completionFlag));
                console.log('一括送信完了フラグ設定:', completionFlag);
                
                // Phase 3: 統合メッセージ表示
                batchStatus.textContent = '✅ 全事業部データ送信完了！統合PLページに移動します...';
                
                alert(`【Phase 3一括送信成功】\n\n` +
                      `全事業部データを一括送信しました！\n\n` +
                      `【各事業部売上合計】\n` +
                      `SR事業部: ${formatNumber(srTotal)}万円\n` +
                      `W事業部: ${formatNumber(wTotal)}万円\n` +
                      `RC卸店: ${formatNumber(rcTotal)}万円\n` +
                      `RCD社: ${formatNumber(rcdTotal)}万円\n` +
                      `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n` +
                      `🔥 統合売上合計: ${formatNumber(grandTotal)}万円\n\n` +
                      `🚀 3秒後に統合PLページに移動します。\n` +
                      `※データは確実に保存・連携済みです`);
                
                // Phase 3: 画面遷移（待機時間延長）
                setTimeout(() => {
                    batchStatus.className = 'batch-send-status';
                    window.location.href = 'combined-dashboard/index.html';
                }, 3000); // 3秒待機
                
            } catch (error) {
                batchStatus.className = 'batch-send-status';
                batchStatus.textContent = '❌ 送信エラーが発生しました';
                
                alert('【Phase 3一括送信エラー】\n\n' + 
                      '一括送信に失敗しました: ' + error.message + '\n\n' +
                      '個別送信をお試しください。');
                console.error('Phase 3一括送信エラー:', error);
            }
        }

        // Phase 3追加: 遅延関数
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Phase 3追加: LocalStorage書き込み完了確認
        async function verifyAllDataSaved() {
            const keys = [
                LOCAL_STORAGE_KEYS.sr_data, 
                LOCAL_STORAGE_KEYS.w_data, 
                LOCAL_STORAGE_KEYS.rc_data, 
                LOCAL_STORAGE_KEYS.rcd_data
            ];
            
            for (let key of keys) {
                let retries = 0;
                while (retries < 10) { // 最大1秒待機
                    const data = localStorage.getItem(key);
                    if (data && data.length > 100) break; // データが十分な長さかチェック
                    
                    await delay(100);
                    retries++;
                }
                
                if (retries >= 10) {
                    throw new Error(`${key} の保存確認に失敗しました`);
                }
            }
            console.log('全LocalStorageキー保存確認完了');
        }

        // ===== 個別送信機能（Phase 2互換性維持） =====
        function sendSRDataToPLSystem(silent = false) {
            sendSRDataToPLSystemAsync(silent);
        }

        function sendWDataToPLSystem(silent = false) {
            sendWDataToPLSystemAsync(silent);
        }

        function sendRCDataToPLSystem(silent = false) {
            sendRCDataToPLSystemAsync(silent);
        }

        function sendRCDDataToPLSystem(silent = false) {
            sendRCDDataToPLSystemAsync(silent);
        }

        // ===== 以下、Phase 2の機能（変更なし） =====
        
        // 入力値の自動保存・復元
        function saveInputValues() {
            try {
                const inputValues = {
                    timestamp: new Date().toISOString(),
                    currentData: JSON.parse(JSON.stringify(currentData))
                };
                localStorage.setItem(LOCAL_STORAGE_KEYS.input_values, JSON.stringify(inputValues));
            } catch (error) {
                console.error('Error saving input values:', error);
            }
        }

        function loadInputValues() {
            try {
                const saved = localStorage.getItem(LOCAL_STORAGE_KEYS.input_values);
                if (saved) {
                    const inputValues = JSON.parse(saved);
                    if (inputValues.currentData) {
                        currentData = inputValues.currentData;
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error loading input values:', error);
                return false;
            }
        }

        function restoreFromLocalStorage() {
            const restored = loadInputValues();
            if (restored) {
                updateAllUIElements();
                generateAllTables();
                calculateAllDepartments();
                updateAllCharts();
                alert('保存されたデータを復元しました！\n復元時刻: ' + new Date().toLocaleTimeString());
            } else {
                alert('復元可能なデータが見つかりませんでした。');
            }
        }

        function updateAllUIElements() {
            const elements = {
                'sr-commission': currentData.sr.variables.commission,
                'sr-bonus6': currentData.sr.variables.bonus6,
                'sr-bonus12': currentData.sr.variables.bonus12,
                'sr-advertising': currentData.sr.variables.advertising,
                'w-advertising': currentData.w.variables.advertising,
                'rc-advertising': currentData.rc.variables.advertising,
                'rc-december-booth': currentData.rc.variables.decemberBooth,
                'rc-may-booth': currentData.rc.variables.mayBooth,
                'rc-target-rate': currentData.rc.targetRate
            };

            Object.entries(elements).forEach(([id, value]) => {
                const elem = document.getElementById(id);
                if (elem) elem.value = value;
            });

            const rcCurrentRateElem = document.getElementById('rc-current-rate');
            if (rcCurrentRateElem) rcCurrentRateElem.textContent = currentData.rc.targetRate;
        }

        function generateAllTables() {
            generateSRTable();
            generateWTable();
            generateRCTable();
            generateRCDTable();
        }

        function calculateAllDepartments() {
            calculateSR();
            calculateW();
            calculateRC();
            calculateRCD();
        }

        function updateAllCharts() {
            setTimeout(() => {
                updateSRChart();
                updateWChart();
                updateRCChart();
                updateRCDChart();
            }, 100);
        }

        // 設定値更新関数群
        function updateSRSettings() {
            currentData.sr.variables.commission = parseInt(document.getElementById('sr-commission').value) || 0;
            currentData.sr.variables.bonus6 = parseInt(document.getElementById('sr-bonus6').value) || 0;
            currentData.sr.variables.bonus12 = parseInt(document.getElementById('sr-bonus12').value) || 0;
            currentData.sr.variables.advertising = parseInt(document.getElementById('sr-advertising').value) || 0;
            saveInputValues();
        }

        function updateWSettings() {
            currentData.w.variables.advertising = parseInt(document.getElementById('w-advertising').value) || 0;
            saveInputValues();
        }

        function updateRCSettings() {
            currentData.rc.variables.advertising = parseInt(document.getElementById('rc-advertising').value) || 0;
            currentData.rc.variables.decemberBooth = parseInt(document.getElementById('rc-december-booth').value) || 0;
            currentData.rc.variables.mayBooth = parseInt(document.getElementById('rc-may-booth').value) || 0;
            saveInputValues();
        }

        // テーブル生成関数
        function generateSRTable() {
            try {
                const tableBody = document.getElementById('sr-table-body');
                if (!tableBody) return;

                let html = '';
                
                const totals = months.map((_, i) => {
                    return Object.values(currentData.sr.stores).reduce((sum, store) => sum + store[i], 0);
                });

                html += `
                    <tr style="background: #ebf8ff; font-weight: 600;">
                        <td rowspan="3" style="background: #3182ce; color: white;">合計</td>
                        <td style="color: #1e40af;">売上</td>
                        ${totals.map(total => `<td style="color: #1e40af;"><strong>${formatNumber(total)}</strong></td>`).join('')}
                    </tr>
                    <tr style="background: #ebf8ff;">
                        <td style="color: #059669;">増減</td>
                        ${totals.map((total, i) => {
                            const diff = total - referenceData.SR[i];
                            const color = diff >= 0 ? '#059669' : '#dc2626';
                            return `
