<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCå¸äº‹æ¥­éƒ¨ æç›Šè¨ˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* RCå¸äº‹æ¥­éƒ¨å°‚ç”¨ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒï¼ˆç·‘ç³»ï¼‰ */
        .rc-theme {
            --primary: #27ae60;
            --secondary: #2ecc71;
            --accent: #55efc4;
            --success: #00b894;
            --error: #d63031;
            --warning: #fdcb6e;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .status-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .status-label {
            color: #666;
            margin-top: 5px;
        }

        /* åŸºæº–å£²ä¸Šå…¥åŠ› */
        .baseline-input {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .baseline-input h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .baseline-value {
            font-size: 3em;
            font-weight: bold;
            color: var(--primary);
            margin: 15px 0;
        }

        .baseline-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .baseline-controls input {
            width: 150px;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* æœˆæ¬¡å¢—æ¸›å…¥åŠ› */
        .adjustment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .adjustment-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .adjustment-card:hover {
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.2);
        }

        .adjustment-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .month-input {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .month-input label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .month-input input {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
        }

        .month-input input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 5px rgba(39, 174, 96, 0.3);
        }

        /* è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .config-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .config-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .config-item input, .config-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        /* å±•ç¤ºä¼šè²»ç”¨ã®ç‰¹åˆ¥è¡¨ç¤º */
        .exhibition-info {
            background: #fff7e6;
            border: 1px solid #ffd93d;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .exhibition-info h4 {
            color: #b7950b;
            margin-bottom: 10px;
        }

        .exhibition-schedule {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }

        .exhibition-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid var(--warning);
        }

        /* çµæœè¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ« */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .results-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .results-table tr:hover {
            background: #e8f5e8;
        }

        .total-row {
            background: #e8f5e8 !important;
            font-weight: bold;
        }

        .profit-positive {
            color: var(--success);
        }

        .profit-negative {
            color: var(--error);
        }

        .exhibition-month {
            background: #fff3cd !important;
            border-left: 4px solid var(--warning) !important;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #00a085;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .data-status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
        }

        .data-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* RCå¸äº‹æ¥­éƒ¨ç‰¹æœ‰ã®èª¬æ˜ãƒœãƒƒã‚¯ã‚¹ */
        .rc-info {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .rc-info h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .rc-info ul {
            margin-left: 20px;
            color: #2d5016;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .content {
                padding: 20px;
            }

            .adjustment-grid {
                grid-template-columns: 1fr;
            }

            .month-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .header h1 {
                font-size: 2em;
            }

            .status-indicators {
                grid-template-columns: repeat(2, 1fr);
            }

            .baseline-controls {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="rc-theme">
    <div class="container">
        <div class="header">
            <h1>RCå¸äº‹æ¥­éƒ¨ æç›Šè¨ˆç®—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <div class="subtitle">åŸºæº–å£²ä¸Šæ–¹å¼ãƒ»å±•ç¤ºä¼šè²»ç”¨å¯¾å¿œãƒ¢ãƒ‡ãƒ« | v2.0 è‡ªå‹•é€ä¿¡å¯¾å¿œ</div>
        </div>

        <div class="content">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="status-indicators">
                <div class="status-card">
                    <div class="status-value" id="totalSalesDisplay">0</div>
                    <div class="status-label">å¹´é–“å£²ä¸Šï¼ˆä¸‡å††ï¼‰</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="operatingProfitDisplay">0</div>
                    <div class="status-label">å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="profitRateDisplay">0%</div>
                    <div class="status-label">åˆ©ç›Šç‡</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="exhibitionCostDisplay">0</div>
                    <div class="status-label">å¹´é–“å±•ç¤ºä¼šè²»ï¼ˆä¸‡å††ï¼‰</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="dataStatusDisplay">æœªé€ä¿¡</div>
                    <div class="status-label">ãƒ‡ãƒ¼ã‚¿é€ä¿¡çŠ¶æ³</div>
                </div>
            </div>

            <!-- RCå¸äº‹æ¥­éƒ¨ã®ç‰¹å¾´èª¬æ˜ -->
            <div class="section">
                <h2>ğŸª RCå¸äº‹æ¥­éƒ¨ã®ç‰¹å¾´</h2>
                <div class="rc-info">
                    <h4>ğŸ“Š åŸºæº–å£²ä¸Šæ–¹å¼</h4>
                    <ul>
                        <li><strong>æœˆæ¬¡å£²ä¸Š</strong> = åŸºæº–å£²ä¸Šï¼ˆ1,500ä¸‡å††ï¼‰+ æœˆæ¬¡å¢—æ¸›é¡</li>
                        <li><strong>å£²ä¸ŠåŸä¾¡</strong> = å£²ä¸Šé«˜ Ã— 65%</li>
                        <li><strong>ç‰¹åˆ¥è²»ç”¨</strong> = å±•ç¤ºä¼šè²»ç”¨ï¼ˆ5æœˆ150ä¸‡å††ã€12æœˆ200ä¸‡å††ï¼‰</li>
                        <li><strong>å–¶æ¥­åˆ©ç›Š</strong> = ç²—åˆ©ç›Š - äººä»¶è²» - è²©ç®¡è²» - ç‰¹åˆ¥è²»ç”¨</li>
                    </ul>
                </div>
                <div class="exhibition-info">
                    <h4>ğŸª å±•ç¤ºä¼šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h4>
                    <div class="exhibition-schedule">
                        <div class="exhibition-item">
                            <span>5æœˆå±•ç¤ºä¼š</span>
                            <strong>150ä¸‡å††</strong>
                        </div>
                        <div class="exhibition-item">
                            <span>12æœˆå±•ç¤ºä¼š</span>
                            <strong>200ä¸‡å††</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŸºæº–å£²ä¸Šè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“Š åŸºæº–å£²ä¸Šè¨­å®š</h2>
                <div class="baseline-input">
                    <h3>ğŸ’° æœˆæ¬¡åŸºæº–å£²ä¸Š</h3>
                    <div class="baseline-value" id="baselineSalesDisplay">1,500</div>
                    <div class="baseline-controls">
                        <label>åŸºæº–å£²ä¸Šï¼ˆä¸‡å††ï¼‰:</label>
                        <input type="number" id="baselineSales" value="1500" step="50" min="0" 
                               oninput="updateBaselineDisplay(); calculate(); updateCharts(); autoSendData();">
                    </div>
                </div>
            </div>

            <!-- æœˆæ¬¡å¢—æ¸›å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“ˆ æœˆæ¬¡å¢—æ¸›é¡å…¥åŠ›</h2>
                <div class="adjustment-grid">
                    <div class="adjustment-card">
                        <h3>ğŸ“Š æœˆæ¬¡å¢—æ¸›é¡</h3>
                        <div class="month-grid" id="adjustmentInputs">
                            <!-- JavaScriptã§ç”Ÿæˆ -->
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>å¹´é–“å¢—æ¸›åˆè¨ˆ: <span id="totalAdjustment">0</span>ä¸‡å††</strong>
                        </div>
                    </div>
                    <div class="adjustment-card">
                        <h3>ğŸ’° å®Ÿéš›ã®æœˆæ¬¡å£²ä¸Š</h3>
                        <div class="month-grid" id="actualSalesDisplay">
                            <!-- JavaScriptã§ç”Ÿæˆ -->
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>å¹´é–“å£²ä¸Šåˆè¨ˆ: <span id="totalActualSales">0</span>ä¸‡å††</strong>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="loadSampleData()">ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
                    <button class="btn btn-secondary" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ã‚¯ãƒªã‚¢</button>
                    <button class="btn btn-success" onclick="manualDataSend()">ğŸ“¤ æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿é€ä¿¡</button>
                </div>
            </div>

            <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>âš™ï¸ çµŒè²»ãƒ»è¨­å®š</h2>
                <div class="config-grid">
                    <div class="config-item">
                        <label>å£²ä¸ŠåŸä¾¡ç‡</label>
                        <input type="number" id="cogsRate" value="65" step="0.5" min="0" max="100">
                        <small>%ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 65%ï¼‰</small>
                    </div>
                    <div class="config-item">
                        <label>äººä»¶è²»ï¼ˆæœˆé¡ï¼‰</label>
                        <input type="number" id="personnelCost" value="300" step="10" min="0">
                        <small>ä¸‡å††</small>
                    </div>
                    <div class="config-item">
                        <label>è²©ç®¡è²»ï¼ˆæœˆé¡ï¼‰</label>
                        <input type="number" id="sellingExpenses" value="150" step="10" min="0">
                        <small>ä¸‡å††</small>
                    </div>
                    <div class="config-item">
                        <label>5æœˆå±•ç¤ºä¼šè²»</label>
                        <input type="number" id="exhibition5" value="150" step="10" min="0">
                        <small>ä¸‡å††</small>
                    </div>
                    <div class="config-item">
                        <label>12æœˆå±•ç¤ºä¼šè²»</label>
                        <input type="number" id="exhibition12" value="200" step="10" min="0">
                        <small>ä¸‡å††</small>
                    </div>
                </div>
            </div>

            <!-- è¨ˆç®—çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“Š æœˆæ¬¡æç›Šè¨ˆç®—æ›¸</h2>
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>é …ç›®</th>
                            <th>1æœˆ</th>
                            <th>2æœˆ</th>
                            <th>3æœˆ</th>
                            <th>4æœˆ</th>
                            <th>5æœˆ</th>
                            <th>6æœˆ</th>
                            <th>7æœˆ</th>
                            <th>8æœˆ</th>
                            <th>9æœˆ</th>
                            <th>10æœˆ</th>
                            <th>11æœˆ</th>
                            <th>12æœˆ</th>
                            <th>å¹´é–“åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- è¨ˆç®—çµæœã‚’JSã§æŒ¿å…¥ -->
                    </tbody>
                </table>
            </div>

            <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“ˆ è¦–è¦šåˆ†æ</h2>
                <div class="chart-container">
                    <h3>æœˆæ¬¡å£²ä¸Šãƒ»åˆ©ç›Šæ¨ç§»</h3>
                    <div class="chart-wrapper">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>å±•ç¤ºä¼šè²»ç”¨ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ</h3>
                    <div class="chart-wrapper">
                        <canvas id="exhibitionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ»çµ±åˆé€£æº</h2>
                <div id="dataStatus" class="data-status">
                    è‡ªå‹•é€ä¿¡: è¨ˆç®—æ™‚ã«çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã¸è‡ªå‹•é€ä¿¡ã•ã‚Œã¾ã™
                </div>
                <div style="text-align: center;">
                    <button class="btn" onclick="saveData()">ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="loadData()">ğŸ“‚ ãƒ­ãƒ¼ã‚«ãƒ«èª­è¾¼</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">ğŸ“„ CSVå‡ºåŠ›</button>
                    <button class="btn" onclick="checkIntegrationStatus()">ğŸ” çµ±åˆã‚·ã‚¹ãƒ†ãƒ ç¢ºèª</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const STORAGE_KEY = 'pl_system_rc_data';
        const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        let salesChart, exhibitionChart;

        // RCå¸äº‹æ¥­éƒ¨ã®è¨ˆç®—å®šæ•°
        const RC_CONSTANTS = {
            defaultBaseline: 1500,   // åŸºæº–å£²ä¸Š1500ä¸‡å††
            defaultCogsRate: 65,     // å£²ä¸ŠåŸä¾¡ç‡65%
            exhibition5: 150,        // 5æœˆå±•ç¤ºä¼šè²»150ä¸‡å††
            exhibition12: 200        // 12æœˆå±•ç¤ºä¼šè²»200ä¸‡å††
        };

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeInputs();
            updateBaselineDisplay();
            loadData();
            calculate();
            updateCharts();
        });

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆæœŸåŒ–
        function initializeInputs() {
            // æœˆæ¬¡å¢—æ¸›é¡å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”Ÿæˆ
            const adjustmentContainer = document.getElementById('adjustmentInputs');
            months.forEach((month, index) => {
                const monthInput = document.createElement('div');
                monthInput.className = 'month-input';
                monthInput.innerHTML = `
                    <label>${month}</label>
                    <input type="number" 
                           id="adjustment-month${index + 1}" 
                           min="-1000" 
                           max="1000" 
                           step="10" 
                           value="0"
                           oninput="updateActualSales(); calculate(); updateCharts(); autoSendData();">
                `;
                adjustmentContainer.appendChild(monthInput);
            });

            // å®Ÿéš›ã®å£²ä¸Šè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”Ÿæˆ
            const actualContainer = document.getElementById('actualSalesDisplay');
            months.forEach((month, index) => {
                const monthDisplay = document.createElement('div');
                monthDisplay.className = 'month-input';
                monthDisplay.innerHTML = `
                    <label>${month}</label>
                    <div id="actual-month${index + 1}" style="
                        padding: 8px; 
                        background: #e8f5e8; 
                        border: 2px solid var(--primary); 
                        border-radius: 5px; 
                        text-align: center; 
                        font-weight: bold;
                        color: var(--primary);
                        min-height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">1500</div>
                `;
                actualContainer.appendChild(monthDisplay);
            });
        }

        // åŸºæº–å£²ä¸Šè¡¨ç¤ºæ›´æ–°
        function updateBaselineDisplay() {
            const baseline = parseFloat(document.getElementById('baselineSales').value) || RC_CONSTANTS.defaultBaseline;
            document.getElementById('baselineSalesDisplay').textContent = baseline.toLocaleString();
            updateActualSales();
        }

        // å®Ÿéš›ã®å£²ä¸Šè¨ˆç®—ãƒ»è¡¨ç¤ºæ›´æ–°
        function updateActualSales() {
            const baseline = parseFloat(document.getElementById('baselineSales').value) || RC_CONSTANTS.defaultBaseline;
            let totalAdjustment = 0;
            let totalActualSales = 0;

            for (let i = 1; i <= 12; i++) {
                const adjustment = parseFloat(document.getElementById(`adjustment-month${i}`).value) || 0;
                const actualSales = baseline + adjustment;
                
                totalAdjustment += adjustment;
                totalActualSales += actualSales;

                document.getElementById(`actual-month${i}`).textContent = actualSales.toLocaleString();
            }

            document.getElementById('totalAdjustment').textContent = totalAdjustment.toLocaleString();
            document.getElementById('totalActualSales').textContent = totalActualSales.toLocaleString();
        }

        // æœˆæ¬¡è¨ˆç®—
        function calculateMonthlyPL(monthIndex) {
            const baseline = parseFloat(document.getElementById('baselineSales').value) || RC_CONSTANTS.defaultBaseline;
            const adjustment = parseFloat(document.getElementById(`adjustment-month${monthIndex + 1}`).value) || 0;
            const monthlySales = baseline + adjustment;
            
            const cogsRate = parseFloat(document.getElementById('cogsRate').value) / 100 || RC_CONSTANTS.defaultCogsRate / 100;
            const personnelCost = parseFloat(document.getElementById('personnelCost').value) || 0;
            const sellingExpenses = parseFloat(document.getElementById('sellingExpenses').value) || 0;
            const exhibition5 = parseFloat(document.getElementById('exhibition5').value) || RC_CONSTANTS.exhibition5;
            const exhibition12 = parseFloat(document.getElementById('exhibition12').value) || RC_CONSTANTS.exhibition12;

            // RCå¸äº‹æ¥­éƒ¨ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
            const cogs = monthlySales * cogsRate;
            const grossProfit = monthlySales - cogs;
            
            // å±•ç¤ºä¼šè²»ç”¨ï¼ˆ5æœˆã¨12æœˆã®ã¿ï¼‰
            let exhibitionCost = 0;
            if (monthIndex === 4) {  // 5æœˆ
                exhibitionCost = exhibition5;
            } else if (monthIndex === 11) {  // 12æœˆ
                exhibitionCost = exhibition12;
            }
            
            // å–¶æ¥­åˆ©ç›Š
            const operatingProfit = grossProfit - personnelCost - sellingExpenses - exhibitionCost;

            return {
                sales: monthlySales,
                baseline: baseline,
                adjustment: adjustment,
                cogs: cogs,
                grossProfit: grossProfit,
                personnelCost: personnelCost,
                sellingExpenses: sellingExpenses,
                exhibitionCost: exhibitionCost,
                operatingProfit: operatingProfit,
                profitRate: monthlySales > 0 ? (operatingProfit / monthlySales * 100) : 0,
                isExhibitionMonth: exhibitionCost > 0
            };
        }

        // å…¨ä½“è¨ˆç®—å®Ÿè¡Œ
        function calculate() {
            const results = [];
            let totalSales = 0, totalOperatingProfit = 0, totalExhibitionCost = 0;

            // æœˆæ¬¡è¨ˆç®—
            for (let i = 0; i < 12; i++) {
                const monthResult = calculateMonthlyPL(i);
                results.push(monthResult);
                totalSales += monthResult.sales;
                totalOperatingProfit += monthResult.operatingProfit;
                totalExhibitionCost += monthResult.exhibitionCost;
            }

            // çµæœè¡¨ç¤ºæ›´æ–°
            updateResultsTable(results);
            updateStatusDisplay(totalSales, totalOperatingProfit, totalExhibitionCost);
            updateActualSales();
        }

        // çµæœãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateResultsTable(results) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            const items = [
                { label: 'åŸºæº–å£²ä¸Š', key: 'baseline', format: 'currency' },
                { label: 'å¢—æ¸›é¡', key: 'adjustment', format: 'adjustment' },
                { label: 'å®Ÿéš›å£²ä¸Š', key: 'sales', format: 'currency' },
                { label: 'å£²ä¸ŠåŸä¾¡', key: 'cogs', format: 'currency' },
                { label: 'ç²—åˆ©ç›Š', key: 'grossProfit', format: 'currency' },
                { label: 'äººä»¶è²»', key: 'personnelCost', format: 'currency' },
                { label: 'è²©ç®¡è²»', key: 'sellingExpenses', format: 'currency' },
                { label: 'å±•ç¤ºä¼šè²»', key: 'exhibitionCost', format: 'exhibition' },
                { label: 'å–¶æ¥­åˆ©ç›Š', key: 'operatingProfit', format: 'profit' }
            ];

            items.forEach(item => {
                const row = document.createElement('tr');
                let html = `<td style="text-align: left; font-weight: bold;">${item.label}</td>`;

                let total = 0;
                results.forEach((result, index) => {
                    const value = result[item.key] || 0;
                    total += value;

                    let cellClass = '';
                    if (result.isExhibitionMonth) {
                        cellClass = 'exhibition-month';
                    }

                    if (item.format === 'profit') {
                        const profitClass = value >= 0 ? 'profit-positive' : 'profit-negative';
                        html += `<td class="${cellClass} ${profitClass}">${Math.round(value).toLocaleString()}</td>`;
                    } else if (item.format === 'adjustment') {
                        const adjustClass = value >= 0 ? 'profit-positive' : 'profit-negative';
                        html += `<td class="${cellClass} ${adjustClass}">${value >= 0 ? '+' : ''}${Math.round(value).toLocaleString()}</td>`;
                    } else if (item.format === 'exhibition') {
                        if (value > 0) {
                            html += `<td class="${cellClass}" style="background: #fff3cd; font-weight: bold; color: #856404;">${Math.round(value).toLocaleString()}</td>`;
                        } else {
                            html += `<td class="${cellClass}">-</td>`;
                        }
                    } else {
                        html += `<td class="${cellClass}">${Math.round(value).toLocaleString()}</td>`;
                    }
                });

                // å¹´é–“åˆè¨ˆ
                if (item.format === 'profit') {
                    const className = total >= 0 ? 'profit-positive' : 'profit-negative';
                    html += `<td class="${className}" style="font-weight: bold;">${Math.round(total).toLocaleString()}</td>`;
                } else if (item.format === 'adjustment') {
                    const className = total >= 0 ? 'profit-positive' : 'profit-negative';
                    html += `<td class="${className}" style="font-weight: bold;">${total >= 0 ? '+' : ''}${Math.round(total).toLocaleString()}</td>`;
                } else {
                    html += `<td style="font-weight: bold;">${Math.round(total).toLocaleString()}</td>`;
                }

                if (item.key === 'operatingProfit') {
                    row.className = 'total-row';
                }

                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
        function updateStatusDisplay(totalSales, totalOperatingProfit, totalExhibitionCost) {
            document.getElementById('totalSalesDisplay').textContent = Math.round(totalSales).toLocaleString();
            document.getElementById('operatingProfitDisplay').textContent = Math.round(totalOperatingProfit).toLocaleString();
            document.getElementById('exhibitionCostDisplay').textContent = Math.round(totalExhibitionCost).toLocaleString();
            
            const profitRate = totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0;
            document.getElementById('profitRateDisplay').textContent = profitRate.toFixed(1) + '%';
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateCharts() {
            updateSalesChart();
            updateExhibitionChart();
        }

        // å£²ä¸Šãƒ»åˆ©ç›Šæ¨ç§»ã‚°ãƒ©ãƒ•
        function updateSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            if (salesChart) {
                salesChart.destroy();
            }

            const salesData = [];
            const profitData = [];
            
            for (let i = 0; i < 12; i++) {
                const result = calculateMonthlyPL(i);
                salesData.push(Math.round(result.sales));
                profitData.push(Math.round(result.operatingProfit));
            }

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'æœˆæ¬¡å£²ä¸Š',
                            data: salesData,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'å–¶æ¥­åˆ©ç›Š',
                            data: profitData,
                            borderColor: '#00b894',
                            backgroundColor: 'rgba(0, 184, 148, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡å††';
                                }
                            }
                        }
                    }
                }
            });
        }

        // å±•ç¤ºä¼šè²»ç”¨ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚°ãƒ©ãƒ•
        function updateExhibitionChart() {
            const ctx = document.getElementById('exhibitionChart').getContext('2d');
            
            if (exhibitionChart) {
                exhibitionChart.destroy();
            }

            const normalProfitData = [];
            const exhibitionData = [];
            
            for (let i = 0; i < 12; i++) {
                const result = calculateMonthlyPL(i);
                const normalProfit = result.operatingProfit + result.exhibitionCost;
                
                normalProfitData.push(Math.round(normalProfit));
                exhibitionData.push(Math.round(-result.exhibitionCost));
            }

            exhibitionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'é€šå¸¸å–¶æ¥­åˆ©ç›Š',
                            data: normalProfitData,
                            backgroundColor: 'rgba(39, 174, 96, 0.7)'
                        },
                        {
                            label: 'å±•ç¤ºä¼šè²»ç”¨',
                            data: exhibitionData,
                            backgroundColor: 'rgba(253, 203, 110, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 1 && context.parsed.y < 0) {
                                        return `å±•ç¤ºä¼šè²»ç”¨: ${Math.abs(context.parsed.y).toLocaleString()}ä¸‡å††`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}ä¸‡å††`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'ä¸‡å††';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ğŸ”„ è‡ªå‹•ãƒ‡ãƒ¼ã‚¿é€ä¿¡æ©Ÿèƒ½ï¼ˆStep 2ã®æ ¸å¿ƒï¼‰
        function autoSendData() {
            try {
                const results = [];
                let totalSales = 0, totalOperatingProfit = 0, totalExhibitionCost = 0;

                // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿åé›†
                for (let i = 0; i < 12; i++) {
                    const monthResult = calculateMonthlyPL(i);
                    results.push({
                        month: i + 1,
                        sales: Math.round(monthResult.sales),
                        profit: Math.round(monthResult.operatingProfit),
                        profitRate: monthResult.profitRate,
                        exhibitionCost: Math.round(monthResult.exhibitionCost)
                    });
                    totalSales += monthResult.sales;
                    totalOperatingProfit += monthResult.operatingProfit;
                    totalExhibitionCost += monthResult.exhibitionCost;
                }

                // çµ±åˆã‚·ã‚¹ãƒ†ãƒ ç”¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
                const integrationData = {
                    department: 'RCå¸äº‹æ¥­éƒ¨',
                    timestamp: new Date().toISOString(),
                    monthly: results,
                    annual: {
                        sales: Math.round(totalSales),
                        profit: Math.round(totalOperatingProfit),
                        profitRate: totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0,
                        exhibitionCost: Math.round(totalExhibitionCost)
                    },
                    metadata: {
                        source: 'rc_calculator_v2',
                        version: '2.0',
                        calculationMethod: 'baseline_sales_exhibition_costs',
                        lastUpdated: new Date().toISOString()
                    }
                };

                // LocalStorageã«ä¿å­˜
                localStorage.setItem(STORAGE_KEY, JSON.stringify(integrationData));
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                document.getElementById('dataStatusDisplay').textContent = 'é€ä¿¡å®Œäº†';
                document.getElementById('dataStatusDisplay').style.color = '#00b894';
                
                // ãƒ­ã‚°å‡ºåŠ›
                console.log('RCå¸äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿è‡ªå‹•é€ä¿¡å®Œäº†:', integrationData);
                
                return true;
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('dataStatusDisplay').textContent = 'é€ä¿¡ã‚¨ãƒ©ãƒ¼';
                document.getElementById('dataStatusDisplay').style.color = '#d63031';
                return false;
            }
        }

        // æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿é€ä¿¡
        function manualDataSend() {
            const success = autoSendData();
            if (success) {
                showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã«é€ä¿¡ã—ã¾ã—ãŸ', 'success');
            } else {
                showStatus('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // çµ±åˆã‚·ã‚¹ãƒ†ãƒ ç¢ºèª
        function checkIntegrationStatus() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                const parsed = JSON.parse(data);
                const lastUpdate = new Date(parsed.timestamp).toLocaleString();
                showStatus(`æœ€çµ‚é€ä¿¡: ${lastUpdate}`, 'success');
            } else {
                showStatus('é€ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            }
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­è¾¼
        function loadSampleData() {
            // å¼•ç¶™ãæ›¸ã®å®Ÿç¸¾ä¾‹ã‚’å‚è€ƒã«ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¨­å®š
            // å¹´é–“å£²ä¸Š19,413ä¸‡å††ã€å–¶æ¥­åˆ©ç›Š1,894ä¸‡å††ã€å±•ç¤ºä¼šè²»350ä¸‡å††ã‚’ç›®æ¨™
            const sampleAdjustments = [100, 50, 150, 80, -50, 120, 90, 60, 110, 75, 85, 130];

            for (let i = 1; i <= 12; i++) {
                document.getElementById(`adjustment-month${i}`).value = sampleAdjustments[i-1];
            }

            updateActualSales();
            calculate();
            updateCharts();
            autoSendData();
            showStatus('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (!confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;

            for (let i = 1; i <= 12; i++) {
                document.getElementById(`adjustment-month${i}`).value = 0;
            }

            updateActualSales();
            calculate();
            updateCharts();
            autoSendData();
            showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            const data = {
                department: "RCå¸äº‹æ¥­éƒ¨",
                timestamp: new Date().toISOString(),
                inputData: {},
                config: {},
                version: "2.0"
            };

            // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿åé›†
            data.inputData.baseline = parseFloat(document.getElementById('baselineSales').value) || 0;
            for (let i = 1; i <= 12; i++) {
                data.inputData[`adjustment_month${i}`] = parseFloat(document.getElementById(`adjustment-month${i}`).value) || 0;
            }

            // è¨­å®šãƒ‡ãƒ¼ã‚¿åé›†
            data.config = {
                cogsRate: parseFloat(document.getElementById('cogsRate').value) || 0,
                personnelCost: parseFloat(document.getElementById('personnelCost').value) || 0,
                sellingExpenses: parseFloat(document.getElementById('sellingExpenses').value) || 0,
                exhibition5: parseFloat(document.getElementById('exhibition5').value) || 0,
                exhibition12: parseFloat(document.getElementById('exhibition12').value) || 0
            };

            localStorage.setItem(STORAGE_KEY + '_local', JSON.stringify(data));
            showStatus('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿èª­è¾¼
        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY + '_local');
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);
                
                // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                if (data.inputData) {
                    if (data.inputData.baseline) {
                        document.getElementById('baselineSales').value = data.inputData.baseline;
                        updateBaselineDisplay();
                    }
                    
                    for (let i = 1; i <= 12; i++) {
                        const value = data.inputData[`adjustment_month${i}`] || 0;
                        document.getElementById(`adjustment-month${i}`).value = value;
                    }
                }

                // è¨­å®šãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                if (data.config) {
                    document.getElementById('cogsRate').value = data.config.cogsRate || 65;
                    document.getElementById('personnelCost').value = data.config.personnelCost || 300;
                    document.getElementById('sellingExpenses').value = data.config.sellingExpenses || 150;
                    document.getElementById('exhibition5').value = data.config.exhibition5 || 150;
                    document.getElementById('exhibition12').value = data.config.exhibition12 || 200;
                }

                updateActualSales();
                calculate();
                updateCharts();
                autoSendData();
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // CSVå‡ºåŠ›
        function exportCSV() {
            const results = [];
            for (let i = 0; i < 12; i++) {
                results.push(calculateMonthlyPL(i));
            }

            let csv = 'RCå¸äº‹æ¥­éƒ¨ æç›Šè¨ˆç®—æ›¸\n\n';
            csv += 'é …ç›®,' + months.join(',') + ',å¹´é–“åˆè¨ˆ\n';

            const items = [
                { label: 'åŸºæº–å£²ä¸Š', key: 'baseline' },
                { label: 'å¢—æ¸›é¡', key: 'adjustment' },
                { label: 'å®Ÿéš›å£²ä¸Š', key: 'sales' },
                { label: 'å£²ä¸ŠåŸä¾¡', key: 'cogs' },
                { label: 'ç²—åˆ©ç›Š', key: 'grossProfit' },
                { label: 'äººä»¶è²»', key: 'personnelCost' },
                { label: 'è²©ç®¡è²»', key: 'sellingExpenses' },
                { label: 'å±•ç¤ºä¼šè²»', key: 'exhibitionCost' },
                { label: 'å–¶æ¥­åˆ©ç›Š', key: 'operatingProfit' }
            ];

            items.forEach(item => {
                let row = item.label;
                let total = 0;
                results.forEach(result => {
                    const value = Math.round(result[item.key] || 0);
                    row += ',' + value;
                    total += value;
                });
                row += ',' + Math.round(total);
                csv += row + '\n';
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `RCå¸äº‹æ¥­éƒ¨_æç›Šè¨ˆç®—æ›¸_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();

            showStatus('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'data-status ' + (type === 'error' ? 'error' : '');
            
            setTimeout(() => {
                statusDiv.textContent = 'è‡ªå‹•é€ä¿¡: è¨ˆç®—æ™‚ã«çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã¸è‡ªå‹•é€ä¿¡ã•ã‚Œã¾ã™';
                statusDiv.className = 'data-status';
            }, 3000);
        }

        // è¨­å®šå¤‰æ›´æ™‚ã®å†è¨ˆç®—
        ['baselineSales', 'cogsRate', 'personnelCost', 'sellingExpenses', 'exhibition5', 'exhibition12'].forEach(id => {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById(id).addEventListener('input', () => {
                    if (id === 'baselineSales') {
                        updateBaselineDisplay();
                    }
                    calculate();
                    updateCharts();
                    autoSendData();
                });
            });
        });
    </script>
</body>
</html>
