<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ  - ä¿è­·æˆ¦ç•¥é©ç”¨ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
        }

        .title-section {
            padding: 25px 20px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .main-title {
            font-size: 32px;
            font-weight: 800;
            color: white;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }

        .control-section {
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .control-table {
            width: 100%;
            border-collapse: collapse;
        }

        .control-table td {
            padding: 8px 0;
            vertical-align: middle;
        }

        .status-cell {
            width: 35%;
            text-align: left;
        }

        .controls-cell {
            width: 65%;
            text-align: right;
        }

        .linkage-status {
            display: inline-block;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .linkage-warning {
            background: rgba(243, 156, 18, 0.25);
            color: #f39c12;
            border: 2px solid rgba(243, 156, 18, 0.5);
        }

        .linkage-success {
            background: rgba(39, 174, 96, 0.25);
            color: #27ae60;
            border: 2px solid rgba(39, 174, 96, 0.5);
        }

        .linkage-error {
            background: rgba(231, 76, 60, 0.25);
            color: #e74c3c;
            border: 2px solid rgba(231, 76, 60, 0.5);
        }

        .control-group {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            color: white;
            white-space: nowrap;
        }

        .control-item input {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 70px;
            font-size: 11px;
            text-align: center;
        }

        .btn-action {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-update {
            background: #27ae60;
            color: white;
        }

        .btn-update:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .btn-csv {
            background: #e67e22;
            color: white;
        }

        .btn-csv:hover {
            background: #d35400;
            transform: translateY(-2px);
        }

        .btn-test {
            background: #9b59b6;
            color: white;
        }

        .btn-test:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }

        .main-content {
            padding: 25px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 3px solid #34495e;
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.06);
            margin-bottom: 25px;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 15px;
        }

        .table-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.06);
        }

        .pl-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin-top: 15px;
        }

        .pl-table th,
        .pl-table td {
            padding: 5px 4px;
            text-align: right;
            border: 1px solid #ddd;
            line-height: 1.2;
        }

        .pl-table th {
            background: #34495e;
            color: white;
            font-weight: 700;
            position: sticky;
            top: 0;
            font-size: 11px;
            padding: 7px 4px;
        }

        .pl-table th:first-child,
        .pl-table td:first-child {
            text-align: left;
            font-weight: 600;
        }

        .pl-table tr:hover {
            background: rgba(52, 73, 94, 0.05);
        }

        .sales-row { background: rgba(39, 174, 96, 0.1); }
        .expense-row { background: rgba(231, 76, 60, 0.08); }
        .profit-row { background: rgba(52, 152, 219, 0.1); font-weight: 700; }
        .total-row { background: rgba(52, 73, 94, 0.2); font-weight: 700; }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .summary-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .summary-card .unit {
            font-size: 12px;
            color: #95a5a6;
            font-weight: 500;
        }

        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .neutral { color: #34495e; }

        @media (max-width: 768px) {
            .main-title {
                font-size: 24px;
            }

            .control-table td {
                display: block;
                width: 100%;
                text-align: center;
                padding: 5px 0;
            }

            .control-group {
                justify-content: center;
                gap: 10px;
            }

            .pl-table {
                font-size: 9px;
            }

            .pl-table th,
            .pl-table td {
                padding: 4px 3px;
            }

            .summary-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ===== ã€ä¿è­·é ˜åŸŸé–‹å§‹ã€‘çµ¶å¯¾ã«å¤‰æ›´ç¦æ­¢ ===== -->
        <script>
        // çµ±åˆã‚·ã‚¹ãƒ†ãƒ ç”¨LocalStorageã‚­ãƒ¼ç®¡ç† - å¤‰æ›´ç¦æ­¢
        const STORAGE_KEYS = {
            rcd: 'pl_system_rcd_data',
            w: 'pl_system_w_data',
            rc: 'pl_system_rc_data',
            sr: 'pl_system_sr_data',
            integrated: 'pl_system_integrated_data'
        };

        // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ãƒ»ç®¡ç†æ©Ÿèƒ½ç¾¤ - å¤‰æ›´ç¦æ­¢
        const DATA_TRANSMISSION = {
            createIntegrationData: function(departmentData, metadata) {
                const integrationData = {
                    timestamp: new Date().toISOString(),
                    departments: departmentData,
                    metadata: metadata,
                    version: '2.0',
                    status: 'integrated'
                };
                return integrationData;
            },
            
            sendToIntegrated: function(data) {
                try {
                    localStorage.setItem(STORAGE_KEYS.integrated, JSON.stringify(data));
                    this.updateSendStatus('success', 'çµ±åˆãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†');
                    return true;
                } catch (error) {
                    this.updateSendStatus('error', 'ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    return false;
                }
            },
            
            updateSendStatus: function(status, message) {
                const statusElement = document.getElementById('linkage-status');
                if (statusElement) {
                    if (status === 'success') {
                        statusElement.className = 'linkage-status linkage-success';
                        statusElement.innerHTML = 'âœ“ ' + message;
                    } else if (status === 'error') {
                        statusElement.className = 'linkage-status linkage-error';
                        statusElement.innerHTML = 'âœ— ' + message;
                    } else {
                        statusElement.className = 'linkage-status linkage-warning';
                        statusElement.innerHTML = 'âš  ' + message;
                    }
                }
            },
            
            validateData: function(data) {
                if (!data || typeof data !== 'object') return false;
                if (!data.departments || Object.keys(data.departments).length === 0) return false;
                return true;
            },
            
            checkIntegrationStatus: function() {
                const data = localStorage.getItem(STORAGE_KEYS.integrated);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        return this.validateData(parsed) ? 'connected' : 'error';
                    } catch (error) {
                        return 'error';
                    }
                }
                return 'disconnected';
            }
        };

        // è‡ªå‹•ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Ÿè¡Œé–¢æ•° - å¤‰æ›´ç¦æ­¢
        function autoSendData() {
            const departmentData = CALCULATION_ENGINE.collectDepartmentData();
            const metadata = {
                lastUpdate: new Date().toISOString(),
                calculationEngine: 'v2.0',
                departments: ['sr', 'w', 'rc', 'rcd']
            };
            
            const integrationData = DATA_TRANSMISSION.createIntegrationData(departmentData, metadata);
            return DATA_TRANSMISSION.sendToIntegrated(integrationData);
        }

        // æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿é€ä¿¡é–¢æ•° - å¤‰æ›´ç¦æ­¢
        function manualDataSend() {
            console.log('æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Ÿè¡Œ...');
            const result = autoSendData();
            if (result) {
                alert('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
            } else {
                alert('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
            return result;
        }

        // çµ±åˆã‚·ã‚¹ãƒ†ãƒ ç¢ºèªé–¢æ•° - å¤‰æ›´ç¦æ­¢
        function checkIntegrationStatus() {
            return DATA_TRANSMISSION.checkIntegrationStatus();
        }
        </script>
        <!-- ===== ã€ä¿è­·é ˜åŸŸçµ‚äº†ã€‘ ===== -->

        <header class="header">
            <div class="title-section">
                <h1 class="main-title">4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ </h1>
                <p class="subtitle">ä¿è­·æˆ¦ç•¥é©ç”¨ç‰ˆ - çµ±åˆæç›Šè¨ˆç®—æ›¸</p>
            </div>

            <div class="control-section">
                <table class="control-table">
                    <tr>
                        <td class="status-cell">
                            <div id="linkage-status" class="linkage-status linkage-warning">
                                âš  ãƒ‡ãƒ¼ã‚¿çµ±åˆæº–å‚™ä¸­
                            </div>
                        </td>
                        <td class="controls-cell">
                            <div class="control-group">
                                <div class="control-item">
                                    <span>å½¹å“¡å ±é…¬:</span>
                                    <span id="executive-salary-display">6,755</span>
                                    <span>ä¸‡å††/æœˆ</span>
                                </div>
                                <div class="control-item">
                                    <span>å½¹å“¡è³ä¸:</span>
                                    <span id="executive-bonus-display">300</span>
                                    <span>ä¸‡å††</span>
                                </div>
                                <div class="control-item">
                                    <span>æœ€çµ‚æ›´æ–°:</span>
                                    <span id="last-update">æœªå–å¾—</span>
                                </div>
                                <button class="btn-action btn-update" onclick="loadAllIntegratedData()">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
                                <button class="btn-action btn-csv" onclick="exportIntegratedCSV()">CSVå‡ºåŠ›</button>
                                <button class="btn-action btn-test" onclick="loadTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿</button>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </header>

        <main class="main-content">
            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>å¹´é–“å£²ä¸Šåˆè¨ˆ</h3>
                    <div class="value neutral" id="total-sales-summary">0</div>
                    <div class="unit">ä¸‡å††</div>
                </div>
                <div class="summary-card">
                    <h3>å¹´é–“å–¶æ¥­åˆ©ç›Š</h3>
                    <div class="value neutral" id="total-profit-summary">0</div>
                    <div class="unit">ä¸‡å††</div>
                </div>
                <div class="summary-card">
                    <h3>å–¶æ¥­åˆ©ç›Šç‡</h3>
                    <div class="value neutral" id="profit-margin-summary">0.0</div>
                    <div class="unit">%</div>
                </div>
                <div class="summary-card">
                    <h3>äº‹æ¥­éƒ¨æ•°</h3>
                    <div class="value neutral" id="department-count">4</div>
                    <div class="unit">éƒ¨é–€</div>
                </div>
            </div>

            <!-- å‰æœŸæ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="chart-section">
                <h3 class="section-title">ğŸ“ˆ å‰æœŸæ¯”è¼ƒæ¨ç§»ï¼ˆå£²ä¸Šãƒ»å–¶æ¥­åˆ©ç›Šï¼‰</h3>
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <!-- çµ±åˆPLè¡¨ -->
            <div class="table-section">
                <h3 class="section-title">ğŸ“Š 4äº‹æ¥­éƒ¨çµ±åˆæç›Šè¨ˆç®—æ›¸ï¼ˆæœˆæ¬¡è©³ç´°ï¼‰</h3>
                <table class="pl-table">
                    <thead>
                        <tr>
                            <th style="width: 120px;">é …ç›®</th>
                            <th>7æœˆ</th>
                            <th>8æœˆ</th>
                            <th>9æœˆ</th>
                            <th>10æœˆ</th>
                            <th>11æœˆ</th>
                            <th>12æœˆ</th>
                            <th>1æœˆ</th>
                            <th>2æœˆ</th>
                            <th>3æœˆ</th>
                            <th>4æœˆ</th>
                            <th>5æœˆ</th>
                            <th>6æœˆ</th>
                            <th>å¹´é–“åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- å£²ä¸Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <tr class="sales-row">
                            <td>SRäº‹æ¥­éƒ¨å£²ä¸Š</td>
                            <td id="sr-sales-jul">0</td>
                            <td id="sr-sales-aug">0</td>
                            <td id="sr-sales-sep">0</td>
                            <td id="sr-sales-oct">0</td>
                            <td id="sr-sales-nov">0</td>
                            <td id="sr-sales-dec">0</td>
                            <td id="sr-sales-jan">0</td>
                            <td id="sr-sales-feb">0</td>
                            <td id="sr-sales-mar">0</td>
                            <td id="sr-sales-apr">0</td>
                            <td id="sr-sales-may">0</td>
                            <td id="sr-sales-jun">0</td>
                            <td id="sr-sales-total">0</td>
                        </tr>
                        <tr class="sales-row">
                            <td>Wäº‹æ¥­éƒ¨å£²ä¸Š</td>
                            <td id="w-sales-jul">0</td>
                            <td id="w-sales-aug">0</td>
                            <td id="w-sales-sep">0</td>
                            <td id="w-sales-oct">0</td>
                            <td id="w-sales-nov">0</td>
                            <td id="w-sales-dec">0</td>
                            <td id="w-sales-jan">0</td>
                            <td id="w-sales-feb">0</td>
                            <td id="w-sales-mar">0</td>
                            <td id="w-sales-apr">0</td>
                            <td id="w-sales-may">0</td>
                            <td id="w-sales-jun">0</td>
                            <td id="w-sales-total">0</td>
                        </tr>
                        <tr class="sales-row">
                            <td>RCå¸äº‹æ¥­éƒ¨å£²ä¸Š</td>
                            <td id="rc-sales-jul">0</td>
                            <td id="rc-sales-aug">0</td>
                            <td id="rc-sales-sep">0</td>
                            <td id="rc-sales-oct">0</td>
                            <td id="rc-sales-nov">0</td>
                            <td id="rc-sales-dec">0</td>
                            <td id="rc-sales-jan">0</td>
                            <td id="rc-sales-feb">0</td>
                            <td id="rc-sales-mar">0</td>
                            <td id="rc-sales-apr">0</td>
                            <td id="rc-sales-may">0</td>
                            <td id="rc-sales-jun">0</td>
                            <td id="rc-sales-total">0</td>
                        </tr>
                        <tr class="sales-row">
                            <td>RCDç¤¾äº‹æ¥­éƒ¨å£²ä¸Š</td>
                            <td id="rcd-sales-jul">0</td>
                            <td id="rcd-sales-aug">0</td>
                            <td id="rcd-sales-sep">0</td>
                            <td id="rcd-sales-oct">0</td>
                            <td id="rcd-sales-nov">0</td>
                            <td id="rcd-sales-dec">0</td>
                            <td id="rcd-sales-jan">0</td>
                            <td id="rcd-sales-feb">0</td>
                            <td id="rcd-sales-mar">0</td>
                            <td id="rcd-sales-apr">0</td>
                            <td id="rcd-sales-may">0</td>
                            <td id="rcd-sales-jun">0</td>
                            <td id="rcd-sales-total">0</td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>A: å£²ä¸Šé«˜ è¨ˆ</strong></td>
                            <td id="total-sales-jul"><strong>0</strong></td>
                            <td id="total-sales-aug"><strong>0</strong></td>
                            <td id="total-sales-sep"><strong>0</strong></td>
                            <td id="total-sales-oct"><strong>0</strong></td>
                            <td id="total-sales-nov"><strong>0</strong></td>
                            <td id="total-sales-dec"><strong>0</strong></td>
                            <td id="total-sales-jan"><strong>0</strong></td>
                            <td id="total-sales-feb"><strong>0</strong></td>
                            <td id="total-sales-mar"><strong>0</strong></td>
                            <td id="total-sales-apr"><strong>0</strong></td>
                            <td id="total-sales-may"><strong>0</strong></td>
                            <td id="total-sales-jun"><strong>0</strong></td>
                            <td id="total-sales-year"><strong>0</strong></td>
                        </tr>
                        
                        <!-- ä»•å…¥ãƒ»å£²ä¸Šç·åˆ©ç›Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <tr class="expense-row">
                            <td><strong>B: ä»•å…¥é«˜ è¨ˆ</strong></td>
                            <td id="cogs-jul">0</td>
                            <td id="cogs-aug">0</td>
                            <td id="cogs-sep">0</td>
                            <td id="cogs-oct">0</td>
                            <td id="cogs-nov">0</td>
                            <td id="cogs-dec">0</td>
                            <td id="cogs-jan">0</td>
                            <td id="cogs-feb">0</td>
                            <td id="cogs-mar">0</td>
                            <td id="cogs-apr">0</td>
                            <td id="cogs-may">0</td>
                            <td id="cogs-jun">0</td>
                            <td id="cogs-total"><strong>0</strong></td>
                        </tr>
                        
                        <tr class="profit-row">
                            <td><strong>C: å£²ä¸Šç·åˆ©ç›Š</strong></td>
                            <td id="gross-profit-jul"><strong>0</strong></td>
                            <td id="gross-profit-aug"><strong>0</strong></td>
                            <td id="gross-profit-sep"><strong>0</strong></td>
                            <td id="gross-profit-oct"><strong>0</strong></td>
                            <td id="gross-profit-nov"><strong>0</strong></td>
                            <td id="gross-profit-dec"><strong>0</strong></td>
                            <td id="gross-profit-jan"><strong>0</strong></td>
                            <td id="gross-profit-feb"><strong>0</strong></td>
                            <td id="gross-profit-mar"><strong>0</strong></td>
                            <td id="gross-profit-apr"><strong>0</strong></td>
                            <td id="gross-profit-may"><strong>0</strong></td>
                            <td id="gross-profit-jun"><strong>0</strong></td>
                            <td id="gross-profit-year"><strong>0</strong></td>
                        </tr>
                        
                        <!-- è²©å£²ç®¡ç†è²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <tr class="expense-row">
                            <td>äººä»¶è²»çµ±åˆ</td>
                            <td id="personnel-jul">0</td>
                            <td id="personnel-aug">0</td>
                            <td id="personnel-sep">0</td>
                            <td id="personnel-oct">0</td>
                            <td id="personnel-nov">0</td>
                            <td id="personnel-dec">0</td>
                            <td id="personnel-jan">0</td>
                            <td id="personnel-feb">0</td>
                            <td id="personnel-mar">0</td>
                            <td id="personnel-apr">0</td>
                            <td id="personnel-may">0</td>
                            <td id="personnel-jun">0</td>
                            <td id="personnel-total">0</td>
                        </tr>
                        <tr class="expense-row">
                            <td>æ³•å®šç¦åˆ©è²»</td>
                            <td id="welfare-jul">0</td>
                            <td id="welfare-aug">0</td>
                            <td id="welfare-sep">0</td>
                            <td id="welfare-oct">0</td>
                            <td id="welfare-nov">0</td>
                            <td id="welfare-dec">0</td>
                            <td id="welfare-jan">0</td>
                            <td id="welfare-feb">0</td>
                            <td id="welfare-mar">0</td>
                            <td id="welfare-apr">0</td>
                            <td id="welfare-may">0</td>
                            <td id="welfare-jun">0</td>
                            <td id="welfare-total">0</td>
                        </tr>
                        <tr class="expense-row">
                            <td>è¡›ç”Ÿè²»</td>
                            <td>25</td><td>25</td><td>25</td><td>25</td><td>25</td><td>25</td>
                            <td>25</td><td>25</td><td>25</td><td>25</td><td>25</td><td>25</td>
                            <td>300</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ç‰©æµç®¡ç†è²»</td>
                            <td>180</td><td>180</td><td>180</td><td>180</td><td>180</td><td>180</td>
                            <td>180</td><td>180</td><td>180</td><td>180</td><td>180</td><td>180</td>
                            <td>2,160</td>
                        </tr>
                        <tr class="expense-row">
                            <td>åœ°ä»£å®¶è³ƒ</td>
                            <td>420</td><td>420</td><td>420</td><td>420</td><td>420</td><td>420</td>
                            <td>420</td><td>420</td><td>420</td><td>420</td><td>420</td><td>420</td>
                            <td>5,040</td>
                        </tr>
                        <tr class="expense-row">
                            <td>å¤–æ³¨è²»</td>
                            <td>200</td><td>200</td><td>200</td><td>200</td><td>200</td><td>200</td>
                            <td>200</td><td>200</td><td>200</td><td>200</td><td>200</td><td>200</td>
                            <td>2,400</td>
                        </tr>
                        <tr class="expense-row">
                            <td>è·é€ é‹è³ƒ</td>
                            <td>85</td><td>85</td><td>85</td><td>85</td><td>85</td><td>85</td>
                            <td>85</td><td>85</td><td>85</td><td>85</td><td>85</td><td>85</td>
                            <td>1,020</td>
                        </tr>
                        <tr class="expense-row">
                            <td>åºƒå‘Šå®£ä¼è²»</td>
                            <td>150</td><td>150</td><td>150</td><td>150</td><td>150</td><td>150</td>
                            <td>150</td><td>150</td><td>150</td><td>150</td><td>150</td><td>150</td>
                            <td>1,800</td>
                        </tr>
                        <tr class="expense-row">
                            <td>æ—…è²»äº¤é€šè²»</td>
                            <td>120</td><td>120</td><td>120</td><td>120</td><td>120</td><td>120</td>
                            <td>120</td><td>120</td><td>120</td><td>120</td><td>120</td><td>120</td>
                            <td>1,440</td>
                        </tr>
                        <tr class="expense-row">
                            <td>é€šä¿¡è²»</td>
                            <td>180</td><td>180</td><td>180</td><td>180</td><td>180</td><td>180</td>
                            <td>180</td><td>180</td><td>180</td><td>180</td><td>180</td><td>180</td>
                            <td>2,160</td>
                        </tr>
                        <tr class="expense-row">
                            <td>è²©å£²ä¿ƒé€²è²»</td>
                            <td>95</td><td>95</td><td>95</td><td>95</td><td>95</td><td>95</td>
                            <td>95</td><td>95</td><td>95</td><td>95</td><td>95</td><td>95</td>
                            <td>1,140</td>
                        </tr>
                        <tr class="expense-row">
                            <td>æ¶ˆè€—å“è²»</td>
                            <td>45</td><td>45</td><td>45</td><td>45</td><td>45</td><td>45</td>
                            <td>45</td><td>45</td><td>45</td><td>45</td><td>45</td><td>45</td>
                            <td>540</td>
                        </tr>
                        <tr class="expense-row">
                            <td>äº‹å‹™ç”¨å“è²»</td>
                            <td>35</td><td>35</td><td>35</td><td>35</td><td>35</td><td>35</td>
                            <td>35</td><td>35</td><td>35</td><td>35</td><td>35</td><td>35</td>
                            <td>420</td>
                        </tr>
                        <tr class="expense-row">
                            <td>æ°´é“å…‰ç†±è²»</td>
                            <td>95</td><td>95</td><td>95</td><td>95</td><td>95</td><td>95</td>
                            <td>95</td><td>95</td><td>95</td><td>95</td><td>95</td><td>95</td>
                            <td>1,140</td>
                        </tr>
                        <tr class="expense-row">
                            <td>æ”¯æ‰•æ‰‹æ•°æ–™</td>
                            <td>90</td><td>90</td><td>90</td><td>90</td><td>90</td><td>90</td>
                            <td>90</td><td>90</td><td>90</td><td>90</td><td>90</td><td>90</td>
                            <td>1,080</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ãƒªãƒ¼ã‚¹æ–™</td>
                            <td>65</td><td>65</td><td>65</td><td>65</td><td>65</td><td>65</td>
                            <td>65</td><td>65</td><td>65</td><td>65</td><td>65</td><td>65</td>
                            <td>780</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ä¿é™ºæ–™</td>
                            <td>75</td><td>75</td><td>75</td><td>75</td><td>75</td><td>75</td>
                            <td>75</td><td>75</td><td>75</td><td>75</td><td>75</td><td>75</td>
                            <td>900</td>
                        </tr>
                        <tr class="expense-row">
                            <td>æ”¯æ‰•å ±é…¬æ–™</td>
                            <td>110</td><td>110</td><td>110</td><td>110</td><td>110</td><td>110</td>
                            <td>110</td><td>110</td><td>110</td><td>110</td><td>110</td><td>110</td>
                            <td>1,320</td>
                        </tr>
                        <tr class="expense-row">
                            <td>æ¸›ä¾¡å„Ÿå´è²»</td>
                            <td>240</td><td>240</td><td>240</td><td>240</td><td>240</td><td>240</td>
                            <td>240</td><td>240</td><td>240</td><td>240</td><td>240</td><td>240</td>
                            <td>2,880</td>
                        </tr>
                        <tr class="expense-row">
                            <td>å½¹å“¡å ±é…¬</td>
                            <td id="salary-jul">0</td>
                            <td id="salary-aug">0</td>
                            <td id="salary-sep">0</td>
                            <td id="salary-oct">0</td>
                            <td id="salary-nov">0</td>
                            <td id="salary-dec">0</td>
                            <td id="salary-jan">0</td>
                            <td id="salary-feb">0</td>
                            <td id="salary-mar">0</td>
                            <td id="salary-apr">0</td>
                            <td id="salary-may">0</td>
                            <td id="salary-jun">0</td>
                            <td id="salary-total">0</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ç®¡ç†è«¸è²»</td>
                            <td>140</td><td>140</td><td>140</td><td>140</td><td>140</td><td>140</td>
                            <td>140</td><td>140</td><td>140</td><td>140</td><td>140</td><td>140</td>
                            <td>1,680</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ä¿®ç¹•è²»</td>
                            <td>65</td><td>65</td><td>65</td><td>65</td><td>65</td><td>65</td>
                            <td>65</td><td>65</td><td>65</td><td>65</td><td>65</td><td>65</td>
                            <td>780</td>
                        </tr>
                        <tr class="expense-row">
                            <td>è»Šä¸¡è²»</td>
                            <td>85</td><td>85</td><td>85</td><td>85</td><td>85</td><td>85</td>
                            <td>85</td><td>85</td><td>85</td><td>85</td><td>85</td><td>85</td>
                            <td>1,020</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ç§Ÿç¨å…¬èª²</td>
                            <td>120</td><td>120</td><td>120</td><td>120</td><td>120</td><td>120</td>
                            <td>120</td><td>120</td><td>120</td><td>120</td><td>120</td><td>120</td>
                            <td>1,440</td>
                        </tr>
                        <tr class="expense-row">
                            <td>äº¤éš›è²»</td>
                            <td>80</td><td>80</td><td>80</td><td>80</td><td>80</td><td>80</td>
                            <td>80</td><td>80</td><td>80</td><td>80</td><td>80</td><td>80</td>
                            <td>960</td>
                        </tr>
                        <tr class="expense-row">
                            <td>è«¸ä¼šè²»</td>
                            <td>30</td><td>30</td><td>30</td><td>30</td><td>30</td><td>30</td>
                            <td>30</td><td>30</td><td>30</td><td>30</td><td>30</td><td>30</td>
                            <td>360</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ä¼šè­°è²»</td>
                            <td>15</td><td>15</td><td>15</td><td>15</td><td>15</td><td>15</td>
                            <td>15</td><td>15</td><td>15</td><td>15</td><td>15</td><td>15</td>
                            <td>180</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ç¦åˆ©åšç”Ÿè²»</td>
                            <td>45</td><td>45</td><td>45</td><td>45</td><td>45</td><td>45</td>
                            <td>45</td><td>45</td><td>45</td><td>45</td><td>45</td><td>45</td>
                            <td>540</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ç ”ä¿®è²»</td>
                            <td>25</td><td>25</td><td>25</td><td>25</td><td>25</td><td>25</td>
                            <td>25</td><td>25</td><td>25</td><td>25</td><td>25</td><td>25</td>
                            <td>300</td>
                        </tr>
                        <tr class="expense-row">
                            <td>é›‘è²»</td>
                            <td>55</td><td>55</td><td>55</td><td>55</td><td>55</td><td>55</td>
                            <td>55</td><td>55</td><td>55</td><td>55</td><td>55</td><td>55</td>
                            <td>660</td>
                        </tr>
                        <tr class="expense-row">
                            <td>å¯„ä»˜é‡‘</td>
                            <td>15</td><td>15</td><td>15</td><td>15</td><td>15</td><td>15</td>
                            <td>15</td><td>15</td><td>15</td><td>15</td><td>15</td><td>15</td>
                            <td>180</td>
                        </tr>
                        <tr class="expense-row">
                            <td>ãã®ä»–</td>
                            <td>75</td><td>75</td><td>75</td><td>75</td><td>75</td><td>75</td>
                            <td>75</td><td>75</td><td>75</td><td>75</td><td>75</td><td>75</td>
                            <td>900</td>
                        </tr>
                        
                        <tr class="total-row">
                            <td><strong>D: è²©å£²ç®¡ç†è²» è¨ˆ</strong></td>
                            <td id="total-expenses-jul"><strong>0</strong></td>
                            <td id="total-expenses-aug"><strong>0</strong></td>
                            <td id="total-expenses-sep"><strong>0</strong></td>
                            <td id="total-expenses-oct"><strong>0</strong></td>
                            <td id="total-expenses-nov"><strong>0</strong></td>
                            <td id="total-expenses-dec"><strong>0</strong></td>
                            <td id="total-expenses-jan"><strong>0</strong></td>
                            <td id="total-expenses-feb"><strong>0</strong></td>
                            <td id="total-expenses-mar"><strong>0</strong></td>
                            <td id="total-expenses-apr"><strong>0</strong></td>
                            <td id="total-expenses-may"><strong>0</strong></td>
                            <td id="total-expenses-jun"><strong>0</strong></td>
                            <td id="total-expenses-year"><strong>0</strong></td>
                        </tr>
                        
                        <tr class="profit-row">
                            <td><strong>E: å–¶æ¥­åˆ©ç›Š</strong></td>
                            <td id="operating-profit-jul"><strong>0</strong></td>
                            <td id="operating-profit-aug"><strong>0</strong></td>
                            <td id="operating-profit-sep"><strong>0</strong></td>
                            <td id="operating-profit-oct"><strong>0</strong></td>
                            <td id="operating-profit-nov"><strong>0</strong></td>
                            <td id="operating-profit-dec"><strong>0</strong></td>
                            <td id="operating-profit-jan"><strong>0</strong></td>
                            <td id="operating-profit-feb"><strong>0</strong></td>
                            <td id="operating-profit-mar"><strong>0</strong></td>
                            <td id="operating-profit-apr"><strong>0</strong></td>
                            <td id="operating-profit-may"><strong>0</strong></td>
                            <td id="operating-profit-jun"><strong>0</strong></td>
                            <td id="operating-profit-year"><strong>0</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- ===== ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºé ˜åŸŸé–‹å§‹ã€‘è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´å¯èƒ½ ===== -->
    <script>
        // çµ±åˆã‚·ã‚¹ãƒ†ãƒ è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ - ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯¾è±¡
        const CALCULATION_ENGINE = {
            // å„äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿å–å¾—
            collectDepartmentData: function() {
                const departments = ['sr', 'w', 'rc', 'rcd'];
                const data = {};
                
                departments.forEach(dept => {
                    try {
                        const stored = localStorage.getItem(STORAGE_KEYS[dept]);
                        if (stored) {
                            data[dept] = JSON.parse(stored);
                        } else {
                            data[dept] = this.getEmptyDepartmentData();
                        }
                    } catch (error) {
                        console.error(`${dept}äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
                        data[dept] = this.getEmptyDepartmentData();
                    }
                });
                
                return data;
            },
            
            // ç©ºã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
            getEmptyDepartmentData: function() {
                return {
                    sales: new Array(12).fill(0),
                    cogs: new Array(12).fill(0),
                    personnel: new Array(12).fill(0),
                    expenses: new Array(12).fill(0), // è²©ç®¡è²»è¿½åŠ 
                    metadata: {
                        lastUpdate: null,
                        dataSource: 'empty'
                    }
                };
            },
            
            // ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ»å¤‰æ›å‡¦ç†ï¼ˆè²©ç®¡è²»ã‚’å„äº‹æ¥­éƒ¨ã‹ã‚‰å‹•çš„å–å¾—ï¼‰
            extractFinancialData: function(rawData, department) {
                const result = {
                    sales: new Array(12).fill(0),
                    cogs: new Array(12).fill(0),
                    personnel: new Array(12).fill(0),
                    expenses: new Array(12).fill(0) // è²©ç®¡è²»è¿½åŠ 
                };
                
                try {
                    // äº‹æ¥­éƒ¨åˆ¥ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¿œã˜ãŸæŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯
                    if (department === 'sr' && rawData.stores) {
                        // SRäº‹æ¥­éƒ¨ï¼š6åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®çµ±åˆ
                        for (let month = 0; month < 12; month++) {
                            let monthlySales = 0, monthlyCogs = 0, monthlyPersonnel = 0, monthlyExpenses = 0;
                            
                            rawData.stores.forEach(store => {
                                if (store.monthlySales && store.monthlySales[month]) {
                                    monthlySales += store.monthlySales[month];
                                }
                                if (store.monthlyCogs && store.monthlyCogs[month]) {
                                    monthlyCogs += store.monthlyCogs[month];
                                }
                                if (store.monthlyPersonnel && store.monthlyPersonnel[month]) {
                                    monthlyPersonnel += store.monthlyPersonnel[month];
                                }
                                if (store.monthlyExpenses && store.monthlyExpenses[month]) {
                                    monthlyExpenses += store.monthlyExpenses[month];
                                }
                            });
                            
                            result.sales[month] = Math.round(monthlySales);
                            result.cogs[month] = Math.round(monthlyCogs);
                            result.personnel[month] = Math.round(monthlyPersonnel);
                            result.expenses[month] = Math.round(monthlyExpenses);
                        }
                    }
                    else if (department === 'w' && rawData.monthlySales) {
                        // Wäº‹æ¥­éƒ¨ï¼šæœˆæ¬¡å£²ä¸Šé…åˆ—
                        result.sales = rawData.monthlySales.map(s => Math.round(s || 0));
                        if (rawData.monthlyCogs) {
                            result.cogs = rawData.monthlyCogs.map(c => Math.round(c || 0));
                        }
                        if (rawData.monthlyPersonnel) {
                            result.personnel = rawData.monthlyPersonnel.map(p => Math.round(p || 0));
                        }
                        if (rawData.monthlyExpenses) {
                            result.expenses = rawData.monthlyExpenses.map(e => Math.round(e || 0));
                        }
                    }
                    else if (department === 'rc' && rawData.baseSales && rawData.variations) {
                        // RCå¸äº‹æ¥­éƒ¨ï¼šåŸºæº–å£²ä¸Š+å¢—æ¸›
                        const baseSales = Number(rawData.baseSales) || 0;
                        result.sales = rawData.variations.map(v => Math.round(baseSales + (v || 0)));
                        if (rawData.monthlyCogs) {
                            result.cogs = rawData.monthlyCogs.map(c => Math.round(c || 0));
                        }
                        if (rawData.monthlyPersonnel) {
                            result.personnel = rawData.monthlyPersonnel.map(p => Math.round(p || 0));
                        }
                        if (rawData.monthlyExpenses) {
                            result.expenses = rawData.monthlyExpenses.map(e => Math.round(e || 0));
                        }
                    }
                    else if (department === 'rcd' && rawData.purchases) {
                        // RCDç¤¾äº‹æ¥­éƒ¨ï¼šè³¼å…¥æœ¬æ•°Ã—å˜ä¾¡è¨ˆç®—
                        result.sales = rawData.purchases.map(p => Math.round((p || 0) * 2000 * 1.03));
                        if (rawData.monthlyCogs) {
                            result.cogs = rawData.monthlyCogs.map(c => Math.round(c || 0));
                        }
                        // RCDç¤¾ã¯å¤–éƒ¨å§”è¨—ã®ãŸã‚äººä»¶è²»0
                        result.personnel = new Array(12).fill(0);
                        if (rawData.monthlyExpenses) {
                            result.expenses = rawData.monthlyExpenses.map(e => Math.round(e || 0));
                        }
                    }
                    
                } catch (error) {
                    console.error(`${department}äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚¨ãƒ©ãƒ¼:`, error);
                }
                
                return result;
            },
            
            // å½¹å“¡å ±é…¬è¨ˆç®—ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰
            calculateExecutiveExpenses: function() {
                let baseSalary = 6755; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                let bonusAmount = 300; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                
                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®å½¹å“¡ãƒ‡ãƒ¼ã‚¿å–å¾—
                try {
                    const executiveData = localStorage.getItem('pl_system_executive_data');
                    if (executiveData) {
                        const parsed = JSON.parse(executiveData);
                        bonusAmount = parsed.bonusAmount || 300;
                        
                        // åŸºæœ¬6755ä¸‡å†† + èª¿æ•´é¡
                        const adjustment = parsed.adjustment || 0;
                        baseSalary = 6755 + adjustment;
                        
                        console.log(`ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰å½¹å“¡ãƒ‡ãƒ¼ã‚¿å–å¾—: åŸºæœ¬${baseSalary}ä¸‡å††/æœˆ, è³ä¸${bonusAmount}ä¸‡å††`);
                    }
                } catch (error) {
                    console.error('å½¹å“¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                }
                
                const months = ['jul', 'aug', 'sep', 'oct', 'nov', 'dec', 'jan', 'feb', 'mar', 'apr', 'may', 'jun'];
                const result = {};
                
                months.forEach((month, index) => {
                    let monthlySalary = baseSalary;
                    
                    // 7-9æœˆã¯+1500ä¸‡å††
                    if (index <= 2) {
                        monthlySalary += 1500;
                    }
                    
                    // 6æœˆã¯è³ä¸è¿½åŠ 
                    if (month === 'jun') {
                        monthlySalary += bonusAmount;
                    }
                    
                    result[month] = {
                        salary: monthlySalary,
                        welfare: Math.round(monthlySalary * 0.13002) // æ³•å®šç¦åˆ©è²»ç‡
                    };
                });
                
                // è¡¨ç¤ºéƒ¨åˆ†ã‚’æ›´æ–°
                document.getElementById('executive-salary-display').textContent = baseSalary.toLocaleString();
                document.getElementById('executive-bonus-display').textContent = bonusAmount.toLocaleString();
                
                return result;
            }
        };

        // UIç®¡ç†æ©Ÿèƒ½ - ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯¾è±¡
        const UI_MANAGER = {
            // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
            initComparisonChart: function() {
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                
            // å‰å¹´å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVã‹ã‚‰å–å¾—ã—ãŸæ­£ç¢ºãªå€¤ï¼‰
            previousYearData: {
                sales: [16107.9, 19359.2, 16632.2, 20379.5, 17474.7, 21761.5, 18857.2, 20138.0, 18949.1, 20456.7, 19917.8, 21426.0], // æœˆæ¬¡å£²ä¸Šï¼ˆä¸‡å††ï¼‰
                cogs: [12569.7, 15558.2, 12799.0, 16164.1, 13645.2, 16917.7, 15035.6, 16647.3, 15493.2, 16754.5, 16363.7, 17599.0], // æœˆæ¬¡ä»•å…¥ï¼ˆä¸‡å††ï¼‰  
                expenses: [4019.3, 4019.3, 4019.3, 4019.3, 4019.3, 4019.3, 4019.3, 4019.3, 4019.3, 4019.3, 4019.3, 4019.3], // æœˆæ¬¡è²©ç®¡è²»ï¼ˆä¸‡å††ï¼‰
                profit: [-481.1, 159.7, 4.0, 397.2, 320.5, 586.6, 301.1, -138.6, -75.9, 79.1, 64.4, -325.5] // æœˆæ¬¡å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰
            },
                
                this.comparisonChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'],
                        datasets: [
                            {
                                label: 'å‰æœŸå£²ä¸Šé«˜',
                                data: previousYearData.sales,
                                backgroundColor: 'rgba(52, 73, 94, 0.1)',
                                borderColor: '#34495e',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                yAxisID: 'y'
                            },
                            {
                                label: 'å½“æœŸå£²ä¸Šé«˜',
                                data: new Array(12).fill(0),
                                backgroundColor: 'rgba(52, 152, 219, 0.8)',
                                borderColor: '#3498db',
                                borderWidth: 3,
                                fill: false,
                                yAxisID: 'y'
                            },
                            {
                                label: 'å‰æœŸå–¶æ¥­åˆ©ç›Š',
                                data: previousYearData.profit,
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                borderColor: '#e74c3c',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                yAxisID: 'y1'
                            },
                            {
                                label: 'å½“æœŸå–¶æ¥­åˆ©ç›Š',
                                data: new Array(12).fill(0),
                                backgroundColor: 'rgba(39, 174, 96, 0.8)',
                                borderColor: '#27ae60',
                                borderWidth: 3,
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { font: { size: 11 }, padding: 12, usePointStyle: true }
                            }
                        },
                        scales: {
                            x: { ticks: { font: { size: 10 } } },
                            y: {
                                type: 'linear', display: true, position: 'left',
                                title: { display: true, text: 'å£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰', color: '#3498db', font: { size: 11, weight: 'bold' } },
                                ticks: { color: '#3498db', font: { size: 9 } },
                                grid: { drawOnChartArea: true }
                            },
                            y1: {
                                type: 'linear', display: true, position: 'right',
                                title: { display: true, text: 'å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰', color: '#27ae60', font: { size: 11, weight: 'bold' } },
                                ticks: { color: '#27ae60', font: { size: 9 } },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            },
            
            // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
            updateComparisonChart: function(salesData, profitData) {
                if (this.comparisonChart) {
                    this.comparisonChart.data.datasets[1].data = salesData;
                    this.comparisonChart.data.datasets[3].data = profitData;
                    this.comparisonChart.update();
                }
            },
            
            // PLãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
            updatePLTable: function(departmentData, executiveData) {
                const months = ['jul', 'aug', 'sep', 'oct', 'nov', 'dec', 'jan', 'feb', 'mar', 'apr', 'may', 'jun'];
                const departments = ['sr', 'w', 'rc', 'rcd'];
                
                let totalSalesYear = 0;
                let totalCogsYear = 0;
                let totalPersonnelYear = 0;
                let totalExpensesYear = 0;
                let salesData = [];
                let profitData = [];
                
                // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                months.forEach((month, monthIndex) => {
                    let monthlySalesTotal = 0;
                    let monthlyCogsTotal = 0;
                    let monthlyPersonnelTotal = 0;
                    
                    // å„äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿é›†è¨ˆï¼ˆè²©ç®¡è²»ã‚‚å‹•çš„ã«å–å¾—ï¼‰
                    departments.forEach(dept => {
                        const deptData = departmentData[dept] || CALCULATION_ENGINE.getEmptyDepartmentData();
                        
                        const sales = deptData.sales[monthIndex] || 0;
                        const cogs = deptData.cogs[monthIndex] || 0;
                        const personnel = deptData.personnel[monthIndex] || 0;
                        const expenses = deptData.expenses[monthIndex] || 0; // å„äº‹æ¥­éƒ¨ã®è²©ç®¡è²»
                        
                        // äº‹æ¥­éƒ¨åˆ¥å£²ä¸Šè¡¨ç¤º
                        const salesElement = document.getElementById(`${dept}-sales-${month}`);
                        if (salesElement) {
                            salesElement.textContent = sales.toLocaleString();
                        }
                        
                        monthlySalesTotal += sales;
                        monthlyCogsTotal += cogs;
                        monthlyPersonnelTotal += personnel;
                        monthlyExpensesTotal += expenses; // è²©ç®¡è²»ç´¯ç©
                    });
                    
                    // æœˆæ¬¡åˆè¨ˆå€¤è¡¨ç¤º
                    document.getElementById(`total-sales-${month}`).innerHTML = `<strong>${monthlySalesTotal.toLocaleString()}</strong>`;
                    document.getElementById(`cogs-${month}`).textContent = monthlyCogsTotal.toLocaleString();
                    document.getElementById(`personnel-${month}`).textContent = monthlyPersonnelTotal.toLocaleString();
                    
                    // å£²ä¸Šç·åˆ©ç›Š
                    const grossProfit = monthlySalesTotal - monthlyCogsTotal;
                    document.getElementById(`gross-profit-${month}`).innerHTML = `<strong>${grossProfit.toLocaleString()}</strong>`;
                    
                    // å½¹å“¡å ±é…¬ãƒ»æ³•å®šç¦åˆ©è²»
                    const execExpense = executiveData[month];
                    document.getElementById(`salary-${month}`).textContent = execExpense.salary.toLocaleString();
                    document.getElementById(`welfare-${month}`).textContent = execExpense.welfare.toLocaleString();
                    
                    // æœˆæ¬¡è²©ç®¡è²»åˆè¨ˆï¼ˆUIã‚½ãƒ¼ã‚¹ã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
                    const fixedExpenses = 25 + 180 + 420 + 200 + 85 + 150 + 120 + 180 + 95 + 45 + 35 + 95 + 90 + 65 + 75 + 110 + 240 + 140 + 65 + 85 + 120 + 80 + 30 + 15 + 45 + 25 + 55 + 15 + 75; // 2,537ä¸‡å††
                    const monthlyTotalExpenses = monthlyPersonnelTotal + execExpense.salary + execExpense.welfare + fixedExpenses;
                    document.getElementById(`total-expenses-${month}`).innerHTML = `<strong>${monthlyTotalExpenses.toLocaleString()}</strong>`;
                    
                    // å–¶æ¥­åˆ©ç›Š
                    const operatingProfit = grossProfit - monthlyTotalExpenses;
                    const profitElement = document.getElementById(`operating-profit-${month}`);
                    profitElement.innerHTML = `<strong>${operatingProfit.toLocaleString()}</strong>`;
                    profitElement.style.color = operatingProfit < 0 ? '#e74c3c' : '#27ae60';
                    
                    // å¹´é–“ç´¯ç©
                    totalSalesYear += monthlySalesTotal;
                    totalCogsYear += monthlyCogsTotal;
                    totalPersonnelYear += monthlyPersonnelTotal;
                    totalExpensesYear += monthlyTotalExpenses;
                    
                    // ãƒãƒ£ãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿
                    salesData.push(monthlySalesTotal);
                    profitData.push(operatingProfit);
                });
                
                // å¹´é–“åˆè¨ˆè¡¨ç¤º
                departments.forEach(dept => {
                    const deptData = departmentData[dept] || CALCULATION_ENGINE.getEmptyDepartmentData();
                    const annualSales = deptData.sales.reduce((sum, val) => sum + val, 0);
                    document.getElementById(`${dept}-sales-total`).textContent = annualSales.toLocaleString();
                });
                
                const totalGrossProfitYear = totalSalesYear - totalCogsYear;
                const totalOperatingProfitYear = totalGrossProfitYear - totalExpensesYear;
                
                document.getElementById('total-sales-year').innerHTML = `<strong>${totalSalesYear.toLocaleString()}</strong>`;
                document.getElementById('cogs-total').innerHTML = `<strong>${totalCogsYear.toLocaleString()}</strong>`;
                document.getElementById('gross-profit-year').innerHTML = `<strong>${totalGrossProfitYear.toLocaleString()}</strong>`;
                document.getElementById('personnel-total').textContent = totalPersonnelYear.toLocaleString();
                document.getElementById('salary-total').textContent = Object.values(executiveData).reduce((sum, exp) => sum + exp.salary, 0).toLocaleString();
                document.getElementById('welfare-total').textContent = Object.values(executiveData).reduce((sum, exp) => sum + exp.welfare, 0).toLocaleString();
                document.getElementById('total-expenses-year').innerHTML = `<strong>${totalExpensesYear.toLocaleString()}</strong>`;
                
                const operatingProfitElement = document.getElementById('operating-profit-year');
                operatingProfitElement.innerHTML = `<strong>${totalOperatingProfitYear.toLocaleString()}</strong>`;
                operatingProfitElement.style.color = totalOperatingProfitYear < 0 ? '#e74c3c' : '#27ae60';
                
                // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
                this.updateSummaryCards(totalSalesYear, totalOperatingProfitYear);
                
                // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
                this.updateComparisonChart(salesData, profitData);
                
                return {
                    totalSalesYear,
                    totalOperatingProfitYear,
                    profitMargin: totalSalesYear > 0 ? (totalOperatingProfitYear / totalSalesYear * 100) : 0
                };
            },
            
            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
            updateSummaryCards: function(totalSales, totalProfit) {
                const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100) : 0;
                
                document.getElementById('total-sales-summary').textContent = totalSales.toLocaleString();
                document.getElementById('total-profit-summary').textContent = totalProfit.toLocaleString();
                document.getElementById('profit-margin-summary').textContent = profitMargin.toFixed(1);
                
                // è‰²åˆ†ã‘
                const profitElement = document.getElementById('total-profit-summary');
                const marginElement = document.getElementById('profit-margin-summary');
                
                if (totalProfit > 0) {
                    profitElement.className = 'value positive';
                    marginElement.className = 'value positive';
                } else if (totalProfit < 0) {
                    profitElement.className = 'value negative';
                    marginElement.className = 'value negative';
                } else {
                    profitElement.className = 'value neutral';
                    marginElement.className = 'value neutral';
                }
            }
        };
        
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†é–¢æ•°
        function loadAllIntegratedData() {
            console.log('çµ±åˆã‚·ã‚¹ãƒ†ãƒ : ãƒ‡ãƒ¼ã‚¿çµ±åˆé–‹å§‹...');
            
            try {
                // å„äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿å–å¾—
                const rawData = CALCULATION_ENGINE.collectDepartmentData();
                
                // ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ»å¤‰æ›
                const departmentData = {};
                Object.keys(rawData).forEach(dept => {
                    departmentData[dept] = CALCULATION_ENGINE.extractFinancialData(rawData[dept], dept);
                });
                
                // å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿è¨ˆç®—
                const executiveData = CALCULATION_ENGINE.calculateExecutiveExpenses();
                
                // UIæ›´æ–°
                const results = UI_MANAGER.updatePLTable(departmentData, executiveData);
                
                // çµ±åˆãƒ‡ãƒ¼ã‚¿é€ä¿¡
                autoSendData();
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                DATA_TRANSMISSION.updateSendStatus('success', '4äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿çµ±åˆå®Œäº†');
                document.getElementById('last-update').textContent = new Date().toLocaleString();
                
                console.log('çµ±åˆã‚·ã‚¹ãƒ†ãƒ : ãƒ‡ãƒ¼ã‚¿çµ±åˆå®Œäº†', results);
                
            } catch (error) {
                console.error('çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:', error);
                DATA_TRANSMISSION.updateSendStatus('error', 'ãƒ‡ãƒ¼ã‚¿çµ±åˆã‚¨ãƒ©ãƒ¼');
            }
        }
        
        function exportIntegratedCSV() {
            // CSVå‡ºåŠ›æ©Ÿèƒ½å®Ÿè£…
            alert('CSVå‡ºåŠ›æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™ã€‚');
        }
        
        function loadTestData() {
            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆå¼•ç¶™ãæ›¸ã®æ¤œç®—ç”¨ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
            const testData = {
                sr: {
                    sales: [4636, 5317, 5326, 5210, 4944, 5063, 5407, 4725, 4804, 5003, 4628, 5122],
                    cogs: [1261, 1446, 1449, 1417, 1345, 1377, 1471, 1285, 1307, 1361, 1259, 1393],
                    personnel: [703, 850, 860, 979, 773, 924, 839, 772, 695, 747, 633, 826]
                },
                w: {
                    sales: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
                    cogs: [265, 150, 200, 352, 377, 698, 213, 231, 259, 247, 182, 277],
                    personnel: [354, 354, 354, 354, 354, 354, 354, 354, 354, 354, 354, 354]
                },
                rc: {
                    sales: [1550, 1550, 1550, 1550, 1550, 1550, 1550, 1550, 1550, 1550, 1550, 1550],
                    cogs: [546, 546, 546, 546, 546, 546, 546, 546, 546, 546, 546, 546],
                    personnel: [350, 350, 350, 350, 350, 350, 350, 350, 350, 350, 350, 350]
                },
                rcd: {
                    sales: [16480, 16480, 16480, 16480, 16480, 16480, 16480, 16480, 16480, 16480, 16480, 16480],
                    cogs: [16000, 16000, 16000, 16000, 16000, 16000, 16000, 16000, 16000, 16000, 16000, 16000],
                    personnel: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] // å¤–éƒ¨å§”è¨—ã®ãŸã‚0
                }
            };
            
            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’LocalStorageã«ä¿å­˜
            Object.keys(testData).forEach(dept => {
                localStorage.setItem(STORAGE_KEYS[dept], JSON.stringify(testData[dept]));
            });
            
            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Ÿè¡Œ
            loadAllIntegratedData();
            
            alert('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚æ¤œç®—ç”¨ãƒ‡ãƒ¼ã‚¿ã¨ç…§åˆã§ãã¾ã™ã€‚');
        }
        
        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
            
            UI_MANAGER.initComparisonChart();
            loadAllIntegratedData();
            
            console.log('4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        });
    </script>
    <!-- ===== ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºé ˜åŸŸçµ‚äº†ã€‘ ===== -->
