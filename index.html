<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4事業部統合PLシミュレーター（決算データ対応完全版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 8px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header-table {
            width: 100%;
            border-collapse: collapse;
            background: #667eea;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .header-table td {
            padding: 8px 12px;
            font-size: 0.85em;
            font-weight: 600;
            vertical-align: middle;
        }

        .header-left {
            text-align: left;
            width: 60%;
        }

        .header-right {
            text-align: right;
            width: 40%;
            font-size: 0.75em;
        }

        .nav-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.98);
        }

        .nav-table td {
            padding: 6px 8px;
            text-align: center;
            border-right: 1px solid #ddd;
        }

        .nav-table td:last-child {
            border-right: none;
        }

        .nav-btn, .action-btn {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.7em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover, .action-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: #4a5bc4;
        }

        .action-btn.reload { background: #e74c3c; }
        .action-btn.export { background: #27ae60; }
        .action-btn.toggle { background: #9b59b6; }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 10px;
            background: white;
        }

        .kpi-card {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .kpi-card.sales { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .kpi-card.profit-positive { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .kpi-card.profit-negative { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .kpi-card.growth-positive { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .kpi-card.growth-negative { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .kpi-card.target { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }

        .kpi-label {
            font-size: 0.65em;
            margin-bottom: 2px;
            opacity: 0.9;
        }

        .kpi-value {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 1px;
        }

        .kpi-detail {
            font-size: 0.55em;
            opacity: 0.8;
        }

        .data-warning {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 10px;
            font-size: 0.75em;
            display: block;
        }

        .chart-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .chart-title {
            font-size: 0.9em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 250px;
        }

        .individual-dept-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .section-title {
            font-size: 0.85em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
            border-left: 3px solid #667eea;
            padding-left: 6px;
        }

        .dept-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .dept-chart-container {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .dept-chart-title {
            font-size: 0.75em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .dept-chart-wrapper {
            position: relative;
            height: 120px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .dept-kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .dept-kpi-card {
            background: #f8f9fa;
            padding: 6px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .dept-kpi-card.integrated {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .dept-kpi-label {
            font-size: 0.6em;
            margin-bottom: 2px;
        }

        .dept-kpi-value {
            font-size: 0.8em;
            font-weight: 700;
        }

        .target-section {
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .target-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .target-toggle {
            padding: 4px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.7em;
            transition: all 0.3s ease;
        }

        .toggle-active {
            background: #27ae60;
            color: white;
        }

        .toggle-inactive {
            background: #bdc3c7;
            color: #7f8c8d;
        }

        .target-input input {
            padding: 3px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 80px;
            font-size: 0.75em;
        }

        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin: 10px;
            padding: 8px;
        }

        .debug-title {
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 6px;
            color: #495057;
        }

        .debug-content {
            font-family: 'Courier New', monospace;
            font-size: 0.65em;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .action-buttons {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            
            /* テーブルをモバイル用レイアウトに変更 */
            .individual-dept-section table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .individual-dept-section tr {
                display: flex;
                flex-direction: column;
                margin-bottom: 15px;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                overflow: hidden;
            }
            
            .individual-dept-section td {
                display: block;
                width: 100% !important;
                padding: 12px !important;
                border-bottom: 1px solid #eee !important;
            }
            
            .individual-dept-section td:last-child {
                border-bottom: none !important;
            }
            
            /* モバイルでKPI項目のフォントサイズを調整 */
            .individual-dept-section td div[style*="grid-template-columns"] {
                grid-template-columns: 1fr 1fr !important;
                font-size: 0.75em !important;
            }
        }
        
        @media (max-width: 480px) {
            .kpi-grid { 
                grid-template-columns: 1fr; 
                gap: 6px;
            }
            
            /* 超小画面ではKPIを1列に */
            .individual-dept-section td div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 6px !important;
            }
            
            .individual-dept-section td div[style*="grid-template-columns"] div {
                margin-bottom: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <table class="header-table">
            <tr>
                <td class="header-left">
                    最終営業利益 <span id="header-final-profit">891</span>万円（決算予測値・目標配分<span id="header-allocation-status">OFF</span>）
                </td>
                <td class="header-right">
                    4事業部統合PLシミュレーター 決算データ対応完全版
                </td>
            </tr>
        </table>

        <table class="nav-table">
            <tr>
                <td><button class="nav-btn active">ダッシュボード</button></td>
                <td><button class="nav-btn" onclick="location.href='budget-input.html'">予算入力</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/sr-pl.html'">SR事業部PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/w-pl.html'">W事業部PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/rc-pl.html'">RC卸事業部PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/rcd-pl.html'">RCD社事業部PL</button></td>
                <td><button class="nav-btn" onclick="location.href='combined-dashboard/index.html'">全体PL分析</button></td>
            </tr>
        </table>

        <div class="data-warning">
            <strong>決算データ基準値適用中:</strong> 
            年間売上231,459万円、最終営業利益891万円の決算予測データに基づいて表示しています。
        </div>

        <div class="chart-section">
            <div class="chart-title">月次営業利益推移（決算データ）</div>
            <div class="chart-wrapper">
                <canvas id="monthly-profit-chart"></canvas>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card sales">
                <div class="kpi-label">年間売上高</div>
                <div class="kpi-value" id="total-sales">231,459万円</div>
                <div class="kpi-detail">決算予測値</div>
            </div>
            <div class="kpi-card profit-positive" id="profit-card">
                <div class="kpi-label">最終営業利益</div>
                <div class="kpi-value" id="final-profit">891万円</div>
                <div class="kpi-detail">共通経費控除後</div>
            </div>
            <div class="kpi-card growth-positive" id="growth-card">
                <div class="kpi-label">前年比増額</div>
                <div class="kpi-value" id="growth-amount">+891万円</div>
                <div class="kpi-detail" id="growth-rate">伸び率: 計算中</div>
            </div>
            <div class="kpi-card target">
                <div class="kpi-label">目標達成率</div>
                <div class="kpi-value" id="target-achievement">---%</div>
                <div class="kpi-detail" id="target-status">目標配分OFF</div>
            </div>
        </div>

        <div class="individual-dept-section">
            <div class="section-title">Step2-3: 各事業部データ表示・分析（決算データ連動対応）</div>
            
            <!-- テーブル構造で視覚的セット感を最大化 -->
            <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <table style="width: 100%; border-collapse: collapse;">
                    <!-- SR事業部 -->
                    <tr>
                        <td style="width: 50%; padding: 15px; border-bottom: 1px solid #eee; vertical-align: top;">
                            <div style="font-size: 0.75em; font-weight: bold; color: #f39c12; margin-bottom: 8px;">SR事業部</div>
                            <div style="position: relative; height: 100px; background: #f8f9fa; border-radius: 4px;">
                                <canvas id="sr-monthly-chart"></canvas>
                            </div>
                        </td>
                        <td style="width: 50%; padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle;">
                            <div style="background: linear-gradient(135deg, #f39c12, #e67e22); padding: 12px; border-radius: 6px; color: white; height: 100px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: 100%; align-items: center; font-size: 0.7em;">
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">前年実績</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">-28,000万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">目標売上</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">30,000万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">事業部利益</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">-2,800万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">売上前年比</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">+7.1%</div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    
                    <!-- W事業部 -->
                    <tr>
                        <td style="width: 50%; padding: 15px; border-bottom: 1px solid #eee; vertical-align: top;">
                            <div style="font-size: 0.75em; font-weight: bold; color: #3498db; margin-bottom: 8px;">W事業部</div>
                            <div style="position: relative; height: 100px; background: #f8f9fa; border-radius: 4px;">
                                <canvas id="w-monthly-chart"></canvas>
                            </div>
                        </td>
                        <td style="width: 50%; padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle;">
                            <div style="background: linear-gradient(135deg, #3498db, #2980b9); padding: 12px; border-radius: 6px; color: white; height: 100px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: 100%; align-items: center; font-size: 0.7em;">
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">前年実績</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">21,000万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">目標売上</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">14,500万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">事業部利益</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">2,100万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">売上前年比</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">-31.0%</div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    
                    <!-- RC卸事業部 -->
                    <tr>
                        <td style="width: 50%; padding: 15px; border-bottom: 1px solid #eee; vertical-align: top;">
                            <div style="font-size: 0.75em; font-weight: bold; color: #27ae60; margin-bottom: 8px;">RC卸事業部</div>
                            <div style="position: relative; height: 100px; background: #f8f9fa; border-radius: 4px;">
                                <canvas id="rc-monthly-chart"></canvas>
                            </div>
                        </td>
                        <td style="width: 50%; padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle;">
                            <div style="background: linear-gradient(135deg, #27ae60, #229954); padding: 12px; border-radius: 6px; color: white; height: 100px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: 100%; align-items: center; font-size: 0.7em;">
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">前年実績</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">18,000万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">目標売上</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">19,200万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">事業部利益</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">1,400万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">売上前年比</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">+6.7%</div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    
                    <!-- RCD社事業部 -->
                    <tr>
                        <td style="width: 50%; padding: 15px; vertical-align: top;">
                            <div style="font-size: 0.75em; font-weight: bold; color: #9b59b6; margin-bottom: 8px;">RCD社事業部</div>
                            <div style="position: relative; height: 100px; background: #f8f9fa; border-radius: 4px;">
                                <canvas id="rcd-monthly-chart"></canvas>
                            </div>
                        </td>
                        <td style="width: 50%; padding: 15px; vertical-align: middle;">
                            <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); padding: 12px; border-radius: 6px; color: white; height: 100px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; height: 100%; align-items: center; font-size: 0.7em;">
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">前年実績</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">180,000万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">目標売上</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">195,000万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">事業部利益</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">1,000万円</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="opacity: 0.9; margin-bottom: 2px; font-size: 0.9em;">売上前年比</div>
                                        <div style="font-weight: bold; font-size: 1.2em;">+8.3%</div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="target-section">
            <div class="section-title">目標配分機能（損失圧縮ロジック）</div>
            
            <div class="target-controls">
                <button id="allocation-toggle-btn" class="target-toggle toggle-inactive" onclick="toggleTargetAllocation()">
                    目標配分OFF
                </button>
                <div class="target-input">
                    <label style="font-size: 0.7em;">年間目標:</label>
                    <input type="number" id="total-target" value="6000" step="100" onchange="updateTargetAllocation()">
                    <span style="font-size: 0.7em;">万円</span>
                </div>
            </div>

            <div id="allocation-results" style="display: none;">
                <div style="background: #fff3cd; padding: 6px; border-radius: 4px; font-size: 0.65em;">
                    <strong>配分ロジック:</strong>
                    決算データ基準により赤字事業部の改善策を効率配分。制約：売上増20%上限、実現可能性重視
                </div>
            </div>
        </div>

        <div class="debug-section">
            <div class="debug-title">決算データ基準デバッグ: リアルタイム処理状況</div>
            <div class="debug-content" id="debug-output">
                決算データ読み込み完了...
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn reload" onclick="refreshDashboardData()">全データ更新</button>
            <button class="action-btn export" onclick="exportDebugData()">決算データ出力</button>
            <button class="action-btn toggle" onclick="toggleDebugMode()">デバッグ表示切替</button>
            <button class="action-btn" style="background: #1abc9c;" onclick="loadIntegrationData()">統合PL連携確認</button>
            <button class="action-btn" style="background: #e67e22;" onclick="checkDecisionData()">決算データ確認</button>
        </div>
    </div>

    <script>
        // 決算データ（万円単位、少数切り捨て）
        const DECISION_DATA = {
            "A": {
                "name": "売上高 計",
                "monthlyData": [16107, 19359, 16632, 20379, 17474, 21761, 18857, 20138, 18949, 20456, 19917, 21425],
                "annualTotal": 231459
            },
            "B": {
                "name": "仕入高 計",
                "monthlyData": [12569, 15558, 12798, 16164, 13645, 16917, 15035, 16647, 15493, 16754, 16363, 17598],
                "annualTotal": 185547
            },
            "C": {
                "name": "売上総損益",
                "monthlyData": [3538, 3800, 3833, 4215, 3829, 4843, 3821, 3490, 3455, 3702, 3554, 3827],
                "annualTotal": 45912
            },
            "D": {
                "name": "販売管理費 計",
                "monthlyData": [4019, 3641, 3829, 3818, 3509, 4257, 3520, 3629, 3531, 3623, 3489, 4152],
                "annualTotal": 45021
            },
            "E": {
                "name": "営業利益",
                "monthlyData": [-482, 159, 3, 397, 320, 586, 301, -139, -76, 79, 64, -326],
                "annualTotal": 891
            }
        };

        // 前年データ（比較用・推定値）
        const PREVIOUS_YEAR_DATA = {
            annualSales: 220000, // 前年売上推定
            annualProfit: 0,     // 前年営業利益推定（赤字）
            monthlyProfit: [-500, -480, -450, -400, -350, -300, -250, -200, -150, -100, -50, 0]
        };

        // LocalStorageキー管理
        const STORAGE_KEYS = {
            sr: 'pl_system_sr_data',
            w: 'pl_system_w_data',
            rc: 'pl_system_rc_data',
            rcd: 'pl_system_rcd_data',
            executive: 'pl_system_executive_data',
            dashboard_integration: 'dashboard_integration_data'
        };

        // チャート管理クラス
        const ChartManager = {
            charts: {},

            // 月次営業利益チャート初期化
            initializeMainChart: function() {
                const ctx = document.getElementById('monthly-profit-chart');
                if (!ctx) return;

                if (this.charts.main) {
                    this.charts.main.destroy();
                }

                const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];

                this.charts.main = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: '当期営業利益（決算データ）',
                                data: DECISION_DATA.E.monthlyData,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: '前年営業利益（推定）',
                                data: PREVIOUS_YEAR_DATA.monthlyProfit,
                                borderColor: '#95a5a6',
                                backgroundColor: 'rgba(149, 165, 166, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                borderDash: [5, 5]
                            },
                            {
                                label: '売上高',
                                data: DECISION_DATA.A.monthlyData,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.05)',
                                borderWidth: 1,
                                fill: false,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { font: { size: 10 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '万円';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '営業利益（万円）'
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '売上高（万円）'
                                },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });

                console.log('メインチャート初期化完了（決算データ基準）');
            },

            // 個別事業部チャート初期化
            initializeDepartmentCharts: function() {
                const departments = [
                    { id: 'sr', name: 'SR事業部', color: '#f39c12', height: 100 }, // 薄いオレンジ系に変更
                    { id: 'w', name: 'W事業部', color: '#3498db', height: 100 },
                    { id: 'rc', name: 'RC卸事業部', color: '#27ae60', height: 100 },
                    { id: 'rcd', name: 'RCD社事業部', color: '#9b59b6', height: 100 }
                ];

                departments.forEach(dept => {
                    const ctx = document.getElementById(`${dept.id}-monthly-chart`);
                    if (!ctx) return;

                    if (this.charts[dept.id]) {
                        this.charts[dept.id].destroy();
                    }

                    // 事業部別のサンプルデータ（統合PLシステムから取得予定）
                    const sampleData = this.getDepartmentSampleData(dept.id);

                    this.charts[dept.id] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['7', '8', '9', '10', '11', '12', '1', '2', '3', '4', '5', '6'],
                            datasets: [
                                {
                                    label: '前年実績',
                                    data: sampleData.previous,
                                    backgroundColor: 'rgba(149, 165, 166, 0.6)',
                                    borderColor: '#95a5a6',
                                    borderWidth: 1
                                },
                                {
                                    label: '当期実績',
                                    data: sampleData.current,
                                    backgroundColor: `${dept.color}80`,
                                    borderColor: dept.color,
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '万円';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: dept.id === 'sr' ? false : true, // SR事業部はマイナス値対応
                                    grid: { display: false },
                                    ticks: { 
                                        font: { size: 7 },
                                        maxTicksLimit: 3
                                    }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 7 } }
                                }
                            }
                        }
                    });
                });

                console.log('事業部チャート初期化完了');
            },

            // 事業部別サンプルデータ取得
            getDepartmentSampleData: function(deptId) {
                const sampleData = {
                    sr: {
                        previous: [-240, -230, -235, -232, -234, -233, -233, -234, -233, -233, -235, -234],
                        current: [-250, -240, -245, -242, -244, -243, -243, -244, -243, -243, -245, -244]
                    },
                    w: {
                        previous: [170, 175, 173, 176, 175, 177, 175, 174, 176, 176, 174, 179],
                        current: [180, 185, 183, 186, 185, 187, 185, 184, 186, 186, 184, 189]
                    },
                    rc: {
                        previous: [115, 118, 116, 117, 117, 118, 117, 116, 117, 117, 116, 118],
                        current: [125, 128, 126, 127, 127, 128, 127, 126, 127, 127, 126, 128]
                    },
                    rcd: {
                        previous: [80, 85, 83, 84, 84, 85, 83, 82, 84, 84, 82, 84],
                        current: [85, 90, 88, 89, 89, 90, 88, 87, 89, 89, 87, 89]
                    }
                };
                return sampleData[deptId] || { previous: Array(12).fill(0), current: Array(12).fill(0) };
            }
        };

        // KPI更新管理
        const KPIManager = {
            // 基本KPI更新
            updateBasicKPIs: function() {
                // 売上高
                document.getElementById('total-sales').textContent = DECISION_DATA.A.annualTotal.toLocaleString() + '万円';
                
                // 最終営業利益
                const finalProfit = DECISION_DATA.E.annualTotal;
                document.getElementById('final-profit').textContent = finalProfit.toLocaleString() + '万円';
                document.getElementById('header-final-profit').textContent = finalProfit.toLocaleString();
                
                // 利益カードの色設定
                const profitCard = document.getElementById('profit-card');
                if (finalProfit >= 0) {
                    profitCard.className = 'kpi-card profit-positive';
                } else {
                    profitCard.className = 'kpi-card profit-negative';
                }

                // 前年比増額・伸び率計算
                this.updateGrowthKPIs(finalProfit);

                console.log('基本KPI更新完了');
            },

            // 成長率KPI更新
            updateGrowthKPIs: function(currentProfit) {
                const previousProfit = PREVIOUS_YEAR_DATA.annualProfit;
                const growthAmount = currentProfit - previousProfit;
                const growthRate = previousProfit !== 0 ? ((growthAmount / Math.abs(previousProfit)) * 100) : 0;

                document.getElementById('growth-amount').textContent = 
                    (growthAmount >= 0 ? '+' : '') + growthAmount.toLocaleString() + '万円';
                
                document.getElementById('growth-rate').textContent = 
                    '伸び率: ' + (growthRate >= 0 ? '+' : '') + growthRate.toFixed(1) + '%';

                // 成長カードの色設定
                const growthCard = document.getElementById('growth-card');
                if (growthAmount >= 0) {
                    growthCard.className = 'kpi-card growth-positive';
                } else {
                    growthCard.className = 'kpi-card growth-negative';
                }
            }
        };

        // 統合PL連携管理（簡略版）
        const IntegrationManager = {
            loadIntegrationData: function() {
                try {
                    const integrationData = localStorage.getItem(STORAGE_KEYS.dashboard_integration);
                    if (integrationData) {
                        const data = JSON.parse(integrationData);
                        console.log('統合PLデータ取得成功:', data);
                        return data;
                    } else {
                        console.log('統合PLデータなし、決算データを使用');
                        return null;
                    }
                } catch (error) {
                    console.error('統合PL連携エラー:', error);
                    return null;
                }
            }
        };

        // 目標配分機能
        let targetAllocationEnabled = false;

        function toggleTargetAllocation() {
            targetAllocationEnabled = !targetAllocationEnabled;
            const btn = document.getElementById('allocation-toggle-btn');
            const results = document.getElementById('allocation-results');
            
            if (targetAllocationEnabled) {
                btn.textContent = '目標配分ON';
                btn.className = 'target-toggle toggle-active';
                results.style.display = 'block';
                updateTargetAllocation();
            } else {
                btn.textContent = '目標配分OFF';
                btn.className = 'target-toggle toggle-inactive';
                results.style.display = 'none';
            }
            
            // メインとサイドバーの目標配分ステータス更新
            document.getElementById('header-allocation-status').textContent = targetAllocationEnabled ? 'ON' : 'OFF';
            document.getElementById('target-status').textContent = targetAllocationEnabled ? '目標配分ON' : '目標配分OFF';
            document.getElementById('sidebar-target-status').textContent = targetAllocationEnabled ? '目標配分ON' : '目標配分OFF';
        }

        function updateTargetAllocation() {
            if (!targetAllocationEnabled) return;
            
            const totalTarget = parseInt(document.getElementById('total-target').value) || 6000;
            const currentProfit = DECISION_DATA.E.annualTotal;
            const achievementRate = currentProfit > 0 ? ((currentProfit / totalTarget) * 100) : 0;
            
            // メインとサイドバー両方の目標達成率を更新
            const achievementText = achievementRate.toFixed(1) + '%';
            document.getElementById('target-achievement').textContent = achievementText;
            document.getElementById('sidebar-target-achievement').textContent = achievementText;
        }

        // ボタン機能
        function refreshDashboardData() {
            try {
                KPIManager.updateBasicKPIs();
                ChartManager.initializeMainChart();
                ChartManager.initializeDepartmentCharts();
                updateDebugInfo();
                alert('決算データを基に全データを更新しました。');
            } catch (error) {
                console.error('データ更新エラー:', error);
                alert('データ更新中にエラーが発生しました: ' + error.message);
            }
        }

        function exportDebugData() {
            try {
                const debugData = {
                    timestamp: new Date().toISOString(),
                    decisionData: DECISION_DATA,
                    previousYearData: PREVIOUS_YEAR_DATA,
                    currentKPIs: {
                        sales: DECISION_DATA.A.annualTotal,
                        profit: DECISION_DATA.E.annualTotal
                    }
                };
                
                const blob = new Blob([JSON.stringify(debugData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `decision_data_debug_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('決算データをダウンロードしました。');
            } catch (error) {
                console.error('データ出力エラー:', error);
                alert('データ出力中にエラーが発生しました: ' + error.message);
            }
        }

        function toggleDebugMode() {
            const debugSection = document.querySelector('.debug-section');
            if (debugSection) {
                debugSection.style.display = debugSection.style.display === 'none' ? 'block' : 'none';
            }
        }

        function loadIntegrationData() {
            const data = IntegrationManager.loadIntegrationData();
            if (data) {
                alert(`統合PL連携データ取得\n売上: ${data.summary?.totalSales || '---'}万円\n利益: ${data.summary?.totalProfit || '---'}万円\n\n決算データ（基準値）\n売上: ${DECISION_DATA.A.annualTotal.toLocaleString()}万円\n利益: ${DECISION_DATA.E.annualTotal.toLocaleString()}万円`);
            } else {
                alert('統合PLデータなし。決算データ基準値を使用中。\n\n決算予測値\n売上: ' + DECISION_DATA.A.annualTotal.toLocaleString() + '万円\n営業利益: ' + DECISION_DATA.E.annualTotal.toLocaleString() + '万円');
            }
        }

        function checkDecisionData() {
            alert(`決算データ確認\n\n年間売上: ${DECISION_DATA.A.annualTotal.toLocaleString()}万円\n年間営業利益: ${DECISION_DATA.E.annualTotal.toLocaleString()}万円\n\n月次営業利益:\n7月: ${DECISION_DATA.E.monthlyData[0]}万円\n8月: ${DECISION_DATA.E.monthlyData[1]}万円\n9月: ${DECISION_DATA.E.monthlyData[2]}万円\n10月: ${DECISION_DATA.E.monthlyData[3]}万円\n11月: ${DECISION_DATA.E.monthlyData[4]}万円\n12月: ${DECISION_DATA.E.monthlyData[5]}万円\n\n※この数値は決算予測の基準値です`);
        }

        function updateDebugInfo() {
            const debugElement = document.getElementById('debug-output');
            if (debugElement) {
                const timestamp = new Date().toLocaleString();
                debugElement.innerHTML = `
                    <div><strong>決算データ基準処理結果 (${timestamp})</strong></div>
                    <div>年間売上: ${DECISION_DATA.A.annualTotal.toLocaleString()}万円</div>
                    <div>年間営業利益: ${DECISION_DATA.E.annualTotal.toLocaleString()}万円</div>
                    <div>前年比増額: +${DECISION_DATA.E.annualTotal.toLocaleString()}万円</div>
                    <div>月次赤字月数: ${DECISION_DATA.E.monthlyData.filter(v => v < 0).length}ヶ月</div>
                    <div>統合PL連携: 手動更新対応</div>
                    <div>チャート表示: 決算データ基準</div>
                `;
            }
        }

        // 初期化処理
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('決算データ対応ダッシュボード初期化開始');
                
                // KPI更新
                setTimeout(() => {
                    KPIManager.updateBasicKPIs();
                }, 100);
                
                // チャート初期化
                setTimeout(() => {
                    ChartManager.initializeMainChart();
                    ChartManager.initializeDepartmentCharts();
                }, 300);
                
                // デバッグ情報更新
                setTimeout(() => {
                    updateDebugInfo();
                }, 500);
                
                console.log('決算データ対応完全版 初期化完了');
            } catch (error) {
                console.error('初期化エラー:', error);
            }
        });
    </script>
</body>
</html>
