<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4事業部統合PLシミュレーター</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 8px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header-table {
            width: 100%;
            border-collapse: collapse;
            background: #667eea;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .header-table td {
            padding: 8px 12px;
            font-size: 0.85em;
            font-weight: 600;
            vertical-align: middle;
        }

        .header-left {
            text-align: left;
            width: 60%;
        }

        .header-right {
            text-align: right;
            width: 40%;
            font-size: 0.75em;
        }

        .nav-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.98);
        }

        .nav-table td {
            padding: 6px 8px;
            text-align: center;
            border-right: 1px solid #ddd;
        }

        .nav-table td:last-child {
            border-right: none;
        }

        .nav-btn, .action-btn {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.7em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover, .action-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: #4a5bc4;
        }

        .action-btn.reload { background: #e74c3c; }
        .action-btn.export { background: #27ae60; }
        .action-btn.toggle { background: #9b59b6; }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 10px;
            background: white;
        }

        .kpi-card {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .kpi-card.dept { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .kpi-card.common { background: linear-gradient(135deg, #34495e, #2c3e50); color: white; }
        .kpi-card.final-positive { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .kpi-card.final-negative { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .kpi-card.target { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .kpi-card.data-sync { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .kpi-card.data-sync.complete { background: linear-gradient(135deg, #27ae60, #229954); }
        .kpi-card.data-sync.partial { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .kpi-card.data-sync.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .kpi-label {
            font-size: 0.65em;
            margin-bottom: 2px;
            opacity: 0.9;
        }

        .kpi-value {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 1px;
        }

        .kpi-detail {
            font-size: 0.55em;
            opacity: 0.8;
        }

        .data-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 10px;
            font-size: 0.75em;
            display: none;
        }

        .individual-dept-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .section-title {
            font-size: 0.85em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
            border-left: 3px solid #667eea;
            padding-left: 6px;
        }

        .dept-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .dept-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .dept-card.loaded {
            border-left: 4px solid #27ae60;
        }

        .dept-card.no-data {
            border-left: 4px solid #e74c3c;
            background: #f8f9fa;
        }

        .dept-card.error {
            border-left: 4px solid #fd7e14;
            background: #fff5f0;
        }

        .dept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .dept-name {
            font-size: 0.75em;
            font-weight: bold;
            color: #2c3e50;
        }

        .dept-status {
            font-size: 0.6em;
            padding: 2px 6px;
            border-radius: 10px;
            color: white;
        }

        .status-loaded { background: #27ae60; }
        .status-no-data { background: #e74c3c; }
        .status-error { background: #fd7e14; }

        .dept-metrics {
            font-size: 0.65em;
            color: #666;
        }

        .dept-profit {
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 4px;
        }

        .profit-positive { color: #27ae60; }
        .profit-negative { color: #e74c3c; }

        .comparison-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .comparison-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
        }

        .comparison-header {
            font-size: 0.7em;
            font-weight: bold;
            margin-bottom: 6px;
            color: #495057;
        }

        .comparison-metrics {
            font-size: 0.6em;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
        }

        .metric-item {
            text-align: center;
            padding: 4px;
            background: white;
            border-radius: 3px;
        }

        .metric-label {
            display: block;
            font-size: 0.9em;
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .neutral { color: #6c757d; }

        .chart-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .chart-title {
            font-size: 0.9em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 220px;
        }

        .target-section {
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .target-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .target-toggle {
            padding: 4px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.7em;
            transition: all 0.3s ease;
        }

        .toggle-active {
            background: #27ae60;
            color: white;
        }

        .toggle-inactive {
            background: #bdc3c7;
            color: #7f8c8d;
        }

        .target-input input {
            padding: 3px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 80px;
            font-size: 0.75em;
        }

        .micro-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65em;
            margin-bottom: 8px;
        }

        .micro-table th,
        .micro-table td {
            padding: 2px 4px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .micro-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
            font-size: 0.6em;
        }

        .micro-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin: 10px;
            padding: 8px;
        }

        .debug-title {
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 6px;
            color: #495057;
        }

        .debug-content {
            font-family: 'Courier New', monospace;
            font-size: 0.65em;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .action-buttons {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .dept-grid { grid-template-columns: 1fr; }
            .comparison-grid { grid-template-columns: 1fr; }
            
            /* Step2-3モバイル対応 */
            .individual-dept-section > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
            
            .individual-dept-section .dept-grid {
                grid-template-columns: 1fr;
            }
            
            /* モバイル時のグラフ高さ調整 */
            .individual-dept-section canvas {
                height: 100px !important;
            }
            
            /* モバイル時の全体パフォーマンス指標を2列維持 */
            .individual-dept-section div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr 1fr !important;
                gap: 4px;
            }
            
            /* KPIカードのフォントサイズ微調整 */
            .individual-dept-section .dept-card {
                font-size: 0.9em;
            }
        }
        
        @media (max-width: 480px) {
            .kpi-grid { 
                grid-template-columns: 1fr; 
                gap: 6px;
            }
            
            /* 極小画面での追加調整 */
            .individual-dept-section canvas {
                height: 80px !important;
            }
            
            .individual-dept-section > div[style*="grid-template-columns"] {
                gap: 8px;
            }
            
            /* 全体パフォーマンス指標を1列に */
            .individual-dept-section div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 3px;
            }
            
            /* フォントサイズをさらに調整 */
            .section-title {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <table class="header-table">
            <tr>
                <td class="header-left">
                    最終営業利益 <span id="header-final-profit">---</span>万円（共通経費控除後・目標配分<span id="header-allocation-status">OFF</span>）
                </td>
                <td class="header-right">
                    4事業部統合PLシミュレーター Step1-4完全版（目標配分復旧）
                </td>
            </tr>
        </table>

        <table class="nav-table">
            <tr>
                <td><button class="nav-btn active">ダッシュボード</button></td>
                <td><button class="nav-btn" onclick="location.href='budget-input.html'">予算入力</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/sr-pl.html'">SR事業部PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/w-pl.html'">W事業部PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/rc-pl.html'">RC卸事業部PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/rcd-pl.html'">RCD社事業部PL</button></td>
                <td><button class="nav-btn" onclick="location.href='combined-dashboard/index.html'">全体PL分析</button></td>
            </tr>
        </table>

        <div class="data-warning" id="data-warning"></div>

        <div class="chart-section">
            <div class="chart-title">月次利益推移（動的データ対応）</div>
            <div class="chart-wrapper">
                <canvas id="monthly-profit-chart"></canvas>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card dept">
                <div class="kpi-label">事業部営業利益</div>
                <div class="kpi-value" id="dept-total-profit">---万円</div>
                <div class="kpi-detail">4事業部合計</div>
            </div>
            <div class="kpi-card common">
                <div class="kpi-label">年間共通経費</div>
                <div class="kpi-value" id="common-expenses-total">-10,342万円</div>
                <div class="kpi-detail">役員報酬・諸経費</div>
            </div>
            <div class="kpi-card final-positive" id="final-card">
                <div class="kpi-label">最終営業利益</div>
                <div class="kpi-value" id="final-profit">---万円</div>
                <div class="kpi-detail">共通経費控除後</div>
            </div>
            <div class="kpi-card target">
                <div class="kpi-label">目標達成率</div>
                <div class="kpi-value" id="target-achievement">---%</div>
                <div class="kpi-detail" id="target-status">目標配分OFF</div>
            </div>
            <div class="kpi-card data-sync" id="data-sync-card">
                <div class="kpi-label">データ取得状況</div>
                <div class="kpi-value" id="data-sync-status">0/4部門</div>
                <div class="kpi-detail" id="last-sync-time">最終更新: --:--</div>
            </div>
        </div>

        <div class="individual-dept-section">
            <div class="section-title">Step2-3: 各事業部個別データ表示・分析</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <!-- 左側：主要3事業部月次グラフ -->
                <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6;">
                    <div style="font-size: 0.75em; font-weight: 700; margin-bottom: 8px; color: #2c3e50;">主要3事業部 月次推移（前年実績 vs 設定予算）</div>
                    
                    <!-- SR事業部グラフ -->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 0.7em; font-weight: bold; color: #e74c3c; margin-bottom: 4px;">SR事業部</div>
                        <div style="position: relative; height: 120px; background: #f8f9fa; border-radius: 4px;">
                            <canvas id="sr-monthly-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- W事業部グラフ -->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 0.7em; font-weight: bold; color: #3498db; margin-bottom: 4px;">W事業部</div>
                        <div style="position: relative; height: 120px; background: #f8f9fa; border-radius: 4px;">
                            <canvas id="w-monthly-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- RC卸事業部グラフ -->
                    <div style="margin-bottom: 8px;">
                        <div style="font-size: 0.7em; font-weight: bold; color: #27ae60; margin-bottom: 4px;">RC卸事業部</div>
                        <div style="position: relative; height: 120px; background: #f8f9fa; border-radius: 4px;">
                            <canvas id="rc-monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- 右側：KPI指標まとめ＋RCD社グラフ -->
                <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6;">
                    <div style="font-size: 0.75em; font-weight: 700; margin-bottom: 8px; color: #2c3e50;">KPI指標サマリー</div>
                    
                    <div class="dept-grid" id="department-kpi-grid">
                        <!-- 動的生成されるKPI指標カード -->
                    </div>
                    
                    <!-- 全体パフォーマンス指標 -->
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 12px;">
                        <div style="font-size: 0.7em; font-weight: bold; margin-bottom: 4px; color: #495057;">全体パフォーマンス</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 0.6em;">
                            <div style="background: white; padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: #666;">データ取得率</div>
                                <div id="overall-data-rate" style="font-weight: bold; color: #3498db;">--%</div>
                            </div>
                            <div style="background: white; padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: #666;">平均利益率</div>
                                <div id="overall-profit-margin" style="font-weight: bold; color: #27ae60;">--%</div>
                            </div>
                            <div style="background: white; padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: #666;">前年比成長</div>
                                <div id="overall-growth-rate" style="font-weight: bold; color: #9b59b6;">--%</div>
                            </div>
                            <div style="background: white; padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: #666;">黒字部門数</div>
                                <div id="profitable-dept-count" style="font-weight: bold; color: #e74c3c;">-/-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RCD社グラフ（補助） -->
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; border: 1px solid #e0e0e0;">
                        <div style="font-size: 0.65em; font-weight: bold; color: #9b59b6; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between;">
                            <span>RCD社事業部（計画受注）</span>
                            <span style="font-size: 0.9em; background: #9b59b6; color: white; padding: 1px 4px; border-radius: 6px;">補助</span>
                        </div>
                        <div style="position: relative; height: 80px; background: white; border-radius: 4px;">
                            <canvas id="rcd-monthly-chart"></canvas>
                        </div>
                        <div style="font-size: 0.55em; color: #666; margin-top: 2px; text-align: center;">
                            ※計画受注のため予算変動は少なめ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="target-section">
            <div class="section-title">目標配分機能（損失圧縮ロジック）</div>
            
            <div class="target-controls">
                <button id="allocation-toggle-btn" class="target-toggle toggle-inactive" onclick="toggleTargetAllocation()">
                    目標配分OFF
                </button>
                <div class="target-input">
                    <label style="font-size: 0.7em;">年間目標:</label>
                    <input type="number" id="total-target" value="6000" step="100" onchange="updateTargetAllocation()">
                    <span style="font-size: 0.7em;">万円</span>
                </div>
            </div>

            <div id="allocation-results" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <table class="micro-table">
                            <thead>
                                <tr>
                                    <th>事業部</th>
                                    <th>戦略</th>
                                    <th>現在利益</th>
                                    <th>目標利益</th>
                                    <th>改善額</th>
                                    <th>売上増率</th>
                                    <th>現実性</th>
                                </tr>
                            </thead>
                            <tbody id="allocation-table">
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <div style="font-size: 0.7em; font-weight: 600; margin-bottom: 8px; text-align: center; color: #2c3e50;">利益比較チャート</div>
                        <div style="position: relative; height: 200px;">
                            <canvas id="profit-comparison-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 6px; border-radius: 4px; font-size: 0.65em; margin-top: 6px;">
                    <strong>配分ロジック:</strong>
                    赤字事業部（SR）:月+100万固定 | 黒字事業部（W・RC卸）:効率配分 | RCD社:計画受注により除外 | 制約:売上増20%上限
                </div>
            </div>
        </div>

        <div class="debug-section">
            <div class="debug-title">Step1-4デバッグ情報: 統合動的データ処理状況</div>
            <div class="debug-content" id="debug-output">
                読み込み中...
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn reload" onclick="refreshDashboardData()">全データ更新</button>
            <button class="action-btn export" onclick="exportDebugData()">デバッグ情報出力</button>
            <button class="action-btn toggle" onclick="toggleDebugMode()">デバッグ表示切替</button>
        </div>
    </div>

    <script>
        // ===== 【保護領域開始】絶対に変更禁止 =====
        // LocalStorageキー管理 - 統合システム用
        const STORAGE_KEYS = {
            sr: 'pl_system_sr_data',
            w: 'pl_system_w_data',
            rc: 'pl_system_rc_data',
            rcd: 'pl_system_rcd_data',
            executive: 'pl_system_executive_data'
        };
        // ===== 【保護領域終了】 =====

        // Step1実装: 動的データ取得機能
        const DynamicDataManager = {
            loadDepartmentDataFromStorage: function() {
                const departmentData = {};
                const debugInfo = [];
                
                Object.entries(STORAGE_KEYS).forEach(([dept, storageKey]) => {
                    if (dept === 'executive') return;
                    
                    try {
                        const storedData = localStorage.getItem(storageKey);
                        debugInfo.push(`[${dept}] キー: ${storageKey}`);
                        
                        if (storedData) {
                            const parsedData = JSON.parse(storedData);
                            departmentData[dept] = {
                                name: this.getDepartmentName(dept),
                                rawData: parsedData,
                                monthlyProfit: this.extractMonthlyProfit(parsedData),
                                monthlyRevenue: this.extractMonthlyRevenue(parsedData),
                                annualProfit: this.calculateAnnualProfit(parsedData),
                                annualRevenue: this.calculateAnnualRevenue(parsedData),
                                lastUpdated: parsedData.timestamp || parsedData.lastUpdate,
                                dataStatus: 'loaded',
                                dataSize: JSON.stringify(parsedData).length,
                                profitMargin: this.calculateProfitMargin(parsedData)
                            };
                            debugInfo.push(`[${dept}] ✓ データ読み込み成功 (${departmentData[dept].dataSize}文字)`);
                            debugInfo.push(`[${dept}] 年間利益: ${departmentData[dept].annualProfit}万円`);
                        } else {
                            departmentData[dept] = {
                                name: this.getDepartmentName(dept),
                                dataStatus: 'no_data'
                            };
                            debugInfo.push(`[${dept}] ✗ データなし`);
                        }
                    } catch (error) {
                        console.error(`${dept}データ読み込みエラー:`, error);
                        departmentData[dept] = {
                            name: this.getDepartmentName(dept),
                            dataStatus: 'error',
                            errorMessage: error.message
                        };
                        debugInfo.push(`[${dept}] ✗ エラー: ${error.message}`);
                    }
                });
                
                this.updateDebugOutput(debugInfo);
                return departmentData;
            },

            getDepartmentName: function(deptKey) {
                const nameMap = {
                    'sr': 'SR事業部',
                    'w': 'W事業部',
                    'rc': 'RC卸事業部',
                    'rcd': 'RCD社事業部'
                };
                return nameMap[deptKey] || deptKey;
            },

            extractMonthlyProfit: function(data) {
                const monthlyProfit = {};
                const monthNames = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
                
                if (data.monthlyProfit) {
                    return data.monthlyProfit;
                }
                
                if (data.monthlyData) {
                    monthNames.forEach(month => {
                        if (data.monthlyData[month] && data.monthlyData[month].profit !== undefined) {
                            monthlyProfit[month] = data.monthlyData[month].profit;
                        }
                    });
                }
                
                return monthlyProfit;
            },

            extractMonthlyRevenue: function(data) {
                const monthlyRevenue = {};
                const monthNames = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
                
                if (data.monthlyRevenue) {
                    return data.monthlyRevenue;
                }
                
                if (data.monthlyData) {
                    monthNames.forEach(month => {
                        if (data.monthlyData[month] && data.monthlyData[month].revenue !== undefined) {
                            monthlyRevenue[month] = data.monthlyData[month].revenue;
                        }
                    });
                }
                
                return monthlyRevenue;
            },

            calculateAnnualProfit: function(data) {
                if (data.annualProfit !== undefined) {
                    return data.annualProfit;
                }
                
                const monthlyProfit = this.extractMonthlyProfit(data);
                return Object.values(monthlyProfit).reduce((sum, val) => sum + (val || 0), 0);
            },

            calculateAnnualRevenue: function(data) {
                if (data.annualRevenue !== undefined) {
                    return data.annualRevenue;
                }
                
                const monthlyRevenue = this.extractMonthlyRevenue(data);
                return Object.values(monthlyRevenue).reduce((sum, val) => sum + (val || 0), 0);
            },

            calculateProfitMargin: function(data) {
                const profit = this.calculateAnnualProfit(data);
                const revenue = this.calculateAnnualRevenue(data);
                
                return revenue > 0 ? ((profit / revenue) * 100) : 0;
            },

            updateDebugOutput: function(debugInfo) {
                const debugElement = document.getElementById('debug-output');
                if (debugElement) {
                    debugElement.innerHTML = `
                        <div><strong>Step1-4統合処理結果 (${new Date().toLocaleString()})</strong></div>
                        <div>LocalStorage確認結果:</div>
                        ${debugInfo.map(info => `<div style="margin-left: 10px;">${info}</div>`).join('')}
                        <div style="margin-top: 8px;"><strong>処理完了機能:</strong></div>
                        <div style="margin-left: 10px;">✓ Step1: 動的データ取得</div>
                        <div style="margin-left: 10px;">✓ Step2: データステータス表示</div>
                        <div style="margin-left: 10px;">✓ Step3: 事業部月次グラフ＋KPI表示</div>
                        <div style="margin-left: 10px;">✓ 目標配分機能復旧</div>
                        <div style="margin-left: 10px;">✓ 月次利益推移グラフ</div>
                    `;
                }
            }
        };

        // Step2実装: データ同期ステータス管理
        const DataSyncManager = {
            updateDataSyncStatus: function() {
                const departmentData = DynamicDataManager.loadDepartmentDataFromStorage();
                let loadedCount = 0;
                let totalCount = 0;
                let latestUpdate = null;
                const statusDetails = [];

                Object.entries(departmentData).forEach(([dept, data]) => {
                    totalCount++;
                    if (data.dataStatus === 'loaded') {
                        loadedCount++;
                        statusDetails.push(`${data.name}: ✓`);
                        
                        if (data.lastUpdated) {
                            const updateTime = new Date(data.lastUpdated);
                            if (!latestUpdate || updateTime > new Date(latestUpdate)) {
                                latestUpdate = data.lastUpdated;
                            }
                        }
                    } else {
                        statusDetails.push(`${data.name}: ${data.dataStatus === 'no_data' ? '未取得' : 'エラー'}`);
                    }
                });

                // UI更新
                this.updateElement('data-sync-status', `${loadedCount}/${totalCount}部門`);
                this.updateElement('last-sync-time', latestUpdate ? 
                    `最終更新: ${new Date(latestUpdate).toLocaleString()}` : 
                    '最終更新: 未取得');

                // ステータスカードの状態変更
                const statusCard = document.getElementById('data-sync-card');
                if (statusCard) {
                    statusCard.className = `kpi-card data-sync ${
                        loadedCount === totalCount ? 'complete' : 
                        loadedCount > 0 ? 'partial' : 'error'
                    }`;
                }

                // 警告表示管理
                this.manageDataWarning(loadedCount, totalCount, statusDetails);
                
                return { loadedCount, totalCount, departmentData };
            },

            manageDataWarning: function(loadedCount, totalCount, statusDetails) {
                const warningDiv = document.getElementById('data-warning');
                
                if (loadedCount < totalCount) {
                    const missingCount = totalCount - loadedCount;
                    warningDiv.innerHTML = `
                        <strong>⚠️ データ不完全:</strong> 
                        ${missingCount}部門のデータが未取得です。各事業部PLページでデータ送信を確認してください。<br>
                        <div style="margin-top: 4px; font-size: 0.9em;">
                            ${statusDetails.join(' | ')}
                        </div>
                    `;
                    warningDiv.style.display = 'block';
                } else {
                    warningDiv.innerHTML = `
                        <strong>✅ データ完了:</strong> 
                        全事業部のデータが正常に取得されています。Step1-4機能が完全動作中。
                    `;
                    warningDiv.style.display = 'block';
                    warningDiv.style.background = '#d4edda';
                    warningDiv.style.borderColor = '#c3e6cb';
                    warningDiv.style.color = '#155724';
                    
                    setTimeout(() => {
                        warningDiv.style.display = 'none';
                    }, 3000);
                }
            },

            updateElement: function(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                }
            }
        };

        // Step3改良版: 個別事業部データ表示（グラフ＋KPI）
        const IndividualDepartmentDisplay = {
            departmentCharts: {},

            displayDepartmentCards: function(departmentData) {
                // KPI指標カード表示
                this.displayKPICards(departmentData);
                // 月次グラフ初期化・更新
                this.initializeDepartmentCharts();
                this.updateDepartmentCharts(departmentData);
                // 全体パフォーマンス更新
                this.updateOverallPerformance(departmentData);
            },

            displayKPICards: function(departmentData) {
                const gridElement = document.getElementById('department-kpi-grid');
                if (!gridElement) return;

                gridElement.innerHTML = '';
                
                Object.entries(departmentData).forEach(([dept, data]) => {
                    const card = this.createKPICard(dept, data);
                    gridElement.appendChild(card);
                });
            },

            createKPICard: function(dept, data) {
                const card = document.createElement('div');
                card.className = `dept-card ${data.dataStatus}`;
                card.style.cssText = 'background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 6px; margin-bottom: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';
                
                if (data.dataStatus === 'loaded') {
                    const profitClass = data.annualProfit >= 0 ? 'profit-positive' : 'profit-negative';
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                            <div style="font-size: 0.7em; font-weight: bold; color: #2c3e50;">${data.name}</div>
                            <div style="font-size: 0.55em; padding: 1px 4px; border-radius: 8px; background: #27ae60; color: white;">取得済</div>
                        </div>
                        <div style="font-size: 0.6em; color: #666; margin-bottom: 2px;">
                            年間売上: ${data.annualRevenue ? data.annualRevenue.toLocaleString() : '---'}万円
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.6em;">
                            <span>利益率: ${data.profitMargin ? data.profitMargin.toFixed(1) : '--'}%</span>
                            <span class="${profitClass}" style="font-weight: bold;">
                                ${data.annualProfit ? data.annualProfit.toLocaleString() : '---'}万円
                            </span>
                        </div>
                    `;
                } else if (data.dataStatus === 'no_data') {
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                            <div style="font-size: 0.7em; font-weight: bold; color: #2c3e50;">${data.name}</div>
                            <div style="font-size: 0.55em; padding: 1px 4px; border-radius: 8px; background: #e74c3c; color: white;">未取得</div>
                        </div>
                        <div style="font-size: 0.6em; color: #666;">
                            PLページでデータ送信が必要
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                            <div style="font-size: 0.7em; font-weight: bold; color: #2c3e50;">${data.name}</div>
                            <div style="font-size: 0.55em; padding: 1px 4px; border-radius: 8px; background: #fd7e14; color: white;">エラー</div>
                        </div>
                        <div style="font-size: 0.6em; color: #666;">
                            ${data.errorMessage || '不明なエラー'}
                        </div>
                    `;
                }
                
                return card;
            },

            initializeDepartmentCharts: function() {
                const departments = [
                    { id: 'sr', name: 'SR事業部', color: '#e74c3c', height: 120 },
                    { id: 'w', name: 'W事業部', color: '#3498db', height: 120 },
                    { id: 'rc', name: 'RC卸事業部', color: '#27ae60', height: 120 },
                    { id: 'rcd', name: 'RCD社事業部', color: '#9b59b6', height: 80 }
                ];

                departments.forEach(dept => {
                    const ctx = document.getElementById(`${dept.id}-monthly-chart`);
                    if (!ctx || this.departmentCharts[dept.id]) return;

                    // RCD社は補助グラフとして簡素化
                    const isRcd = dept.id === 'rcd';
                    
                    this.departmentCharts[dept.id] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: isRcd ? ['7', '8', '9', '10', '11', '12', '1', '2', '3', '4', '5', '6'] : ['7', '8', '9', '10', '11', '12', '1', '2', '3', '4', '5', '6'],
                            datasets: [
                                {
                                    label: '前年実績',
                                    data: this.getPreviousYearData(dept.id),
                                    backgroundColor: isRcd ? 'rgba(149, 165, 166, 0.4)' : 'rgba(149, 165, 166, 0.6)',
                                    borderColor: '#95a5a6',
                                    borderWidth: isRcd ? 0.5 : 1
                                },
                                {
                                    label: isRcd ? '計画予算' : '設定予算',
                                    data: Array(12).fill(0),
                                    backgroundColor: isRcd ? `${dept.color}60` : `${dept.color}80`,
                                    borderColor: dept.color,
                                    borderWidth: isRcd ? 0.5 : 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: isRcd ? false : false  // 全グラフで非表示に統一
                                },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label + '月';
                                        },
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + '万円';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    display: true,
                                    grid: { display: false },
                                    ticks: { 
                                        font: { size: isRcd ? 7 : 8 },
                                        maxTicksLimit: isRcd ? 2 : 3,
                                        callback: function(value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                },
                                x: {
                                    display: true,
                                    grid: { display: false },
                                    ticks: { font: { size: isRcd ? 7 : 8 } }
                                }
                            }
                        }
                    });
                });
            },

            getPreviousYearData: function(deptId) {
                const previousData = {
                    sr: [-240, -230, -235, -232, -234, -233, -233, -234, -233, -233, -235, -234],
                    w: [170, 175, 173, 176, 175, 177, 175, 174, 176, 176, 174, 179],
                    rc: [115, 118, 116, 117, 117, 118, 117, 116, 117, 117, 116, 118],
                    rcd: [80, 85, 83, 84, 84, 85, 83, 82, 84, 84, 82, 84]
                };
                return previousData[deptId] || Array(12).fill(0);
            },

            updateDepartmentCharts: function(departmentData) {
                Object.entries(departmentData).forEach(([dept, data]) => {
                    const chart = this.departmentCharts[dept];
                    if (!chart || data.dataStatus !== 'loaded') return;

                    const monthlyData = this.extractMonthlyData(data);
                    chart.data.datasets[1].data = monthlyData;
                    chart.update('none');
                });
            },

            extractMonthlyData: function(data) {
                const monthNames = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
                return monthNames.map(month => {
                    if (data.monthlyProfit && data.monthlyProfit[month] !== undefined) {
                        return data.monthlyProfit[month];
                    }
                    return 0;
                });
            },

            updateOverallPerformance: function(departmentData) {
                let loadedCount = 0;
                let totalCount = 0;
                let totalProfitMargin = 0;
                let profitableCount = 0;
                let totalGrowth = 0;
                let validGrowthCount = 0;

                Object.entries(departmentData).forEach(([dept, data]) => {
                    totalCount++;
                    if (data.dataStatus === 'loaded') {
                        loadedCount++;
                        if (data.profitMargin) {
                            totalProfitMargin += data.profitMargin;
                        }
                        if (data.annualProfit >= 0) {
                            profitableCount++;
                        }
                        
                        // 前年対比成長率計算
                        const prevData = YearOverYearAnalysis.previousYearData[dept.toUpperCase()];
                        if (prevData && data.annualRevenue) {
                            const growth = ((data.annualRevenue - prevData.revenue) / prevData.revenue) * 100;
                            totalGrowth += growth;
                            validGrowthCount++;
                        }
                    }
                });

                const dataRate = totalCount > 0 ? (loadedCount / totalCount) * 100 : 0;
                const avgProfitMargin = loadedCount > 0 ? totalProfitMargin / loadedCount : 0;
                const avgGrowth = validGrowthCount > 0 ? totalGrowth / validGrowthCount : 0;

                DataSyncManager.updateElement('overall-data-rate', `${dataRate.toFixed(0)}%`);
                DataSyncManager.updateElement('overall-profit-margin', `${avgProfitMargin.toFixed(1)}%`);
                DataSyncManager.updateElement('overall-growth-rate', `${avgGrowth >= 0 ? '+' : ''}${avgGrowth.toFixed(1)}%`);
                DataSyncManager.updateElement('profitable-dept-count', `${profitableCount}/${totalCount}`);
            }
        };

        // Step4実装: 前年対比分析（動的データ版）
        const YearOverYearAnalysis = {
            // 前年実績データ（引継ぎ書より）
            previousYearData: {
                SR: { revenue: 30000, profit: -2800 },
                W: { revenue: 14500, profit: 2100 },
                RC: { revenue: 19200, profit: 1400 },
                RCD: { revenue: 195000, profit: 1000 }
            },

            analyzeYearOverYear: function(currentData) {
                const analysisResults = {};
                const improvingDepts = [];
                const decliningDepts = [];
                let totalCurrentRevenue = 0, totalPrevRevenue = 0;
                
                Object.entries(currentData).forEach(([dept, current]) => {
                    if (current.dataStatus !== 'loaded') return;
                    
                    const deptKey = dept.toUpperCase();
                    const prev = this.previousYearData[deptKey];
                    
                    if (!prev) return;
                    
                    const revenueDiff = current.annualRevenue - prev.revenue;
                    const profitDiff = current.annualProfit - prev.profit;
                    const revenueGrowthRate = (revenueDiff / prev.revenue) * 100;
                    const profitGrowthRate = prev.profit !== 0 ? (profitDiff / Math.abs(prev.profit)) * 100 : 0;
                    
                    analysisResults[dept] = {
                        name: current.name,
                        current: {
                            revenue: current.annualRevenue,
                            profit: current.annualProfit
                        },
                        previous: {
                            revenue: prev.revenue,
                            profit: prev.profit
                        },
                        difference: {
                            revenue: revenueDiff,
                            profit: profitDiff
                        },
                        growth: {
                            revenue: revenueGrowthRate,
                            profit: profitGrowthRate
                        }
                    };
                    
                    totalCurrentRevenue += current.annualRevenue;
                    totalPrevRevenue += prev.revenue;
                    
                    // 改善・悪化の判定
                    if (profitDiff > 0) {
                        improvingDepts.push(`${current.name.replace('事業部', '')}(+${profitGrowthRate.toFixed(1)}%)`);
                    } else if (profitDiff < 0) {
                        decliningDepts.push(`${current.name.replace('事業部', '')}(-${Math.abs(profitGrowthRate).toFixed(1)}%)`);
                    }
                });
                
                const overallRevenueGrowth = ((totalCurrentRevenue - totalPrevRevenue) / totalPrevRevenue) * 100;
                
                return {
                    departments: analysisResults,
                    overall: {
                        revenueGrowth: overallRevenueGrowth,
                        improving: improvingDepts,
                        declining: decliningDepts
                    }
                };
            },

            displayComparison: function(analysisData) {
                const gridElement = document.getElementById('comparison-grid');
                if (!gridElement) return;

                gridElement.innerHTML = '';
                
                Object.entries(analysisData.departments).forEach(([dept, data]) => {
                    const card = this.createComparisonCard(data);
                    gridElement.appendChild(card);
                });
                
                // サマリー更新
                this.updateAnalysisSummary(analysisData.overall);
            },

            createComparisonCard: function(data) {
                const card = document.createElement('div');
                card.className = 'comparison-card';
                
                const revenueClass = data.difference.revenue >= 0 ? 'positive' : 'negative';
                const profitClass = data.difference.profit >= 0 ? 'positive' : 'negative';
                
                card.innerHTML = `
                    <div class="comparison-header">${data.name} - 前年対比</div>
                    <div class="comparison-metrics">
                        <div class="metric-item">
                            <span class="metric-label">前年売上</span>
                            <div class="metric-value">${data.previous.revenue.toLocaleString()}</div>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">今年売上</span>
                            <div class="metric-value">${data.current.revenue.toLocaleString()}</div>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">売上増減</span>
                            <div class="metric-value ${revenueClass}">
                                ${data.difference.revenue >= 0 ? '+' : ''}${data.difference.revenue.toLocaleString()}
                                <br><span style="font-size: 0.8em;">(${data.growth.revenue.toFixed(1)}%)</span>
                            </div>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">前年利益</span>
                            <div class="metric-value">${data.previous.profit.toLocaleString()}</div>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">今年利益</span>
                            <div class="metric-value">${data.current.profit.toLocaleString()}</div>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">利益増減</span>
                            <div class="metric-value ${profitClass}">
                                ${data.difference.profit >= 0 ? '+' : ''}${data.difference.profit.toLocaleString()}
                                <br><span style="font-size: 0.8em;">(${data.growth.profit.toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>
                `;
                
                return card;
            },

            updateAnalysisSummary: function(overallData) {
                const summaryElement = document.getElementById('analysis-summary');
                if (!summaryElement) return;
                
                const summaryText = `
                    <span style="color: #27ae60;">改善事業部</span>: ${overallData.improving.join(', ')} | 
                    <span style="color: #e74c3c;">要改善</span>: ${overallData.declining.join(', ')} | 
                    <span style="color: #3498db;">全体売上伸長</span>: ${overallData.revenueGrowth >= 0 ? '+' : ''}${overallData.revenueGrowth.toFixed(2)}%
                `;
                
                summaryElement.innerHTML = summaryText;
            }
        };

        // 目標配分機能（完全復旧）
        const targetAllocation = {
            isEnabled: false,
            totalTarget: 6000
        };

        let profitComparisonChart = null;

        function calculateTargetAllocation(totalTarget, departmentData) {
            const result = {};
            
            const departmentSettings = {
                sr: { profitMargin: 0.02, strategicImportance: 0.8, allocatable: true },
                w: { profitMargin: 0.15, strategicImportance: 0.9, allocatable: true },
                rc: { profitMargin: 0.08, strategicImportance: 0.7, allocatable: true },
                rcd: { profitMargin: 0.005, strategicImportance: 0.6, allocatable: false }
            };

            let remainingTarget = totalTarget;
            const blackProfitDepartments = [];

            // データがない場合は仮想データを使用
            const virtualDepartmentData = {
                sr: { name: 'SR事業部', annualProfit: -3054, dataStatus: 'loaded' },
                w: { name: 'W事業部', annualProfit: 2370, dataStatus: 'loaded' },
                rc: { name: 'RC卸事業部', annualProfit: 1510, dataStatus: 'loaded' },
                rcd: { name: 'RCD社事業部', annualProfit: 1115, dataStatus: 'loaded' }
            };

            const dataToUse = Object.keys(departmentData).length > 0 ? departmentData : virtualDepartmentData;

            Object.entries(dataToUse).forEach(([deptId, data]) => {
                if (data.dataStatus !== 'loaded') return;
                
                const settings = departmentSettings[deptId];
                if (!settings) return;

                if (!settings.allocatable) {
                    result[deptId] = {
                        name: data.name,
                        currentProfit: data.annualProfit,
                        targetProfit: data.annualProfit,
                        strategyType: '対象外',
                        improvementEffect: 0,
                        salesIncreaseRate: '-',
                        feasibility: 'excluded',
                        allocationType: 'excluded'
                    };
                    return;
                }

                const currentProfit = data.annualProfit;
                
                if (currentProfit < 0) {
                    const fixedAnnualImprovement = 1200;
                    
                    result[deptId] = {
                        name: data.name,
                        currentProfit: currentProfit,
                        targetProfit: currentProfit + fixedAnnualImprovement,
                        strategyType: '赤字改善',
                        improvementEffect: fixedAnnualImprovement,
                        salesIncreaseRate: '固定',
                        feasibility: 'fixed_improvement',
                        allocationType: 'red_deficit'
                    };
                    
                    remainingTarget -= fixedAnnualImprovement;
                } else {
                    blackProfitDepartments.push([deptId, data, settings]);
                }
            });

            if (blackProfitDepartments.length > 0 && remainingTarget > 0) {
                const totalEfficiencyScore = blackProfitDepartments.reduce((sum, [_, __, settings]) => 
                    sum + (settings.profitMargin * settings.strategicImportance), 0);
                
                blackProfitDepartments.forEach(([deptId, data, settings]) => {
                    const currentProfit = data.annualProfit;
                    const efficiencyScore = settings.profitMargin * settings.strategicImportance;
                    const allocation = Math.max(0, (efficiencyScore / totalEfficiencyScore) * remainingTarget);
                    
                    const estimatedSales = currentProfit / settings.profitMargin;
                    const requiredSalesIncrease = allocation / settings.profitMargin;
                    const salesIncreaseRate = estimatedSales > 0 ? (requiredSalesIncrease / estimatedSales) * 100 : 0;
                    
                    result[deptId] = {
                        name: data.name,
                        currentProfit: currentProfit,
                        targetProfit: Math.round(currentProfit + allocation),
                        strategyType: '効率成長',
                        improvementEffect: Math.round(allocation),
                        salesIncreaseRate: salesIncreaseRate.toFixed(1) + '%',
                        feasibility: salesIncreaseRate <= 20 ? 'realistic' : 'challenging',
                        allocationType: 'efficiency_based'
                    };
                });
            }
            
            return result;
        }

        function toggleTargetAllocation() {
            targetAllocation.isEnabled = !targetAllocation.isEnabled;
            
            const toggleBtn = document.getElementById('allocation-toggle-btn');
            const allocationResults = document.getElementById('allocation-results');
            
            if (targetAllocation.isEnabled) {
                toggleBtn.textContent = '目標配分ON';
                toggleBtn.className = 'target-toggle toggle-active';
                allocationResults.style.display = 'block';
                DataSyncManager.updateElement('header-allocation-status', 'ON');
                updateTargetAllocation();
            } else {
                toggleBtn.textContent = '目標配分OFF';
                toggleBtn.className = 'target-toggle toggle-inactive';
                allocationResults.style.display = 'none';
                DataSyncManager.updateElement('target-achievement', '---%');
                DataSyncManager.updateElement('target-status', '目標配分OFF');
                DataSyncManager.updateElement('header-allocation-status', 'OFF');
            }
        }

        function updateTargetAllocation() {
            if (!targetAllocation.isEnabled) return;

            const totalTargetInput = document.getElementById('total-target');
            targetAllocation.totalTarget = parseInt(totalTargetInput.value) || 6000;

            const { departmentData } = DataSyncManager.updateDataSyncStatus();
            const allocationData = calculateTargetAllocation(targetAllocation.totalTarget, departmentData);
            updateAllocationTable(allocationData);
            updateProfitComparisonChart(allocationData);

            // 目標達成率計算
            let finalProfit = 0;
            Object.entries(departmentData).forEach(([dept, data]) => {
                if (data.dataStatus === 'loaded') {
                    finalProfit += data.annualProfit;
                }
            });
            finalProfit -= calculateCommonExpensesTotal();
            
            const achievementRate = (finalProfit / targetAllocation.totalTarget) * 100;
            DataSyncManager.updateElement('target-achievement', `${achievementRate.toFixed(1)}%`);
            DataSyncManager.updateElement('target-status', '目標配分ON');
        }

        function updateAllocationTable(allocationData) {
            const tableBody = document.getElementById('allocation-table');
            if (!tableBody) return;

            tableBody.innerHTML = '';
            
            Object.entries(allocationData).forEach(([deptId, data]) => {
                const row = document.createElement('tr');
                
                let feasibilityColor, feasibilityText;
                switch(data.feasibility) {
                    case 'fixed_improvement':
                        feasibilityColor = '#f39c12';
                        feasibilityText = '固定改善';
                        break;
                    case 'realistic':
                        feasibilityColor = '#27ae60';
                        feasibilityText = '現実的';
                        break;
                    case 'challenging':
                        feasibilityColor = '#e74c3c';
                        feasibilityText = '要検討';
                        break;
                    case 'excluded':
                        feasibilityColor = '#95a5a6';
                        feasibilityText = '対象外';
                        break;
                    default:
                        feasibilityColor = '#3498db';
                        feasibilityText = data.feasibility;
                }
                
                row.innerHTML = `
                    <td style="font-weight: bold; font-size: 0.6em;">${data.name}</td>
                    <td><span style="padding: 1px 4px; border-radius: 6px; font-size: 0.55em; ${
                        data.allocationType === 'red_deficit' ? 'background: #ffe0e0; color: #c62828;' :
                        data.allocationType === 'efficiency_based' ? 'background: #e0f2e0; color: #2e7d32;' :
                        'background: #f0f0f0; color: #616161;'
                    }">${data.strategyType}</span></td>
                    <td class="${data.currentProfit >= 0 ? 'positive' : 'negative'}">
                        ${data.currentProfit.toLocaleString()}
                    </td>
                    <td class="${data.targetProfit >= 0 ? 'positive' : 'negative'}">
                        ${data.targetProfit.toLocaleString()}
                    </td>
                    <td class="positive">
                        +${data.improvementEffect.toLocaleString()}
                    </td>
                    <td style="color: ${
                        data.salesIncreaseRate.includes('%') && parseFloat(data.salesIncreaseRate) > 20 ? '#e74c3c' : 
                        data.salesIncreaseRate.includes('%') ? '#27ae60' : '#95a5a6'
                    };">
                        ${data.salesIncreaseRate}
                    </td>
                    <td style="color: ${feasibilityColor}; font-weight: bold; font-size: 0.6em;">
                        ${feasibilityText}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function initializeProfitComparisonChart() {
            const ctx = document.getElementById('profit-comparison-chart');
            if (!ctx) return;

            profitComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '現在利益',
                            data: [],
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        },
                        {
                            label: '目標利益',
                            data: [],
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: '#2ecc71',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 10 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { 
                                font: { size: 9 },
                                callback: function(value) {
                                    return value + '万円';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 9 } }
                        }
                    }
                }
            });
        }

        function updateProfitComparisonChart(allocationData) {
            if (!profitComparisonChart) {
                initializeProfitComparisonChart();
            }
            
            const labels = [];
            const currentProfits = [];
            const targetProfits = [];

            // 部門順序を固定してW事業部を確実に表示
            const departmentOrder = ['sr', 'w', 'rc', 'rcd'];
            
            departmentOrder.forEach(deptId => {
                if (allocationData[deptId]) {
                    const data = allocationData[deptId];
                    labels.push(data.name.replace('事業部', ''));
                    currentProfits.push(data.currentProfit);
                    targetProfits.push(data.targetProfit);
                }
            });

            // データがない場合のフォールバック
            if (labels.length === 0) {
                const fallbackData = {
                    sr: { name: 'SR', currentProfit: -3054, targetProfit: -1854 },
                    w: { name: 'W', currentProfit: 2370, targetProfit: 4607 },
                    rc: { name: 'RC卸', currentProfit: 1510, targetProfit: 1333 },
                    rcd: { name: 'RCD社', currentProfit: 1115, targetProfit: 1115 }
                };
                
                Object.values(fallbackData).forEach(data => {
                    labels.push(data.name);
                    currentProfits.push(data.currentProfit);
                    targetProfits.push(data.targetProfit);
                });
            }

            profitComparisonChart.data.labels = labels;
            profitComparisonChart.data.datasets[0].data = currentProfits;
            profitComparisonChart.data.datasets[1].data = targetProfits;
            profitComparisonChart.update();
        }

        // 共通経費計算（既存ロジック維持）
        const commonExpensesData = {
            executiveSalary: {
                monthlyData: {
                    '7月': 826, '8月': 826, '9月': 826, '10月': 676, '11月': 676, '12月': 676,
                    '1月': 676, '2月': 676, '3月': 676, '4月': 676, '5月': 676, '6月': 676
                }
            },
            otherExpenses: {
                '7月': 59, '8月': -5, '9月': 46, '10月': 37, '11月': 30, '12月': 62,
                '1月': 58, '2月': 48, '3月': 110, '4月': 60, '5月': 102, '6月': 61
            },
            welfareRate: 0.13002
        };

        let executiveAdjustment = 0;
        let executiveBonusAmount = 300;
        let monthlyChart = null;

        // Step1-4統合メイン関数
        function executeStep1to4Pipeline() {
            console.log('Step1-4統合処理開始');
            
            // Step1-2: データ取得・ステータス更新
            const syncResult = DataSyncManager.updateDataSyncStatus();
            const { loadedCount, totalCount, departmentData } = syncResult;
            
            // Step3: 個別事業部表示（改良版）
            IndividualDepartmentDisplay.displayDepartmentCards(departmentData);
            
            // KPI計算・更新
            let departmentTotalProfit = 0;
            let validDataCount = 0;
            
            Object.entries(departmentData).forEach(([dept, data]) => {
                if (data.dataStatus === 'loaded' && data.annualProfit !== undefined) {
                    departmentTotalProfit += data.annualProfit;
                    validDataCount++;
                }
            });

            const commonExpensesTotal = calculateCommonExpensesTotal();
            const finalProfit = departmentTotalProfit - commonExpensesTotal;

            // UI更新
            DataSyncManager.updateElement('dept-total-profit', `${departmentTotalProfit.toLocaleString()}万円`);
            DataSyncManager.updateElement('final-profit', `${finalProfit.toLocaleString()}万円`);
            DataSyncManager.updateElement('header-final-profit', finalProfit.toLocaleString());
            DataSyncManager.updateElement('common-expenses-total', `-${commonExpensesTotal.toLocaleString()}万円`);

            // 最終利益カードの色変更
            const finalCard = document.getElementById('final-card');
            if (finalCard) {
                finalCard.className = 'kpi-card ' + (finalProfit >= 0 ? 'final-positive' : 'final-negative');
            }

            // 目標配分が有効な場合は更新
            if (targetAllocation.isEnabled) {
                updateTargetAllocation();
            }

            // チャート更新
            updateDynamicChart(departmentData);

            console.log(`Step1-4処理完了: 部門利益=${departmentTotalProfit}, 最終利益=${finalProfit}, 有効データ数=${validDataCount}`);
            
            return { departmentTotalProfit, finalProfit, validDataCount };
        }

        function calculateCommonExpensesTotal() {
            const monthNames = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
            let total = 0;

            monthNames.forEach(month => {
                const executiveSalary = commonExpensesData.executiveSalary.monthlyData[month] + executiveAdjustment;
                let totalExecutiveSalary = executiveSalary;
                if (month === '6月') {
                    totalExecutiveSalary += executiveBonusAmount;
                }
                const legalWelfare = Math.round(totalExecutiveSalary * commonExpensesData.welfareRate);
                const otherExpenses = commonExpensesData.otherExpenses[month];
                total += (totalExecutiveSalary + legalWelfare + otherExpenses);
            });

            return total;
        }

        // 動的チャート更新
        function updateDynamicChart(departmentData) {
            if (!monthlyChart) return;
            
            const monthNames = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
            const departmentProfits = monthNames.map(month => {
                let total = 0;
                Object.entries(departmentData).forEach(([dept, data]) => {
                    if (data.dataStatus === 'loaded' && data.monthlyProfit && data.monthlyProfit[month]) {
                        total += data.monthlyProfit[month];
                    }
                });
                return total;
            });
            
            // チャート更新
            monthlyChart.data.datasets[0].data = departmentProfits;
            monthlyChart.data.datasets[0].label = '事業部利益合計（実データ）';
            monthlyChart.data.datasets[0].backgroundColor = 'rgba(52, 152, 219, 0.7)';
            monthlyChart.update();
        }

        // 初期化とイベントリスナー
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Step1-4統合ダッシュボード初期化開始');
            executeStep1to4Pipeline();
            initializeDynamicChart();
            initializeProfitComparisonChart();
        });

        function initializeDynamicChart() {
            const ctx = document.getElementById('monthly-profit-chart');
            if (!ctx) return;

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'],
                    datasets: [{
                        label: '動的データ読み込み中',
                        data: Array(12).fill(0),
                        backgroundColor: 'rgba(108, 117, 125, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: { font: { size: 10 } }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                font: { size: 9 },
                                callback: function(value) {
                                    return value.toLocaleString() + '万円';
                                }
                            }
                        }
                    }
                }
            });
        }

        // データ更新関数
        function refreshDashboardData() {
            console.log('Step1-4全データ手動更新実行');
            executeStep1to4Pipeline();
        }

        // デバッグ関数
        function exportDebugData() {
            const { departmentData } = DataSyncManager.updateDataSyncStatus();
            const analysisData = YearOverYearAnalysis.analyzeYearOverYear(departmentData);
            
            const debugData = {
                timestamp: new Date().toISOString(),
                version: 'Step1-4完全版（目標配分復旧）',
                storageKeys: STORAGE_KEYS,
                departmentData: departmentData,
                analysisData: analysisData,
                commonExpenses: calculateCommonExpensesTotal(),
                targetAllocation: targetAllocation,
                step1_dataAcquisition: 'completed',
                step2_statusDisplay: 'completed',
                step3_individualDisplay: 'completed',
                step4_yearOverYear: 'completed',
                targetAllocationFunction: 'restored'
            };
            
            console.log('Step1-4統合デバッグデータ（目標配分復旧版）:', debugData);
            
            const textarea = document.createElement('textarea');
            textarea.value = JSON.stringify(debugData, null, 2);
            textarea.style.position = 'fixed';
            textarea.style.top = '50px';
            textarea.style.left = '50px';
            textarea.style.width = '80%';
            textarea.style.height = '60%';
            textarea.style.zIndex = '9999';
            textarea.style.background = 'white';
            textarea.style.border = '2px solid #333';
            document.body.appendChild(textarea);
            textarea.select();
            
            setTimeout(() => {
                document.body.removeChild(textarea);
            }, 5000);
        }

        let debugMode = true;
        function toggleDebugMode() {
            debugMode = !debugMode;
            const debugSection = document.querySelector('.debug-section');
            debugSection.style.display = debugMode ? 'block' : 'none';
        }

        // 自動更新（フォーカス時）
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                setTimeout(executeStep1to4Pipeline, 500);
            }
        });
    </script>
</body>
</html>
