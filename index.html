<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆCSVå®Ÿãƒ‡ãƒ¼ã‚¿å¯¾å¿œç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 8px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header-table {
            width: 100%;
            border-collapse: collapse;
            background: #667eea;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .header-table td {
            padding: 8px 12px;
            font-size: 0.85em;
            font-weight: 600;
            vertical-align: middle;
        }

        .header-left {
            text-align: left;
            width: 60%;
        }

        .header-right {
            text-align: right;
            width: 40%;
        }

        .nav-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.98);
        }

        .nav-table td {
            padding: 6px 8px;
            text-align: center;
            border-right: 1px solid #ddd;
        }

        .nav-table td:last-child {
            border-right: none;
        }

        .nav-btn, .action-btn {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.7em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover, .action-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: #4a5bc4;
        }

        .action-btn.reload { background: #e74c3c; }
        .action-btn.export { background: #27ae60; }
        .action-btn.toggle { background: #9b59b6; }
        .action-btn.data-sync { 
            background: linear-gradient(135deg, #f39c12, #e67e22); 
            min-width: 100px;
        }
        .action-btn.integration { 
            background: linear-gradient(135deg, #1abc9c, #16a085); 
            min-width: 100px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 10px;
            background: white;
        }

        .kpi-card {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .kpi-card.dept { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .kpi-card.common { background: linear-gradient(135deg, #34495e, #2c3e50); color: white; }
        .kpi-card.final-positive { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .kpi-card.final-negative { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .kpi-card.target { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }

        .kpi-label {
            font-size: 0.65em;
            margin-bottom: 2px;
            opacity: 0.9;
        }

        .kpi-value {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 1px;
        }

        .kpi-detail {
            font-size: 0.55em;
            opacity: 0.8;
        }

        .data-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 10px;
            font-size: 0.75em;
            display: none;
        }

        .chart-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .chart-title {
            font-size: 0.9em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 220px;
        }

        .dept-comparison-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .section-title {
            font-size: 0.85em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
            border-left: 3px solid #667eea;
            padding-left: 6px;
        }

        .dept-comparison-row {
            display: table;
            width: 100%;
            table-layout: fixed;
            margin-bottom: 12px;
        }

        .dept-graph-cell {
            display: table-cell;
            width: 50%;
            padding-right: 10px;
            vertical-align: middle;
        }

        .dept-kpi-cell {
            display: table-cell;
            width: 50%;
            padding-left: 10px;
            vertical-align: middle;
        }

        .dept-graph-container {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #dee2e6;
        }

        .dept-graph-header {
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dept-kpi-container {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid;
            height: 100%;
        }

        .kpi-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.7em;
        }

        .kpi-item:last-child {
            border-bottom: none;
        }

        .kpi-item-label {
            color: #666;
            font-weight: 500;
        }

        .kpi-item-value {
            font-weight: bold;
        }

        /* äº‹æ¥­éƒ¨ã‚«ãƒ©ãƒ¼å®šç¾© */
        .dept-sr { color: #f39c12; border-color: #f39c12 !important; }
        .dept-sr .dept-graph-header { color: #f39c12; }
        .dept-sr .kpi-item-value { color: #f39c12; }

        .dept-w { color: #3498db; border-color: #3498db !important; }
        .dept-w .dept-graph-header { color: #3498db; }
        .dept-w .kpi-item-value { color: #3498db; }

        .dept-rc { color: #27ae60; border-color: #27ae60 !important; }
        .dept-rc .dept-graph-header { color: #27ae60; }
        .dept-rc .kpi-item-value { color: #27ae60; }

        .dept-rcd { color: #9b59b6; border-color: #9b59b6 !important; }
        .dept-rcd .dept-graph-header { color: #9b59b6; }
        .dept-rcd .kpi-item-value { color: #9b59b6; }

        .target-section {
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .target-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .target-toggle {
            padding: 4px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.7em;
            transition: all 0.3s ease;
        }

        .toggle-active {
            background: #27ae60;
            color: white;
        }

        .toggle-inactive {
            background: #bdc3c7;
            color: #7f8c8d;
        }

        .target-input input {
            padding: 3px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 80px;
            font-size: 0.75em;
        }

        .micro-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65em;
            margin-bottom: 8px;
        }

        .micro-table th,
        .micro-table td {
            padding: 2px 4px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .micro-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
            font-size: 0.6em;
        }

        .micro-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin: 10px;
            padding: 8px;
        }

        .debug-title {
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 6px;
            color: #495057;
        }

        .debug-content {
            font-family: 'Courier New', monospace;
            font-size: 0.65em;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .action-buttons {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .status-indicator {
            font-size: 0.7em;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-complete { background: #d4edda; color: #155724; }
        .status-partial { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }

        .auto-sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1abc9c;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .auto-sync-indicator.show {
            opacity: 1;
        }

        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .neutral { color: #6c757d; }

        /* å½¹å“¡å ±é…¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³å¼·èª¿ */
        .executive-section {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            border-radius: 8px;
            margin: 10px;
            padding: 15px;
        }

        .executive-title {
            color: #2c3e50;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 5px;
        }

        .csv-data-highlight {
            background: #fff3cd;
            border: 1px solid #f39c12;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-size: 0.75em;
        }

        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: 1fr; }
            
            .dept-comparison-row {
                display: block;
            }
            
            .dept-graph-cell, .dept-kpi-cell {
                display: block;
                width: 100%;
                padding: 0;
                margin-bottom: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .kpi-grid { 
                grid-template-columns: 1fr; 
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="auto-sync-indicator" id="auto-sync-indicator">
        ğŸ”„ çµ±åˆPLè‡ªå‹•åŒæœŸä¸­...
    </div>

    <div class="container">
        <table class="header-table">
            <tr>
                <td class="header-left">
                    æœ€çµ‚å–¶æ¥­åˆ©ç›Š <span id="header-final-profit">---</span>ä¸‡å††ï¼ˆå…±é€šçµŒè²»æ§é™¤å¾Œãƒ»ç›®æ¨™é…åˆ†<span id="header-allocation-status">OFF</span>ï¼‰
                </td>
                <td class="header-right">
                    4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ CSVå®Ÿãƒ‡ãƒ¼ã‚¿å¯¾å¿œç‰ˆï¼ˆçµ±åˆPLå®Œå…¨é€£å‹•ç‰ˆï¼‰
                </td>
            </tr>
        </table>

        <table class="nav-table">
            <tr>
                <td><button class="nav-btn active">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button></td>
                <td><button class="nav-btn" onclick="location.href='budget-input.html'">äºˆç®—å…¥åŠ›</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/sr-pl.html'">SRäº‹æ¥­éƒ¨PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/w-pl.html'">Wäº‹æ¥­éƒ¨PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/rc-pl.html'">RCÃ¥Â¸äº‹æ¥­éƒ¨PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/rcd-pl.html'">RCDÃ§Â¤Â¾äº‹æ¥­éƒ¨PL</button></td>
                <td><button class="nav-btn" onclick="location.href='combined-dashboard/index.html'">å…¨ä½“PLåˆ†æ</button></td>
            </tr>
        </table>

        <div class="data-warning" id="data-warning"></div>

        <div class="chart-section">
            <div class="chart-title">æœˆæ¬¡åˆ©ç›Šæ¨ç§»ï¼ˆçµ±åˆPLãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€£å‹•å¯¾å¿œï¼‰</div>
            <div class="chart-wrapper">
                <canvas id="monthly-profit-chart"></canvas>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card dept">
                <div class="kpi-label">çµ±åˆå¹´é–“å£²ä¸Š</div>
                <div class="kpi-value" id="dept-total-sales">---ä¸‡å††</div>
                <div class="kpi-detail">4äº‹æ¥­éƒ¨åˆè¨ˆ</div>
            </div>
            <div class="kpi-card common">
                <div class="kpi-label">å¹´é–“å…±é€šçµŒè²»</div>
                <div class="kpi-value" id="common-expenses-total">-8,556ä¸‡å††</div>
                <div class="kpi-detail">å½¹å“¡å ±é…¬ãƒ»è«¸çµŒè²»ï¼ˆCSVå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰</div>
            </div>
            <div class="kpi-card final-positive" id="final-card">
                <div class="kpi-label">æœ€çµ‚å–¶æ¥­åˆ©ç›Š</div>
                <div class="kpi-value" id="final-profit">---ä¸‡å††</div>
                <div class="kpi-detail">å…±é€šçµŒè²»æ§é™¤å¾Œ</div>
            </div>
            <div class="kpi-card target">
                <div class="kpi-label">ç›®æ¨™é”æˆç‡</div>
                <div class="kpi-value" id="target-achievement">---%</div>
                <div class="kpi-detail" id="target-status">ç›®æ¨™é…åˆ†OFF</div>
            </div>
        </div>

        <div class="dept-comparison-section">
            <div class="section-title">Step2-3: å„äº‹æ¥­éƒ¨å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ»åˆ†æï¼ˆå‰å¹´åŒæœˆå®Ÿç¸¾æ¯”è¼ƒï¼‰</div>
            
            <!-- SRäº‹æ¥­éƒ¨ -->
            <div class="dept-comparison-row">
                <div class="dept-graph-cell">
                    <div class="dept-graph-container">
                        <div class="dept-graph-header dept-sr">
                            <span>SRäº‹æ¥­éƒ¨</span>
                            <span id="sr-yoy-summary" style="font-size: 0.9em;">å‰å¹´æ¯”: --%</span>
                        </div>
                        <div style="position: relative; height: 120px; background: white; border-radius: 4px;">
                            <canvas id="sr-monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="dept-kpi-cell">
                    <div class="dept-kpi-container dept-sr">
                        <div class="kpi-item">
                            <span class="kpi-item-label">å‰å¹´å£²ä¸Šåˆè¨ˆ</span>
                            <span class="kpi-item-value">31,382ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼å£²ä¸Š</span>
                            <span class="kpi-item-value" id="sr-sim-sales">---ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å¢—é¡</span>
                            <span class="kpi-item-value" id="sr-increase">---ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å£²ä¸Šä¼¸ã³ç‡</span>
                            <span class="kpi-item-value" id="sr-growth">--%</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å–¶æ¥­åˆ©ç›Šé¡</span>
                            <span class="kpi-item-value" id="sr-profit">---ä¸‡å††</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wäº‹æ¥­éƒ¨ -->
            <div class="dept-comparison-row">
                <div class="dept-graph-cell">
                    <div class="dept-graph-container">
                        <div class="dept-graph-header dept-w">
                            <span>Wäº‹æ¥­éƒ¨</span>
                            <span id="w-yoy-summary" style="font-size: 0.9em;">å‰å¹´æ¯”: --%</span>
                        </div>
                        <div style="position: relative; height: 120px; background: white; border-radius: 4px;">
                            <canvas id="w-monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="dept-kpi-cell">
                    <div class="dept-kpi-container dept-w">
                        <div class="kpi-item">
                            <span class="kpi-item-label">å‰å¹´å£²ä¸Šåˆè¨ˆ</span>
                            <span class="kpi-item-value">11,521ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼å£²ä¸Š</span>
                            <span class="kpi-item-value" id="w-sim-sales">---ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å¢—é¡</span>
                            <span class="kpi-item-value" id="w-increase">---ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å£²ä¸Šä¼¸ã³ç‡</span>
                            <span class="kpi-item-value" id="w-growth">--%</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å–¶æ¥­åˆ©ç›Šé¡</span>
                            <span class="kpi-item-value" id="w-profit">---ä¸‡å††</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RCÃ¥Â¸äº‹æ¥­éƒ¨ -->
            <div class="dept-comparison-row">
                <div class="dept-graph-cell">
                    <div class="dept-graph-container">
                        <div class="dept-graph-header dept-rc">
                            <span>RCÃ¥Â¸äº‹æ¥­éƒ¨</span>
                            <span id="rc-yoy-summary" style="font-size: 0.9em;">å‰å¹´æ¯”: --%</span>
                        </div>
                        <div style="position: relative; height: 120px; background: white; border-radius: 4px;">
                            <canvas id="rc-monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="dept-kpi-cell">
                    <div class="dept-kpi-container dept-rc">
                        <div class="kpi-item">
                            <span class="kpi-item-label">å‰å¹´å£²ä¸Šåˆè¨ˆ</span>
                            <span class="kpi-item-value">18,359ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼å£²ä¸Š</span>
                            <span class="kpi-item-value" id="rc-sim-sales">---ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å¢—é¡</span>
                            <span class="kpi-item-value" id="rc-increase">---ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å£²ä¸Šä¼¸ã³ç‡</span>
                            <span class="kpi-item-value" id="rc-growth">--%</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å–¶æ¥­åˆ©ç›Šé¡</span>
                            <span class="kpi-item-value" id="rc-profit">---ä¸‡å††</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RCDÃ§Â¤Â¾äº‹æ¥­éƒ¨ -->
            <div class="dept-comparison-row">
                <div class="dept-graph-cell">
                    <div class="dept-graph-container">
                        <div class="dept-graph-header dept-rcd">
                            <span>RCDÃ§Â¤Â¾äº‹æ¥­éƒ¨ï¼ˆè¨ˆç”»å—æ³¨ï¼‰</span>
                            <span id="rcd-yoy-summary" style="font-size: 0.9em;">å‰å¹´æ¯”: --%</span>
                        </div>
                        <div style="position: relative; height: 120px; background: white; border-radius: 4px;">
                            <canvas id="rcd-monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="dept-kpi-cell">
                    <div class="dept-kpi-container dept-rcd">
                        <div class="kpi-item">
                            <span class="kpi-item-label">å‰å¹´å£²ä¸Šåˆè¨ˆ</span>
                            <span class="kpi-item-value">170,179ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼å£²ä¸Š</span>
                            <span class="kpi-item-value" id="rcd-sim-sales">---ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å¢—é¡</span>
                            <span class="kpi-item-value" id="rcd-increase">---ä¸‡å††</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å£²ä¸Šä¼¸ã³ç‡</span>
                            <span class="kpi-item-value" id="rcd-growth">--%</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-item-label">å–¶æ¥­åˆ©ç›Šé¡</span>
                            <span class="kpi-item-value" id="rcd-profit">---ä¸‡å††</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="target-section">
            <div class="section-title">ç›®æ¨™é…åˆ†æ©Ÿèƒ½ï¼ˆæå¤±åœ§ç¸®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰</div>
            
            <div class="target-controls">
                <button id="allocation-toggle-btn" class="target-toggle toggle-inactive" onclick="toggleTargetAllocation()">
                    ç›®æ¨™é…åˆ†OFF
                </button>
                <div class="target-input">
                    <label style="font-size: 0.7em;">å¹´é–“ç›®æ¨™:</label>
                    <input type="number" id="total-target" value="6000" step="100" onchange="updateTargetAllocation()">
                    <span style="font-size: 0.7em;">ä¸‡å††</span>
                </div>
            </div>

            <div id="allocation-results" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <table class="micro-table">
                            <thead>
                                <tr>
                                    <th>äº‹æ¥­éƒ¨</th>
                                    <th>æˆ¦ç•¥</th>
                                    <th>ç¾åœ¨åˆ©ç›Š</th>
                                    <th>ç›®æ¨™åˆ©ç›Š</th>
                                    <th>æ”¹å–„é¡</th>
                                    <th>å£²ä¸Šå¢—ç‡</th>
                                    <th>ç¾å®Ÿæ€§</th>
                                </tr>
                            </thead>
                            <tbody id="allocation-table">
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <div style="font-size: 0.7em; font-weight: 600; margin-bottom: 8px; text-align: center; color: #2c3e50;">åˆ©ç›Šæ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ</div>
                        <div style="position: relative; height: 200px;">
                            <canvas id="profit-comparison-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 6px; border-radius: 4px; font-size: 0.65em; margin-top: 6px;">
                    <strong>é…åˆ†ãƒ­ã‚¸ãƒƒã‚¯:</strong>
                    èµ¤å­—äº‹æ¥­éƒ¨ï¼ˆSRï¼‰:æœˆ+100ä¸‡å›ºå®š | é»’å­—äº‹æ¥­éƒ¨ï¼ˆWãƒ»RCÃ¥Â¸ï¼‰:åŠ¹ç‡é…åˆ† | RCDÃ§Â¤Â¾:è¨ˆç”»å—æ³¨ã«ã‚ˆã‚Šé™¤å¤– | åˆ¶ç´„:å£²ä¸Šå¢—20%ä¸Šé™
                </div>
            </div>
        </div>

        <!-- CSVå®Ÿãƒ‡ãƒ¼ã‚¿å¯¾å¿œå½¹å“¡å ±é…¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="executive-section">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                <div class="executive-title" style="margin-bottom: 0; border-bottom: none; padding-bottom: 0;">å½¹å“¡å ±é…¬è¨­å®š</div>
                <div class="csv-data-highlight" style="margin: 0; flex-grow: 1;">
                    <strong>ğŸ“Š CSVå®Ÿãƒ‡ãƒ¼ã‚¿åæ˜ æ¸ˆã¿:</strong> å½¹å“¡å ±é…¬ã¯å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆ7-9æœˆ:826ä¸‡å††ã€10-6æœˆ:676ä¸‡å††ã€å¹´é–“è¨ˆ8,556ä¸‡å††ï¼‰ã«åŸºã¥ã„ã¦è‡ªå‹•è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã™ã€‚
                </div>
            </div>
            
            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #27ae60;">
                <!-- 1è¡Œç›®ï¼šæœˆé¡è¨­å®š -->
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
                    <div style="font-size: 0.8em; font-weight: bold; color: #2c3e50; min-width: 80px;">æœˆé¡è¨­å®š</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.7em; color: #666;">7-9æœˆåŸºæº–:</label>
                        <input type="number" id="base-salary-high" value="826" step="10" readonly style="width: 60px; padding: 2px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.7em; background: #f8f9fa;">
                        <span style="font-size: 0.65em;">ä¸‡å††</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.7em; color: #666;">10-6æœˆåŸºæº–:</label>
                        <input type="number" id="base-salary-low" value="676" step="10" readonly style="width: 60px; padding: 2px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.7em; background: #f8f9fa;">
                        <span style="font-size: 0.65em;">ä¸‡å††</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.7em; color: #666;">èª¿æ•´é¡:</label>
                        <input type="number" id="adjustment-amount" value="0" step="50" style="width: 60px; padding: 2px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.7em;">
                        <span style="font-size: 0.65em;">ä¸‡å††</span>
                    </div>
                    <!-- é©ç”¨ãƒœã‚¿ãƒ³ã‚’å³å´ã«é…ç½® -->
                    <div style="margin-left: auto;">
                        <button class="action-btn" style="background: #27ae60; font-size: 0.7em; padding: 6px 16px;" onclick="applyExecutiveAdjustment()">
                            è¨­å®šã‚’é©ç”¨
                        </button>
                    </div>
                </div>
                
                <!-- 2è¡Œç›®ï¼šå½¹å“¡å ±é…¬ -->
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
                    <div style="font-size: 0.8em; font-weight: bold; color: #2c3e50; min-width: 80px;">å½¹å“¡å ±é…¬</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.7em; color: #666;">6æœˆå½¹å“¡è³ä¸:</label>
                        <input type="number" id="bonus-june" value="0" step="50" style="width: 60px; padding: 2px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.7em;">
                        <span style="font-size: 0.65em;">ä¸‡å††</span>
                    </div>
                    <div style="font-size: 0.9em; font-weight: bold; color: #00bcd4;">
                        6æœˆã®æœˆé¡è²»ã«åŠ ç®—
                    </div>
                </div>
                
                <!-- æœˆåˆ¥è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç°¡ç•¥åŒ–ç‰ˆï¼‰ -->
                <div style="margin-top: 15px; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.65em;">
                        <thead>
                            <tr style="background: #27ae60; color: white;">
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">é …ç›®</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">7æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">8æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">9æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">10æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">11æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">12æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">1æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">2æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">3æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">4æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">5æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd;">6æœˆ</th>
                                <th style="padding: 4px; text-align: center; border: 1px solid #ddd; font-weight: bold;">å¹´è¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #e8f5e8;">
                                <td style="padding: 4px; border: 1px solid #ddd; font-weight: bold;">å½¹å“¡å ±é…¬</td>
                                <td id="exec-m0" style="padding: 4px; text-align: right; border: 1px solid #ddd;">826</td>
                                <td id="exec-m1" style="padding: 4px; text-align: right; border: 1px solid #ddd;">826</td>
                                <td id="exec-m2" style="padding: 4px; text-align: right; border: 1px solid #ddd;">826</td>
                                <td id="exec-m3" style="padding: 4px; text-align: right; border: 1px solid #ddd;">676</td>
                                <td id="exec-m4" style="padding: 4px; text-align: right; border: 1px solid #ddd;">676</td>
                                <td id="exec-m5" style="padding: 4px; text-align: right; border: 1px solid #ddd;">676</td>
                                <td id="exec-m6" style="padding: 4px; text-align: right; border: 1px solid #ddd;">676</td>
                                <td id="exec-m7" style="padding: 4px; text-align: right; border: 1px solid #ddd;">676</td>
                                <td id="exec-m8" style="padding: 4px; text-align: right; border: 1px solid #ddd;">676</td>
                                <td id="exec-m9" style="padding: 4px; text-align: right; border: 1px solid #ddd;">676</td>
                                <td id="exec-m10" style="padding: 4px; text-align: right; border: 1px solid #ddd;">676</td>
                                <td id="exec-m11" style="padding: 4px; text-align: right; border: 1px solid #ddd; font-weight: bold; background: #e1f5fe; color: #00bcd4;">676</td>
                                <td id="exec-total" style="padding: 4px; text-align: right; border: 1px solid #ddd; font-weight: bold;">8,556</td>
                            </tr>
                            <tr style="background: #fff;">
                                <td style="padding: 4px; border: 1px solid #ddd; font-weight: bold;">æ³•å®šç¦åˆ©è²»</td>
                                <td id="welfare-m0" style="padding: 4px; text-align: right; border: 1px solid #ddd;">107</td>
                                <td id="welfare-m1" style="padding: 4px; text-align: right; border: 1px solid #ddd;">107</td>
                                <td id="welfare-m2" style="padding: 4px; text-align: right; border: 1px solid #ddd;">107</td>
                                <td id="welfare-m3" style="padding: 4px; text-align: right; border: 1px solid #ddd;">88</td>
                                <td id="welfare-m4" style="padding: 4px; text-align: right; border: 1px solid #ddd;">88</td>
                                <td id="welfare-m5" style="padding: 4px; text-align: right; border: 1px solid #ddd;">88</td>
                                <td id="welfare-m6" style="padding: 4px; text-align: right; border: 1px solid #ddd;">88</td>
                                <td id="welfare-m7" style="padding: 4px; text-align: right; border: 1px solid #ddd;">88</td>
                                <td id="welfare-m8" style="padding: 4px; text-align: right; border: 1px solid #ddd;">88</td>
                                <td id="welfare-m9" style="padding: 4px; text-align: right; border: 1px solid #ddd;">88</td>
                                <td id="welfare-m10" style="padding: 4px; text-align: right; border: 1px solid #ddd;">88</td>
                                <td id="welfare-m11" style="padding: 4px; text-align: right; border: 1px solid #ddd;">88</td>
                                <td id="welfare-total" style="padding: 4px; text-align: right; border: 1px solid #ddd; font-weight: bold;">1,115</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <div class="debug-title">CSVå®Ÿãƒ‡ãƒ¼ã‚¿å¯¾å¿œç‰ˆãƒ‡ãƒãƒƒã‚°: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸçŠ¶æ³</div>
            <div class="debug-content" id="debug-output">
                CSVå®Ÿãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn reload" onclick="refreshDashboardData()">å…¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
            <div class="status-indicator" id="data-sync-status-indicator">
                <span>ğŸ“Š</span>
                <span id="data-sync-status-text">ãƒ‡ãƒ¼ã‚¿å–å¾—: 0/4éƒ¨é–€</span>
            </div>
            <div class="status-indicator" id="integration-status-indicator">
                <span>ğŸ”—</span>
                <span id="integration-status-text">çµ±åˆPLé€£æº: å¾…æ©Ÿä¸­</span>
            </div>
            <button class="action-btn export" onclick="exportDebugData()">ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›</button>
            <button class="action-btn toggle" onclick="toggleDebugMode()">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡æ›¿</button>
            <button class="action-btn integration" onclick="loadIntegrationData()">çµ±åˆPLé€£æºç¢ºèª</button>
            <button class="action-btn" style="background: #e67e22;" onclick="enableAutoSync()">è‡ªå‹•åŒæœŸé–‹å§‹</button>
        </div>
    </div>

    <script>
        // ===== ã€ä¿è­·é ˜åŸŸé–‹å§‹ã€‘çµ¶å¯¾ã«å¤‰æ›´ç¦æ­¢ =====
        // LocalStorageã‚­ãƒ¼ç®¡ç† - çµ±åˆã‚·ã‚¹ãƒ†ãƒ ç”¨
        const STORAGE_KEYS = {
            sr: 'pl_system_sr_data',
            w: 'pl_system_w_data',
            rc: 'pl_system_rc_data',
            rcd: 'pl_system_rcd_data',
            executive: 'pl_system_executive_data',
            dashboard_integration: 'dashboard_integration_data'
        };
        // ===== ã€ä¿è­·é ˜åŸŸçµ‚äº†ã€‘ =====

        // å‰å¹´å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿å®šç¾©ï¼ˆå›ºå®šå€¤ã¨ã—ã¦ä¿ç®¡ï¼‰
        const PREVIOUS_YEAR_DATA = {
            sr: {
                name: 'SRäº‹æ¥­éƒ¨',
                monthly: [2236, 2916, 2927, 2810, 2544, 2663, 3008, 2324, 2403, 2602, 2228, 2721],
                stores: {
                    æ¸…æ°´åº—: [416, 397, 421, 502, 471, 544, 567, 476, 355, 408, 299, 346],
                    é™å²¡åº—: [369, 386, 600, 535, 285, 437, 351, 270, 369, 391, 256, 242],
                    æ›å·åº—: [284, 375, 508, 278, 394, 394, 377, 309, 248, 469, 448, 535],
                    å¸‚é‡åº—: [328, 547, 723, 520, 528, 607, 574, 318, 714, 657, 700, 600],
                    ä½é³´åº—: [349, 719, 247, 433, 308, 265, 516, 311, 222, 293, 272, 379],
                    åºƒå³¶åº—: [490, 493, 427, 542, 558, 416, 622, 641, 496, 385, 253, 620]
                },
                annual: 31382
            },
            w: {
                name: 'Wäº‹æ¥­éƒ¨',
                monthly: [886, 500, 669, 1174, 1257, 2331, 712, 772, 865, 824, 608, 923],
                annual: 11521
            },
            rc: {
                name: 'RCÃ¥Â¸äº‹æ¥­éƒ¨',
                monthly: [1947, 1645, 1530, 1730, 1165, 1846, 1475, 1585, 1241, 1173, 1602, 1420],
                annual: 18359
            },
            rcd: {
                name: 'RCDÃ§Â¤Â¾äº‹æ¥­éƒ¨',
                monthly: [11037, 14297, 11504, 14664, 12507, 14920, 13661, 15455, 14439, 15857, 15478, 16360],
                annual: 170179
            }
        };

        // äº‹æ¥­éƒ¨ã‚«ãƒ©ãƒ¼å®šç¾©ï¼ˆSRäº‹æ¥­éƒ¨ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ç³»ã«å¤‰æ›´ï¼‰
        const DEPT_COLORS = {
            sr: '#f39c12',  // ã‚ªãƒ¬ãƒ³ã‚¸ç³»ã«å¤‰æ›´
            w: '#3498db',   // é’
            rc: '#27ae60',  // ç·‘
            rcd: '#9b59b6'  // ç´«
        };

        // CSVå®Ÿãƒ‡ãƒ¼ã‚¿å¯¾å¿œå½¹å“¡å ±é…¬ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        const ExecutiveCompensationManager = {
            // CSVå®Ÿãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å€¤
            csvData: {
                highPeriod: 826,  // 7-9æœˆ
                lowPeriod: 676,   // 10-6æœˆ
                monthly: [826, 826, 826, 676, 676, 676, 676, 676, 676, 676, 676, 676],
                welfare: [107, 107, 107, 88, 88, 88, 88, 88, 88, 88, 88, 88],
                other: [59, -5, 46, 37, 30, 82, 58, 48, 110, 80, 102, 61]
            },

            // ç¾åœ¨ã®å€¤ï¼ˆèª¿æ•´é©ç”¨å¾Œï¼‰
            currentValues: null,

            // åˆæœŸåŒ–
            init: function() {
                this.loadValues();
                this.updateDisplay();
                this.logDebug('CSVå®Ÿãƒ‡ãƒ¼ã‚¿å¯¾å¿œå½¹å“¡å ±é…¬ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            },

            // å€¤ã®èª­ã¿è¾¼ã¿
            loadValues: function() {
                try {
                    const stored = localStorage.getItem('executive_compensation_csv_settings');
                    if (stored) {
                        this.currentValues = JSON.parse(stored);
                        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«bonusJuneãŒç„¡ã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                        if (this.currentValues.bonusJune === undefined) {
                            this.currentValues.bonusJune = 0;
                        }
                    } else {
                        this.currentValues = {
                            adjustment: 0,
                            bonusJune: 0,
                            monthlyCompensation: [...this.csvData.monthly],
                            welfare: [...this.csvData.welfare],
                            other: [...this.csvData.other]
                        };
                    }
                } catch (error) {
                    this.logDebug('å½¹å“¡å ±é…¬è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', error.message);
                    this.resetToCSVData();
                }
            },

            // CSVå®Ÿãƒ‡ãƒ¼ã‚¿ã«ãƒªã‚»ãƒƒãƒˆ
            resetToCSVData: function() {
                this.currentValues = {
                    adjustment: 0,
                    bonusJune: 0,
                    monthlyCompensation: [...this.csvData.monthly],
                    welfare: [...this.csvData.welfare],
                    other: [...this.csvData.other]
                };
                this.saveValues();
            },

            // å€¤ã®ä¿å­˜
            saveValues: function() {
                try {
                    localStorage.setItem('executive_compensation_csv_settings', JSON.stringify(this.currentValues));
                    
                    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                    const dashboardData = {
                        executiveCompensation: this.currentValues.monthlyCompensation,
                        lastUpdate: new Date().toISOString()
                    };
                    
                    // æ—¢å­˜ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸
                    const existingData = localStorage.getItem(STORAGE_KEYS.dashboard) || '{}';
                    const merged = { ...JSON.parse(existingData), ...dashboardData };
                    localStorage.setItem(STORAGE_KEYS.dashboard, JSON.stringify(merged));
                    
                    this.logDebug('å½¹å“¡å ±é…¬ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
                } catch (error) {
                    this.logDebug('å½¹å“¡å ±é…¬è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼', error.message);
                }
            },

            // è¡¨ç¤ºæ›´æ–°
            updateDisplay: function() {
                // å…¥åŠ›æ¬„æ›´æ–°
                document.getElementById('base-salary-high').value = this.csvData.highPeriod;
                document.getElementById('base-salary-low').value = this.csvData.lowPeriod;
                document.getElementById('adjustment-amount').value = this.currentValues.adjustment;
                document.getElementById('bonus-june').value = this.currentValues.bonusJune;
                
                // æœˆåˆ¥è¡¨ç¤ºæ›´æ–°ï¼ˆå½¹å“¡å ±é…¬ã¨æ³•å®šç¦åˆ©è²»ã®ã¿ï¼‰
                let execTotal = 0;
                let welfareTotal = 0;
                
                for (let i = 0; i < 12; i++) {
                    const exec = this.currentValues.monthlyCompensation[i];
                    const welfare = this.currentValues.welfare[i];
                    
                    document.getElementById(`exec-m${i}`).textContent = exec.toLocaleString();
                    document.getElementById(`welfare-m${i}`).textContent = welfare.toLocaleString();
                    
                    execTotal += exec;
                    welfareTotal += welfare;
                }
                
                // å¹´è¨ˆæ›´æ–°
                document.getElementById('exec-total').textContent = execTotal.toLocaleString();
                document.getElementById('welfare-total').textContent = welfareTotal.toLocaleString();
                
                // å…±é€šçµŒè²»åˆè¨ˆKPIæ›´æ–°ï¼ˆå½¹å“¡å ±é…¬ã®ã¿ã€‚æ³•å®šç¦åˆ©è²»ã¯ä»–äº‹æ¥­éƒ¨ã«åˆç®—ï¼‰
                const commonExpensesElement = document.getElementById('common-expenses-total');
                if (commonExpensesElement) {
                    commonExpensesElement.textContent = `-${execTotal.toLocaleString()}ä¸‡å††`;
                }
            },

            // èª¿æ•´é©ç”¨
            applyAdjustment: function() {
                const adjustment = parseInt(document.getElementById('adjustment-amount').value) || 0;
                const bonusJune = parseInt(document.getElementById('bonus-june').value) || 0;
                
                this.currentValues.adjustment = adjustment;
                this.currentValues.bonusJune = bonusJune;
                
                // åŸºæœ¬æœˆé¡ã«èª¿æ•´é¡ã‚’é©ç”¨
                this.currentValues.monthlyCompensation = this.csvData.monthly.map(base => base + adjustment);
                
                // 6æœˆã«å½¹å“¡è³ä¸ã‚’åŠ ç®—
                this.currentValues.monthlyCompensation[11] += bonusJune; // 6æœˆã¯é…åˆ—ã®11ç•ªç›®
                
                // æ³•å®šç¦åˆ©è²»ã‚‚èª¿æ•´ï¼ˆ13%ã§è¨ˆç®—ï¼‰
                this.currentValues.welfare = this.currentValues.monthlyCompensation.map(comp => 
                    Math.round(comp * 0.13)
                );
                
                this.updateDisplay();
                this.saveValues();
                
                const newTotal = this.currentValues.monthlyCompensation.reduce((sum, val) => sum + val, 0);
                this.logDebug(`å½¹å“¡å ±é…¬è¨­å®šé©ç”¨: èª¿æ•´é¡${adjustment}ä¸‡å††/æœˆ, 6æœˆè³ä¸${bonusJune}ä¸‡å†† â†’ å¹´é–“åˆè¨ˆ${newTotal}ä¸‡å††`);
                
                alert(`å½¹å“¡å ±é…¬è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸã€‚\nèª¿æ•´é¡: ${adjustment >= 0 ? '+' : ''}${adjustment}ä¸‡å††/æœˆ\n6æœˆè³ä¸: ${bonusJune}ä¸‡å††\nå¹´é–“åˆè¨ˆ: ${newTotal.toLocaleString()}ä¸‡å††`);
            },

            logDebug: function(message, data = null) {
                console.log(`[CSVå½¹å“¡å ±é…¬] ${message}`, data || '');
                const debugElement = document.getElementById('debug-output');
                if (debugElement) {
                    const timestamp = new Date().toLocaleTimeString();
                    debugElement.innerHTML += `<br>[${timestamp}] CSVå½¹å“¡å ±é…¬: ${message}`;
                    if (data) {
                        debugElement.innerHTML += `<br>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€${JSON.stringify(data, null, 2)}`;
                    }
                }
            }
        };

        // Phase 3å®Œå…¨å®Ÿè£…: çµ±åˆPLå®Œå…¨é€£å‹•ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  
        const IntegrationLinkageManager = {
            autoSyncInterval: null,
            isAutoSyncEnabled: false,
            lastSyncData: null,

            loadIntegrationData: function() {
                try {
                    const integrationData = localStorage.getItem(STORAGE_KEYS.dashboard_integration);
                    if (integrationData) {
                        const data = JSON.parse(integrationData);
                        
                        this.updateDashboardFromIntegration(data);
                        this.updateIntegrationStatus('çµ±åˆPLã¨é€£æºä¸­', 'success');
                        this.lastSyncData = data;
                        
                        this.logDebug('çµ±åˆPLãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ', {
                            version: data.version,
                            departments: data.departments.activeCount,
                            lastUpdate: data.lastUpdate
                        });
                        
                        return data;
                    } else {
                        this.updateIntegrationStatus('çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãªã—', 'waiting');
                        this.logDebug('çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        return null;
                    }
                } catch (error) {
                    console.error('çµ±åˆPLé€£æºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateIntegrationStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
                    this.logDebug('çµ±åˆPLé€£æºã‚¨ãƒ©ãƒ¼', error.message);
                    return null;
                }
            },

            updateDashboardFromIntegration: function(integrationData) {
                try {
                    // åŸºæœ¬KPIæ›´æ–°
                    this.updateElement('dept-total-sales', `${this.formatNumber(integrationData.summary.totalSales)}ä¸‡å††`);
                    this.updateElement('final-profit', `${this.formatNumber(integrationData.summary.totalProfit)}ä¸‡å††`);
                    this.updateElement('header-final-profit', this.formatNumber(integrationData.summary.totalProfit));
                    
                    // çµ±åˆPLé€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                    this.updateIntegrationStatus('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', 'success');
                    
                    // æœ€çµ‚åˆ©ç›Šã‚«ãƒ¼ãƒ‰ã®è‰²å¤‰æ›´
                    const finalCard = document.getElementById('final-card');
                    if (finalCard) {
                        finalCard.className = 'kpi-card ' + (integrationData.summary.totalProfit >= 0 ? 'final-positive' : 'final-negative');
                    }

                    // ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                    this.updateDataSyncStatus(integrationData.departments.activeCount, 4);

                    // æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
                    if (integrationData.monthlyData) {
                        this.updateMonthlyChart(integrationData.monthlyData);
                    }

                    this.logDebug('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°å®Œäº†ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿ï¼‰', {
                        å£²ä¸Š: integrationData.summary.totalSales,
                        åˆ©ç›Š: integrationData.summary.totalProfit,
                        åˆ©ç›Šç‡: integrationData.summary.profitRate,
                        ã‚¢ã‚¯ãƒ†ã‚£ãƒ–éƒ¨é–€: integrationData.departments.activeCount
                    });

                } catch (error) {
                    console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateIntegrationStatus('æ›´æ–°ã‚¨ãƒ©ãƒ¼', 'error');
                    this.logDebug('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼', error.message);
                }
            },

            updateMonthlyChart: function(monthlyData) {
                try {
                    const ctx = document.getElementById('monthly-profit-chart');
                    if (!ctx) return;

                    if (window.monthlyProfitChart) {
                        window.monthlyProfitChart.destroy();
                    }

                    const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];

                    window.monthlyProfitChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'çµ±åˆå–¶æ¥­åˆ©ç›Š',
                                    data: monthlyData.profit || Array(12).fill(0),
                                    borderColor: '#e74c3c',
                                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'çµ±åˆå£²ä¸Šé«˜',
                                    data: monthlyData.sales || Array(12).fill(0),
                                    borderColor: '#3498db',
                                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                    borderWidth: 2,
                                    fill: false,
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'ä¸‡å††';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'å£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    });

                    this.logDebug('æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°å®Œäº†ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿ï¼‰');
                } catch (error) {
                    console.error('æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    this.logDebug('æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼', error.message);
                }
            },

            updateIntegrationStatus: function(message, status) {
                try {
                    const statusText = document.getElementById('integration-status-text');
                    const indicator = document.getElementById('integration-status-indicator');
                    
                    if (statusText) {
                        statusText.textContent = `çµ±åˆPLé€£æº: ${message}`;
                    }
                    
                    if (indicator) {
                        indicator.className = `status-indicator status-${status === 'success' ? 'complete' : status === 'waiting' ? 'partial' : 'error'}`;
                    }

                    this.logDebug(`çµ±åˆPLé€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${status} - ${message}`);
                } catch (error) {
                    console.error('çµ±åˆé€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            },

            updateDataSyncStatus: function(loadedCount, totalCount) {
                const statusText = document.getElementById('data-sync-status-text');
                const indicator = document.getElementById('data-sync-status-indicator');
                
                if (statusText) {
                    statusText.textContent = `ãƒ‡ãƒ¼ã‚¿å–å¾—: ${loadedCount}/${totalCount}éƒ¨é–€`;
                }
                
                if (indicator) {
                    const statusClass = loadedCount === totalCount ? 'complete' : 
                                      loadedCount > 0 ? 'partial' : 'error';
                    indicator.className = `status-indicator status-${statusClass}`;
                }
            },

            enableAutoSync: function() {
                if (this.isAutoSyncEnabled) {
                    this.disableAutoSync();
                    return;
                }

                this.isAutoSyncEnabled = true;
                this.showAutoSyncIndicator();
                
                this.autoSyncInterval = setInterval(() => {
                    this.checkForUpdates();
                }, 5000);

                this.logDebug('è‡ªå‹•åŒæœŸé–‹å§‹');
                alert('çµ±åˆPLè‡ªå‹•åŒæœŸã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚5ç§’é–“éš”ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¾ã™ã€‚');
            },

            disableAutoSync: function() {
                if (this.autoSyncInterval) {
                    clearInterval(this.autoSyncInterval);
                    this.autoSyncInterval = null;
                }
                this.isAutoSyncEnabled = false;
                this.hideAutoSyncIndicator();
                this.logDebug('è‡ªå‹•åŒæœŸåœæ­¢');
                alert('çµ±åˆPLè‡ªå‹•åŒæœŸã‚’åœæ­¢ã—ã¾ã—ãŸã€‚');
            },

            checkForUpdates: function() {
                try {
                    const currentData = localStorage.getItem(STORAGE_KEYS.dashboard_integration);
                    if (!currentData) return;

                    const data = JSON.parse(currentData);
                    
                    if (!this.lastSyncData || 
                        data.lastUpdate !== this.lastSyncData.lastUpdate ||
                        JSON.stringify(data.summary) !== JSON.stringify(this.lastSyncData.summary)) {
                        
                        this.updateDashboardFromIntegration(data);
                        this.lastSyncData = data;
                        this.showAutoSyncIndicator();
                        
                        this.logDebug('è‡ªå‹•åŒæœŸ: ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¤œå‡º', {
                            æ›´æ–°æ™‚åˆ»: data.lastUpdate,
                            å£²ä¸Š: data.summary.totalSales,
                            åˆ©ç›Š: data.summary.totalProfit
                        });

                        setTimeout(() => this.hideAutoSyncIndicator(), 2000);
                    }
                } catch (error) {
                    console.error('è‡ªå‹•åŒæœŸãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                }
            },

            showAutoSyncIndicator: function() {
                const indicator = document.getElementById('auto-sync-indicator');
                if (indicator) {
                    indicator.className = 'auto-sync-indicator show';
                }
            },

            hideAutoSyncIndicator: function() {
                const indicator = document.getElementById('auto-sync-indicator');
                if (indicator) {
                    indicator.className = 'auto-sync-indicator';
                }
            },

            updateElement: function(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                }
            },

            formatNumber: function(num) {
                if (isNaN(num) || num === null || num === undefined) return '0';
                return Math.round(num).toLocaleString();
            },

            logDebug: function(message, data = null) {
                console.log(`[çµ±åˆPLé€£æº] ${message}`, data || '');
                const debugElement = document.getElementById('debug-output');
                if (debugElement) {
                    const timestamp = new Date().toLocaleTimeString();
                    debugElement.innerHTML += `<br>[${timestamp}] çµ±åˆPLé€£æº: ${message}`;
                    if (data) {
                        debugElement.innerHTML += `<br>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€${JSON.stringify(data, null, 2)}`;
                    }
                }
            }
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾©
        let targetAllocationEnabled = false;
        let departmentCharts = {};
        let departmentCurrentData = {
            sr: { sales: 0, profit: 0 },
            w: { sales: 0, profit: 0 },
            rc: { sales: 0, profit: 0 },
            rcd: { sales: 0, profit: 0 }
        };

        // å€‹åˆ¥äº‹æ¥­éƒ¨æœˆæ¬¡ã‚°ãƒ©ãƒ•æç”»é–¢æ•°ï¼ˆå‰å¹´æ¯”è¼ƒå¯¾å¿œç‰ˆï¼‰
        function createDepartmentMonthlyChart(canvasId, deptKey) {
            try {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return null;

                const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
                const previousData = PREVIOUS_YEAR_DATA[deptKey];
                const color = DEPT_COLORS[deptKey];
                
                // ä»ŠæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ€ãƒŸãƒ¼ï¼‰
                let currentData = [];
                const storedData = getCurrentYearData(deptKey);
                
                if (storedData && storedData.length === 12) {
                    currentData = storedData;
                } else {
                    // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
                    currentData = months.map(() => Math.random() * 2000 + 1000);
                }
                
                // KPIãƒ‡ãƒ¼ã‚¿æ›´æ–°ç”¨ã«é›†è¨ˆ
                const currentTotal = currentData.reduce((a, b) => a + b, 0);
                const previousTotal = previousData.annual;
                const yoyChange = ((currentTotal - previousTotal) / previousTotal * 100);
                const increase = currentTotal - previousTotal;
                const profit = Math.random() * 2000 - 500; // åˆ©ç›Šã¯ä»®å€¤ï¼ˆçµ±åˆPLã‹ã‚‰å–å¾—äºˆå®šï¼‰
                
                // éƒ¨é–€ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                departmentCurrentData[deptKey] = {
                    sales: currentTotal,
                    profit: profit
                };
                
                // KPIæ›´æ–°
                updateDepartmentKPI(deptKey, {
                    simSales: currentTotal,
                    increase: increase,
                    growth: Math.round(yoyChange), // æ•´æ•°ã«ä¸¸ã‚
                    profit: profit
                });
                
                // å‰å¹´æ¯”ã‚µãƒãƒªãƒ¼æ›´æ–°ï¼ˆæ•´æ•°è¡¨ç¤ºï¼‰
                const summaryElement = document.getElementById(`${deptKey}-yoy-summary`);
                if (summaryElement) {
                    const roundedChange = Math.round(yoyChange);
                    const changeColor = roundedChange >= 0 ? '#27ae60' : '#e74c3c';
                    summaryElement.innerHTML = `å‰å¹´æ¯”: <span style="color: ${changeColor};">${roundedChange >= 0 ? '+' : ''}${roundedChange}%</span>`;
                }

                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'ä»ŠæœŸå®Ÿç¸¾',
                                data: currentData,
                                backgroundColor: color + '99',
                                borderColor: color,
                                borderWidth: 2,
                                order: 1
                            },
                            {
                                label: 'å‰å¹´å®Ÿç¸¾',
                                data: previousData ? previousData.monthly : [],
                                backgroundColor: '#95a5a633',
                                borderColor: '#7f8c8d',
                                borderWidth: 1,
                                order: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 15,
                                    padding: 5,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label;
                                        const value = Math.round(context.parsed.y); // æ•´æ•°è¡¨ç¤º
                                        
                                        if (label === 'ä»ŠæœŸå®Ÿç¸¾' && previousData) {
                                            const prevValue = previousData.monthly[context.dataIndex];
                                            const change = Math.round(((value - prevValue) / prevValue * 100));
                                            return `${label}: ${value.toLocaleString()}ä¸‡å†† (å‰å¹´æ¯” ${change >= 0 ? '+' : ''}${change}%)`;
                                        }
                                        return `${label}: ${value.toLocaleString()}ä¸‡å††`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        size: 9
                                    },
                                    callback: function(value) {
                                        return Math.round(value).toLocaleString();
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 9
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error(`${deptKey}ã‚°ãƒ©ãƒ•ä½œæˆã‚¨ãƒ©ãƒ¼:`, error);
                return null;
            }
        }

        // ä»ŠæœŸå®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
        function getCurrentYearData(deptKey) {
            try {
                // çµ±åˆPLã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆ
                const integrationData = localStorage.getItem(STORAGE_KEYS.dashboard_integration);
                if (integrationData) {
                    const data = JSON.parse(integrationData);
                    if (data.monthlyData && data.monthlyData[deptKey]) {
                        return data.monthlyData[deptKey];
                    }
                }
                
                // å€‹åˆ¥PLãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
                const deptData = localStorage.getItem(STORAGE_KEYS[deptKey]);
                if (deptData) {
                    const parsed = JSON.parse(deptData);
                    if (parsed.monthlySales && Array.isArray(parsed.monthlySales)) {
                        return parsed.monthlySales;
                    }
                    if (parsed.sales && Array.isArray(parsed.sales)) {
                        return parsed.sales;
                    }
                }
                
                return null;
            } catch (error) {
                console.error(`${deptKey}ã®ä»ŠæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
                return null;
            }
        }

        // äº‹æ¥­éƒ¨KPIæ›´æ–°é–¢æ•°
        function updateDepartmentKPI(deptKey, data) {
            const elements = {
                simSales: document.getElementById(`${deptKey}-sim-sales`),
                increase: document.getElementById(`${deptKey}-increase`),
                growth: document.getElementById(`${deptKey}-growth`),
                profit: document.getElementById(`${deptKey}-profit`)
            };
            
            if (elements.simSales) {
                elements.simSales.textContent = `${Math.round(data.simSales).toLocaleString()}ä¸‡å††`;
            }
            if (elements.increase) {
                elements.increase.textContent = `${data.increase >= 0 ? '+' : ''}${Math.round(data.increase).toLocaleString()}ä¸‡å††`;
                elements.increase.className = `kpi-item-value ${data.increase >= 0 ? 'positive' : 'negative'}`;
            }
            if (elements.growth) {
                elements.growth.textContent = `${data.growth >= 0 ? '+' : ''}${data.growth}%`;
                elements.growth.className = `kpi-item-value ${data.growth >= 0 ? 'positive' : 'negative'}`;
            }
            if (elements.profit) {
                elements.profit.textContent = `${Math.round(data.profit).toLocaleString()}ä¸‡å††`;
                elements.profit.className = `kpi-item-value ${data.profit >= 0 ? 'positive' : 'negative'}`;
            }
        }

        // ç›®æ¨™é…åˆ†æ©Ÿèƒ½
        function toggleTargetAllocation() {
            targetAllocationEnabled = !targetAllocationEnabled;
            const btn = document.getElementById('allocation-toggle-btn');
            const results = document.getElementById('allocation-results');
            
            if (targetAllocationEnabled) {
                btn.textContent = 'ç›®æ¨™é…åˆ†ON';
                btn.className = 'target-toggle toggle-active';
                results.style.display = 'block';
                updateTargetAllocation();
            } else {
                btn.textContent = 'ç›®æ¨™é…åˆ†OFF';
                btn.className = 'target-toggle toggle-inactive';
                results.style.display = 'none';
            }
            
            document.getElementById('header-allocation-status').textContent = targetAllocationEnabled ? 'ON' : 'OFF';
            document.getElementById('target-status').textContent = targetAllocationEnabled ? 'ç›®æ¨™é…åˆ†ON' : 'ç›®æ¨™é…åˆ†OFF';
        }

        function updateTargetAllocation() {
            if (!targetAllocationEnabled) return;
            
            const totalTarget = parseInt(document.getElementById('total-target').value) || 6000;
            
            const currentProfits = {
                sr: departmentCurrentData.sr.profit || -2800,
                w: departmentCurrentData.w.profit || 2100,
                rc: departmentCurrentData.rc.profit || 1400,
                rcd: departmentCurrentData.rcd.profit || 1000
            };
            
            const allocation = calculateTargetAllocation(currentProfits, totalTarget);
            displayAllocationResults(allocation);
        }

        function calculateTargetAllocation(currentProfits, totalTarget) {
            const currentTotal = Object.values(currentProfits).reduce((sum, val) => sum + val, 0);
            const improvementNeeded = totalTarget - currentTotal;
            
            return {
                sr: { current: currentProfits.sr, target: currentProfits.sr + 1200, strategy: 'æœˆ+100ä¸‡å›ºå®š' },
                w: { current: currentProfits.w, target: currentProfits.w + (improvementNeeded * 0.4), strategy: 'åŠ¹ç‡æ”¹å–„' },
                rc: { current: currentProfits.rc, target: currentProfits.rc + (improvementNeeded * 0.3), strategy: 'åŠ¹ç‡æ”¹å–„' },
                rcd: { current: currentProfits.rcd, target: currentProfits.rcd, strategy: 'è¨ˆç”»å—æ³¨ç¶­æŒ' }
            };
        }

        function displayAllocationResults(allocation) {
            const tableBody = document.getElementById('allocation-table');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            Object.entries(allocation).forEach(([dept, data]) => {
                const improvement = data.target - data.current;
                const salesIncrease = data.current > 0 ? (improvement / data.current * 100) : 0;
                const feasibility = salesIncrease <= 20 ? 'ç¾å®Ÿçš„' : 'å›°é›£';
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${dept.toUpperCase()}</td>
                    <td>${data.strategy}</td>
                    <td>${data.current.toLocaleString()}</td>
                    <td>${data.target.toLocaleString()}</td>
                    <td class="${improvement >= 0 ? 'positive' : 'negative'}">${improvement.toLocaleString()}</td>
                    <td>${salesIncrease.toFixed(1)}%</td>
                    <td class="${feasibility === 'ç¾å®Ÿçš„' ? 'positive' : 'negative'}">${feasibility}</td>
                `;
            });
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        function loadIntegrationData() {
            try {
                const data = IntegrationLinkageManager.loadIntegrationData();
                if (data) {
                    alert(`çµ±åˆPLé€£æºãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ\n\nå£²ä¸Š: ${IntegrationLinkageManager.formatNumber(data.summary.totalSales)}ä¸‡å††\nåˆ©ç›Š: ${IntegrationLinkageManager.formatNumber(data.summary.totalProfit)}ä¸‡å††\nåˆ©ç›Šç‡: ${data.summary.profitRate.toFixed(1)}%\nã‚¢ã‚¯ãƒ†ã‚£ãƒ–äº‹æ¥­éƒ¨: ${data.departments.activeCount}/4\n\nãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${data.version}\næœ€çµ‚æ›´æ–°: ${new Date(data.lastUpdate).toLocaleString()}`);
                } else {
                    alert('çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n\nçµ±åˆPLã‚·ã‚¹ãƒ†ãƒ ï¼ˆcombined-dashboard/index.htmlï¼‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
                }
            } catch (error) {
                console.error('çµ±åˆPLé€£æºç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                alert('çµ±åˆPLé€£æºç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function enableAutoSync() {
            IntegrationLinkageManager.enableAutoSync();
        }

        function refreshDashboardData() {
            try {
                IntegrationLinkageManager.loadIntegrationData();
                
                if (targetAllocationEnabled) {
                    updateTargetAllocation();
                }
                
                alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function exportDebugData() {
            try {
                const debugData = {
                    timestamp: new Date().toISOString(),
                    csvExecutiveData: ExecutiveCompensationManager.csvData,
                    currentExecutiveData: ExecutiveCompensationManager.currentValues,
                    integrationData: IntegrationLinkageManager.lastSyncData,
                    autoSyncEnabled: IntegrationLinkageManager.isAutoSyncEnabled,
                    departmentData: departmentCurrentData,
                    localStorage: {
                        keys: Object.keys(localStorage),
                        sizes: Object.keys(localStorage).map(key => ({
                            key: key,
                            size: localStorage.getItem(key)?.length || 0
                        }))
                    }
                };
                
                const blob = new Blob([JSON.stringify(debugData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard_csv_debug_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
            } catch (error) {
                console.error('ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function toggleDebugMode() {
            const debugSection = document.querySelector('.debug-section');
            if (debugSection) {
                debugSection.style.display = debugSection.style.display === 'none' ? 'block' : 'none';
            }
        }

        // å½¹å“¡å ±é…¬èª¿æ•´é©ç”¨é–¢æ•°
        function applyExecutiveAdjustment() {
            ExecutiveCompensationManager.applyAdjustment();
        }

        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('CSVå®Ÿãƒ‡ãƒ¼ã‚¿å¯¾å¿œãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–é–‹å§‹');
                
                // å½¹å“¡å ±é…¬ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
                ExecutiveCompensationManager.init();
                
                // å€‹åˆ¥äº‹æ¥­éƒ¨ã‚°ãƒ©ãƒ•ä½œæˆ
                setTimeout(() => {
                    departmentCharts.sr = createDepartmentMonthlyChart('sr-monthly-chart', 'sr');
                    departmentCharts.w = createDepartmentMonthlyChart('w-monthly-chart', 'w');
                    departmentCharts.rc = createDepartmentMonthlyChart('rc-monthly-chart', 'rc');
                    departmentCharts.rcd = createDepartmentMonthlyChart('rcd-monthly-chart', 'rcd');
                    
                    console.log('å‰å¹´å®Ÿç¸¾æ¯”è¼ƒã‚°ãƒ©ãƒ•ä½œæˆå®Œäº†');
                }, 100);
                
                // çµ±åˆPLé€£æºãƒ‡ãƒ¼ã‚¿è‡ªå‹•èª­ã¿è¾¼ã¿
                setTimeout(() => {
                    IntegrationLinkageManager.loadIntegrationData();
                }, 500);
                
                // å®šæœŸçš„ãªçµ±åˆPLé€£æºãƒã‚§ãƒƒã‚¯ï¼ˆ30ç§’é–“éš”ï¼‰
                setInterval(() => {
                    if (!IntegrationLinkageManager.isAutoSyncEnabled) {
                        IntegrationLinkageManager.checkForUpdates();
                    }
                }, 30000);
                
                console.log('CSVå®Ÿãƒ‡ãƒ¼ã‚¿å¯¾å¿œç‰ˆåˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®è‡ªå‹•åŒæœŸåœæ­¢
        window.addEventListener('beforeunload', function() {
            if (IntegrationLinkageManager.isAutoSyncEnabled) {
                IntegrationLinkageManager.disableAutoSync();
            }
        });
    </script>
</body>
</html>
