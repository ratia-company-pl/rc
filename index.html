<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆçµ±åˆPLå®Œå…¨é€£å‹•ç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 8px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header-table {
            width: 100%;
            border-collapse: collapse;
            background: #667eea;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .header-table td {
            padding: 8px 12px;
            font-size: 0.85em;
            font-weight: 600;
            vertical-align: middle;
        }

        .header-left {
            text-align: left;
            width: 60%;
        }

        .header-right {
            text-align: right;
            width: 40%;
            font-size: 0.75em;
        }

        .nav-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.98);
        }

        .nav-table td {
            padding: 6px 8px;
            text-align: center;
            border-right: 1px solid #ddd;
        }

        .nav-table td:last-child {
            border-right: none;
        }

        .nav-btn, .action-btn {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.7em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn:hover, .action-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: #4a5bc4;
        }

        .action-btn.reload { background: #e74c3c; }
        .action-btn.export { background: #27ae60; }
        .action-btn.toggle { background: #9b59b6; }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 10px;
            background: white;
        }

        .kpi-card {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .kpi-card.dept { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .kpi-card.common { background: linear-gradient(135deg, #34495e, #2c3e50); color: white; }
        .kpi-card.final-positive { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .kpi-card.final-negative { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .kpi-card.target { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .kpi-card.data-sync { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .kpi-card.data-sync.complete { background: linear-gradient(135deg, #27ae60, #229954); }
        .kpi-card.data-sync.partial { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .kpi-card.data-sync.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .kpi-card.integration-linkage { 
            background: linear-gradient(135deg, #1abc9c, #16a085); 
            color: white;
            border: 2px solid #0e8c73;
        }
        .kpi-card.integration-linkage.active { 
            animation: integrationPulse 2s infinite;
        }

        @keyframes integrationPulse {
            0% { border-color: #0e8c73; }
            50% { border-color: #27ae60; }
            100% { border-color: #0e8c73; }
        }

        .kpi-label {
            font-size: 0.65em;
            margin-bottom: 2px;
            opacity: 0.9;
        }

        .kpi-value {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 1px;
        }

        .kpi-detail {
            font-size: 0.55em;
            opacity: 0.8;
        }

        .data-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 10px;
            font-size: 0.75em;
            display: none;
        }

        .integration-status-bar {
            background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
            color: white;
            padding: 8px 10px;
            margin: 8px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            text-align: center;
            display: none;
        }

        .integration-status-bar.active {
            display: block;
            animation: statusBarSlide 0.5s ease-in-out;
        }

        @keyframes statusBarSlide {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .individual-dept-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .section-title {
            font-size: 0.85em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
            border-left: 3px solid #667eea;
            padding-left: 6px;
        }

        .dept-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .dept-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .dept-card.loaded {
            border-left: 4px solid #27ae60;
        }

        .dept-card.no-data {
            border-left: 4px solid #e74c3c;
            background: #f8f9fa;
        }

        .dept-card.error {
            border-left: 4px solid #fd7e14;
            background: #fff5f0;
        }

        .dept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .dept-name {
            font-size: 0.75em;
            font-weight: bold;
            color: #2c3e50;
        }

        .dept-status {
            font-size: 0.6em;
            padding: 2px 6px;
            border-radius: 10px;
            color: white;
        }

        .status-loaded { background: #27ae60; }
        .status-no-data { background: #e74c3c; }
        .status-error { background: #fd7e14; }

        .dept-metrics {
            font-size: 0.65em;
            color: #666;
        }

        .dept-profit {
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 4px;
        }

        .profit-positive { color: #27ae60; }
        .profit-negative { color: #e74c3c; }

        .comparison-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .comparison-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
        }

        .comparison-header {
            font-size: 0.7em;
            font-weight: bold;
            margin-bottom: 6px;
            color: #495057;
        }

        .comparison-metrics {
            font-size: 0.6em;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
        }

        .metric-item {
            text-align: center;
            padding: 4px;
            background: white;
            border-radius: 3px;
        }

        .metric-label {
            display: block;
            font-size: 0.9em;
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .neutral { color: #6c757d; }

        .chart-section {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        .chart-title {
            font-size: 0.9em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 220px;
        }

        .target-section {
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .target-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .target-toggle {
            padding: 4px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.7em;
            transition: all 0.3s ease;
        }

        .toggle-active {
            background: #27ae60;
            color: white;
        }

        .toggle-inactive {
            background: #bdc3c7;
            color: #7f8c8d;
        }

        .target-input input {
            padding: 3px 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 80px;
            font-size: 0.75em;
        }

        .micro-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65em;
            margin-bottom: 8px;
        }

        .micro-table th,
        .micro-table td {
            padding: 2px 4px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .micro-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
            font-size: 0.6em;
        }

        .micro-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin: 10px;
            padding: 8px;
        }

        .debug-title {
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 6px;
            color: #495057;
        }

        .debug-content {
            font-family: 'Courier New', monospace;
            font-size: 0.65em;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .action-buttons {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Phase 3è¿½åŠ : çµ±åˆPLå®Œå…¨é€£å‹•ã‚¹ã‚¿ã‚¤ãƒ« */
        .integration-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
            animation: integrationSuccess 1.5s ease-in-out;
        }

        .integration-partial {
            background: linear-gradient(135deg, #f39c12, #e67e22) !important;
        }

        .integration-error {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
        }

        @keyframes integrationSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .auto-sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1abc9c;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .auto-sync-indicator.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .dept-grid { grid-template-columns: 1fr; }
            .comparison-grid { grid-template-columns: 1fr; }
            
            .individual-dept-section > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }
            
            .individual-dept-section .dept-grid {
                grid-template-columns: 1fr;
            }
            
            .individual-dept-section canvas {
                height: 100px !important;
            }
            
            .individual-dept-section div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr 1fr !important;
                gap: 4px;
            }
            
            .individual-dept-section .dept-card {
                font-size: 0.9em;
            }
        }
        
        @media (max-width: 480px) {
            .kpi-grid { 
                grid-template-columns: 1fr; 
                gap: 6px;
            }
            
            .individual-dept-section canvas {
                height: 80px !important;
            }
            
            .individual-dept-section > div[style*="grid-template-columns"] {
                gap: 8px;
            }
            
            .individual-dept-section div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 3px;
            }
            
            .section-title {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="auto-sync-indicator" id="auto-sync-indicator">
        ğŸ”„ çµ±åˆPLè‡ªå‹•åŒæœŸä¸­...
    </div>

    <div class="container">
        <table class="header-table">
            <tr>
                <td class="header-left">
                    æœ€çµ‚å–¶æ¥­åˆ©ç›Š <span id="header-final-profit">---</span>ä¸‡å††ï¼ˆå…±é€šçµŒè²»æ§é™¤å¾Œãƒ»ç›®æ¨™é…åˆ†<span id="header-allocation-status">OFF</span>ï¼‰
                </td>
                <td class="header-right">
                    4äº‹æ¥­éƒ¨çµ±åˆPLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Step1-4å®Œå…¨ç‰ˆï¼ˆçµ±åˆPLå®Œå…¨é€£å‹•ç‰ˆï¼‰
                </td>
            </tr>
        </table>

        <table class="nav-table">
            <tr>
                <td><button class="nav-btn active">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button></td>
                <td><button class="nav-btn" onclick="location.href='budget-input.html'">äºˆç®—å…¥åŠ›</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/sr-pl.html'">SRäº‹æ¥­éƒ¨PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/w-pl.html'">Wäº‹æ¥­éƒ¨PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/rc-pl.html'">RCå¸äº‹æ¥­éƒ¨PL</button></td>
                <td><button class="nav-btn" onclick="location.href='department-pl/rcd-pl.html'">RCDç¤¾äº‹æ¥­éƒ¨PL</button></td>
                <td><button class="nav-btn" onclick="location.href='combined-dashboard/index.html'">å…¨ä½“PLåˆ†æ</button></td>
            </tr>
        </table>

        <div class="data-warning" id="data-warning"></div>

        <div class="integration-status-bar" id="integration-status-bar">
            <strong>ğŸ”— çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ é€£æº:</strong> 
            <span id="integration-status-text">å¾…æ©Ÿä¸­</span> | 
            <span id="integration-last-update">æœ€çµ‚æ›´æ–°: --:--</span> |
            <span id="integration-data-version">Phase3å®Œå…¨ç‰ˆ</span>
        </div>

        <div class="chart-section">
            <div class="chart-title">æœˆæ¬¡åˆ©ç›Šæ¨ç§»ï¼ˆçµ±åˆPLãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€£å‹•å¯¾å¿œï¼‰</div>
            <div class="chart-wrapper">
                <canvas id="monthly-profit-chart"></canvas>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card dept">
                <div class="kpi-label">çµ±åˆå¹´é–“å£²ä¸Š</div>
                <div class="kpi-value" id="dept-total-sales">---ä¸‡å††</div>
                <div class="kpi-detail">4äº‹æ¥­éƒ¨åˆè¨ˆ</div>
            </div>
            <div class="kpi-card common">
                <div class="kpi-label">å¹´é–“å…±é€šçµŒè²»</div>
                <div class="kpi-value" id="common-expenses-total">-10,342ä¸‡å††</div>
                <div class="kpi-detail">å½¹å“¡å ±é…¬ãƒ»è«¸çµŒè²»</div>
            </div>
            <div class="kpi-card final-positive" id="final-card">
                <div class="kpi-label">æœ€çµ‚å–¶æ¥­åˆ©ç›Š</div>
                <div class="kpi-value" id="final-profit">---ä¸‡å††</div>
                <div class="kpi-detail">å…±é€šçµŒè²»æ§é™¤å¾Œ</div>
            </div>
            <div class="kpi-card target">
                <div class="kpi-label">ç›®æ¨™é”æˆç‡</div>
                <div class="kpi-value" id="target-achievement">---%</div>
                <div class="kpi-detail" id="target-status">ç›®æ¨™é…åˆ†OFF</div>
            </div>
            <div class="kpi-card integration-linkage" id="integration-linkage-card">
                <div class="kpi-label">çµ±åˆPLé€£æº</div>
                <div class="kpi-value" id="integration-linkage-status">å¾…æ©Ÿä¸­</div>
                <div class="kpi-detail" id="integration-linkage-detail">è‡ªå‹•åŒæœŸ</div>
            </div>
            <div class="kpi-card data-sync" id="data-sync-card">
                <div class="kpi-label">ãƒ‡ãƒ¼ã‚¿å–å¾—çŠ¶æ³</div>
                <div class="kpi-value" id="data-sync-status">0/4éƒ¨é–€</div>
                <div class="kpi-detail" id="last-sync-time">æœ€çµ‚æ›´æ–°: --:--</div>
            </div>
        </div>

        <div class="individual-dept-section">
            <div class="section-title">Step2-3: å„äº‹æ¥­éƒ¨å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ»åˆ†æï¼ˆçµ±åˆPLå®Œå…¨é€£å‹•ç‰ˆï¼‰</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <!-- å·¦å´ï¼šä¸»è¦3äº‹æ¥­éƒ¨æœˆæ¬¡ã‚°ãƒ©ãƒ• -->
                <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6;">
                    <div style="font-size: 0.75em; font-weight: 700; margin-bottom: 8px; color: #2c3e50;">ä¸»è¦3äº‹æ¥­éƒ¨ æœˆæ¬¡æ¨ç§»ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿åæ˜ ï¼‰</div>
                    
                    <!-- SRäº‹æ¥­éƒ¨ã‚°ãƒ©ãƒ• -->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 0.7em; font-weight: bold; color: #e74c3c; margin-bottom: 4px;">SRäº‹æ¥­éƒ¨</div>
                        <div style="position: relative; height: 120px; background: #f8f9fa; border-radius: 4px;">
                            <canvas id="sr-monthly-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Wäº‹æ¥­éƒ¨ã‚°ãƒ©ãƒ• -->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 0.7em; font-weight: bold; color: #3498db; margin-bottom: 4px;">Wäº‹æ¥­éƒ¨</div>
                        <div style="position: relative; height: 120px; background: #f8f9fa; border-radius: 4px;">
                            <canvas id="w-monthly-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- RCå¸äº‹æ¥­éƒ¨ã‚°ãƒ©ãƒ• -->
                    <div style="margin-bottom: 8px;">
                        <div style="font-size: 0.7em; font-weight: bold; color: #27ae60; margin-bottom: 4px;">RCå¸äº‹æ¥­éƒ¨</div>
                        <div style="position: relative; height: 120px; background: #f8f9fa; border-radius: 4px;">
                            <canvas id="rc-monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- å³å´ï¼šKPIæŒ‡æ¨™ã¾ã¨ã‚ï¼‹RCDç¤¾ã‚°ãƒ©ãƒ• -->
                <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6;">
                    <div style="font-size: 0.75em; font-weight: 700; margin-bottom: 8px; color: #2c3e50;">KPIæŒ‡æ¨™ã‚µãƒãƒªãƒ¼ï¼ˆçµ±åˆPLé€£å‹•ï¼‰</div>
                    
                    <div class="dept-grid" id="department-kpi-grid">
                        <!-- å‹•çš„ç”Ÿæˆã•ã‚Œã‚‹KPIæŒ‡æ¨™ã‚«ãƒ¼ãƒ‰ -->
                    </div>
                    
                    <!-- å…¨ä½“ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™ -->
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 12px;">
                        <div style="font-size: 0.7em; font-weight: bold; margin-bottom: 4px; color: #495057;">å…¨ä½“ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 0.6em;">
                            <div style="background: white; padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: #666;">ãƒ‡ãƒ¼ã‚¿å–å¾—ç‡</div>
                                <div id="overall-data-rate" style="font-weight: bold; color: #3498db;">--%</div>
                            </div>
                            <div style="background: white; padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: #666;">å¹³å‡åˆ©ç›Šç‡</div>
                                <div id="overall-profit-margin" style="font-weight: bold; color: #27ae60;">--%</div>
                            </div>
                            <div style="background: white; padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: #666;">å‰å¹´æ¯”æˆé•·</div>
                                <div id="overall-growth-rate" style="font-weight: bold; color: #9b59b6;">--%</div>
                            </div>
                            <div style="background: white; padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: #666;">é»’å­—éƒ¨é–€æ•°</div>
                                <div id="profitable-dept-count" style="font-weight: bold; color: #e74c3c;">-/-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RCDç¤¾ã‚°ãƒ©ãƒ•ï¼ˆè£œåŠ©ï¼‰ -->
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; border: 1px solid #e0e0e0;">
                        <div style="font-size: 0.65em; font-weight: bold; color: #9b59b6; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between;">
                            <span>RCDç¤¾äº‹æ¥­éƒ¨ï¼ˆè¨ˆç”»å—æ³¨ï¼‰</span>
                            <span style="font-size: 0.9em; background: #9b59b6; color: white; padding: 1px 4px; border-radius: 6px;">è£œåŠ©</span>
                        </div>
                        <div style="position: relative; height: 80px; background: white; border-radius: 4px;">
                            <canvas id="rcd-monthly-chart"></canvas>
                        </div>
                        <div style="font-size: 0.55em; color: #666; margin-top: 2px; text-align: center;">
                            â€»è¨ˆç”»å—æ³¨ã®ãŸã‚äºˆç®—å¤‰å‹•ã¯å°‘ãªã„
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="target-section">
            <div class="section-title">ç›®æ¨™é…åˆ†æ©Ÿèƒ½ï¼ˆæå¤±åœ§ç¸®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰</div>
            
            <div class="target-controls">
                <button id="allocation-toggle-btn" class="target-toggle toggle-inactive" onclick="toggleTargetAllocation()">
                    ç›®æ¨™é…åˆ†OFF
                </button>
                <div class="target-input">
                    <label style="font-size: 0.7em;">å¹´é–“ç›®æ¨™:</label>
                    <input type="number" id="total-target" value="6000" step="100" onchange="updateTargetAllocation()">
                    <span style="font-size: 0.7em;">ä¸‡å††</span>
                </div>
            </div>

            <div id="allocation-results" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <table class="micro-table">
                            <thead>
                                <tr>
                                    <th>äº‹æ¥­éƒ¨</th>
                                    <th>æˆ¦ç•¥</th>
                                    <th>ç¾åœ¨åˆ©ç›Š</th>
                                    <th>ç›®æ¨™åˆ©ç›Š</th>
                                    <th>æ”¹å–„é¡</th>
                                    <th>å£²ä¸Šå¢—ç‡</th>
                                    <th>ç¾å®Ÿæ€§</th>
                                </tr>
                            </thead>
                            <tbody id="allocation-table">
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <div style="font-size: 0.7em; font-weight: 600; margin-bottom: 8px; text-align: center; color: #2c3e50;">åˆ©ç›Šæ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ</div>
                        <div style="position: relative; height: 200px;">
                            <canvas id="profit-comparison-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 6px; border-radius: 4px; font-size: 0.65em; margin-top: 6px;">
                    <strong>é…åˆ†ãƒ­ã‚¸ãƒƒã‚¯:</strong>
                    èµ¤å­—äº‹æ¥­éƒ¨ï¼ˆSRï¼‰:æœˆ+100ä¸‡å›ºå®š | é»’å­—äº‹æ¥­éƒ¨ï¼ˆWãƒ»RCå¸ï¼‰:åŠ¹ç‡é…åˆ† | RCDç¤¾:è¨ˆç”»å—æ³¨ã«ã‚ˆã‚Šé™¤å¤– | åˆ¶ç´„:å£²ä¸Šå¢—20%ä¸Šé™
                </div>
            </div>
        </div>

        <div class="debug-section">
            <div class="debug-title">Phase 3çµ±åˆPLå®Œå…¨é€£å‹•ãƒ‡ãƒãƒƒã‚°: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸçŠ¶æ³</div>
            <div class="debug-content" id="debug-output">
                èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn reload" onclick="refreshDashboardData()">å…¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
            <button class="action-btn export" onclick="exportDebugData()">ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›</button>
            <button class="action-btn toggle" onclick="toggleDebugMode()">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡æ›¿</button>
            <button class="action-btn" style="background: #1abc9c;" onclick="loadIntegrationData()">ğŸ”— çµ±åˆPLé€£æºç¢ºèª</button>
            <button class="action-btn" style="background: #e67e22;" onclick="enableAutoSync()">ğŸ”„ è‡ªå‹•åŒæœŸé–‹å§‹</button>
        </div>
    </div>

    <script>
        // ===== ã€ä¿è­·é ˜åŸŸé–‹å§‹ã€‘çµ¶å¯¾ã«å¤‰æ›´ç¦æ­¢ =====
        // LocalStorageã‚­ãƒ¼ç®¡ç† - çµ±åˆã‚·ã‚¹ãƒ†ãƒ ç”¨
        const STORAGE_KEYS = {
            sr: 'pl_system_sr_data',
            w: 'pl_system_w_data',
            rc: 'pl_system_rc_data',
            rcd: 'pl_system_rcd_data',
            executive: 'pl_system_executive_data',
            
            // Phase 3è¿½åŠ : ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é€£æºå°‚ç”¨ã‚­ãƒ¼
            dashboard_integration: 'dashboard_integration_data'
        };
        // ===== ã€ä¿è­·é ˜åŸŸçµ‚äº†ã€‘ =====

        // Phase 3å®Œå…¨å®Ÿè£…: çµ±åˆPLå®Œå…¨é€£å‹•ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        const IntegrationLinkageManager = {
            autoSyncInterval: null,
            isAutoSyncEnabled: false,
            lastSyncData: null,

            // çµ±åˆPLãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ©Ÿèƒ½ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
            loadIntegrationData: function() {
                try {
                    const integrationData = localStorage.getItem(STORAGE_KEYS.dashboard_integration);
                    if (integrationData) {
                        const data = JSON.parse(integrationData);
                        
                        // ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
                        if (data.version !== 'Phase3-Complete') {
                            console.warn('çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:', data.version);
                        }

                        this.updateDashboardFromIntegration(data);
                        this.updateIntegrationStatus('çµ±åˆPLã¨é€£æºä¸­', 'success');
                        this.lastSyncData = data;
                        
                        this.logDebug('çµ±åˆPLãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ', {
                            version: data.version,
                            departments: data.departments.activeCount,
                            lastUpdate: data.lastUpdate
                        });
                        
                        return data;
                    } else {
                        this.updateIntegrationStatus('çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãªã—', 'waiting');
                        this.logDebug('çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        return null;
                    }
                } catch (error) {
                    console.error('çµ±åˆPLé€£æºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateIntegrationStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
                    this.logDebug('çµ±åˆPLé€£æºã‚¨ãƒ©ãƒ¼', error.message);
                    return null;
                }
            },

            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆPLãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°ï¼ˆå®Œå…¨ç‰ˆï¼‰
            updateDashboardFromIntegration: function(integrationData) {
                try {
                    // åŸºæœ¬KPIæ›´æ–°
                    this.updateElement('dept-total-sales', `${this.formatNumber(integrationData.summary.totalSales)}ä¸‡å††`);
                    this.updateElement('final-profit', `${this.formatNumber(integrationData.summary.totalProfit)}ä¸‡å††`);
                    this.updateElement('header-final-profit', this.formatNumber(integrationData.summary.totalProfit));
                    
                    // çµ±åˆPLé€£æºã‚«ãƒ¼ãƒ‰æ›´æ–°
                    this.updateElement('integration-linkage-status', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–');
                    this.updateElement('integration-linkage-detail', `åˆ©ç›Šç‡: ${integrationData.summary.profitRate.toFixed(1)}%`);
                    
                    // æœ€çµ‚åˆ©ç›Šã‚«ãƒ¼ãƒ‰ã®è‰²å¤‰æ›´
                    const finalCard = document.getElementById('final-card');
                    if (finalCard) {
                        finalCard.className = 'kpi-card ' + (integrationData.summary.totalProfit >= 0 ? 'final-positive' : 'final-negative');
                    }

                    // çµ±åˆPLé€£æºã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    const linkageCard = document.getElementById('integration-linkage-card');
                    if (linkageCard) {
                        linkageCard.className = 'kpi-card integration-linkage active';
                    }

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼è¡¨ç¤º
                    const statusBar = document.getElementById('integration-status-bar');
                    if (statusBar) {
                        statusBar.className = 'integration-status-bar active';
                    }

                    // ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                    this.updateElement('data-sync-status', `${integrationData.departments.activeCount}/4éƒ¨é–€`);
                    const syncCard = document.getElementById('data-sync-card');
                    if (syncCard) {
                        syncCard.className = `kpi-card data-sync ${
                            integrationData.departments.activeCount === 4 ? 'complete' : 
                            integrationData.departments.activeCount > 0 ? 'partial' : 'error'
                        }`;
                    }

                    // æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
                    if (integrationData.monthlyData) {
                        this.updateMonthlyChart(integrationData.monthlyData);
                    }

                    // å„äº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                    if (integrationData.departments && integrationData.departments.list) {
                        this.updateDepartmentKPIs(integrationData);
                    }

                    this.logDebug('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°å®Œäº†ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿ï¼‰', {
                        å£²ä¸Š: integrationData.summary.totalSales,
                        åˆ©ç›Š: integrationData.summary.totalProfit,
                        åˆ©ç›Šç‡: integrationData.summary.profitRate,
                        ã‚¢ã‚¯ãƒ†ã‚£ãƒ–éƒ¨é–€: integrationData.departments.activeCount
                    });

                } catch (error) {
                    console.error('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateIntegrationStatus('æ›´æ–°ã‚¨ãƒ©ãƒ¼', 'error');
                    this.logDebug('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼', error.message);
                }
            },

            // æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
            updateMonthlyChart: function(monthlyData) {
                try {
                    const ctx = document.getElementById('monthly-profit-chart');
                    if (!ctx) return;

                    // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
                    if (window.monthlyProfitChart) {
                        window.monthlyProfitChart.destroy();
                    }

                    const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];

                    window.monthlyProfitChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'çµ±åˆå–¶æ¥­åˆ©ç›Š',
                                    data: monthlyData.profit || Array(12).fill(0),
                                    borderColor: '#e74c3c',
                                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'çµ±åˆå£²ä¸Šé«˜',
                                    data: monthlyData.sales || Array(12).fill(0),
                                    borderColor: '#3498db',
                                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                    borderWidth: 2,
                                    fill: false,
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'ä¸‡å††';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'å£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    });

                    this.logDebug('æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°å®Œäº†ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿ï¼‰');
                } catch (error) {
                    console.error('æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    this.logDebug('æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼', error.message);
                }
            },

            // äº‹æ¥­éƒ¨KPIæ›´æ–°ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
            updateDepartmentKPIs: function(integrationData) {
                try {
                    const gridElement = document.getElementById('department-kpi-grid');
                    if (!gridElement) return;

                    gridElement.innerHTML = '';
                    
                    const deptMapping = {
                        'SR': { name: 'SRäº‹æ¥­éƒ¨', key: 'sr' },
                        'W': { name: 'Wäº‹æ¥­éƒ¨', key: 'w' },
                        'RCå¸': { name: 'RCå¸äº‹æ¥­éƒ¨', key: 'rc' },
                        'RCDç¤¾': { name: 'RCDç¤¾äº‹æ¥­éƒ¨', key: 'rcd' }
                    };

                    integrationData.departments.list.forEach(deptName => {
                        const deptInfo = deptMapping[deptName];
                        if (!deptInfo) return;

                        const card = document.createElement('div');
                        card.className = 'dept-card loaded';
                        card.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                <div style="font-size: 0.7em; font-weight: bold; color: #2c3e50;">${deptInfo.name}</div>
                                <div style="font-size: 0.55em; padding: 1px 4px; border-radius: 8px; background: #27ae60; color: white;">çµ±åˆæ¸ˆ</div>
                            </div>
                            <div style="font-size: 0.6em; color: #666; margin-bottom: 2px;">
                                çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰å–å¾—æ¸ˆ
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.6em;">
                                <span>Phase3é€£å‹•</span>
                                <span style="font-weight: bold; color: #27ae60;">âœ“ å®Œäº†</span>
                            </div>
                        `;
                        gridElement.appendChild(card);
                    });

                    this.logDebug('äº‹æ¥­éƒ¨KPIæ›´æ–°å®Œäº†', { éƒ¨é–€æ•°: integrationData.departments.list.length });
                } catch (error) {
                    console.error('äº‹æ¥­éƒ¨KPIæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    this.logDebug('äº‹æ¥­éƒ¨KPIæ›´æ–°ã‚¨ãƒ©ãƒ¼', error.message);
                }
            },

            // çµ±åˆé€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateIntegrationStatus: function(message, status) {
                try {
                    const statusText = document.getElementById('integration-status-text');
                    const lastUpdate = document.getElementById('integration-last-update');
                    const dataVersion = document.getElementById('integration-data-version');
                    
                    if (statusText) {
                        statusText.textContent = message;
                    }
                    
                    if (lastUpdate && status === 'success') {
                        lastUpdate.textContent = `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleTimeString()}`;
                    }

                    if (dataVersion && status === 'success') {
                        dataVersion.textContent = 'Phase3å®Œå…¨ç‰ˆ';
                    }

                    this.logDebug(`çµ±åˆPLé€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${status} - ${message}`);
                } catch (error) {
                    console.error('çµ±åˆé€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            },

            // è‡ªå‹•åŒæœŸæ©Ÿèƒ½
            enableAutoSync: function() {
                if (this.isAutoSyncEnabled) {
                    this.disableAutoSync();
                    return;
                }

                this.isAutoSyncEnabled = true;
                this.showAutoSyncIndicator();
                
                // 5ç§’é–“éš”ã§çµ±åˆPLãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
                this.autoSyncInterval = setInterval(() => {
                    this.checkForUpdates();
                }, 5000);

                this.logDebug('è‡ªå‹•åŒæœŸé–‹å§‹');
                alert('çµ±åˆPLè‡ªå‹•åŒæœŸã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚5ç§’é–“éš”ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¾ã™ã€‚');
            },

            disableAutoSync: function() {
                if (this.autoSyncInterval) {
                    clearInterval(this.autoSyncInterval);
                    this.autoSyncInterval = null;
                }
                this.isAutoSyncEnabled = false;
                this.hideAutoSyncIndicator();
                this.logDebug('è‡ªå‹•åŒæœŸåœæ­¢');
                alert('çµ±åˆPLè‡ªå‹•åŒæœŸã‚’åœæ­¢ã—ã¾ã—ãŸã€‚');
            },

            checkForUpdates: function() {
                try {
                    const currentData = localStorage.getItem(STORAGE_KEYS.dashboard_integration);
                    if (!currentData) return;

                    const data = JSON.parse(currentData);
                    
                    // å‰å›ã¨ç•°ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã‹ãƒã‚§ãƒƒã‚¯
                    if (!this.lastSyncData || 
                        data.lastUpdate !== this.lastSyncData.lastUpdate ||
                        JSON.stringify(data.summary) !== JSON.stringify(this.lastSyncData.summary)) {
                        
                        this.updateDashboardFromIntegration(data);
                        this.lastSyncData = data;
                        this.showAutoSyncIndicator();
                        
                        this.logDebug('è‡ªå‹•åŒæœŸ: ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¤œå‡º', {
                            æ›´æ–°æ™‚åˆ»: data.lastUpdate,
                            å£²ä¸Š: data.summary.totalSales,
                            åˆ©ç›Š: data.summary.totalProfit
                        });

                        setTimeout(() => this.hideAutoSyncIndicator(), 2000);
                    }
                } catch (error) {
                    console.error('è‡ªå‹•åŒæœŸãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                }
            },

            showAutoSyncIndicator: function() {
                const indicator = document.getElementById('auto-sync-indicator');
                if (indicator) {
                    indicator.className = 'auto-sync-indicator show';
                }
            },

            hideAutoSyncIndicator: function() {
                const indicator = document.getElementById('auto-sync-indicator');
                if (indicator) {
                    indicator.className = 'auto-sync-indicator';
                }
            },

            // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
            updateElement: function(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                }
            },

            formatNumber: function(num) {
                if (isNaN(num) || num === null || num === undefined) return '0';
                return Math.round(num).toLocaleString();
            },

            logDebug: function(message, data = null) {
                console.log(`[çµ±åˆPLé€£æº] ${message}`, data || '');
                const debugElement = document.getElementById('debug-output');
                if (debugElement) {
                    const timestamp = new Date().toLocaleTimeString();
                    debugElement.innerHTML += `<br>[${timestamp}] çµ±åˆPLé€£æº: ${message}`;
                    if (data) {
                        debugElement.innerHTML += `<br>ã€€ã€€ã€€ã€€ã€€ã€€ã€€${JSON.stringify(data, null, 2)}`;
                    }
                }
            }
        };

        // Phase 3çµ±åˆPLé€£æºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
        function loadIntegrationData() {
            try {
                const data = IntegrationLinkageManager.loadIntegrationData();
                if (data) {
                    alert(`çµ±åˆPLé€£æºãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ\n\nå£²ä¸Š: ${IntegrationLinkageManager.formatNumber(data.summary.totalSales)}ä¸‡å††\nåˆ©ç›Š: ${IntegrationLinkageManager.formatNumber(data.summary.totalProfit)}ä¸‡å††\nåˆ©ç›Šç‡: ${data.summary.profitRate.toFixed(1)}%\nã‚¢ã‚¯ãƒ†ã‚£ãƒ–äº‹æ¥­éƒ¨: ${data.departments.activeCount}/4\n\nãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${data.version}\næœ€çµ‚æ›´æ–°: ${new Date(data.lastUpdate).toLocaleString()}`);
                } else {
                    alert('çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n\nçµ±åˆPLã‚·ã‚¹ãƒ†ãƒ ï¼ˆcombined-dashboard/index.htmlï¼‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚\n\nç¢ºèªæ‰‹é †:\n1. çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹\n2. ã€Œãƒ‡ãƒ¼ã‚¿çµ±åˆæ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n3. ã€ŒğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é€£æºé€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯\n4. å†åº¦ã“ã®ç”»é¢ã§é€£æºç¢ºèªã‚’å®Ÿè¡Œ');
                }
            } catch (error) {
                console.error('çµ±åˆPLé€£æºç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                alert('çµ±åˆPLé€£æºç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // è‡ªå‹•åŒæœŸé–‹å§‹ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
        function enableAutoSync() {
            IntegrationLinkageManager.enableAutoSync();
        }

        // Step1å®Ÿè£…: å‹•çš„ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½ï¼ˆæ—¢å­˜ã®ã¾ã¾ç¶™æ‰¿ï¼‰
        const DynamicDataManager = {
            loadDepartmentDataFromStorage: function() {
                const departmentData = {};
                const debugInfo = [];
                
                Object.entries(STORAGE_KEYS).forEach(([dept, storageKey]) => {
                    if (dept === 'executive' || dept === 'dashboard_integration') return;
                    
                    try {
                        const storedData = localStorage.getItem(storageKey);
                        debugInfo.push(`[${dept}] ã‚­ãƒ¼: ${storageKey}`);
                        
                        if (storedData) {
                            const parsedData = JSON.parse(storedData);
                            departmentData[dept] = {
                                name: this.getDepartmentName(dept),
                                rawData: parsedData,
                                monthlyProfit: this.extractMonthlyProfit(parsedData),
                                monthlyRevenue: this.extractMonthlyRevenue(parsedData),
                                annualProfit: this.calculateAnnualProfit(parsedData),
                                annualRevenue: this.calculateAnnualRevenue(parsedData),
                                lastUpdated: parsedData.timestamp || parsedData.lastUpdate,
                                dataStatus: 'loaded',
                                dataSize: JSON.stringify(parsedData).length,
                                profitMargin: this.calculateProfitMargin(parsedData)
                            };
                            debugInfo.push(`[${dept}] âœ“ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ (${departmentData[dept].dataSize}æ–‡å­—)`);
                            debugInfo.push(`[${dept}] å¹´é–“åˆ©ç›Š: ${departmentData[dept].annualProfit}ä¸‡å††`);
                        } else {
                            departmentData[dept] = {
                                name: this.getDepartmentName(dept),
                                dataStatus: 'no_data'
                            };
                            debugInfo.push(`[${dept}] âœ— ãƒ‡ãƒ¼ã‚¿ãªã—`);
                        }
                    } catch (error) {
                        console.error(`${dept}ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
                        departmentData[dept] = {
                            name: this.getDepartmentName(dept),
                            dataStatus: 'error',
                            errorMessage: error.message
                        };
                        debugInfo.push(`[${dept}] âœ— ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    }
                });
                
                this.updateDebugOutput(debugInfo);
                return departmentData;
            },

            getDepartmentName: function(deptKey) {
                const nameMap = {
                    'sr': 'SRäº‹æ¥­éƒ¨',
                    'w': 'Wäº‹æ¥­éƒ¨',
                    'rc': 'RCå¸äº‹æ¥­éƒ¨',
                    'rcd': 'RCDç¤¾äº‹æ¥­éƒ¨'
                };
                return nameMap[deptKey] || deptKey;
            },

            extractMonthlyProfit: function(data) {
                const monthlyProfit = {};
                const monthNames = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
                
                if (data.monthlyProfit) {
                    return data.monthlyProfit;
                }
                
                if (data.monthlyData) {
                    monthNames.forEach(month => {
                        if (data.monthlyData[month] && data.monthlyData[month].profit !== undefined) {
                            monthlyProfit[month] = data.monthlyData[month].profit;
                        }
                    });
                }
                
                return monthlyProfit;
            },

            extractMonthlyRevenue: function(data) {
                const monthlyRevenue = {};
                const monthNames = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
                
                if (data.monthlyRevenue) {
                    return data.monthlyRevenue;
                }
                
                if (data.monthlyData) {
                    monthNames.forEach(month => {
                        if (data.monthlyData[month] && data.monthlyData[month].revenue !== undefined) {
                            monthlyRevenue[month] = data.monthlyData[month].revenue;
                        }
                    });
                }
                
                return monthlyRevenue;
            },

            calculateAnnualProfit: function(data) {
                if (data.annualProfit !== undefined) {
                    return data.annualProfit;
                }
                
                const monthlyProfit = this.extractMonthlyProfit(data);
                return Object.values(monthlyProfit).reduce((sum, val) => sum + (val || 0), 0);
            },

            calculateAnnualRevenue: function(data) {
                if (data.annualRevenue !== undefined) {
                    return data.annualRevenue;
                }
                
                const monthlyRevenue = this.extractMonthlyRevenue(data);
                return Object.values(monthlyRevenue).reduce((sum, val) => sum + (val || 0), 0);
            },

            calculateProfitMargin: function(data) {
                const profit = this.calculateAnnualProfit(data);
                const revenue = this.calculateAnnualRevenue(data);
                
                return revenue > 0 ? ((profit / revenue) * 100) : 0;
            },

            updateDebugOutput: function(debugInfo) {
                const debugElement = document.getElementById('debug-output');
                if (debugElement) {
                    debugElement.innerHTML = `
                        <div><strong>Phase 3çµ±åˆPLå®Œå…¨é€£å‹•å‡¦ç†çµæœ (${new Date().toLocaleString()})</strong></div>
                        <div>LocalStorageç¢ºèªçµæœ:</div>
                        ${debugInfo.map(info => `<div style="margin-left: 10px;">${info}</div>`).join('')}
                        <div style="margin-top: 8px;"><strong>å‡¦ç†å®Œäº†æ©Ÿèƒ½:</strong></div>
                        <div style="margin-left: 10px;">âœ“ Step1: å‹•çš„ãƒ‡ãƒ¼ã‚¿å–å¾—</div>
                        <div style="margin-left: 10px;">âœ“ Step2: ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º</div>
                        <div style="margin-left: 10px;">âœ“ Step3: äº‹æ¥­éƒ¨æœˆæ¬¡ã‚°ãƒ©ãƒ•ï¼‹KPIè¡¨ç¤º</div>
                        <div style="margin-left: 10px;">âœ“ ç›®æ¨™é…åˆ†æ©Ÿèƒ½å¾©æ—§</div>
                        <div style="margin-left: 10px;">âœ“ æœˆæ¬¡åˆ©ç›Šæ¨ç§»ã‚°ãƒ©ãƒ•</div>
                        <div style="margin-left: 10px;">âœ“ Phase 3: çµ±åˆPLå®Œå…¨é€£æºæ©Ÿèƒ½</div>
                        <div style="margin-left: 10px;">âœ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è‡ªå‹•åŒæœŸå¯¾å¿œ</div>
                    `;
                }
            }
        };

        // Step2å®Ÿè£…: ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼ˆçµ±åˆPLå¯¾å¿œæ”¹è‰¯ç‰ˆï¼‰
        const DataSyncManager = {
            updateDataSyncStatus: function() {
                // çµ±åˆPLãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯
                const integrationData = IntegrationLinkageManager.loadIntegrationData();
                if (integrationData) {
                    // çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    this.updateFromIntegrationData(integrationData);
                    return { loadedCount: integrationData.departments.activeCount, totalCount: 4, departmentData: {} };
                }

                // çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
                const departmentData = DynamicDataManager.loadDepartmentDataFromStorage();
                let loadedCount = 0;
                let totalCount = 0;
                let latestUpdate = null;
                const statusDetails = [];

                Object.entries(departmentData).forEach(([dept, data]) => {
                    totalCount++;
                    if (data.dataStatus === 'loaded') {
                        loadedCount++;
                        statusDetails.push(`${data.name}: âœ“`);
                        
                        if (data.lastUpdated) {
                            const updateTime = new Date(data.lastUpdated);
                            if (!latestUpdate || updateTime > new Date(latestUpdate)) {
                                latestUpdate = data.lastUpdated;
                            }
                        }
                    } else {
                        statusDetails.push(`${data.name}: ${data.dataStatus === 'no_data' ? 'æœªå–å¾—' : 'ã‚¨ãƒ©ãƒ¼'}`);
                    }
                });

                // UIæ›´æ–°
                this.updateElement('data-sync-status', `${loadedCount}/${totalCount}éƒ¨é–€`);
                this.updateElement('last-sync-time', latestUpdate ? 
                    `æœ€çµ‚æ›´æ–°: ${new Date(latestUpdate).toLocaleString()}` : 
                    'æœ€çµ‚æ›´æ–°: æœªå–å¾—');

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ã®çŠ¶æ…‹å¤‰æ›´
                const statusCard = document.getElementById('data-sync-card');
                if (statusCard) {
                    statusCard.className = `kpi-card data-sync ${
                        loadedCount === totalCount ? 'complete' : 
                        loadedCount > 0 ? 'partial' : 'error'
                    }`;
                }

                // è­¦å‘Šè¡¨ç¤ºç®¡ç†
                this.manageDataWarning(loadedCount, totalCount, statusDetails);
                
                return { loadedCount, totalCount, departmentData };
            },

            updateFromIntegrationData: function(integrationData) {
                this.updateElement('data-sync-status', `${integrationData.departments.activeCount}/4éƒ¨é–€`);
                this.updateElement('last-sync-time', `æœ€çµ‚æ›´æ–°: ${new Date(integrationData.lastUpdate).toLocaleString()}`);

                const statusCard = document.getElementById('data-sync-card');
                if (statusCard) {
                    statusCard.className = `kpi-card data-sync ${
                        integrationData.departments.activeCount === 4 ? 'complete' : 
                        integrationData.departments.activeCount > 0 ? 'partial' : 'error'
                    }`;
                }

                // çµ±åˆPLé€£æºæˆåŠŸã®è¡¨ç¤º
                const warningDiv = document.getElementById('data-warning');
                if (warningDiv) {
                    warningDiv.innerHTML = `
                        <strong>ğŸ”— çµ±åˆPLå®Œå…¨é€£å‹•:</strong> 
                        çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰${integrationData.departments.activeCount}éƒ¨é–€ã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«é€£æºã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸå¯¾å¿œã€‚<br>
                        <div style="margin-top: 4px; font-size: 0.9em;">
                            é€£æºéƒ¨é–€: ${integrationData.departments.list.join(' | ')} | ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${integrationData.version}
                        </div>
                    `;
                    warningDiv.style.display = 'block';
                    warningDiv.style.background = '#d1ecf1';
                    warningDiv.style.borderColor = '#bee5eb';
                    warningDiv.style.color = '#0c5460';
                }
            },

            manageDataWarning: function(loadedCount, totalCount, statusDetails) {
                const warningDiv = document.getElementById('data-warning');
                
                if (loadedCount < totalCount) {
                    const missingCount = totalCount - loadedCount;
                    warningDiv.innerHTML = `
                        <strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿ä¸å®Œå…¨:</strong> 
                        ${missingCount}éƒ¨é–€ã®ãƒ‡ãƒ¼ã‚¿ãŒæœªå–å¾—ã§ã™ã€‚å„äº‹æ¥­éƒ¨PLãƒšãƒ¼ã‚¸ã§ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>
                        <div style="margin-top: 4px; font-size: 0.9em;">
                            ${statusDetails.join(' | ')}
                        </div>
                    `;
                    warningDiv.style.display = 'block';
                } else {
                    warningDiv.innerHTML = `
                        <strong>âœ… ãƒ‡ãƒ¼ã‚¿å®Œäº†:</strong> 
                        å…¨äº‹æ¥­éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚Phase 3å®Œå…¨é€£å‹•æ©Ÿèƒ½ãŒå®Œå…¨å‹•ä½œä¸­ã€‚
                    `;
                    warningDiv.style.display = 'block';
                    warningDiv.style.background = '#d4edda';
                    warningDiv.style.borderColor = '#c3e6cb';
                    warningDiv.style.color = '#155724';
                    
                    setTimeout(() => {
                        warningDiv.style.display = 'none';
                    }, 3000);
                }
            },

            updateElement: function(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                }
            }
        };

        // æ—¢å­˜ã®æ©Ÿèƒ½ç¶™æ‰¿ï¼ˆç›®æ¨™é…åˆ†ç­‰ï¼‰
        let targetAllocationEnabled = false;
        let departmentCharts = {};

        function toggleTargetAllocation() {
            targetAllocationEnabled = !targetAllocationEnabled;
            const btn = document.getElementById('allocation-toggle-btn');
            const results = document.getElementById('allocation-results');
            
            if (targetAllocationEnabled) {
                btn.textContent = 'ç›®æ¨™é…åˆ†ON';
                btn.className = 'target-toggle toggle-active';
                results.style.display = 'block';
                updateTargetAllocation();
            } else {
                btn.textContent = 'ç›®æ¨™é…åˆ†OFF';
                btn.className = 'target-toggle toggle-inactive';
                results.style.display = 'none';
            }
            
            document.getElementById('header-allocation-status').textContent = targetAllocationEnabled ? 'ON' : 'OFF';
            document.getElementById('target-status').textContent = targetAllocationEnabled ? 'ç›®æ¨™é…åˆ†ON' : 'ç›®æ¨™é…åˆ†OFF';
        }

        function updateTargetAllocation() {
            if (!targetAllocationEnabled) return;
            
            // ç›®æ¨™é…åˆ†ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
            const totalTarget = parseInt(document.getElementById('total-target').value) || 6000;
            
            // ç¾åœ¨ã®åˆ©ç›Šãƒ‡ãƒ¼ã‚¿ï¼ˆçµ±åˆPLã¾ãŸã¯å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰
            const integrationData = IntegrationLinkageManager.lastSyncData;
            let currentProfits = { sr: -2800, w: 2100, rc: 1400, rcd: 1000 }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            
            if (integrationData) {
                // çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                // ç°¡ç•¥åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
            }
            
            // é…åˆ†ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
            const allocation = calculateTargetAllocation(currentProfits, totalTarget);
            displayAllocationResults(allocation);
        }

        function calculateTargetAllocation(currentProfits, totalTarget) {
            const currentTotal = Object.values(currentProfits).reduce((sum, val) => sum + val, 0);
            const improvementNeeded = totalTarget - currentTotal;
            
            return {
                sr: { current: currentProfits.sr, target: currentProfits.sr + 1200, strategy: 'æœˆ+100ä¸‡å›ºå®š' },
                w: { current: currentProfits.w, target: currentProfits.w + (improvementNeeded * 0.4), strategy: 'åŠ¹ç‡æ”¹å–„' },
                rc: { current: currentProfits.rc, target: currentProfits.rc + (improvementNeeded * 0.3), strategy: 'åŠ¹ç‡æ”¹å–„' },
                rcd: { current: currentProfits.rcd, target: currentProfits.rcd, strategy: 'è¨ˆç”»å—æ³¨ç¶­æŒ' }
            };
        }

        function displayAllocationResults(allocation) {
            const tableBody = document.getElementById('allocation-table');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            Object.entries(allocation).forEach(([dept, data]) => {
                const improvement = data.target - data.current;
                const salesIncrease = data.current > 0 ? (improvement / data.current * 100) : 0;
                const feasibility = salesIncrease <= 20 ? 'ç¾å®Ÿçš„' : 'å›°é›£';
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${dept.toUpperCase()}</td>
                    <td>${data.strategy}</td>
                    <td>${data.current.toLocaleString()}</td>
                    <td>${data.target.toLocaleString()}</td>
                    <td class="${improvement >= 0 ? 'positive' : 'negative'}">${improvement.toLocaleString()}</td>
                    <td>${salesIncrease.toFixed(1)}%</td>
                    <td class="${feasibility === 'ç¾å®Ÿçš„' ? 'positive' : 'negative'}">${feasibility}</td>
                `;
            });
        }

        function refreshDashboardData() {
            try {
                // çµ±åˆPLé€£æºãƒ‡ãƒ¼ã‚¿ç¢ºèª
                IntegrationLinkageManager.loadIntegrationData();
                
                // å¾“æ¥ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸç¢ºèª
                DataSyncManager.updateDataSyncStatus();
                
                // ç›®æ¨™é…åˆ†æ›´æ–°
                if (targetAllocationEnabled) {
                    updateTargetAllocation();
                }
                
                alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚çµ±åˆPLé€£æºãƒ‡ãƒ¼ã‚¿ã‚‚æœ€æ–°ã®çŠ¶æ…‹ã«åŒæœŸã•ã‚Œã¾ã—ãŸã€‚');
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function exportDebugData() {
            try {
                const debugData = {
                    timestamp: new Date().toISOString(),
                    integrationData: IntegrationLinkageManager.lastSyncData,
                    autoSyncEnabled: IntegrationLinkageManager.isAutoSyncEnabled,
                    localStorage: {
                        keys: Object.keys(localStorage),
                        sizes: Object.keys(localStorage).map(key => ({
                            key: key,
                            size: localStorage.getItem(key)?.length || 0
                        }))
                    }
                };
                
                const blob = new Blob([JSON.stringify(debugData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard_debug_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
            } catch (error) {
                console.error('ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function toggleDebugMode() {
            const debugSection = document.getElementById('debug-section');
            if (debugSection) {
                debugSection.style.display = debugSection.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–ç®¡ç†
        const ChartManager = {
            departmentCharts: {},
            monthlyProfitChart: null,

            // å€‹åˆ¥äº‹æ¥­éƒ¨ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
            initializeDepartmentCharts: function() {
                const departments = [
                    { id: 'sr', name: 'SRäº‹æ¥­éƒ¨', color: '#e74c3c', height: 120 },
                    { id: 'w', name: 'Wäº‹æ¥­éƒ¨', color: '#3498db', height: 120 },
                    { id: 'rc', name: 'RCå¸äº‹æ¥­éƒ¨', color: '#27ae60', height: 120 },
                    { id: 'rcd', name: 'RCDç¤¾äº‹æ¥­éƒ¨', color: '#9b59b6', height: 80 }
                ];

                departments.forEach(dept => {
                    const ctx = document.getElementById(`${dept.id}-monthly-chart`);
                    if (!ctx || this.departmentCharts[dept.id]) return;

                    const isRcd = dept.id === 'rcd';
                    
                    this.departmentCharts[dept.id] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['7', '8', '9', '10', '11', '12', '1', '2', '3', '4', '5', '6'],
                            datasets: [
                                {
                                    label: 'å‰å¹´å®Ÿç¸¾',
                                    data: this.getPreviousYearData(dept.id),
                                    backgroundColor: isRcd ? 'rgba(149, 165, 166, 0.4)' : 'rgba(149, 165, 166, 0.6)',
                                    borderColor: '#95a5a6',
                                    borderWidth: isRcd ? 0.5 : 1
                                },
                                {
                                    label: isRcd ? 'è¨ˆç”»äºˆç®—' : 'è¨­å®šäºˆç®—',
                                    data: this.getCurrentYearData(dept.id),
                                    backgroundColor: isRcd ? `${dept.color}60` : `${dept.color}80`,
                                    borderColor: dept.color,
                                    borderWidth: isRcd ? 0.5 : 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label + 'æœˆ';
                                        },
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'ä¸‡å††';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    display: true,
                                    grid: { display: false },
                                    ticks: { 
                                        font: { size: isRcd ? 7 : 8 },
                                        maxTicksLimit: isRcd ? 2 : 3,
                                        callback: function(value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                },
                                x: {
                                    display: true,
                                    grid: { display: false },
                                    ticks: { font: { size: isRcd ? 7 : 8 } }
                                }
                            }
                        }
                    });
                });

                console.log('å€‹åˆ¥äº‹æ¥­éƒ¨ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–å®Œäº†');
            },

            // æœˆæ¬¡åˆ©ç›Šæ¨ç§»ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
            initializeMonthlyProfitChart: function() {
                const ctx = document.getElementById('monthly-profit-chart');
                if (!ctx) return;

                // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
                if (this.monthlyProfitChart) {
                    this.monthlyProfitChart.destroy();
                }

                const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆçµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼‰
                const defaultProfit = [-1950, -1880, -1920, -1900, -1910, -1890, -1900, -1920, -1900, -1900, -1910, -1890];
                const defaultSales = [2500, 2600, 2550, 2580, 2570, 2590, 2580, 2560, 2590, 2590, 2570, 2600];

                this.monthlyProfitChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'çµ±åˆå–¶æ¥­åˆ©ç›Š',
                                data: defaultProfit,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'çµ±åˆå£²ä¸Šé«˜',
                                data: defaultSales,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'ä¸‡å††';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'å–¶æ¥­åˆ©ç›Šï¼ˆä¸‡å††ï¼‰'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'å£²ä¸Šé«˜ï¼ˆä¸‡å††ï¼‰'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });

                console.log('æœˆæ¬¡åˆ©ç›Šæ¨ç§»ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–å®Œäº†');
            },

            // çµ±åˆPLãƒ‡ãƒ¼ã‚¿ã§ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            updateWithIntegrationData: function(integrationData) {
                if (integrationData.monthlyData && this.monthlyProfitChart) {
                    this.monthlyProfitChart.data.datasets[0].data = integrationData.monthlyData.profit || Array(12).fill(0);
                    this.monthlyProfitChart.data.datasets[1].data = integrationData.monthlyData.sales || Array(12).fill(0);
                    this.monthlyProfitChart.update('none');
                    console.log('æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆã‚’çµ±åˆPLãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°');
                }
            },

            // å‰å¹´ãƒ‡ãƒ¼ã‚¿å–å¾—
            getPreviousYearData: function(deptId) {
                const previousData = {
                    sr: [-240, -230, -235, -232, -234, -233, -233, -234, -233, -233, -235, -234],
                    w: [170, 175, 173, 176, 175, 177, 175, 174, 176, 176, 174, 179],
                    rc: [115, 118, 116, 117, 117, 118, 117, 116, 117, 117, 116, 118],
                    rcd: [80, 85, 83, 84, 84, 85, 83, 82, 84, 84, 82, 84]
                };
                return previousData[deptId] || Array(12).fill(0);
            },

            // å½“å¹´ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆçµ±åˆPLã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
            getCurrentYearData: function(deptId) {
                const integrationData = IntegrationLinkageManager.lastSyncData;
                if (integrationData && integrationData.departments) {
                    // çµ±åˆPLãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                    // ç°¡ç•¥åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
                }
                
                const defaultData = {
                    sr: [-250, -240, -245, -242, -244, -243, -243, -244, -243, -243, -245, -244],
                    w: [180, 185, 183, 186, 185, 187, 185, 184, 186, 186, 184, 189],
                    rc: [125, 128, 126, 127, 127, 128, 127, 126, 127, 127, 126, 128],
                    rcd: [85, 90, 88, 89, 89, 90, 88, 87, 89, 89, 87, 89]
                };
                return defaultData[deptId] || Array(12).fill(0);
            }
        };

        // åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–é–‹å§‹ï¼ˆPhase 3çµ±åˆPLå®Œå…¨é€£å‹•ç‰ˆï¼‰');
                
                // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–ï¼ˆæœ€å„ªå…ˆï¼‰
                setTimeout(() => {
                    ChartManager.initializeMonthlyProfitChart();
                    ChartManager.initializeDepartmentCharts();
                }, 100);
                
                // çµ±åˆPLé€£æºãƒ‡ãƒ¼ã‚¿è‡ªå‹•èª­ã¿è¾¼ã¿
                setTimeout(() => {
                    const data = IntegrationLinkageManager.loadIntegrationData();
                    if (data) {
                        ChartManager.updateWithIntegrationData(data);
                    }
                }, 500);
                
                // ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
                setTimeout(() => {
                    DataSyncManager.updateDataSyncStatus();
                }, 1000);
                
                // å®šæœŸçš„ãªçµ±åˆPLé€£æºãƒã‚§ãƒƒã‚¯ï¼ˆ30ç§’é–“éš”ï¼‰
                setInterval(() => {
                    if (!IntegrationLinkageManager.isAutoSyncEnabled) {
                        const data = IntegrationLinkageManager.checkForUpdates();
                        if (data) {
                            ChartManager.updateWithIntegrationData(data);
                        }
                    }
                }, 30000);
                
                console.log('Phase 3çµ±åˆPLå®Œå…¨é€£å‹•ç‰ˆ åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®è‡ªå‹•åŒæœŸåœæ­¢
        window.addEventListener('beforeunload', function() {
            if (IntegrationLinkageManager.isAutoSyncEnabled) {
                IntegrationLinkageManager.disableAutoSync();
            }
        });
    </script>
</body>
</html>
