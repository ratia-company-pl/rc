<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCDç¤¾PLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Phase 4å®Œæˆç‰ˆï¼ˆç²¾åº¦å‘ä¸Šç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        .header-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .nav-section {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            padding: 12px 20px;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .btn-nav {
            padding: 8px 14px;
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-nav:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .btn-nav.btn-sr { background: #e53e3e; border-color: #e53e3e; }
        .btn-nav.btn-w { background: #3498db; border-color: #3498db; }
        .btn-nav.btn-rc { background: #38a169; border-color: #38a169; }
        .btn-nav.btn-rcd { background: #805ad5; border-color: #805ad5; box-shadow: 0 4px 12px rgba(128, 90, 213, 0.4); }

        .workflow-section {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            padding: 18px 20px;
            border-bottom: 3px solid #805ad5;
        }

        .workflow-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .workflow-info {
            font-size: 0.9rem;
            color: #34495e;
            text-align: center;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .workflow-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #805ad5, #6b46c1);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-csv {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #805ad5;
        }

        .chart-header {
            background: linear-gradient(135deg, #805ad5 0%, #9f7aea 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .kpi-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(128, 90, 213, 0.1);
            padding: 15px;
            margin: 10px 20px;
            border-radius: 8px;
            border: 2px solid #805ad5;
            flex-wrap: wrap;
            gap: 10px;
        }

        .kpi-item {
            text-align: center;
            min-width: 120px;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: #34495e;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #805ad5;
        }

        .kpi-value.negative {
            color: #e74c3c;
        }

        .chart-container {
            height: 250px;
            padding: 20px;
            background: white;
            position: relative;
        }

        .chart-legend {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 15px;
            font-size: 0.75rem;
            z-index: 10;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-purple { background: rgba(128, 90, 213, 0.7); }
        .legend-red { background: rgba(231, 76, 60, 0.7); }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #805ad5;
        }

        .input-header {
            background: linear-gradient(135deg, #805ad5 0%, #9f7aea 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .input-controls {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 90px;
        }

        .preset-btn.green { background: linear-gradient(135deg, #52c41a, #389e0d); color: white; }
        .preset-btn.blue { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .preset-btn.purple { background: linear-gradient(135deg, #722ed1, #531dab); color: white; }
        .preset-btn.red { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }

        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .settings-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f3e8ff;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #805ad5;
        }

        .setting-label {
            font-weight: 600;
            color: #6b46c1;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .input-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            table-layout: fixed;
        }

        .input-table th,
        .input-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 6px;
            text-align: center;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .input-table th {
            background: linear-gradient(135deg, #805ad5, #9f7aea);
            color: white;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .input-table th:first-child { width: 120px; }
        .input-table th:nth-child(n+2):nth-child(-n+13) { width: 60px; }
        .input-table th:nth-child(n+14) { width: 80px; }

        .input-table .row-header {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            text-align: left;
            padding-left: 12px;
            white-space: normal;
            word-wrap: break-word;
        }

        .input-table input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #ddd;
            background: rgba(128, 90, 213, 0.1);
            border-radius: 3px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .input-table input:focus {
            background: rgba(128, 90, 213, 0.2);
            border-color: #805ad5;
            outline: none;
        }

        .diff-positive { color: #27ae60; font-weight: 700; }
        .diff-negative { color: #e74c3c; font-weight: 700; }
        .reference-value { color: #7f8c8d; font-size: 0.65rem; }

        .profit-section, .expense-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .profit-section { border-left: 5px solid #52c41a; }
        .expense-section { border-left: 5px solid #34495e; }

        .profit-header {
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .expense-header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .profit-table, .expense-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            background: white;
            table-layout: fixed;
        }

        .profit-table th, .profit-table td, .expense-table th, .expense-table td {
            border: 1px solid #e2e8f0;
            padding: 6px 4px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .profit-table th:first-child, .profit-table td:first-child {
            width: 120px;
            white-space: normal;
            word-wrap: break-word;
            text-align: left;
            padding-left: 10px;
        }

        .expense-table th:first-child, .expense-table td:first-child { width: 40px; }
        .expense-table th:nth-child(2), .expense-table td:nth-child(2) {
            width: 120px;
            white-space: normal;
            word-wrap: break-word;
            text-align: left;
            padding-left: 10px;
        }

        .profit-table th:nth-child(n+2):nth-child(-n+13), .profit-table td:nth-child(n+2):nth-child(-n+13),
        .expense-table th:nth-child(n+3):nth-child(-n+14), .expense-table td:nth-child(n+3):nth-child(-n+14) {
            width: 60px;
        }

        .profit-table th:nth-child(n+14), .profit-table td:nth-child(n+14),
        .expense-table th:nth-child(n+15), .expense-table td:nth-child(n+15) {
            width: 80px;
        }

        .profit-table th {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            color: white;
            font-weight: 600;
            font-size: 0.65rem;
        }

        .expense-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: 600;
            font-size: 0.65rem;
        }

        .profit-table .profit-name, .expense-table .expense-name {
            background: #f8f9fa;
            font-weight: 600;
        }

        .precision-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 20px;
            font-size: 0.75rem;
            color: #856404;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .nav-buttons { gap: 6px; }
            .btn-nav { padding: 6px 10px; font-size: 0.7rem; }
            .input-controls { flex-direction: column; align-items: stretch; }
            .preset-buttons { justify-content: center; }
            .settings-inline { justify-content: center; }
            .kpi-display { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- RCDäº‹æ¥­éƒ¨çµ±åˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header-section">
            <div class="nav-section">
                <div class="nav-buttons">
                    <a href="../index.html" class="btn-nav">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                    <a href="sr-pl.html" class="btn-nav btn-sr">SRäº‹æ¥­éƒ¨</a>
                    <a href="w-pl.html" class="btn-nav btn-w">Wäº‹æ¥­éƒ¨</a>
                    <a href="rc-pl.html" class="btn-nav btn-rc">RCäº‹æ¥­éƒ¨</a>
                    <a href="rcd-pl.html" class="btn-nav btn-rcd">RCDç¤¾</a>
                    <a href="../combined-dashboard/index.html" class="btn-nav">å…¨ä½“PL</a>
                </div>
            </div>

            <div class="workflow-section">
                <div class="workflow-title">çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ  ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - Step 4/4 æœ€çµ‚æ®µéšï¼ˆç²¾åº¦å‘ä¸Šç‰ˆï¼‰</div>
                <div class="workflow-info">
                    <span style="color: #27ae60; font-weight: 600;">âœ“ SRäº‹æ¥­éƒ¨å®Œäº†</span>
                    <span style="margin: 0 10px; color: #bdc3c7;">|</span>
                    <span style="color: #27ae60; font-weight: 600;">âœ“ Wäº‹æ¥­éƒ¨å®Œäº†</span>
                    <span style="margin: 0 10px; color: #bdc3c7;">|</span>
                    <span style="color: #27ae60; font-weight: 600;">âœ“ RCäº‹æ¥­éƒ¨å®Œäº†</span>
                    <span style="margin: 0 10px; color: #bdc3c7;">|</span>
                    <span style="color: #805ad5; font-weight: 700;">â— RCDç¤¾è¨­å®šä¸­</span>
                    <span style="margin: 0 10px; color: #bdc3c7;">â†’</span>
                    <span style="color: #f39c12; font-weight: 600;">åˆè¨ˆPLçµ±åˆ</span>
                </div>
                <div class="workflow-actions">
                    <button class="action-btn btn-primary" onclick="sendRCDDataAndNavigateToNext()">
                        RCDç¤¾ãƒ‡ãƒ¼ã‚¿é€ä¿¡ â†’ çµ±åˆPLã¸
                    </button>
                    <button class="action-btn btn-csv" onclick="exportRCDCSV()">
                        CSVå‡ºåŠ›
                    </button>
                    <button class="action-btn btn-secondary" onclick="location.href='../combined-dashboard/index.html'">
                        å…¨ä½“PLåˆ†æã¸
                    </button>
                </div>
            </div>
        </div>

        <!-- ç²¾åº¦æ”¹å–„é€šçŸ¥ -->
        <div class="precision-note">
            <strong>ğŸ”§ è¨ˆç®—ç²¾åº¦æ”¹å–„:</strong> ä»•å…¥æœ¬æ•°ã‚’å°æ•°2ä½ã¾ã§å…¥åŠ›å¯èƒ½ã€‚è¨ˆç®—çµæœã¯ä¸‡å††å˜ä½ã§æ•´æ•°åŒ–ã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚
        </div>

        <!-- RCDäº‹æ¥­éƒ¨ãƒãƒ£ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="chart-section">
            <div class="chart-header">
                å‚è€ƒå‰å¹´æ•°å€¤ã¨ã®æ¯”è¼ƒã‚°ãƒ©ãƒ•ï¼ˆçµ±ä¸€æ§‹é€  Version 3.0 - ç²¾åº¦å‘ä¸Šç‰ˆï¼‰
            </div>
            
            <div class="kpi-display">
                <div class="kpi-item">
                    <div class="kpi-label">å¹´é–“å£²ä¸Šåˆè¨ˆ</div>
                    <div class="kpi-value" id="annual-sales">197,760ä¸‡å††</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">å‰å¹´å¯¾æ¯”å¢—æ¸›</div>
                    <div class="kpi-value" id="sales-diff">+27,581ä¸‡å††</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">å–¶æ¥­åˆ©ç›Šç‡</div>
                    <div class="kpi-value" id="profit-rate">2.4%</div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-red"></div>
                        <span>å‚è€ƒ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-purple"></div>
                        <span>äºˆç®—</span>
                    </div>
                </div>
                <canvas id="rcd-comparison-chart"></canvas>
            </div>
        </div>

        <!-- RCDäº‹æ¥­éƒ¨å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="input-section">
            <div class="input-header">
                RCDç¤¾ ä»•å…¥æœ¬æ•°ãƒ»æ‰‹æ•°æ–™ç™ºç”Ÿå›æ•°å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç²¾åº¦å‘ä¸Šç‰ˆï¼‰ 
            </div>
            
            <div class="input-controls">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyRCDPreset('actual')">å®Ÿç¸¾ãƒ‘ã‚¿ãƒ¼ãƒ³</button>
                    <button class="preset-btn blue" onclick="applyRCDPreset('standard')">æ¨™æº–è¨­å®š(æœˆ8æœ¬)</button>
                    <button class="preset-btn purple" onclick="applyRCDPreset('growth')">æœˆ7æœ¬è¨­å®š</button>
                    <button class="preset-btn red" onclick="applyRCDPreset('improve')">æœˆ6æœ¬è¨­å®š</button>
                    <button class="preset-btn" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white;" onclick="applyRCDPreset('zero_fee')">æ”¯æ‰•æ‰‹æ•°æ–™0</button>
                </div>

                <div class="settings-inline">
                    <label class="setting-label">å¤–éƒ¨å§”è¨—å‹</label>
                    <span class="setting-label">äººä»¶è²»ãƒ»çµŒè²»0å††å‡¦ç†</span>
                </div>
            </div>

            <table class="input-table">
                <thead>
                    <tr>
                        <th>é …ç›®</th>
                        <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                        <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-header">ä»•å…¥æœ¬æ•°</td>
                        <td><input type="number" step="0.01" data-month="0" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="1" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="2" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="3" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="4" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="5" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="6" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="7" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="8" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="9" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="10" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                        <td><input type="number" step="0.01" data-month="11" data-type="purchase" value="8.00" onchange="updateRCDSales()" /></td>
                    </tr>
                    <tr>
                        <td class="row-header">æ‰‹æ•°æ–™å›æ•°</td>
                        <td><input type="number" data-month="0" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="1" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="2" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="3" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="4" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="5" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="6" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="7" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="8" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="9" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="10" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                        <td><input type="number" data-month="11" data-type="fee" value="1" onchange="updateRCDSales()" /></td>
                    </tr>
                    <tr>
                        <td class="row-header">å£²ä¸Šäºˆæ¸¬</td>
                        <td class="calculated-value" data-sales="0">16,480</td>
                        <td class="calculated-value" data-sales="1">16,480</td>
                        <td class="calculated-value" data-sales="2">16,480</td>
                        <td class="calculated-value" data-sales="3">16,480</td>
                        <td class="calculated-value" data-sales="4">16,480</td>
                        <td class="calculated-value" data-sales="5">16,480</td>
                        <td class="calculated-value" data-sales="6">16,480</td>
                        <td class="calculated-value" data-sales="7">16,480</td>
                        <td class="calculated-value" data-sales="8">16,480</td>
                        <td class="calculated-value" data-sales="9">16,480</td>
                        <td class="calculated-value" data-sales="10">16,480</td>
                        <td class="calculated-value" data-sales="11">16,480</td>
                    </tr>
                    <tr>
                        <td class="row-header">å¢—æ¸›</td>
                        <td class="diff-value" data-diff="0">+49%</td>
                        <td class="diff-value" data-diff="1">+15%</td>
                        <td class="diff-value" data-diff="2">+43%</td>
                        <td class="diff-value" data-diff="3">+12%</td>
                        <td class="diff-value" data-diff="4">+32%</td>
                        <td class="diff-value" data-diff="5">+10%</td>
                        <td class="diff-value" data-diff="6">+21%</td>
                        <td class="diff-value" data-diff="7">+7%</td>
                        <td class="diff-value" data-diff="8">+14%</td>
                        <td class="diff-value" data-diff="9">+4%</td>
                        <td class="diff-value" data-diff="10">+6%</td>
                        <td class="diff-value" data-diff="11">+1%</td>
                    </tr>
                    <tr>
                        <td class="row-header">å‚è€ƒ</td>
                        <td class="reference-value">11,037</td>
                        <td class="reference-value">14,297</td>
                        <td class="reference-value">11,504</td>
                        <td class="reference-value">14,664</td>
                        <td class="reference-value">12,507</td>
                        <td class="reference-value">14,920</td>
                        <td class="reference-value">13,661</td>
                        <td class="reference-value">15,455</td>
                        <td class="reference-value">14,439</td>
                        <td class="reference-value">15,857</td>
                        <td class="reference-value">15,478</td>
                        <td class="reference-value">16,360</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- RCDäº‹æ¥­éƒ¨åˆ©ç›Šãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="profit-section">
            <div class="profit-header">
                å£²ä¸Šç·åˆ©ç›Šãƒ»å–¶æ¥­åˆ©ç›Šæœˆé¡è¡¨ï¼ˆçµ±ä¸€æ§‹é€  Version 3.0 - ç²¾åº¦å‘ä¸Šç‰ˆï¼‰
            </div>
            <table class="profit-table">
                <thead>
                    <tr>
                        <th>é …ç›®</th>
                        <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                        <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                        <th>å¹´é–“åˆè¨ˆ</th>
                        <th>æœˆå¹³å‡</th>
                    </tr>
                </thead>
                <tbody id="profit-table-body">
                </tbody>
            </table>
        </div>

        <!-- RCDäº‹æ¥­éƒ¨è²©ç®¡è²»ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="expense-section">
            <div class="expense-header">
                è²©ç®¡è²»19é …ç›®è©³ç´°è¡¨ç¤ºï¼ˆçµ±ä¸€æ§‹é€  Version 3.0 - ç²¾åº¦å‘ä¸Šç‰ˆï¼‰
            </div>
            <table class="expense-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>è²»ç”¨é …ç›®</th>
                        <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                        <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                        <th>å¹´é–“</th>
                        <th>æœˆæ¬¡åˆè¨ˆ</th>
                    </tr>
                </thead>
                <tbody id="expense-table-body">
                </tbody>
                <tfoot id="expense-table-footer">
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        // RCDç¤¾ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆç²¾åº¦å‘ä¸Šç‰ˆï¼‰
        const rcdReferenceData = [11037, 14297, 11504, 14664, 12507, 14920, 13661, 15455, 14439, 15857, 15478, 16360];
        const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
        
        let rcdData = {
            unitPurchase: 2000,    // ä»•å…¥å˜ä¾¡2,000ä¸‡å††/æœ¬
            profitRate: 0.03,      // åˆ©ç›Šç‡3%å›ºå®š
            feePerOccurrence: 90.6, // æ”¯æ‰•æ‰‹æ•°æ–™90.6ä¸‡å††/ä»¶
            monthlyPurchases: [8.00, 8.00, 8.00, 8.00, 8.00, 8.00, 8.00, 8.00, 8.00, 8.00, 8.00, 8.00],
            monthlyFeeOccurrences: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
        };

        let rcdChart = null;

        // RCDç¤¾è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆç²¾åº¦å‘ä¸Šç‰ˆï¼šå…¥åŠ›å°æ•°2ä½ãƒ»å‡ºåŠ›æ•´æ•°ä¸‡å††ï¼‰
        function calculateRCD() {
            const results = {
                monthlyResults: [],
                expenses: {},
                annual: {}
            };

            // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿åé›†
            const purchaseInputs = document.querySelectorAll('input[data-type="purchase"]');
            const feeInputs = document.querySelectorAll('input[data-type="fee"]');
            
            purchaseInputs.forEach((input, i) => {
                rcdData.monthlyPurchases[i] = parseFloat(input.value) || 0;
            });
            
            feeInputs.forEach((input, i) => {
                rcdData.monthlyFeeOccurrences[i] = parseInt(input.value) || 0;
            });

            // æœˆæ¬¡è¨ˆç®—å®Ÿè¡Œï¼ˆç²¾åº¦å‘ä¸Šï¼šè¨ˆç®—ã¯å°æ•°ã§è¡Œã„ã€çµæœã¯æ•´æ•°åŒ–ï¼‰
            results.monthlyResults = rcdData.monthlyPurchases.map((purchaseCount, i) => {
                // å£²ä¸Šè¨ˆç®—: ä»•å…¥æœ¬æ•°Ã—2,000ä¸‡å††Ã—1.03ï¼ˆå°æ•°è¨ˆç®—ï¼‰â†’ æ•´æ•°åŒ–
                const salesCalc = purchaseCount * rcdData.unitPurchase * (1 + rcdData.profitRate);
                const sales = Math.floor(salesCalc); // å°æ•°åˆ‡ã‚Šæ¨ã¦ã§æ•´æ•°åŒ–
                
                // ä»•å…¥åŸä¾¡: ä»•å…¥æœ¬æ•°Ã—2,000ä¸‡å††ï¼ˆå°æ•°è¨ˆç®—ï¼‰â†’ æ•´æ•°åŒ–
                const cogsCalc = purchaseCount * rcdData.unitPurchase;
                const cogs = Math.floor(cogsCalc); // å°æ•°åˆ‡ã‚Šæ¨ã¦ã§æ•´æ•°åŒ–
                
                // å£²ä¸Šç·åˆ©ç›Šï¼ˆæ•´æ•°ï¼‰
                const grossProfit = sales - cogs;
                
                // æ”¯æ‰•æ‰‹æ•°æ–™: ç™ºç”Ÿå›æ•°Ã—90.6ä¸‡å†† â†’ æ•´æ•°åŒ–
                const paymentFeesCalc = rcdData.monthlyFeeOccurrences[i] * rcdData.feePerOccurrence;
                const paymentFees = Math.floor(paymentFeesCalc); // å°æ•°åˆ‡ã‚Šæ¨ã¦ã§æ•´æ•°åŒ–
                
                // å–¶æ¥­åˆ©ç›Šï¼ˆæ•´æ•°ï¼‰
                const operatingProfit = grossProfit - paymentFees;
                
                return {
                    purchaseCount,
                    sales, 
                    cogs, 
                    grossProfit, 
                    paymentFees,
                    totalExpenses: paymentFees,
                    operatingProfit
                };
            });

            // è²©ç®¡è²»19é …ç›®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆRCDç¤¾ã¯æ”¯æ‰•æ‰‹æ•°æ–™ä»¥å¤–0å††ãƒ»æ•´æ•°ï¼‰
            for (let i = 1; i <= 19; i++) {
                if (i === 15) {
                    results.expenses[i] = results.monthlyResults.map(m => m.paymentFees);
                } else {
                    results.expenses[i] = new Array(12).fill(0);
                }
            }

            // å¹´é–“é›†è¨ˆï¼ˆæ•´æ•°ï¼‰
            results.annual = {
                purchaseCount: results.monthlyResults.reduce((sum, m) => sum + m.purchaseCount, 0),
                sales: results.monthlyResults.reduce((sum, m) => sum + m.sales, 0),
                cogs: results.monthlyResults.reduce((sum, m) => sum + m.cogs, 0),
                grossProfit: results.monthlyResults.reduce((sum, m) => sum + m.grossProfit, 0),
                totalExpenses: results.monthlyResults.reduce((sum, m) => sum + m.totalExpenses, 0),
                operatingProfit: results.monthlyResults.reduce((sum, m) => sum + m.operatingProfit, 0)
            };

            return results;
        }

        function updateRCDSales() {
            const results = calculateRCD();
            updateSalesDisplay();
            updateDifferenceDisplay();
            updateKPIDisplay(results.annual);
            updateChart();
            updateProfitTable(results);
            updateExpenseTable(results.expenses);
        }

        function updateSalesDisplay() {
            rcdData.monthlyPurchases.forEach((purchaseCount, i) => {
                const salesCalc = purchaseCount * rcdData.unitPurchase * (1 + rcdData.profitRate);
                const sales = Math.floor(salesCalc); // æ•´æ•°åŒ–
                const salesElement = document.querySelector(`[data-sales="${i}"]`);
                if (salesElement) {
                    salesElement.textContent = sales.toLocaleString();
                }
            });
        }

        function updateDifferenceDisplay() {
            rcdData.monthlyPurchases.forEach((purchaseCount, i) => {
                const salesCalc = purchaseCount * rcdData.unitPurchase * (1 + rcdData.profitRate);
                const currentSales = Math.floor(salesCalc);
                const referenceValue = rcdReferenceData[i];
                const diffPercent = ((currentSales - referenceValue) / referenceValue * 100);
                
                const diffElement = document.querySelector(`[data-diff="${i}"]`);
                if (diffElement) {
                    diffElement.textContent = (diffPercent >= 0 ? '+' : '') + diffPercent.toFixed(0) + '%';
                    diffElement.className = diffPercent >= 0 ? 'diff-value diff-positive' : 'diff-value diff-negative';
                }
            });
        }

        function updateKPIDisplay(annual) {
            const refTotal = rcdReferenceData.reduce((sum, val) => sum + val, 0);
            const salesDiff = annual.sales - refTotal;
            const profitRate = annual.sales > 0 ? (annual.operatingProfit / annual.sales * 100).toFixed(1) : '0.0';

            document.getElementById('annual-sales').textContent = annual.sales.toLocaleString() + 'ä¸‡å††';
            document.getElementById('sales-diff').textContent = (salesDiff >= 0 ? '+' : '') + salesDiff.toLocaleString() + 'ä¸‡å††';
            document.getElementById('profit-rate').textContent = profitRate + '%';

            const profitRateElement = document.getElementById('profit-rate');
            if (annual.operatingProfit >= 0) {
                profitRateElement.className = 'kpi-value';
            } else {
                profitRateElement.className = 'kpi-value negative';
            }
        }

        function updateChart() {
            const ctx = document.getElementById('rcd-comparison-chart');
            if (!ctx) return;

            if (rcdChart) rcdChart.destroy();

            const currentSales = rcdData.monthlyPurchases.map(purchaseCount => {
                const salesCalc = purchaseCount * rcdData.unitPurchase * (1 + rcdData.profitRate);
                return Math.floor(salesCalc); // æ•´æ•°åŒ–
            });

            rcdChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'å‚è€ƒå£²ä¸Š',
                            data: rcdReferenceData,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'äºˆç®—è¨­å®š',
                            data: currentSales,
                            backgroundColor: 'rgba(128, 90, 213, 0.7)',
                            borderColor: 'rgba(128, 90, 213, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 10 } } },
                        x: { ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        function updateProfitTable(results) {
            const tbody = document.getElementById('profit-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            const monthlySGAExpenses = new Array(12).fill(0);
            Object.values(results.expenses).forEach(expenseArray => {
                expenseArray.forEach((val, monthIndex) => {
                    monthlySGAExpenses[monthIndex] += val;
                });
            });

            const tableData = [
                {
                    name: 'å£²ä¸Šé«˜',
                    values: results.monthlyResults.map(m => m.sales),
                    style: 'background: #f6ffed; font-weight: 600; color: #237804;'
                },
                {
                    name: 'ä»•å…¥åŸä¾¡',
                    values: results.monthlyResults.map(m => m.cogs),
                    style: 'background: #fff7e6; font-weight: 600; color: #d48806;'
                },
                {
                    name: 'å£²ä¸Šç·åˆ©ç›Š',
                    values: results.monthlyResults.map(m => m.grossProfit),
                    style: 'background: #e6f7ff; font-weight: 600; color: #1890ff;'
                },
                {
                    name: 'è²©ç®¡è²»åˆè¨ˆ',
                    values: monthlySGAExpenses,
                    style: 'background: #fff0f6; font-weight: 600; color: #c41d7f;'
                },
                {
                    name: 'å–¶æ¥­åˆ©ç›Š',
                    values: results.monthlyResults.map((m, i) => m.grossProfit - monthlySGAExpenses[i]),
                    style: 'background: #f9f0ff; font-weight: 600; color: #722ed1;'
                }
            ];

            tableData.forEach((row) => {
                const annual = row.values.reduce((sum, val) => sum + val, 0);
                const average = Math.round(annual / 12);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="profit-name">${row.name}</td>
                    ${row.values.map(val => `<td style="${row.style}">${val.toLocaleString()}</td>`).join('')}
                    <td style="${row.style} border-left: 3px solid #333;">${annual.toLocaleString()}</td>
                    <td style="${row.style} border-left: 2px solid #666;">${average.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateExpenseTable(expenses) {
            const expenseNames = [
                'äººä»¶è²»çµ±åˆ', 'æ³•å®šç¦åˆ©è²»', 'è¡›ç”Ÿè²»', 'ç‰©æµç®¡ç†è²»', 'åœ°ä»£å®¶è³ƒ',
                'å¤–æ³¨è²»', 'è²¨ç‰©é‹è³ƒ', 'åºƒå‘Šå®£ä¼è²»', 'æ—…è²»äº¤é€šè²»', 'é€šä¿¡è²»',
                'è²©å£²ä¿ƒé€²è²»', 'æ¶ˆè€—å“è²»', 'äº‹å‹™ç”¨å“è²»', 'æ°´é“å…‰ç†±è²»', 'æ”¯æ‰•æ‰‹æ•°æ–™',
                'ãƒªãƒ¼ã‚¹æ–™', 'ä¿é™ºæ–™', 'æ”¯æ‰•å ±é…¬æ–™', 'æ¸›ä¾¡å„Ÿå´è²»'
            ];

            const tbody = document.getElementById('expense-table-body');
            const tfoot = document.getElementById('expense-table-footer');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            const monthlyTotals = new Array(12).fill(0);
            let grandTotal = 0;

            expenseNames.forEach((name, index) => {
                const expenseId = index + 1;
                const monthlyExpenses = expenses[expenseId];
                const annual = monthlyExpenses.reduce((sum, val) => sum + val, 0);

                if (annual === 0) return;

                monthlyExpenses.forEach((val, monthIndex) => {
                    monthlyTotals[monthIndex] += val;
                });
                grandTotal += annual;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; background: #f8f9fa; text-align: center;">${expenseId}</td>
                    <td class="expense-name">${name}</td>
                    ${monthlyExpenses.map(val => `<td>${val.toLocaleString()}</td>`).join('')}
                    <td style="font-weight: 700; background: #f8f9fa;">${annual.toLocaleString()}</td>
                    <td style="font-weight: 700; background: #e8f5e8; color: #27ae60;">${Math.round(annual / 12).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });

            const totalRow = document.createElement('tr');
            totalRow.style.background = '#34495e';
            totalRow.style.color = 'white';
            totalRow.style.fontWeight = '700';
            totalRow.innerHTML = `
                <td style="text-align: center;">åˆè¨ˆ</td>
                <td style="text-align: left; padding-left: 10px;">è²©ç®¡è²»åˆè¨ˆ</td>
                ${monthlyTotals.map(val => `<td>${val.toLocaleString()}</td>`).join('')}
                <td style="background: #2c3e50;">${grandTotal.toLocaleString()}</td>
                <td style="background: #2c3e50;">${Math.round(grandTotal / 12).toLocaleString()}</td>
            `;
            tfoot.appendChild(totalRow);
        }

        function applyRCDPreset(presetType) {
            const purchaseInputs = document.querySelectorAll('input[data-type="purchase"]');
            const feeInputs = document.querySelectorAll('input[data-type="fee"]');
            
            switch(presetType) {
                case 'actual':
                    const actualPurchases = [5.50, 7.10, 5.80, 7.30, 6.30, 7.50, 6.80, 7.70, 7.20, 7.90, 7.70, 8.20];
                    const actualFees = [0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1];
                    actualPurchases.forEach((val, i) => {
                        rcdData.monthlyPurchases[i] = val;
                        purchaseInputs[i].value = val.toFixed(2);
                    });
                    actualFees.forEach((val, i) => {
                        rcdData.monthlyFeeOccurrences[i] = val;
                        feeInputs[i].value = val;
                    });
                    break;
                case 'standard':
                    rcdData.monthlyPurchases.fill(8.00);
                    rcdData.monthlyFeeOccurrences.fill(1);
                    purchaseInputs.forEach(input => input.value = "8.00");
                    feeInputs.forEach(input => input.value = 1);
                    break;
                case 'growth':
                    rcdData.monthlyPurchases.fill(7.00);
                    rcdData.monthlyFeeOccurrences.fill(1);
                    purchaseInputs.forEach(input => input.value = "7.00");
                    feeInputs.forEach(input => input.value = 1);
                    break;
                case 'improve':
                    rcdData.monthlyPurchases.fill(6.00);
                    rcdData.monthlyFeeOccurrences.fill(0);
                    purchaseInputs.forEach(input => input.value = "6.00");
                    feeInputs.forEach(input => input.value = 0);
                    break;
                case 'zero_fee':
                    rcdData.monthlyFeeOccurrences.fill(0);
                    feeInputs.forEach(input => input.value = 0);
                    break;
            }
            
            updateRCDSales();
        }

        function exportRCDCSV() {
            try {
                const results = calculateRCD();
                const csvData = [];
                const months = ['é …ç›®å', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 'å¹´é–“åˆè¨ˆ'];
                csvData.push(months);

                csvData.push(['å£²ä¸Šé«˜', ...results.monthlyResults.map(m => m.sales), results.annual.sales]);
                csvData.push(['å£²ä¸ŠåŸä¾¡', ...results.monthlyResults.map(m => m.cogs), results.annual.cogs]);
                csvData.push(['å£²ä¸Šç·åˆ©ç›Š', ...results.monthlyResults.map(m => m.grossProfit), results.annual.grossProfit]);

                const expenseNames = [
                    'äººä»¶è²»çµ±åˆ', 'æ³•å®šç¦åˆ©è²»', 'è¡›ç”Ÿè²»', 'ç‰©æµç®¡ç†è²»', 'åœ°ä»£å®¶è³ƒ',
                    'å¤–æ³¨è²»', 'è²¨ç‰©é‹è³ƒ', 'åºƒå‘Šå®£ä¼è²»', 'æ—…è²»äº¤é€šè²»', 'é€šä¿¡è²»',
                    'è²©å£²ä¿ƒé€²è²»', 'æ¶ˆè€—å“è²»', 'äº‹å‹™ç”¨å“è²»', 'æ°´é“å…‰ç†±è²»', 'æ”¯æ‰•æ‰‹æ•°æ–™',
                    'ãƒªãƒ¼ã‚¹æ–™', 'ä¿é™ºæ–™', 'æ”¯æ‰•å ±é…¬æ–™', 'æ¸›ä¾¡å„Ÿå´è²»'
                ];

                expenseNames.forEach((name, index) => {
                    const expenseId = index + 1;
                    const monthlyExpenses = results.expenses[expenseId];
                    const annual = monthlyExpenses.reduce((sum, val) => sum + val, 0);
                    csvData.push([name, ...monthlyExpenses, annual]);
                });

                const zeroData = Array(12).fill(0);
                csvData.push(['å½¹å“¡å ±é…¬', ...zeroData, 0]);
                csvData.push(['å½¹å“¡æ³•å®šç¦åˆ©è²»', ...zeroData, 0]);
                csvData.push(['ç®¡ç†è«¸è²»', ...zeroData, 0]);
                csvData.push(['ä¿®ç¹•è²»', ...zeroData, 0]);
                csvData.push(['è»Šä¸¡è²»', ...zeroData, 0]);
                csvData.push(['ç§Ÿç¨å…¬èª²', ...zeroData, 0]);
                csvData.push(['äº¤éš›è²»', ...zeroData, 0]);
                csvData.push(['è«¸ä¼šè²»', ...zeroData, 0]);
                csvData.push(['ä¼šè­°è²»', ...zeroData, 0]);
                csvData.push(['ç¦åˆ©åšç”Ÿè²»', ...zeroData, 0]);
                csvData.push(['ç ”ä¿®è²»', ...zeroData, 0]);
                csvData.push(['é›‘è²»', ...zeroData, 0]);
                csvData.push(['å¯„ä»˜é‡‘', ...zeroData, 0]);

                csvData.push(['è²©ç®¡è²»åˆè¨ˆ', ...results.monthlyResults.map(m => m.totalExpenses), results.annual.totalExpenses]);
                csvData.push(['å–¶æ¥­åˆ©ç›Š', ...results.monthlyResults.map(m => m.operatingProfit), results.annual.operatingProfit]);

                const csvString = '\uFEFF' + csvData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `RCDç¤¾_PL_ç²¾åº¦å‘ä¸Šç‰ˆ_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                alert('RCDç¤¾PLãƒ‡ãƒ¼ã‚¿ï¼ˆç²¾åº¦å‘ä¸Šç‰ˆï¼‰ã®CSVå‡ºåŠ›ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');

            } catch (error) {
                alert('CSVå‡ºåŠ›ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                console.error('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function sendRCDDataAndNavigateToNext() {
            try {
                const results = calculateRCD();
                
                const unifiedData = {
                    metadata: {
                        department: 'RCD',
                        lastUpdate: new Date().toISOString(),
                        version: '3.0',
                        unifiedStructure: true,
                        precisionImproved: true,
                        unitPurchase: rcdData.unitPurchase,
                        profitRate: rcdData.profitRate,
                        feePerOccurrence: rcdData.feePerOccurrence,
                        monthlyPurchases: rcdData.monthlyPurchases,
                        monthlyFeeOccurrences: rcdData.monthlyFeeOccurrences
                    },
                    
                    // æ•´æ•°ä¸‡å††å˜ä½ã§ã®é€ä¿¡
                    sales: results.monthlyResults.map(m => m.sales),
                    cogs: results.monthlyResults.map(m => m.cogs),
                    expenses: results.expenses
                };

                localStorage.setItem('pl_system_rcd_data', JSON.stringify(unifiedData));
                
                const workflowProgress = {
                    step1_SR: 'completed',
                    step2_W: 'completed',
                    step3_RC: 'completed',
                    step4_RCD: 'completed',
                    currentStep: 5,
                    lastUpdate: new Date().toISOString()
                };
                localStorage.setItem('workflow_progress', JSON.stringify(workflowProgress));
                
                alert(`RCDç¤¾ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†ï¼ï¼ˆç²¾åº¦å‘ä¸Šç‰ˆãƒ»æ•´æ•°ä¸‡å††å˜ä½å‡ºåŠ›ï¼‰\n\nå¹´é–“å£²ä¸Š: ${results.annual.sales.toLocaleString()}ä¸‡å††\nå¹´é–“å–¶æ¥­åˆ©ç›Š: ${results.annual.operatingProfit.toLocaleString()}ä¸‡å††\nå–¶æ¥­åˆ©ç›Šç‡: ${(results.annual.operatingProfit / results.annual.sales * 100).toFixed(1)}%\n\nPhase 4å®Œäº†ï¼çµ±åˆPLã§å…¨ä½“çµæœã‚’ç¢ºèªã—ã¾ã™ã€‚\n3ç§’å¾Œã«è‡ªå‹•ç§»å‹•ã—ã¾ã™...`);
                
                setTimeout(() => {
                    window.location.href = '../combined-dashboard/index.html';
                }, 3000);

                return results.annual.sales;

            } catch (error) {
                alert('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                console.error('RCDé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                return 0;
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function initialize() {
            try {
                updateRCDSales();
                
                const inputs = document.querySelectorAll('input[data-month]');
                inputs.forEach(input => {
                    input.addEventListener('input', debounce(updateRCDSales, 300));
                });
                
                console.log('RCDç¤¾PLã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†ï¼ˆç²¾åº¦å‘ä¸Šç‰ˆãƒ»æ•´æ•°ä¸‡å††å˜ä½å‡ºåŠ›ï¼‰');
                
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        window.addEventListener('load', initialize);
    </script>
</body>
</html>
