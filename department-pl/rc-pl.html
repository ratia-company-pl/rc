<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RC卸事業部PLシミュレーター（連携機能付）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* 共通ヘッダー仕様（4行構造） */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header-row1 {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 15px 20px;
        }

        .main-title {
            font-size: 1.8em;
            font-weight: 700;
            margin: 0;
        }

        .header-row2 {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            padding: 8px 15px;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1100px;
            gap: 8px;
            margin: 0 auto;
        }

        .btn {
            flex: 1;
            min-width: 140px;
            max-width: 180px;
            padding: 8px 16px;
            font-size: 0.8em;
            text-decoration: none;
            border-radius: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
            font-weight: 700;
        }

        .header-row3 {
            background: #f8f9fa;
            padding: 12px 15px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(160px, 1fr));
            gap: 10px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .kpi-card {
            padding: 10px 12px;
            border-radius: 8px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #2c3e50;
            border: 2px solid #27ae60;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .kpi-card.positive {
            border-color: #27ae60;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .kpi-label {
            font-size: 0.75em;
            font-weight: 600;
            margin-bottom: 4px;
            color: #7f8c8d;
        }

        .kpi-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
        }

        .kpi-value.positive {
            color: #27ae60;
        }

        .header-row4 {
            background: #ecf0f1;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .linkage-status {
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.85em;
            text-align: center;
            flex: 0 0 auto;
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .linkage-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .linkage-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .dept-subtitle {
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: 500;
            margin: 0;
            flex: 1;
            text-align: right;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4em;
            font-weight: 700;
            border-bottom: 3px solid #e67e22;
            padding-bottom: 8px;
        }

        .chart-container {
            position: relative;
            height: 140px;
            width: 100%;
            margin: 15px 0;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.85em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary { background: #27ae60; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            font-size: 0.85em;
        }

        th, td {
            padding: 8px 12px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .month-header {
            background: #27ae60 !important;
        }

        .total-header {
            background: #e74c3c !important;
        }

        .item-name {
            text-align: left;
            font-weight: 600;
            background: #ecf0f1;
            padding-left: 15px;
            min-width: 200px;
        }

        .sales-row { background: #e8f5e8; }
        .gross-profit-row { background: #d5f4e6; font-weight: 600; }
        .expense-row { background: #fdf2e9; }
        .total-expense-row { background: #fadbd8; font-weight: 600; }
        .operating-profit-row { background: #d5f4e6; font-weight: 700; }

        .positive { color: #27ae60; font-weight: 600; }
        .negative { color: #e74c3c; font-weight: 600; }

        .spec-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 2px solid #27ae60;
            border-left: 6px solid #e67e22;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .spec-info strong {
            color: #2c3e50;
            font-weight: 700;
        }

        .spec-detail {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            border-left: 4px solid #e67e22;
        }

        /* Phase 2修正: 非表示行のスタイル */
        .hidden-row {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container { padding: 5px; }
            .main-title { font-size: 1.5em; }
            .nav-buttons { flex-direction: column; gap: 5px; }
            .btn { flex: none; width: 100%; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .header-row4 { flex-direction: column; text-align: center; }
            .dept-subtitle { text-align: center; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-row1">
                <h1 class="main-title">RC卸事業部PLシミュレーター（連携機能付）</h1>
            </div>

            <div class="header-row2">
                <div class="nav-buttons">
                    <a href="../index.html" class="btn">ダッシュボード</a>
                    <a href="../budget-input.html" class="btn">予算入力</a>
                    <a href="sr-pl.html" class="btn">SR事業部PL</a>
                    <a href="w-pl.html" class="btn">W事業部PL</a>
                    <a href="#" class="btn active">RC卸事業部PL</a>
                    <a href="rcd-pl.html" class="btn">RCD社事業部PL</a>
                    <a href="../combined-dashboard/index.html" class="btn">統合PLシステム</a>
                </div>
            </div>

            <div class="header-row3">
                <div class="kpi-grid">
                    <div class="kpi-card positive">
                        <div class="kpi-label">年間売上高</div>
                        <div class="kpi-value positive" id="annual-sales">19,200万円</div>
                    </div>
                    <div class="kpi-card positive">
                        <div class="kpi-label">年間営業利益</div>
                        <div class="kpi-value positive" id="annual-profit">5,961万円</div>
                    </div>
                    <div class="kpi-card positive">
                        <div class="kpi-label">営業利益率</div>
                        <div class="kpi-value positive" id="profit-rate">31.1%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">年間販管費合計</div>
                        <div class="kpi-value" id="annual-admin-expenses">1,239万円</div>
                    </div>
                </div>
            </div>

            <div class="header-row4">
                <div class="linkage-status" id="linkage-status">
                    <strong>✓</strong> 連携成功: <span id="last-update">2025-09-22 14:35:12</span> にデータ受信
                </div>
                <p class="dept-subtitle">基準売上1,500万円+月次増減方式・仕入原価率35.2%（修正モデル）・固定人件費50万円/月・販管費合計対応（5月90万円・12月90万円）</p>
            </div>
        </header>

        <main class="main-content">
            <h2 class="section-title">RC卸事業部 月次PL表示（連携機能付）</h2>
            
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #27ae60;"></div>
                    <span>売上高</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #87ceeb;"></div>
                    <span>営業利益</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e67e22;"></div>
                    <span>販管費合計</span>
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="loadLinkageData()">連携データ再読み込み</button>
                <button class="action-btn btn-success" onclick="exportToCSV()">データエクスポート</button>
                <button class="action-btn btn-danger" onclick="clearLinkageData()">入力システムに戻る</button>
                <button class="action-btn btn-primary" onclick="sendToIntegratedPL()">統合PLに送信</button>
            </div>

            <div class="table-container">
                <table id="plTable">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th class="month-header">7月</th>
                            <th class="month-header">8月</th>
                            <th class="month-header">9月</th>
                            <th class="month-header">10月</th>
                            <th class="month-header">11月</th>
                            <th class="month-header">12月</th>
                            <th class="month-header">1月</th>
                            <th class="month-header">2月</th>
                            <th class="month-header">3月</th>
                            <th class="month-header">4月</th>
                            <th class="month-header">5月</th>
                            <th class="month-header">6月</th>
                            <th class="total-header">年間計</th>
                            <th class="total-header">前年増減</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- データは動的に生成 -->
                    </tbody>
                </table>
            </div>

            <div class="spec-info">
                <strong>RC卸事業部計算仕様・項目ID体系</strong><br>
                基準売上1,500万円+月次増減方式 • 仕入原価率35.2%（RC卸事業部仕入修正モデル） • 固定人件費50万円/月（売上変動なし） • 支払手数料70万円/月（固定額） • 販管費合計：5月90万円・12月90万円対応
                
                <div class="spec-detail">
                    <strong>その他固定費内訳（月額260万円）：</strong><br>
                    会場賃料154万円、通信費0.4万円、事務用品費10万円、オフィス関連費12万円、水道光熱費2万円、保険料0.8万円、支払報酬料10万円、減価償却費7万円、物流管理費74万円
                </div>
            </div>
        </main>
    </div>

    <script>
        // データ保護戦略の維持 - 変更禁止領域
        const STORAGE_KEYS = {
            rc: 'pl_system_rc_data',
            rc_settings: 'pl_system_rc_settings',
            integration_status: 'pl_system_integration_status'
        };

        const DATA_TRANSMISSION = {
            endpoint: 'integrated-pl.html',
            format: 'json',
            compression: true
        };

        // RC卸事業部データ構造（v3.0対応）
        let rcData = {
            sales: new Array(12).fill(0),
            cogs: new Array(12).fill(0), 
            personnel: new Array(12).fill(0),
            expenses: new Array(12).fill(0), // 新規追加：販管費配列
            metadata: {
                lastUpdate: new Date().toISOString(),
                dataSource: "RC卸事業部",
                version: "3.0",
                calculationEngine: "dynamic"
            }
        };

        // 計算エンジン（カスタマイズ可能領域）
        const CALCULATION_ENGINE = {
            baseSales: 1550, // デフォルトの基準売上
            cogsRate: 0.352, // 仕入原価率35.2%
            fixedPersonnel: 50, // 固定人件費
            welfareRate: 0.13002, // 法定福利費率
            
            // 月次変動データ（初期値）
            variations: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            
            // 販管費構成
            expenses: {
                welfare: 6, // 法定福利費（固定）
                fees: 70, // 支払手数料
                travel: 15, // 旅費交通費
                advertising: 40, // デフォルトの広告宣伝費
                exhibition: 90, // デフォルトの展示会費用
                other: 260, // その他固定費
                promotion: { // 販売促進費（展示会費用）
                    base: 10,
                    exhibition: {
                        may: 0, // 5月の展示会費用（インデックス10）
                        december: 0 // 12月の展示会費用（インデックス5）
                    }
                }
            }
        };

        // 月名の配列（7月から開始）
        const monthNames = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];

        // UI管理（カスタマイズ可能領域）
        const UI_MANAGER = {
            updateKPIs: function() {
                const annualSales = rcData.sales.reduce((sum, val) => sum + val, 0);
                const annualCogs = rcData.cogs.reduce((sum, val) => sum + val, 0);
                const annualPersonnel = rcData.personnel.reduce((sum, val) => sum + val, 0);
                const annualExpenses = rcData.expenses.reduce((sum, val) => sum + val, 0);
                
                const grossProfit = annualSales - annualCogs;
                const totalExpenses = annualPersonnel + annualExpenses;
                const operatingProfit = grossProfit - totalExpenses;
                const profitRate = annualSales > 0 ? (operatingProfit / annualSales * 100).toFixed(1) : 0;
                
                // Phase 2修正: 年間販管費合計を表示
                const totalAdminExpenses = annualPersonnel + annualExpenses;

                document.getElementById('annual-sales').textContent = `${annualSales.toLocaleString()}万円`;
                document.getElementById('annual-profit').textContent = `${operatingProfit.toLocaleString()}万円`;
                document.getElementById('profit-rate').textContent = `${profitRate}%`;
                document.getElementById('annual-admin-expenses').textContent = `${totalAdminExpenses.toLocaleString()}万円`;
            },

            updateTable: function() {
                const tableBody = document.getElementById('table-body');
                if (!tableBody) return;

                let html = '';
                
                // Phase 2修正: 基準売上行と増減額行を非表示
                html += '<tr class="sales-row hidden-row"><td class="item-name">基準売上</td>';
                for (let i = 0; i < 12; i++) {
                    html += `<td>${CALCULATION_ENGINE.baseSales}</td>`;
                }
                html += `<td><strong>${CALCULATION_ENGINE.baseSales * 12}</strong></td><td>-</td></tr>`;

                html += '<tr class="sales-row hidden-row"><td class="item-name">増減額</td>';
                for (let i = 0; i < 12; i++) {
                    const variation = CALCULATION_ENGINE.variations[i];
                    const className = variation > 0 ? 'positive' : variation < 0 ? 'negative' : '';
                    const sign = variation > 0 ? '+' : '';
                    html += `<td class="${className}">${sign}${variation}</td>`;
                }
                const totalVariation = CALCULATION_ENGINE.variations.reduce((sum, val) => sum + val, 0);
                const varClass = totalVariation > 0 ? 'positive' : totalVariation < 0 ? 'negative' : '';
                html += `<td class="${varClass}"><strong>${totalVariation > 0 ? '+' : ''}${totalVariation}</strong></td><td>-</td></tr>`;

                // Phase 2修正: 実績売上→設定売上に変更
                html += '<tr class="sales-row"><td class="item-name">設定売上</td>';
                for (let i = 0; i < 12; i++) {
                    html += `<td>${rcData.sales[i].toLocaleString()}</td>`;
                }
                const totalSales = rcData.sales.reduce((sum, val) => sum + val, 0);
                html += `<td><strong>${totalSales.toLocaleString()}</strong></td>`;
                html += `<td class="positive">+${Math.round(totalSales * 0.05)}</td></tr>`;

                // 仕入原価行
                html += '<tr class="expense-row"><td class="item-name">仕入原価</td>';
                for (let i = 0; i < 12; i++) {
                    html += `<td>${rcData.cogs[i].toLocaleString()}</td>`;
                }
                const totalCogs = rcData.cogs.reduce((sum, val) => sum + val, 0);
                html += `<td><strong>${totalCogs.toLocaleString()}</strong></td>`;
                html += `<td class="negative">+${Math.round(totalCogs * 0.05)}</td></tr>`;

                // 売上総利益行
                html += '<tr class="gross-profit-row"><td class="item-name">売上総利益</td>';
                for (let i = 0; i < 12; i++) {
                    const grossProfit = rcData.sales[i] - rcData.cogs[i];
                    html += `<td>${grossProfit.toLocaleString()}</td>`;
                }
                const totalGrossProfit = totalSales - totalCogs;
                html += `<td><strong>${totalGrossProfit.toLocaleString()}</strong></td>`;
                html += `<td class="positive">+${Math.round(totalGrossProfit * 0.05)}</td></tr>`;

                // 空行
                html += '<tr><td colspan="15" style="border:none; padding:5px;"></td></tr>';

                // 販管費の詳細
                const expenseItems = [
                    { name: '固定人件費', values: rcData.personnel },
                    { name: '法定福利費', values: new Array(12).fill(6) },
                    { name: '支払手数料', values: new Array(12).fill(70) },
                    { name: '旅費交通費', values: new Array(12).fill(15) },
                    { name: '広告宣伝費', values: new Array(12).fill(CALCULATION_ENGINE.expenses.advertising) }
                ];

                // Phase 2修正: 販売促進費を販管費合計に変更
                const adminExpensesValues = new Array(12).fill(270); // 基本販管費（人件費除く）
                if (CALCULATION_ENGINE.expenses.exhibition > 0) {
                    adminExpensesValues[10] = 270 + CALCULATION_ENGINE.expenses.exhibition; // 5月（インデックス10）
                    adminExpensesValues[5] = 270 + CALCULATION_ENGINE.expenses.exhibition; // 12月（インデックス5）
                }
                expenseItems.push({ name: '販管費合計', values: adminExpensesValues });
                expenseItems.push({ name: 'その他固定費', values: new Array(12).fill(260) });

                // 各販管費項目を表示
                expenseItems.forEach(item => {
                    html += '<tr class="expense-row"><td class="item-name">' + item.name + '</td>';
                    for (let i = 0; i < 12; i++) {
                        const isHighlight = (item.name === '販管費合計' && (i === 10 || i === 5) && CALCULATION_ENGINE.expenses.exhibition > 0);
                        const style = isHighlight ? ' style="background: #fff3e0; font-weight: bold;"' : '';
                        html += `<td${style}>${item.values[i]}</td>`;
                    }
                    const total = item.values.reduce((sum, val) => sum + val, 0);
                    html += `<td><strong>${total}</strong></td><td>-</td></tr>`;
                });

                // 販売管理費計
                html += '<tr class="total-expense-row"><td class="item-name">販売管理費計</td>';
                for (let i = 0; i < 12; i++) {
                    const totalExpense = rcData.personnel[i] + rcData.expenses[i];
                    html += `<td>${totalExpense.toLocaleString()}</td>`;
                }
                const totalExpenses = rcData.personnel.reduce((sum, val) => sum + val, 0) + 
                                     rcData.expenses.reduce((sum, val) => sum + val, 0);
                html += `<td><strong>${totalExpenses.toLocaleString()}</strong></td>`;
                html += `<td>+${Math.round(totalExpenses * 0.02)}</td></tr>`;

                // 営業利益行
                html += '<tr class="operating-profit-row"><td class="item-name">営業利益</td>';
                for (let i = 0; i < 12; i++) {
                    const operatingProfit = rcData.sales[i] - rcData.cogs[i] - rcData.personnel[i] - rcData.expenses[i];
                    const className = operatingProfit >= 0 ? 'positive' : 'negative';
                    html += `<td class="${className}">${operatingProfit.toLocaleString()}</td>`;
                }
                const totalOperatingProfit = totalGrossProfit - totalExpenses;
                const profitClass = totalOperatingProfit >= 0 ? 'positive' : 'negative';
                html += `<td class="${profitClass}"><strong>${totalOperatingProfit.toLocaleString()}</strong></td>`;
                html += `<td class="${profitClass}">+${Math.round(totalOperatingProfit * 0.1)}</td></tr>`;

                tableBody.innerHTML = html;
            }
        };

        // Phase 2修正: 自動送信メッセージ表示（新規実装）
        function showAutoSendMessage() {
            const statusElement = document.getElementById('linkage-status');
            if (statusElement) {
                statusElement.innerHTML = 
                    `<strong>✓</strong> 統合PLへ自動送信完了: ${new Date().toLocaleString()}`;
                statusElement.className = 'linkage-status';
            }
        }

        // 【修正版】連携データ読み込み機能
        function loadLinkageData() {
            try {
                const rcDataStr = localStorage.getItem(STORAGE_KEYS.rc);
                const rcSettingsStr = localStorage.getItem(STORAGE_KEYS.rc_settings);
                
                if (rcDataStr) {
                    const parsedData = JSON.parse(rcDataStr);
                    console.log('RC卸連携データ受信:', parsedData);
                    
                    // baseSalesとvariations形式のデータ（budget-input.htmlから）
                    if (parsedData.baseSales !== undefined && parsedData.variations && Array.isArray(parsedData.variations)) {
                        CALCULATION_ENGINE.baseSales = parsedData.baseSales;
                        CALCULATION_ENGINE.variations = parsedData.variations;
                        
                        // 設定データの読み込み（修正版）
                        if (rcSettingsStr) {
                            const settings = JSON.parse(rcSettingsStr);
                            if (settings.advertising !== undefined) {
                                CALCULATION_ENGINE.expenses.advertising = settings.advertising;
                            }
                            // 12月の展示会費用
                            if (settings.decemberExhibition !== undefined) {
                                CALCULATION_ENGINE.expenses.exhibition = settings.decemberExhibition;
                            }
                            // 5月のブース料も設定
                            if (settings.mayBoothFee !== undefined) {
                                CALCULATION_ENGINE.expenses.promotion.exhibition.may = settings.mayBoothFee;
                                // 両月同じ金額を使用
                                if (!settings.decemberExhibition) {
                                    CALCULATION_ENGINE.expenses.exhibition = settings.mayBoothFee;
                                }
                            }
                        }
                        
                        // データを再計算
                        calculateRCData();
                        
                        document.getElementById('linkage-status').innerHTML = 
                            `<strong>✓</strong> 連携成功: ${new Date(parsedData.timestamp || new Date()).toLocaleString('ja-JP')} にデータ受信`;
                        document.getElementById('linkage-status').className = 'linkage-status';
                        
                        console.log('RC卸連携データ読み込み成功');
                    }
                    // sales配列形式のデータ（既存のv3.0形式）
                    else if (parsedData.sales && Array.isArray(parsedData.sales)) {
                        rcData.sales = parsedData.sales;
                        
                        if (parsedData.cogs) rcData.cogs = parsedData.cogs;
                        if (parsedData.personnel) rcData.personnel = parsedData.personnel;
                        if (parsedData.expenses) rcData.expenses = parsedData.expenses;
                        
                        document.getElementById('linkage-status').innerHTML = 
                            `<strong>✓</strong> 連携成功: ${new Date(parsedData.metadata?.lastUpdate || new Date()).toLocaleString('ja-JP')} にデータ受信`;
                        document.getElementById('linkage-status').className = 'linkage-status';
                        
                        console.log('RC卸連携データ読み込み成功（v3.0形式）');
                    } else {
                        throw new Error('データ形式が不正です');
                    }
                    
                    // UI更新
                    UI_MANAGER.updateKPIs();
                    UI_MANAGER.updateTable();
                    updateChart();
                    
                    // Phase 2修正: 自動送信タイミング設定
                    setTimeout(() => {
                        if (window.currentRCResults) {
                            sendToIntegratedPL(); // 既存の送信関数使用
                            showAutoSendMessage(); // メッセージ表示（新規実装）
                        }
                    }, 1500); // 1.5秒後に自動送信
                    
                } else {
                    // データが見つからない場合
                    document.getElementById('linkage-status').innerHTML = 
                        `<strong>⚠</strong> 連携データが見つかりません`;
                    document.getElementById('linkage-status').className = 'linkage-status linkage-warning';
                    
                    // デフォルト値で計算実行
                    calculateRCData();
                    UI_MANAGER.updateKPIs();
                    UI_MANAGER.updateTable();
                    updateChart();
                }
            } catch (error) {
                console.error('連携データ読み込みエラー:', error);
                document.getElementById('linkage-status').innerHTML = 
                    `<strong>✗</strong> 連携エラー: ${error.message}`;
                document.getElementById('linkage-status').className = 'linkage-status linkage-error';
                
                // エラー時もデフォルト値で表示
                calculateRCData();
                UI_MANAGER.updateKPIs();
                UI_MANAGER.updateTable();
                updateChart();
            }
        }

        // RC卸事業部固有の計算処理
        function calculateRCData() {
            // 売上計算（基準売上 + 月次変動）
            for (let i = 0; i < 12; i++) {
                rcData.sales[i] = CALCULATION_ENGINE.baseSales + CALCULATION_ENGINE.variations[i];
            }

            // 仕入原価計算（売上 × 原価率）
            for (let i = 0; i < 12; i++) {
                rcData.cogs[i] = Math.round(rcData.sales[i] * CALCULATION_ENGINE.cogsRate);
            }

            // 人件費計算（固定）
            for (let i = 0; i < 12; i++) {
                rcData.personnel[i] = CALCULATION_ENGINE.fixedPersonnel;
            }

            // 販管費計算（展示会費用含む）
            for (let i = 0; i < 12; i++) {
                let monthlyExpenses = 0;
                
                // 基本販管費
                monthlyExpenses += CALCULATION_ENGINE.expenses.welfare;
                monthlyExpenses += CALCULATION_ENGINE.expenses.fees;
                monthlyExpenses += CALCULATION_ENGINE.expenses.travel;
                monthlyExpenses += CALCULATION_ENGINE.expenses.advertising;
                monthlyExpenses += CALCULATION_ENGINE.expenses.other;
                
                // 販売促進費（展示会費用）
                if (i === 10) { // 5月（インデックス10）
                    monthlyExpenses += CALCULATION_ENGINE.expenses.promotion.base;
                    monthlyExpenses += CALCULATION_ENGINE.expenses.exhibition;
                } else if (i === 5) { // 12月（インデックス5）
                    monthlyExpenses += CALCULATION_ENGINE.expenses.promotion.base;
                    monthlyExpenses += CALCULATION_ENGINE.expenses.exhibition;
                } else {
                    monthlyExpenses += CALCULATION_ENGINE.expenses.promotion.base;
                }
                
                rcData.expenses[i] = monthlyExpenses;
            }

            // メタデータ更新
            rcData.metadata.lastUpdate = new Date().toISOString();

            // グローバル変数に保存（自動送信用）
            window.currentRCResults = rcData;
        }

        // 自動データ送信（保護領域 - 変更禁止）
        function autoSendData() {
            try {
                // v3.0形式でデータ保存
                localStorage.setItem(STORAGE_KEYS.rc, JSON.stringify(rcData));
                
                const integrationStatus = {
                    rc: {
                        status: 'success',
                        lastUpdate: new Date().toISOString(),
                        dataVersion: rcData.metadata.version
                    }
                };
                
                localStorage.setItem(STORAGE_KEYS.integration_status, JSON.stringify(integrationStatus));
                
                console.log('RC卸事業部データ自動送信完了', rcData);
                
            } catch (error) {
                console.error('データ送信エラー:', error);
            }
        }

        // チャート更新
        let monthlyChart;
        function updateChart() {
            const ctx = document.getElementById('monthlyChart');
            if (ctx && monthlyChart) {
                monthlyChart.destroy();
            }

            if (ctx) {
                const profitData = rcData.sales.map((sales, index) => 
                    sales - rcData.cogs[index] - rcData.personnel[index] - rcData.expenses[index]
                );
                
                // Phase 2修正: 販管費合計データ
                const adminExpensesData = rcData.personnel.map((personnel, index) => 
                    personnel + rcData.expenses[index]
                );

                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: monthNames,
                        datasets: [
                            {
                                label: '売上高',
                                data: rcData.sales,
                                backgroundColor: 'rgba(39, 174, 96, 0.8)',
                                borderColor: '#27ae60',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: '営業利益',
                                data: profitData,
                                type: 'line',
                                backgroundColor: 'rgba(135, 206, 235, 0.8)', // Phase 2修正: 水色に変更
                                borderColor: '#87ceeb',
                                borderWidth: 3,
                                fill: false,
                                yAxisID: 'y1'
                            },
                            {
                                label: '販管費合計', // Phase 2修正: 展示会費用→販管費合計
                                data: adminExpensesData,
                                backgroundColor: 'rgba(230, 126, 34, 0.8)',
                                borderColor: '#e67e22',
                                borderWidth: 1,
                                yAxisID: 'y2'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '売上高（万円）',
                                    color: '#27ae60'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '営業利益（万円）',
                                    color: '#87ceeb' // Phase 2修正: 水色に変更
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                            y2: {
                                type: 'linear',
                                display: false,
                                position: 'right'
                            }
                        }
                    }
                });
            }
        }

        // ボタン機能
        function exportToCSV() {
            const csvData = [];
            csvData.push(['項目', ...monthNames, '年間計']);
            csvData.push(['売上高', ...rcData.sales, rcData.sales.reduce((a, b) => a + b, 0)]);
            csvData.push(['仕入原価', ...rcData.cogs, rcData.cogs.reduce((a, b) => a + b, 0)]);
            csvData.push(['人件費', ...rcData.personnel, rcData.personnel.reduce((a, b) => a + b, 0)]);
            csvData.push(['販管費', ...rcData.expenses, rcData.expenses.reduce((a, b) => a + b, 0)]);
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rc_pl_data.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearLinkageData() {
            if (confirm('連携データをクリアしますか？')) {
                localStorage.removeItem(STORAGE_KEYS.rc);
                localStorage.removeItem(STORAGE_KEYS.rc_settings);
                localStorage.removeItem(STORAGE_KEYS.integration_status);
                document.getElementById('linkage-status').innerHTML = 
                    `<strong>-</strong> 手動入力モード`;
                document.getElementById('linkage-status').className = 'linkage-status linkage-warning';
                alert('連携データをクリアしました。手動入力モードです。');
            }
        }

        function sendToIntegratedPL() {
            calculateRCData();
            autoSendData();
            alert('統合PLシステムにデータを送信しました');
        }

        // 初期化処理
        document.addEventListener('DOMContentLoaded', function() {
            // 連携データ読み込み（修正版を使用）
            loadLinkageData();

            // Phase 2修正: 画面表示時の自動送信メッセージ実装
            setTimeout(() => {
                showAutoSendMessage();
            }, 2000); // 2秒後に自動送信メッセージ表示
        });
    </script>
</body>
</html>
