<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RC事業部PLシミュレーター BWJ費用可変対応版 v4.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        /* 通知システム */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            text-align: center;
            max-width: 400px;
        }

        .notification.success {
            border-left: 5px solid #10b981;
        }

        .notification.warning {
            border-left: 5px solid #f59e0b;
        }

        .notification.error {
            border-left: 5px solid #ef4444;
        }

        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
        }

        .header-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .nav-section {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            padding: 12px 20px;
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .btn-nav {
            padding: 8px 14px;
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-nav:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .btn-nav.btn-sr { background: #e53e3e; border-color: #e53e3e; }
        .btn-nav.btn-w { background: #3498db; border-color: #3498db; }
        .btn-nav.btn-rc { background: #38a169; border-color: #38a169; box-shadow: 0 4px 12px rgba(56, 161, 105, 0.4); }
        .btn-nav.btn-rcd { background: #805ad5; border-color: #805ad5; }

        .workflow-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            padding: 18px 20px;
            border-bottom: 3px solid #38a169;
        }

        .workflow-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .workflow-info {
            font-size: 0.9rem;
            color: #34495e;
            text-align: center;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .workflow-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #38a169, #2f7d59);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-csv {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-protection {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-protection.protected {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* パルス効果 */
        .btn-pulse {
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 20px rgba(56, 161, 105, 0.6);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(56, 161, 105, 0.6); }
            50% { box-shadow: 0 0 30px rgba(56, 161, 105, 0.8); }
            100% { box-shadow: 0 0 20px rgba(56, 161, 105, 0.6); }
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #38a169;
        }

        .chart-header {
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .kpi-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(56, 161, 105, 0.1);
            padding: 15px;
            margin: 10px 20px;
            border-radius: 8px;
            border: 2px solid #38a169;
            flex-wrap: wrap;
            gap: 10px;
        }

        .kpi-item {
            text-align: center;
            min-width: 120px;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: #34495e;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #38a169;
        }

        .kpi-value.negative {
            color: #e74c3c;
        }

        .chart-container {
            height: 250px;
            padding: 20px;
            background: white;
            position: relative;
        }

        .chart-legend {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 15px;
            font-size: 0.75rem;
            z-index: 10;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-blue { background: rgba(59, 130, 246, 0.7); }
        .legend-green { background: rgba(56, 161, 105, 0.7); }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #38a169;
        }

        .input-header {
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .input-controls {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .preset-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 75px;
        }

        .preset-btn.green { background: linear-gradient(135deg, #52c41a, #389e0d); color: white; }
        .preset-btn.blue { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .preset-btn.purple { background: linear-gradient(135deg, #722ed1, #531dab); color: white; }
        .preset-btn.red { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }

        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .preset-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .settings-inline {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #fff3e0;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #ff9800;
            flex-wrap: wrap;
        }

        .setting-label {
            font-weight: 600;
            color: #e65100;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .setting-input {
            width: 65px;
            padding: 4px 6px;
            border: 2px solid #ffcc02;
            border-radius: 4px;
            font-size: 0.75rem;
            text-align: center;
        }

        .setting-input:focus {
            border-color: #ff9800;
            outline: none;
        }

        .setting-input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            opacity: 0.8;
        }

        .input-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        .input-table th,
        .input-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 6px;
            text-align: center;
            line-height: 1.2;
        }

        .input-table th {
            background: linear-gradient(135deg, #38a169, #48bb78);
            color: white;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .input-table .row-header {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            text-align: left;
            padding-left: 12px;
            min-width: 60px;
        }

        .input-table input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #ddd;
            background: rgba(56, 161, 105, 0.1);
            border-radius: 3px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .input-table input:focus {
            background: rgba(56, 161, 105, 0.2);
            border-color: #38a169;
            outline: none;
        }

        .input-table input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            opacity: 0.8;
        }

        .diff-positive { color: #27ae60; font-weight: 700; }
        .diff-negative { color: #e74c3c; font-weight: 700; }
        .reference-value { color: #7f8c8d; font-size: 0.65rem; }

        .profit-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #52c41a;
        }

        .profit-header {
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .expense-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #34495e;
        }

        .expense-header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .profit-table,
        .expense-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            background: white;
            table-layout: fixed;
        }

        .profit-table th,
        .profit-table td,
        .expense-table th,
        .expense-table td {
            border: 1px solid #e2e8f0;
            padding: 6px 4px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .profit-table th:first-child,
        .profit-table td:first-child {
            width: 120px;
            white-space: normal;
            word-wrap: break-word;
            text-align: left;
            padding-left: 10px;
        }

        .expense-table th:first-child,
        .expense-table td:first-child {
            width: 40px;
        }

        .expense-table th:nth-child(2),
        .expense-table td:nth-child(2) {
            width: 120px;
            white-space: normal;
            word-wrap: break-word;
            text-align: left;
            padding-left: 10px;
        }

        .profit-table th:nth-child(n+2):nth-child(-n+13),
        .profit-table td:nth-child(n+2):nth-child(-n+13),
        .expense-table th:nth-child(n+3):nth-child(-n+14),
        .expense-table td:nth-child(n+3):nth-child(-n+14) {
            width: 60px;
        }

        .profit-table th:nth-child(n+14),
        .profit-table td:nth-child(n+14),
        .expense-table th:nth-child(n+15),
        .expense-table td:nth-child(n+15) {
            width: 80px;
        }

        .profit-table th {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            color: white;
            font-weight: 600;
            font-size: 0.65rem;
        }

        .expense-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: 600;
            font-size: 0.65rem;
        }

        .profit-table .profit-name {
            background: #f8f9fa;
            font-weight: 600;
        }

        .expense-table .expense-name {
            background: #f8f9fa;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .nav-buttons { gap: 6px; }
            .btn-nav { padding: 6px 10px; font-size: 0.7rem; }
            .input-controls { flex-direction: column; align-items: stretch; }
            .preset-buttons { justify-content: center; }
            .settings-inline { justify-content: center; flex-wrap: wrap; gap: 4px; }
            .setting-input { width: 55px; }
            .setting-label { font-size: 0.7rem; }
            .kpi-display { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section">
            <div class="nav-section">
                <div class="nav-buttons">
                    <a href="../index.html" class="btn-nav">ダッシュボード</a>
                    <a href="sr-pl.html" class="btn-nav btn-sr">SR事業部</a>
                    <a href="w-pl.html" class="btn-nav btn-w">W事業部</a>
                    <a href="rc-pl.html" class="btn-nav btn-rc">RC事業部</a>
                    <a href="rcd-pl.html" class="btn-nav btn-rcd">RCD社</a>
                    <a href="../combined-dashboard/index.html" class="btn-nav">全体PL</a>
                </div>
            </div>

            <div class="workflow-section">
                <div class="workflow-title">統合PLシステム ワークフロー - Step 3/4 進行中</div>
                <div class="workflow-info">
                    <span style="color: #27ae60; font-weight: 600;">✓ SR事業部完了</span>
                    <span style="margin: 0 10px; color: #bdc3c7;">|</span>
                    <span style="color: #27ae60; font-weight: 600;">✓ W事業部完了</span>
                    <span style="margin: 0 10px; color: #bdc3c7;">|</span>
                    <span style="color: #38a169; font-weight: 700;">● RC事業部設定中</span>
                    <span style="margin: 0 10px; color: #bdc3c7;">|</span>
                    <span style="color: #95a5a6;">RCD社待機</span>
                    <span style="margin: 0 10px; color: #bdc3c7;">→</span>
                    <span style="color: #f39c12; font-weight: 600;">合計PL統合</span>
                </div>
                <div class="workflow-actions">
                    <button class="action-btn btn-protection" id="protection-btn" onclick="toggleDataProtection()">
                        🔓 データ保護OFF
                    </button>
                    <button class="action-btn btn-csv" onclick="exportCSV()">
                        CSVエクスポート
                    </button>
                    <button class="action-btn btn-primary" id="send-data-btn" onclick="sendDataAndNavigate()">
                        RC事業部データ送信 → 次のステップ
                    </button>
                    <button class="action-btn btn-secondary" onclick="location.href='../combined-dashboard/index.html'">
                        全体PL分析へ
                    </button>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-header">
                参考前年数値との比較グラフ（BWJ費用可変対応版）
            </div>
            
            <div class="kpi-display">
                <div class="kpi-item">
                    <div class="kpi-label">年間売上合計</div>
                    <div class="kpi-value" id="annual-sales">18,600万円</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">前年対比増減</div>
                    <div class="kpi-value" id="sales-diff">+234万円</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">営業利益率</div>
                    <div class="kpi-value" id="profit-rate">49.3%</div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>参考</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>予算</span>
                    </div>
                </div>
                <canvas id="comparison-chart"></canvas>
            </div>
        </div>

        <div class="input-section">
            <div class="input-header">
                基準売上1,550万円 + 月別増減額入力 (万円)
            </div>
            
            <div class="input-controls">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyPreset('reference')">実績パターン</button>
                    <button class="preset-btn blue" onclick="applyPreset('standard')">標準設定</button>
                    <button class="preset-btn purple" onclick="applyPreset('growth4')">成長4%</button>
                    <button class="preset-btn red" onclick="applyPreset('improvement7')">改善7%</button>
                </div>

                <div class="settings-inline">
                    <label class="setting-label">広告宣伝費</label>
                    <input type="number" class="setting-input" id="advertising" value="40">
                    <span class="setting-label">万円/月</span>
                    
                    <div style="border-left: 2px solid #ff9800; height: 25px; margin: 0 8px;"></div>
                    
                    <label class="setting-label">BWJ施工費</label>
                    <input type="number" class="setting-input" id="bwj-construction" value="90">
                    <span class="setting-label">万円</span>
                    
                    <div style="border-left: 2px solid #ff9800; height: 25px; margin: 0 8px;"></div>
                    
                    <label class="setting-label">BWJ東京ブース費</label>
                    <input type="number" class="setting-input" id="bwj-tokyo" value="90">
                    <span class="setting-label">万円</span>
                </div>
            </div>

            <table class="input-table">
                <thead>
                    <tr>
                        <th>項目</th>
                        <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                        <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-header">増減額</td>
                        <td><input type="number" data-month="0" value="0" /></td>
                        <td><input type="number" data-month="1" value="0" /></td>
                        <td><input type="number" data-month="2" value="0" /></td>
                        <td><input type="number" data-month="3" value="0" /></td>
                        <td><input type="number" data-month="4" value="0" /></td>
                        <td><input type="number" data-month="5" value="0" /></td>
                        <td><input type="number" data-month="6" value="0" /></td>
                        <td><input type="number" data-month="7" value="0" /></td>
                        <td><input type="number" data-month="8" value="0" /></td>
                        <td><input type="number" data-month="9" value="0" /></td>
                        <td><input type="number" data-month="10" value="0" /></td>
                        <td><input type="number" data-month="11" value="0" /></td>
                    </tr>
                    <tr>
                        <td class="row-header">売上</td>
                        <td class="calculated-value" id="sales-0">1550</td>
                        <td class="calculated-value" id="sales-1">1550</td>
                        <td class="calculated-value" id="sales-2">1550</td>
                        <td class="calculated-value" id="sales-3">1550</td>
                        <td class="calculated-value" id="sales-4">1550</td>
                        <td class="calculated-value" id="sales-5">1550</td>
                        <td class="calculated-value" id="sales-6">1550</td>
                        <td class="calculated-value" id="sales-7">1550</td>
                        <td class="calculated-value" id="sales-8">1550</td>
                        <td class="calculated-value" id="sales-9">1550</td>
                        <td class="calculated-value" id="sales-10">1550</td>
                        <td class="calculated-value" id="sales-11">1550</td>
                    </tr>
                    <tr>
                        <td class="row-header">増減</td>
                        <td class="diff-value" id="diff-0">-20%</td>
                        <td class="diff-value" id="diff-1">-6%</td>
                        <td class="diff-value" id="diff-2">1%</td>
                        <td class="diff-value" id="diff-3">-10%</td>
                        <td class="diff-value" id="diff-4">33%</td>
                        <td class="diff-value" id="diff-5">-16%</td>
                        <td class="diff-value" id="diff-6">5%</td>
                        <td class="diff-value" id="diff-7">-2%</td>
                        <td class="diff-value" id="diff-8">25%</td>
                        <td class="diff-value" id="diff-9">32%</td>
                        <td class="diff-value" id="diff-10">-3%</td>
                        <td class="diff-value" id="diff-11">9%</td>
                    </tr>
                    <tr>
                        <td class="row-header">参考</td>
                        <td class="reference-value">1947</td>
                        <td class="reference-value">1645</td>
                        <td class="reference-value">1530</td>
                        <td class="reference-value">1730</td>
                        <td class="reference-value">1165</td>
                        <td class="reference-value">1846</td>
                        <td class="reference-value">1475</td>
                        <td class="reference-value">1585</td>
                        <td class="reference-value">1241</td>
                        <td class="reference-value">1173</td>
                        <td class="reference-value">1602</td>
                        <td class="reference-value">1420</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="profit-section">
            <div class="profit-header">
                売上総利益・営業利益月額表（BWJ費用可変対応版）
            </div>
            <table class="profit-table">
                <thead>
                    <tr>
                        <th>項目</th>
                        <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                        <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        <th>年間合計</th>
                        <th>月平均</th>
                    </tr>
                </thead>
                <tbody id="profit-table-body">
                </tbody>
            </table>
        </div>

        <div class="expense-section">
            <div class="expense-header">
                販管費19項目詳細表示（BWJ費用可変対応版）
            </div>
            <table class="expense-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>費用項目</th>
                        <th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th>12月</th>
                        <th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th>6月</th>
                        <th>年間</th>
                        <th>月次合計</th>
                    </tr>
                </thead>
                <tbody id="expense-table-body">
                </tbody>
                <tfoot id="expense-table-footer">
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        // グローバル変数
        const referenceData = [1947, 1645, 1530, 1730, 1165, 1846, 1475, 1585, 1241, 1173, 1602, 1420];
        const months = ['7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月'];
        
        let appData = {
            baseSales: 1550,
            variations: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            advertising: 40,
            bwjConstruction: 90,
            bwjTokyo: 90,
            cogsRate: 0.352,
            fixedPersonnel: 50
        };

        let chart = null;
        let dataProtectionState = {
            isProtected: false,
            autoSaveInterval: null,
            backupCount: 3
        };
        let csvExported = false;
        let backupCount = 0;

        // LocalStorageキー（統一規則）
        const STORAGE_KEY = 'pl_system_rc_corrected_data';
        const BACKUP_KEY = 'rc_pl_backups';
        const EMERGENCY_KEY = 'rc_pl_emergency_backup';

        // 販管費19項目の設定
        const expenseItems = [
            { name: '人件費', calculate: () => appData.fixedPersonnel },
            { name: '法定福利費', calculate: () => 7 },
            { name: '衛生費', calculate: () => 0 },
            { name: '物流管理費', calculate: () => 74 },
            { name: '地代家賃', calculate: () => 0 },
            { name: '外注費', calculate: () => 57 },
            { name: '貨物運賃', calculate: () => 62 },
            { name: '広告宣伝費', calculate: () => appData.advertising },
            { name: '旅費交通費', calculate: () => 15 },
            { name: '通信費', calculate: () => 1 },
            { name: '販売促進費', calculate: (month) => {
                let base = 10;
                if (month === 4) base += appData.bwjConstruction;
                if (month === 11) base += appData.bwjTokyo;
                return base;
            }},
            { name: '消耗品費', calculate: () => 36 },
            { name: '事務用品費', calculate: () => 10 },
            { name: '水道光熱費', calculate: () => 2 },
            { name: '支払手数料', calculate: () => 70 },
            { name: 'リース料', calculate: () => 7 },
            { name: '保険料', calculate: () => 1 },
            { name: '支払報酬料', calculate: () => 10 },
            { name: '減価償却費', calculate: () => 7 }
        ];

        // 通知システム 
        function showNotification(message, type = 'success', duration = 3000) {
            // 既存の通知を削除
            const existingNotifications = document.querySelectorAll('.notification, .notification-overlay');
            existingNotifications.forEach(el => el.remove());
            
            // オーバーレイ作成
            const overlay = document.createElement('div');
            overlay.className = 'notification-overlay';
            document.body.appendChild(overlay);
            
            // 通知作成
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="margin-bottom: 15px; font-weight: 600; font-size: 1.1rem;">
                    ${type === 'success' ? '✅' : type === 'warning' ? '⚠️' : '❌'} 
                    ${type === 'success' ? '成功' : type === 'warning' ? '警告' : 'エラー'}
                </div>
                <div style="margin-bottom: 20px; line-height: 1.5;">
                    ${message}
                </div>
                <button onclick="closeNotification()" style="padding: 8px 20px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer;">
                    OK
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // 自動閉じる
            setTimeout(() => {
                closeNotification();
            }, duration);
            
            // オーバーレイクリックで閉じる
            overlay.addEventListener('click', closeNotification);
        }

        function closeNotification() {
            const notifications = document.querySelectorAll('.notification, .notification-overlay');
            notifications.forEach(el => el.remove());
        }

        // データ保護機能
        function toggleDataProtection() {
            dataProtectionState.isProtected = !dataProtectionState.isProtected;
            
            if (dataProtectionState.isProtected) {
                enableDataProtection();
            } else {
                disableDataProtection();
            }
            
            updateProtectionStatus();
            saveToStorage(true);
        }

        function enableDataProtection() {
            // 入力フィールドを無効化
            const inputs = document.querySelectorAll('.input-table input, .setting-input');
            inputs.forEach(input => input.disabled = true);
            
            // プリセットボタンを無効化
            const presetBtns = document.querySelectorAll('.preset-btn');
            presetBtns.forEach(btn => btn.disabled = true);
            
            // 自動保存開始
            if (dataProtectionState.autoSaveInterval) {
                clearInterval(dataProtectionState.autoSaveInterval);
            }
            dataProtectionState.autoSaveInterval = setInterval(autoSave, 30000); // 30秒間隔
            
            // ページ離脱時の保存
            window.addEventListener('beforeunload', emergencySave);
            
            showNotification('データ保護が有効になりました。タブ移動・ページ遷移後もデータが保持されます。', 'success');
        }

        function disableDataProtection() {
            // 入力フィールドを有効化
            const inputs = document.querySelectorAll('.input-table input, .setting-input');
            inputs.forEach(input => input.disabled = false);
            
            // プリセットボタンを有効化
            const presetBtns = document.querySelectorAll('.preset-btn');
            presetBtns.forEach(btn => btn.disabled = false);
            
            // 自動保存停止
            if (dataProtectionState.autoSaveInterval) {
                clearInterval(dataProtectionState.autoSaveInterval);
                dataProtectionState.autoSaveInterval = null;
            }
            
            // ページ離脱時の保存を無効化
            window.removeEventListener('beforeunload', emergencySave);
            
            showNotification('データ保護が無効になりました。編集可能状態に戻りました。', 'warning');
        }

        function updateProtectionStatus() {
            const protectionBtn = document.getElementById('protection-btn');
            
            if (dataProtectionState.isProtected) {
                protectionBtn.innerHTML = '🔒 データ保護ON';
                protectionBtn.className = 'action-btn btn-protection protected';
            } else {
                protectionBtn.innerHTML = '🔓 データ保護OFF';
                protectionBtn.className = 'action-btn btn-protection';
            }
        }

        function autoSave() {
            try {
                const timestamp = new Date().toISOString();
                const backupData = {
                    ...appData,
                    timestamp: timestamp,
                    version: 'auto-backup'
                };
                
                // 最新3件のバックアップを保持
                let backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || '[]');
                backups.unshift(backupData);
                backups = backups.slice(0, dataProtectionState.backupCount);
                
                localStorage.setItem(BACKUP_KEY, JSON.stringify(backups));
                console.log('自動保存完了:', timestamp);
            } catch (error) {
                console.error('自動保存エラー:', error);
            }
        }

        function emergencySave() {
            try {
                const emergencyData = {
                    ...appData,
                    timestamp: new Date().toISOString(),
                    version: 'emergency-save'
                };
                
                localStorage.setItem(EMERGENCY_KEY, JSON.stringify(emergencyData));
                console.log('緊急保存完了');
            } catch (error) {
                console.error('緊急保存エラー:', error);
            }
        }

        function saveToStorage(isProtection = false) {
            try {
                const results = calculate();
                
                const unifiedData = {
                    metadata: {
                        department: 'RC',
                        version: '4.0_unified_corrected',
                        lastUpdate: new Date().toISOString(),
                        dataProtectionEnabled: dataProtectionState.isProtected,
                        personnelCalculationMethod: 'fixed_50',
                        bwjVariableCostSupport: true
                    },
                    sales: results.monthlyResults.map(m => m.sales),
                    cogs: results.monthlyResults.map(m => m.cogs),
                    personnel: Array(12).fill(appData.fixedPersonnel),
                    totalExpenses: new Array(12).fill(0).map((_, i) => {
                        return Object.values(results.expenses).reduce((sum, expenseArray) => {
                            return sum + (expenseArray[i] || 0);
                        }, 0);
                    }),
                    operatingProfit: results.monthlyResults.map((m, i) => {
                        const totalExpense = Object.values(results.expenses).reduce((sum, expenseArray) => {
                            return sum + (expenseArray[i] || 0);
                        }, 0);
                        return m.grossProfit - totalExpense;
                    }),
                    expenses: {},
                    annual: {
                        sales: results.annual.sales,
                        cogs: results.annual.cogs,
                        grossProfit: results.annual.grossProfit,
                        totalExpenses: results.annual.totalExpenses,
                        operatingProfit: results.annual.operatingProfit
                    },
                    exportedAt: csvExported ? new Date().toISOString() : null
                };

                // 37項目統一フォーマット対応
                expenseItems.forEach((item, index) => {
                    unifiedData.expenses[index + 1] = results.expenses[index];
                });

                // 統合PL用のゼロ項目追加
                [20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37].forEach(i => {
                    unifiedData.expenses[i] = Array(12).fill(0);
                });

                localStorage.setItem(STORAGE_KEY, JSON.stringify(unifiedData));
                
                if (isProtection) {
                    showNotification('データが正常に保護されました。', 'success');
                }
                
            } catch (error) {
                console.error('保存エラー:', error);
                showNotification('データ保存でエラーが発生しました。', 'error');
            }
        }

        function loadFromStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.metadata && data.metadata.dataProtectionEnabled) {
                        dataProtectionState.isProtected = data.metadata.dataProtectionEnabled;
                        if (dataProtectionState.isProtected) {
                            enableDataProtection();
                        }
                        updateProtectionStatus();
                    }
                    showNotification('保存されたデータを読み込みました。', 'success', 2000);
                    return true;
                }
            } catch (error) {
                console.error('読み込みエラー:', error);
            }
            return false;
        }

        // メイン計算関数
        function calculate() {
            collectInputs();

            const results = {
                monthlyResults: [],
                expenses: {},
                annual: {}
            };

            // 月次売上・原価計算
            results.monthlyResults = appData.variations.map((variation, i) => {
                const sales = appData.baseSales + variation;
                const cogs = Math.round(sales * appData.cogsRate);
                const grossProfit = sales - cogs;
                return { sales, cogs, grossProfit };
            });

            // 販管費計算
            expenseItems.forEach((item, index) => {
                results.expenses[index] = [];
                for (let month = 0; month < 12; month++) {
                    results.expenses[index][month] = item.calculate(month);
                }
            });

            // 年間集計
            results.annual = {
                sales: results.monthlyResults.reduce((sum, m) => sum + m.sales, 0),
                cogs: results.monthlyResults.reduce((sum, m) => sum + m.cogs, 0),
                grossProfit: results.monthlyResults.reduce((sum, m) => sum + m.grossProfit, 0),
                totalExpenses: Object.values(results.expenses).reduce((sum, expenseArray) => 
                    sum + expenseArray.reduce((expSum, val) => expSum + val, 0), 0)
            };
            results.annual.operatingProfit = results.annual.grossProfit - results.annual.totalExpenses;

            return results;
        }

        // 入力値収集
        function collectInputs() {
            if (dataProtectionState.isProtected) return;
            
            const inputs = document.querySelectorAll('input[data-month]');
            inputs.forEach(input => {
                const month = parseInt(input.dataset.month);
                const value = parseInt(input.value) || 0;
                appData.variations[month] = value;
            });

            const adElement = document.getElementById('advertising');
            const bwjCElement = document.getElementById('bwj-construction');
            const bwjTElement = document.getElementById('bwj-tokyo');
            
            if (adElement) appData.advertising = parseInt(adElement.value) || 40;
            if (bwjCElement) appData.bwjConstruction = parseInt(bwjCElement.value) || 90;
            if (bwjTElement) appData.bwjTokyo = parseInt(bwjTElement.value) || 90;
        }

        // 画面更新
        function updateDisplay() {
            const results = calculate();
            
            updateSalesDisplay();
            updateDifferenceDisplay();
            updateKPIDisplay(results.annual);
            updateChart();
            updateProfitTable(results);
            updateExpenseTable(results.expenses);
            
            // CSVが生成済みの場合はリセット
            if (csvExported) {
                csvExported = false;
                document.getElementById('send-data-btn').classList.remove('btn-pulse');
            }
            
            // データ保護が有効な場合は自動保存
            if (dataProtectionState.isProtected) {
                saveToStorage();
            }
        }

        // 売上表示更新
        function updateSalesDisplay() {
            appData.variations.forEach((variation, i) => {
                const element = document.getElementById(`sales-${i}`);
                if (element) {
                    element.textContent = formatNumber(appData.baseSales + variation);
                }
            });
        }

        // 差異表示更新
        function updateDifferenceDisplay() {
            appData.variations.forEach((variation, i) => {
                const currentSales = appData.baseSales + variation;
                const referenceValue = referenceData[i];
                const diffPercent = ((currentSales - referenceValue) / referenceValue * 100).toFixed(0);
                
                const element = document.getElementById(`diff-${i}`);
                if (element) {
                    element.textContent = (diffPercent >= 0 ? '+' : '') + diffPercent + '%';
                    element.className = diffPercent >= 0 ? 'diff-value diff-positive' : 'diff-value diff-negative';
                }
            });
        }

        // KPI表示更新
        function updateKPIDisplay(annual) {
            const refTotal = referenceData.reduce((sum, val) => sum + val, 0);
            const salesDiff = annual.sales - refTotal;
            const profitRate = annual.sales > 0 ? (annual.operatingProfit / annual.sales * 100).toFixed(1) : '0.0';

            const salesElement = document.getElementById('annual-sales');
            const diffElement = document.getElementById('sales-diff');
            const rateElement = document.getElementById('profit-rate');

            if (salesElement) salesElement.textContent = formatNumber(annual.sales) + '万円';
            if (diffElement) diffElement.textContent = (salesDiff >= 0 ? '+' : '') + formatNumber(salesDiff) + '万円';
            if (rateElement) {
                rateElement.textContent = profitRate + '%';
                rateElement.className = annual.operatingProfit >= 0 ? 'kpi-value' : 'kpi-value negative';
            }
        }

        // グラフ更新
        function updateChart() {
            const ctx = document.getElementById('comparison-chart');
            if (!ctx) return;

            if (chart) chart.destroy();

            const currentSales = appData.variations.map(variation => appData.baseSales + variation);

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '参考売上',
                            data: referenceData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2
                        },
                        {
                            label: '予算設定',
                            data: currentSales,
                            backgroundColor: 'rgba(56, 161, 105, 0.7)',
                            borderColor: 'rgba(56, 161, 105, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 10 } } },
                        x: { ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        // 利益表更新
        function updateProfitTable(results) {
            const tbody = document.getElementById('profit-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            // 月次販管費合計計算
            const monthlySGAExpenses = new Array(12).fill(0);
            Object.values(results.expenses).forEach(expenseArray => {
                expenseArray.forEach((val, monthIndex) => {
                    monthlySGAExpenses[monthIndex] += val;
                });
            });

            const tableData = [
                {
                    name: '売上高',
                    values: results.monthlyResults.map(m => m.sales),
                    style: 'background: #f6ffed; font-weight: 600; color: #237804;'
                },
                {
                    name: '仕入原価',
                    values: results.monthlyResults.map(m => m.cogs),
                    style: 'background: #fff7e6; font-weight: 600; color: #d48806;'
                },
                {
                    name: '売上総利益',
                    values: results.monthlyResults.map(m => m.grossProfit),
                    style: 'background: #e6f7ff; font-weight: 600; color: #1890ff;'
                },
                {
                    name: '販管費合計',
                    values: monthlySGAExpenses,
                    style: 'background: #fff0f6; font-weight: 600; color: #c41d7f;'
                },
                {
                    name: '営業利益',
                    values: results.monthlyResults.map((m, i) => m.grossProfit - monthlySGAExpenses[i]),
                    style: 'background: #f9f0ff; font-weight: 600; color: #722ed1;'
                }
            ];

            tableData.forEach((row) => {
                const annual = row.values.reduce((sum, val) => sum + val, 0);
                const average = Math.round(annual / 12);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="profit-name">${row.name}</td>
                    ${row.values.map(val => `<td style="${row.style}">${formatNumber(Math.round(val))}</td>`).join('')}
                    <td style="${row.style} border-left: 3px solid #333;">${formatNumber(annual)}</td>
                    <td style="${row.style} border-left: 2px solid #666;">${formatNumber(average)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 費用表更新
        function updateExpenseTable(expenses) {
            const tbody = document.getElementById('expense-table-body');
            const tfoot = document.getElementById('expense-table-footer');
            if (!tbody || !tfoot) return;
            
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            const monthlyTotals = new Array(12).fill(0);
            let grandTotal = 0;

            expenseItems.forEach((item, index) => {
                const monthlyExpenses = expenses[index];
                const annual = monthlyExpenses.reduce((sum, val) => sum + val, 0);

                if (annual === 0) return;

                monthlyExpenses.forEach((val, monthIndex) => {
                    monthlyTotals[monthIndex] += val;
                });
                grandTotal += annual;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; background: #f8f9fa; text-align: center;">${index + 1}</td>
                    <td class="expense-name">${item.name}</td>
                    ${monthlyExpenses.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                    <td style="font-weight: 700; background: #f8f9fa;">${formatNumber(annual)}</td>
                    <td style="font-weight: 700; background: #e8f5e8; color: #27ae60;">${formatNumber(Math.round(annual / 12))}</td>
                `;
                tbody.appendChild(row);
            });

            // 合計行
            const totalRow = document.createElement('tr');
            totalRow.style.background = '#34495e';
            totalRow.style.color = 'white';
            totalRow.style.fontWeight = '700';
            totalRow.innerHTML = `
                <td style="text-align: center;">合計</td>
                <td style="text-align: left; padding-left: 10px;">販管費合計</td>
                ${monthlyTotals.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                <td style="background: #2c3e50;">${formatNumber(grandTotal)}</td>
                <td style="background: #2c3e50;">${formatNumber(Math.round(grandTotal / 12))}</td>
            `;
            tfoot.appendChild(totalRow);
        }

        // プリセット適用
        function applyPreset(presetType) {
            if (dataProtectionState.isProtected) {
                showNotification('データ保護が有効です。先に保護を無効にしてください。', 'warning');
                return;
            }
            
            const inputs = document.querySelectorAll('input[data-month]');
            
            switch(presetType) {
                case 'reference':
                    referenceData.forEach((value, i) => {
                        const variation = value - appData.baseSales;
                        appData.variations[i] = variation;
                        if (inputs[i]) inputs[i].value = variation;
                    });
                    break;
                case 'standard':
                    appData.variations.fill(0);
                    inputs.forEach(input => input.value = 0);
                    break;
                case 'growth4':
                    referenceData.forEach((value, i) => {
                        const targetSales = Math.round(value * 1.04);
                        const variation = targetSales - appData.baseSales;
                        appData.variations[i] = variation;
                        if (inputs[i]) inputs[i].value = variation;
                    });
                    break;
                case 'improvement7':
                    referenceData.forEach((value, i) => {
                        const targetSales = Math.round(value * 1.07);
                        const variation = targetSales - appData.baseSales;
                        appData.variations[i] = variation;
                        if (inputs[i]) inputs[i].value = variation;
                    });
                    break;
            }
            
            updateDisplay();
            showNotification(`${presetType}パターンを適用しました。`, 'success');
        }

        // CSV出力
        function exportCSV() {
            try {
                const results = calculate();
                const csvData = [];
                const headers = ['項目名', '7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月', '4月', '5月', '6月', '年間合計'];
                csvData.push(headers);

                // 基本PL項目（37項目統一フォーマット対応）
                csvData.push(['売上高', ...results.monthlyResults.map(m => m.sales), results.annual.sales]);
                csvData.push(['売上原価', ...results.monthlyResults.map(m => m.cogs), results.annual.cogs]);
                csvData.push(['売上総利益', ...results.monthlyResults.map(m => m.grossProfit), results.annual.grossProfit]);

                // 販管費項目
                expenseItems.forEach((item, index) => {
                    const monthlyExpenses = results.expenses[index];
                    const annual = monthlyExpenses.reduce((sum, val) => sum + val, 0);
                    csvData.push([item.name, ...monthlyExpenses, annual]);
                });

                // 統合PL用ゼロ項目
                const zeroData = Array(12).fill(0);
                ['役員報酬', '役員法定福利費', '管理諸費', '修繕費', '車両費', '租税公課', '交際費', '諸会費', '会議費', '福利厚生費', '研修費', '雑費', '寄付金'].forEach(name => {
                    csvData.push([name, ...zeroData, 0]);
                });

                // 計算項目
                const totalExpensesData = new Array(12).fill(0);
                Object.values(results.expenses).forEach(expenseArray => {
                    expenseArray.forEach((val, monthIndex) => {
                        totalExpensesData[monthIndex] += val;
                    });
                });

                const operatingProfitData = results.monthlyResults.map((m, i) => m.grossProfit - totalExpensesData[i]);
                csvData.push(['販管費合計', ...totalExpensesData, results.annual.totalExpenses]);
                csvData.push(['営業利益', ...operatingProfitData, results.annual.operatingProfit]);

                // CSV生成・ダウンロード
                const csvString = '\uFEFF' + csvData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `RC事業部_PL_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                csvExported = true;
                showNotification('CSV出力が完了しました。送信準備が整いました！', 'success');
                
                // 送信ボタンにパルス効果を追加
                const sendBtn = document.getElementById('send-data-btn');
                sendBtn.classList.add('btn-pulse');
                
            } catch (error) {
                showNotification('CSV出力でエラーが発生しました: ' + error.message, 'error');
            }
        }

        // データ送信・画面移動
        function sendDataAndNavigate() {
            try {
                if (!csvExported) {
                    showNotification('先にCSVエクスポートを実行してください。', 'warning');
                    return;
                }

                const results = calculate();
                
                // データ保護を自動で有効化
                if (!dataProtectionState.isProtected) {
                    dataProtectionState.isProtected = true;
                    enableDataProtection();
                    updateProtectionStatus();
                }
                saveToStorage(false);
                
                const workflowProgress = {
                    step1_SR: 'completed',
                    step2_W: 'completed',
                    step3_RC: 'completed',
                    step4_RCD: 'waiting',
                    currentStep: 4,
                    lastUpdate: new Date().toISOString()
                };
                localStorage.setItem('workflow_progress', JSON.stringify(workflowProgress));
                
                showNotification(`RC事業部データ送信完了！

年間売上: ${formatNumber(results.annual.sales)}万円
年間営業利益: ${formatNumber(results.annual.operatingProfit)}万円
営業利益率: ${(results.annual.operatingProfit / results.annual.sales * 100).toFixed(1)}%

次のステップに移動します...`, 'success', 6000);
                
                setTimeout(() => {
                    window.location.href = 'rcd-pl.html';
                }, 3000);

            } catch (error) {
                showNotification('データ送信に失敗しました: ' + error.message, 'error');
            }
        }

        // ユーティリティ関数
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // イベントリスナー設定
        function setupEventListeners() {
            // 月別増減額入力
            const monthInputs = document.querySelectorAll('input[data-month]');
            monthInputs.forEach(input => {
                input.addEventListener('input', debounce(() => {
                    updateDisplay();
                }, 300));
            });

            // 可変費用入力
            const variableInputs = ['advertising', 'bwj-construction', 'bwj-tokyo'];
            variableInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', debounce(() => {
                        updateDisplay();
                    }, 300));
                }
            });

            // ページ離脱時の緊急保存
            window.addEventListener('beforeunload', (e) => {
                emergencySave();
                if (!dataProtectionState.isProtected && csvExported) {
                    e.preventDefault();
                    e.returnValue = 'データが未保護です。離脱してもよろしいですか？';
                }
            });

            // ページ非表示時の保存
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && !dataProtectionState.isProtected) {
                    emergencySave();
                }
            });
        }

        // 初期化
        function initialize() {
            try {
                loadFromStorage();
                updateDisplay();
                setupEventListeners();
                
                showNotification('RC事業部PLシステム v4.0 が起動しました。', 'success', 2000);
                
            } catch (error) {
                console.error('初期化エラー:', error);
                showNotification('システム初期化でエラーが発生しました。', 'error');
            }
        }

        // ページ読み込み完了時に初期化
        window.addEventListener('load', initialize);
