<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCäº‹æ¥­éƒ¨PLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ BWJè²»ç”¨å¯å¤‰å¯¾å¿œç‰ˆ v4.0ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿è­·å¼·åŒ–ç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* 4è¡Œãƒ˜ãƒƒãƒ€ãƒ¼æ§‹é€  */
        .header-row1 {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }

        .header-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .version-info {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 16px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: inline-block;
        }

        /* 2è¡Œç›®: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .header-row2 {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            padding: 8px 15px;
        }

        .nav-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 160px;
            max-width: 200px;
            padding: 8px 16px;
            font-size: 0.8em;
            border-radius: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
            text-align: center;
            cursor: pointer;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            color: white;
            text-decoration: none;
        }

        .btn-active-rc { 
            background: #27ae60 !important; 
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5) !important;
        }

        /* 3è¡Œç›®: KPIã‚«ãƒ¼ãƒ‰ */
        .header-row3 {
            background: #f8f9fa;
            padding: 12px 15px;
        }

        .mini-kpi-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mini-kpi {
            background: white;
            border-radius: 8px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            min-width: 120px;
            text-align: center;
        }

        .mini-kpi-label {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 3px;
        }

        .mini-kpi-value {
            font-size: 0.9em;
            font-weight: bold;
            color: #27ae60;
        }

        /* 4è¡Œç›®: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ± */
        .header-row4 {
            background: #ecf0f1;
            padding: 10px 15px;
            text-align: center;
        }

        .workflow-info {
            font-size: 0.9rem;
            color: #34495e;
            text-align: center;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .workflow-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        /* ãƒ‡ãƒ¼ã‚¿ä¿è­·çŠ¶æ³è¡¨ç¤º */
        .data-protection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid #e2e8f0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-protected { background: #10b981; }
        .status-unprotected { background: #f59e0b; }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-csv {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-protection {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-protection.protected {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #27ae60;
        }

        .chart-header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .kpi-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(39, 174, 96, 0.1);
            padding: 15px;
            margin: 10px 20px;
            border-radius: 8px;
            border: 2px solid #27ae60;
            flex-wrap: wrap;
            gap: 10px;
        }

        .kpi-item {
            text-align: center;
            min-width: 120px;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: #34495e;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #27ae60;
        }

        .chart-container {
            height: 250px;
            padding: 20px;
            background: white;
            position: relative;
        }

        .chart-legend {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 15px;
            font-size: 0.75rem;
            z-index: 10;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-blue { background: rgba(59, 130, 246, 0.7); }
        .legend-green { background: rgba(39, 174, 96, 0.7); }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #27ae60;
        }

        .input-header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .input-controls {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 90px;
        }

        .preset-btn.green { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .preset-btn.blue { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .preset-btn.purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .preset-btn.red { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }

        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .preset-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .settings-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff3e0;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #ff9800;
        }

        .setting-label {
            font-weight: 600;
            color: #e65100;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .setting-input {
            width: 80px;
            padding: 6px 8px;
            border: 2px solid #ffcc02;
            border-radius: 4px;
            font-size: 0.8rem;
            text-align: center;
        }

        .setting-input:focus {
            border-color: #ff9800;
            outline: none;
        }

        .setting-input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            opacity: 0.8;
        }

        .input-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        .input-table th,
        .input-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 6px;
            text-align: center;
            line-height: 1.2;
        }

        .input-table th {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .input-table .row-header {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            text-align: left;
            padding-left: 12px;
            min-width: 60px;
        }

        .input-table input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #ddd;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 3px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .input-table input:focus {
            background: rgba(39, 174, 96, 0.2);
            border-color: #27ae60;
            outline: none;
        }

        .input-table input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            opacity: 0.8;
        }

        .calculated-value {
            background: #e8f5e8;
            font-weight: 600;
            color: #27ae60;
        }

        .diff-positive { color: #27ae60; font-weight: 700; }
        .diff-negative { color: #e74c3c; font-weight: 700; }
        .reference-value { color: #7f8c8d; font-size: 0.65rem; }

        .profit-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #52c41a;
        }

        .profit-header {
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .expense-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #34495e;
        }

        .expense-header {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 12px 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .profit-table,
        .expense-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            background: white;
            table-layout: fixed;
        }

        .profit-table th,
        .profit-table td,
        .expense-table th,
        .expense-table td {
            border: 1px solid #e2e8f0;
            padding: 6px 4px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .profit-table th:first-child,
        .profit-table td:first-child {
            width: 120px;
            white-space: normal;
            word-wrap: break-word;
            text-align: left;
            padding-left: 10px;
        }

        .expense-table th:first-child,
        .expense-table td:first-child {
            width: 40px;
        }

        .expense-table th:nth-child(2),
        .expense-table td:nth-child(2) {
            width: 120px;
            white-space: normal;
            word-wrap: break-word;
            text-align: left;
            padding-left: 10px;
        }

        .profit-table th {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            color: white;
            font-weight: 600;
            font-size: 0.65rem;
        }

        .expense-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: 600;
            font-size: 0.65rem;
        }

        .profit-table .profit-name {
            background: #f8f9fa;
            font-weight: 600;
        }

        .expense-table .expense-name {
            background: #f8f9fa;
            font-weight: 600;
        }

        /* é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            text-align: center;
            max-width: 400px;
        }

        .notification.success {
            border-left: 5px solid #10b981;
        }

        .notification.warning {
            border-left: 5px solid #f59e0b;
        }

        .notification.error {
            border-left: 5px solid #ef4444;
        }

        .notification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
        }

        @media (max-width: 768px) {
            .header-row1, .header-row2, .header-row3, .header-row4 {
                padding: 10px;
            }
            
            .header-title {
                font-size: 1.3em;
            }
            
            .nav-container {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                min-width: 200px;
                max-width: 300px;
            }
            
            .mini-kpi-container {
                flex-direction: column;
                align-items: center;
            }
            
            .workflow-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .container { padding: 10px; }
            .input-controls { flex-direction: column; align-items: stretch; }
            .preset-buttons { justify-content: center; }
            .settings-inline { justify-content: center; }
            .kpi-display { flex-direction: column; gap: 15px; }
            .data-protection-status { 
                position: relative; 
                top: auto; 
                right: auto; 
                margin-bottom: 10px;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- 4è¡Œãƒ˜ãƒƒãƒ€ãƒ¼æ§‹é€  -->
    <div class="header-row1">
        <h1 class="header-title">RCäº‹æ¥­éƒ¨PLã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="version-info">BWJè²»ç”¨å¯å¤‰å¯¾å¿œãƒ»å›ºå®šè²»è¿½åŠ ãƒ»ãƒ‡ãƒ¼ã‚¿ä¿è­·æ©Ÿèƒ½ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€£æº</div>
    </div>

    <div class="header-row2">
        <div class="nav-container">
            <a href="sr-pl.html" class="btn">SRäº‹æ¥­éƒ¨PL</a>
            <a href="w-pl.html" class="btn">Wäº‹æ¥­éƒ¨PL</a>
            <a href="#" class="btn btn-active-rc">RCäº‹æ¥­éƒ¨PL</a>
            <a href="rcd-pl.html" class="btn">RCDäº‹æ¥­éƒ¨PL</a>
            <a href="../combined-dashboard/" class="btn">çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ </a>
        </div>
    </div>

    <div class="header-row3">
        <div class="mini-kpi-container">
            <div class="mini-kpi">
                <div class="mini-kpi-label">å¹´é–“å£²ä¸Šåˆè¨ˆ</div>
                <div class="mini-kpi-value" id="mini-annual-sales">18,600ä¸‡å††</div>
            </div>
            <div class="mini-kpi">
                <div class="mini-kpi-label">å–¶æ¥­åˆ©ç›Š</div>
                <div class="mini-kpi-value" id="mini-operating-profit">9,176ä¸‡å††</div>
            </div>
            <div class="mini-kpi">
                <div class="mini-kpi-label">å‰å¹´å¢—æ¸›</div>
                <div class="mini-kpi-value" id="mini-sales-diff">+234ä¸‡å††</div>
            </div>
            <div class="mini-kpi">
                <div class="mini-kpi-label">ãƒ‡ãƒ¼ã‚¿çŠ¶æ³</div>
                <div class="mini-kpi-value" id="mini-data-status">ä¿è­·ä¸­</div>
            </div>
        </div>
    </div>

    <div class="header-row4">
        <div class="workflow-info">
            <span style="color: #27ae60; font-weight: 600;">âœ“ SRäº‹æ¥­éƒ¨å®Œäº†</span>
            <span style="margin: 0 10px; color: #bdc3c7;">|</span>
            <span style="color: #27ae60; font-weight: 600;">âœ“ Wäº‹æ¥­éƒ¨å®Œäº†</span>
            <span style="margin: 0 10px; color: #bdc3c7;">|</span>
            <span style="color: #27ae60; font-weight: 700;">â— RCäº‹æ¥­éƒ¨è¨­å®šä¸­</span>
            <span style="margin: 0 10px; color: #bdc3c7;">|</span>
            <span style="color: #95a5a6;">RCDç¤¾å¾…æ©Ÿ</span>
            <span style="margin: 0 10px; color: #bdc3c7;">â†’</span>
            <span style="color: #f39c12; font-weight: 600;">åˆè¨ˆPLçµ±åˆ</span>
        </div>
        <div class="workflow-actions">
            <button class="action-btn btn-protection" id="protection-btn" onclick="toggleDataProtection()">
                ğŸ”’ ãƒ‡ãƒ¼ã‚¿ä¿è­·ON
            </button>
            <button class="action-btn btn-csv" onclick="exportRCCSV()">
                CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆä»»æ„ï¼‰
            </button>
            <button class="action-btn btn-primary" id="send-btn" onclick="sendRCDataAndNavigateToNext()">
                RCãƒ‡ãƒ¼ã‚¿é€ä¿¡ â†’ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— (RCDç¤¾)
            </button>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ä¿è­·çŠ¶æ³è¡¨ç¤º -->
    <div class="data-protection-status" id="protection-status">
        <div class="status-indicator" id="status-indicator"></div>
        <span id="status-text">ãƒ‡ãƒ¼ã‚¿ä¿è­·ON</span>
    </div>

    <div class="container">
        <div class="chart-section">
            <div class="chart-header">
                å‚è€ƒå‰å¹´æ•°å€¤ã¨ã®æ¯”è¼ƒã‚°ãƒ©ãƒ•ï¼ˆçµ±ä¸€æ§‹é€  Version 4.0ï¼‰
            </div>
            
            <div class="kpi-display">
                <div class="kpi-item">
                    <div class="kpi-label">å¹´é–“å£²ä¸Šåˆè¨ˆ</div>
                    <div class="kpi-value" id="annual-sales">18,600ä¸‡å††</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">å‰å¹´å¯¾æ¯”å¢—æ¸›</div>
                    <div class="kpi-value" id="sales-diff">+234ä¸‡å††</div>
                </div>
                <div class="kpi-item">
                    <div class="kpi-label">å–¶æ¥­åˆ©ç›Šç‡</div>
                    <div class="kpi-value" id="profit-rate">49.3%</div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-blue"></div>
                        <span>å‚è€ƒ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-green"></div>
                        <span>äºˆç®—</span>
                    </div>
                </div>
                <canvas id="rc-comparison-chart"></canvas>
            </div>
        </div>

        <div class="input-section">
            <div class="input-header">
                åŸºæº–å£²ä¸Š1,550ä¸‡å†† + æœˆåˆ¥å¢—æ¸›é¡å…¥åŠ› (ä¸‡å††)
            </div>
            
            <div class="input-controls">
                <div class="preset-buttons">
                    <button class="preset-btn green" onclick="applyRCPreset('actual')">å®Ÿç¸¾å€¤</button>
                    <button class="preset-btn blue" onclick="applyRCPreset('standard')">æ¨™æº–è¨­å®š</button>
                    <button class="preset-btn purple" onclick="applyRCPreset('growth4')">æˆé•·4%</button>
                    <button class="preset-btn red" onclick="applyRCPreset('improvement7')">æ”¹å–„7%</button>
                </div>

                <div class="settings-inline">
                    <label class="setting-label">åºƒå‘Šå®£ä¼è²»</label>
                    <input type="number" class="setting-input" id="advertising" value="40" onchange="updateRCSales()">
                    <span class="setting-label">ä¸‡å††/æœˆ</span>
                    
                    <div style="border-left: 2px solid #ff9800; height: 25px; margin: 0 8px;"></div>
                    
                    <label class="setting-label">BWJæ–½å·¥è²»</label>
                    <input type="number" class="setting-input" id="bwj-construction" value="90" onchange="updateRCSales()">
                    <span class="setting-label">ä¸‡å††</span>
                    
                    <div style="border-left: 2px solid #ff9800; height: 25px; margin: 0 8px;"></div>
                    
                    <label class="setting-label">BWJæ±äº¬ãƒ–ãƒ¼ã‚¹è²»</label>
                    <input type="number" class="setting-input" id="bwj-tokyo" value="90" onchange="updateRCSales()">
                    <span class="setting-label">ä¸‡å††</span>
                </div>
            </div>

            <table class="input-table">
                <thead>
                    <tr>
                        <th>é …ç›®</th>
                        <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                        <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="row-header">å¢—æ¸›é¡</td>
                        <td><input type="number" data-month="0" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="1" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="2" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="3" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="4" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="5" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="6" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="7" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="8" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="9" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="10" value="0" onchange="updateRCSales()" /></td>
                        <td><input type="number" data-month="11" value="0" onchange="updateRCSales()" /></td>
                    </tr>
                    <tr>
                        <td class="row-header">å£²ä¸Š</td>
                        <td class="calculated-value" id="sales-0">1550</td>
                        <td class="calculated-value" id="sales-1">1550</td>
                        <td class="calculated-value" id="sales-2">1550</td>
                        <td class="calculated-value" id="sales-3">1550</td>
                        <td class="calculated-value" id="sales-4">1550</td>
                        <td class="calculated-value" id="sales-5">1550</td>
                        <td class="calculated-value" id="sales-6">1550</td>
                        <td class="calculated-value" id="sales-7">1550</td>
                        <td class="calculated-value" id="sales-8">1550</td>
                        <td class="calculated-value" id="sales-9">1550</td>
                        <td class="calculated-value" id="sales-10">1550</td>
                        <td class="calculated-value" id="sales-11">1550</td>
                    </tr>
                    <tr>
                        <td class="row-header">å¢—æ¸›</td>
                        <td class="diff-value" data-diff="0">+0</td>
                        <td class="diff-value" data-diff="1">+0</td>
                        <td class="diff-value" data-diff="2">+0</td>
                        <td class="diff-value" data-diff="3">+0</td>
                        <td class="diff-value" data-diff="4">+0</td>
                        <td class="diff-value" data-diff="5">+0</td>
                        <td class="diff-value" data-diff="6">+0</td>
                        <td class="diff-value" data-diff="7">+0</td>
                        <td class="diff-value" data-diff="8">+0</td>
                        <td class="diff-value" data-diff="9">+0</td>
                        <td class="diff-value" data-diff="10">+0</td>
                        <td class="diff-value" data-diff="11">+0</td>
                    </tr>
                    <tr>
                        <td class="row-header">å‚è€ƒ</td>
                        <td class="reference-value">1947</td>
                        <td class="reference-value">1645</td>
                        <td class="reference-value">1530</td>
                        <td class="reference-value">1730</td>
                        <td class="reference-value">1165</td>
                        <td class="reference-value">1846</td>
                        <td class="reference-value">1475</td>
                        <td class="reference-value">1585</td>
                        <td class="reference-value">1241</td>
                        <td class="reference-value">1173</td>
                        <td class="reference-value">1602</td>
                        <td class="reference-value">1420</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="profit-section">
            <div class="profit-header">
                å£²ä¸Šç·åˆ©ç›Šãƒ»å–¶æ¥­åˆ©ç›Šæœˆé¡è¡¨ï¼ˆä¿®æ­£ç‰ˆå›ºå®šè²»ç”¨å¯¾å¿œï¼‰
            </div>
            <table class="profit-table">
                <thead>
                    <tr>
                        <th>é …ç›®</th>
                        <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                        <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                        <th>å¹´é–“åˆè¨ˆ</th>
                        <th>æœˆå¹³å‡</th>
                    </tr>
                </thead>
                <tbody id="profit-table-body">
                </tbody>
            </table>
        </div>

        <div class="expense-section">
            <div class="expense-header">
                è²©ç®¡è²»19é …ç›®è©³ç´°è¡¨ç¤ºï¼ˆçµ±ä¸€æ§‹é€  Version 4.0ï¼‰
            </div>
            <table class="expense-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>è²»ç”¨é …ç›®</th>
                        <th>7æœˆ</th><th>8æœˆ</th><th>9æœˆ</th><th>10æœˆ</th><th>11æœˆ</th><th>12æœˆ</th>
                        <th>1æœˆ</th><th>2æœˆ</th><th>3æœˆ</th><th>4æœˆ</th><th>5æœˆ</th><th>6æœˆ</th>
                        <th>å¹´é–“</th>
                        <th>æœˆæ¬¡åˆè¨ˆ</th>
                    </tr>
                </thead>
                <tbody id="expense-table-body">
                </tbody>
                <tfoot id="expense-table-footer">
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const rcReferenceData = [1947, 1645, 1530, 1730, 1165, 1846, 1475, 1585, 1241, 1173, 1602, 1420];
        const months = ['7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
        
        let rcData = {
            baseSales: 1550,
            variations: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            advertising: 40,
            bwjConstruction: 90,
            bwjTokyo: 90,
            cogsRate: 0.352,
            fixedPersonnel: 50
        };

        // ãƒ‡ãƒ¼ã‚¿ä¿è­·ã‚·ã‚¹ãƒ†ãƒ  - åˆæœŸçŠ¶æ…‹ã‚’ä¿è­·ONã«å¤‰æ›´
        let dataProtectionState = {
            isProtected: true,  // åˆæœŸçŠ¶æ…‹ã‚’ä¿è­·ONã«å¤‰æ›´
            autoSaveInterval: null,
            backupCount: 3
        };

        let rcChart = null;

        // å®Ÿç¸¾å€¤ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã™ã‚‹é–¢æ•°
        function setDefaultToActualValues() {
            rcData.variations = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]; // åŸºæº–å£²ä¸Š1550ä¸‡å††ã®ã¾ã¾
            rcData.advertising = 40;
            rcData.bwjConstruction = 90;
            rcData.bwjTokyo = 90;
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿è­·æ©Ÿèƒ½
        function toggleDataProtection() {
            dataProtectionState.isProtected = !dataProtectionState.isProtected;
            
            if (dataProtectionState.isProtected) {
                enableDataProtection();
            } else {
                disableDataProtection();
            }
            
            updateProtectionStatus();
            saveDataToStorage();
        }

        function enableDataProtection() {
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
            const inputs = document.querySelectorAll('.input-table input, .setting-input');
            inputs.forEach(input => input.disabled = true);
            
            // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const presetBtns = document.querySelectorAll('.preset-btn');
            presetBtns.forEach(btn => btn.disabled = true);
            
            // è‡ªå‹•ä¿å­˜é–‹å§‹
            if (dataProtectionState.autoSaveInterval) {
                clearInterval(dataProtectionState.autoSaveInterval);
            }
            dataProtectionState.autoSaveInterval = setInterval(autoSave, 30000); // 30ç§’é–“éš”
            
            // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ä¿å­˜
            window.addEventListener('beforeunload', emergencySave);
            
            showNotification('ãƒ‡ãƒ¼ã‚¿ä¿è­·ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚ã‚¿ãƒ–ç§»å‹•ãƒ»ãƒšãƒ¼ã‚¸é·ç§»å¾Œã‚‚ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã¾ã™ã€‚', 'success');
        }

        function disableDataProtection() {
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
            const inputs = document.querySelectorAll('.input-table input, .setting-input');
            inputs.forEach(input => input.disabled = false);
            
            // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const presetBtns = document.querySelectorAll('.preset-btn');
            presetBtns.forEach(btn => btn.disabled = false);
            
            // è‡ªå‹•ä¿å­˜åœæ­¢
            if (dataProtectionState.autoSaveInterval) {
                clearInterval(dataProtectionState.autoSaveInterval);
                dataProtectionState.autoSaveInterval = null;
            }
            
            // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ä¿å­˜ã‚’ç„¡åŠ¹åŒ–
            window.removeEventListener('beforeunload', emergencySave);
            
            showNotification('ãƒ‡ãƒ¼ã‚¿ä¿è­·ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚ç·¨é›†å¯èƒ½çŠ¶æ…‹ã«æˆ»ã‚Šã¾ã—ãŸã€‚', 'warning');
        }

        function updateProtectionStatus() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const protectionBtn = document.getElementById('protection-btn');
            
            if (dataProtectionState.isProtected) {
                statusIndicator.className = 'status-indicator status-protected';
                statusText.textContent = 'ãƒ‡ãƒ¼ã‚¿ä¿è­·ON';
                protectionBtn.innerHTML = 'ğŸ”’ ãƒ‡ãƒ¼ã‚¿ä¿è­·ON';
                protectionBtn.className = 'action-btn btn-protection protected';
            } else {
                statusIndicator.className = 'status-indicator status-unprotected';
                statusText.textContent = 'ãƒ‡ãƒ¼ã‚¿ä¿è­·OFF';
                protectionBtn.innerHTML = 'ğŸ”“ ãƒ‡ãƒ¼ã‚¿ä¿è­·OFF';
                protectionBtn.className = 'action-btn btn-protection';
            }

            // ãƒŸãƒ‹KPIã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³æ›´æ–°
            const statusElement = document.getElementById('mini-data-status');
            if (dataProtectionState.isProtected) {
                statusElement.textContent = 'ä¿è­·ä¸­';
                statusElement.style.color = '#28a745';
            } else {
                statusElement.textContent = 'è¨­å®šä¸­';
                statusElement.style.color = '#f39c12';
            }
        }

        function autoSave() {
            try {
                const timestamp = new Date().toISOString();
                const backupData = {
                    rcData: JSON.parse(JSON.stringify(rcData)),
                    timestamp: timestamp,
                    version: 'auto-backup'
                };
                
                // æœ€æ–°3ä»¶ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿æŒ
                let backups = JSON.parse(localStorage.getItem('rc_pl_backups') || '[]');
                backups.unshift(backupData);
                backups = backups.slice(0, dataProtectionState.backupCount);
                
                localStorage.setItem('rc_pl_backups', JSON.stringify(backups));
                console.log('è‡ªå‹•ä¿å­˜å®Œäº†:', timestamp);
            } catch (error) {
                console.error('è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function emergencySave() {
            try {
                const emergencyData = {
                    rcData: JSON.parse(JSON.stringify(rcData)),
                    timestamp: new Date().toISOString(),
                    version: 'emergency-save'
                };
                
                localStorage.setItem('rc_pl_emergency_backup', JSON.stringify(emergencyData));
                console.log('ç·Šæ€¥ä¿å­˜å®Œäº†');
            } catch (error) {
                console.error('ç·Šæ€¥ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function saveDataToStorage() {
            try {
                const storageData = {
                    rcData: JSON.parse(JSON.stringify(rcData)),
                    protectionState: dataProtectionState.isProtected,
                    timestamp: new Date().toISOString(),
                    version: 'v4.0'
                };
                
                localStorage.setItem('pl_system_rc_corrected_data', JSON.stringify(storageData));
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function loadDataFromStorage() {
            try {
                const stored = localStorage.getItem('pl_system_rc_corrected_data');
                if (stored) {
                    const storageData = JSON.parse(stored);
                    
                    if (storageData.rcData) {
                        rcData = storageData.rcData;
                        
                        // è¨­å®šå€¤ã‚’UIã«åæ˜ 
                        document.getElementById('advertising').value = rcData.advertising;
                        document.getElementById('bwj-construction').value = rcData.bwjConstruction;
                        document.getElementById('bwj-tokyo').value = rcData.bwjTokyo;
                        
                        // å£²ä¸Šå€¤ã‚’UIã«åæ˜ 
                        const inputs = document.querySelectorAll('input[data-month]');
                        inputs.forEach((input, i) => {
                            input.value = rcData.variations[i];
                        });
                    }
                    
                    if (storageData.protectionState) {
                        dataProtectionState.isProtected = true;
                        enableDataProtection();
                    }
                    
                    updateProtectionStatus();
                    
                    console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ');
                    return true;
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆæœŸå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚', 'warning');
            }
            return false;
        }

        // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
        function showNotification(message, type = 'success', duration = 3000) {
            // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
            const existingNotifications = document.querySelectorAll('.notification, .notification-overlay');
            existingNotifications.forEach(el => el.remove());
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä½œæˆ
            const overlay = document.createElement('div');
            overlay.className = 'notification-overlay';
            document.body.appendChild(overlay);
            
            // é€šçŸ¥ä½œæˆ
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="margin-bottom: 15px; font-weight: 600; font-size: 1.1rem;">
                    ${type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'âŒ'} 
                    ${type === 'success' ? 'æˆåŠŸ' : type === 'warning' ? 'è­¦å‘Š' : 'ã‚¨ãƒ©ãƒ¼'}
                </div>
                <div style="margin-bottom: 20px; line-height: 1.5;">
                    ${message}
                </div>
                <button onclick="closeNotification()" style="padding: 8px 20px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer;">
                    OK
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // è‡ªå‹•é–‰ã˜ã‚‹
            setTimeout(() => {
                closeNotification();
            }, duration);
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            overlay.addEventListener('click', closeNotification);
        }

        function closeNotification() {
            const notifications = document.querySelectorAll('.notification, .notification-overlay');
            notifications.forEach(el => el.remove());
        }

        // RCäº‹æ¥­éƒ¨å°‚ç”¨è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ 
        function calculateRC() {
            const results = {
                monthlyResults: [],
                expenses: {},
                annual: {}
            };

            results.monthlyResults = rcData.variations.map((variation, i) => {
                const sales = rcData.baseSales + variation;
                const cogs = Math.round(sales * rcData.cogsRate);
                const grossProfit = sales - cogs;
                return { sales, cogs, grossProfit };
            });

            results.expenses = {
                1: results.monthlyResults.map(() => rcData.fixedPersonnel),
                2: results.monthlyResults.map(() => 7),
                3: results.monthlyResults.map(() => 0),
                4: results.monthlyResults.map(() => 74),
                5: results.monthlyResults.map(() => 0),
                6: results.monthlyResults.map(() => 57),
                7: results.monthlyResults.map(() => 62),
                8: results.monthlyResults.map(() => rcData.advertising),
                9: results.monthlyResults.map(() => 15),
                10: results.monthlyResults.map(() => 1),
                11: results.monthlyResults.map((m, i) => {
                    let base = 10;
                    if (i === 4) base += rcData.bwjConstruction;
                    if (i === 11) base += rcData.bwjTokyo;
                    return base;
                }),
                12: results.monthlyResults.map(() => 36),
                13: results.monthlyResults.map(() => 10),
                14: results.monthlyResults.map(() => 2),
                15: results.monthlyResults.map(() => 70),
                16: results.monthlyResults.map(() => 7),
                17: results.monthlyResults.map(() => 1),
                18: results.monthlyResults.map(() => 10),
                19: results.monthlyResults.map(() => 7)
            };

            results.annual = {
                sales: results.monthlyResults.reduce((sum, m) => sum + m.sales, 0),
                cogs: results.monthlyResults.reduce((sum, m) => sum + m.cogs, 0),
                grossProfit: results.monthlyResults.reduce((sum, m) => sum + m.grossProfit, 0),
                totalExpenses: Object.values(results.expenses).reduce((sum, expenseArray) => 
                    sum + expenseArray.reduce((expSum, val) => expSum + val, 0), 0),
            };
            results.annual.operatingProfit = results.annual.grossProfit - results.annual.totalExpenses;

            return results;
        }

        function updateRCSales() {
            if (dataProtectionState.isProtected) return;
            
            const inputs = document.querySelectorAll('input[data-month]');
            inputs.forEach(input => {
                const month = parseInt(input.dataset.month);
                const value = parseInt(input.value) || 0;
                rcData.variations[month] = value;
            });

            rcData.advertising = parseInt(document.getElementById('advertising').value) || 40;
            rcData.bwjConstruction = parseInt(document.getElementById('bwj-construction').value) || 90;
            rcData.bwjTokyo = parseInt(document.getElementById('bwj-tokyo').value) || 90;
            
            const results = calculateRC();

            updateSalesDisplay();
            updateDifferenceDisplay();
            updateKPIDisplay(results.annual);
            updateMiniKPIDisplay(results.annual);
            updateChart();
            updateProfitTable(results);
            updateExpenseTable(results.expenses);
            
            // ãƒ‡ãƒ¼ã‚¿ä¿è­·ãŒæœ‰åŠ¹ãªå ´åˆã¯è‡ªå‹•ä¿å­˜
            if (dataProtectionState.isProtected) {
                saveDataToStorage();
            }
        }

        function updateSalesDisplay() {
            rcData.variations.forEach((variation, i) => {
                const element = document.getElementById(`sales-${i}`);
                if (element) {
                    element.textContent = formatNumber(rcData.baseSales + variation);
                }
            });
        }

        function updateDifferenceDisplay() {
            rcData.variations.forEach((variation, i) => {
                const diffElement = document.querySelector(`[data-diff="${i}"]`);
                if (diffElement) {
                    const currentSales = rcData.baseSales + variation;
                    const referenceValue = rcReferenceData[i];
                    const diff = currentSales - referenceValue;
                    diffElement.textContent = diff >= 0 ? `+${diff}` : `${diff}`;
                    diffElement.className = diff >= 0 ? 'diff-value diff-positive' : 'diff-value diff-negative';
                }
            });
        }

        function updateKPIDisplay(annual) {
            const refTotal = rcReferenceData.reduce((sum, val) => sum + val, 0);
            const salesDiff = annual.sales - refTotal;
            const profitRate = annual.sales > 0 ? (annual.operatingProfit / annual.sales * 100).toFixed(1) : '0.0';

            document.getElementById('annual-sales').textContent = formatNumber(annual.sales) + 'ä¸‡å††';
            document.getElementById('sales-diff').textContent = (salesDiff >= 0 ? '+' : '') + formatNumber(salesDiff) + 'ä¸‡å††';
            document.getElementById('profit-rate').textContent = profitRate + '%';
        }

        function updateMiniKPIDisplay(annual) {
            const refTotal = rcReferenceData.reduce((sum, val) => sum + val, 0);
            const salesDiff = annual.sales - refTotal;

            document.getElementById('mini-annual-sales').textContent = formatNumber(annual.sales) + 'ä¸‡å††';
            document.getElementById('mini-operating-profit').textContent = formatNumber(annual.operatingProfit) + 'ä¸‡å††';
            
            const diffElement = document.getElementById('mini-sales-diff');
            diffElement.textContent = (salesDiff >= 0 ? '+' : '') + formatNumber(salesDiff) + 'ä¸‡å††';
            diffElement.style.color = salesDiff >= 0 ? '#28a745' : '#dc3545';
        }

        function updateChart() {
            const ctx = document.getElementById('rc-comparison-chart');
            if (!ctx) return;

            if (rcChart) rcChart.destroy();

            const currentSales = rcData.variations.map(variation => rcData.baseSales + variation);

            rcChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'å‚è€ƒå£²ä¸Š',
                            data: rcReferenceData,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'äºˆç®—è¨­å®š',
                            data: currentSales,
                            backgroundColor: 'rgba(39, 174, 96, 0.7)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 10 } } },
                        x: { ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        function updateProfitTable(results) {
            const tbody = document.getElementById('profit-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            // æœˆæ¬¡è²©ç®¡è²»åˆè¨ˆè¨ˆç®—
            const monthlySGAExpenses = new Array(12).fill(0);
            Object.values(results.expenses).forEach(expenseArray => {
                expenseArray.forEach((val, monthIndex) => {
                    monthlySGAExpenses[monthIndex] += val;
                });
            });

            const tableData = [
                {
                    name: 'å£²ä¸Šé«˜',
                    values: results.monthlyResults.map(m => m.sales),
                    style: 'background: #f6ffed; font-weight: 600; color: #237804;'
                },
                {
                    name: 'ä»•å…¥åŸä¾¡',
                    values: results.monthlyResults.map(m => m.cogs),
                    style: 'background: #fff7e6; font-weight: 600; color: #d48806;'
                },
                {
                    name: 'å£²ä¸Šç·åˆ©ç›Š',
                    values: results.monthlyResults.map(m => m.grossProfit),
                    style: 'background: #e6f7ff; font-weight: 600; color: #1890ff;'
                },
                {
                    name: 'äººä»¶è²»å›ºå®šï¼ˆä¿®æ­£ç‰ˆï¼‰',
                    values: results.monthlyResults.map(() => rcData.fixedPersonnel),
                    style: 'background: #fff3cd; font-weight: bold; color: #e65100;'
                },
                {
                    name: 'æ³•å®šç¦åˆ©è²»',
                    values: results.monthlyResults.map(() => 7),
                    style: 'background: #f0f9ff; font-weight: 600; color: #0369a1;'
                },
                {
                    name: 'è²©ç®¡è²»åˆè¨ˆ',
                    values: monthlySGAExpenses,
                    style: 'background: #fff0f6; font-weight: 600; color: #c41d7f;'
                },
                {
                    name: 'å–¶æ¥­åˆ©ç›Š',
                    values: results.monthlyResults.map((m, i) => m.grossProfit - monthlySGAExpenses[i]),
                    style: 'background: #f9f0ff; font-weight: 600; color: #722ed1;'
                }
            ];

            tableData.forEach((row) => {
                const annual = row.values.reduce((sum, val) => sum + val, 0);
                const average = Math.round(annual / 12);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="profit-name">${row.name}</td>
                    ${row.values.map(val => `<td style="${row.style}">${formatNumber(Math.round(val))}</td>`).join('')}
                    <td style="${row.style} border-left: 3px solid #333;">${formatNumber(annual)}</td>
                    <td style="${row.style} border-left: 2px solid #666;">${formatNumber(average)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateExpenseTable(expenses) {
            const expenseNames = [
                'äººä»¶è²»', 'æ³•å®šç¦åˆ©è²»', 'è¡›ç”Ÿè²»', 'ç‰©æµç®¡ç†è²»', 'åœ°ä»£å®¶è³ƒ',
                'å¤–æ³¨è²»', 'é‹é€é‹è³ƒ', 'åºƒå‘Šå®£ä¼è²»', 'æ—…è²»äº¤é€šè²»', 'é€šä¿¡è²»',
                'è²©å£²ä¿ƒé€²è²»', 'æ¶ˆè€—å“è²»', 'äº‹å‹™ç”¨å“è²»', 'æ°´é“å…‰ç†±è²»', 'æ”¯æ‰•æ‰‹æ•°æ–™',
                'ãƒªãƒ¼ã‚¹æ–™', 'ä¿é™ºæ–™', 'æ”¯æ‰•å ±é…¬æ–™', 'æ¸›ä¾¡å„Ÿå´è²»'
            ];

            const tbody = document.getElementById('expense-table-body');
            const tfoot = document.getElementById('expense-table-footer');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            const monthlyTotals = new Array(12).fill(0);
            let grandTotal = 0;

            expenseNames.forEach((name, index) => {
                const expenseId = index + 1;
                const monthlyExpenses = expenses[expenseId];
                const annual = monthlyExpenses.reduce((sum, val) => sum + val, 0);

                if (annual === 0) return;

                monthlyExpenses.forEach((val, monthIndex) => {
                    monthlyTotals[monthIndex] += val;
                });
                grandTotal += annual;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; background: #f8f9fa; text-align: center;">${expenseId}</td>
                    <td class="expense-name">${name}</td>
                    ${monthlyExpenses.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                    <td style="font-weight: 700; background: #f8f9fa;">${formatNumber(annual)}</td>
                    <td style="font-weight: 700; background: #e8f5e8; color: #27ae60;">${formatNumber(Math.round(annual / 12))}</td>
                `;
                tbody.appendChild(row);
            });

            const totalRow = document.createElement('tr');
            totalRow.style.background = '#34495e';
            totalRow.style.color = 'white';
            totalRow.style.fontWeight = '700';
            totalRow.innerHTML = `
                <td style="text-align: center;">åˆè¨ˆ</td>
                <td style="text-align: left; padding-left: 10px;">è²©ç®¡è²»åˆè¨ˆ</td>
                ${monthlyTotals.map(val => `<td>${formatNumber(val)}</td>`).join('')}
                <td style="background: #2c3e50;">${formatNumber(grandTotal)}</td>
                <td style="background: #2c3e50;">${formatNumber(Math.round(grandTotal / 12))}</td>
            `;
            tfoot.appendChild(totalRow);
        }

        function applyRCPreset(presetType) {
            if (dataProtectionState.isProtected) {
                showNotification('ãƒ‡ãƒ¼ã‚¿ä¿è­·ãŒæœ‰åŠ¹ã§ã™ã€‚å…ˆã«ä¿è­·ã‚’ç„¡åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚', 'warning');
                return;
            }
            
            const inputs = document.querySelectorAll('input[data-month]');
            
            switch(presetType) {
                case 'actual':
                    rcReferenceData.forEach((value, i) => {
                        const variation = value - rcData.baseSales;
                        rcData.variations[i] = variation;
                        inputs[i].value = variation;
                    });
                    break;
                case 'standard':
                    rcData.variations.fill(0);
                    inputs.forEach(input => input.value = 0);
                    break;
                case 'growth4':
                    rcReferenceData.forEach((value, i) => {
                        const targetSales = Math.round(value * 1.04);
                        const variation = targetSales - rcData.baseSales;
                        rcData.variations[i] = variation;
                        inputs[i].value = variation;
                    });
                    break;
                case 'improvement7':
                    rcReferenceData.forEach((value, i) => {
                        const targetSales = Math.round(value * 1.07);
                        const variation = targetSales - rcData.baseSales;
                        rcData.variations[i] = variation;
                        inputs[i].value = variation;
                    });
                    break;
            }
            
            updateRCSales();
        }

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆRCäº‹æ¥­éƒ¨ç‰ˆï¼‰
        function exportRCCSV() {
            try {
                const results = calculateRC();

                const csvData = [];
                const headers = ['é …ç›®å', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 'å¹´é–“åˆè¨ˆ'];
                csvData.push(headers);

                // åŸºæœ¬PLé …ç›®
                csvData.push(['å£²ä¸Šé«˜', ...rcData.variations.map(v => rcData.baseSales + v), results.annual.sales]);
                csvData.push(['å£²ä¸ŠåŸä¾¡', ...results.monthlyResults.map(m => m.cogs), results.annual.cogs]);
                csvData.push(['å£²ä¸Šç·åˆ©ç›Š', ...results.monthlyResults.map(m => m.grossProfit), results.annual.grossProfit]);

                // è²©ç®¡è²»19é …ç›®
                const expenseNames = [
                    'äººä»¶è²»', 'æ³•å®šç¦åˆ©è²»', 'è¡›ç”Ÿè²»', 'ç‰©æµç®¡ç†è²»', 'åœ°ä»£å®¶è³ƒ',
                    'å¤–æ³¨è²»', 'é‹é€é‹è³ƒ', 'åºƒå‘Šå®£ä¼è²»', 'æ—…è²»äº¤é€šè²»', 'é€šä¿¡è²»',
                    'è²©å£²ä¿ƒé€²è²»', 'æ¶ˆè€—å“è²»', 'äº‹å‹™ç”¨å“è²»', 'æ°´é“å…‰ç†±è²»', 'æ”¯æ‰•æ‰‹æ•°æ–™',
                    'ãƒªãƒ¼ã‚¹æ–™', 'ä¿é™ºæ–™', 'æ”¯æ‰•å ±é…¬æ–™', 'æ¸›ä¾¡å„Ÿå´è²»'
                ];

                expenseNames.forEach((name, index) => {
                    const expenseId = index + 1;
                    const monthlyExpenses = results.expenses[expenseId];
                    const annual = monthlyExpenses.reduce((sum, val) => sum + val, 0);
                    csvData.push([name, ...monthlyExpenses, annual]);
                });

                // çµ±åˆPLå°‚ç”¨é …ç›®ï¼ˆRCäº‹æ¥­éƒ¨ã§ã¯0å††å‡ºåŠ›ï¼‰
                const zeroData = Array(12).fill(0);
                csvData.push(['å½¹å“¡å ±é…¬', ...zeroData, 0]);
                csvData.push(['å½¹å“¡æ³•å®šç¦åˆ©è²»', ...zeroData, 0]);
                csvData.push(['ç®¡ç†è«¸è²»', ...zeroData, 0]);
                csvData.push(['ä¿®ç¹•è²»', ...zeroData, 0]);
                csvData.push(['è»Šä¸¡è²»', ...zeroData, 0]);
                csvData.push(['ç§Ÿç¨å…¬èª²', ...zeroData, 0]);
                csvData.push(['äº¤éš›è²»', ...zeroData, 0]);
                csvData.push(['è«¸ä¼šè²»', ...zeroData, 0]);
                csvData.push(['ä¼šè­°è²»', ...zeroData, 0]);
                csvData.push(['ç¦åˆ©åšç”Ÿè²»', ...zeroData, 0]);
                csvData.push(['ç ”ä¿®è²»', ...zeroData, 0]);
                csvData.push(['é›‘è²»', ...zeroData, 0]);
                csvData.push(['å¯„ä»˜é‡‘', ...zeroData, 0]);

                // è¨ˆç®—é …ç›®
                const totalExpensesData = new Array(12).fill(0);
                Object.values(results.expenses).forEach(expenseArray => {
                    expenseArray.forEach((val, monthIndex) => {
                        totalExpensesData[monthIndex] += val;
                    });
                });

                const operatingProfitData = results.monthlyResults.map((m, i) => m.grossProfit - totalExpensesData[i]);
                csvData.push(['è²©ç®¡è²»åˆè¨ˆ', ...totalExpensesData, results.annual.totalExpenses]);
                csvData.push(['å–¶æ¥­åˆ©ç›Š', ...operatingProfitData, results.annual.operatingProfit]);

                const csvString = '\uFEFF' + csvData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `RCäº‹æ¥­éƒ¨_ä¿®æ­£ç‰ˆPL_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                showNotification('ä¿®æ­£ç‰ˆRCäº‹æ¥­éƒ¨PLãƒ‡ãƒ¼ã‚¿ã®CSVå‡ºåŠ›ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'success');

            } catch (error) {
                console.error('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('CSVå‡ºåŠ›ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿é€ä¿¡é–¢æ•°
        function sendRCDataAndNavigateToNext() {
            try {
                const results = calculateRC();
                
                const unifiedData = {
                    metadata: {
                        department: 'RC',
                        lastUpdate: new Date().toISOString(),
                        version: '4.0_corrected',
                        unifiedStructure: true,
                        workflowStep: 3,
                        workflowStatus: 'completed',
                        personnelCalculationMethod: 'fixed_50_corrected',
                        dataProtectionEnabled: dataProtectionState.isProtected
                    },
                    sales: rcData.variations.map(v => rcData.baseSales + v),
                    cogs: results.monthlyResults.map(m => m.cogs),
                    personnel: results.monthlyResults.map(() => rcData.fixedPersonnel),
                    totalExpenses: results.monthlyResults.map(m => {
                        let totalExp = 0;
                        Object.values(results.expenses).forEach(expenseArray => {
                            totalExp += expenseArray[results.monthlyResults.indexOf(m)];
                        });
                        return totalExp;
                    }),
                    operatingProfit: results.monthlyResults.map(m => {
                        let totalExp = 0;
                        Object.values(results.expenses).forEach(expenseArray => {
                            totalExp += expenseArray[results.monthlyResults.indexOf(m)];
                        });
                        return m.grossProfit - totalExp;
                    }),
                    expenses: results.expenses,
                    annual: results.annual,
                    exportedAt: new Date().toISOString()
                };

                // ä¿®æ­£ã•ã‚ŒãŸã‚­ãƒ¼ã§ä¿å­˜
                localStorage.setItem('pl_system_rc_corrected_data', JSON.stringify(unifiedData));
                
                // ãƒ‡ãƒ¼ã‚¿ä¿è­·ã‚’è‡ªå‹•ã§æœ‰åŠ¹åŒ–
                if (!dataProtectionState.isProtected) {
                    dataProtectionState.isProtected = true;
                    enableDataProtection();
                    updateProtectionStatus();
                }

                showNotification(`ä¿®æ­£ç‰ˆRCäº‹æ¥­éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆPLã‚·ã‚¹ãƒ†ãƒ ã«é€ä¿¡ã—ã¾ã—ãŸ!

å¹´é–“å£²ä¸Š: ${formatNumber(results.annual.sales)}ä¸‡å††
å¹´é–“å–¶æ¥­åˆ©ç›Š: ${formatNumber(results.annual.operatingProfit)}ä¸‡å††
äººä»¶è²»è¨ˆç®—æ–¹å¼: å›ºå®š50ä¸‡å††/æœˆï¼ˆä¿®æ­£ç‰ˆï¼‰

è¿½åŠ è²»ç”¨é …ç›®:
ãƒ»å¤–æ³¨è²»: 684ä¸‡å††/å¹´ (57ä¸‡å††/æœˆ)
ãƒ»é‹é€é‹è³ƒ: 744ä¸‡å††/å¹´ (62ä¸‡å††/æœˆ)  
ãƒ»æ¶ˆè€—å“è²»: 432ä¸‡å††/å¹´ (36ä¸‡å††/æœˆ)
ãƒ»ãƒªãƒ¼ã‚¹æ–™: 84ä¸‡å††/å¹´ (7ä¸‡å††/æœˆ)

ãƒ‡ãƒ¼ã‚¿ä¿è­·ãŒè‡ªå‹•ã§æœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚
2ç§’å¾Œã«RCDç¤¾ç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚`, 'success', 5000);

                setTimeout(() => {
                    window.location.href = 'rcd-pl.html';
                }, 2000);

                return results.annual.sales;

            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                return 0;
            }
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // åˆæœŸåŒ– - ãƒ‡ãƒ¼ã‚¿ä¿è­·å¼·åŒ–ç‰ˆ
        function initialize() {
            try {
                // 1. ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã‚’è©¦è¡Œ
                const dataRestored = loadDataFromStorage();
                
                // 2. ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ã¿å®Ÿç¸¾å€¤è¨­å®š
                if (!dataRestored) {
                    setDefaultToActualValues();
                }
                
                // 3. å¸¸ã«ãƒ‡ãƒ¼ã‚¿ä¿è­·ONçŠ¶æ…‹ã§é–‹å§‹
                dataProtectionState.isProtected = true;
                enableDataProtection();
                updateProtectionStatus();
                
                // 4. æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†ç¶šè¡Œ
                // è¨ˆç®—çµæœã‚’å³åº§ã«è¡¨ç¤º
                const results = calculateRC();
                updateSalesDisplay();
                updateDifferenceDisplay();
                updateKPIDisplay(results.annual);
                updateMiniKPIDisplay(results.annual);
                updateChart();
                updateProfitTable(results);
                updateExpenseTable(results.expenses);
                
                const inputs = document.querySelectorAll('input[data-month]');
                inputs.forEach(input => {
                    input.addEventListener('input', debounce(updateRCSales, 300));
                });
                
                document.getElementById('advertising').addEventListener('input', debounce(updateRCSales, 300));
                document.getElementById('bwj-construction').addEventListener('input', debounce(updateRCSales, 300));
                document.getElementById('bwj-tokyo').addEventListener('input', debounce(updateRCSales, 300));
                
                // çµæœã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
                window.rcResults = calculateRC();
                
                console.log('RCäº‹æ¥­éƒ¨PLã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ãƒ‡ãƒ¼ã‚¿ä¿è­·å¼·åŒ–ç‰ˆåˆæœŸåŒ–å®Œäº†');
                
                // åˆæœŸåŒ–å®Œäº†é€šçŸ¥
                if (!dataRestored) {
                    showNotification('RCäº‹æ¥­éƒ¨PLã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚\n\nå®Ÿç¸¾å€¤ãƒ™ãƒ¼ã‚¹ã§é–‹å§‹ã—ã€ãƒ‡ãƒ¼ã‚¿ä¿è­·ãŒæœ‰åŠ¹ã§ã™ã€‚', 'success', 2000);
                } else {
                    showNotification('ä¿å­˜ã•ã‚ŒãŸäºˆç®—ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸã€‚\n\nãƒ‡ãƒ¼ã‚¿ä¿è­·ãŒæœ‰åŠ¹ã§ã™ã€‚', 'success', 2000);
                }
                
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        window.addEventListener('load', initialize);
        
        // ã‚¿ãƒ–ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®è‡ªå‹•ä¿è­·
        window.addEventListener('focus', () => {
            if (!dataProtectionState.isProtected) {
                dataProtectionState.isProtected = true;
                enableDataProtection();
                updateProtectionStatus();
                showNotification('ã‚¿ãƒ–å¾©å¸°ã«ã‚ˆã‚Šè‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ä¿è­·ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸã€‚', 'success', 2000);
            }
        });
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ç·Šæ€¥ä¿å­˜
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                emergencySave();
            }
        });
        
        // ãƒšãƒ¼ã‚¸é›¢è„±å‰ã®ç¢ºèªï¼ˆãƒ‡ãƒ¼ã‚¿ä¿è­·ãŒæœ‰åŠ¹ã§ãªã„å ´åˆã®ã¿ï¼‰
        window.addEventListener('beforeunload', (event) => {
            if (!dataProtectionState.isProtected && window.rcResults) {
                event.preventDefault();
                event.returnValue = 'ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æœ¬å½“ã«ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¾ã™ã‹ï¼Ÿ';
            }
        });
    </script>
</body>
</html>
