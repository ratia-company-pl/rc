<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>W事業部 損益計算シミュレーター v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* W事業部専用カラーテーマ（ネイビーパープル系） */
        .w-theme {
            --primary: #6c5ce7;
            --secondary: #5a4fcf;
            --accent: #a29bfe;
            --success: #00b894;
            --error: #d63031;
            --warning: #fdcb6e;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        /* ステータス表示 */
        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }

        .status-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .status-label {
            color: #666;
            margin-top: 5px;
        }

        /* 入力セクション */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .input-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .input-card:hover {
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.2);
        }

        .input-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .month-input {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .month-input label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .month-input input {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
        }

        .month-input input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 5px rgba(108, 92, 231, 0.3);
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .config-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .config-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .config-item input, .config-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        /* 結果表示テーブル */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }

        .results-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .results-table tr:hover {
            background: #e8f4f8;
        }

        .total-row {
            background: #f0ecff !important;
            font-weight: bold;
        }

        .profit-positive {
            color: var(--success);
        }

        .profit-negative {
            color: var(--error);
        }

        /* ボタン */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #00a085;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* グラフコンテナ */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* データ送信ステータス */
        .data-status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
        }

        .data-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* W事業部特有の説明ボックス */
        .w-info {
            background: #f3f0ff;
            border: 1px solid #d1c4e9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .w-info h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .w-info ul {
            margin-left: 20px;
            color: #5a4fcf;
        }

        /* 段階的手数料説明 */
        .fee-structure {
            background: #fff9e6;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .fee-structure h4 {
            color: #e17055;
            margin-bottom: 10px;
        }

        .fee-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            background: white;
            border-radius: 4px;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .content {
                padding: 20px;
            }

            .input-grid {
                grid-template-columns: 1fr;
            }

            .month-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .header h1 {
                font-size: 2em;
            }

            .status-indicators {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="w-theme">
    <div class="container">
        <div class="header">
            <h1>W事業部 損益計算シミュレーター</h1>
            <div class="subtitle">固定人件費・段階的手数料モデル | v2.0 自動送信対応</div>
        </div>

        <div class="content">
            <!-- ステータス表示 -->
            <div class="status-indicators">
                <div class="status-card">
                    <div class="status-value" id="totalSalesDisplay">0</div>
                    <div class="status-label">年間売上（万円）</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="operatingProfitDisplay">0</div>
                    <div class="status-label">営業利益（万円）</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="profitRateDisplay">0%</div>
                    <div class="status-label">利益率</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="dataStatusDisplay">未送信</div>
                    <div class="status-label">データ送信状況</div>
                </div>
            </div>

            <!-- W事業部の特徴説明 -->
            <div class="section">
                <h2>🏬 W事業部の特徴</h2>
                <div class="w-info">
                    <h4>📊 計算ロジック</h4>
                    <ul>
                        <li><strong>売上原価</strong> = 売上高 × 29.96%</li>
                        <li><strong>人件費</strong> = 固定給 + 手当 + 賞与（指定月のみ）</li>
                        <li><strong>販管費</strong> = 固定額（月次設定）</li>
                        <li><strong>営業利益</strong> = 粗利益 - 人件費 - 販管費 - 支払手数料</li>
                    </ul>
                </div>
                <div class="fee-structure">
                    <h4>💰 段階的支払手数料</h4>
                    <div class="fee-table">
                        <div class="fee-item">
                            <span>0 - 999万円</span>
                            <strong>6.0%</strong>
                        </div>
                        <div class="fee-item">
                            <span>1,000万円以上</span>
                            <strong>8.0%</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 月次売上入力セクション -->
            <div class="section">
                <h2>📊 月次売上入力</h2>
                <div class="input-grid">
                    <div class="input-card">
                        <h3>💰 月次売上高</h3>
                        <div class="month-grid" id="salesInputs">
                            <!-- JavaScriptで生成 -->
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <strong>年間合計: <span id="totalSales">0</span>万円</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 人件費・経費設定セクション -->
            <div class="section">
                <h2>⚙️ 人件費・経費設定</h2>
                <div class="config-grid">
                    <div class="config-item">
                        <label>基本給（月額）</label>
                        <input type="number" id="baseSalary" value="250" step="10" min="0">
                        <small>万円</small>
                    </div>
                    <div class="config-item">
                        <label>手当（月額）</label>
                        <input type="number" id="allowance" value="50" step="5" min="0">
                        <small>万円</small>
                    </div>
                    <div class="config-item">
                        <label>賞与額</label>
                        <input type="number" id="bonusAmount" value="150" step="10" min="0">
                        <small>万円</small>
                    </div>
                    <div class="config-item">
                        <label>賞与支給月</label>
                        <select id="bonusMonth">
                            <option value="0">なし</option>
                            <option value="6" selected>6月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label>販管費（月額）</label>
                        <input type="number" id="sellingExpenses" value="80" step="5" min="0">
                        <small>万円</small>
                    </div>
                    <div class="config-item">
                        <label>売上原価率</label>
                        <input type="number" id="cogsRate" value="29.96" step="0.1" min="0" max="100">
                        <small>%</small>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="loadSampleData()">📝 サンプルデータ読込</button>
                    <button class="btn btn-secondary" onclick="clearAllData()">🗑️ 全クリア</button>
                    <button class="btn btn-success" onclick="manualDataSend()">📤 手動データ送信</button>
                </div>
            </div>

            <!-- 計算結果セクション -->
            <div class="section">
                <h2>📊 月次損益計算書</h2>
                <table class="results-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>1月</th>
                            <th>2月</th>
                            <th>3月</th>
                            <th>4月</th>
                            <th>5月</th>
                            <th>6月</th>
                            <th>7月</th>
                            <th>8月</th>
                            <th>9月</th>
                            <th>10月</th>
                            <th>11月</th>
                            <th>12月</th>
                            <th>年間合計</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- 計算結果をJSで挿入 -->
                    </tbody>
                </table>
            </div>

            <!-- グラフ表示セクション -->
            <div class="section">
                <h2>📈 視覚分析</h2>
                <div class="chart-container">
                    <h3>月次売上・利益推移</h3>
                    <div class="chart-wrapper">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>費用構成分析</h3>
                    <div class="chart-wrapper">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- データ管理セクション -->
            <div class="section">
                <h2>💾 データ管理・統合連携</h2>
                <div id="dataStatus" class="data-status">
                    自動送信: 計算時に統合システムへ自動送信されます
                </div>
                <div style="text-align: center;">
                    <button class="btn" onclick="saveData()">💾 ローカル保存</button>
                    <button class="btn btn-secondary" onclick="loadData()">📂 ローカル読込</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">📄 CSV出力</button>
                    <button class="btn" onclick="checkIntegrationStatus()">🔍 統合システム確認</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        const STORAGE_KEY = 'pl_system_w_data';
        const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        let salesChart, expenseChart;

        // W事業部の計算定数
        const W_CONSTANTS = {
            defaultCogsRate: 29.96,  // 売上原価率29.96%
            feeRate1: 0.06,          // 999万円まで6%
            feeRate2: 0.08,          // 1000万円以上8%
            feeThreshold: 1000       // 閾値1000万円
        };

        // ページ初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeInputs();
            loadData();
            calculate();
            updateCharts();
        });

        // 入力フィールド初期化
        function initializeInputs() {
            const salesContainer = document.getElementById('salesInputs');
            months.forEach((month, index) => {
                const monthInput = document.createElement('div');
                monthInput.className = 'month-input';
                monthInput.innerHTML = `
                    <label>${month}</label>
                    <input type="number" 
                           id="sales-month${index + 1}" 
                           min="0" 
                           step="10" 
                           value="0"
                           oninput="updateTotals(); calculate(); updateCharts(); autoSendData();">
                `;
                salesContainer.appendChild(monthInput);
            });
        }

        // 合計値更新
        function updateTotals() {
            let totalSales = 0;

            for (let i = 1; i <= 12; i++) {
                const sales = parseFloat(document.getElementById(`sales-month${i}`).value) || 0;
                totalSales += sales;
            }

            document.getElementById('totalSales').textContent = totalSales.toLocaleString();
        }

        // 段階的支払手数料計算
        function calculatePaymentFee(monthlySales) {
            if (monthlySales <= W_CONSTANTS.feeThreshold) {
                return monthlySales * W_CONSTANTS.feeRate1;
            } else {
                return W_CONSTANTS.feeThreshold * W_CONSTANTS.feeRate1 + 
                       (monthlySales - W_CONSTANTS.feeThreshold) * W_CONSTANTS.feeRate2;
            }
        }

        // 月次計算
        function calculateMonthlyPL(monthIndex) {
            const monthlySales = parseFloat(document.getElementById(`sales-month${monthIndex + 1}`).value) || 0;
            const baseSalary = parseFloat(document.getElementById('baseSalary').value) || 0;
            const allowance = parseFloat(document.getElementById('allowance').value) || 0;
            const bonusAmount = parseFloat(document.getElementById('bonusAmount').value) || 0;
            const bonusMonth = parseInt(document.getElementById('bonusMonth').value) || 0;
            const sellingExpenses = parseFloat(document.getElementById('sellingExpenses').value) || 0;
            const cogsRate = parseFloat(document.getElementById('cogsRate').value) / 100 || W_CONSTANTS.defaultCogsRate / 100;

            // W事業部の計算ロジック
            const cogs = monthlySales * cogsRate;
            const grossProfit = monthlySales - cogs;
            
            // 人件費計算（賞与は指定月のみ）
            const monthlyPersonnelCost = baseSalary + allowance + 
                ((bonusMonth === (monthIndex + 1)) ? bonusAmount : 0);
            
            // 支払手数料（段階的）
            const paymentFee = calculatePaymentFee(monthlySales);
            
            // 営業利益
            const operatingProfit = grossProfit - monthlyPersonnelCost - sellingExpenses - paymentFee;

            return {
                sales: monthlySales,
                cogs: cogs,
                grossProfit: grossProfit,
                personnelCost: monthlyPersonnelCost,
                sellingExpenses: sellingExpenses,
                paymentFee: paymentFee,
                operatingProfit: operatingProfit,
                profitRate: monthlySales > 0 ? (operatingProfit / monthlySales * 100) : 0
            };
        }

        // 全体計算実行
        function calculate() {
            const results = [];
            let totalSales = 0, totalOperatingProfit = 0;

            // 月次計算
            for (let i = 0; i < 12; i++) {
                const monthResult = calculateMonthlyPL(i);
                results.push(monthResult);
                totalSales += monthResult.sales;
                totalOperatingProfit += monthResult.operatingProfit;
            }

            // 結果表示更新
            updateResultsTable(results);
            updateStatusDisplay(totalSales, totalOperatingProfit);
            updateTotals();
        }

        // 結果テーブル更新
        function updateResultsTable(results) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            const items = [
                { label: '売上高', key: 'sales', format: 'currency' },
                { label: '売上原価', key: 'cogs', format: 'currency' },
                { label: '粗利益', key: 'grossProfit', format: 'currency' },
                { label: '人件費', key: 'personnelCost', format: 'currency' },
                { label: '販管費', key: 'sellingExpenses', format: 'currency' },
                { label: '支払手数料', key: 'paymentFee', format: 'currency' },
                { label: '営業利益', key: 'operatingProfit', format: 'profit' }
            ];

            items.forEach(item => {
                const row = document.createElement('tr');
                let html = `<td style="text-align: left; font-weight: bold;">${item.label}</td>`;

                let total = 0;
                results.forEach(result => {
                    const value = result[item.key] || 0;
                    total += value;

                    if (item.format === 'profit') {
                        const className = value >= 0 ? 'profit-positive' : 'profit-negative';
                        html += `<td class="${className}">${Math.round(value).toLocaleString()}</td>`;
                    } else {
                        html += `<td>${Math.round(value).toLocaleString()}</td>`;
                    }
                });

                // 年間合計
                if (item.format === 'profit') {
                    const className = total >= 0 ? 'profit-positive' : 'profit-negative';
                    html += `<td class="${className}" style="font-weight: bold;">${Math.round(total).toLocaleString()}</td>`;
                } else {
                    html += `<td style="font-weight: bold;">${Math.round(total).toLocaleString()}</td>`;
                }

                if (item.key === 'operatingProfit') {
                    row.className = 'total-row';
                }

                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        // ステータス表示更新
        function updateStatusDisplay(totalSales, totalOperatingProfit) {
            document.getElementById('totalSalesDisplay').textContent = Math.round(totalSales).toLocaleString();
            document.getElementById('operatingProfitDisplay').textContent = Math.round(totalOperatingProfit).toLocaleString();
            
            const profitRate = totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0;
            document.getElementById('profitRateDisplay').textContent = profitRate.toFixed(1) + '%';
        }

        // グラフ更新
        function updateCharts() {
            updateSalesChart();
            updateExpenseChart();
        }

        // 売上・利益推移グラフ
        function updateSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            if (salesChart) {
                salesChart.destroy();
            }

            const salesData = [];
            const profitData = [];
            
            for (let i = 0; i < 12; i++) {
                const result = calculateMonthlyPL(i);
                salesData.push(Math.round(result.sales));
                profitData.push(Math.round(result.operatingProfit));
            }

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '売上高',
                            data: salesData,
                            borderColor: '#6c5ce7',
                            backgroundColor: 'rgba(108, 92, 231, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '営業利益',
                            data: profitData,
                            borderColor: '#00b894',
                            backgroundColor: 'rgba(0, 184, 148, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '万円';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 費用構成分析グラフ
        function updateExpenseChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            if (expenseChart) {
                expenseChart.destroy();
            }

            const cogsData = [];
            const personnelData = [];
            const sellingData = [];
            const feeData = [];
            
            for (let i = 0; i < 12; i++) {
                const result = calculateMonthlyPL(i);
                cogsData.push(Math.round(result.cogs));
                personnelData.push(Math.round(result.personnelCost));
                sellingData.push(Math.round(result.sellingExpenses));
                feeData.push(Math.round(result.paymentFee));
            }

            expenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '売上原価',
                            data: cogsData,
                            backgroundColor: 'rgba(108, 92, 231, 0.7)'
                        },
                        {
                            label: '人件費',
                            data: personnelData,
                            backgroundColor: 'rgba(162, 155, 254, 0.7)'
                        },
                        {
                            label: '販管費',
                            data: sellingData,
                            backgroundColor: 'rgba(253, 203, 110, 0.7)'
                        },
                        {
                            label: '支払手数料',
                            data: feeData,
                            backgroundColor: 'rgba(214, 48, 49, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '万円';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 🔄 自動データ送信機能（Step 2の核心）
        function autoSendData() {
            try {
                const results = [];
                let totalSales = 0, totalOperatingProfit = 0;

                // 月次データ収集
                for (let i = 0; i < 12; i++) {
                    const monthResult = calculateMonthlyPL(i);
                    results.push({
                        month: i + 1,
                        sales: Math.round(monthResult.sales),
                        profit: Math.round(monthResult.operatingProfit),
                        profitRate: monthResult.profitRate
                    });
                    totalSales += monthResult.sales;
                    totalOperatingProfit += monthResult.operatingProfit;
                }

                // 統合システム用データ構造
                const integrationData = {
                    department: 'W事業部',
                    timestamp: new Date().toISOString(),
                    monthly: results,
                    annual: {
                        sales: Math.round(totalSales),
                        profit: Math.round(totalOperatingProfit),
                        profitRate: totalSales > 0 ? (totalOperatingProfit / totalSales * 100) : 0
                    },
                    metadata: {
                        source: 'w_calculator_v2',
                        version: '2.0',
                        calculationMethod: 'fixed_personnel_tiered_fees',
                        lastUpdated: new Date().toISOString()
                    }
                };

                // LocalStorageに保存
                localStorage.setItem(STORAGE_KEY, JSON.stringify(integrationData));
                
                // ステータス更新
                document.getElementById('dataStatusDisplay').textContent = '送信完了';
                document.getElementById('dataStatusDisplay').style.color = '#00b894';
                
                // ログ出力
                console.log('W事業部データ自動送信完了:', integrationData);
                
                return true;
            } catch (error) {
                console.error('データ送信エラー:', error);
                document.getElementById('dataStatusDisplay').textContent = '送信エラー';
                document.getElementById('dataStatusDisplay').style.color = '#d63031';
                return false;
            }
        }

        // 手動データ送信
        function manualDataSend() {
            const success = autoSendData();
            if (success) {
                showStatus('データを統合システムに送信しました', 'success');
            } else {
                showStatus('データ送信に失敗しました', 'error');
            }
        }

        // 統合システム確認
        function checkIntegrationStatus() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                const parsed = JSON.parse(data);
                const lastUpdate = new Date(parsed.timestamp).toLocaleString();
                showStatus(`最終送信: ${lastUpdate}`, 'success');
            } else {
                showStatus('送信データが見つかりません', 'error');
            }
        }

        // サンプルデータ読込
        function loadSampleData() {
            // 引継ぎ書の実績例を参考にサンプルデータ設定
            // 年間売上12,510万円、営業利益2,238万円、利益率17.9%を目標
            const sampleSales = [1000, 950, 1100, 1050, 900, 1200, 1150, 1000, 950, 1100, 1050, 1060];

            for (let i = 1; i <= 12; i++) {
                document.getElementById(`sales-month${i}`).value = sampleSales[i-1];
            }

            calculate();
            updateCharts();
            autoSendData();
            showStatus('サンプルデータを読み込みました', 'success');
        }

        // 全データクリア
        function clearAllData() {
            if (!confirm('全てのデータをクリアしますか？')) return;

            for (let i = 1; i <= 12; i++) {
                document.getElementById(`sales-month${i}`).value = 0;
            }

            calculate();
            updateCharts();
            autoSendData();
            showStatus('データをクリアしました', 'info');
        }

        // データ保存
        function saveData() {
            const data = {
                department: "W事業部",
                timestamp: new Date().toISOString(),
                inputData: {},
                config: {},
                version: "2.0"
            };

            // 入力データ収集
            for (let i = 1; i <= 12; i++) {
                data.inputData[`sales_month${i}`] = parseFloat(document.getElementById(`sales-month${i}`).value) || 0;
            }

            // 設定データ収集
            data.config = {
                baseSalary: parseFloat(document.getElementById('baseSalary').value) || 0,
                allowance: parseFloat(document.getElementById('allowance').value) || 0,
                bonusAmount: parseFloat(document.getElementById('bonusAmount').value) || 0,
                bonusMonth: parseInt(document.getElementById('bonusMonth').value) || 0,
                sellingExpenses: parseFloat(document.getElementById('sellingExpenses').value) || 0,
                cogsRate: parseFloat(document.getElementById('cogsRate').value) || 0
            };

            localStorage.setItem(STORAGE_KEY + '_local', JSON.stringify(data));
            showStatus('ローカルデータを保存しました', 'success');
        }

        // データ読込
        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY + '_local');
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);
                
                // 入力データ復元
                if (data.inputData) {
                    for (let i = 1; i <= 12; i++) {
                        const value = data.inputData[`sales_month${i}`] || 0;
                        document.getElementById(`sales-month${i}`).value = value;
                    }
                }

                // 設定データ復元
                if (data.config) {
                    document.getElementById('baseSalary').value = data.config.baseSalary || 250;
                    document.getElementById('allowance').value = data.config.allowance || 50;
                    document.getElementById('bonusAmount').value = data.config.bonusAmount || 150;
                    document.getElementById('bonusMonth').value = data.config.bonusMonth || 6;
                    document.getElementById('sellingExpenses').value = data.config.sellingExpenses || 80;
                    document.getElementById('cogsRate').value = data.config.cogsRate || 29.96;
                }

                calculate();
                updateCharts();
                autoSendData();
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // CSV出力
        function exportCSV() {
            const results = [];
            for (let i = 0; i < 12; i++) {
                results.push(calculateMonthlyPL(i));
            }

            let csv = 'W事業部 損益計算書\n\n';
            csv += '項目,' + months.join(',') + ',年間合計\n';

            const items = [
                { label: '売上高', key: 'sales' },
                { label: '売上原価', key: 'cogs' },
                { label: '粗利益', key: 'grossProfit' },
                { label: '人件費', key: 'personnelCost' },
                { label: '販管費', key: 'sellingExpenses' },
                { label: '支払手数料', key: 'paymentFee' },
                { label: '営業利益', key: 'operatingProfit' }
            ];

            items.forEach(item => {
                let row = item.label;
                let total = 0;
                results.forEach(result => {
                    const value = Math.round(result[item.key] || 0);
                    row += ',' + value;
                    total += value;
                });
                row += ',' + Math.round(total);
                csv += row + '\n';
            });

            // ダウンロード実行
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `W事業部_損益計算書_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();

            showStatus('CSVファイルをダウンロードしました', 'success');
        }

        // ステータス表示
        function showStatus(message, type) {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'data-status ' + (type === 'error' ? 'error' : '');
            
            setTimeout(() => {
                statusDiv.textContent = '自動送信: 計算時に統合システムへ自動送信されます';
                statusDiv.className = 'data-status';
            }, 3000);
        }

        // 設定変更時の再計算
        ['baseSalary', 'allowance', 'bonusAmount', 'bonusMonth', 'sellingExpenses', 'cogsRate'].forEach(id => {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById(id).addEventListener('input', () => {
                    calculate();
                    updateCharts();
                    autoSendData();
                });
            });
        });
    </script>
</body>
</html>
